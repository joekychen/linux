<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath6kl › wmi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>wmi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004-2011 Atheros Communications Inc.</span>
<span class="cm"> * Copyright (c) 2011-2012 Qualcomm Atheros, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;testmode.h&quot;</span>
<span class="cp">#include &quot;../regd.h&quot;</span>
<span class="cp">#include &quot;../regd_common.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ath6kl_wmi_sync_point</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s32</span> <span class="n">wmi_rate_tbl</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* {W/O SGI, with SGI} */</span>
	<span class="p">{</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">5500</span><span class="p">,</span> <span class="mi">5500</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">11000</span><span class="p">,</span> <span class="mi">11000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">6000</span><span class="p">,</span> <span class="mi">6000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">9000</span><span class="p">,</span> <span class="mi">9000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">12000</span><span class="p">,</span> <span class="mi">12000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">18000</span><span class="p">,</span> <span class="mi">18000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">24000</span><span class="p">,</span> <span class="mi">24000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">36000</span><span class="p">,</span> <span class="mi">36000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">48000</span><span class="p">,</span> <span class="mi">48000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">54000</span><span class="p">,</span> <span class="mi">54000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">6500</span><span class="p">,</span> <span class="mi">7200</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">13000</span><span class="p">,</span> <span class="mi">14400</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">19500</span><span class="p">,</span> <span class="mi">21700</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">26000</span><span class="p">,</span> <span class="mi">28900</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">39000</span><span class="p">,</span> <span class="mi">43300</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">52000</span><span class="p">,</span> <span class="mi">57800</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">58500</span><span class="p">,</span> <span class="mi">65000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">65000</span><span class="p">,</span> <span class="mi">72200</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">13500</span><span class="p">,</span> <span class="mi">15000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">27000</span><span class="p">,</span> <span class="mi">30000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">40500</span><span class="p">,</span> <span class="mi">45000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">54000</span><span class="p">,</span> <span class="mi">60000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">81000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">108000</span><span class="p">,</span> <span class="mi">120000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">121500</span><span class="p">,</span> <span class="mi">135000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">135000</span><span class="p">,</span> <span class="mi">150000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* 802.1d to AC mapping. Refer pg 57 of WMM-test-plan-v1.2 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">up_to_ac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">WMM_AC_BE</span><span class="p">,</span>
	<span class="n">WMM_AC_BK</span><span class="p">,</span>
	<span class="n">WMM_AC_BK</span><span class="p">,</span>
	<span class="n">WMM_AC_BE</span><span class="p">,</span>
	<span class="n">WMM_AC_VI</span><span class="p">,</span>
	<span class="n">WMM_AC_VI</span><span class="p">,</span>
	<span class="n">WMM_AC_VO</span><span class="p">,</span>
	<span class="n">WMM_AC_VO</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ath6kl_wmi_set_control_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">ep_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">ep_id</span> <span class="o">==</span> <span class="n">ENDPOINT_UNUSED</span> <span class="o">||</span> <span class="n">ep_id</span> <span class="o">&gt;=</span> <span class="n">ENDPOINT_MAX</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">ep_id</span> <span class="o">=</span> <span class="n">ep_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="nf">ath6kl_wmi_get_control_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">ep_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="nf">ath6kl_get_vif_by_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="o">*</span><span class="n">found</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">if_idx</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* FIXME: Locking */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span> <span class="o">==</span> <span class="n">if_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="n">vif</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  Performs DIX to 802.3 encapsulation for transmit packets.</span>
<span class="cm"> *  Assumes the entire DIX header is contigous and that there is</span>
<span class="cm"> *  enough room in the buffer for a 802.3 mac header and LLC+SNAP headers.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ath6kl_wmi_dix_2_dot3</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span> <span class="o">*</span><span class="n">llc_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eth_hdr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">new_len</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">eth_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_ethertype</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">type</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
			   <span class="s">&quot;%s: pkt is already in 802.3 format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">llc_hdr</span><span class="p">);</span>

	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span><span class="p">));</span>
	<span class="n">datap</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">new_len</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">datap</span><span class="p">,</span> <span class="n">eth_hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth_hdr</span><span class="p">));</span>

	<span class="n">llc_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">datap</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth_hdr</span><span class="p">));</span>
	<span class="n">llc_hdr</span><span class="o">-&gt;</span><span class="n">dsap</span> <span class="o">=</span> <span class="mh">0xAA</span><span class="p">;</span>
	<span class="n">llc_hdr</span><span class="o">-&gt;</span><span class="n">ssap</span> <span class="o">=</span> <span class="mh">0xAA</span><span class="p">;</span>
	<span class="n">llc_hdr</span><span class="o">-&gt;</span><span class="n">cntl</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">llc_hdr</span><span class="o">-&gt;</span><span class="n">org_code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">llc_hdr</span><span class="o">-&gt;</span><span class="n">org_code</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">llc_hdr</span><span class="o">-&gt;</span><span class="n">org_code</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">llc_hdr</span><span class="o">-&gt;</span><span class="n">eth_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_meta_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="o">*</span><span class="n">version</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">tx_meta_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_tx_meta_v1</span> <span class="o">*</span><span class="n">v1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_tx_meta_v2</span> <span class="o">*</span><span class="n">v2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">version</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WMI_META_VERSION_1</span>:
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">WMI_MAX_TX_META_SZ</span><span class="p">);</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_tx_meta_v1</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">v1</span><span class="o">-&gt;</span><span class="n">pkt_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">v1</span><span class="o">-&gt;</span><span class="n">rate_plcy_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">version</span> <span class="o">=</span> <span class="n">WMI_META_VERSION_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_META_VERSION_2</span>:
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">WMI_MAX_TX_META_SZ</span><span class="p">);</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_tx_meta_v2</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_tx_meta_v2</span> <span class="o">*</span><span class="p">)</span> <span class="n">tx_meta_info</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_tx_meta_v2</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_data_hdr_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">wmi_data_hdr_data_type</span> <span class="n">data_type</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="n">meta_ver</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">tx_meta_info</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_data_hdr</span> <span class="o">*</span><span class="n">data_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="n">if_idx</span> <span class="o">&gt;</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="o">-&gt;</span><span class="n">vif_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_meta_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_meta_add</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meta_ver</span><span class="p">,</span> <span class="n">tx_meta_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span><span class="p">));</span>

	<span class="n">data_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">data_hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span><span class="p">));</span>

	<span class="n">data_hdr</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">msg_type</span> <span class="o">&lt;&lt;</span> <span class="n">WMI_DATA_HDR_MSG_TYPE_SHIFT</span><span class="p">;</span>
	<span class="n">data_hdr</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">|=</span> <span class="n">data_type</span> <span class="o">&lt;&lt;</span> <span class="n">WMI_DATA_HDR_DATA_TYPE_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WMI_DATA_HDR_FLAGS_MORE</span><span class="p">)</span>
		<span class="n">data_hdr</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">|=</span> <span class="n">WMI_DATA_HDR_MORE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WMI_DATA_HDR_FLAGS_EOSP</span><span class="p">)</span>
		<span class="n">data_hdr</span><span class="o">-&gt;</span><span class="n">info3</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WMI_DATA_HDR_EOSP</span><span class="p">);</span>

	<span class="n">data_hdr</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">meta_ver</span> <span class="o">&lt;&lt;</span> <span class="n">WMI_DATA_HDR_META_SHIFT</span><span class="p">);</span>
	<span class="n">data_hdr</span><span class="o">-&gt;</span><span class="n">info3</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">if_idx</span> <span class="o">&amp;</span> <span class="n">WMI_DATA_HDR_IF_IDX_MASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">ath6kl_wmi_determine_user_priority</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">layer2_pri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pkt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ip_pri</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine IPTOS priority</span>
<span class="cm">	 *</span>
<span class="cm">	 * IP-TOS - 8bits</span>
<span class="cm">	 *          : DSCP(6-bits) ECN(2-bits)</span>
<span class="cm">	 *          : DSCP - P2 P1 P0 X X X</span>
<span class="cm">	 * where (P2 P1 P0) form 802.1D</span>
<span class="cm">	 */</span>
	<span class="n">ip_pri</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">ip_pri</span> <span class="o">&amp;=</span> <span class="mh">0x7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">layer2_pri</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ip_pri</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">layer2_pri</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ip_pri</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">ath6kl_wmi_get_traffic_class</span><span class="p">(</span><span class="n">u8</span> <span class="n">user_priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>  <span class="n">up_to_ac</span><span class="p">[</span><span class="n">user_priority</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_implicit_create_pstream</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">layer2_priority</span><span class="p">,</span> <span class="n">bool</span> <span class="n">wmm_enabled</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_data_hdr</span> <span class="o">*</span><span class="n">data_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span> <span class="o">*</span><span class="n">llc_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_create_pstream_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">meta_size</span><span class="p">,</span> <span class="n">hdr_size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ip_type</span> <span class="o">=</span> <span class="n">IP_ETHERTYPE</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stream_exist</span><span class="p">,</span> <span class="n">usr_pri</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">traffic_class</span> <span class="o">=</span> <span class="n">WMM_AC_BE</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">datap</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">data_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="n">meta_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">data_hdr</span><span class="o">-&gt;</span><span class="n">info2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">WMI_DATA_HDR_META_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="n">WMI_DATA_HDR_META_MASK</span><span class="p">)</span> <span class="o">?</span> <span class="n">WMI_MAX_TX_META_SZ</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wmm_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If WMM is disabled all traffic goes as BE traffic */</span>
		<span class="n">usr_pri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdr_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span><span class="p">);</span>

		<span class="n">llc_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">datap</span> <span class="o">+</span>
							 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span>
								<span class="n">wmi_data_hdr</span><span class="p">)</span> <span class="o">+</span>
							 <span class="n">meta_size</span> <span class="o">+</span> <span class="n">hdr_size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">llc_hdr</span><span class="o">-&gt;</span><span class="n">eth_type</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ip_type</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Extract the endpoint info from the TOS field</span>
<span class="cm">			 * in the IP header.</span>
<span class="cm">			 */</span>
			<span class="n">usr_pri</span> <span class="o">=</span>
			   <span class="n">ath6kl_wmi_determine_user_priority</span><span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">llc_hdr</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span><span class="p">),</span>
					<span class="n">layer2_priority</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">usr_pri</span> <span class="o">=</span> <span class="n">layer2_priority</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Queue the EAPOL frames in the same WMM_AC_VO queue</span>
<span class="cm">		 * as that of management frames.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_PAE</span><span class="p">))</span>
			<span class="n">usr_pri</span> <span class="o">=</span> <span class="n">WMI_VOICE_USER_PRIORITY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * workaround for WMM S5</span>
<span class="cm">	 *</span>
<span class="cm">	 * FIXME: wmi-&gt;traffic_class is always 100 so this test doesn&#39;t</span>
<span class="cm">	 * make sense</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">WMM_AC_VI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">usr_pri</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">usr_pri</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)))</span>
		<span class="n">usr_pri</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Convert user priority to traffic class */</span>
	<span class="n">traffic_class</span> <span class="o">=</span> <span class="n">up_to_ac</span><span class="p">[</span><span class="n">usr_pri</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">];</span>

	<span class="n">wmi_data_hdr_set_up</span><span class="p">(</span><span class="n">data_hdr</span><span class="p">,</span> <span class="n">usr_pri</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">stream_exist</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">fat_pipe_exist</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stream_exist</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">traffic_class</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">=</span> <span class="n">traffic_class</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">user_pri</span> <span class="o">=</span> <span class="n">usr_pri</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">inactivity_int</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">WMI_IMPLICIT_PSTREAM_INACTIVITY_INT</span><span class="p">);</span>
		<span class="cm">/* Implicit streams are created with TSID 0xFF */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">tsid</span> <span class="o">=</span> <span class="n">WMI_IMPLICIT_PSTREAM</span><span class="p">;</span>
		<span class="n">ath6kl_wmi_create_pstream_cmd</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ac</span> <span class="o">=</span> <span class="n">traffic_class</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_dot11_hdr_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="n">pwh</span><span class="p">,</span> <span class="n">wh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span> <span class="o">*</span><span class="n">llc_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="n">eth_hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hdr_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">sub_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">datap</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">pwh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="n">sub_type</span> <span class="o">=</span> <span class="n">pwh</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_STYPE</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">wh</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">));</span>

	<span class="cm">/* Strip off the 802.11 header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sub_type</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_QOS_DATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdr_size</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_qos_hdr</span><span class="p">),</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sub_type</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_DATA</span><span class="p">))</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">));</span>

	<span class="n">datap</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">llc_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">datap</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eth_hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">));</span>
	<span class="n">eth_hdr</span><span class="p">.</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">llc_hdr</span><span class="o">-&gt;</span><span class="n">eth_type</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wh</span><span class="p">.</span><span class="n">frame_control</span><span class="p">))</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">.</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">wh</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">.</span><span class="n">h_source</span><span class="p">,</span> <span class="n">wh</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_TODS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">.</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">wh</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">.</span><span class="n">h_source</span><span class="p">,</span> <span class="n">wh</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_FROMDS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">.</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">wh</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">.</span><span class="n">h_source</span><span class="p">,</span> <span class="n">wh</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span><span class="p">));</span>
	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">));</span>

	<span class="n">datap</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">datap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eth_hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Performs 802.3 to DIX encapsulation for received packets.</span>
<span class="cm"> * Assumes the entire 802.3 header is contigous.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ath6kl_wmi_dot3_2_dix</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span> <span class="o">*</span><span class="n">llc_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="n">eth_hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">datap</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eth_hdr</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">));</span>

	<span class="n">llc_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">datap</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">));</span>
	<span class="n">eth_hdr</span><span class="p">.</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">llc_hdr</span><span class="o">-&gt;</span><span class="n">eth_type</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span><span class="p">));</span>
	<span class="n">datap</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">datap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eth_hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_tx_complete_event_rx</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tx_complete_msg_v1</span> <span class="o">*</span><span class="n">msg_v1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_tx_complete_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">evt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_tx_complete_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;comp: %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">evt</span><span class="o">-&gt;</span><span class="n">num_msg</span><span class="p">,</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">,</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">msg_type</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">num_msg</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_tx_complete_event</span><span class="p">)</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_complete_msg_v1</span><span class="p">));</span>
		<span class="n">msg_v1</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_complete_msg_v1</span> <span class="o">*</span><span class="p">)(</span><span class="n">datap</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;msg: %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">msg_v1</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">msg_v1</span><span class="o">-&gt;</span><span class="n">pkt_id</span><span class="p">,</span>
			   <span class="n">msg_v1</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">,</span> <span class="n">msg_v1</span><span class="o">-&gt;</span><span class="n">ack_failures</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_remain_on_chnl_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_remain_on_chnl_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_remain_on_chnl_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">);</span>
	<span class="n">dur</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">duration</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;remain_on_chnl: freq=%u dur=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">freq</span><span class="p">,</span> <span class="n">dur</span><span class="p">);</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
			   <span class="s">&quot;remain_on_chnl: Unknown channel (freq=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">freq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">last_roc_id</span><span class="p">;</span>
	<span class="n">cfg80211_ready_on_channel</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">,</span>
				  <span class="n">dur</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_cancel_remain_on_chnl_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span>
						     <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_cancel_remain_on_chnl_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_cancel_remain_on_chnl_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">);</span>
	<span class="n">dur</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">duration</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;cancel_remain_on_chnl: freq=%u dur=%u status=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">freq</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
			   <span class="s">&quot;cancel_remain_on_chnl: Unknown channel (freq=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">freq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">last_cancel_roc_id</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">last_cancel_roc_id</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">last_roc_id</span><span class="p">)</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">last_cancel_roc_id</span><span class="p">;</span> <span class="cm">/* event for cancel command */</span>
	<span class="k">else</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">last_roc_id</span><span class="p">;</span> <span class="cm">/* timeout on uncanceled r-o-c */</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">last_cancel_roc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg80211_remain_on_channel_expired</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
					   <span class="n">NL80211_CHAN_NO_HT</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_tx_status_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_tx_status_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_tx_status_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;tx_status: id=%x ack_status=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">id</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">ack_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">last_mgmt_tx_frame</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg80211_mgmt_tx_status</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
					<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">last_mgmt_tx_frame</span><span class="p">,</span>
					<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">last_mgmt_tx_frame_len</span><span class="p">,</span>
					<span class="o">!!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ack_status</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">last_mgmt_tx_frame</span><span class="p">);</span>
		<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">last_mgmt_tx_frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">last_mgmt_tx_frame_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_rx_probe_req_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_p2p_rx_probe_req_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_p2p_rx_probe_req_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">);</span>
	<span class="n">dlen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datap</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">dlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;invalid wmi_p2p_rx_probe_req_event: len=%d dlen=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">len</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;rx_probe_req: len=%u freq=%u probe_req_report=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">dlen</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">probe_req_report</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">probe_req_report</span> <span class="o">||</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span>
		<span class="n">cfg80211_rx_mgmt</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_p2p_capabilities_event_rx</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_p2p_capabilities_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_p2p_capabilities_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>
	<span class="n">dlen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;p2p_capab: len=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_rx_action_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_rx_action_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_rx_action_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">);</span>
	<span class="n">dlen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datap</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">dlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;invalid wmi_rx_action_event: len=%d dlen=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">len</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;rx_action: len=%u freq=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="n">cfg80211_rx_mgmt</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_p2p_info_event_rx</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_p2p_info_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_p2p_info_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">info_req_flags</span><span class="p">);</span>
	<span class="n">dlen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;p2p_info: flags=%x len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">P2P_FLAG_CAPABILITIES_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">wmi_p2p_capabilities</span> <span class="o">*</span><span class="n">cap</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cap</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_p2p_capabilities</span> <span class="o">*</span><span class="p">)</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;p2p_info: GO Power Save = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">cap</span><span class="o">-&gt;</span><span class="n">go_power_save</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">P2P_FLAG_MACADDR_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">wmi_p2p_macaddr</span> <span class="o">*</span><span class="n">mac</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mac</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">mac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_p2p_macaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;p2p_info: MAC Address = %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">P2P_FLAG_HMODEL_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">wmi_p2p_hmodel</span> <span class="o">*</span><span class="n">mod</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">mod</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_p2p_hmodel</span> <span class="o">*</span><span class="p">)</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;p2p_info: P2P Model = %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">mod</span><span class="o">-&gt;</span><span class="n">p2p_model</span><span class="p">,</span>
			   <span class="n">mod</span><span class="o">-&gt;</span><span class="n">p2p_model</span> <span class="o">?</span> <span class="s">&quot;host&quot;</span> <span class="o">:</span> <span class="s">&quot;firmware&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_buf_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send a &quot;simple&quot; wmi command -- one with no arguments */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_simple_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">wmi_cmd_id</span> <span class="n">cmd_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">cmd_id</span><span class="p">,</span> <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_ready_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_ready_event_2</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_ready_event_2</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_ready_event_2</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ath6kl_ready_event</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span>
			   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">sw_version</span><span class="p">),</span>
			   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">abi_version</span><span class="p">),</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">phy_cap</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Mechanism to modify the roaming behavior in the firmware. The lower rssi</span>
<span class="cm"> * at which the station has to roam can be passed with</span>
<span class="cm"> * WMI_SET_LRSSI_SCAN_PARAMS. Subtract 96 from RSSI to get the signal level</span>
<span class="cm"> * in dBm.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_roam_lrssi_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lrssi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">roam_ctrl_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">roam_ctrl_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">lrssi_scan_period</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">DEF_LRSSI_SCAN_PERIOD</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">lrssi_scan_threshold</span> <span class="o">=</span> <span class="n">a_cpu_to_sle16</span><span class="p">(</span><span class="n">lrssi</span> <span class="o">+</span>
						       <span class="n">DEF_SCAN_FOR_ROAM_INTVL</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">lrssi_roam_threshold</span> <span class="o">=</span> <span class="n">a_cpu_to_sle16</span><span class="p">(</span><span class="n">lrssi</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">roam_rssi_floor</span> <span class="o">=</span> <span class="n">DEF_LRSSI_ROAM_FLOOR</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">roam_ctrl</span> <span class="o">=</span> <span class="n">WMI_SET_LRSSI_SCAN_PARAMS</span><span class="p">;</span>

	<span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_ROAM_CTRL_CMDID</span><span class="p">,</span>
			    <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_force_roam_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">roam_ctrl_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">roam_ctrl_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">roam_ctrl</span> <span class="o">=</span> <span class="n">WMI_FORCE_ROAM</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;force roam to %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_ROAM_CTRL_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_roam_mode_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="k">enum</span> <span class="n">wmi_roam_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">roam_ctrl_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">roam_ctrl_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">roam_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">roam_ctrl</span> <span class="o">=</span> <span class="n">WMI_SET_ROAM_MODE</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;set roam mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_ROAM_CTRL_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_connect_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_connect_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pie</span><span class="p">,</span> <span class="o">*</span><span class="n">peie</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_connect_event</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_connect_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* AP mode start/STA connected event */</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_bss</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
				   <span class="s">&quot;%s: freq %d bssid %pM (AP started)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_bss</span><span class="p">.</span><span class="n">ch</span><span class="p">),</span>
				   <span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_bss</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>
			<span class="n">ath6kl_connect_ap_mode_bss</span><span class="p">(</span>
				<span class="n">vif</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_bss</span><span class="p">.</span><span class="n">ch</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
				   <span class="s">&quot;%s: aid %u mac_addr %pM auth=%u keymgmt=%u cipher=%u apsd_info=%u (STA connected)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_sta</span><span class="p">.</span><span class="n">aid</span><span class="p">,</span>
				   <span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_sta</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span>
				   <span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_sta</span><span class="p">.</span><span class="n">auth</span><span class="p">,</span>
				   <span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_sta</span><span class="p">.</span><span class="n">keymgmt</span><span class="p">,</span>
				   <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_sta</span><span class="p">.</span><span class="n">cipher</span><span class="p">),</span>
				   <span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_sta</span><span class="p">.</span><span class="n">apsd_info</span><span class="p">);</span>

			<span class="n">ath6kl_connect_ap_mode_sta</span><span class="p">(</span>
				<span class="n">vif</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_sta</span><span class="p">.</span><span class="n">aid</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_sta</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span>
				<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_sta</span><span class="p">.</span><span class="n">keymgmt</span><span class="p">,</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_sta</span><span class="p">.</span><span class="n">cipher</span><span class="p">),</span>
				<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_sta</span><span class="p">.</span><span class="n">auth</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">assoc_req_len</span><span class="p">,</span>
				<span class="n">ev</span><span class="o">-&gt;</span><span class="n">assoc_info</span> <span class="o">+</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">beacon_ie_len</span><span class="p">,</span>
				<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_sta</span><span class="p">.</span><span class="n">apsd_info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* STA/IBSS mode connection event */</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;wmi event connect freq %d bssid %pM listen_intvl %d beacon_intvl %d type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">ch</span><span class="p">),</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
		   <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">listen_intvl</span><span class="p">),</span>
		   <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">beacon_intvl</span><span class="p">),</span>
		   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">nw_type</span><span class="p">));</span>

	<span class="cm">/* Start of assoc rsp IEs */</span>
	<span class="n">pie</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">assoc_info</span> <span class="o">+</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">beacon_ie_len</span> <span class="o">+</span>
	      <span class="n">ev</span><span class="o">-&gt;</span><span class="n">assoc_req_len</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span> <span class="cm">/* capinfo, status, aid */</span>

	<span class="cm">/* End of assoc rsp IEs */</span>
	<span class="n">peie</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">assoc_info</span> <span class="o">+</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">beacon_ie_len</span> <span class="o">+</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">assoc_req_len</span> <span class="o">+</span>
	    <span class="n">ev</span><span class="o">-&gt;</span><span class="n">assoc_resp_len</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pie</span> <span class="o">&lt;</span> <span class="n">peie</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">pie</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_EID_VENDOR_SPECIFIC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">pie</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">pie</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">&amp;&amp;</span>
			    <span class="n">pie</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf2</span> <span class="o">&amp;&amp;</span> <span class="n">pie</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">WMM_OUI_TYPE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* WMM OUT (00:50:F2) */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span>
				    <span class="n">pie</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="n">WMM_PARAM_OUI_SUBTYPE</span><span class="p">)</span>
					<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">is_wmm_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">is_wmm_enabled</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">pie</span> <span class="o">+=</span> <span class="n">pie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_connect_event</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">ch</span><span class="p">),</span>
			     <span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
			     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">listen_intvl</span><span class="p">),</span>
			     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">beacon_intvl</span><span class="p">),</span>
			     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">nw_type</span><span class="p">),</span>
			     <span class="n">ev</span><span class="o">-&gt;</span><span class="n">beacon_ie_len</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">assoc_req_len</span><span class="p">,</span>
			     <span class="n">ev</span><span class="o">-&gt;</span><span class="n">assoc_resp_len</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">assoc_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">country_code_to_enum_rd</span> <span class="o">*</span>
<span class="nf">ath6kl_regd_find_country</span><span class="p">(</span><span class="n">u16</span> <span class="n">countryCode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">allCountries</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">allCountries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">countryCode</span> <span class="o">==</span> <span class="n">countryCode</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">allCountries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">reg_dmn_pair_mapping</span> <span class="o">*</span>
<span class="nf">ath6kl_get_regpair</span><span class="p">(</span><span class="n">u16</span> <span class="n">regdmn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regdmn</span> <span class="o">==</span> <span class="n">NO_ENUMRD</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">regDomainPairs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regDomainPairs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">regDmnEnum</span> <span class="o">==</span> <span class="n">regdmn</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">regDomainPairs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">country_code_to_enum_rd</span> <span class="o">*</span>
<span class="nf">ath6kl_regd_find_country_by_rd</span><span class="p">(</span><span class="n">u16</span> <span class="n">regdmn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">allCountries</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">allCountries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">regDmnEnum</span> <span class="o">==</span> <span class="n">regdmn</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">allCountries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_wmi_regdomain_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ath6kl_wmi_regdomain</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">country_code_to_enum_rd</span> <span class="o">*</span><span class="n">country</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reg_dmn_pair_mapping</span> <span class="o">*</span><span class="n">regpair</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">alpha2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">reg_code</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_wmi_regdomain</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>
	<span class="n">reg_code</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">reg_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reg_code</span> <span class="o">&gt;&gt;</span> <span class="n">ATH6KL_COUNTRY_RD_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">COUNTRY_ERD_FLAG</span><span class="p">)</span>
		<span class="n">country</span> <span class="o">=</span> <span class="n">ath6kl_regd_find_country</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">reg_code</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="n">u16</span><span class="p">)</span> <span class="n">reg_code</span> <span class="o">&amp;</span> <span class="n">WORLD_SKU_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">WORLD_SKU_PREFIX</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">regpair</span> <span class="o">=</span> <span class="n">ath6kl_get_regpair</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">reg_code</span><span class="p">);</span>
		<span class="n">country</span> <span class="o">=</span> <span class="n">ath6kl_regd_find_country_by_rd</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">reg_code</span><span class="p">);</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;Regpair used: 0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">regpair</span><span class="o">-&gt;</span><span class="n">regDmnEnum</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">country</span> <span class="o">&amp;&amp;</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="o">-&gt;</span><span class="n">wiphy_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">alpha2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">country</span><span class="o">-&gt;</span><span class="n">isoName</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">alpha2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">country</span><span class="o">-&gt;</span><span class="n">isoName</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

		<span class="n">regulatory_hint</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">alpha2</span><span class="p">);</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;Country alpha2 being used: %c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">alpha2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha2</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_disconnect_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_disconnect_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">traffic_class</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_disconnect_event</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_disconnect_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;wmi event disconnect proto_reason %d bssid %pM wmi_reason %d assoc_resp_len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">proto_reason_status</span><span class="p">),</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
		   <span class="n">ev</span><span class="o">-&gt;</span><span class="n">disconn_reason</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">assoc_resp_len</span><span class="p">);</span>

	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">is_wmm_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ath6kl_disconnect_event</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">disconn_reason</span><span class="p">,</span>
				<span class="n">ev</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">assoc_resp_len</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">assoc_info</span><span class="p">,</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">proto_reason_status</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_peer_node_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_peer_node_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_peer_node_event</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_peer_node_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">event_code</span> <span class="o">==</span> <span class="n">PEER_NODE_JOIN_EVENT</span><span class="p">)</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;joined node with mac addr: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ev</span><span class="o">-&gt;</span><span class="n">peer_mac_addr</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">event_code</span> <span class="o">==</span> <span class="n">PEER_NODE_LEAVE_EVENT</span><span class="p">)</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;left node with mac addr: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ev</span><span class="o">-&gt;</span><span class="n">peer_mac_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_tkip_micerr_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_tkip_micerr_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_tkip_micerr_event</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_tkip_micerr_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="n">ath6kl_tkip_micerr_event</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">key_id</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">is_mcast</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_wmi_sscan_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">cfg80211_sched_scan_results</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_bssinfo_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_bss_info_hdr2</span> <span class="o">*</span><span class="n">bih</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_bss_info_hdr2</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">bih</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_bss_info_hdr2</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">datap</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_bss_info_hdr2</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_bss_info_hdr2</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;bss info evt - ch %u, snr %d, rssi %d, bssid </span><span class="se">\&quot;</span><span class="s">%pM</span><span class="se">\&quot;</span><span class="s"> &quot;</span>
		   <span class="s">&quot;frame_type=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">bih</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">,</span> <span class="n">bih</span><span class="o">-&gt;</span><span class="n">snr</span><span class="p">,</span> <span class="n">bih</span><span class="o">-&gt;</span><span class="n">snr</span> <span class="o">-</span> <span class="mi">95</span><span class="p">,</span> <span class="n">bih</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
		   <span class="n">bih</span><span class="o">-&gt;</span><span class="n">frame_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bih</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">!=</span> <span class="n">BEACON_FTYPE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bih</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">!=</span> <span class="n">PROBERESP_FTYPE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Only update BSS table for now */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bih</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">BEACON_FTYPE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">CLEAR_BSSFILTER_ON_BEACON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CLEAR_BSSFILTER_ON_BEACON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ath6kl_wmi_bssfilter_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					 <span class="n">NONE_BSS_FILTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bih</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bih</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">BEACON_FTYPE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">bih</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tim</span><span class="p">;</span>
		<span class="n">tim</span> <span class="o">=</span> <span class="n">cfg80211_find_ie</span><span class="p">(</span><span class="n">WLAN_EID_TIM</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
				       <span class="n">len</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tim</span> <span class="o">&amp;&amp;</span> <span class="n">tim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vif</span><span class="o">-&gt;</span><span class="n">assoc_bss_dtim_period</span> <span class="o">=</span> <span class="n">tim</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">DTIM_PERIOD_AVAIL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * In theory, use of cfg80211_inform_bss() would be more natural here</span>
<span class="cm">	 * since we do not have the full frame. However, at least for now,</span>
<span class="cm">	 * cfg80211 can only distinguish Beacon and Probe Response frames from</span>
<span class="cm">	 * each other when using cfg80211_inform_bss_frame(), so let&#39;s build a</span>
<span class="cm">	 * fake IEEE 802.11 header to be able to take benefit of this.</span>
<span class="cm">	 */</span>
	<span class="n">mgmt</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">24</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bih</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">BEACON_FTYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
						  <span class="n">IEEE80211_STYPE_BEACON</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

		<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
						  <span class="n">IEEE80211_STYPE_PROBE_RESP</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">duration</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">bih</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bih</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">bss</span> <span class="o">=</span> <span class="n">cfg80211_inform_bss_frame</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">mgmt</span><span class="p">,</span>
					<span class="mi">24</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="n">bih</span><span class="o">-&gt;</span><span class="n">snr</span> <span class="o">-</span> <span class="mi">95</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
					<span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mgmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cfg80211_put_bss</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Firmware doesn&#39;t return any event when scheduled scan has</span>
<span class="cm">	 * finished, so we need to use a timer to find out when there are</span>
<span class="cm">	 * no more results.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The timer is started from the first bss info received, otherwise</span>
<span class="cm">	 * the timer would not ever fire if the scan interval is short</span>
<span class="cm">	 * enough.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ATH6KL_STATE_SCHED_SCAN</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">sched_scan_timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">sched_scan_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
			  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH6KL_SCHED_SCAN_RESULT_DELAY</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Inactivity timeout of a fatpipe(pstream) at the target */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_pstream_timeout_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_pstream_timeout_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_pstream_timeout_event</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_pstream_timeout_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * When the pstream (fat pipe == AC) timesout, it means there were</span>
<span class="cm">	 * no thinStreams within this pstream &amp; it got implicitly created</span>
<span class="cm">	 * due to data flow on this AC. We start the inactivity timer only</span>
<span class="cm">	 * for implicitly created pstream. Just reset the host state.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">stream_exist_for_ac</span><span class="p">[</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">fat_pipe_exist</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Indicate inactivity to driver layer for this fatpipe (pstream) */</span>
	<span class="n">ath6kl_indicate_tx_activity</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_bitrate_reply_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_bit_rate_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sgi</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_bit_rate_reply</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_bit_rate_reply</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;rateindex %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">rate_index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">rate_index</span> <span class="o">==</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">RATE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">RATE_AUTO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">rate_index</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">sgi</span> <span class="o">=</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">rate_index</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">wmi_rate_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">sgi</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">ath6kl_wakeup_event</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_test_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath6kl_tm_rx_event</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_ratemask_reply_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_fix_rates_reply</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ath6kl_wakeup_event</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_ch_list_reply_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_channel_list_reply</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ath6kl_wakeup_event</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_tx_pwr_reply_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_tx_pwr_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_tx_pwr_reply</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_tx_pwr_reply</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>
	<span class="n">ath6kl_txpwr_rx_evt</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">dbM</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_keepalive_reply_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_get_keepalive_cmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ath6kl_wakeup_event</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_scan_complete_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_scan_complete_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_scan_complete_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="n">ath6kl_scan_complete_evt</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">a_sle32_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">is_probe_ssid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_neighbor_report_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_neighbor_report_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_neighbor_report_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">+</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_neighbors</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_neighbor_info</span><span class="p">)</span>
	    <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
			   <span class="s">&quot;truncated neighbor event (num=%d len=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_neighbors</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_neighbors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;neighbor %d/%d - %pM 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_neighbors</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">neighbor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span>
			   <span class="n">ev</span><span class="o">-&gt;</span><span class="n">neighbor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bss_flags</span><span class="p">);</span>
		<span class="n">cfg80211_pmksa_candidate_notify</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="n">ev</span><span class="o">-&gt;</span><span class="n">neighbor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span>
						<span class="o">!!</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">neighbor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bss_flags</span> <span class="o">&amp;</span>
						   <span class="n">WMI_PREAUTH_CAPABLE_BSS</span><span class="p">),</span>
						<span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Target is reporting a programming error.  This is for</span>
<span class="cm"> * developer aid only.  Target only checks a few common violations</span>
<span class="cm"> * and it is responsibility of host to do all error checking.</span>
<span class="cm"> * Behavior of target after wmi error event is undefined.</span>
<span class="cm"> * A reset is recommended.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_error_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;unknown error&quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_cmd_error_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_cmd_error_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">err_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INVALID_PARAM</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;invalid parameter&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ILLEGAL_STATE</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;invalid state&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INTERNAL_ERROR</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;internal error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;programming error, cmd=%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ev</span><span class="o">-&gt;</span><span class="n">cmd_id</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_stats_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath6kl_tgt_stats_event</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ath6kl_wmi_get_upper_threshold</span><span class="p">(</span><span class="n">s16</span> <span class="n">rssi</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">sq_threshold_params</span> <span class="o">*</span><span class="n">sq_thresh</span><span class="p">,</span>
					 <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* The list is already in sorted order. Get the next lower value */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">threshold</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ath6kl_wmi_get_lower_threshold</span><span class="p">(</span><span class="n">s16</span> <span class="n">rssi</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">sq_threshold_params</span> <span class="o">*</span><span class="n">sq_thresh</span><span class="p">,</span>
					 <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* The list is already in sorted order. Get the next lower value */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">threshold</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_send_rssi_threshold_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">wmi_rssi_threshold_params_cmd</span> <span class="o">*</span><span class="n">rssi_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_rssi_threshold_params_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_rssi_threshold_params_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rssi_cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_rssi_threshold_params_cmd</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_RSSI_THRESHOLD_PARAMS_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_rssi_threshold_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_rssi_threshold_event</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_rssi_threshold_params_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sq_threshold_params</span> <span class="o">*</span><span class="n">sq_thresh</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">wmi_rssi_threshold_val</span> <span class="n">new_threshold</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">upper_rssi_threshold</span><span class="p">,</span> <span class="n">lower_rssi_threshold</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">rssi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_rssi_threshold_event</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_rssi_threshold_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>
	<span class="n">new_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">wmi_rssi_threshold_val</span><span class="p">)</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">;</span>
	<span class="n">rssi</span> <span class="o">=</span> <span class="n">a_sle16_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">);</span>

	<span class="n">sq_thresh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">sq_threshld</span><span class="p">[</span><span class="n">SIGNAL_QUALITY_METRICS_RSSI</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Identify the threshold breached and communicate that to the app.</span>
<span class="cm">	 * After that install a new set of thresholds based on the signal</span>
<span class="cm">	 * quality reported by the target</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_threshold</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Upper threshold breached */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
				   <span class="s">&quot;spurious upper rssi threshold event: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">rssi</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_RSSI_THRESHOLD1_ABOVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_RSSI_THRESHOLD2_ABOVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_RSSI_THRESHOLD3_ABOVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_RSSI_THRESHOLD4_ABOVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_RSSI_THRESHOLD5_ABOVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_RSSI_THRESHOLD6_ABOVE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Lower threshold breached */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
				   <span class="s">&quot;spurious lower rssi threshold event: %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rssi</span><span class="p">,</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_RSSI_THRESHOLD6_BELOW</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_RSSI_THRESHOLD5_BELOW</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_RSSI_THRESHOLD4_BELOW</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_RSSI_THRESHOLD3_BELOW</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_RSSI_THRESHOLD2_BELOW</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_RSSI_THRESHOLD1_BELOW</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate and install the next set of thresholds */</span>
	<span class="n">lower_rssi_threshold</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_lower_threshold</span><span class="p">(</span><span class="n">rssi</span><span class="p">,</span> <span class="n">sq_thresh</span><span class="p">,</span>
				       <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold_valid_count</span><span class="p">);</span>
	<span class="n">upper_rssi_threshold</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_upper_threshold</span><span class="p">(</span><span class="n">rssi</span><span class="p">,</span> <span class="n">sq_thresh</span><span class="p">,</span>
				       <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold_valid_count</span><span class="p">);</span>

	<span class="cm">/* Issue a wmi command to install the thresholds */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">thresh_above1_val</span> <span class="o">=</span> <span class="n">a_cpu_to_sle16</span><span class="p">(</span><span class="n">upper_rssi_threshold</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">thresh_below1_val</span> <span class="o">=</span> <span class="n">a_cpu_to_sle16</span><span class="p">(</span><span class="n">lower_rssi_threshold</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">weight</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">poll_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">polling_interval</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_send_rssi_threshold_params</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unable to configure rssi thresholds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_cac_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_cac_event</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tspec_ie</span> <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">active_tsids</span><span class="p">,</span> <span class="n">tsinfo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tsid</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ts_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_cac_event</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_cac_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">cac_indication</span> <span class="o">==</span> <span class="n">CAC_INDICATION_ADMISSION_RESP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">IEEE80211_TSPEC_STATUS_ADMISS_ACCEPTED</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tspec_ie</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">tspec_suggestion</span><span class="p">);</span>
		<span class="n">tsinfo</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">tsinfo</span><span class="p">);</span>
		<span class="n">tsid</span> <span class="o">=</span> <span class="p">(</span><span class="n">tsinfo</span> <span class="o">&gt;&gt;</span> <span class="n">IEEE80211_WMM_IE_TSPEC_TID_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">IEEE80211_WMM_IE_TSPEC_TID_MASK</span><span class="p">;</span>

		<span class="n">ath6kl_wmi_delete_pstream_cmd</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					      <span class="n">reply</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">,</span> <span class="n">tsid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">cac_indication</span> <span class="o">==</span> <span class="n">CAC_INDICATION_NO_RESP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Following assumes that there is only one outstanding</span>
<span class="cm">		 * ADDTS request when this event is received</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">active_tsids</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">stream_exist_for_ac</span><span class="p">[</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">];</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">active_tsids</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">active_tsids</span> <span class="o">&gt;&gt;</span> <span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">active_tsids</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">ath6kl_wmi_delete_pstream_cmd</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						      <span class="n">reply</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear active tsids and Add missing handling</span>
<span class="cm">	 * for delete qos stream from AP</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">cac_indication</span> <span class="o">==</span> <span class="n">CAC_INDICATION_DELETE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ts</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tspec_ie</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">tspec_suggestion</span><span class="p">);</span>
		<span class="n">tsinfo</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">tsinfo</span><span class="p">);</span>
		<span class="n">ts_id</span> <span class="o">=</span> <span class="p">((</span><span class="n">tsinfo</span> <span class="o">&gt;&gt;</span> <span class="n">IEEE80211_WMM_IE_TSPEC_TID_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
			 <span class="n">IEEE80211_WMM_IE_TSPEC_TID_MASK</span><span class="p">);</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">stream_exist_for_ac</span><span class="p">[</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ts_id</span><span class="p">);</span>
		<span class="n">active_tsids</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">stream_exist_for_ac</span><span class="p">[</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">];</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="cm">/* Indicate stream inactivity to driver layer only if all tsids</span>
<span class="cm">		 * within this AC are deleted.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">active_tsids</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_indicate_tx_activity</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">,</span>
						    <span class="nb">false</span><span class="p">);</span>
			<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">fat_pipe_exist</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_send_snr_threshold_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">wmi_snr_threshold_params_cmd</span> <span class="o">*</span><span class="n">snr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_snr_threshold_params_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_snr_threshold_params_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">snr_cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_snr_threshold_params_cmd</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SNR_THRESHOLD_PARAMS_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_snr_threshold_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_snr_threshold_event</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sq_threshold_params</span> <span class="o">*</span><span class="n">sq_thresh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_snr_threshold_params_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">wmi_snr_threshold_val</span> <span class="n">new_threshold</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">upper_snr_threshold</span><span class="p">,</span> <span class="n">lower_snr_threshold</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">snr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_snr_threshold_event</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_snr_threshold_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="n">new_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">wmi_snr_threshold_val</span><span class="p">)</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">;</span>
	<span class="n">snr</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">snr</span><span class="p">;</span>

	<span class="n">sq_thresh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">sq_threshld</span><span class="p">[</span><span class="n">SIGNAL_QUALITY_METRICS_SNR</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Identify the threshold breached and communicate that to the app.</span>
<span class="cm">	 * After that install a new set of thresholds based on the signal</span>
<span class="cm">	 * quality reported by the target.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_threshold</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Upper threshold breached */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snr</span> <span class="o">&lt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
				   <span class="s">&quot;spurious upper snr threshold event: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">snr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">snr</span> <span class="o">&lt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">snr</span> <span class="o">&gt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_SNR_THRESHOLD1_ABOVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">snr</span> <span class="o">&lt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">snr</span> <span class="o">&gt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_SNR_THRESHOLD2_ABOVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">snr</span> <span class="o">&lt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">snr</span> <span class="o">&gt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_SNR_THRESHOLD3_ABOVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">snr</span> <span class="o">&gt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_SNR_THRESHOLD4_ABOVE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Lower threshold breached */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snr</span> <span class="o">&gt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
				   <span class="s">&quot;spurious lower snr threshold event: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">snr</span> <span class="o">&gt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">snr</span> <span class="o">&lt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_SNR_THRESHOLD4_BELOW</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">snr</span> <span class="o">&gt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">snr</span> <span class="o">&lt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_SNR_THRESHOLD3_BELOW</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">snr</span> <span class="o">&gt;</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">snr</span> <span class="o">&lt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_SNR_THRESHOLD2_BELOW</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">snr</span> <span class="o">&lt;=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">new_threshold</span> <span class="o">=</span> <span class="n">WMI_SNR_THRESHOLD1_BELOW</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate and install the next set of thresholds */</span>
	<span class="n">lower_snr_threshold</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_lower_threshold</span><span class="p">(</span><span class="n">snr</span><span class="p">,</span> <span class="n">sq_thresh</span><span class="p">,</span>
				       <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">lower_threshold_valid_count</span><span class="p">);</span>
	<span class="n">upper_snr_threshold</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_upper_threshold</span><span class="p">(</span><span class="n">snr</span><span class="p">,</span> <span class="n">sq_thresh</span><span class="p">,</span>
				       <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">upper_threshold_valid_count</span><span class="p">);</span>

	<span class="cm">/* Issue a wmi command to install the thresholds */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">thresh_above1_val</span> <span class="o">=</span> <span class="n">upper_snr_threshold</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">thresh_below1_val</span> <span class="o">=</span> <span class="n">lower_snr_threshold</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">weight</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">poll_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sq_thresh</span><span class="o">-&gt;</span><span class="n">polling_interval</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;snr: %d, threshold: %d, lower: %d, upper: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">snr</span><span class="p">,</span> <span class="n">new_threshold</span><span class="p">,</span>
		   <span class="n">lower_snr_threshold</span><span class="p">,</span> <span class="n">upper_snr_threshold</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_send_snr_threshold_params</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unable to configure snr threshold</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_aplist_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ap_info_entry_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_aplist_event</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_aplist_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_ap_info_v1</span> <span class="o">*</span><span class="n">ap_info_v1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_aplist_event</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ev</span><span class="o">-&gt;</span><span class="n">ap_list_ver</span> <span class="o">!=</span> <span class="n">APLIST_VER1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ap_info_entry_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_ap_info_v1</span><span class="p">);</span>
	<span class="n">ap_info_v1</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_ap_info_v1</span> <span class="o">*</span><span class="p">)</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">ap_list</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;number of APs in aplist event: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_aplist_event</span><span class="p">)</span> <span class="o">+</span>
			 <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_ap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ap_info_entry_size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* AP list version 1 contents */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_ap</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;AP#%d BSSID %pM Channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">index</span><span class="p">,</span> <span class="n">ap_info_v1</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ap_info_v1</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">ap_info_v1</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">wmi_cmd_id</span> <span class="n">cmd_id</span><span class="p">,</span> <span class="k">enum</span> <span class="n">wmi_sync_flag</span> <span class="n">sync_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_cmd_hdr</span> <span class="o">*</span><span class="n">cmd_hdr</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">ep_id</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">ep_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">info1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="n">if_idx</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="o">-&gt;</span><span class="n">vif_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;wmi tx id %d len %d flag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">cmd_id</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">sync_flag</span><span class="p">);</span>
	<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI_DUMP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;wmi tx &quot;</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_flag</span> <span class="o">&gt;=</span> <span class="n">END_WMIFLAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sync_flag</span> <span class="o">==</span> <span class="n">SYNC_BEFORE_WMIFLAG</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sync_flag</span> <span class="o">==</span> <span class="n">SYNC_BOTH_WMIFLAG</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Make sure all data currently queued is transmitted before</span>
<span class="cm">		 * the cmd execution.  Establish a new sync point.</span>
<span class="cm">		 */</span>
		<span class="n">ath6kl_wmi_sync_point</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_cmd_hdr</span><span class="p">));</span>

	<span class="n">cmd_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_cmd_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd_hdr</span><span class="o">-&gt;</span><span class="n">cmd_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_id</span><span class="p">);</span>
	<span class="n">info1</span> <span class="o">=</span> <span class="n">if_idx</span> <span class="o">&amp;</span> <span class="n">WMI_CMD_HDR_IF_ID_MASK</span><span class="p">;</span>
	<span class="n">cmd_hdr</span><span class="o">-&gt;</span><span class="n">info1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">info1</span><span class="p">);</span>

	<span class="cm">/* Only for OPT_TX_CMD, use BE endpoint. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_id</span> <span class="o">==</span> <span class="n">WMI_OPT_TX_FRAME_CMDID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_data_hdr_add</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">OPT_MSGTYPE</span><span class="p">,</span>
					      <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ep_id</span> <span class="o">=</span> <span class="n">ath6kl_ac2_endpoint_id</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">WMM_AC_BE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath6kl_control_tx</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sync_flag</span> <span class="o">==</span> <span class="n">SYNC_AFTER_WMIFLAG</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sync_flag</span> <span class="o">==</span> <span class="n">SYNC_BOTH_WMIFLAG</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Make sure all new data queued waits for the command to</span>
<span class="cm">		 * execute. Establish a new sync point.</span>
<span class="cm">		 */</span>
		<span class="n">ath6kl_wmi_sync_point</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_connect_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">network_type</span> <span class="n">nw_type</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">dot11_auth_mode</span> <span class="n">dot11_auth_mode</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">auth_mode</span> <span class="n">auth_mode</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">crypto_type</span> <span class="n">pairwise_crypto</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">pairwise_crypto_len</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">crypto_type</span> <span class="n">group_crypto</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">group_crypto_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ssid_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ctrl_flags</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">nw_subtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_connect_cmd</span> <span class="o">*</span><span class="n">cc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;wmi connect bssid %pM freq %d flags 0x%x ssid_len %d &quot;</span>
		   <span class="s">&quot;type %d dot11_auth %d auth %d pairwise %d group %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">bssid</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ctrl_flags</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">,</span> <span class="n">nw_type</span><span class="p">,</span>
		   <span class="n">dot11_auth_mode</span><span class="p">,</span> <span class="n">auth_mode</span><span class="p">,</span> <span class="n">pairwise_crypto</span><span class="p">,</span> <span class="n">group_crypto</span><span class="p">);</span>
	<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ssid &quot;</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>

	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">traffic_class</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pairwise_crypto</span> <span class="o">==</span> <span class="n">NONE_CRYPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">group_crypto</span> <span class="o">!=</span> <span class="n">NONE_CRYPT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pairwise_crypto</span> <span class="o">!=</span> <span class="n">NONE_CRYPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">group_crypto</span> <span class="o">==</span> <span class="n">NONE_CRYPT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_connect_cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_connect_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssid_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>

	<span class="n">cc</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">cc</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">nw_type</span><span class="p">;</span>
	<span class="n">cc</span><span class="o">-&gt;</span><span class="n">dot11_auth_mode</span> <span class="o">=</span> <span class="n">dot11_auth_mode</span><span class="p">;</span>
	<span class="n">cc</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">auth_mode</span><span class="p">;</span>
	<span class="n">cc</span><span class="o">-&gt;</span><span class="n">prwise_crypto_type</span> <span class="o">=</span> <span class="n">pairwise_crypto</span><span class="p">;</span>
	<span class="n">cc</span><span class="o">-&gt;</span><span class="n">prwise_crypto_len</span> <span class="o">=</span> <span class="n">pairwise_crypto_len</span><span class="p">;</span>
	<span class="n">cc</span><span class="o">-&gt;</span><span class="n">grp_crypto_type</span> <span class="o">=</span> <span class="n">group_crypto</span><span class="p">;</span>
	<span class="n">cc</span><span class="o">-&gt;</span><span class="n">grp_crypto_len</span> <span class="o">=</span> <span class="n">group_crypto_len</span><span class="p">;</span>
	<span class="n">cc</span><span class="o">-&gt;</span><span class="n">ch</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">cc</span><span class="o">-&gt;</span><span class="n">ctrl_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ctrl_flags</span><span class="p">);</span>
	<span class="n">cc</span><span class="o">-&gt;</span><span class="n">nw_subtype</span> <span class="o">=</span> <span class="n">nw_subtype</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bssid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_CONNECT_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_reconnect_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_reconnect_cmd</span> <span class="o">*</span><span class="n">cc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;wmi reconnect bssid %pM freq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">bssid</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">traffic_class</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_reconnect_cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_reconnect_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cc</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bssid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_RECONNECT_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_disconnect_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;wmi disconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">traffic_class</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* Disconnect command does not need to do a SYNC before. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_simple_cmd</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">WMI_DISCONNECT_CMDID</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_beginscan_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">wmi_scan_type</span> <span class="n">scan_type</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">force_fgscan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">is_legacy</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">home_dwell_time</span><span class="p">,</span> <span class="n">u32</span> <span class="n">force_scan_interval</span><span class="p">,</span>
			     <span class="n">s8</span> <span class="n">num_chan</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ch_list</span><span class="p">,</span> <span class="n">u32</span> <span class="n">no_cck</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_begin_scan_cmd</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">size</span><span class="p">,</span> <span class="o">*</span><span class="n">supp_rates</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_rates</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ratemask</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_begin_scan_cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scan_type</span> <span class="o">!=</span> <span class="n">WMI_LONG_SCAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scan_type</span> <span class="o">!=</span> <span class="n">WMI_SHORT_SCAN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_chan</span> <span class="o">&gt;</span> <span class="n">WMI_MAX_CHANNELS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_chan</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_chan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_begin_scan_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">=</span> <span class="n">scan_type</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">force_fg_scan</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">force_fgscan</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">is_legacy</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">is_legacy</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">home_dwell_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">home_dwell_time</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">force_scan_intvl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">force_scan_interval</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">no_cck</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">no_cck</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">num_ch</span> <span class="o">=</span> <span class="n">num_chan</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">band</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sband</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sband</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ratemask</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>
		<span class="n">supp_rates</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">band</span><span class="p">].</span><span class="n">rates</span><span class="p">;</span>
		<span class="n">num_rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ratemask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span> <span class="cm">/* skip rate */</span>
			<span class="n">supp_rates</span><span class="p">[</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">/</span> <span class="mi">5</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">band</span><span class="p">].</span><span class="n">nrates</span> <span class="o">=</span> <span class="n">num_rates</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ch_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ch_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_BEGIN_SCAN_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ath6kl_wmi_start_scan_cmd is to be deprecated. Use</span>
<span class="cm"> * ath6kl_wmi_begin_scan_cmd instead. The new function supports P2P</span>
<span class="cm"> * mgmt operations using station interface.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ath6kl_wmi_startscan_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">wmi_scan_type</span> <span class="n">scan_type</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">force_fgscan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">is_legacy</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">home_dwell_time</span><span class="p">,</span> <span class="n">u32</span> <span class="n">force_scan_interval</span><span class="p">,</span>
			     <span class="n">s8</span> <span class="n">num_chan</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ch_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_start_scan_cmd</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_start_scan_cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scan_type</span> <span class="o">!=</span> <span class="n">WMI_LONG_SCAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scan_type</span> <span class="o">!=</span> <span class="n">WMI_SHORT_SCAN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_chan</span> <span class="o">&gt;</span> <span class="n">WMI_MAX_CHANNELS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_chan</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_chan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_start_scan_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">=</span> <span class="n">scan_type</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">force_fg_scan</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">force_fgscan</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">is_legacy</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">is_legacy</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">home_dwell_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">home_dwell_time</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">force_scan_intvl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">force_scan_interval</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">num_ch</span> <span class="o">=</span> <span class="n">num_chan</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ch_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ch_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_START_SCAN_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_scanparams_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">fg_start_sec</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">fg_end_sec</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bg_sec</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">minact_chdw_msec</span><span class="p">,</span> <span class="n">u16</span> <span class="n">maxact_chdw_msec</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">pas_chdw_msec</span><span class="p">,</span> <span class="n">u8</span> <span class="n">short_scan_ratio</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">scan_ctrl_flag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">max_dfsch_act_time</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">maxact_scan_per_ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_scan_params_cmd</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_scan_params_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">fg_start_period</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fg_start_sec</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">fg_end_period</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fg_end_sec</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">bg_period</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bg_sec</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">minact_chdwell_time</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">minact_chdw_msec</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">maxact_chdwell_time</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">maxact_chdw_msec</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">pas_chdwell_time</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pas_chdw_msec</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">short_scan_ratio</span> <span class="o">=</span> <span class="n">short_scan_ratio</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">scan_ctrl_flags</span> <span class="o">=</span> <span class="n">scan_ctrl_flag</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">max_dfsch_act_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">max_dfsch_act_time</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">maxact_scan_per_ssid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">maxact_scan_per_ssid</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_SCAN_PARAMS_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_bssfilter_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">filter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ie_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_bss_filter_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&gt;=</span> <span class="n">LAST_BSS_FILTER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_bss_filter_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bss_filter</span> <span class="o">=</span> <span class="n">filter</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ie_mask</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ie_mask</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_BSS_FILTER_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_probedssid_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flag</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">ssid_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_probed_ssid_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">MAX_PROBED_SSID_INDEX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DISABLE_SSID_FLAG</span> <span class="o">|</span> <span class="n">ANY_SSID_FLAG</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">SPECIFIC_SSID_FLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ssid_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">SPECIFIC_SSID_FLAG</span><span class="p">)</span>
		<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">is_probe_ssid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_probed_ssid_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">entry_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_PROBED_SSID_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_listeninterval_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">listen_interval</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">listen_beacons</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_listen_int_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_listen_int_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">listen_intvl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">listen_interval</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_beacons</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">listen_beacons</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_LISTEN_INT_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_bmisstime_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">bmiss_time</span><span class="p">,</span> <span class="n">u16</span> <span class="n">num_beacons</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_bmiss_time_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_bmiss_time_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bmiss_time</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bmiss_time</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_beacons</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">num_beacons</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_BMISS_TIME_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_powermode_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pwr_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_power_mode_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_power_mode_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pwr_mode</span> <span class="o">=</span> <span class="n">pwr_mode</span><span class="p">;</span>
	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">pwr_mode</span> <span class="o">=</span> <span class="n">pwr_mode</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_POWER_MODE_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_pmparams_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">idle_period</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">ps_poll_num</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dtim_policy</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">tx_wakeup_policy</span><span class="p">,</span> <span class="n">u16</span> <span class="n">num_tx_to_wakeup</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">ps_fail_event_policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_power_params_cmd</span> <span class="o">*</span><span class="n">pm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pm</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pm</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_power_params_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">pm</span><span class="o">-&gt;</span><span class="n">idle_period</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">idle_period</span><span class="p">);</span>
	<span class="n">pm</span><span class="o">-&gt;</span><span class="n">pspoll_number</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ps_poll_num</span><span class="p">);</span>
	<span class="n">pm</span><span class="o">-&gt;</span><span class="n">dtim_policy</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dtim_policy</span><span class="p">);</span>
	<span class="n">pm</span><span class="o">-&gt;</span><span class="n">tx_wakeup_policy</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tx_wakeup_policy</span><span class="p">);</span>
	<span class="n">pm</span><span class="o">-&gt;</span><span class="n">num_tx_to_wakeup</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">num_tx_to_wakeup</span><span class="p">);</span>
	<span class="n">pm</span><span class="o">-&gt;</span><span class="n">ps_fail_event_policy</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ps_fail_event_policy</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_POWER_PARAMS_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_disctimeout_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_disc_timeout_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_disc_timeout_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">discon_timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_DISC_TIMEOUT_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ath6kl_debug_set_disconnect_timeout</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_addkey_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key_index</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">crypto_type</span> <span class="n">key_type</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">key_usage</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key_len</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">*</span><span class="n">key_rsc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_rsc_len</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">*</span><span class="n">key_material</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">key_op_ctrl</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">wmi_sync_flag</span> <span class="n">sync_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_add_cipher_key_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;addkey cmd: key_index=%u key_type=%d key_usage=%d key_len=%d key_op_ctrl=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">key_index</span><span class="p">,</span> <span class="n">key_type</span><span class="p">,</span> <span class="n">key_usage</span><span class="p">,</span> <span class="n">key_len</span><span class="p">,</span> <span class="n">key_op_ctrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">key_index</span> <span class="o">&gt;</span> <span class="n">WMI_MAX_KEY_INDEX</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="n">WMI_MAX_KEY_LEN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">key_material</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="n">key_rsc_len</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">WEP_CRYPT</span> <span class="o">!=</span> <span class="n">key_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">key_rsc</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_add_cipher_key_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_index</span> <span class="o">=</span> <span class="n">key_index</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">key_type</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_usage</span> <span class="o">=</span> <span class="n">key_usage</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">key_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key_material</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_rsc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_rsc</span><span class="p">,</span> <span class="n">key_rsc</span><span class="p">,</span> <span class="n">key_rsc_len</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_op_ctrl</span> <span class="o">=</span> <span class="n">key_op_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_mac_addr</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_ADD_CIPHER_KEY_CMDID</span><span class="p">,</span>
				  <span class="n">sync_flag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_add_krk_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">krk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_add_krk_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_add_krk_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">krk</span><span class="p">,</span> <span class="n">krk</span><span class="p">,</span> <span class="n">WMI_KRK_LEN</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_ADD_KRK_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_deletekey_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_delete_cipher_key_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span> <span class="o">&gt;</span> <span class="n">WMI_MAX_KEY_INDEX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_delete_cipher_key_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_index</span> <span class="o">=</span> <span class="n">key_index</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_DELETE_CIPHER_KEY_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_setpmkid_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
			    <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pmkid</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_setpmkid_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bssid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;&amp;</span> <span class="n">pmkid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_setpmkid_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">,</span> <span class="n">pmkid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">PMKID_ENABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">PMKID_DISABLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_PMKID_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_data_sync_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">ep_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_data_hdr</span> <span class="o">*</span><span class="n">data_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">ep_id</span> <span class="o">==</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">ep_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span><span class="p">));</span>

	<span class="n">data_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">data_hdr</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">SYNC_MSGTYPE</span> <span class="o">&lt;&lt;</span> <span class="n">WMI_DATA_HDR_MSG_TYPE_SHIFT</span><span class="p">;</span>
	<span class="n">data_hdr</span><span class="o">-&gt;</span><span class="n">info3</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">if_idx</span> <span class="o">&amp;</span> <span class="n">WMI_DATA_HDR_IF_IDX_MASK</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_control_tx</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ep_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_sync_point</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_sync_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_data_sync_bufs</span> <span class="n">data_sync_bufs</span><span class="p">[</span><span class="n">WMM_NUM_AC</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">ep_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">num_pri_streams</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">data_sync_bufs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data_sync_bufs</span><span class="p">));</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">WMM_NUM_AC</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">fat_pipe_exist</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">num_pri_streams</span><span class="o">++</span><span class="p">;</span>
			<span class="n">data_sync_bufs</span><span class="p">[</span><span class="n">num_pri_streams</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">traffic_class</span> <span class="o">=</span>
			    <span class="n">index</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_sync_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In the SYNC cmd sent on the control Ep, send a bitmap</span>
<span class="cm">	 * of the data eps on which the Data Sync will be sent</span>
<span class="cm">	 */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_sync_map</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">fat_pipe_exist</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">num_pri_streams</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_sync_bufs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_buf_alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_sync_bufs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If buffer allocation for any of the dataSync fails,</span>
<span class="cm">	 * then do not send the Synchronize cmd on the control ep</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_skb</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send sync cmd followed by sync data messages on all</span>
<span class="cm">	 * endpoints being used</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SYNCHRONIZE_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_skb</span><span class="p">;</span>

	<span class="cm">/* cmd buffer sent, we no longer own it */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">num_pri_streams</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">data_sync_bufs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">skb</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ep_id</span> <span class="o">=</span> <span class="n">ath6kl_ac2_endpoint_id</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span>
					       <span class="n">data_sync_bufs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span>
					       <span class="n">traffic_class</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span>
		    <span class="n">ath6kl_wmi_data_sync_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">data_sync_bufs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">skb</span><span class="p">,</span>
					      <span class="n">ep_id</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">data_sync_bufs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">free_skb:</span>
	<span class="cm">/* free up any resources left over (possibly due to an error) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">num_pri_streams</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_sync_bufs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">((</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="n">data_sync_bufs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span>
				      <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_create_pstream_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">wmi_create_pstream_cmd</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_create_pstream_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fatpipe_exist_for_ac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">min_phy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">nominal_phy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">user_pri</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">user_pri</span> <span class="o">&lt;=</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">up_to_ac</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">user_pri</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">]</span> <span class="o">==</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">traffic_direc</span> <span class="o">==</span> <span class="n">UPLINK_TRAFFIC</span> <span class="o">||</span>
	       <span class="n">params</span><span class="o">-&gt;</span><span class="n">traffic_direc</span> <span class="o">==</span> <span class="n">DNLINK_TRAFFIC</span> <span class="o">||</span>
	       <span class="n">params</span><span class="o">-&gt;</span><span class="n">traffic_direc</span> <span class="o">==</span> <span class="n">BIDIR_TRAFFIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">traffic_type</span> <span class="o">==</span> <span class="n">TRAFFIC_TYPE_APERIODIC</span> <span class="o">||</span>
	       <span class="n">params</span><span class="o">-&gt;</span><span class="n">traffic_type</span> <span class="o">==</span> <span class="n">TRAFFIC_TYPE_PERIODIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">voice_psc_cap</span> <span class="o">==</span> <span class="n">DISABLE_FOR_THIS_AC</span> <span class="o">||</span>
	       <span class="n">params</span><span class="o">-&gt;</span><span class="n">voice_psc_cap</span> <span class="o">==</span> <span class="n">ENABLE_FOR_THIS_AC</span> <span class="o">||</span>
	       <span class="n">params</span><span class="o">-&gt;</span><span class="n">voice_psc_cap</span> <span class="o">==</span> <span class="n">ENABLE_FOR_ALL_AC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">tsid</span> <span class="o">==</span> <span class="n">WMI_IMPLICIT_PSTREAM</span> <span class="o">||</span>
	       <span class="n">params</span><span class="o">-&gt;</span><span class="n">tsid</span> <span class="o">&lt;=</span> <span class="n">WMI_MAX_THINSTREAM</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check nominal PHY rate is &gt;= minimalPHY,</span>
<span class="cm">	 * so that DUT can allow TSRS IE</span>
<span class="cm">	 */</span>

	<span class="cm">/* Get the physical rate (units of bps) */</span>
	<span class="n">min_phy</span> <span class="o">=</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">min_phy_rate</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* Check minimal phy &lt; nominal phy rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">nominal_phy</span> <span class="o">&gt;=</span> <span class="n">min_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unit of 500 kbps */</span>
		<span class="n">nominal_phy</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">nominal_phy</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">500</span><span class="p">;</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
			   <span class="s">&quot;TSRS IE enabled::MinPhy %x-&gt;NominalPhy ===&gt; %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">min_phy</span><span class="p">,</span> <span class="n">nominal_phy</span><span class="p">);</span>

		<span class="n">params</span><span class="o">-&gt;</span><span class="n">nominal_phy</span> <span class="o">=</span> <span class="n">nominal_phy</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">nominal_phy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;sending create_pstream_cmd: ac=%d  tsid:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">params</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">tsid</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_create_pstream_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="cm">/* This is an implicitly created Fat pipe */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">tsid</span> <span class="o">==</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">WMI_IMPLICIT_PSTREAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">fatpipe_exist_for_ac</span> <span class="o">=</span> <span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">fat_pipe_exist</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">));</span>
		<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">fat_pipe_exist</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* explicitly created thin stream within a fat pipe */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">fatpipe_exist_for_ac</span> <span class="o">=</span> <span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">fat_pipe_exist</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">));</span>
		<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">stream_exist_for_ac</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">]</span> <span class="o">|=</span>
		    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">tsid</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If a thinstream becomes active, the fat pipe automatically</span>
<span class="cm">		 * becomes active</span>
<span class="cm">		 */</span>
		<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">fat_pipe_exist</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Indicate activty change to driver layer only if this is the</span>
<span class="cm">	 * first TSID to get created in this AC explicitly or an implicit</span>
<span class="cm">	 * fat pipe is getting created.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fatpipe_exist_for_ac</span><span class="p">)</span>
		<span class="n">ath6kl_indicate_tx_activity</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span>
					    <span class="n">params</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_CREATE_PSTREAM_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_delete_pstream_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">traffic_class</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">tsid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_delete_pstream_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">active_tsids</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">traffic_class</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;invalid traffic class: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">traffic_class</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_delete_pstream_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">traffic_class</span> <span class="o">=</span> <span class="n">traffic_class</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tsid</span> <span class="o">=</span> <span class="n">tsid</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">active_tsids</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">stream_exist_for_ac</span><span class="p">[</span><span class="n">traffic_class</span><span class="p">];</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">active_tsids</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tsid</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
			   <span class="s">&quot;TSID %d doesn&#39;t exist for traffic class: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">tsid</span><span class="p">,</span> <span class="n">traffic_class</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;sending delete_pstream_cmd: traffic class: %d tsid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">traffic_class</span><span class="p">,</span> <span class="n">tsid</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_DELETE_PSTREAM_CMDID</span><span class="p">,</span>
				  <span class="n">SYNC_BEFORE_WMIFLAG</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">stream_exist_for_ac</span><span class="p">[</span><span class="n">traffic_class</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tsid</span><span class="p">);</span>
	<span class="n">active_tsids</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">stream_exist_for_ac</span><span class="p">[</span><span class="n">traffic_class</span><span class="p">];</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Indicate stream inactivity to driver layer only if all tsids</span>
<span class="cm">	 * within this AC are deleted.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">active_tsids</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_indicate_tx_activity</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span>
					    <span class="n">traffic_class</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">fat_pipe_exist</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">traffic_class</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_ip_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
			  <span class="n">__be32</span> <span class="n">ips0</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">ips1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_set_ip_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Multicast address are not valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">ips0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">ips1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_ip_cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_ip_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ips0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ips</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ips1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_IP_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_wmi_relinquish_implicit_pstream_credits</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">active_tsids</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stream_exist</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Relinquish credits from all implicitly created pstreams</span>
<span class="cm">	 * since when we go to sleep. If user created explicit</span>
<span class="cm">	 * thinstreams exists with in a fatpipe leave them intact</span>
<span class="cm">	 * for the user to delete.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">stream_exist</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">fat_pipe_exist</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WMM_NUM_AC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream_exist</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			 * FIXME: Is this lock &amp; unlock inside</span>
<span class="cm">			 * for loop correct? may need rework.</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">active_tsids</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">stream_exist_for_ac</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * If there are no user created thin streams</span>
<span class="cm">			 * delete the fatpipe</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">active_tsids</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stream_exist</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * Indicate inactivity to driver layer for</span>
<span class="cm">				 * this fatpipe (pstream)</span>
<span class="cm">				 */</span>
				<span class="n">ath6kl_indicate_tx_activity</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span>
							    <span class="n">i</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: Can we do this assignment without locking ? */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">fat_pipe_exist</span> <span class="o">=</span> <span class="n">stream_exist</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_host_sleep_mode_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">ath6kl_host_mode</span> <span class="n">host_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_set_host_sleep_mode_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">host_mode</span> <span class="o">!=</span> <span class="n">ATH6KL_HOST_MODE_ASLEEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">host_mode</span> <span class="o">!=</span> <span class="n">ATH6KL_HOST_MODE_AWAKE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;invalid host sleep mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_host_sleep_mode_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host_mode</span> <span class="o">==</span> <span class="n">ATH6KL_HOST_MODE_ASLEEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_wmi_relinquish_implicit_pstream_credits</span><span class="p">(</span><span class="n">wmi</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">asleep</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">awake</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
				  <span class="n">WMI_SET_HOST_SLEEP_MODE_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This command has zero length payload */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_host_sleep_mode_cmd_prcd_evt_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span>
						      <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">HOST_SLEEP_MODE_CMD_PROCESSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_wow_mode_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">ath6kl_wow_mode</span> <span class="n">wow_mode</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">filter</span><span class="p">,</span> <span class="n">u16</span> <span class="n">host_req_delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_set_wow_mode_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wow_mode</span> <span class="o">!=</span> <span class="n">ATH6KL_WOW_MODE_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">wow_mode</span> <span class="o">!=</span> <span class="n">ATH6KL_WOW_MODE_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;invalid wow mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wow_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_wow_mode_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">enable_wow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wow_mode</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_req_delay</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">host_req_delay</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_WOW_MODE_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_add_wow_pattern_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">list_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">filter_size</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">filter_offset</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
				   <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_add_wow_pattern_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">filter_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate additional memory in the buffer to hold</span>
<span class="cm">	 * filter and mask value, which is twice of filter_size.</span>
<span class="cm">	 */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">filter_size</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_add_wow_pattern_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">filter_list_id</span> <span class="o">=</span> <span class="n">list_id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">filter_size</span> <span class="o">=</span> <span class="n">filter_size</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">filter_offset</span> <span class="o">=</span> <span class="n">filter_offset</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">,</span> <span class="n">filter</span><span class="p">,</span> <span class="n">filter_size</span><span class="p">);</span>

	<span class="n">filter_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">+</span> <span class="n">filter_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">filter_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">filter_size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_ADD_WOW_PATTERN_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_del_wow_pattern_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">list_id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">filter_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_del_wow_pattern_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_del_wow_pattern_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">filter_list_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">list_id</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">filter_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">filter_id</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_DEL_WOW_PATTERN_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_cmd_send_xtnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">wmix_command_id</span> <span class="n">cmd_id</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">wmi_sync_flag</span> <span class="n">sync_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmix_cmd_hdr</span> <span class="o">*</span><span class="n">cmd_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmix_cmd_hdr</span><span class="p">));</span>

	<span class="n">cmd_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmix_cmd_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd_hdr</span><span class="o">-&gt;</span><span class="n">cmd_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd_id</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_EXTENSION_CMDID</span><span class="p">,</span> <span class="n">sync_flag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_get_challenge_resp_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">u32</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmix_hb_challenge_resp_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmix_hb_challenge_resp_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cookie</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send_xtnd</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMIX_HB_CHALLENGE_RESP_CMDID</span><span class="p">,</span>
				       <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_config_debug_module_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">valid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_wmix_dbglog_cfg_module_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_wmix_dbglog_cfg_module_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">valid</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send_xtnd</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMIX_DBGLOG_CFG_MODULE_CMDID</span><span class="p">,</span>
				       <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_get_stats_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_simple_cmd</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">WMI_GET_STATISTICS_CMDID</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_tx_pwr_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dbM</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_set_tx_pwr_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_tx_pwr_cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_tx_pwr_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dbM</span> <span class="o">=</span> <span class="n">dbM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_TX_PWR_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_get_tx_pwr_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_simple_cmd</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">WMI_GET_TX_PWR_CMDID</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_get_roam_tbl_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_simple_cmd</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WMI_GET_ROAM_TBL_CMDID</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_lpreamble_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">preamble_policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_set_lpreamble_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_lpreamble_cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_lpreamble_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">preamble_policy</span> <span class="o">=</span> <span class="n">preamble_policy</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_LPREAMBLE_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_rts_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_set_rts_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_rts_cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_rts_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">threshold</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_RTS_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_wmm_txop</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="k">enum</span> <span class="n">wmi_txop_cfg</span> <span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_set_wmm_txop_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">cfg</span> <span class="o">==</span> <span class="n">WMI_TXOP_DISABLED</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">==</span> <span class="n">WMI_TXOP_ENABLED</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_wmm_txop_cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_wmm_txop_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">txop_enable</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_WMM_TXOP_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_keepalive_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">keep_alive_intvl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_set_keepalive_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_keepalive_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">keep_alive_intvl</span> <span class="o">=</span> <span class="n">keep_alive_intvl</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_KEEPALIVE_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ath6kl_debug_set_keepalive</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">keep_alive_intvl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_htcap_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ath6kl_htcap</span> <span class="o">*</span><span class="n">htcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_set_htcap_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_htcap_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE: Band in firmware matches enum ieee80211_band, it is unlikely</span>
<span class="cm">	 * this will be changed in firmware. If at all there is any change in</span>
<span class="cm">	 * band value, the host needs to be fixed.</span>
<span class="cm">	 */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ht_enable</span> <span class="o">=</span> <span class="o">!!</span><span class="n">htcap</span><span class="o">-&gt;</span><span class="n">ht_enable</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ht20_sgi</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">htcap</span><span class="o">-&gt;</span><span class="n">cap_info</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_20</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ht40_supported</span> <span class="o">=</span>
		<span class="o">!!</span><span class="p">(</span><span class="n">htcap</span><span class="o">-&gt;</span><span class="n">cap_info</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SUP_WIDTH_20_40</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ht40_sgi</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">htcap</span><span class="o">-&gt;</span><span class="n">cap_info</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">intolerant_40mhz</span> <span class="o">=</span>
		<span class="o">!!</span><span class="p">(</span><span class="n">htcap</span><span class="o">-&gt;</span><span class="n">cap_info</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_40MHZ_INTOLERANT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_ampdu_len_exp</span> <span class="o">=</span> <span class="n">htcap</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;Set htcap: band:%d ht_enable:%d 40mhz:%d sgi_20mhz:%d sgi_40mhz:%d 40mhz_intolerant:%d ampdu_len_exp:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ht_enable</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ht40_supported</span><span class="p">,</span>
		   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ht20_sgi</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ht40_sgi</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">intolerant_40mhz</span><span class="p">,</span>
		   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">max_ampdu_len_exp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_HT_CAP_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_test_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_TEST_CMDID</span><span class="p">,</span> <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_mcast_filter_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mc_all_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_mcast_filter_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_mcast_filter_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mcast_all_enable</span> <span class="o">=</span> <span class="n">mc_all_on</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_MCAST_FILTER_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_add_del_mcast_filter_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
					<span class="n">u8</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="n">bool</span> <span class="n">add_filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_mcast_filter_add_del_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x33</span> <span class="o">||</span> <span class="n">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x33</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x01</span> <span class="o">||</span> <span class="n">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span> <span class="o">||</span>
	    <span class="n">filter</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x5e</span> <span class="o">||</span> <span class="n">filter</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;invalid multicast filter address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_mcast_filter_add_del_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mcast_mac</span><span class="p">,</span> <span class="n">filter</span><span class="p">,</span> <span class="n">ATH6KL_MCAST_FILTER_MAC_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
				  <span class="n">add_filter</span> <span class="o">?</span> <span class="n">WMI_SET_MCAST_FILTER_CMDID</span> <span class="o">:</span>
				  <span class="n">WMI_DEL_MCAST_FILTER_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">s32</span> <span class="nf">ath6kl_wmi_get_rate</span><span class="p">(</span><span class="n">s8</span> <span class="n">rate_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_index</span> <span class="o">==</span> <span class="n">RATE_AUTO</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">wmi_rate_tbl</span><span class="p">[(</span><span class="n">u32</span><span class="p">)</span> <span class="n">rate_index</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_get_pmkid_list_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span>
					      <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_pmkid_list_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">expected_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_pmkid_list_reply</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_pmkid_list_reply</span> <span class="o">*</span><span class="p">)</span><span class="n">datap</span><span class="p">;</span>
	<span class="n">expected_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">num_pmkid</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">num_pmkid</span><span class="p">)</span> <span class="o">*</span> <span class="n">WMI_PMKID_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">expected_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_addba_req_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_addba_req_event</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_addba_req_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="n">aggr_recv_addba_req_evt</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">st_seq_no</span><span class="p">),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">win_sz</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_delba_req_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_delba_event</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_delba_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="n">aggr_recv_delba_req_evt</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  AP mode functions */</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_ap_profile_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">wmi_connect_cmd</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_connect_cmd</span> <span class="o">*</span><span class="n">cm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cm</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cm</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_connect_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cm</span><span class="p">));</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmip</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_AP_CONFIG_COMMIT_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;%s: nw_type=%u auth_mode=%u ch=%u ctrl_flags=0x%x-&gt; res=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nw_type</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">auth_mode</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">),</span>
		   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ctrl_flags</span><span class="p">),</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_ap_set_mlme</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_ap_set_mlme_cmd</span> <span class="o">*</span><span class="n">cm</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cm</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cm</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_ap_set_mlme_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">reason</span><span class="p">);</span>
	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;ap_set_mlme: cmd=%d reason=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span>
		   <span class="n">cm</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmip</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_AP_SET_MLME_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_ap_hidden_ssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_ap_hidden_ssid_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_ap_hidden_ssid_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hidden_ssid</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_AP_HIDDEN_SSID_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This command will be used to enable/disable AP uAPSD feature */</span>
<span class="kt">int</span> <span class="nf">ath6kl_wmi_ap_set_apsd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_ap_set_apsd_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_ap_set_apsd_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_AP_SET_APSD_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_apsd_bfrd_traf</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
					     <span class="n">u16</span> <span class="n">aid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bitmap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_ap_apsd_buffered_traffic_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_ap_apsd_buffered_traffic_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">aid</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
				   <span class="n">WMI_AP_APSD_BUFFERED_TRAFFIC_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_pspoll_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_pspoll_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_pspoll_event</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_pspoll_event</span> <span class="o">*</span><span class="p">)</span> <span class="n">datap</span><span class="p">;</span>

	<span class="n">ath6kl_pspoll_event</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_dtimexpiry_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath6kl_dtimexpiry_event</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_pvb_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">aid</span><span class="p">,</span>
			   <span class="n">bool</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_ap_set_pvb_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_ap_set_pvb_cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_ap_set_pvb_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">aid</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rsvd</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_AP_SET_PVB_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_rx_frame_format_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">rx_meta_ver</span><span class="p">,</span>
				       <span class="n">bool</span> <span class="n">rx_dot11_hdr</span><span class="p">,</span> <span class="n">bool</span> <span class="n">defrag_on_host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_rx_frame_format_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_rx_frame_format_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dot11_hdr</span> <span class="o">=</span> <span class="n">rx_dot11_hdr</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">defrag_on_host</span> <span class="o">=</span> <span class="n">defrag_on_host</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">meta_ver</span> <span class="o">=</span> <span class="n">rx_meta_ver</span><span class="p">;</span>

	<span class="cm">/* Delete the local aggr state, on host */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_RX_FRAME_FORMAT_CMDID</span><span class="p">,</span>
				  <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_appie_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mgmt_frm_type</span><span class="p">,</span>
			     <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ie_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_set_appie_cmd</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">ie_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;set_appie_cmd: mgmt_frm_type=%u ie_len=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">mgmt_frm_type</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_appie_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">mgmt_frm_type</span> <span class="o">=</span> <span class="n">mgmt_frm_type</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ie_len</span> <span class="o">=</span> <span class="n">ie_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ie</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ie_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ie_info</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_APPIE_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_ie_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ie_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ie_field</span><span class="p">,</span>
			  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie_info</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ie_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_set_ie_cmd</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">ie_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;set_ie_cmd: ie_id=%u ie_ie_field=%u ie_len=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ie_id</span><span class="p">,</span> <span class="n">ie_field</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_ie_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ie_id</span> <span class="o">=</span> <span class="n">ie_id</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ie_field</span> <span class="o">=</span> <span class="n">ie_field</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ie_len</span> <span class="o">=</span> <span class="n">ie_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ie_info</span> <span class="o">&amp;&amp;</span> <span class="n">ie_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ie_info</span><span class="p">,</span> <span class="n">ie_info</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SET_IE_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_disable_11b_rates_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">bool</span> <span class="n">disable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_disable_11b_rates_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;disable_11b_rates_cmd: disable=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">disable</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_disable_11b_rates_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">disable</span> <span class="o">=</span> <span class="n">disable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_DISABLE_11B_RATES_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_remain_on_chnl_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">freq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_remain_on_chnl_cmd</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;remain_on_chnl_cmd: freq=%u dur=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">freq</span><span class="p">,</span> <span class="n">dur</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_remain_on_chnl_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">freq</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">duration</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dur</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_REMAIN_ON_CHNL_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ath6kl_wmi_send_action_cmd is to be deprecated. Use</span>
<span class="cm"> * ath6kl_wmi_send_mgmt_cmd instead. The new function supports P2P</span>
<span class="cm"> * mgmt operations using station interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_send_action_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">freq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">wait</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_send_action_cmd</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* Offload for wait not supported */</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">data_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">last_mgmt_tx_frame</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">last_mgmt_tx_frame</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">last_mgmt_tx_frame_len</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;send_action_cmd: id=%u freq=%u wait=%u len=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">id</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">wait</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_send_action_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">freq</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">data_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SEND_ACTION_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ath6kl_wmi_send_mgmt_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">freq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">wait</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">no_cck</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_send_mgmt_cmd</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* Offload for wait not supported */</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">data_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">last_mgmt_tx_frame</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">last_mgmt_tx_frame</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">last_mgmt_tx_frame_len</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;send_action_cmd: id=%u freq=%u wait=%u len=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">id</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">wait</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_send_mgmt_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">freq</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">no_cck</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">no_cck</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">data_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_SEND_MGMT_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_send_mgmt_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">freq</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">wait</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data_len</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">no_cck</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATH6KL_FW_CAPABILITY_STA_P2PDEV_DUPLEX</span><span class="p">,</span>
		     <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_capabilities</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If capable of doing P2P mgmt operations using</span>
<span class="cm">		 * station interface, send additional information like</span>
<span class="cm">		 * supported rates to advertise and xmit rates for</span>
<span class="cm">		 * probe requests</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">__ath6kl_wmi_send_mgmt_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span>
						    <span class="n">wait</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span>
						    <span class="n">no_cck</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_wmi_send_action_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span>
						    <span class="n">wait</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_send_probe_response_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">freq</span><span class="p">,</span>
				       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				       <span class="n">u16</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_p2p_probe_response_cmd</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">cmd_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">data_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cmd_len</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* work around target minimum length requirement */</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
		   <span class="s">&quot;send_probe_response_cmd: freq=%u dst=%pM len=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">freq</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_p2p_probe_response_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">freq</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">destination_addr</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">data_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
				   <span class="n">WMI_SEND_PROBE_RESPONSE_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_probe_report_req_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_probe_req_report_cmd</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;probe_report_req_cmd: enable=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">enable</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_probe_req_report_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_PROBE_REQ_REPORT_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_info_req_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">info_req_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_get_p2p_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;info_req_cmd: flags=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">info_req_flags</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_get_p2p_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">info_req_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">info_req_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_GET_P2P_INFO_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_cancel_remain_on_chnl_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;cancel_remain_on_chnl_cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_simple_cmd</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span>
				     <span class="n">WMI_CANCEL_REMAIN_ON_CHNL_CMDID</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_wmi_set_inact_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inact_timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_set_inact_period_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_new_buf</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_set_inact_period_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">inact_period</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">inact_timeout</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_null_func</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_cmd_send</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">WMI_AP_CONN_INACT_CMDID</span><span class="p">,</span>
				   <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_control_rx_xtnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmix_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmix_cmd_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;bad packet 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmix_cmd_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_id</span><span class="p">);</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmix_cmd_hdr</span><span class="p">));</span>

	<span class="n">datap</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WMIX_HB_CHALLENGE_RESP_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;wmi event hb challenge resp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMIX_DBGLOG_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;wmi event dbglog len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">ath6kl_debug_fwlog_event</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;unknown cmd id 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_roam_tbl_event_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ath6kl_debug_roam_tbl_event</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Process interface specific wmi events, caller would free the datap */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_proc_events_vif</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd_id</span><span class="p">,</span>
					<span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_get_vif_by_index</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
			   <span class="s">&quot;Wmi event for unavailable vif, vif_index:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">if_idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WMI_CONNECT_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_CONNECT_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_connect_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_DISCONNECT_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_DISCONNECT_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_disconnect_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_TKIP_MICERR_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_TKIP_MICERR_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_tkip_micerr_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_BSSINFO_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_BSSINFO_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_bssinfo_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_NEIGHBOR_REPORT_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_NEIGHBOR_REPORT_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_neighbor_report_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
							   <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_SCAN_COMPLETE_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_SCAN_COMPLETE_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_scan_complete_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_REPORT_STATISTICS_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_REPORT_STATISTICS_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_stats_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_CAC_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_CAC_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_cac_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_PSPOLL_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_PSPOLL_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_pspoll_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_DTIMEXPIRY_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_DTIMEXPIRY_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_dtimexpiry_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_ADDBA_REQ_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_ADDBA_REQ_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_addba_req_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_DELBA_REQ_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_DELBA_REQ_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_delba_req_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_SET_HOST_SLEEP_MODE_CMD_PROCESSED_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
			   <span class="s">&quot;WMI_SET_HOST_SLEEP_MODE_CMD_PROCESSED_EVENTID&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_host_sleep_mode_cmd_prcd_evt_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_REMAIN_ON_CHNL_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_REMAIN_ON_CHNL_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_remain_on_chnl_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_CANCEL_REMAIN_ON_CHNL_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
			   <span class="s">&quot;WMI_CANCEL_REMAIN_ON_CHNL_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_cancel_remain_on_chnl_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span>
								 <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_TX_STATUS_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_TX_STATUS_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_tx_status_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_RX_PROBE_REQ_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_RX_PROBE_REQ_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_rx_probe_req_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WMI_RX_ACTION_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_RX_ACTION_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_rx_action_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;unknown cmd id 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wmi_proc_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">if_idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_cmd_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_id</span><span class="p">);</span>
	<span class="n">if_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">info1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WMI_CMD_HDR_IF_ID_MASK</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_cmd_hdr</span><span class="p">));</span>
	<span class="n">datap</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;wmi rx id %d len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI_DUMP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;wmi rx &quot;</span><span class="p">,</span>
			<span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WMI_GET_BITRATE_CMDID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_GET_BITRATE_CMDID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_bitrate_reply_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_GET_CHANNEL_LIST_CMDID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_GET_CHANNEL_LIST_CMDID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_ch_list_reply_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_GET_TX_PWR_CMDID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_GET_TX_PWR_CMDID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_tx_pwr_reply_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_READY_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_READY_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_ready_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_PEER_NODE_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_PEER_NODE_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_peer_node_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_REGDOMAIN_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_REGDOMAIN_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ath6kl_wmi_regdomain_event</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_PSTREAM_TIMEOUT_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_PSTREAM_TIMEOUT_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_pstream_timeout_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_CMDERROR_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_CMDERROR_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_error_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_RSSI_THRESHOLD_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_RSSI_THRESHOLD_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_rssi_threshold_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_ERROR_REPORT_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_ERROR_REPORT_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_OPT_RX_FRAME_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_OPT_RX_FRAME_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* this event has been deprecated */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_REPORT_ROAM_TBL_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_REPORT_ROAM_TBL_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_roam_tbl_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_EXTENSION_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_EXTENSION_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_control_rx_xtnd</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_CHANNEL_CHANGE_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_CHANNEL_CHANGE_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_REPORT_ROAM_DATA_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_REPORT_ROAM_DATA_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_TEST_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_TEST_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_test_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_GET_FIXRATES_CMDID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_GET_FIXRATES_CMDID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_ratemask_reply_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_TX_RETRY_ERR_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_TX_RETRY_ERR_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_SNR_THRESHOLD_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_SNR_THRESHOLD_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_snr_threshold_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_LQ_THRESHOLD_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_LQ_THRESHOLD_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_APLIST_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_APLIST_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_aplist_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_GET_KEEPALIVE_CMDID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_GET_KEEPALIVE_CMDID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_keepalive_reply_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_GET_WOW_LIST_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_GET_WOW_LIST_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_GET_PMKID_LIST_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_GET_PMKID_LIST_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_pmkid_list_event_rx</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_SET_PARAMS_REPLY_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_SET_PARAMS_REPLY_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_ADDBA_RESP_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_ADDBA_RESP_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_REPORT_BTCOEX_CONFIG_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
			   <span class="s">&quot;WMI_REPORT_BTCOEX_CONFIG_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_REPORT_BTCOEX_STATS_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span>
			   <span class="s">&quot;WMI_REPORT_BTCOEX_STATS_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_TX_COMPLETE_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_TX_COMPLETE_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_tx_complete_event_rx</span><span class="p">(</span><span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_P2P_CAPABILITIES_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_P2P_CAPABILITIES_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_p2p_capabilities_event_rx</span><span class="p">(</span><span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_P2P_INFO_EVENTID</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WMI</span><span class="p">,</span> <span class="s">&quot;WMI_P2P_INFO_EVENTID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_p2p_info_event_rx</span><span class="p">(</span><span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* may be the event is interface specific */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_proc_events_vif</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Control Path */</span>
<span class="kt">int</span> <span class="nf">ath6kl_wmi_control_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_cmd_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;bad packet 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_proc_events</span><span class="p">(</span><span class="n">wmi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_wmi_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">fat_pipe_exist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">stream_exist_for_ac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">stream_exist_for_ac</span><span class="p">));</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">ath6kl_wmi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">;</span>

	<span class="n">wmi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wmi</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">parent_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">wmi</span><span class="o">-&gt;</span><span class="n">pwr_mode</span> <span class="o">=</span> <span class="n">REC_POWER</span><span class="p">;</span>

	<span class="n">ath6kl_wmi_reset</span><span class="p">(</span><span class="n">wmi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wmi</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_wmi_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi</span> <span class="o">*</span><span class="n">wmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wmi</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">last_mgmt_tx_frame</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wmi</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
