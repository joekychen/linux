<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath6kl › htc_pipe.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>htc_pipe.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2007-2011 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;hif-ops.h&quot;</span>

<span class="cp">#define HTC_PACKET_CONTAINER_ALLOCATION 32</span>
<span class="cp">#define HTC_CONTROL_BUFFER_SIZE (HTC_MAX_CTRL_MSG_LEN + HTC_HDR_LENGTH)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ath6kl_htc_pipe_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ath6kl_htc_pipe_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>

<span class="cm">/* htc pipe tx path */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">restore_tx_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HTC_FLAGS_TX_FIXUP_NETBUF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_frame_hdr</span><span class="p">));</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HTC_FLAGS_TX_FIXUP_NETBUF</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_send_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">queue_to_indicate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">queue_to_indicate</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* nothing to indicate */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">tx_comp_multi</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;%s: calling ep %d, send complete multiple callback (%d pkts)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span>
			   <span class="n">get_queue_depth</span><span class="p">(</span><span class="n">queue_to_indicate</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * a multiple send complete handler is being used,</span>
<span class="cm">		 * pass the queue to the handler</span>
<span class="cm">		 */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">tx_comp_multi</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">queue_to_indicate</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * all packets are now owned by the callback,</span>
<span class="cm">		 * reset queue to be safe</span>
<span class="cm">		 */</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="n">queue_to_indicate</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* using legacy EpTxComplete */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">queue_to_indicate</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				   <span class="s">&quot;%s: calling ep %d send complete callback on packet 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">tx_complete</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">queue_to_indicate</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_packet_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">container</span><span class="p">;</span>

	<span class="n">restore_tx_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>

	<span class="cm">/* do completion */</span>
	<span class="n">do_send_completion</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_htc_packet_credit_based</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">credits_required</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">remainder</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">send_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">transfer_len</span><span class="p">;</span>

	<span class="cm">/* NOTE : the TX lock is held when this function is called */</span>

	<span class="cm">/* loop until we can grab as many packets out of the queue as we can */</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* get packet at head, but don&#39;t remove it */</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;%s: got head packet:0x%p , queue depth: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">));</span>

		<span class="n">transfer_len</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">transfer_len</span> <span class="o">&lt;=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">credits_required</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* figure out how many credits this message requires */</span>
			<span class="n">credits_required</span> <span class="o">=</span> <span class="n">transfer_len</span> <span class="o">/</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">;</span>
			<span class="n">remainder</span> <span class="o">=</span> <span class="n">transfer_len</span> <span class="o">%</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">remainder</span><span class="p">)</span>
				<span class="n">credits_required</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;%s: creds required:%d got:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">credits_required</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">==</span> <span class="n">ENDPOINT_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * endpoint 0 is special, it always has a credit and</span>
<span class="cm">			 * does not require credit based flow control</span>
<span class="cm">			 */</span>
			<span class="n">credits_required</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span> <span class="o">&lt;</span> <span class="n">credits_required</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span> <span class="o">-=</span> <span class="n">credits_required</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">cred_cosumd</span> <span class="o">+=</span> <span class="n">credits_required</span><span class="p">;</span>

			<span class="cm">/* check if we need credits back from the target */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span> <span class="o">&lt;</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_per_msg</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* tell the target we need credits ASAP! */</span>
				<span class="n">send_flags</span> <span class="o">|=</span> <span class="n">HTC_FLAGS_NEED_CREDIT_UPDATE</span><span class="p">;</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">cred_low_indicate</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
					   <span class="s">&quot;%s: host needs credits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* now we can fully dequeue */</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="cm">/* save the number of credits this packet consumed */</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">cred_used</span> <span class="o">=</span> <span class="n">credits_required</span><span class="p">;</span>
		<span class="cm">/* save send flags */</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">send_flags</span><span class="p">;</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* queue this packet into the caller&#39;s queue */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_htc_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">resources</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

	<span class="cm">/* NOTE : the TX lock is held when this function is called */</span>

	<span class="cm">/* loop until we can grab as many packets out of the queue as we can */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">resources</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;%s: got packet:0x%p , new queue depth: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">));</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">;</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">cred_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* queue this packet into the caller&#39;s queue */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">resources</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">htc_issue_packets</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pkt_queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">payload_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="n">htc_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;%s: queue: 0x%p, pkts %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">pkt_queue</span><span class="p">,</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">payload_len</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">;</span>

		<span class="cm">/* setup HTC frame header */</span>
		<span class="n">htc_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
							    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">htc_hdr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">htc_hdr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HTC_FLAGS_TX_FIXUP_NETBUF</span><span class="p">;</span>

		<span class="cm">/* Endianess? */</span>
		<span class="n">put_unaligned</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">payload_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">payld_len</span><span class="p">);</span>
		<span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">;</span>
		<span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">seqno</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

		<span class="cm">/* store in look up queue to match completions */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">tx_lookup_queue</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">tx_issued</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_hif_pipe_send</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span>
					      <span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">pipeid_ul</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* TODO: if more than 1 endpoint maps to the</span>
<span class="cm">				 * same PipeID, it is possible to run out of</span>
<span class="cm">				 * resources in the HIF layer.</span>
<span class="cm">				 * Don&#39;t emit the error</span>
<span class="cm">				 */</span>
				<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
					   <span class="s">&quot;%s: failed status:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

			<span class="cm">/* reclaim credits */</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span> <span class="o">+=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">cred_used</span><span class="p">;</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

			<span class="cm">/* put it back into the callers queue */</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">pkt_queue</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
					   <span class="s">&quot;%s: failed pkt:0x%p status:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="n">send_packet_completion</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">htc_send_queue_result</span> <span class="nf">htc_try_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">send_queue</span><span class="p">;</span>	<span class="cm">/* temp queue to hold packets */</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_send_full_action</span> <span class="n">action</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_resources</span><span class="p">,</span> <span class="n">overflow</span><span class="p">,</span> <span class="n">txqueue_depth</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">good_pkts</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pipeid</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;%s: (queue:0x%p depth:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">txq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="n">txq</span><span class="p">));</span>

	<span class="cm">/* init the local send queue */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_queue</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * txq equals to NULL means</span>
<span class="cm">	 * caller didn&#39;t provide a queue, just wants us to</span>
<span class="cm">	 * check queues and send</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* empty queue */</span>
			<span class="k">return</span> <span class="n">HTC_SEND_QUEUE_DROP</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
		<span class="n">txqueue_depth</span> <span class="o">=</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txqueue_depth</span> <span class="o">&gt;=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">max_txq_depth</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we&#39;ve already overflowed */</span>
			<span class="n">overflow</span> <span class="o">=</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* get how much we will overflow by */</span>
			<span class="n">overflow</span> <span class="o">=</span> <span class="n">txqueue_depth</span><span class="p">;</span>
			<span class="n">overflow</span> <span class="o">+=</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
			<span class="cm">/* get how much we will overflow the TX queue by */</span>
			<span class="n">overflow</span> <span class="o">-=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">max_txq_depth</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* if overflow is negative or zero, we are okay */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">overflow</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				   <span class="s">&quot;%s: Endpoint %d, TX queue will overflow :%d, Tx Depth:%d, Max:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span> <span class="n">overflow</span><span class="p">,</span> <span class="n">txqueue_depth</span><span class="p">,</span>
				   <span class="n">ep</span><span class="o">-&gt;</span><span class="n">max_txq_depth</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">overflow</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">tx_full</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * all packets will fit or caller did not provide send</span>
<span class="cm">			 * full indication handler -- just move all of them</span>
<span class="cm">			 * to the local send_queue object</span>
<span class="cm">			 */</span>
			<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">send_queue</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">good_pkts</span> <span class="o">=</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="n">txq</span><span class="p">)</span> <span class="o">-</span> <span class="n">overflow</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">good_pkts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">HTC_SEND_QUEUE_DROP</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* we have overflowed, and a callback is provided */</span>
			<span class="cm">/* dequeue all non-overflow packets to the sendqueue */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">good_pkts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* pop off caller&#39;s queue */</span>
				<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span>
							  <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span>
							  <span class="n">list</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="cm">/* insert into local queue */</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">send_queue</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * the caller&#39;s queue has all the packets that won&#39;t fit</span>
<span class="cm">			 * walk through the caller&#39;s queue and indicate each to</span>
<span class="cm">			 * the send full handler</span>
<span class="cm">			 */</span>
			<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span>
						 <span class="n">txq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
					   <span class="s">&quot;%s: Indicat overflowed TX pkts: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
				<span class="n">action</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">tx_full</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">HTC_SEND_FULL_DROP</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* callback wants the packet dropped */</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">tx_dropped</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

					<span class="cm">/* leave this one in the caller&#39;s queue</span>
<span class="cm">					 * for cleanup */</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* callback wants to keep this packet,</span>
<span class="cm">					 * remove from caller&#39;s queue */</span>
					<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
					<span class="cm">/* put it in the send queue */</span>
					<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">send_queue</span><span class="p">);</span>
				<span class="p">}</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* no packets made it in, caller will cleanup */</span>
				<span class="k">return</span> <span class="n">HTC_SEND_QUEUE_DROP</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">tx_credit_flow_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_resources</span> <span class="o">=</span>
		    <span class="n">ath6kl_hif_pipe_get_free_queue_number</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span>
							  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">pipeid_ul</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tx_resources</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* transfer packets to tail */</span>
		<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">HTC_SEND_QUEUE_DROP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* increment tx processing count on entry */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_proc_cnt</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_proc_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Another thread or task is draining the TX queues on this</span>
<span class="cm">		 * endpoint that thread will reset the tx processing count</span>
<span class="cm">		 * when the queue is drained.</span>
<span class="cm">		 */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_proc_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HTC_SEND_QUEUE_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/***** beyond this point only 1 thread may enter ******/</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now drain the endpoint TX queue for transmission as long as we have</span>
<span class="cm">	 * enough transmit resources.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">tx_credit_flow_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Credit based mechanism provides flow control</span>
<span class="cm">			 * based on target transmit resource availability,</span>
<span class="cm">			 * we assume that the HIF layer will always have</span>
<span class="cm">			 * bus resources greater than target transmit</span>
<span class="cm">			 * resources.</span>
<span class="cm">			 */</span>
			<span class="n">get_htc_packet_credit_based</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">send_queue</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Get all packets for this endpoint that we can</span>
<span class="cm">			 * for this pass.</span>
<span class="cm">			 */</span>
			<span class="n">get_htc_packet</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">send_queue</span><span class="p">,</span> <span class="n">tx_resources</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Didn&#39;t get packets due to out of resources or TX</span>
<span class="cm">			 * queue was drained.</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

		<span class="cm">/* send what we can */</span>
		<span class="n">htc_issue_packets</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">send_queue</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">tx_credit_flow_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pipeid</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">pipeid_ul</span><span class="p">;</span>
			<span class="n">tx_resources</span> <span class="o">=</span>
			    <span class="n">ath6kl_hif_pipe_get_free_queue_number</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">pipeid</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="cm">/* done with this endpoint, we can clear the count */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_proc_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">HTC_SEND_QUEUE_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* htc control packet manipulation */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_htc_txctrl_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="nf">build_htc_txctrl_packet</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">packet</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_packet</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">HTC_CONTROL_BUFFER_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">packet</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_free_txctrl_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">destroy_htc_txctrl_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="nf">htc_alloc_txctrl_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">build_htc_txctrl_packet</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_txctrl_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">htc_free_txctrl_packet</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MAX_MESSAGE_SIZE 1536</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">htc_setup_target_buffer_assignments</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">credits</span><span class="p">,</span> <span class="n">credit_per_maxmsg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_pipe_txcredit_alloc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hif_usbaudioclass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">credit_per_maxmsg</span> <span class="o">=</span> <span class="n">MAX_MESSAGE_SIZE</span> <span class="o">/</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MAX_MESSAGE_SIZE</span> <span class="o">%</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">)</span>
		<span class="n">credit_per_maxmsg</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* TODO, this should be configured by the caller! */</span>

	<span class="n">credits</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_creds</span><span class="p">;</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">txcredit_alloc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* FIXME: hif_usbaudioclass is always zero */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hif_usbaudioclass</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;%s: For USB Audio Class- Total:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">credits</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Setup VO Service To have Max Credits */</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">WMI_DATA_VO_SVC</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">credits</span> <span class="o">-</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span><span class="o">++</span><span class="p">;</span>

		<span class="n">credits</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">credits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">WMI_CONTROL_SVC</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span> <span class="o">=</span> <span class="n">credit_per_maxmsg</span><span class="p">;</span>
		<span class="n">credits</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">credits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="cm">/* leftovers go to best effort */</span>
		<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">WMI_DATA_BE_SVC</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">credits</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">WMI_DATA_VI_SVC</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span> <span class="o">=</span> <span class="n">credits</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span><span class="o">++</span><span class="p">;</span>

		<span class="n">credits</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">credits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">WMI_DATA_VO_SVC</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span> <span class="o">=</span> <span class="n">credits</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span><span class="o">++</span><span class="p">;</span>

		<span class="n">credits</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">credits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">WMI_CONTROL_SVC</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span> <span class="o">=</span> <span class="n">credit_per_maxmsg</span><span class="p">;</span>
		<span class="n">credits</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">credits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">WMI_DATA_BK_SVC</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span> <span class="o">=</span> <span class="n">credit_per_maxmsg</span><span class="p">;</span>
		<span class="n">credits</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">credits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="cm">/* leftovers go to best effort */</span>
		<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">WMI_DATA_BE_SVC</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">credit_alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">credits</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">txcredit_alloc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">service_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
					   <span class="s">&quot;HTC Service Index : %d TX : 0x%2.2X : alloc:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">i</span><span class="p">,</span>
					   <span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">txcredit_alloc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
					   <span class="n">service_id</span><span class="p">,</span>
					   <span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">txcredit_alloc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
					   <span class="n">credit_alloc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* process credit reports and call distribution function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_process_credit_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">htc_credit_report</span> <span class="o">*</span><span class="n">rpt</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">num_entries</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">from_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">total_credits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="cm">/* lock out TX while we update credits */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">rpt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rpt</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">&gt;=</span> <span class="n">ENDPOINT_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">rpt</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span> <span class="o">+=</span> <span class="n">rpt</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span> <span class="o">&amp;&amp;</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
			<span class="n">htc_try_send</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">total_credits</span> <span class="o">+=</span> <span class="n">rpt</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;Report indicated %d credits to distribute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">total_credits</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* flush endpoint TX queue */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_flush_tx_endpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">send_packet_completion</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * In the adapted HIF layer, struct sk_buff * are passed between HIF and HTC,</span>
<span class="cm"> * since upper layers expects struct htc_packet containers we use the completed</span>
<span class="cm"> * skb and lookup it&#39;s corresponding HTC packet buffer from a lookup list.</span>
<span class="cm"> * This is extra overhead that can be fixed by re-aligning HIF interfaces with</span>
<span class="cm"> * HTC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="nf">htc_lookup_tx_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pkt</span><span class="p">,</span> <span class="o">*</span><span class="n">found_packet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * interate from the front of tx lookup queue</span>
<span class="cm">	 * this lookup should be fast since lower layers completes in-order and</span>
<span class="cm">	 * so the completed packet should be at the head of the list generally</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">tx_lookup_queue</span><span class="p">,</span>
				 <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check for removal */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* found it */</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">found_packet</span> <span class="o">=</span> <span class="n">packet</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">found_packet</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_pipe_tx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="n">htc_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ep_id</span><span class="p">,</span> <span class="o">*</span><span class="n">netdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">netlen</span><span class="p">;</span>

	<span class="n">netdata</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">netlen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">htc_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdata</span><span class="p">;</span>

	<span class="n">ep_id</span> <span class="o">=</span> <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">ep_id</span><span class="p">];</span>

	<span class="n">packet</span> <span class="o">=</span> <span class="n">htc_lookup_tx_packet</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* may have already been flushed and freed */</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;HTC TX lookup failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* will be giving this buffer back to upper layers */</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">send_packet_completion</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">tx_credit_flow_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * note: when using TX credit flow, the re-checking of queues</span>
<span class="cm">		 * happens when credits flow back from the target. in the</span>
<span class="cm">		 * non-TX credit case, we recheck after the packet completes</span>
<span class="cm">		 */</span>
		<span class="n">htc_try_send</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">htc_send_packets_multiple</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pkt_queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pkt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* get first packet to find out which ep the packets will go into */</span>
	<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">&gt;=</span> <span class="n">ENDPOINT_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">];</span>

	<span class="n">htc_try_send</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">pkt_queue</span><span class="p">);</span>

	<span class="cm">/* do completion on any packets that couldn&#39;t get in */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span> <span class="n">pkt_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">do_send_completion</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">pkt_queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* htc pipe rx path */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="nf">alloc_htc_packet_container</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">htc_packet_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">packet</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">htc_packet_pool</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">htc_packet_pool</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="p">)</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">packet</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_htc_packet_container</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">lh</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">htc_packet_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">htc_packet_pool</span> <span class="o">=</span> <span class="n">packet</span><span class="p">;</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">)</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">htc_packet_pool</span><span class="p">;</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">lh</span><span class="p">;</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">htc_packet_pool</span> <span class="o">=</span> <span class="n">packet</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">htc_process_trailer</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">from_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_credit_report</span> <span class="o">*</span><span class="n">report</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_record_hdr</span> <span class="o">*</span><span class="n">record</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">record_buf</span><span class="p">,</span> <span class="o">*</span><span class="n">orig_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orig_len</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">orig_buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">orig_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_record_hdr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* these are byte aligned structs */</span>
		<span class="n">record</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_record_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_record_hdr</span><span class="p">);</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_record_hdr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no room left in buffer for record */</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				   <span class="s">&quot;invalid length: %d (id:%d) buffer has: %d bytes left</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">rec_id</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* start of record follows the header */</span>
		<span class="n">record_buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">rec_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HTC_RECORD_CREDITS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_credit_report</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">report</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_credit_report</span> <span class="o">*</span><span class="p">)</span> <span class="n">record_buf</span><span class="p">;</span>
			<span class="n">htc_process_credit_report</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span>
						  <span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">report</span><span class="p">),</span>
						  <span class="n">from_ep</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				   <span class="s">&quot;unhandled record: id:%d length:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">record</span><span class="o">-&gt;</span><span class="n">rec_id</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* advance buffer past this record for next time around */</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_recv_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">queue_to_indicate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">queue_to_indicate</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* nothing to indicate */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* using legacy EpRecv */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">queue_to_indicate</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">queue_to_indicate</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">recv_packet_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">container</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>

	<span class="cm">/* do completion */</span>
	<span class="n">do_recv_completion</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_pipe_rx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">pipeid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">netdata</span><span class="p">,</span> <span class="o">*</span><span class="n">trailer</span><span class="p">,</span> <span class="n">hdr_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="n">htc_hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">netlen</span><span class="p">,</span> <span class="n">trailerlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">payload_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netdata</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">netlen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">htc_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdata</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">&gt;=</span> <span class="n">ENDPOINT_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;HTC Rx: invalid EndpointID=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">payload_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">get_unaligned</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">payld_len</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netlen</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">payload_len</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;HTC Rx: insufficient length, got:%d expected =%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">netlen</span><span class="p">,</span> <span class="n">payload_len</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get flags to check for trailer */</span>
	<span class="n">hdr_info</span> <span class="o">=</span> <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr_info</span> <span class="o">&amp;</span> <span class="n">HTC_FLG_RX_TRAILER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* extract the trailer length */</span>
		<span class="n">hdr_info</span> <span class="o">=</span> <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdr_info</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_record_hdr</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">hdr_info</span> <span class="o">&gt;</span> <span class="n">payload_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				   <span class="s">&quot;invalid header: payloadlen should be %d, CB[0]: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">payload_len</span><span class="p">,</span> <span class="n">hdr_info</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_skb</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">trailerlen</span> <span class="o">=</span> <span class="n">hdr_info</span><span class="p">;</span>
		<span class="cm">/* process trailer after hdr/apps payload */</span>
		<span class="n">trailer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">htc_hdr</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span> <span class="o">+</span>
			<span class="n">payload_len</span> <span class="o">-</span> <span class="n">hdr_info</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">htc_process_trailer</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">trailer</span><span class="p">,</span> <span class="n">hdr_info</span><span class="p">,</span>
					     <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)</span> <span class="n">payload_len</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">trailerlen</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* zero length packet with trailer, just drop these */</span>
		<span class="k">goto</span> <span class="n">free_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">==</span> <span class="n">ENDPOINT_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* handle HTC control message */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_flags</span> <span class="o">&amp;</span> <span class="n">HTC_OP_STATE_SETUP_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * fatal: target should not send unsolicited</span>
<span class="cm">			 * messageson the endpoint 0</span>
<span class="cm">			 */</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				   <span class="s">&quot;HTC ignores Rx Ctrl after setup complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_skb</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* remove HTC header */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">);</span>

		<span class="n">netdata</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">netlen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

		<span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">ctrl_response_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">ctrl_response_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">netlen</span><span class="p">,</span>
						       <span class="n">HTC_MAX_CTRL_MSG_LEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">ctrl_response_buf</span><span class="p">,</span> <span class="n">netdata</span><span class="p">,</span>
		       <span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">ctrl_response_len</span><span class="p">);</span>

		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: the message based HIF architecture allocates net bufs</span>
<span class="cm">	 * for recv packets since it bridges that HIF to upper layers,</span>
<span class="cm">	 * which expects HTC packets, we form the packets here</span>
<span class="cm">	 */</span>
	<span class="n">packet</span> <span class="o">=</span> <span class="n">alloc_htc_packet_container</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">pkt_cntxt</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* TODO: for backwards compatibility */</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">=</span> <span class="n">netlen</span> <span class="o">-</span> <span class="n">HTC_HDR_LENGTH</span> <span class="o">-</span> <span class="n">trailerlen</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: this is a hack because the driver layer will set the</span>
<span class="cm">	 * actual len of the skb again which will just double the len</span>
<span class="cm">	 */</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">recv_packet_completion</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>

	<span class="cm">/* recover the packet container */</span>
	<span class="n">free_htc_packet_container</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">free_skb:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_flush_rx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">container</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rx_bufq</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rx_bufq</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">;</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;Flushing RX packet:0x%p, length:%d, ep:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">,</span>
			   <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">);</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>

		<span class="cm">/* give the packet back */</span>
		<span class="n">do_recv_completion</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* polling routine to wait for a control packet to be received */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">htc_wait_recv_ctrl_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">HTC_TARGET_RESPONSE_POLL_COUNT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">ctrl_response_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">ctrl_response_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

		<span class="n">count</span><span class="o">--</span><span class="p">;</span>

		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">HTC_TARGET_RESPONSE_POLL_WAIT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;%s: Timeout!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECOMM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_rxctrl_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO, can&#39;t really receive HTC control messages yet.... */</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;%s: invalid call function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* htc pipe initialization */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_endpoint_states</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ENDPOINT_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">len_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">max_txq_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">tx_lookup_queue</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rx_bufq</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">tx_credit_flow_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* FIXME */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* start HTC, this is called after all services are connected */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">htc_config_target_hif_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* htc service functions */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">htc_get_credit_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="n">u16</span> <span class="n">service_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">allocation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">txcredit_alloc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">service_id</span> <span class="o">==</span> <span class="n">service_id</span><span class="p">)</span>
			<span class="n">allocation</span> <span class="o">=</span>
				<span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">txcredit_alloc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">credit_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">allocation</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;HTC Service TX : 0x%2.2X : allocation is zero!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">service_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">allocation</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_pipe_conn_service</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">htc_service_connect_req</span> <span class="o">*</span><span class="n">conn_req</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">htc_service_connect_resp</span> <span class="o">*</span><span class="n">conn_resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_conn_service_resp</span> <span class="o">*</span><span class="n">resp_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_conn_service_msg</span> <span class="o">*</span><span class="n">conn_msg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">assigned_epid</span> <span class="o">=</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">disable_credit_flowctrl</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_msg_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_alloc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="n">HTC_CTRL_RSVD_SVC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* special case for pseudo control service */</span>
		<span class="n">assigned_epid</span> <span class="o">=</span> <span class="n">ENDPOINT_0</span><span class="p">;</span>
		<span class="n">max_msg_size</span> <span class="o">=</span> <span class="n">HTC_MAX_CTRL_MSG_LEN</span><span class="p">;</span>
		<span class="n">tx_alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">tx_alloc</span> <span class="o">=</span> <span class="n">htc_get_credit_alloc</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_alloc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* allocate a packet to send to the target */</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">htc_alloc_txctrl_packet</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_conn_service_msg</span><span class="p">);</span>

		<span class="cm">/* assemble connect service message */</span>
		<span class="n">conn_msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_conn_service_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
								   <span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn_msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">conn_msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_conn_service_msg</span><span class="p">));</span>
		<span class="n">conn_msg</span><span class="o">-&gt;</span><span class="n">msg_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HTC_MSG_CONN_SVC_ID</span><span class="p">);</span>
		<span class="n">conn_msg</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">);</span>
		<span class="n">conn_msg</span><span class="o">-&gt;</span><span class="n">conn_flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">conn_flags</span> <span class="o">&amp;</span>
					<span class="o">~</span><span class="n">HTC_CONN_FLGS_SET_RECV_ALLOC_MASK</span><span class="p">);</span>

		<span class="cm">/* tell target desired recv alloc for this ep */</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">tx_alloc</span> <span class="o">&lt;&lt;</span> <span class="n">HTC_CONN_FLGS_SET_RECV_ALLOC_SHIFT</span><span class="p">;</span>
		<span class="n">conn_msg</span><span class="o">-&gt;</span><span class="n">conn_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">conn_flags</span> <span class="o">&amp;</span>
		    <span class="n">HTC_CONN_FLGS_DISABLE_CRED_FLOW_CTRL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">disable_credit_flowctrl</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">set_htc_pkt_info</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">conn_msg</span><span class="p">,</span>
				 <span class="n">length</span><span class="p">,</span>
				 <span class="n">ENDPOINT_0</span><span class="p">,</span> <span class="n">HTC_SERVICE_TX_PACKET_TAG</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_tx</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>

		<span class="cm">/* we don&#39;t own it anymore */</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>

		<span class="cm">/* wait for response */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">htc_wait_recv_ctrl_message</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>

		<span class="cm">/* we controlled the buffer creation so it has to be</span>
<span class="cm">		 * properly aligned</span>
<span class="cm">		 */</span>
		<span class="n">resp_msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_conn_service_resp</span> <span class="o">*</span><span class="p">)</span>
		    <span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">ctrl_response_buf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">msg_id</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HTC_MSG_CONN_SVC_RESP_ID</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">ctrl_response_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">resp_msg</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* this message is not valid */</span>
			<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span>
			   <span class="s">&quot;%s: service 0x%X conn resp: status: %d ep: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">,</span> <span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
			   <span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">);</span>

		<span class="n">conn_resp</span><span class="o">-&gt;</span><span class="n">resp_code</span> <span class="o">=</span> <span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
		<span class="cm">/* check response status */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">HTC_SERVICE_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				   <span class="s">&quot;Target failed service 0x%X connect request (status:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">,</span> <span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">assigned_epid</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">htc_endpoint_id</span><span class="p">)</span> <span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">;</span>
		<span class="n">max_msg_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">max_msg_sz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* the rest are parameter checks so set the error status */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">assigned_epid</span> <span class="o">&gt;=</span> <span class="n">ENDPOINT_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_msg_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">assigned_epid</span><span class="p">];</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">=</span> <span class="n">assigned_epid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* endpoint already in use! */</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* return assigned endpoint to caller */</span>
	<span class="n">conn_resp</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">assigned_epid</span><span class="p">;</span>
	<span class="n">conn_resp</span><span class="o">-&gt;</span><span class="n">len_max</span> <span class="o">=</span> <span class="n">max_msg_size</span><span class="p">;</span>

	<span class="cm">/* setup the endpoint */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">=</span> <span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">;</span> <span class="cm">/* this marks ep in use */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">max_txq_depth</span> <span class="o">=</span> <span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">max_txq_depth</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">len_max</span> <span class="o">=</span> <span class="n">max_msg_size</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span> <span class="o">=</span> <span class="n">tx_alloc</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_sz</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_per_msg</span> <span class="o">=</span> <span class="n">max_msg_size</span> <span class="o">/</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_msg_size</span> <span class="o">%</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_per_msg</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* copy all the callbacks */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cb</span> <span class="o">=</span> <span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">ep_cb</span><span class="p">;</span>

	<span class="cm">/* initialize tx_drop_packet_threshold */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_drop_packet_threshold</span> <span class="o">=</span> <span class="n">MAX_HI_COOKIE_NUM</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_hif_pipe_map_service</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">pipeid_ul</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">pipeid_dl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;SVC Ready: 0x%4.4X: ULpipe:%d DLpipe:%d id:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">pipeid_ul</span><span class="p">,</span>
		   <span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">pipeid_dl</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable_credit_flowctrl</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">tx_credit_flow_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">tx_credit_flow_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;SVC: 0x%4.4X ep:%d TX flow control off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ep</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">,</span> <span class="n">assigned_epid</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">free_packet:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">htc_free_txctrl_packet</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* htc export functions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ath6kl_htc_pipe_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">target</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;htc create unable to allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_htc_create</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="n">reset_endpoint_states</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HTC_PACKET_CONTAINER_ALLOCATION</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_packet</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">free_htc_packet_container</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unable to allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_htc_create</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ar</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">htc_cnxt</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>

	<span class="cm">/* Get HIF default pipe for HTC message exchange */</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">ENDPOINT_0</span><span class="p">];</span>

	<span class="n">ath6kl_hif_pipe_get_default</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">pipeid_ul</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">pipeid_dl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">target</span><span class="p">;</span>

<span class="nl">fail_htc_create:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">ath6kl_htc_pipe_cleanup</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

		<span class="n">target</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">target</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* cleanup the HTC instance */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_pipe_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">alloc_htc_packet_container</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* kfree our instance */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_pipe_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_setup_comp_ext_msg</span> <span class="o">*</span><span class="n">setup</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

	<span class="n">htc_config_target_hif_pipe</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="cm">/* allocate a buffer to send */</span>
	<span class="n">packet</span> <span class="o">=</span> <span class="n">htc_alloc_txctrl_packet</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* assemble setup complete message */</span>
	<span class="n">setup</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_setup_comp_ext_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
							  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">setup</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_setup_comp_ext_msg</span><span class="p">));</span>
	<span class="n">setup</span><span class="o">-&gt;</span><span class="n">msg_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HTC_MSG_SETUP_COMPLETE_EX_ID</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;HTC using TX credit flow control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">set_htc_pkt_info</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">setup</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_setup_comp_ext_msg</span><span class="p">),</span>
			 <span class="n">ENDPOINT_0</span><span class="p">,</span> <span class="n">HTC_SERVICE_TX_PACKET_TAG</span><span class="p">);</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_flags</span> <span class="o">|=</span> <span class="n">HTC_OP_STATE_SETUP_COMPLETE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ath6kl_htc_pipe_tx</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_pipe_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="cm">/* cleanup endpoints */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">htc_flush_rx_queue</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">htc_flush_tx_endpoint</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">HTC_TX_PACKET_TAG_ALL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">reset_endpoint_states</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HTC_OP_STATE_SETUP_COMPLETE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_pipe_get_rxbuf_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">endpoint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">endpoint</span><span class="p">].</span><span class="n">rx_bufq</span><span class="p">));</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_pipe_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">queue</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;%s: endPointId: %d, buffer: 0x%p, length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
		   <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">htc_send_packets_multiple</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_pipe_wait_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_ready_ext_msg</span> <span class="o">*</span><span class="n">ready_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_service_connect_req</span> <span class="n">connect</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_service_connect_resp</span> <span class="n">resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">htc_wait_recv_ctrl_message</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">ctrl_response_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ready_msg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;invalid htc ready msg len:%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">ctrl_response_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECOMM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ready_msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_ready_ext_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">.</span><span class="n">ctrl_response_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ready_msg</span><span class="o">-&gt;</span><span class="n">ver2_0_info</span><span class="p">.</span><span class="n">msg_id</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HTC_MSG_READY_ID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;invalid htc ready msg : 0x%X !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ready_msg</span><span class="o">-&gt;</span><span class="n">ver2_0_info</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECOMM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;Target Ready! : transmit resources : %d size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ready_msg</span><span class="o">-&gt;</span><span class="n">ver2_0_info</span><span class="p">.</span><span class="n">cred_cnt</span><span class="p">,</span>
		   <span class="n">ready_msg</span><span class="o">-&gt;</span><span class="n">ver2_0_info</span><span class="p">.</span><span class="n">cred_sz</span><span class="p">);</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_creds</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ready_msg</span><span class="o">-&gt;</span><span class="n">ver2_0_info</span><span class="p">.</span><span class="n">cred_cnt</span><span class="p">);</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ready_msg</span><span class="o">-&gt;</span><span class="n">ver2_0_info</span><span class="p">.</span><span class="n">cred_sz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_creds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECOMM</span><span class="p">;</span>

	<span class="n">htc_setup_target_buffer_assignments</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="cm">/* setup our pseudo HTC control endpoint connection */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">connect</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">resp</span><span class="p">));</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">tx_complete</span> <span class="o">=</span> <span class="n">htc_txctrl_complete</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">htc_rxctrl_complete</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">max_txq_depth</span> <span class="o">=</span> <span class="n">NUM_CONTROL_TX_BUFFERS</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">svc_id</span> <span class="o">=</span> <span class="n">HTC_CTRL_RSVD_SVC</span><span class="p">;</span>

	<span class="cm">/* connect fake service */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_conn_service</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connect</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_pipe_flush_txep</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">endpoint</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* not in use.. */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">htc_flush_tx_endpoint</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_pipe_add_rxbuf_multiple</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pkt_queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pkt</span><span class="p">,</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">first</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">&gt;=</span> <span class="n">ENDPOINT_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;%s: epid: %d, cnt:%d, len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">),</span>
		   <span class="n">first</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">);</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">];</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="cm">/* store receive packets */</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rx_bufq</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* walk through queue and mark each one canceled */</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span> <span class="n">pkt_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">do_recv_completion</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">pkt_queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_pipe_activity_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					     <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">ep</span><span class="p">,</span>
					     <span class="n">bool</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_pipe_flush_rx_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_pipe_credit_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ath6kl_htc_credit_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath6kl_htc_ops</span> <span class="n">ath6kl_htc_pipe_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_target</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_wait_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conn_service</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_conn_service</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_txep</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_flush_txep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_rx_buf</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_flush_rx_buf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">activity_changed</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_activity_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rxbuf_num</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_get_rxbuf_num</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_rxbuf_multiple</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_add_rxbuf_multiple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">credit_setup</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_credit_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_complete</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_tx_complete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_complete</span> <span class="o">=</span> <span class="n">ath6kl_htc_pipe_rx_complete</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ath6kl_htc_pipe_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ath6kl_htc_pipe_ops</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
