<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath6kl › usb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>usb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2007-2011 Atheros Communications Inc.</span>
<span class="cm"> * Copyright (c) 2011-2012 Qualcomm Atheros, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>

<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;core.h&quot;</span>

<span class="cm">/* constants */</span>
<span class="cp">#define TX_URB_COUNT            32</span>
<span class="cp">#define RX_URB_COUNT            32</span>
<span class="cp">#define ATH6KL_USB_RX_BUFFER_SIZE  1700</span>

<span class="cm">/* tx/rx pipes for usb */</span>
<span class="k">enum</span> <span class="n">ATH6KL_USB_PIPE_ID</span> <span class="p">{</span>
	<span class="n">ATH6KL_USB_PIPE_TX_CTRL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ATH6KL_USB_PIPE_TX_DATA_LP</span><span class="p">,</span>
	<span class="n">ATH6KL_USB_PIPE_TX_DATA_MP</span><span class="p">,</span>
	<span class="n">ATH6KL_USB_PIPE_TX_DATA_HP</span><span class="p">,</span>
	<span class="n">ATH6KL_USB_PIPE_RX_CTRL</span><span class="p">,</span>
	<span class="n">ATH6KL_USB_PIPE_RX_DATA</span><span class="p">,</span>
	<span class="n">ATH6KL_USB_PIPE_RX_DATA2</span><span class="p">,</span>
	<span class="n">ATH6KL_USB_PIPE_RX_INT</span><span class="p">,</span>
	<span class="n">ATH6KL_USB_PIPE_MAX</span>
<span class="p">};</span>

<span class="cp">#define ATH6KL_USB_PIPE_INVALID ATH6KL_USB_PIPE_MAX</span>

<span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">urb_list_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_anchor</span> <span class="n">urb_submitted</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">urb_alloc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">urb_cnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">urb_cnt_thresh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">usb_pipe_handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ep_address</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">logical_pipe_num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_packet_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">io_complete_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">io_comp_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep_desc</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define ATH6KL_USB_PIPE_FLAG_TX    (1 &lt;&lt; 0)</span>

<span class="cm">/* usb device object */</span>
<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="p">{</span>
	<span class="cm">/* protects pipe-&gt;urb_list_head and  pipe-&gt;urb_cnt */</span>
	<span class="n">spinlock_t</span> <span class="n">cs_lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="n">pipes</span><span class="p">[</span><span class="n">ATH6KL_USB_PIPE_MAX</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">diag_cmd_buffer</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">diag_resp_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* usb urb object */</span>
<span class="k">struct</span> <span class="n">ath6kl_urb_context</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* USB endpoint definitions */</span>
<span class="cp">#define ATH6KL_USB_EP_ADDR_APP_CTRL_IN          0x81</span>
<span class="cp">#define ATH6KL_USB_EP_ADDR_APP_DATA_IN          0x82</span>
<span class="cp">#define ATH6KL_USB_EP_ADDR_APP_DATA2_IN         0x83</span>
<span class="cp">#define ATH6KL_USB_EP_ADDR_APP_INT_IN           0x84</span>

<span class="cp">#define ATH6KL_USB_EP_ADDR_APP_CTRL_OUT         0x01</span>
<span class="cp">#define ATH6KL_USB_EP_ADDR_APP_DATA_LP_OUT      0x02</span>
<span class="cp">#define ATH6KL_USB_EP_ADDR_APP_DATA_MP_OUT      0x03</span>
<span class="cp">#define ATH6KL_USB_EP_ADDR_APP_DATA_HP_OUT      0x04</span>

<span class="cm">/* diagnostic command defnitions */</span>
<span class="cp">#define ATH6KL_USB_CONTROL_REQ_SEND_BMI_CMD        1</span>
<span class="cp">#define ATH6KL_USB_CONTROL_REQ_RECV_BMI_RESP       2</span>
<span class="cp">#define ATH6KL_USB_CONTROL_REQ_DIAG_CMD            3</span>
<span class="cp">#define ATH6KL_USB_CONTROL_REQ_DIAG_RESP           4</span>

<span class="cp">#define ATH6KL_USB_CTRL_DIAG_CC_READ               0</span>
<span class="cp">#define ATH6KL_USB_CTRL_DIAG_CC_WRITE              1</span>

<span class="k">struct</span> <span class="n">ath6kl_usb_ctrl_diag_cmd_write</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">_pad</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ath6kl_usb_ctrl_diag_cmd_read</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">address</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ath6kl_usb_ctrl_diag_resp_read</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* function declarations */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ath6kl_usb_recv_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>

<span class="cp">#define ATH6KL_USB_IS_BULK_EP(attr) (((attr) &amp; 3) == 0x02)</span>
<span class="cp">#define ATH6KL_USB_IS_INT_EP(attr)  (((attr) &amp; 3) == 0x03)</span>
<span class="cp">#define ATH6KL_USB_IS_ISOC_EP(attr)  (((attr) &amp; 3) == 0x01)</span>
<span class="cp">#define ATH6KL_USB_IS_DIR_IN(addr)  ((addr) &amp; 0x80)</span>

<span class="cm">/* pipe/urb operations */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ath6kl_urb_context</span> <span class="o">*</span>
<span class="nf">ath6kl_usb_alloc_urb_from_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_urb_context</span> <span class="o">*</span><span class="n">urb_context</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">cs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_list_head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">urb_context</span> <span class="o">=</span>
		    <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_list_head</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ath6kl_urb_context</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">cs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">urb_context</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_free_urb_to_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ath6kl_urb_context</span> <span class="o">*</span><span class="n">urb_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">cs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_cnt</span><span class="o">++</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_list_head</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">cs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_cleanup_recv_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_urb_context</span> <span class="o">*</span><span class="n">urb_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_usb_free_urb_to_pipe</span><span class="p">(</span><span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">urb_context</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="nf">ath6kl_usb_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hif_priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* pipe resource allocation/cleanup */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_alloc_pipe_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">urb_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_urb_context</span> <span class="o">*</span><span class="n">urb_context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_list_head</span><span class="p">);</span>
	<span class="n">init_usb_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_submitted</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">urb_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb_context</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_urb_context</span><span class="p">),</span>
				      <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb_context</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="cm">/* FIXME: set status to -ENOMEM */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * we are only allocate the urb contexts here, the actual URB</span>
<span class="cm">		 * is allocated from the kernel as needed to do a transaction</span>
<span class="cm">		 */</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_alloc</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ath6kl_usb_free_urb_to_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">urb_context</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span>
		   <span class="s">&quot;ath6kl usb: alloc resources lpipe:%d hpipe:0x%X urbs:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">logical_pipe_num</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">usb_pipe_handle</span><span class="p">,</span>
		   <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_alloc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_free_pipe_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_urb_context</span> <span class="o">*</span><span class="n">urb_context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ar_usb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* nothing allocated for this pipe */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span>
		   <span class="s">&quot;ath6kl usb: free resources lpipe:%d&quot;</span>
		   <span class="s">&quot;hpipe:0x%X urbs:%d avail:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">logical_pipe_num</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">usb_pipe_handle</span><span class="p">,</span>
		   <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_alloc</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_cnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_alloc</span> <span class="o">!=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span>
			   <span class="s">&quot;ath6kl usb: urb leak! lpipe:%d&quot;</span>
			   <span class="s">&quot;hpipe:0x%X urbs:%d avail:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">logical_pipe_num</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">usb_pipe_handle</span><span class="p">,</span>
			   <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_alloc</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb_context</span> <span class="o">=</span> <span class="n">ath6kl_usb_alloc_urb_from_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb_context</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">urb_context</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_cleanup_pipe_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH6KL_USB_PIPE_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ath6kl_usb_free_pipe_resources</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ath6kl_usb_get_logical_pipe_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="n">ep_address</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">urb_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pipe_num</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_INVALID</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ep_address</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATH6KL_USB_EP_ADDR_APP_CTRL_IN</span>:
		<span class="n">pipe_num</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_RX_CTRL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">urb_count</span> <span class="o">=</span> <span class="n">RX_URB_COUNT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATH6KL_USB_EP_ADDR_APP_DATA_IN</span>:
		<span class="n">pipe_num</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_RX_DATA</span><span class="p">;</span>
		<span class="o">*</span><span class="n">urb_count</span> <span class="o">=</span> <span class="n">RX_URB_COUNT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATH6KL_USB_EP_ADDR_APP_INT_IN</span>:
		<span class="n">pipe_num</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_RX_INT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">urb_count</span> <span class="o">=</span> <span class="n">RX_URB_COUNT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATH6KL_USB_EP_ADDR_APP_DATA2_IN</span>:
		<span class="n">pipe_num</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_RX_DATA2</span><span class="p">;</span>
		<span class="o">*</span><span class="n">urb_count</span> <span class="o">=</span> <span class="n">RX_URB_COUNT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATH6KL_USB_EP_ADDR_APP_CTRL_OUT</span>:
		<span class="n">pipe_num</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_TX_CTRL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">urb_count</span> <span class="o">=</span> <span class="n">TX_URB_COUNT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATH6KL_USB_EP_ADDR_APP_DATA_LP_OUT</span>:
		<span class="n">pipe_num</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_TX_DATA_LP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">urb_count</span> <span class="o">=</span> <span class="n">TX_URB_COUNT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATH6KL_USB_EP_ADDR_APP_DATA_MP_OUT</span>:
		<span class="n">pipe_num</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_TX_DATA_MP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">urb_count</span> <span class="o">=</span> <span class="n">TX_URB_COUNT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATH6KL_USB_EP_ADDR_APP_DATA_HP_OUT</span>:
		<span class="n">pipe_num</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_TX_DATA_HP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">urb_count</span> <span class="o">=</span> <span class="n">TX_URB_COUNT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* note: there may be endpoints not currently used */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pipe_num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_setup_pipe_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">iface_desc</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">urbcount</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pipe_num</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span> <span class="s">&quot;setting up USB Pipes using interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* walk decriptors and setup pipes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iface_desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iface_desc</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ATH6KL_USB_IS_BULK_EP</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span>
				   <span class="s">&quot;%s Bulk Ep:0x%2.2X maxpktsz:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ATH6KL_USB_IS_DIR_IN</span>
				   <span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">)</span> <span class="o">?</span>
				   <span class="s">&quot;RX&quot;</span> <span class="o">:</span> <span class="s">&quot;TX&quot;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">,</span>
				   <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ATH6KL_USB_IS_INT_EP</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span>
				   <span class="s">&quot;%s Int Ep:0x%2.2X maxpktsz:%d interval:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ATH6KL_USB_IS_DIR_IN</span>
				   <span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">)</span> <span class="o">?</span>
				   <span class="s">&quot;RX&quot;</span> <span class="o">:</span> <span class="s">&quot;TX&quot;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">,</span>
				   <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">),</span>
				   <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ATH6KL_USB_IS_ISOC_EP</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* TODO for ISO */</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span>
				   <span class="s">&quot;%s ISOC Ep:0x%2.2X maxpktsz:%d interval:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ATH6KL_USB_IS_DIR_IN</span>
				   <span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">)</span> <span class="o">?</span>
				   <span class="s">&quot;RX&quot;</span> <span class="o">:</span> <span class="s">&quot;TX&quot;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">,</span>
				   <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">),</span>
				   <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">urbcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pipe_num</span> <span class="o">=</span>
		    <span class="n">ath6kl_usb_get_logical_pipe_num</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">,</span>
						    <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">urbcount</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe_num</span> <span class="o">==</span> <span class="n">ATH6KL_USB_PIPE_INVALID</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pipe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ar_usb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* hmmm..pipe was already setup */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ar_usb</span> <span class="o">=</span> <span class="n">ar_usb</span><span class="p">;</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">logical_pipe_num</span> <span class="o">=</span> <span class="n">pipe_num</span><span class="p">;</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">max_packet_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ATH6KL_USB_IS_BULK_EP</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ATH6KL_USB_IS_DIR_IN</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">usb_pipe_handle</span> <span class="o">=</span>
				    <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
						    <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">usb_pipe_handle</span> <span class="o">=</span>
				    <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
						    <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ATH6KL_USB_IS_INT_EP</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ATH6KL_USB_IS_DIR_IN</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">usb_pipe_handle</span> <span class="o">=</span>
				    <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
						   <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">usb_pipe_handle</span> <span class="o">=</span>
				    <span class="n">usb_sndintpipe</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
						   <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ATH6KL_USB_IS_ISOC_EP</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* TODO for ISO */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ATH6KL_USB_IS_DIR_IN</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">usb_pipe_handle</span> <span class="o">=</span>
				    <span class="n">usb_rcvisocpipe</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
						    <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">usb_pipe_handle</span> <span class="o">=</span>
				    <span class="n">usb_sndisocpipe</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
						    <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_desc</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ATH6KL_USB_IS_DIR_IN</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span><span class="p">))</span>
			<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH6KL_USB_PIPE_FLAG_TX</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_usb_alloc_pipe_resources</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">urbcount</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* pipe operations */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_post_recv_transfers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="o">*</span><span class="n">recv_pipe</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">buffer_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_urb_context</span> <span class="o">*</span><span class="n">urb_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usb_status</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb_context</span> <span class="o">=</span> <span class="n">ath6kl_usb_alloc_urb_from_pipe</span><span class="p">(</span><span class="n">recv_pipe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb_context</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">buffer_length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_cleanup_urb</span><span class="p">;</span>

		<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_cleanup_urb</span><span class="p">;</span>

		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span>
				  <span class="n">recv_pipe</span><span class="o">-&gt;</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
				  <span class="n">recv_pipe</span><span class="o">-&gt;</span><span class="n">usb_pipe_handle</span><span class="p">,</span>
				  <span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				  <span class="n">buffer_length</span><span class="p">,</span>
				  <span class="n">ath6kl_usb_recv_complete</span><span class="p">,</span> <span class="n">urb_context</span><span class="p">);</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB_BULK</span><span class="p">,</span>
			   <span class="s">&quot;ath6kl usb: bulk recv submit:%d, 0x%X (ep:0x%2.2X), %d bytes buf:0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">recv_pipe</span><span class="o">-&gt;</span><span class="n">logical_pipe_num</span><span class="p">,</span>
			   <span class="n">recv_pipe</span><span class="o">-&gt;</span><span class="n">usb_pipe_handle</span><span class="p">,</span> <span class="n">recv_pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span><span class="p">,</span>
			   <span class="n">buffer_length</span><span class="p">,</span> <span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recv_pipe</span><span class="o">-&gt;</span><span class="n">urb_submitted</span><span class="p">);</span>
		<span class="n">usb_status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usb_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB_BULK</span><span class="p">,</span>
				   <span class="s">&quot;ath6kl usb : usb bulk recv failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">usb_status</span><span class="p">);</span>
			<span class="n">usb_unanchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_cleanup_urb</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_cleanup_urb:</span>
	<span class="n">ath6kl_usb_cleanup_recv_urb</span><span class="p">(</span><span class="n">urb_context</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_flush_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH6KL_USB_PIPE_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ar_usb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">usb_kill_anchored_urbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb_submitted</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Flushing any pending I/O may schedule work this call will block</span>
<span class="cm">	 * until all scheduled work runs to completion.</span>
<span class="cm">	 */</span>
	<span class="n">flush_scheduled_work</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_start_recv_pipes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * note: control pipe is no longer used</span>
<span class="cm">	 * ar_usb-&gt;pipes[ATH6KL_USB_PIPE_RX_CTRL].urb_cnt_thresh =</span>
<span class="cm">	 *      ar_usb-&gt;pipes[ATH6KL_USB_PIPE_RX_CTRL].urb_alloc/2;</span>
<span class="cm">	 * ath6kl_usb_post_recv_transfers(&amp;ar_usb-&gt;</span>
<span class="cm">	 *		pipes[ATH6KL_USB_PIPE_RX_CTRL],</span>
<span class="cm">	 *		ATH6KL_USB_RX_BUFFER_SIZE);</span>
<span class="cm">	 */</span>

	<span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">ATH6KL_USB_PIPE_RX_DATA</span><span class="p">].</span><span class="n">urb_cnt_thresh</span> <span class="o">=</span>
	    <span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">ATH6KL_USB_PIPE_RX_DATA</span><span class="p">].</span><span class="n">urb_alloc</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ath6kl_usb_post_recv_transfers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">ATH6KL_USB_PIPE_RX_DATA</span><span class="p">],</span>
				       <span class="n">ATH6KL_USB_RX_BUFFER_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* hif usb rx/tx completion functions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_recv_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_urb_context</span> <span class="o">*</span><span class="n">urb_context</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB_BULK</span><span class="p">,</span>
		   <span class="s">&quot;%s: recv pipe: %d, stat:%d, len:%d urb:0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">logical_pipe_num</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span>
		   <span class="n">urb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
			<span class="cm">/*</span>
<span class="cm">			 * no need to spew these errors when device</span>
<span class="cm">			 * removed or urb killed due to driver shutdown</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB_BULK</span><span class="p">,</span>
				   <span class="s">&quot;%s recv pipe: %d (ep:0x%2.2X), failed:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">logical_pipe_num</span><span class="p">,</span>
				   <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">cleanup_recv_urb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup_recv_urb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* we are going to pass it up */</span>
	<span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>

	<span class="cm">/* note: queue implements a lock */</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">io_comp_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">io_complete_work</span><span class="p">);</span>

<span class="nl">cleanup_recv_urb:</span>
	<span class="n">ath6kl_usb_cleanup_recv_urb</span><span class="p">(</span><span class="n">urb_context</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_cnt</span> <span class="o">&gt;=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_cnt_thresh</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* our free urbs are piling up, post more transfers */</span>
		<span class="n">ath6kl_usb_post_recv_transfers</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">ATH6KL_USB_RX_BUFFER_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_usb_transmit_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_urb_context</span> <span class="o">*</span><span class="n">urb_context</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB_BULK</span><span class="p">,</span>
		   <span class="s">&quot;%s: pipe: %d, stat:%d, len:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">logical_pipe_num</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
		   <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB_BULK</span><span class="p">,</span>
			   <span class="s">&quot;%s:  pipe: %d, failed:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">logical_pipe_num</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ath6kl_usb_free_urb_to_pipe</span><span class="p">(</span><span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">urb_context</span><span class="p">);</span>

	<span class="cm">/* note: queue implements a lock */</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">io_comp_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">io_complete_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_io_comp_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span><span class="p">,</span>
						    <span class="n">io_complete_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ar_usb</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ar_usb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">io_comp_queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATH6KL_USB_PIPE_FLAG_TX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB_BULK</span><span class="p">,</span>
				   <span class="s">&quot;ath6kl usb xmit callback buf:0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">ath6kl_core_tx_complete</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB_BULK</span><span class="p">,</span>
				   <span class="s">&quot;ath6kl usb recv callback buf:0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">ath6kl_core_rx_complete</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
						<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">logical_pipe_num</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define ATH6KL_USB_MAX_DIAG_CMD (sizeof(struct ath6kl_usb_ctrl_diag_cmd_write))</span>
<span class="cp">#define ATH6KL_USB_MAX_DIAG_RESP (sizeof(struct ath6kl_usb_ctrl_diag_resp_read))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath6kl_usb_flush_all</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">);</span>

	<span class="n">ath6kl_usb_cleanup_pipe_resources</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">diag_cmd_buffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">diag_resp_buffer</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="nf">ath6kl_usb_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ar_usb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar_usb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_ath6kl_usb_create</span><span class="p">;</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">ar_usb</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">cs_lock</span><span class="p">));</span>
	<span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="n">interface</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH6KL_USB_PIPE_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">io_complete_work</span><span class="p">,</span>
			  <span class="n">ath6kl_usb_io_comp_work</span><span class="p">);</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">io_comp_queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">diag_cmd_buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ATH6KL_USB_MAX_DIAG_CMD</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">diag_cmd_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_ath6kl_usb_create</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">diag_resp_buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ATH6KL_USB_MAX_DIAG_RESP</span><span class="p">,</span>
					   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">diag_resp_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_ath6kl_usb_create</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_usb_setup_pipe_resources</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">);</span>

<span class="nl">fail_ath6kl_usb_create:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_usb_destroy</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">);</span>
		<span class="n">ar_usb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ar_usb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_device_detached</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span><span class="p">;</span>

	<span class="n">ar_usb</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar_usb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ath6kl_stop_txrx</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">);</span>

	<span class="cm">/* Delay to wait for the target to reboot */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">ath6kl_core_cleanup</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">);</span>
	<span class="n">ath6kl_usb_destroy</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* exported hif usb APIs for htc pipe */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hif_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">ath6kl_usb_priv</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ath6kl_usb_start_recv_pipes</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="cm">/* set the TX resource avail threshold for each TX pipe */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_TX_CTRL</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">ATH6KL_USB_PIPE_TX_DATA_HP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb_cnt_thresh</span> <span class="o">=</span>
		    <span class="n">device</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb_alloc</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="n">PipeID</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">hdr_skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">ath6kl_usb_priv</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">PipeID</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ath6kl_urb_context</span> <span class="o">*</span><span class="n">urb_context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usb_status</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB_BULK</span><span class="p">,</span> <span class="s">&quot;+%s pipe : %d, buf:0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">PipeID</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">urb_context</span> <span class="o">=</span> <span class="n">ath6kl_usb_alloc_urb_from_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb_context</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TODO: it is possible to run out of urbs if</span>
<span class="cm">		 * 2 endpoints map to the same pipe ID</span>
<span class="cm">		 */</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB_BULK</span><span class="p">,</span>
			   <span class="s">&quot;%s pipe:%d no urbs left. URB Cnt : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">PipeID</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_cnt</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_hif_send</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">ath6kl_usb_free_urb_to_pipe</span><span class="p">(</span><span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span>
					    <span class="n">urb_context</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_hif_send</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			  <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">usb_pipe_handle</span><span class="p">,</span>
			  <span class="n">data</span><span class="p">,</span>
			  <span class="n">len</span><span class="p">,</span>
			  <span class="n">ath6kl_usb_usb_transmit_complete</span><span class="p">,</span> <span class="n">urb_context</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">%</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">max_packet_size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* hit a max packet boundary on this pipe */</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_ZERO_PACKET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB_BULK</span><span class="p">,</span>
		   <span class="s">&quot;athusb bulk send submit:%d, 0x%X (ep:0x%2.2X), %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">logical_pipe_num</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">usb_pipe_handle</span><span class="p">,</span>
		   <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ep_address</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">urb_submitted</span><span class="p">);</span>
	<span class="n">usb_status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB_BULK</span><span class="p">,</span>
			   <span class="s">&quot;ath6kl usb : usb bulk transmit failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">usb_status</span><span class="p">);</span>
		<span class="n">usb_unanchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">ath6kl_usb_free_urb_to_pipe</span><span class="p">(</span><span class="n">urb_context</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span>
					    <span class="n">urb_context</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>

<span class="nl">fail_hif_send:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hif_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">ath6kl_usb_priv</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">ath6kl_usb_flush_all</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_get_default_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
					<span class="n">u8</span> <span class="o">*</span><span class="n">ul_pipe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dl_pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ul_pipe</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_TX_CTRL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">dl_pipe</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_RX_CTRL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_map_service_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u16</span> <span class="n">svc_id</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="o">*</span><span class="n">ul_pipe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dl_pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">svc_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HTC_CTRL_RSVD_SVC</span>:
	<span class="k">case</span> <span class="n">WMI_CONTROL_SVC</span>:
		<span class="o">*</span><span class="n">ul_pipe</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_TX_CTRL</span><span class="p">;</span>
		<span class="cm">/* due to large control packets, shift to data pipe */</span>
		<span class="o">*</span><span class="n">dl_pipe</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_RX_DATA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_DATA_BE_SVC</span>:
	<span class="k">case</span> <span class="n">WMI_DATA_BK_SVC</span>:
		<span class="o">*</span><span class="n">ul_pipe</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_TX_DATA_LP</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		* Disable rxdata2 directly, it will be enabled</span>
<span class="cm">		* if FW enable rxdata2</span>
<span class="cm">		*/</span>
		<span class="o">*</span><span class="n">dl_pipe</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_RX_DATA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_DATA_VI_SVC</span>:
		<span class="o">*</span><span class="n">ul_pipe</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_TX_DATA_MP</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		* Disable rxdata2 directly, it will be enabled</span>
<span class="cm">		* if FW enable rxdata2</span>
<span class="cm">		*/</span>
		<span class="o">*</span><span class="n">dl_pipe</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_RX_DATA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_DATA_VO_SVC</span>:
		<span class="o">*</span><span class="n">ul_pipe</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_TX_DATA_HP</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		* Disable rxdata2 directly, it will be enabled</span>
<span class="cm">		* if FW enable rxdata2</span>
<span class="cm">		*/</span>
		<span class="o">*</span><span class="n">dl_pipe</span> <span class="o">=</span> <span class="n">ATH6KL_USB_PIPE_RX_DATA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">ath6kl_usb_get_free_queue_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pipe_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">ath6kl_usb_priv</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe_id</span><span class="p">].</span><span class="n">urb_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hif_detach_htc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">ath6kl_usb_priv</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">ath6kl_usb_flush_all</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_submit_ctrl_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* note: if successful returns number of bytes transfered */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			      <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">req</span><span class="p">,</span>
			      <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span>
			      <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
			      <span class="n">size</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span> <span class="s">&quot;%s failed,result = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_submit_ctrl_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* note: if successful returns number of bytes transfered */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
				 <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				 <span class="n">req</span><span class="p">,</span>
				 <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span>
				 <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				 <span class="n">size</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span> <span class="s">&quot;%s failed,result = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_ctrl_msg_exchange</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">req_val</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">req_buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">req_len</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">resp_val</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">resp_buf</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">resp_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* send command */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_usb_submit_ctrl_out</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">,</span> <span class="n">req_val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="n">req_buf</span><span class="p">,</span> <span class="n">req_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no expected response */</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get response */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_usb_submit_ctrl_in</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">,</span> <span class="n">resp_val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">resp_buf</span><span class="p">,</span> <span class="o">*</span><span class="n">resp_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_diag_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hif_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb_ctrl_diag_resp_read</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb_ctrl_diag_cmd_read</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">resp_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb_ctrl_diag_cmd_read</span> <span class="o">*</span><span class="p">)</span> <span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">diag_cmd_buffer</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ATH6KL_USB_CTRL_DIAG_CC_READ</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
	<span class="n">resp_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">resp</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_usb_ctrl_msg_exchange</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">,</span>
				<span class="n">ATH6KL_USB_CONTROL_REQ_DIAG_CMD</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb_ctrl_diag_cmd_write</span><span class="p">),</span>
				<span class="n">ATH6KL_USB_CONTROL_REQ_DIAG_RESP</span><span class="p">,</span>
				<span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">diag_resp_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb_ctrl_diag_resp_read</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">diag_resp_buffer</span><span class="p">;</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_diag_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hif_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb_ctrl_diag_cmd_write</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb_ctrl_diag_cmd_write</span> <span class="o">*</span><span class="p">)</span> <span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">diag_cmd_buffer</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_usb_ctrl_diag_cmd_write</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ATH6KL_USB_CTRL_DIAG_CC_WRITE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ath6kl_usb_ctrl_msg_exchange</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">,</span>
					    <span class="n">ATH6KL_USB_CONTROL_REQ_DIAG_CMD</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span>
					    <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_bmi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hif_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* get response */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_usb_submit_ctrl_in</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">,</span>
					<span class="n">ATH6KL_USB_CONTROL_REQ_RECV_BMI_RESP</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Unable to read the bmi data from the device: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_bmi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hif_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* send command */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_usb_submit_ctrl_out</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">,</span>
					 <span class="n">ATH6KL_USB_CONTROL_REQ_SEND_BMI_CMD</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unable to send the bmi data to the device: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hif_start</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hif_detach_htc</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hif_stop</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_cleanup_scatter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * USB doesn&#39;t support it. Just return.</span>
<span class="cm">	 */</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath6kl_hif_ops</span> <span class="n">ath6kl_usb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">diag_read32</span> <span class="o">=</span> <span class="n">ath6kl_usb_diag_read32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">diag_write32</span> <span class="o">=</span> <span class="n">ath6kl_usb_diag_write32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmi_read</span> <span class="o">=</span> <span class="n">ath6kl_usb_bmi_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmi_write</span> <span class="o">=</span> <span class="n">ath6kl_usb_bmi_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">power_on</span> <span class="o">=</span> <span class="n">ath6kl_usb_power_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">power_off</span> <span class="o">=</span> <span class="n">ath6kl_usb_power_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">ath6kl_usb_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pipe_send</span> <span class="o">=</span> <span class="n">ath6kl_usb_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pipe_get_default</span> <span class="o">=</span> <span class="n">ath6kl_usb_get_default_pipe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pipe_map_service</span> <span class="o">=</span> <span class="n">ath6kl_usb_map_service_pipe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pipe_get_free_queue_number</span> <span class="o">=</span> <span class="n">ath6kl_usb_get_free_queue_number</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup_scatter</span> <span class="o">=</span> <span class="n">ath6kl_usb_cleanup_scatter</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ath6kl usb driver registered functions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">ar_usb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vendor_id</span><span class="p">,</span> <span class="n">product_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">usb_get_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">vendor_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">);</span>
	<span class="n">product_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span> <span class="s">&quot;vendor_id = %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vendor_id</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span> <span class="s">&quot;product_id = %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">product_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">)</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span> <span class="s">&quot;USB Interface %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span> <span class="s">&quot;USB 2.0 Host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_USB</span><span class="p">,</span> <span class="s">&quot;USB 1.1 Host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ar_usb</span> <span class="o">=</span> <span class="n">ath6kl_usb_create</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar_usb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_usb_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_core_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to alloc ath6kl core</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_usb_destroy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">hif_priv</span> <span class="o">=</span> <span class="n">ar_usb</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">hif_type</span> <span class="o">=</span> <span class="n">ATH6KL_HIF_TYPE_USB</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">hif_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ath6kl_usb_ops</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">mbox_info</span><span class="p">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">bmi</span><span class="p">.</span><span class="n">max_data_size</span> <span class="o">=</span> <span class="mi">252</span><span class="p">;</span>

	<span class="n">ar_usb</span><span class="o">-&gt;</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ar</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_core_init</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">ATH6KL_HTC_TYPE_PIPE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to init ath6kl core: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_core_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err_core_free:</span>
	<span class="n">ath6kl_core_destroy</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
<span class="nl">err_usb_destroy:</span>
	<span class="n">ath6kl_usb_destroy</span><span class="p">(</span><span class="n">ar_usb</span><span class="p">);</span>
<span class="nl">err_usb_put:</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">interface</span><span class="p">));</span>
	<span class="n">ath6kl_usb_device_detached</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
			      <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="n">device</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>

	<span class="n">ath6kl_usb_flush_all</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_usb</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="n">device</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>

	<span class="n">ath6kl_usb_post_recv_transfers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">ATH6KL_USB_PIPE_RX_DATA</span><span class="p">],</span>
				       <span class="n">ATH6KL_USB_RX_BUFFER_SIZE</span><span class="p">);</span>
	<span class="n">ath6kl_usb_post_recv_transfers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">ATH6KL_USB_PIPE_RX_DATA2</span><span class="p">],</span>
				       <span class="n">ATH6KL_USB_RX_BUFFER_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_reset_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">))</span>
		<span class="n">ath6kl_usb_remove</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define ath6kl_usb_suspend NULL</span>
<span class="cp">#define ath6kl_usb_resume NULL</span>
<span class="cp">#define ath6kl_usb_reset_resume NULL</span>

<span class="cp">#endif</span>

<span class="cm">/* table of devices that work with this driver */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">ath6kl_usb_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0cf3</span><span class="p">,</span> <span class="mh">0x9374</span><span class="p">)},</span>
	<span class="p">{</span> <span class="cm">/* Terminating entry */</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">ath6kl_usb_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">ath6kl_usb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ath6kl_usb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ath6kl_usb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ath6kl_usb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ath6kl_usb_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span> <span class="n">ath6kl_usb_reset_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">ath6kl_usb_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ath6kl_usb_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supports_autosuspend</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_hub_initiated_lpm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_usb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ath6kl_usb_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_usb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ath6kl_usb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ath6kl_usb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ath6kl_usb_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Atheros Communications, Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver support for Atheros AR600x USB devices&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">AR6004_HW_1_0_FIRMWARE_FILE</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">AR6004_HW_1_0_BOARD_DATA_FILE</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">AR6004_HW_1_0_DEFAULT_BOARD_DATA_FILE</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">AR6004_HW_1_1_FIRMWARE_FILE</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">AR6004_HW_1_1_BOARD_DATA_FILE</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">AR6004_HW_1_1_DEFAULT_BOARD_DATA_FILE</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">AR6004_HW_1_2_FIRMWARE_FILE</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">AR6004_HW_1_2_BOARD_DATA_FILE</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">AR6004_HW_1_2_DEFAULT_BOARD_DATA_FILE</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
