<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath6kl › txrx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>txrx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004-2011 Atheros Communications Inc.</span>
<span class="cm"> * Copyright (c) 2011-2012 Qualcomm Atheros, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;htc-ops.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * tid - tid_mux0..tid_mux3</span>
<span class="cm"> * aid - tid_mux4..tid_mux7</span>
<span class="cm"> */</span>
<span class="cp">#define ATH6KL_TID_MASK 0xf</span>
<span class="cp">#define ATH6KL_AID_SHIFT 4</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">ath6kl_get_tid</span><span class="p">(</span><span class="n">u8</span> <span class="n">tid_mux</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tid_mux</span> <span class="o">&amp;</span> <span class="n">ATH6KL_TID_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">ath6kl_get_aid</span><span class="p">(</span><span class="n">u8</span> <span class="n">tid_mux</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tid_mux</span> <span class="o">&gt;&gt;</span> <span class="n">ATH6KL_AID_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ath6kl_ibss_map_epid</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="o">*</span><span class="n">map_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eth_hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">ep_map</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">;</span>

	<span class="o">*</span><span class="n">map_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">datap</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">eth_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">datap</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ENDPOINT_2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">,</span>
			   <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">map_no</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_pend</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ep_id</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ep_map</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_pend</span><span class="p">)</span>
			<span class="n">ep_map</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep_map</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep_map</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_num</span><span class="p">;</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_num</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_num</span> <span class="o">&gt;</span> <span class="n">MAX_NODE_NUM</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ENDPOINT_UNUSED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">[</span><span class="n">ep_map</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ENDPOINT_2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">ENDPOINT_5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">[</span><span class="n">ep_map</span><span class="p">].</span><span class="n">ep_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * No free endpoint is available, start redistribution on</span>
<span class="cm">		 * the inuse endpoints.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ENDPOINT_5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">[</span><span class="n">ep_map</span><span class="p">].</span><span class="n">ep_id</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">next_ep_id</span><span class="p">;</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">next_ep_id</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">next_ep_id</span> <span class="o">&gt;</span> <span class="n">ENDPOINT_5</span><span class="p">)</span>
				<span class="n">ar</span><span class="o">-&gt;</span><span class="n">next_ep_id</span> <span class="o">=</span> <span class="n">ENDPOINT_2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">map_no</span> <span class="o">=</span> <span class="n">ep_map</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">[</span><span class="n">ep_map</span><span class="p">].</span><span class="n">tx_pend</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">[</span><span class="n">ep_map</span><span class="p">].</span><span class="n">ep_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_process_uapsdq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_apsdq_empty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">datap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">traffic_class</span><span class="p">,</span> <span class="o">*</span><span class="n">ip_hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ether_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span> <span class="o">*</span><span class="n">llc_hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;</span> <span class="n">STA_PS_APSD_TRIGGER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This tx is because of a uAPSD trigger, determine</span>
<span class="cm">		 * more and EOSP bit. Set EOSP if queue is empty</span>
<span class="cm">		 * or sufficient frames are delivered for this trigger.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">apsdq</span><span class="p">))</span>
			<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WMI_DATA_HDR_FLAGS_MORE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;</span> <span class="n">STA_PS_APSD_EOSP</span><span class="p">)</span>
			<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WMI_DATA_HDR_FLAGS_EOSP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WMI_DATA_HDR_FLAGS_UAPSD</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">apsd_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WMM_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ether_type</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">datap</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_ethertype</span><span class="p">(</span><span class="n">ether_type</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* packet is in DIX format  */</span>
			<span class="n">ip_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">datap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* packet is in 802.3 format */</span>
			<span class="n">llc_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span> <span class="o">*</span><span class="p">)</span>
							<span class="p">(</span><span class="n">datap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ether_type</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">llc_hdr</span><span class="o">-&gt;</span><span class="n">eth_type</span><span class="p">);</span>
			<span class="n">ip_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">llc_hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ether_type</span> <span class="o">==</span> <span class="n">IP_ETHERTYPE</span><span class="p">)</span>
			<span class="n">up</span> <span class="o">=</span> <span class="n">ath6kl_wmi_determine_user_priority</span><span class="p">(</span>
							<span class="n">ip_hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">traffic_class</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_traffic_class</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">apsd_info</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">traffic_class</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Queue the frames if the STA is sleeping */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
	<span class="n">is_apsdq_empty</span> <span class="o">=</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">apsdq</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">apsdq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this is the first pkt getting queued</span>
<span class="cm">	 * for this STA, update the PVB for this STA</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_apsdq_empty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_wmi_set_apsd_bfrd_traf</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
					      <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WMI_DATA_HDR_FLAGS_UAPSD</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_process_psq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">is_psq_empty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;</span> <span class="n">STA_PS_POLLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq</span><span class="p">))</span>
			<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WMI_DATA_HDR_FLAGS_MORE</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Queue the frames if the STA is sleeping */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
	<span class="n">is_psq_empty</span> <span class="o">=</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this is the first pkt getting queued</span>
<span class="cm">	 * for this STA, update the PVB for this</span>
<span class="cm">	 * STA.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_psq_empty</span><span class="p">)</span>
		<span class="n">ath6kl_wmi_set_pvb_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
				       <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
				       <span class="n">conn</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_powersave_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">datap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ps_queued</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">datap</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">q_mcast</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ctr</span> <span class="o">&lt;</span> <span class="n">AP_MAX_NUM_STA</span><span class="p">;</span> <span class="n">ctr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">[</span><span class="n">ctr</span><span class="p">].</span><span class="n">sta_flags</span> <span class="o">&amp;</span> <span class="n">STA_PS_SLEEP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">q_mcast</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">q_mcast</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If this transmit is not because of a Dtim Expiry</span>
<span class="cm">			 * q it.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DTIM_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bool</span> <span class="n">is_mcastq_empty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq_lock</span><span class="p">);</span>
				<span class="n">is_mcastq_empty</span> <span class="o">=</span>
					<span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq</span><span class="p">);</span>
				<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq_lock</span><span class="p">);</span>

				<span class="cm">/*</span>
<span class="cm">				 * If this is the first Mcast pkt getting</span>
<span class="cm">				 * queued indicate to the target to set the</span>
<span class="cm">				 * BitmapControl LSB of the TIM IE.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_mcastq_empty</span><span class="p">)</span>
					<span class="n">ath6kl_wmi_set_pvb_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
							       <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
							       <span class="n">MCAST_AID</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

				<span class="n">ps_queued</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * This transmit is because of Dtim expiry.</span>
<span class="cm">				 * Determine if MoreData bit has to be set.</span>
<span class="cm">				 */</span>
				<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq</span><span class="p">))</span>
					<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WMI_DATA_HDR_FLAGS_MORE</span><span class="p">;</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq_lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">ath6kl_find_sta</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">datap</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="cm">/* Inform the caller that the skb is consumed */</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;</span> <span class="n">STA_PS_SLEEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ps_queued</span> <span class="o">=</span> <span class="n">ath6kl_process_uapsdq</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span>
						<span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WMI_DATA_HDR_FLAGS_UAPSD</span><span class="p">))</span>
				<span class="n">ps_queued</span> <span class="o">=</span> <span class="n">ath6kl_process_psq</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span>
						<span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ps_queued</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Tx functions */</span>

<span class="kt">int</span> <span class="nf">ath6kl_control_tx</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">devt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		      <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">eid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">devt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_cookie</span> <span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ATH6KL_STATE_WOW</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_TX</span><span class="p">,</span>
		   <span class="s">&quot;%s: skb=0x%p, len=0x%x eid =%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">eid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_CTRL_EP_FULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">eid</span> <span class="o">==</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ctrl_ep</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Control endpoint is full, don&#39;t allocate resources, we</span>
<span class="cm">		 * are just going to drop this packet.</span>
<span class="cm">		 */</span>
		<span class="n">cookie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;wmi ctrl ep full, dropping pkt : 0x%p, len:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cookie</span> <span class="o">=</span> <span class="n">ath6kl_alloc_cookie</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_ctrl_tx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">eid</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eid</span> <span class="o">!=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ctrl_ep</span><span class="p">)</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">total_tx_data_pend</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">cookie</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">cookie</span><span class="o">-&gt;</span><span class="n">map_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_htc_pkt_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cookie</span><span class="o">-&gt;</span><span class="n">htc_pkt</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			 <span class="n">eid</span><span class="p">,</span> <span class="n">ATH6KL_CONTROL_PKT_TAG</span><span class="p">);</span>
	<span class="n">cookie</span><span class="o">-&gt;</span><span class="n">htc_pkt</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This interface is asynchronous, if there is an error, cleanup</span>
<span class="cm">	 * will happen in the TX completion callback.</span>
<span class="cm">	 */</span>
	<span class="n">ath6kl_htc_tx</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="o">-&gt;</span><span class="n">htc_pkt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_ctrl_tx:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_data_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_cookie</span> <span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">eid</span> <span class="o">=</span> <span class="n">ENDPOINT_UNUSED</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">map_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">htc_tag</span> <span class="o">=</span> <span class="n">ATH6KL_DATA_PKT_TAG</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ac</span> <span class="o">=</span> <span class="mi">99</span> <span class="p">;</span> <span class="cm">/* initialize to unmapped ac */</span>
	<span class="n">bool</span> <span class="n">chk_adhoc_ps_mapping</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_tx_meta_v2</span> <span class="n">meta_v2</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">meta</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">csum_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">csum_dest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">csum</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">meta_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_TX</span><span class="p">,</span>
		   <span class="s">&quot;%s: skb=0x%p, data=0x%p, len=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* If target is not associated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ATH6KL_STATE_ON</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>

	<span class="cm">/* AP mode Power saving processing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_powersave_ap</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_IP_CSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">csum</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">csum_start</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum_start</span> <span class="o">-</span>
					<span class="p">(</span><span class="n">skb_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span><span class="p">);</span>
			<span class="n">csum_dest</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum_offset</span> <span class="o">+</span> <span class="n">csum_start</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">needed_headroom</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tmp_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_realloc_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">needed_headroom</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">tmp_skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vif</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_wmi_dix_2_dot3</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;ath6kl_wmi_dix_2_dot3 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_IP_CSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">csum</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">meta_v2</span><span class="p">.</span><span class="n">csum_start</span> <span class="o">=</span> <span class="n">csum_start</span><span class="p">;</span>
			<span class="n">meta_v2</span><span class="p">.</span><span class="n">csum_dest</span> <span class="o">=</span> <span class="n">csum_dest</span><span class="p">;</span>

			<span class="cm">/* instruct target to calculate checksum */</span>
			<span class="n">meta_v2</span><span class="p">.</span><span class="n">csum_flags</span> <span class="o">=</span> <span class="n">WMI_META_V2_FLAG_CSUM_OFFLOAD</span><span class="p">;</span>
			<span class="n">meta_ver</span> <span class="o">=</span> <span class="n">WMI_META_VERSION_2</span><span class="p">;</span>
			<span class="n">meta</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">meta_v2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">meta_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">meta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_data_hdr_add</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
				<span class="n">DATA_MSGTYPE</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">meta_ver</span><span class="p">,</span>
				<span class="n">meta</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;failed to add wmi data header:%d</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">ADHOC_NETWORK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ibss_ps_enable</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">chk_adhoc_ps_mapping</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* get the stream mapping */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_implicit_create_pstream</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
				    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
				    <span class="mi">0</span><span class="p">,</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">WMM_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ac</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chk_adhoc_ps_mapping</span><span class="p">)</span>
		<span class="n">eid</span> <span class="o">=</span> <span class="n">ath6kl_ibss_map_epid</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map_no</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">eid</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ac2ep_map</span><span class="p">[</span><span class="n">ac</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eid</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">eid</span> <span class="o">==</span> <span class="n">ENDPOINT_UNUSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;eid %d is not mapped!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eid</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate resource for this packet */</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">ath6kl_alloc_cookie</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update counts while the lock is held */</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">eid</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">total_tx_data_pend</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We will touch (move the buffer data to align it. Since the</span>
<span class="cm">		 * skb buffer is cloned and not only the header is changed, we</span>
<span class="cm">		 * have to copy it to allow the changes. Since we are copying</span>
<span class="cm">		 * the data here, we may as well align it by reserving suitable</span>
<span class="cm">		 * headroom to avoid the memmove in ath6kl_htc_tx_buf_align().</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>

		<span class="n">nskb</span> <span class="o">=</span> <span class="n">skb_copy_expand</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">nskb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cookie</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">cookie</span><span class="o">-&gt;</span><span class="n">map_no</span> <span class="o">=</span> <span class="n">map_no</span><span class="p">;</span>
	<span class="n">set_htc_pkt_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cookie</span><span class="o">-&gt;</span><span class="n">htc_pkt</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			 <span class="n">eid</span><span class="p">,</span> <span class="n">htc_tag</span><span class="p">);</span>
	<span class="n">cookie</span><span class="o">-&gt;</span><span class="n">htc_pkt</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_RAW_BYTES</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;tx &quot;</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * HTC interface is asynchronous, if this fails, cleanup will</span>
<span class="cm">	 * happen in the ath6kl_tx_complete callback.</span>
<span class="cm">	 */</span>
	<span class="n">ath6kl_htc_tx</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="o">-&gt;</span><span class="n">htc_pkt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_tx:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* indicate tx activity or inactivity on a WMI stream */</span>
<span class="kt">void</span> <span class="nf">ath6kl_indicate_tx_activity</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">devt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">traffic_class</span><span class="p">,</span> <span class="n">bool</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">devt</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">eid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">eid</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ac2ep_map</span><span class="p">[</span><span class="n">traffic_class</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">notify_htc</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ac_stream_active</span><span class="p">[</span><span class="n">traffic_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">active</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Keep track of the active stream with the highest</span>
<span class="cm">		 * priority.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ac_stream_pri_map</span><span class="p">[</span><span class="n">traffic_class</span><span class="p">]</span> <span class="o">&gt;</span>
		    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hiac_stream_active_pri</span><span class="p">)</span>
			<span class="cm">/* set the new highest active priority */</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">hiac_stream_active_pri</span> <span class="o">=</span>
					<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ac_stream_pri_map</span><span class="p">[</span><span class="n">traffic_class</span><span class="p">];</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We may have to search for the next active stream</span>
<span class="cm">		 * that is the highest priority.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hiac_stream_active_pri</span> <span class="o">==</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ac_stream_pri_map</span><span class="p">[</span><span class="n">traffic_class</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The highest priority stream just went inactive</span>
<span class="cm">			 * reset and search for the &quot;next&quot; highest &quot;active&quot;</span>
<span class="cm">			 * priority stream.</span>
<span class="cm">			 */</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">hiac_stream_active_pri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WMM_NUM_AC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ac_stream_active</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ac_stream_pri_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span>
				     <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hiac_stream_active_pri</span><span class="p">))</span>
					<span class="cm">/*</span>
<span class="cm">					 * Set the new highest active</span>
<span class="cm">					 * priority.</span>
<span class="cm">					 */</span>
					<span class="n">ar</span><span class="o">-&gt;</span><span class="n">hiac_stream_active_pri</span> <span class="o">=</span>
						<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ac_stream_pri_map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="nl">notify_htc:</span>
	<span class="cm">/* notify HTC, this may cause credit distribution changes */</span>
	<span class="n">ath6kl_htc_activity_changed</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">htc_send_full_action</span> <span class="nf">ath6kl_tx_queue_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_send_full_action</span> <span class="n">action</span> <span class="o">=</span> <span class="n">HTC_SEND_FULL_KEEP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">endpoint</span> <span class="o">==</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ctrl_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Under normal WMI if this is getting full, then something</span>
<span class="cm">		 * is running rampant the host should not be exhausting the</span>
<span class="cm">		 * WMI queue with too many commands the only exception to</span>
<span class="cm">		 * this is during testing using endpointping.</span>
<span class="cm">		 */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WMI_CTRL_EP_FULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;wmi ctrl ep is full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">action</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">ATH6KL_CONTROL_PKT_TAG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">action</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The last MAX_HI_COOKIE_NUM &quot;batch&quot; of cookies are reserved for</span>
<span class="cm">	 * the highest active stream.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ac_stream_pri_map</span><span class="p">[</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ep2ac_map</span><span class="p">[</span><span class="n">endpoint</span><span class="p">]]</span> <span class="o">&lt;</span>
	    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hiac_stream_active_pri</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_count</span> <span class="o">&lt;=</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">endpoint</span><span class="p">].</span><span class="n">tx_drop_packet_threshold</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Give preference to the highest priority stream by</span>
<span class="cm">		 * dropping the packets which overflowed.</span>
<span class="cm">		 */</span>
		<span class="n">action</span> <span class="o">=</span> <span class="n">HTC_SEND_FULL_DROP</span><span class="p">;</span>

	<span class="cm">/* FIXME: Locking */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">ADHOC_NETWORK</span> <span class="o">||</span>
		    <span class="n">action</span> <span class="o">!=</span> <span class="n">HTC_SEND_FULL_DROP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">NETQ_STOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">action</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">action</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TODO this needs to be looked at */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_tx_clear_node_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">eid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">map_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">!=</span> <span class="n">ADHOC_NETWORK</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ibss_ps_enable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eid</span> <span class="o">==</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ctrl_ep</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">map_no</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">[</span><span class="n">map_no</span><span class="p">].</span><span class="n">tx_pend</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">[</span><span class="n">map_no</span><span class="p">].</span><span class="n">tx_pend</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map_no</span> <span class="o">!=</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_num</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">tx_pend</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_node_mapping</span><span class="p">));</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_num</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_tx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">packet_queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">skb_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_cookie</span> <span class="o">*</span><span class="n">ath6kl_cookie</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">map_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">eid</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">wake_event</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">flushing</span><span class="p">[</span><span class="n">ATH6KL_VIF_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">false</span><span class="p">};</span>
	<span class="n">u8</span> <span class="n">if_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_queue</span><span class="p">);</span>

	<span class="cm">/* lock the driver as we update internal state */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* reap completed packets */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">packet_queue</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">packet_queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span>
					  <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="n">ath6kl_cookie</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_cookie</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">pkt_cntxt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cookie</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fatal</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_cookie</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">eid</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">;</span>
		<span class="n">map_no</span> <span class="o">=</span> <span class="n">ath6kl_cookie</span><span class="o">-&gt;</span><span class="n">map_no</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span> <span class="o">||</span> <span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fatal</span><span class="p">;</span>

		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">!=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fatal</span><span class="p">;</span>

		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">eid</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">eid</span> <span class="o">!=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ctrl_ep</span><span class="p">)</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">total_tx_data_pend</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">eid</span> <span class="o">==</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ctrl_ep</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_CTRL_EP_FULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">WMI_CTRL_EP_FULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">eid</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">wake_event</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">eid</span> <span class="o">==</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ctrl_ep</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">if_idx</span> <span class="o">=</span> <span class="n">wmi_cmd_hdr_get_if_idx</span><span class="p">(</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">wmi_cmd_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">if_idx</span> <span class="o">=</span> <span class="n">wmi_data_hdr_get_if_idx</span><span class="p">(</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_get_vif_by_index</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_free_cookie</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">ath6kl_cookie</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">)</span>
				<span class="cm">/* a packet was flushed  */</span>
				<span class="n">flushing</span><span class="p">[</span><span class="n">if_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="n">vif</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOSPC</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">)</span>
				<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;tx complete error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_TX</span><span class="p">,</span>
				   <span class="s">&quot;%s: skb=0x%p data=0x%p len=0x%x eid=%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">,</span>
				   <span class="n">eid</span><span class="p">,</span> <span class="s">&quot;error!&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_TX</span><span class="p">,</span>
				   <span class="s">&quot;%s: skb=0x%p data=0x%p len=0x%x eid=%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">,</span>
				   <span class="n">eid</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>

			<span class="n">flushing</span><span class="p">[</span><span class="n">if_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">vif</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">vif</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ath6kl_tx_clear_node_map</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="n">map_no</span><span class="p">);</span>

		<span class="n">ath6kl_free_cookie</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">ath6kl_cookie</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NETQ_STOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">NETQ_STOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_queue</span><span class="p">);</span>

	<span class="cm">/* FIXME: Locking */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">flushing</span><span class="p">[</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wake_event</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">fatal:</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_tx_data_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* flush all the data (non-control) streams */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WMM_NUM_AC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ath6kl_htc_flush_txep</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ac2ep_map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				      <span class="n">ATH6KL_DATA_PKT_TAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Rx functions */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_deliver_frames_to_nw_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_rx_ni</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_alloc_netbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="n">u16</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_buf_alloc</span><span class="p">(</span><span class="n">ATH6KL_BUFFER_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;netbuf allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">num</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">aggr_get_free_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">aggr_info</span> <span class="o">*</span><span class="n">p_aggr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_aggr</span><span class="o">-&gt;</span><span class="n">rx_amsdu_freeq</span><span class="p">)</span> <span class="o">&lt;</span>
	    <span class="p">(</span><span class="n">AGGR_NUM_OF_FREE_NETBUFS</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">ath6kl_alloc_netbufs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_aggr</span><span class="o">-&gt;</span><span class="n">rx_amsdu_freeq</span><span class="p">,</span>
				     <span class="n">AGGR_NUM_OF_FREE_NETBUFS</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_aggr</span><span class="o">-&gt;</span><span class="n">rx_amsdu_freeq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_rx_refill</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">endpoint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_buf_refill</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">queue</span><span class="p">;</span>

	<span class="n">n_buf_refill</span> <span class="o">=</span> <span class="n">ATH6KL_MAX_RX_BUFFERS</span> <span class="o">-</span>
			  <span class="n">ath6kl_htc_get_rxbuf_num</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_buf_refill</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_RX</span><span class="p">,</span>
		   <span class="s">&quot;%s: providing htc with %d buffers at eid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">n_buf_refill</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rx_buf</span> <span class="o">&lt;</span> <span class="n">n_buf_refill</span><span class="p">;</span> <span class="n">rx_buf</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_buf_alloc</span><span class="p">(</span><span class="n">ATH6KL_BUFFER_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">packet</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">set_htc_rxpkt_info</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				   <span class="n">ATH6KL_BUFFER_SIZE</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">);</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">ath6kl_htc_add_rxbuf_multiple</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_refill_amsdu_rxbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">ath6kl_buf_alloc</span><span class="p">(</span><span class="n">ATH6KL_AMSDU_BUFFER_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">packet</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">set_htc_rxpkt_info</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				   <span class="n">ATH6KL_AMSDU_BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">amsdu_rx_buffer_queue</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Callback to allocate a receive buffer for a pending packet. We use a</span>
<span class="cm"> * pre-allocated list of buffers of maximum AMSDU size (4K).</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="nf">ath6kl_alloc_amsdu_rxbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					    <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">endpoint</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pkt_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">refill_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_RX</span><span class="p">,</span> <span class="s">&quot;%s: eid=%d, len:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">ATH6KL_BUFFER_SIZE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ATH6KL_AMSDU_BUFFER_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">amsdu_rx_buffer_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">refill_cnt</span> <span class="o">=</span> <span class="n">ATH6KL_MAX_AMSDU_RX_BUFFERS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">refill_buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">amsdu_rx_buffer_queue</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">pkt_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">amsdu_rx_buffer_queue</span><span class="p">)</span>
		<span class="n">depth</span><span class="o">++</span><span class="p">;</span>

	<span class="n">refill_cnt</span> <span class="o">=</span> <span class="n">ATH6KL_MAX_AMSDU_RX_BUFFERS</span> <span class="o">-</span> <span class="n">depth</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* set actual endpoint ID */</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">;</span>

<span class="nl">refill_buf:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">refill_cnt</span> <span class="o">&gt;=</span> <span class="n">ATH6KL_AMSDU_REFILL_THRESHOLD</span><span class="p">)</span>
		<span class="n">ath6kl_refill_amsdu_rxbufs</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">refill_cnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">packet</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aggr_slice_amsdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">aggr_info</span> <span class="o">*</span><span class="n">p_aggr</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">rxtid</span> <span class="o">*</span><span class="n">rxtid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">frame_8023_len</span><span class="p">,</span> <span class="n">payload_8023_len</span><span class="p">,</span> <span class="n">mac_hdr_len</span><span class="p">,</span> <span class="n">amsdu_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">framep</span><span class="p">;</span>

	<span class="n">mac_hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span><span class="p">);</span>
	<span class="n">framep</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">mac_hdr_len</span><span class="p">;</span>
	<span class="n">amsdu_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">mac_hdr_len</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">amsdu_len</span> <span class="o">&gt;</span> <span class="n">mac_hdr_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">framep</span><span class="p">;</span>
		<span class="n">payload_8023_len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">payload_8023_len</span> <span class="o">&lt;</span> <span class="n">MIN_MSDU_SUBFRAME_PAYLOAD_LEN</span> <span class="o">||</span>
		    <span class="n">payload_8023_len</span> <span class="o">&gt;</span> <span class="n">MAX_MSDU_SUBFRAME_PAYLOAD_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;802.3 AMSDU frame bound check failed. len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">payload_8023_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">frame_8023_len</span> <span class="o">=</span> <span class="n">payload_8023_len</span> <span class="o">+</span> <span class="n">mac_hdr_len</span><span class="p">;</span>
		<span class="n">new_skb</span> <span class="o">=</span> <span class="n">aggr_get_free_skb</span><span class="p">(</span><span class="n">p_aggr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;no buffer available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">framep</span><span class="p">,</span> <span class="n">frame_8023_len</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">frame_8023_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_wmi_dot3_2_dix</span><span class="p">(</span><span class="n">new_skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;dot3_2_dix error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">new_skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">new_skb</span><span class="p">);</span>

		<span class="cm">/* Is this the last subframe within this aggregate ? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">amsdu_len</span> <span class="o">-</span> <span class="n">frame_8023_len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Add the length of A-MSDU subframe padding bytes -</span>
<span class="cm">		 * Round to nearest word.</span>
<span class="cm">		 */</span>
		<span class="n">frame_8023_len</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">frame_8023_len</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">framep</span> <span class="o">+=</span> <span class="n">frame_8023_len</span><span class="p">;</span>
		<span class="n">amsdu_len</span> <span class="o">-=</span> <span class="n">frame_8023_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aggr_deque_frms</span><span class="p">(</span><span class="k">struct</span> <span class="n">aggr_info_conn</span> <span class="o">*</span><span class="n">agg_conn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">seq_no</span><span class="p">,</span> <span class="n">u8</span> <span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxtid</span> <span class="o">*</span><span class="n">rxtid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">skb_hold_q</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idx_end</span><span class="p">,</span> <span class="n">seq_end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxtid_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>

	<span class="n">rxtid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agg_conn</span><span class="o">-&gt;</span><span class="n">rx_tid</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
	<span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agg_conn</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">AGGR_WIN_IDX</span><span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">seq_next</span><span class="p">,</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * idx_end is typically the last possible frame in the window,</span>
<span class="cm">	 * but changes to &#39;the&#39; seq_no, when BAR comes. If seq_no</span>
<span class="cm">	 * is non-zero, we will go up to that and stop.</span>
<span class="cm">	 * Note: last seq no in current window will occupy the same</span>
<span class="cm">	 * index position as index that is just previous to start.</span>
<span class="cm">	 * An imp point : if win_sz is 7, for seq_no space of 4095,</span>
<span class="cm">	 * then, there would be holes when sequence wrap around occurs.</span>
<span class="cm">	 * Target should judiciously choose the win_sz, based on</span>
<span class="cm">	 * this condition. For 4095, (TID_WINDOW_SZ = 2 x win_sz</span>
<span class="cm">	 * 2, 4, 8, 16 win_sz works fine).</span>
<span class="cm">	 * We must deque from &quot;idx&quot; to &quot;idx_end&quot;, including both.</span>
<span class="cm">	 */</span>
	<span class="n">seq_end</span> <span class="o">=</span> <span class="n">seq_no</span> <span class="o">?</span> <span class="n">seq_no</span> <span class="o">:</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">seq_next</span><span class="p">;</span>
	<span class="n">idx_end</span> <span class="o">=</span> <span class="n">AGGR_WIN_IDX</span><span class="p">(</span><span class="n">seq_end</span><span class="p">,</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">is_amsdu</span><span class="p">)</span>
				<span class="n">aggr_slice_amsdu</span><span class="p">(</span><span class="n">agg_conn</span><span class="o">-&gt;</span><span class="n">aggr_info</span><span class="p">,</span> <span class="n">rxtid</span><span class="p">,</span>
						 <span class="n">node</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">num_hole</span><span class="o">++</span><span class="p">;</span>

		<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">seq_next</span> <span class="o">=</span> <span class="n">ATH6KL_NEXT_SEQ_NO</span><span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">seq_next</span><span class="p">);</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">AGGR_WIN_IDX</span><span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">seq_next</span><span class="p">,</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">idx_end</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">num_delivered</span> <span class="o">+=</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">)))</span>
		<span class="n">ath6kl_deliver_frames_to_nw_stack</span><span class="p">(</span><span class="n">agg_conn</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">aggr_process_recv_frm</span><span class="p">(</span><span class="k">struct</span> <span class="n">aggr_info_conn</span> <span class="o">*</span><span class="n">agg_conn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">seq_no</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="n">is_amsdu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxtid</span> <span class="o">*</span><span class="n">rxtid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxtid_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">skb_hold_q</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idx</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">cur</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_queued</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">extended_end</span><span class="p">;</span>

	<span class="n">rxtid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agg_conn</span><span class="o">-&gt;</span><span class="n">rx_tid</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
	<span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agg_conn</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">num_into_aggr</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">aggr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_amsdu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">aggr_slice_amsdu</span><span class="p">(</span><span class="n">agg_conn</span><span class="o">-&gt;</span><span class="n">aggr_info</span><span class="p">,</span> <span class="n">rxtid</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
			<span class="n">is_queued</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">num_amsdu</span><span class="o">++</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">)))</span>
				<span class="n">ath6kl_deliver_frames_to_nw_stack</span><span class="p">(</span><span class="n">agg_conn</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
								  <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">is_queued</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check the incoming sequence no, if it&#39;s in the window */</span>
	<span class="n">st</span> <span class="o">=</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">seq_next</span><span class="p">;</span>
	<span class="n">cur</span> <span class="o">=</span> <span class="n">seq_no</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span> <span class="o">+</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ATH6KL_MAX_SEQ_NO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">st</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&lt;</span> <span class="n">st</span> <span class="o">||</span> <span class="n">cur</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">st</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&lt;</span> <span class="n">st</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">extended_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">+</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">ATH6KL_MAX_SEQ_NO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">extended_end</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">cur</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">||</span> <span class="n">cur</span> <span class="o">&gt;</span> <span class="n">extended_end</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">extended_end</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;</span> <span class="n">extended_end</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">cur</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">aggr_deque_frms</span><span class="p">(</span><span class="n">agg_conn</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;=</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">seq_next</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">-</span> <span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">seq_next</span> <span class="o">=</span> <span class="n">ATH6KL_MAX_SEQ_NO</span> <span class="o">-</span>
						  <span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">cur</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Dequeue only those frames that are outside the</span>
<span class="cm">			 * new shifted window.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;=</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">st</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">-</span> <span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">st</span> <span class="o">=</span> <span class="n">ATH6KL_MAX_SEQ_NO</span> <span class="o">-</span>
					<span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">cur</span><span class="p">);</span>

			<span class="n">aggr_deque_frms</span><span class="p">(</span><span class="n">agg_conn</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">num_oow</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">AGGR_WIN_IDX</span><span class="p">(</span><span class="n">seq_no</span><span class="p">,</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span><span class="p">);</span>

	<span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Is the cur frame duplicate or something beyond our window(hold_q</span>
<span class="cm">	 * -&gt; which is 2x, already)?</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1. Duplicate is easy - drop incoming frame.</span>
<span class="cm">	 * 2. Not falling in current sliding window.</span>
<span class="cm">	 *  2a. is the frame_seq_no preceding current tid_seq_no?</span>
<span class="cm">	 *      -&gt; drop the frame. perhaps sender did not get our ACK.</span>
<span class="cm">	 *         this is taken care of above.</span>
<span class="cm">	 *  2b. is the frame_seq_no beyond window(st, TID_WINDOW_SZ);</span>
<span class="cm">	 *      -&gt; Taken care of it above, by moving window forward.</span>
<span class="cm">	 */</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">num_dups</span><span class="o">++</span><span class="p">;</span>

	<span class="n">node</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>
	<span class="n">is_queued</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">node</span><span class="o">-&gt;</span><span class="n">is_amsdu</span> <span class="o">=</span> <span class="n">is_amsdu</span><span class="p">;</span>
	<span class="n">node</span><span class="o">-&gt;</span><span class="n">seq_no</span> <span class="o">=</span> <span class="n">seq_no</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">is_amsdu</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">num_amsdu</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">num_mpdu</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">aggr_deque_frms</span><span class="p">(</span><span class="n">agg_conn</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agg_conn</span><span class="o">-&gt;</span><span class="n">timer_scheduled</span><span class="p">)</span>
		<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">progress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * There is a frame in the queue and no</span>
<span class="cm">				 * timer so start a timer to ensure that</span>
<span class="cm">				 * the frame doesn&#39;t remain stuck</span>
<span class="cm">				 * forever.</span>
<span class="cm">				 */</span>
				<span class="n">agg_conn</span><span class="o">-&gt;</span><span class="n">timer_scheduled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg_conn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span>
					   <span class="n">HZ</span> <span class="o">*</span> <span class="p">(</span><span class="n">AGGR_RX_TIMEOUT</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">));</span>
				<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">timer_mon</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="n">is_queued</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_uapsd_trigger_frame_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_apsdq_empty</span><span class="p">,</span> <span class="n">is_apsdq_empty_at_start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_frames_to_deliver</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the APSD q for this STA is not empty, dequeue and</span>
<span class="cm">	 * send a pkt from the head of the q. Also update the</span>
<span class="cm">	 * More data bit in the WMI_DATA_HDR if there are</span>
<span class="cm">	 * more pkts for this STA in the APSD q.</span>
<span class="cm">	 * If there are no more pkts for this STA,</span>
<span class="cm">	 * update the APSD bitmap for this STA.</span>
<span class="cm">	 */</span>

	<span class="n">num_frames_to_deliver</span> <span class="o">=</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">apsd_info</span> <span class="o">&gt;&gt;</span> <span class="n">ATH6KL_APSD_NUM_OF_AC</span><span class="p">)</span> <span class="o">&amp;</span>
						    <span class="n">ATH6KL_APSD_FRAME_MASK</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Number of frames to send in a service period is</span>
<span class="cm">	 * indicated by the station</span>
<span class="cm">	 * in the QOS_INFO of the association request</span>
<span class="cm">	 * If it is zero, send all frames</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_frames_to_deliver</span><span class="p">)</span>
		<span class="n">num_frames_to_deliver</span> <span class="o">=</span> <span class="n">ATH6KL_APSD_ALL_FRAME</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
	<span class="n">is_apsdq_empty</span> <span class="o">=</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">apsdq</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
	<span class="n">is_apsdq_empty_at_start</span> <span class="o">=</span> <span class="n">is_apsdq_empty</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">is_apsdq_empty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">num_frames_to_deliver</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">apsdq</span><span class="p">);</span>
		<span class="n">is_apsdq_empty</span> <span class="o">=</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">apsdq</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set the STA flag to Trigger delivery,</span>
<span class="cm">		 * so that the frame will go out</span>
<span class="cm">		 */</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">|=</span> <span class="n">STA_PS_APSD_TRIGGER</span><span class="p">;</span>
		<span class="n">num_frames_to_deliver</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* Last frame in the service period, set EOSP or queue empty */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">is_apsdq_empty</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">num_frames_to_deliver</span><span class="p">))</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">|=</span> <span class="n">STA_PS_APSD_EOSP</span><span class="p">;</span>

		<span class="n">ath6kl_data_tx</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STA_PS_APSD_TRIGGER</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STA_PS_APSD_EOSP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_apsdq_empty</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_apsdq_empty_at_start</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="n">WMI_AP_APSD_NO_DELIVERY_FRAMES</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ath6kl_wmi_set_apsd_bfrd_traf</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
					      <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">pkt_cntxt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_rx_meta_v2</span> <span class="o">*</span><span class="n">meta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_data_hdr</span> <span class="o">*</span><span class="n">dhdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_hdr_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">meta_type</span><span class="p">,</span> <span class="n">dot11_hdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pad_before_data_start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">ept</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_amsdu</span><span class="p">,</span> <span class="n">prev_ps</span><span class="p">,</span> <span class="n">ps_state</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">trig_state</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">datap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aggr_info_conn</span> <span class="o">*</span><span class="n">aggr_conn</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seq_no</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_RX</span><span class="p">,</span>
		   <span class="s">&quot;%s: ar=0x%p eid=%d, skb=0x%p, data=0x%p, len=0x%x status:%d&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="n">ept</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
		   <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">);</span>

	<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_RAW_BYTES</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;rx &quot;</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ept</span> <span class="o">==</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ctrl_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath6kl_check_wow_status</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
			<span class="n">ath6kl_wmi_control_rx</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">if_idx</span> <span class="o">=</span>
		<span class="n">wmi_cmd_hdr_get_if_idx</span><span class="p">((</span><span class="k">struct</span> <span class="n">wmi_cmd_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">if_idx</span> <span class="o">=</span>
		<span class="n">wmi_data_hdr_get_if_idx</span><span class="p">((</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_get_vif_by_index</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Take lock to protect buffer counts and adaptive power throughput</span>
<span class="cm">	 * state.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">if_lock</span><span class="p">);</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">if_lock</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">EPPING_ALIGNMENT_PAD</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">EPPING_ALIGNMENT_PAD</span><span class="p">);</span>
		<span class="n">ath6kl_deliver_frames_to_nw_stack</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_check_wow_status</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">min_hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span><span class="p">)</span> <span class="o">+</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span><span class="p">);</span>

	<span class="n">dhdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In the case of AP mode we may receive NULL data frames</span>
<span class="cm">	 * that do not have LLC hdr. They are 16 bytes in size.</span>
<span class="cm">	 * Allow these frames in the AP mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">!=</span> <span class="n">AP_NETWORK</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">&lt;</span> <span class="n">min_hdr_len</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">&gt;</span> <span class="n">WMI_MAX_AMSDU_RX_DATA_FRAME_LENGTH</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ath6kl_info</span><span class="p">(</span><span class="s">&quot;frame len is too short or too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get the Power save state of the STA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">meta_type</span> <span class="o">=</span> <span class="n">wmi_data_hdr_get_meta</span><span class="p">(</span><span class="n">dhdr</span><span class="p">);</span>

		<span class="n">ps_state</span> <span class="o">=</span> <span class="o">!!</span><span class="p">((</span><span class="n">dhdr</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">&gt;&gt;</span> <span class="n">WMI_DATA_HDR_PS_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
			      <span class="n">WMI_DATA_HDR_PS_MASK</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span><span class="p">);</span>
		<span class="n">trig_state</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dhdr</span><span class="o">-&gt;</span><span class="n">info3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WMI_DATA_HDR_TRIG</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">meta_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WMI_META_VERSION_1</span>:
			<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_rx_meta_v1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WMI_META_VERSION_2</span>:
			<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_rx_meta_v2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">datap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">ath6kl_find_sta</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">datap</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If there is a change in PS state of the STA,</span>
<span class="cm">		 * take appropriate steps:</span>
<span class="cm">		 *</span>
<span class="cm">		 * 1. If Sleep--&gt;Awake, flush the psq for the STA</span>
<span class="cm">		 *    Clear the PVB for the STA.</span>
<span class="cm">		 * 2. If Awake--&gt;Sleep, Starting queueing frames</span>
<span class="cm">		 *    the STA.</span>
<span class="cm">		 */</span>
		<span class="n">prev_ps</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;</span> <span class="n">STA_PS_SLEEP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ps_state</span><span class="p">)</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">|=</span> <span class="n">STA_PS_SLEEP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STA_PS_SLEEP</span><span class="p">;</span>

		<span class="cm">/* Accept trigger only when the station is in sleep */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;</span> <span class="n">STA_PS_SLEEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">trig_state</span><span class="p">)</span>
			<span class="n">ath6kl_uapsd_trigger_frame_rx</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prev_ps</span> <span class="o">^</span> <span class="o">!!</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;</span> <span class="n">STA_PS_SLEEP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;</span> <span class="n">STA_PS_SLEEP</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skbuff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">bool</span> <span class="n">is_apsdq_empty</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">ath6kl_mgmt_buff</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
				<span class="n">u8</span> <span class="n">idx</span><span class="p">;</span>

				<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mgmt_psq_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mgmt</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span>
							<span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mgmt_psq</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">ath6kl_mgmt_buff</span><span class="p">,</span>
							<span class="n">list</span><span class="p">);</span>
					<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
					<span class="n">conn</span><span class="o">-&gt;</span><span class="n">mgmt_psq_len</span><span class="o">--</span><span class="p">;</span>
					<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
					<span class="n">idx</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">;</span>

					<span class="n">ath6kl_wmi_send_mgmt_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
								 <span class="n">idx</span><span class="p">,</span>
								 <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
								 <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">,</span>
								 <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
								 <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
								 <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
								 <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">no_cck</span><span class="p">);</span>

					<span class="n">kfree</span><span class="p">(</span><span class="n">mgmt</span><span class="p">);</span>
					<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">mgmt_psq_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">skbuff</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
					<span class="n">ath6kl_data_tx</span><span class="p">(</span><span class="n">skbuff</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
					<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">is_apsdq_empty</span> <span class="o">=</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">apsdq</span><span class="p">);</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">skbuff</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">apsdq</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
					<span class="n">ath6kl_data_tx</span><span class="p">(</span><span class="n">skbuff</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
					<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_apsdq_empty</span><span class="p">)</span>
					<span class="n">ath6kl_wmi_set_apsd_bfrd_traf</span><span class="p">(</span>
							<span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
							<span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
							<span class="n">conn</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="cm">/* Clear the PVB for this STA */</span>
				<span class="n">ath6kl_wmi_set_pvb_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						       <span class="n">conn</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* drop NULL data frames here */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">&lt;</span> <span class="n">min_hdr_len</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">&gt;</span>
		     <span class="n">WMI_MAX_AMSDU_RX_DATA_FRAME_LENGTH</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">is_amsdu</span> <span class="o">=</span> <span class="n">wmi_data_hdr_is_amsdu</span><span class="p">(</span><span class="n">dhdr</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">tid</span> <span class="o">=</span> <span class="n">wmi_data_hdr_get_up</span><span class="p">(</span><span class="n">dhdr</span><span class="p">);</span>
	<span class="n">seq_no</span> <span class="o">=</span> <span class="n">wmi_data_hdr_get_seqno</span><span class="p">(</span><span class="n">dhdr</span><span class="p">);</span>
	<span class="n">meta_type</span> <span class="o">=</span> <span class="n">wmi_data_hdr_get_meta</span><span class="p">(</span><span class="n">dhdr</span><span class="p">);</span>
	<span class="n">dot11_hdr</span> <span class="o">=</span> <span class="n">wmi_data_hdr_get_dot11</span><span class="p">(</span><span class="n">dhdr</span><span class="p">);</span>
	<span class="n">pad_before_data_start</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dhdr</span><span class="o">-&gt;</span><span class="n">info3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">WMI_DATA_HDR_PAD_BEFORE_DATA_SHIFT</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">WMI_DATA_HDR_PAD_BEFORE_DATA_MASK</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">meta_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WMI_META_VERSION_1</span>:
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_rx_meta_v1</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_META_VERSION_2</span>:
		<span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_rx_meta_v2</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">csum_flags</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_COMPLETE</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__wsum</span><span class="p">)</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_rx_meta_v2</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pad_before_data_start</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dot11_hdr</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_wmi_dot11_hdr_remove</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_amsdu</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_wmi_dot3_2_dix</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Drop frames that could not be processed (lack of</span>
<span class="cm">		 * memory, etc.)</span>
<span class="cm">		 */</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">datap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">datap</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">))</span>
			<span class="cm">/*</span>
<span class="cm">			 * Bcast/Mcast frames should be sent to the</span>
<span class="cm">			 * OS stack as well as on the air.</span>
<span class="cm">			 */</span>
			<span class="n">skb1</span> <span class="o">=</span> <span class="n">skb_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Search for a connected STA with dstMac</span>
<span class="cm">			 * as the Mac address. If found send the</span>
<span class="cm">			 * frame to it on the air else send the</span>
<span class="cm">			 * frame up the stack.</span>
<span class="cm">			 */</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">ath6kl_find_sta</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">datap</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&amp;&amp;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">intra_bss</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb1</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">intra_bss</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb1</span><span class="p">)</span>
			<span class="n">ath6kl_data_tx</span><span class="p">(</span><span class="n">skb1</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* nothing to deliver up the stack */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">datap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_unicast_ether_addr</span><span class="p">(</span><span class="n">datap</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">ath6kl_find_sta</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">datap</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">aggr_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">aggr_conn</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">aggr_cntxt</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">aggr_process_recv_frm</span><span class="p">(</span><span class="n">aggr_conn</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">seq_no</span><span class="p">,</span>
					  <span class="n">is_amsdu</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* aggregation code will handle the skb */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">datap</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">))</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">.</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ath6kl_deliver_frames_to_nw_stack</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aggr_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aggr_info_conn</span> <span class="o">*</span><span class="n">aggr_conn</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aggr_info_conn</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxtid</span> <span class="o">*</span><span class="n">rxtid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxtid_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_OF_TIDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxtid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">rx_tid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">aggr</span> <span class="o">||</span> <span class="o">!</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">timer_mon</span> <span class="o">||</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">progress</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">num_timeouts</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_AGGR</span><span class="p">,</span>
			   <span class="s">&quot;aggr timeout (st %d end %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">seq_next</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">seq_next</span> <span class="o">+</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="n">ATH6KL_MAX_SEQ_NO</span><span class="p">));</span>
		<span class="n">aggr_deque_frms</span><span class="p">(</span><span class="n">aggr_conn</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">timer_scheduled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_OF_TIDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxtid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">rx_tid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">aggr</span> <span class="o">&amp;&amp;</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">timer_scheduled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">timer_mon</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span><span class="p">)</span>
				<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">timer_mon</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">timer_scheduled</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
			  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">AGGR_RX_TIMEOUT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aggr_delete_tid_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">aggr_info_conn</span> <span class="o">*</span><span class="n">aggr_conn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxtid</span> <span class="o">*</span><span class="n">rxtid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxtid_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aggr_conn</span> <span class="o">||</span> <span class="n">tid</span> <span class="o">&gt;=</span> <span class="n">NUM_OF_TIDS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rxtid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">rx_tid</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
	<span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">aggr</span><span class="p">)</span>
		<span class="n">aggr_deque_frms</span><span class="p">(</span><span class="n">aggr_conn</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">aggr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">timer_mon</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">win_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">seq_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q</span><span class="p">);</span>
	<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxtid_stats</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">aggr_recv_addba_req_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid_mux</span><span class="p">,</span> <span class="n">u16</span> <span class="n">seq_no</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">win_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aggr_info_conn</span> <span class="o">*</span><span class="n">aggr_conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxtid</span> <span class="o">*</span><span class="n">rxtid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxtid_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hold_q_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">,</span> <span class="n">aid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aid</span> <span class="o">=</span> <span class="n">ath6kl_get_aid</span><span class="p">(</span><span class="n">tid_mux</span><span class="p">);</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">ath6kl_find_sta_by_aid</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span> <span class="n">aid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
			<span class="n">aggr_conn</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">aggr_conn</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">aggr_cntxt</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aggr_conn</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">ath6kl_get_tid</span><span class="p">(</span><span class="n">tid_mux</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&gt;=</span> <span class="n">NUM_OF_TIDS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rxtid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">rx_tid</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
	<span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">win_sz</span> <span class="o">&lt;</span> <span class="n">AGGR_WIN_SZ_MIN</span> <span class="o">||</span> <span class="n">win_sz</span> <span class="o">&gt;</span> <span class="n">AGGR_WIN_SZ_MAX</span><span class="p">)</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_RX</span><span class="p">,</span> <span class="s">&quot;%s: win_sz %d, tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">win_sz</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">aggr</span><span class="p">)</span>
		<span class="n">aggr_delete_tid_state</span><span class="p">(</span><span class="n">aggr_conn</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">seq_next</span> <span class="o">=</span> <span class="n">seq_no</span><span class="p">;</span>
	<span class="n">hold_q_size</span> <span class="o">=</span> <span class="n">TID_WINDOW_SZ</span><span class="p">(</span><span class="n">win_sz</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">skb_hold_q</span><span class="p">);</span>
	<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">hold_q_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">win_sz</span> <span class="o">=</span> <span class="n">win_sz</span><span class="p">;</span>
	<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">hold_q_sz</span> <span class="o">=</span> <span class="n">TID_WINDOW_SZ</span><span class="p">(</span><span class="n">win_sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">aggr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">aggr_conn_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aggr_info</span> <span class="o">*</span><span class="n">aggr_info</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">aggr_info_conn</span> <span class="o">*</span><span class="n">aggr_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rxtid</span> <span class="o">*</span><span class="n">rxtid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">aggr_sz</span> <span class="o">=</span> <span class="n">AGGR_SZ_DEFAULT</span><span class="p">;</span>
	<span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">aggr_timeout</span><span class="p">;</span>
	<span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aggr_conn</span><span class="p">;</span>
	<span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">aggr_info</span> <span class="o">=</span> <span class="n">aggr_info</span><span class="p">;</span>

	<span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">timer_scheduled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_OF_TIDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxtid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">rx_tid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">aggr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">timer_mon</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">struct</span> <span class="n">aggr_info</span> <span class="o">*</span><span class="nf">aggr_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aggr_info</span> <span class="o">*</span><span class="n">p_aggr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">p_aggr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aggr_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_aggr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to alloc memory for aggr_node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p_aggr</span><span class="o">-&gt;</span><span class="n">aggr_conn</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aggr_info_conn</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_aggr</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to alloc memory for connection specific aggr info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p_aggr</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">aggr_conn_init</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">p_aggr</span><span class="p">,</span> <span class="n">p_aggr</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">);</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_aggr</span><span class="o">-&gt;</span><span class="n">rx_amsdu_freeq</span><span class="p">);</span>
	<span class="n">ath6kl_alloc_netbufs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_aggr</span><span class="o">-&gt;</span><span class="n">rx_amsdu_freeq</span><span class="p">,</span> <span class="n">AGGR_NUM_OF_FREE_NETBUFS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p_aggr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">aggr_recv_delba_req_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid_mux</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxtid</span> <span class="o">*</span><span class="n">rxtid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aggr_info_conn</span> <span class="o">*</span><span class="n">aggr_conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">,</span> <span class="n">aid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aid</span> <span class="o">=</span> <span class="n">ath6kl_get_aid</span><span class="p">(</span><span class="n">tid_mux</span><span class="p">);</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">ath6kl_find_sta_by_aid</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span> <span class="n">aid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
			<span class="n">aggr_conn</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">aggr_conn</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">aggr_cntxt</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aggr_conn</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">ath6kl_get_tid</span><span class="p">(</span><span class="n">tid_mux</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&gt;=</span> <span class="n">NUM_OF_TIDS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rxtid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">rx_tid</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxtid</span><span class="o">-&gt;</span><span class="n">aggr</span><span class="p">)</span>
		<span class="n">aggr_delete_tid_state</span><span class="p">(</span><span class="n">aggr_conn</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">aggr_reset_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">aggr_info_conn</span> <span class="o">*</span><span class="n">aggr_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aggr_conn</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">timer_scheduled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">aggr_conn</span><span class="o">-&gt;</span><span class="n">timer_scheduled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="n">NUM_OF_TIDS</span><span class="p">;</span> <span class="n">tid</span><span class="o">++</span><span class="p">)</span>
		<span class="n">aggr_delete_tid_state</span><span class="p">(</span><span class="n">aggr_conn</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* clean up our amsdu buffer list */</span>
<span class="kt">void</span> <span class="nf">ath6kl_cleanup_amsdu_rxbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pkt</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">amsdu_rx_buffer_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">amsdu_rx_buffer_queue</span><span class="p">,</span>
				 <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">pkt_cntxt</span><span class="p">);</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">aggr_module_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">aggr_info</span> <span class="o">*</span><span class="n">aggr_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aggr_info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">aggr_reset_state</span><span class="p">(</span><span class="n">aggr_info</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aggr_info</span><span class="o">-&gt;</span><span class="n">rx_amsdu_freeq</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">aggr_info</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">aggr_info</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
