<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath6kl › debug.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>debug.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004-2011 Atheros Communications Inc.</span>
<span class="cm"> * Copyright (c) 2011-2012 Qualcomm Atheros, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;core.h&quot;</span>

<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;target.h&quot;</span>

<span class="k">struct</span> <span class="n">ath6kl_fwlog_slot</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>

	<span class="cm">/* max ATH6KL_FWLOG_PAYLOAD_SIZE bytes */</span>
	<span class="n">u8</span> <span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define ATH6KL_FWLOG_MAX_ENTRIES 20</span>

<span class="cp">#define ATH6KL_FWLOG_VALID_MASK 0x1ffff</span>

<span class="kt">int</span> <span class="nf">ath6kl_printk</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rtn</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">rtn</span> <span class="o">=</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sath6kl: %pV&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rtn</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath6kl_printk</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ATH6KL_DEBUG</span>

<span class="kt">void</span> <span class="nf">ath6kl_dbg</span><span class="p">(</span><span class="k">enum</span> <span class="n">ATH6K_DEBUG_MASK</span> <span class="n">mask</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">debug_mask</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">ath6kl_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;%pV&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath6kl_dbg</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath6kl_dbg_dump</span><span class="p">(</span><span class="k">enum</span> <span class="n">ATH6K_DEBUG_MASK</span> <span class="n">mask</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_mask</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath6kl_dbg_dump</span><span class="p">);</span>

<span class="cp">#define REG_OUTPUT_LEN_PER_LINE	25</span>
<span class="cp">#define REGTYPE_STR_LEN		100</span>

<span class="k">struct</span> <span class="n">ath6kl_diag_reg_info</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_end</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reg_info</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath6kl_diag_reg_info</span> <span class="n">diag_reg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x20000</span><span class="p">,</span> <span class="mh">0x200fc</span><span class="p">,</span> <span class="s">&quot;General DMA and Rx registers&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x28000</span><span class="p">,</span> <span class="mh">0x28900</span><span class="p">,</span> <span class="s">&quot;MAC PCU register &amp; keycache&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x20800</span><span class="p">,</span> <span class="mh">0x20a40</span><span class="p">,</span> <span class="s">&quot;QCU&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x21000</span><span class="p">,</span> <span class="mh">0x212f0</span><span class="p">,</span> <span class="s">&quot;DCU&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x4000</span><span class="p">,</span>  <span class="mh">0x42e4</span><span class="p">,</span> <span class="s">&quot;RTC&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x540000</span><span class="p">,</span> <span class="mh">0x540000</span> <span class="o">+</span> <span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span> <span class="s">&quot;RAM&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x29800</span><span class="p">,</span> <span class="mh">0x2B210</span><span class="p">,</span> <span class="s">&quot;Base Band&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1C000</span><span class="p">,</span> <span class="mh">0x1C748</span><span class="p">,</span> <span class="s">&quot;Analog&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ath6kl_dump_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ath6kl_irq_proc_registers</span> <span class="o">*</span><span class="n">irq_proc_reg</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ath6kl_irq_enable_reg</span> <span class="o">*</span><span class="n">irq_enable_reg</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;&lt;------- Register Table --------&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_proc_reg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span>
			   <span class="s">&quot;Host Int status:           0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">irq_proc_reg</span><span class="o">-&gt;</span><span class="n">host_int_status</span><span class="p">);</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span>
			   <span class="s">&quot;CPU Int status:            0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">irq_proc_reg</span><span class="o">-&gt;</span><span class="n">cpu_int_status</span><span class="p">);</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span>
			   <span class="s">&quot;Error Int status:          0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">irq_proc_reg</span><span class="o">-&gt;</span><span class="n">error_int_status</span><span class="p">);</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span>
			   <span class="s">&quot;Counter Int status:        0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">irq_proc_reg</span><span class="o">-&gt;</span><span class="n">counter_int_status</span><span class="p">);</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span>
			   <span class="s">&quot;Mbox Frame:                0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">irq_proc_reg</span><span class="o">-&gt;</span><span class="n">mbox_frame</span><span class="p">);</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span>
			   <span class="s">&quot;Rx Lookahead Valid:        0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">irq_proc_reg</span><span class="o">-&gt;</span><span class="n">rx_lkahd_valid</span><span class="p">);</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span>
			   <span class="s">&quot;Rx Lookahead 0:            0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">irq_proc_reg</span><span class="o">-&gt;</span><span class="n">rx_lkahd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span>
			   <span class="s">&quot;Rx Lookahead 1:            0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">irq_proc_reg</span><span class="o">-&gt;</span><span class="n">rx_lkahd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mbox_info</span><span class="p">.</span><span class="n">gmbox_addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the target supports GMBOX hardware, dump some</span>
<span class="cm">			 * additional state.</span>
<span class="cm">			 */</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span>
				   <span class="s">&quot;GMBOX Host Int status 2:   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">irq_proc_reg</span><span class="o">-&gt;</span><span class="n">host_int_status2</span><span class="p">);</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span>
				   <span class="s">&quot;GMBOX RX Avail:            0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">irq_proc_reg</span><span class="o">-&gt;</span><span class="n">gmbox_rx_avail</span><span class="p">);</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span>
				   <span class="s">&quot;GMBOX lookahead alias 0:   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">irq_proc_reg</span><span class="o">-&gt;</span><span class="n">rx_gmbox_lkahd_alias</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span>
				   <span class="s">&quot;GMBOX lookahead alias 1:   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">irq_proc_reg</span><span class="o">-&gt;</span><span class="n">rx_gmbox_lkahd_alias</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_enable_reg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span>
			   <span class="s">&quot;Int status Enable:         0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">irq_enable_reg</span><span class="o">-&gt;</span><span class="n">int_status_en</span><span class="p">);</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;Counter Int status Enable: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">irq_enable_reg</span><span class="o">-&gt;</span><span class="n">cntr_int_status_en</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;&lt;-------------------------------&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_cred_dist</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_endpoint_credit_dist</span> <span class="o">*</span><span class="n">ep_dist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span>
		   <span class="s">&quot;--- endpoint: %d  svc_id: 0x%X ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot; dist_flags     : 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">dist_flags</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot; cred_norm      : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">cred_norm</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot; cred_min       : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">cred_min</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot; credits        : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot; cred_assngd    : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">cred_assngd</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot; seek_cred      : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">seek_cred</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot; cred_sz        : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">cred_sz</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot; cred_per_msg   : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">cred_per_msg</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot; cred_to_dist   : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">cred_to_dist</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot; txq_depth      : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">htc_ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">));</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span>
		   <span class="s">&quot;----------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* FIXME: move to htc.c */</span>
<span class="kt">void</span> <span class="nf">dump_cred_dist_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint_credit_dist</span> <span class="o">*</span><span class="n">ep_list</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">dump_cred_dist</span><span class="p">(</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span>
		   <span class="s">&quot;credit distribution total %d free %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">target</span><span class="o">-&gt;</span><span class="n">credit_info</span><span class="o">-&gt;</span><span class="n">total_avail_credits</span><span class="p">,</span>
		   <span class="n">target</span><span class="o">-&gt;</span><span class="n">credit_info</span><span class="o">-&gt;</span><span class="n">cur_free_credits</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_debug_war</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ath6kl_war</span> <span class="n">war</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">war</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATH6KL_WAR_INVALID_RATE</span>:
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">war_stats</span><span class="p">.</span><span class="n">invalid_rate</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">read_file_war_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret_cnt</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%25s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Workaround stats&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%25s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;=================&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Invalid rates&quot;</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">war_stats</span><span class="p">.</span><span class="n">invalid_rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">buf_len</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>

	<span class="n">ret_cnt</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_war_stats</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">read_file_war_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ath6kl_debug_fwlog_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_fwlog_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">slot_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ATH6KL_FWLOG_PAYLOAD_SIZE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">slot_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">slot</span><span class="p">)</span> <span class="o">+</span> <span class="n">ATH6KL_FWLOG_PAYLOAD_SIZE</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">slot_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_fwlog_slot</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">slot_len</span><span class="p">);</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Need to pad each record to fixed length ATH6KL_FWLOG_PAYLOAD_SIZE */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">payload</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATH6KL_FWLOG_PAYLOAD_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_completion</span><span class="p">);</span>

	<span class="cm">/* drop oldest entries */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">)</span> <span class="o">&gt;</span>
	       <span class="n">ATH6KL_FWLOG_MAX_ENTRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_fwlog_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_open</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_open</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_fwlog_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_open</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_fwlog_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret_cnt</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* read undelivered logs from firmware */</span>
	<span class="n">ath6kl_read_fwlogs</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* not enough space, put skb back and leave */</span>
			<span class="n">__skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* FIXME: what to do if len == 0? */</span>

	<span class="n">ret_cnt</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_fwlog</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ath6kl_fwlog_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">ath6kl_fwlog_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath6kl_fwlog_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_fwlog_block_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				       <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
				       <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret_cnt</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">not_copied</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we must init under queue lock */</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_completion</span><span class="p">);</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_completion</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* not enough space, put skb back and leave */</span>
			<span class="n">__skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* FIXME: what to do if len == 0? */</span>

	<span class="n">not_copied</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">not_copied</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_cnt</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ppos</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">ret_cnt</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_fwlog_block</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ath6kl_fwlog_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">ath6kl_fwlog_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath6kl_fwlog_block_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_fwlog_mask_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_fwlog_mask_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtou32_from_user</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_config_debug_module_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
						 <span class="n">ATH6KL_FWLOG_VALID_MASK</span><span class="p">,</span>
						 <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_fwlog_mask</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath6kl_fwlog_mask_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_fwlog_mask_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">read_file_tgt_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">target_stats</span> <span class="o">*</span><span class="n">tgt_stats</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">left</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret_cnt</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">tgt_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">target_stats</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">STATS_UPDATE_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_wmi_get_stats_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">left</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">,</span>
						<span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATS_UPDATE_PEND</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span> <span class="n">WMI_TIMEOUT</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%25s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Target Tx stats&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%25s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;=================&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Ucast packets&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tx_ucast_pkt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Bcast packets&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tx_bcast_pkt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Ucast byte&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tx_ucast_byte</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Bcast byte&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tx_bcast_byte</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Rts success cnt&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tx_rts_success_cnt</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
				 <span class="s">&quot;%18s %d %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;PER on ac&quot;</span><span class="p">,</span>
				 <span class="n">i</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tx_pkt_per_ac</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Error&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Fail count&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tx_fail_cnt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Retry count&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tx_retry_cnt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Multi retry cnt&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tx_mult_retry_cnt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Rts fail cnt&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tx_rts_fail_cnt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%25s %10llu</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;TKIP counter measure used&quot;</span><span class="p">,</span>
			 <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tkip_cnter_measures_invoked</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%25s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Target Rx stats&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%25s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;=================&quot;</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Ucast packets&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">rx_ucast_pkt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Ucast Rate&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">rx_ucast_rate</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Bcast packets&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">rx_bcast_pkt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Ucast byte&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">rx_ucast_byte</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Bcast byte&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">rx_bcast_byte</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Fragmented pkt&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">rx_frgment_pkt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Error&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;CRC Err&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">rx_crc_err</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Key chache miss&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">rx_key_cache_miss</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Decrypt Err&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">rx_decrypt_err</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Duplicate frame&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">rx_dupl_frame</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Tkip Mic failure&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tkip_local_mic_fail</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;TKIP format err&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">tkip_fmt_err</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;CCMP format Err&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">ccmp_fmt_err</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;CCMP Replay Err&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">ccmp_replays</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%25s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Misc Target stats&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%25s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;=================&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Beacon Miss count&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">cs_bmiss_cnt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Num Connects&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">cs_connect_cnt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Num disconnects&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">cs_discon_cnt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Beacon avg rssi&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">cs_ave_beacon_rssi</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;ARP pkt received&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">arp_received</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;ARP pkt matched&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">arp_matched</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%20s %10d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;ARP pkt replied&quot;</span><span class="p">,</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">arp_replied</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">buf_len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>

	<span class="n">ret_cnt</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_tgt_stats</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">read_file_tgt_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define print_credit_info(fmt_str, ep_list_field)		\</span>
<span class="cp">	(len += scnprintf(buf + len, buf_len - len, fmt_str,	\</span>
<span class="cp">			 ep_list-&gt;ep_list_field))</span>
<span class="cp">#define CREDIT_INFO_DISPLAY_STRING_LEN	200</span>
<span class="cp">#define CREDIT_INFO_LEN	128</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">read_file_credit_dist_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
					   <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
					   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint_credit_dist</span> <span class="o">*</span><span class="n">ep_list</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret_cnt</span><span class="p">;</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">CREDIT_INFO_DISPLAY_STRING_LEN</span> <span class="o">+</span>
		  <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">)</span> <span class="o">*</span> <span class="n">CREDIT_INFO_LEN</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%25s%5d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Total Avail Credits: &quot;</span><span class="p">,</span>
			 <span class="n">target</span><span class="o">-&gt;</span><span class="n">credit_info</span><span class="o">-&gt;</span><span class="n">total_avail_credits</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%25s%5d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;Free credits :&quot;</span><span class="p">,</span>
			 <span class="n">target</span><span class="o">-&gt;</span><span class="n">credit_info</span><span class="o">-&gt;</span><span class="n">cur_free_credits</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			 <span class="s">&quot; Epid  Flags    Cred_norm  Cred_min  Credits  Cred_assngd&quot;</span>
			 <span class="s">&quot;  Seek_cred  Cred_sz  Cred_per_msg  Cred_to_dist&quot;</span>
			 <span class="s">&quot;  qdepth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_credit_info</span><span class="p">(</span><span class="s">&quot;  %2d&quot;</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">);</span>
		<span class="n">print_credit_info</span><span class="p">(</span><span class="s">&quot;%10x&quot;</span><span class="p">,</span> <span class="n">dist_flags</span><span class="p">);</span>
		<span class="n">print_credit_info</span><span class="p">(</span><span class="s">&quot;%8d&quot;</span><span class="p">,</span> <span class="n">cred_norm</span><span class="p">);</span>
		<span class="n">print_credit_info</span><span class="p">(</span><span class="s">&quot;%9d&quot;</span><span class="p">,</span> <span class="n">cred_min</span><span class="p">);</span>
		<span class="n">print_credit_info</span><span class="p">(</span><span class="s">&quot;%9d&quot;</span><span class="p">,</span> <span class="n">credits</span><span class="p">);</span>
		<span class="n">print_credit_info</span><span class="p">(</span><span class="s">&quot;%10d&quot;</span><span class="p">,</span> <span class="n">cred_assngd</span><span class="p">);</span>
		<span class="n">print_credit_info</span><span class="p">(</span><span class="s">&quot;%13d&quot;</span><span class="p">,</span> <span class="n">seek_cred</span><span class="p">);</span>
		<span class="n">print_credit_info</span><span class="p">(</span><span class="s">&quot;%12d&quot;</span><span class="p">,</span> <span class="n">cred_sz</span><span class="p">);</span>
		<span class="n">print_credit_info</span><span class="p">(</span><span class="s">&quot;%9d&quot;</span><span class="p">,</span> <span class="n">cred_per_msg</span><span class="p">);</span>
		<span class="n">print_credit_info</span><span class="p">(</span><span class="s">&quot;%14d&quot;</span><span class="p">,</span> <span class="n">cred_to_dist</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%12d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep_list</span><span class="o">-&gt;</span><span class="n">htc_ep</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">buf_len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>

	<span class="n">ret_cnt</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_credit_dist_stats</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">read_file_credit_dist_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">print_endpoint_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint_stats</span> <span class="o">*</span><span class="n">ep_st</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">counter</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s:&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep_st</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ep_st</span><span class="p">;</span>
		<span class="n">counter</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep_st</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; %u&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">counter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_endpoint_stats_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
					  <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
					  <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret_cnt</span><span class="p">;</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_endpoint_stats</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span>
		<span class="p">(</span><span class="mi">25</span> <span class="o">+</span> <span class="n">ENDPOINT_MAX</span> <span class="o">*</span> <span class="mi">11</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="cp">#define EPSTAT(name)							\</span>
<span class="cp">	do {								\</span>
<span class="cp">		len = print_endpoint_stat(target, buf, buf_len, len,	\</span>
<span class="cp">					  offsetof(struct htc_endpoint_stats, \</span>
<span class="cp">						   name),		\</span>
<span class="cp">					  #name);			\</span>
<span class="cp">	} while (0)</span>

	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">cred_low_indicate</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">tx_issued</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">tx_pkt_bundled</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">tx_bundles</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">tx_dropped</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">tx_cred_rpt</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">cred_rpt_from_rx</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">cred_rpt_from_other</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">cred_rpt_ep0</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">cred_from_rx</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">cred_from_other</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">cred_from_ep0</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">cred_cosumd</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">cred_retnd</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">rx_pkts</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">rx_lkahds</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">rx_bundl</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">rx_bundle_lkahd</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">rx_bundle_from_hdr</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">rx_alloc_thresh_hit</span><span class="p">);</span>
	<span class="n">EPSTAT</span><span class="p">(</span><span class="n">rxalloc_thresh_byte</span><span class="p">);</span>
<span class="cp">#undef EPSTAT</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">buf_len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>

	<span class="n">ret_cnt</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_endpoint_stats_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
					   <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
					   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint_stats</span> <span class="o">*</span><span class="n">ep_st</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtou32_from_user</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep_st</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ep_st</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ep_st</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ep_st</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_endpoint_stats</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath6kl_endpoint_stats_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_endpoint_stats_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">ath6kl_get_num_reg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">diag_reg</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">n_reg</span> <span class="o">=</span> <span class="n">n_reg</span> <span class="o">+</span>
		     <span class="p">(</span><span class="n">diag_reg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_end</span> <span class="o">-</span> <span class="n">diag_reg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">n_reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_dbg_is_diag_reg_valid</span><span class="p">(</span><span class="n">u32</span> <span class="n">reg_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">diag_reg</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">&gt;=</span> <span class="n">diag_reg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_start</span> <span class="o">&amp;&amp;</span>
		    <span class="n">reg_addr</span> <span class="o">&lt;=</span> <span class="n">diag_reg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_end</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_regread_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">dbgfs_diag_reg</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">dbgfs_diag_reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
				 <span class="s">&quot;All diag registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_regread_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoul_from_user</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reg_addr</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ath6kl_dbg_is_diag_reg_valid</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">dbgfs_diag_reg</span> <span class="o">=</span> <span class="n">reg_addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_diag_reg_read</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath6kl_regread_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_regread_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_regdump_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">reg_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">reg_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Dump all the registers if no register is specified */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">dbgfs_diag_reg</span><span class="p">)</span>
		<span class="n">n_reg</span> <span class="o">=</span> <span class="n">ath6kl_get_num_reg</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="n">n_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">reg_len</span> <span class="o">=</span> <span class="n">n_reg</span> <span class="o">*</span> <span class="n">REG_OUTPUT_LEN_PER_LINE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_reg</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">reg_len</span> <span class="o">+=</span> <span class="n">REGTYPE_STR_LEN</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">reg_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_reg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">dbgfs_diag_reg</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_diag_read32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span>
				<span class="n">TARG_VTOP</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">,</span> <span class="n">addr</span><span class="p">),</span>
				<span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_reg_read</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">reg_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
				 <span class="s">&quot;0x%06x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reg_val</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">diag_reg</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">reg_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">diag_reg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_info</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">diag_reg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_start</span><span class="p">;</span>
		     <span class="n">addr</span> <span class="o">&lt;=</span> <span class="n">diag_reg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_diag_read32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span>
					<span class="n">TARG_VTOP</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">,</span> <span class="n">addr</span><span class="p">),</span>
					<span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail_reg_read</span><span class="p">;</span>

			<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">reg_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
					<span class="s">&quot;0x%06x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">addr</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reg_val</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_reg_read:</span>
	<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;Unable to read memory:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_regdump_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_regdump_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_reg_dump</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ath6kl_regdump_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath6kl_regdump_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">ath6kl_regdump_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_lrssi_roam_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lrssi_roam_threshold</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoul_from_user</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lrssi_roam_threshold</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">lrssi_roam_threshold</span> <span class="o">=</span> <span class="n">lrssi_roam_threshold</span><span class="p">;</span>

	<span class="n">ath6kl_wmi_set_roam_lrssi_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">lrssi_roam_threshold</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_lrssi_roam_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">lrssi_roam_threshold</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_lrssi_roam_threshold</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath6kl_lrssi_roam_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_lrssi_roam_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_regwrite_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				    <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;Addr: 0x%x Val: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">diag_reg_addr_wr</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">diag_reg_val_wr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_regwrite_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				     <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sptr</span><span class="p">,</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">sptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot;=&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_dbg_is_diag_reg_valid</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">sptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">diag_reg_addr_wr</span> <span class="o">=</span> <span class="n">reg_addr</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">diag_reg_val_wr</span> <span class="o">=</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_diag_write32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">diag_reg_addr_wr</span><span class="p">,</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">diag_reg_val_wr</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_diag_reg_write</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath6kl_regwrite_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_regwrite_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">ath6kl_debug_roam_tbl_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">wmi_target_roam_tbl</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">num_entries</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tbl</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">wmi_target_roam_tbl</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">num_entries</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tbl</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_bss_roam_info</span><span class="p">)</span> <span class="o">&gt;</span>
	    <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">roam_tbl</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">roam_tbl_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">roam_tbl</span><span class="p">);</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">roam_tbl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">roam_tbl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">roam_tbl</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">roam_tbl_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ROAM_TBL_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ROAM_TBL_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_roam_table_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">left</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_target_roam_tbl</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">num_entries</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">ROAM_TBL_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_roam_tbl_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">left</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">,</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ROAM_TBL_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">),</span> <span class="n">WMI_TIMEOUT</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">roam_tbl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_target_roam_tbl</span> <span class="o">*</span><span class="p">)</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">roam_tbl</span><span class="p">;</span>
	<span class="n">num_entries</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">);</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">num_entries</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			 <span class="s">&quot;roam_mode=%u</span><span class="se">\n\n</span><span class="s">&quot;</span>
			 <span class="s">&quot;# roam_util bssid rssi rssidt last_rssi util bias</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">roam_mode</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">wmi_bss_roam_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
				 <span class="s">&quot;%d %pM %d %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">a_sle32_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">roam_util</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rssidt</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_rssi</span><span class="p">,</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">util</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bias</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">buf_len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>

	<span class="n">ret_cnt</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_roam_table</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath6kl_roam_table_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_force_roam_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%02x:%02x:%02x:%02x:%02x:%02x&quot;</span><span class="p">,</span>
		   <span class="o">&amp;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
	    <span class="o">!=</span> <span class="n">ETH_ALEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_force_roam_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_force_roam</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_force_roam_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_roam_mode_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">wmi_roam_mode</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;default&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">WMI_DEFAULT_ROAM_MODE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;bssbias&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">WMI_HOST_BIAS_ROAM_MODE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;lock&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">WMI_LOCK_BSS_MODE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_roam_mode_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_roam_mode</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_roam_mode_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ath6kl_debug_set_keepalive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="n">keepalive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">keepalive</span> <span class="o">=</span> <span class="n">keepalive</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_keepalive_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				     <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">keepalive</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_keepalive_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtou8_from_user</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_keepalive_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_keepalive</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath6kl_keepalive_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_keepalive_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ath6kl_debug_set_disconnect_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">disc_timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_disconnect_timeout_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
					      <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
					      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">disc_timeout</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_disconnect_timeout_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
					       <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
					       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtou8_from_user</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_disctimeout_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_disconnect_timeout</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath6kl_disconnect_timeout_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_disconnect_timeout_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_create_qos_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
						<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">200</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sptr</span><span class="p">,</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_create_pstream_cmd</span> <span class="n">pstream</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val32</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val16</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">sptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou8</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pstream</span><span class="p">.</span><span class="n">user_pri</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou8</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pstream</span><span class="p">.</span><span class="n">traffic_direc</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou8</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pstream</span><span class="p">.</span><span class="n">traffic_class</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou8</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pstream</span><span class="p">.</span><span class="n">traffic_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou8</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pstream</span><span class="p">.</span><span class="n">voice_psc_cap</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">min_service_int</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val32</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">max_service_int</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val32</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">inactivity_int</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val32</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">suspension_int</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val32</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">service_start_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val32</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou8</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pstream</span><span class="p">.</span><span class="n">tsid</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou16</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">nominal_msdu</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">val16</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou16</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">max_msdu</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">val16</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">min_data_rate</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val32</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">mean_data_rate</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val32</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">peak_data_rate</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val32</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">max_burst_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val32</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">delay_bound</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val32</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">min_phy_rate</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val32</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">sba</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val32</span><span class="p">);</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pstream</span><span class="p">.</span><span class="n">medium_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val32</span><span class="p">);</span>

	<span class="n">pstream</span><span class="p">.</span><span class="n">nominal_phy</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pstream</span><span class="p">.</span><span class="n">min_phy_rate</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span>

	<span class="n">ath6kl_wmi_create_pstream_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pstream</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_create_qos</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_create_qos_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_delete_qos_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sptr</span><span class="p">,</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">traffic_class</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tsid</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">sptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou8</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">traffic_class</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou8</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsid</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ath6kl_wmi_delete_pstream_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
				      <span class="n">traffic_class</span><span class="p">,</span> <span class="n">tsid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_delete_qos</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_delete_qos_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_bgscan_int_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bgscan_int</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou16</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bgscan_int</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bgscan_int</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bgscan_int</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">bg_scan_period</span> <span class="o">=</span> <span class="n">bgscan_int</span><span class="p">;</span>

	<span class="n">ath6kl_wmi_scanparams_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bgscan_int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_bgscan_int</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_bgscan_int_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_listen_int_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">listen_interval</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou16</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">listen_interval</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">listen_interval</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">listen_interval</span> <span class="o">&gt;</span> <span class="mi">3000</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">listen_intvl_t</span> <span class="o">=</span> <span class="n">listen_interval</span><span class="p">;</span>
	<span class="n">ath6kl_wmi_listeninterval_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
				      <span class="n">vif</span><span class="o">-&gt;</span><span class="n">listen_intvl_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_listen_int_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">listen_intvl_t</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_listen_int</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath6kl_listen_int_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_listen_int_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ath6kl_power_params_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
						<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sptr</span><span class="p">,</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idle_period</span><span class="p">,</span> <span class="n">ps_poll_num</span><span class="p">,</span> <span class="n">dtim</span><span class="p">,</span>
		<span class="n">tx_wakeup</span><span class="p">,</span> <span class="n">num_tx</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">sptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou16</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idle_period</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou16</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps_poll_num</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou16</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtim</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou16</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_wakeup</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sptr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou16</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_tx</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ath6kl_wmi_pmparams_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idle_period</span><span class="p">,</span> <span class="n">ps_poll_num</span><span class="p">,</span>
				<span class="n">dtim</span><span class="p">,</span> <span class="n">tx_wakeup</span><span class="p">,</span> <span class="n">num_tx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_power_params</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath6kl_power_params_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ath6kl_debug_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_completion</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Actually we are lying here but don&#39;t know how to read the mask</span>
<span class="cm">	 * value from the firmware.</span>
<span class="cm">	 */</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialisation needs to happen in two stages as fwlog events can come</span>
<span class="cm"> * before cfg80211 is initialised, and debugfs depends on cfg80211</span>
<span class="cm"> * initialisation.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ath6kl_debug_init_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;ath6kl&quot;</span><span class="p">,</span>
					     <span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">debugfsdir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;tgt_stats&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_tgt_stats</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;credit_dist_stats&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_credit_dist_stats</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;endpoint_stats&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
			    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fops_endpoint_stats</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;fwlog&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_fwlog</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;fwlog_block&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_fwlog_block</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;fwlog_mask&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span>
			    <span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fops_fwlog_mask</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;reg_addr&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_diag_reg_read</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;reg_dump&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_reg_dump</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;lrssi_roam_threshold&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
			    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fops_lrssi_roam_threshold</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;reg_write&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
			    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fops_diag_reg_write</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;war_stats&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_war_stats</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;roam_table&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_roam_table</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;force_roam&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_force_roam</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;roam_mode&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_roam_mode</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;keepalive&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_keepalive</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;disconnect_timeout&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
			    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fops_disconnect_timeout</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;create_qos&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_create_qos</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;delete_qos&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_delete_qos</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;bgscan_interval&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span>
			    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fops_bgscan_int</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;listen_interval&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
			    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fops_listen_int</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;power_params&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">debugfs_phy</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fops_power_params</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_debug_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_queue</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">fwlog_completion</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">roam_tbl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
