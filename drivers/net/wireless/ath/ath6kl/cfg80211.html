<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath6kl › cfg80211.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>cfg80211.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004-2011 Atheros Communications Inc.</span>
<span class="cm"> * Copyright (c) 2011-2012 Qualcomm Atheros, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;cfg80211.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;hif-ops.h&quot;</span>
<span class="cp">#include &quot;testmode.h&quot;</span>

<span class="cp">#define RATETAB_ENT(_rate, _rateid, _flags) {   \</span>
<span class="cp">	.bitrate    = (_rate),                  \</span>
<span class="cp">	.flags      = (_flags),                 \</span>
<span class="cp">	.hw_value   = (_rateid),                \</span>
<span class="cp">}</span>

<span class="cp">#define CHAN2G(_channel, _freq, _flags) {   \</span>
<span class="cp">	.band           = IEEE80211_BAND_2GHZ,  \</span>
<span class="cp">	.hw_value       = (_channel),           \</span>
<span class="cp">	.center_freq    = (_freq),              \</span>
<span class="cp">	.flags          = (_flags),             \</span>
<span class="cp">	.max_antenna_gain   = 0,                \</span>
<span class="cp">	.max_power      = 30,                   \</span>
<span class="cp">}</span>

<span class="cp">#define CHAN5G(_channel, _flags) {		    \</span>
<span class="cp">	.band           = IEEE80211_BAND_5GHZ,      \</span>
<span class="cp">	.hw_value       = (_channel),               \</span>
<span class="cp">	.center_freq    = 5000 + (5 * (_channel)),  \</span>
<span class="cp">	.flags          = (_flags),                 \</span>
<span class="cp">	.max_antenna_gain   = 0,                    \</span>
<span class="cp">	.max_power      = 30,                       \</span>
<span class="cp">}</span>

<span class="cp">#define DEFAULT_BG_SCAN_PERIOD 60</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">ath6kl_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">540</span><span class="p">,</span> <span class="mh">0x800</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define ath6kl_a_rates     (ath6kl_rates + 4)</span>
<span class="cp">#define ath6kl_a_rates_size    8</span>
<span class="cp">#define ath6kl_g_rates     (ath6kl_rates + 0)</span>
<span class="cp">#define ath6kl_g_rates_size    12</span>

<span class="cp">#define ath6kl_g_htcap IEEE80211_HT_CAP_SGI_20</span>
<span class="cp">#define ath6kl_a_htcap (IEEE80211_HT_CAP_SUP_WIDTH_20_40 | \</span>
<span class="cp">			IEEE80211_HT_CAP_SGI_20		 | \</span>
<span class="cp">			IEEE80211_HT_CAP_SGI_40)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">ath6kl_2ghz_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2412</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2417</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2422</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2427</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2432</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2437</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2442</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2447</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2452</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2457</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">2462</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">2467</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">2472</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">2484</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">ath6kl_5ghz_a_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">44</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">46</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">56</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">104</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">108</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">112</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">116</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">124</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">136</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">149</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">153</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">157</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">161</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">165</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">184</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">188</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">196</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">208</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">212</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">216</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">ath6kl_band_2ghz</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath6kl_2ghz_channels</span><span class="p">),</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">ath6kl_2ghz_channels</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ath6kl_g_rates_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">ath6kl_g_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">ath6kl_g_htcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">ath6kl_band_5ghz</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath6kl_5ghz_a_channels</span><span class="p">),</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">ath6kl_5ghz_a_channels</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ath6kl_a_rates_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">ath6kl_a_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">ath6kl_a_htcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define CCKM_KRK_CIPHER_SUITE 0x004096ff </span><span class="cm">/* use for KRK */</span><span class="cp"></span>

<span class="cm">/* returns true if scheduled scan was stopped */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">__ath6kl_cfg80211_sscan_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ATH6KL_STATE_SCHED_SCAN</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">sched_scan_timer</span><span class="p">);</span>

	<span class="n">ath6kl_wmi_set_host_sleep_mode_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					   <span class="n">ATH6KL_HOST_MODE_AWAKE</span><span class="p">);</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ATH6KL_STATE_ON</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_cfg80211_sscan_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">stopped</span><span class="p">;</span>

	<span class="n">stopped</span> <span class="o">=</span> <span class="n">__ath6kl_cfg80211_sscan_stop</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stopped</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cfg80211_sched_scan_stopped</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_set_wpa_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">nl80211_wpa_versions</span> <span class="n">wpa_version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wpa_version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wpa_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">NONE_AUTH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wpa_version</span> <span class="o">&amp;</span> <span class="n">NL80211_WPA_VERSION_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WPA2_AUTH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wpa_version</span> <span class="o">&amp;</span> <span class="n">NL80211_WPA_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WPA_AUTH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;%s: %u not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wpa_version</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_set_auth_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">nl80211_auth_type</span> <span class="n">auth_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">auth_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_AUTHTYPE_OPEN_SYSTEM</span>:
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">dot11_auth_mode</span> <span class="o">=</span> <span class="n">OPEN_AUTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_AUTHTYPE_SHARED_KEY</span>:
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">dot11_auth_mode</span> <span class="o">=</span> <span class="n">SHARED_AUTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_AUTHTYPE_NETWORK_EAP</span>:
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">dot11_auth_mode</span> <span class="o">=</span> <span class="n">LEAP_AUTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NL80211_AUTHTYPE_AUTOMATIC</span>:
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">dot11_auth_mode</span> <span class="o">=</span> <span class="n">OPEN_AUTH</span> <span class="o">|</span> <span class="n">SHARED_AUTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;%s: 0x%x not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_set_cipher</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cipher</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ucast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ar_cipher</span> <span class="o">=</span> <span class="n">ucast</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">grp_crypto</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ar_cipher_len</span> <span class="o">=</span> <span class="n">ucast</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto_len</span> <span class="o">:</span>
		<span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">grp_crypto_len</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: cipher 0x%x, ucast %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">cipher</span><span class="p">,</span> <span class="n">ucast</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* our own hack to use value 0 as no crypto used */</span>
		<span class="o">*</span><span class="n">ar_cipher</span> <span class="o">=</span> <span class="n">NONE_CRYPT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ar_cipher_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
		<span class="o">*</span><span class="n">ar_cipher</span> <span class="o">=</span> <span class="n">WEP_CRYPT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ar_cipher_len</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="o">*</span><span class="n">ar_cipher</span> <span class="o">=</span> <span class="n">WEP_CRYPT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ar_cipher_len</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="o">*</span><span class="n">ar_cipher</span> <span class="o">=</span> <span class="n">TKIP_CRYPT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ar_cipher_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="o">*</span><span class="n">ar_cipher</span> <span class="o">=</span> <span class="n">AES_CRYPT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ar_cipher_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_SMS4</span>:
		<span class="o">*</span><span class="n">ar_cipher</span> <span class="o">=</span> <span class="n">WAPI_CRYPT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ar_cipher_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;cipher 0x%x not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cipher</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_set_key_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u32</span> <span class="n">key_mgmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">key_mgmt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_mgmt</span> <span class="o">==</span> <span class="n">WLAN_AKM_SUITE_PSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WPA_AUTH</span><span class="p">)</span>
			<span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WPA_PSK_AUTH</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WPA2_AUTH</span><span class="p">)</span>
			<span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WPA2_PSK_AUTH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key_mgmt</span> <span class="o">==</span> <span class="mh">0x00409600</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WPA_AUTH</span><span class="p">)</span>
			<span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WPA_AUTH_CCKM</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WPA2_AUTH</span><span class="p">)</span>
			<span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WPA2_AUTH_CCKM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key_mgmt</span> <span class="o">!=</span> <span class="n">WLAN_AKM_SUITE_8021X</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">NONE_AUTH</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;wmi is not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLAN_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;wlan disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_is_wpa_ie</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_EID_WPA</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
		<span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">&amp;&amp;</span>
		<span class="n">pos</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf2</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_is_rsn_ie</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_EID_RSN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_is_wps_ie</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_EID_VENDOR_SPECIFIC</span> <span class="o">&amp;&amp;</span>
		<span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
		<span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf2</span> <span class="o">&amp;&amp;</span>
		<span class="n">pos</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_set_assoc_req_ies</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ies</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">ies_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear previously set flag</span>
<span class="cm">	 */</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">connect_ctrl_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CONNECT_WPS_FLAG</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Filter out RSN/WPA IE(s)</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ies</span> <span class="o">&amp;&amp;</span> <span class="n">ies_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ies_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ies</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">ies</span> <span class="o">+</span> <span class="n">ies_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ies</span> <span class="o">+</span> <span class="n">ies_len</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ath6kl_is_wpa_ie</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">||</span> <span class="n">ath6kl_is_rsn_ie</span><span class="p">(</span><span class="n">pos</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_is_wps_ie</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
				<span class="n">ar</span><span class="o">-&gt;</span><span class="n">connect_ctrl_flags</span> <span class="o">|=</span> <span class="n">CONNECT_WPS_FLAG</span><span class="p">;</span>

			<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_appie_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
				       <span class="n">WMI_FRAME_ASSOC_REQ</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_nliftype_to_drv_iftype</span><span class="p">(</span><span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">nw_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="o">*</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">INFRA_NETWORK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="o">*</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">ADHOC_NETWORK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="o">*</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">AP_NETWORK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span>:
		<span class="o">*</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">INFRA_NETWORK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_GO</span>:
		<span class="o">*</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">AP_NETWORK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;invalid interface type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_is_valid_iftype</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="o">*</span><span class="n">if_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">nw_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_nliftype_to_drv_iftype</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">nw_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ibss_if_active</span> <span class="o">||</span> <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">num_vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">||</span>
	    <span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">avail_idx_map</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">if_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span> <span class="o">||</span>
	    <span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">max_norm_iface</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">avail_idx_map</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">if_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_is_tx_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">ath6kl_wmi_get_control_ep</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="o">*</span><span class="n">sme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nw_subtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">p2p</span><span class="p">)</span> <span class="o">?</span> <span class="n">SUBTYPE_P2PDEV</span> <span class="o">:</span> <span class="n">SUBTYPE_NONE</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">interval</span><span class="p">;</span>

	<span class="n">ath6kl_cfg80211_sscan_disable</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">sme_state</span> <span class="o">=</span> <span class="n">SME_CONNECTING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DESTROY_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;destroy in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SKIP_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&amp;&amp;</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span> <span class="o">&amp;&amp;</span> <span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;SkipScan: channel or bssid invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;busy, couldn&#39;t get access</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DESTROY_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;busy, destroy in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">ath6kl_wmi_get_control_ep</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">)])</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * sleep until the command queue drains</span>
<span class="cm">		 */</span>
		<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">,</span>
						 <span class="n">ath6kl_is_tx_pending</span><span class="p">(</span><span class="n">ar</span><span class="p">),</span>
						 <span class="n">WMI_TIMEOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;cmd queue drain timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_set_assoc_req_ies</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">ie</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ie_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">connect_ctrl_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CONNECT_WPS_FLAG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">reconnect_flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_wmi_reconnect_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						  <span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">,</span>
						  <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ch_hint</span><span class="p">);</span>

		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;wmi_reconnect_cmd failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_disconnect</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">));</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ch_hint</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">));</span>

	<span class="n">ath6kl_set_wpa_version</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">wpa_versions</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_set_auth_type</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">n_ciphers_pairwise</span><span class="p">)</span>
		<span class="n">ath6kl_set_cipher</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">ciphers_pairwise</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ath6kl_set_cipher</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">ath6kl_set_cipher</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">n_akm_suites</span><span class="p">)</span>
		<span class="n">ath6kl_set_key_mgmt</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">akm_suites</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">NONE_AUTH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto</span> <span class="o">==</span> <span class="n">WEP_CRYPT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ath6kl_key</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_idx</span> <span class="o">&gt;</span> <span class="n">WMI_MAX_KEY_INDEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;key index %d out of bounds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">key</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">];</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto</span><span class="p">;</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">def_txkey_index</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">;</span>

		<span class="n">ath6kl_wmi_addkey_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">,</span>
				      <span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto</span><span class="p">,</span>
				      <span class="n">GROUP_USAGE</span> <span class="o">|</span> <span class="n">TX_USAGE</span><span class="p">,</span>
				      <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span>
				      <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">KEY_OP_INIT_VAL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				      <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">usr_bss_filter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CLEAR_BSSFILTER_ON_BEACON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_wmi_bssfilter_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					     <span class="n">ALL_BSS_FILTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;couldn&#39;t set bss filtering</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span>
		<span class="n">nw_subtype</span> <span class="o">=</span> <span class="n">SUBTYPE_P2PCLIENT</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
		   <span class="s">&quot;%s: connect called with authmode %d dot11 auth %d&quot;</span>
		   <span class="s">&quot; PW crypto %d PW crypto len %d GRP crypto %d&quot;</span>
		   <span class="s">&quot; GRP crypto len %d channel hint %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">dot11_auth_mode</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto</span><span class="p">,</span>
		   <span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto_len</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">grp_crypto</span><span class="p">,</span>
		   <span class="n">vif</span><span class="o">-&gt;</span><span class="n">grp_crypto_len</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ch_hint</span><span class="p">);</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">reconnect_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">INFRA_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">interval</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">listen_intvl_t</span><span class="p">,</span>
				 <span class="n">ATH6KL_MAX_WOW_LISTEN_INTL</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_wmi_listeninterval_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						       <span class="n">interval</span><span class="p">,</span>
						       <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;couldn&#39;t set listen intervel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_wmi_connect_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">dot11_auth_mode</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto_len</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">grp_crypto</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">grp_crypto_len</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ch_hint</span><span class="p">,</span>
					<span class="n">ar</span><span class="o">-&gt;</span><span class="n">connect_ctrl_flags</span><span class="p">,</span> <span class="n">nw_subtype</span><span class="p">);</span>

	<span class="cm">/* disable background scan if period is 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">bg_scan_period</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sme</span><span class="o">-&gt;</span><span class="n">bg_scan_period</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="cm">/* configure default value if not specified */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">bg_scan_period</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">sme</span><span class="o">-&gt;</span><span class="n">bg_scan_period</span> <span class="o">=</span> <span class="n">DEFAULT_BG_SCAN_PERIOD</span><span class="p">;</span>

	<span class="n">ath6kl_wmi_scanparams_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">sme</span><span class="o">-&gt;</span><span class="n">bg_scan_period</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">));</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;invalid request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;ath6kl_wmi_connect_cmd failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">connect_ctrl_flags</span> <span class="o">&amp;</span> <span class="n">CONNECT_DO_WPA_OFFLOAD</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WPA_PSK_AUTH</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WPA2_PSK_AUTH</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">disconnect_timer</span><span class="p">,</span>
			  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">DISCON_TIMER_INTVAL</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">connect_ctrl_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CONNECT_DO_WPA_OFFLOAD</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span>
<span class="nf">ath6kl_add_bss_if_needed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">network_type</span> <span class="n">nw_type</span><span class="p">,</span>
			 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
			 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">beacon_ie</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">beacon_ie_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cap_mask</span><span class="p">,</span> <span class="n">cap_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nw_type</span> <span class="o">&amp;</span> <span class="n">ADHOC_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cap_mask</span> <span class="o">=</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">;</span>
		<span class="n">cap_val</span> <span class="o">=</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cap_mask</span> <span class="o">=</span> <span class="n">WLAN_CAPABILITY_ESS</span><span class="p">;</span>
		<span class="n">cap_val</span> <span class="o">=</span> <span class="n">WLAN_CAPABILITY_ESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bss</span> <span class="o">=</span> <span class="n">cfg80211_get_bss</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span>
			       <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">,</span>
			       <span class="n">cap_mask</span><span class="p">,</span> <span class="n">cap_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Since cfg80211 may not yet know about the BSS,</span>
<span class="cm">		 * generate a partial entry until the first BSS info</span>
<span class="cm">		 * event becomes available.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Prepend SSID element since it is not included in the Beacon</span>
<span class="cm">		 * IEs from the target.</span>
<span class="cm">		 */</span>
		<span class="n">ie</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">+</span> <span class="n">beacon_ie_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ie</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ie</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span>
		<span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">,</span> <span class="n">beacon_ie</span><span class="p">,</span> <span class="n">beacon_ie_len</span><span class="p">);</span>
		<span class="n">bss</span> <span class="o">=</span> <span class="n">cfg80211_inform_bss</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
					  <span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cap_val</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span>
					  <span class="n">ie</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">+</span> <span class="n">beacon_ie_len</span><span class="p">,</span>
					  <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="p">)</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
				   <span class="s">&quot;added bss %pM to cfg80211</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ie</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;cfg80211 already has a bss</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bss</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_cfg80211_connect_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">channel</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">listen_intvl</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">beacon_intvl</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">network_type</span> <span class="n">nw_type</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">beacon_ie_len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">assoc_req_len</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">assoc_resp_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">assoc_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>

	<span class="cm">/* capinfo + listen interval */</span>
	<span class="n">u8</span> <span class="n">assoc_req_ie_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

	<span class="cm">/* capinfo + status code +  associd */</span>
	<span class="n">u8</span> <span class="n">assoc_resp_ie_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

	<span class="n">u8</span> <span class="o">*</span><span class="n">assoc_req_ie</span> <span class="o">=</span> <span class="n">assoc_info</span> <span class="o">+</span> <span class="n">beacon_ie_len</span> <span class="o">+</span> <span class="n">assoc_req_ie_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">assoc_resp_ie</span> <span class="o">=</span> <span class="n">assoc_info</span> <span class="o">+</span> <span class="n">beacon_ie_len</span> <span class="o">+</span> <span class="n">assoc_req_len</span> <span class="o">+</span>
	    <span class="n">assoc_resp_ie_offset</span><span class="p">;</span>

	<span class="n">assoc_req_len</span> <span class="o">-=</span> <span class="n">assoc_req_ie_offset</span><span class="p">;</span>
	<span class="n">assoc_resp_len</span> <span class="o">-=</span> <span class="n">assoc_resp_ie_offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Store Beacon interval here; DTIM period will be available only once</span>
<span class="cm">	 * a Beacon frame from the AP is seen.</span>
<span class="cm">	 */</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">assoc_bss_beacon_int</span> <span class="o">=</span> <span class="n">beacon_intvl</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DTIM_PERIOD_AVAIL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nw_type</span> <span class="o">&amp;</span> <span class="n">ADHOC_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
				   <span class="s">&quot;%s: ath6k not in ibss mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nw_type</span> <span class="o">&amp;</span> <span class="n">INFRA_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
				   <span class="s">&quot;%s: ath6k not in station mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">bss</span> <span class="o">=</span> <span class="n">ath6kl_add_bss_if_needed</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">nw_type</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
				       <span class="n">assoc_info</span><span class="p">,</span> <span class="n">beacon_ie_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;could not add cfg80211 bss entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nw_type</span> <span class="o">&amp;</span> <span class="n">ADHOC_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;ad-hoc %s selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">nw_type</span> <span class="o">&amp;</span> <span class="n">ADHOC_CREATOR</span> <span class="o">?</span> <span class="s">&quot;creator&quot;</span> <span class="o">:</span> <span class="s">&quot;joiner&quot;</span><span class="p">);</span>
		<span class="n">cfg80211_ibss_joined</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">cfg80211_put_bss</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">sme_state</span> <span class="o">==</span> <span class="n">SME_CONNECTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* inform connect result to cfg80211 */</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">sme_state</span> <span class="o">=</span> <span class="n">SME_CONNECTED</span><span class="p">;</span>
		<span class="n">cfg80211_connect_result</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span>
					<span class="n">assoc_req_ie</span><span class="p">,</span> <span class="n">assoc_req_len</span><span class="p">,</span>
					<span class="n">assoc_resp_ie</span><span class="p">,</span> <span class="n">assoc_resp_len</span><span class="p">,</span>
					<span class="n">WLAN_STATUS_SUCCESS</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">cfg80211_put_bss</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">sme_state</span> <span class="o">==</span> <span class="n">SME_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* inform roam event to cfg80211 */</span>
		<span class="n">cfg80211_roamed_bss</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">bss</span><span class="p">,</span> <span class="n">assoc_req_ie</span><span class="p">,</span> <span class="n">assoc_req_len</span><span class="p">,</span>
				    <span class="n">assoc_resp_ie</span><span class="p">,</span> <span class="n">assoc_resp_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reason_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: reason=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">reason_code</span><span class="p">);</span>

	<span class="n">ath6kl_cfg80211_sscan_disable</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DESTROY_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;busy, destroy in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;busy, couldn&#39;t get access</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">reconnect_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ath6kl_disconnect</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">));</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SKIP_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">));</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">sme_state</span> <span class="o">=</span> <span class="n">SME_DISCONNECTED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_cfg80211_disconnect_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reason</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">assoc_resp_len</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="o">*</span><span class="n">assoc_info</span><span class="p">,</span> <span class="n">u16</span> <span class="n">proto_reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg80211_scan_done</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">&amp;</span> <span class="n">ADHOC_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
				   <span class="s">&quot;%s: ath6k not in ibss mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">cfg80211_ibss_joined</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">&amp;</span> <span class="n">INFRA_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">iftype</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
				   <span class="s">&quot;%s: ath6k not in station mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send a disconnect command to target when a disconnect event is</span>
<span class="cm">	 * received with reason code other than 3 (DISCONNECT_CMD - disconnect</span>
<span class="cm">	 * request from host) to make the firmware stop trying to connect even</span>
<span class="cm">	 * after giving disconnect event. There will be one more disconnect</span>
<span class="cm">	 * event for this disconnect command with reason code DISCONNECT_CMD</span>
<span class="cm">	 * which will be notified to cfg80211.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">DISCONNECT_CMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_wmi_disconnect_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">sme_state</span> <span class="o">==</span> <span class="n">SME_CONNECTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg80211_connect_result</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					<span class="n">bssid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">WLAN_STATUS_UNSPECIFIED_FAILURE</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">sme_state</span> <span class="o">==</span> <span class="n">SME_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg80211_disconnected</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span>
				      <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">sme_state</span> <span class="o">=</span> <span class="n">SME_DISCONNECTED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_set_probed_ssids</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cfg80211_ssid</span> <span class="o">*</span><span class="n">ssids</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_ssids</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_ssids</span> <span class="o">&gt;</span> <span class="n">MAX_PROBED_SSID_INDEX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_ssids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_wmi_probedssid_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					  <span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span> <span class="o">?</span>
					  <span class="n">SPECIFIC_SSID_FLAG</span> <span class="o">:</span> <span class="n">ANY_SSID_FLAG</span><span class="p">,</span>
					  <span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">,</span>
					  <span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure no old entries are left behind */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">n_ssids</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_PROBED_SSID_INDEX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_wmi_probedssid_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					  <span class="n">DISABLE_SSID_FLAG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">s8</span> <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">channels</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">force_fg_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ath6kl_cfg80211_sscan_disable</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">usr_bss_filter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CLEAR_BSSFILTER_ON_BEACON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_bssfilter_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					       <span class="n">ALL_BSS_FILTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;couldn&#39;t set bss filtering</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_set_probed_ssids</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">,</span>
				      <span class="n">request</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* this also clears IE in fw if it&#39;s not set */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_appie_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
				       <span class="n">WMI_FRAME_PROBE_REQ</span><span class="p">,</span>
				       <span class="n">request</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to set Probe Request appie for scan&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Scan only the requested channels if the request specifies a set of</span>
<span class="cm">	 * channels. If the list is longer than the target supports, do not</span>
<span class="cm">	 * configure the list and instead, scan all available channels.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">request</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">&lt;=</span> <span class="n">WMI_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">n_channels</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span>

		<span class="n">channels</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">n_channels</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;failed to set scan channels, scan all channels&quot;</span><span class="p">);</span>
			<span class="n">n_channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">force_fg_scan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATH6KL_FW_CAPABILITY_STA_P2PDEV_DUPLEX</span><span class="p">,</span>
		     <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_capabilities</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If capable of doing P2P mgmt operations using</span>
<span class="cm">		 * station interface, send additional information like</span>
<span class="cm">		 * supported rates to advertise and xmit rates for</span>
<span class="cm">		 * probe requests</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_beginscan_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						<span class="n">WMI_LONG_SCAN</span><span class="p">,</span> <span class="n">force_fg_scan</span><span class="p">,</span>
						<span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">ATH6KL_FG_SCAN_INTERVAL</span><span class="p">,</span>
						<span class="n">n_channels</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span>
						<span class="n">request</span><span class="o">-&gt;</span><span class="n">no_cck</span><span class="p">,</span>
						<span class="n">request</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_startscan_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						<span class="n">WMI_LONG_SCAN</span><span class="p">,</span> <span class="n">force_fg_scan</span><span class="p">,</span>
						<span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">ATH6KL_FG_SCAN_INTERVAL</span><span class="p">,</span>
						<span class="n">n_channels</span><span class="p">,</span> <span class="n">channels</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;wmi_startscan_cmd failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">channels</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_cfg80211_scan_complete_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">bool</span> <span class="n">aborted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: status%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">aborted</span> <span class="o">?</span> <span class="s">&quot; aborted&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aborted</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">n_ssids</span> <span class="o">&amp;&amp;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_wmi_probedssid_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						  <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DISABLE_SSID_FLAG</span><span class="p">,</span>
						  <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">cfg80211_scan_done</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="p">,</span> <span class="n">aborted</span><span class="p">);</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_cfg80211_ch_switch_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">wmi_phy_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
		   <span class="s">&quot;channel switch notify nw_type %d freq %d mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WMI_11G_HT20</span><span class="p">)</span> <span class="o">?</span> <span class="n">NL80211_CHAN_HT20</span> <span class="o">:</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">;</span>

	<span class="n">cfg80211_ch_switch_notify</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_add_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span>
				   <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">key_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_key</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">seq_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key_usage</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">CCKM_KRK_CIPHER_SUITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">!=</span> <span class="n">WMI_KRK_LEN</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_add_krk_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					      <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span> <span class="o">&gt;</span> <span class="n">WMI_MAX_KEY_INDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
			   <span class="s">&quot;%s: key index %d out of bounds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">key_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">key</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">key_index</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_key</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pairwise</span><span class="p">)</span>
		<span class="n">key_usage</span> <span class="o">=</span> <span class="n">PAIRWISE_USAGE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">key_usage</span> <span class="o">=</span> <span class="n">GROUP_USAGE</span><span class="p">;</span>

	<span class="n">seq_len</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_SMS4</span> <span class="o">&amp;&amp;</span>
	    <span class="n">seq_len</span> <span class="o">&gt;</span> <span class="n">ATH6KL_KEY_SEQ_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Only first half of the WPI PN is configured */</span>
		<span class="n">seq_len</span> <span class="o">=</span> <span class="n">ATH6KL_KEY_SEQ_LEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="n">WLAN_MAX_KEY_LEN</span> <span class="o">||</span>
	    <span class="n">seq_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">seq_len</span> <span class="o">=</span> <span class="n">seq_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">seq_len</span><span class="p">);</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">WEP_CRYPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">TKIP_CRYPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">AES_CRYPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_SMS4</span>:
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">WAPI_CRYPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WPA_PSK_AUTH</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WPA2_PSK_AUTH</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">key_usage</span> <span class="o">&amp;</span> <span class="n">GROUP_USAGE</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">disconnect_timer</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
		   <span class="s">&quot;%s: index %d, key_len %d, key_type 0x%x, key_usage 0x%x, seq_len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">key_type</span><span class="p">,</span>
		   <span class="n">key_usage</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">seq_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pairwise</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">TKIP_CRYPT</span> <span class="o">||</span> <span class="n">key_type</span> <span class="o">==</span> <span class="n">AES_CRYPT</span> <span class="o">||</span>
	     <span class="n">key_type</span> <span class="o">==</span> <span class="n">WAPI_CRYPT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ap_mode_bkey</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ap_mode_bkey</span><span class="p">.</span><span class="n">key_index</span> <span class="o">=</span> <span class="n">key_index</span><span class="p">;</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ap_mode_bkey</span><span class="p">.</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">key_type</span><span class="p">;</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ap_mode_bkey</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ap_mode_bkey</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
				   <span class="s">&quot;Delay initial group key configuration until AP mode has been started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * The key will be set in ath6kl_connect_ap_mode() once</span>
<span class="cm">			 * the connected event is received from the target.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_mode</span> <span class="o">==</span> <span class="n">AP_NETWORK</span> <span class="o">&amp;&amp;</span> <span class="n">key_type</span> <span class="o">==</span> <span class="n">WEP_CRYPT</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Store the key locally so that it can be re-configured after</span>
<span class="cm">		 * the AP mode has properly started</span>
<span class="cm">		 * (ath6kl_install_statioc_wep_keys).</span>
<span class="cm">		 */</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
			   <span class="s">&quot;Delay WEP key configuration until AP mode has been started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">wep_key_list</span><span class="p">[</span><span class="n">key_index</span><span class="p">].</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wep_key_list</span><span class="p">[</span><span class="n">key_index</span><span class="p">].</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
		       <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_addkey_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">key_index</span><span class="p">,</span>
				     <span class="n">key_type</span><span class="p">,</span> <span class="n">key_usage</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span>
				     <span class="n">key</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
				     <span class="n">KEY_OP_INIT_VAL</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">SYNC_BOTH_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_del_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span>
				   <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span> <span class="o">&gt;</span> <span class="n">WMI_MAX_KEY_INDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
			   <span class="s">&quot;%s: key index %d out of bounds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">key_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">key_index</span><span class="p">].</span><span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
			   <span class="s">&quot;%s: index %d is empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">key_index</span><span class="p">].</span><span class="n">key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_deletekey_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_get_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span>
				   <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">key_params</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_key</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">key_params</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span> <span class="o">&gt;</span> <span class="n">WMI_MAX_KEY_INDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
			   <span class="s">&quot;%s: key index %d out of bounds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">key_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">key</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">key_index</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
	<span class="n">params</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">seq_len</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">seq_len</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>

	<span class="n">callback</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_set_default_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
					   <span class="n">u8</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">unicast</span><span class="p">,</span>
					   <span class="n">bool</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_key</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key_usage</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">crypto_type</span> <span class="n">key_type</span> <span class="o">=</span> <span class="n">NONE_CRYPT</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span> <span class="o">&gt;</span> <span class="n">WMI_MAX_KEY_INDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
			   <span class="s">&quot;%s: key index %d out of bounds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">key_index</span><span class="p">].</span><span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: invalid key index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">def_txkey_index</span> <span class="o">=</span> <span class="n">key_index</span><span class="p">;</span>
	<span class="n">key</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">def_txkey_index</span><span class="p">];</span>
	<span class="n">key_usage</span> <span class="o">=</span> <span class="n">GROUP_USAGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto</span> <span class="o">==</span> <span class="n">WEP_CRYPT</span><span class="p">)</span>
		<span class="n">key_usage</span> <span class="o">|=</span> <span class="n">TX_USAGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unicast</span><span class="p">)</span>
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">multicast</span><span class="p">)</span>
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">grp_crypto</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_mode</span> <span class="o">==</span> <span class="n">AP_NETWORK</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Delay until AP mode has been started */</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_addkey_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
				     <span class="n">vif</span><span class="o">-&gt;</span><span class="n">def_txkey_index</span><span class="p">,</span>
				     <span class="n">key_type</span><span class="p">,</span> <span class="n">key_usage</span><span class="p">,</span>
				     <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">seq_len</span><span class="p">,</span>
				     <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
				     <span class="n">KEY_OP_INIT_VAL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				     <span class="n">SYNC_BOTH_WMIFLAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_cfg80211_tkip_micerr_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="n">keyid</span><span class="p">,</span>
				       <span class="n">bool</span> <span class="n">ismcast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
		   <span class="s">&quot;%s: keyid %d, ismcast %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">keyid</span><span class="p">,</span> <span class="n">ismcast</span><span class="p">);</span>

	<span class="n">cfg80211_michael_mic_failure</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">ismcast</span> <span class="o">?</span> <span class="n">NL80211_KEYTYPE_GROUP</span> <span class="o">:</span>
				      <span class="n">NL80211_KEYTYPE_PAIRWISE</span><span class="p">),</span> <span class="n">keyid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				     <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_set_wiphy_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="p">)</span><span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: changed 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">changed</span><span class="p">);</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_RTS_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_rts_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;ath6kl_wmi_set_rts_cmd failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The type nl80211_tx_power_setting replaces the following</span>
<span class="cm"> * data type from 2.6.36 onwards</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_set_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">nl80211_tx_power_setting</span> <span class="n">type</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">mbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="p">)</span><span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dbm</span> <span class="o">=</span> <span class="n">MBM_TO_DBM</span><span class="p">(</span><span class="n">mbm</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: type 0x%x, dbm %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">type</span><span class="p">,</span> <span class="n">dbm</span><span class="p">);</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_TX_POWER_AUTOMATIC</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_TX_POWER_LIMITED</span>:
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pwr</span> <span class="o">=</span> <span class="n">dbm</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: type 0x%x not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_wmi_set_tx_pwr_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">dbm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_get_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="p">)</span><span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pwr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_wmi_get_tx_pwr_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;ath6kl_wmi_get_tx_pwr_cmd failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pwr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
						 <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;target did not respond</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">dbm</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pwr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_set_power_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">bool</span> <span class="n">pmgmt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wmi_power_mode_cmd</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: pmgmt %d, timeout %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">pmgmt</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmgmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: max perf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">pwr_mode</span> <span class="o">=</span> <span class="n">REC_POWER</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: rec power</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">mode</span><span class="p">.</span><span class="n">pwr_mode</span> <span class="o">=</span> <span class="n">MAX_PERF_POWER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_wmi_powermode_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
				     <span class="n">mode</span><span class="p">.</span><span class="n">pwr_mode</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;wmi_powermode_cmd failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">ath6kl_cfg80211_add_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
						    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
						    <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">,</span>
						    <span class="n">u32</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">vif_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">nw_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">num_vif</span> <span class="o">==</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Reached maximum number of supported vif</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_is_valid_iftype</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nw_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Not a supported interface type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">ath6kl_interface_add</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">if_idx</span><span class="p">,</span> <span class="n">nw_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">num_vif</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ndev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_del_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

	<span class="n">ath6kl_cleanup_vif</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">));</span>

	<span class="n">ath6kl_cfg80211_vif_cleanup</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_change_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">vif_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t bring up p2p on an interface which is not initialized</span>
<span class="cm">	 * for p2p operation where fw does not have capability to switch</span>
<span class="cm">	 * dynamically between non-p2p and p2p type interface.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATH6KL_FW_CAPABILITY_STA_P2PDEV_DUPLEX</span><span class="p">,</span>
		      <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_capabilities</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span> <span class="o">||</span>
	     <span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">set_iface_type</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">max_norm_iface</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Invalid interface to bring up P2P</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">set_iface_type:</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_mode</span> <span class="o">=</span> <span class="n">INFRA_NETWORK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_mode</span> <span class="o">=</span> <span class="n">ADHOC_NETWORK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_mode</span> <span class="o">=</span> <span class="n">AP_NETWORK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span>:
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_mode</span> <span class="o">=</span> <span class="n">INFRA_NETWORK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_GO</span>:
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_mode</span> <span class="o">=</span> <span class="n">AP_NETWORK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;invalid interface type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">iftype</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_join_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">cfg80211_ibss_params</span> <span class="o">*</span><span class="n">ibss_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">ibss_param</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ibss_param</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibss_param</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ch_hint</span> <span class="o">=</span> <span class="n">ibss_param</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibss_param</span><span class="o">-&gt;</span><span class="n">channel_fixed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TODO: channel_fixed: The channel should be fixed, do not</span>
<span class="cm">		 * search for IBSSs to join on other channels. Target</span>
<span class="cm">		 * firmware does not support this feature, needs to be</span>
<span class="cm">		 * updated.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ibss_param</span><span class="o">-&gt;</span><span class="n">bssid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">ibss_param</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">,</span> <span class="n">ibss_param</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">));</span>

	<span class="n">ath6kl_set_wpa_version</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_set_auth_type</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">NL80211_AUTHTYPE_OPEN_SYSTEM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibss_param</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_set_cipher</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">ath6kl_set_cipher</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath6kl_set_cipher</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">ath6kl_set_cipher</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_mode</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
		   <span class="s">&quot;%s: connect called with authmode %d dot11 auth %d&quot;</span>
		   <span class="s">&quot; PW crypto %d PW crypto len %d GRP crypto %d&quot;</span>
		   <span class="s">&quot; GRP crypto len %d channel hint %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">dot11_auth_mode</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto</span><span class="p">,</span>
		   <span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto_len</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">grp_crypto</span><span class="p">,</span>
		   <span class="n">vif</span><span class="o">-&gt;</span><span class="n">grp_crypto_len</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ch_hint</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_wmi_connect_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">dot11_auth_mode</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto_len</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">grp_crypto</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">grp_crypto_len</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ch_hint</span><span class="p">,</span>
					<span class="n">ar</span><span class="o">-&gt;</span><span class="n">connect_ctrl_flags</span><span class="p">,</span> <span class="n">SUBTYPE_NONE</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_leave_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ath6kl_disconnect</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">));</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">cipher_suites</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">WLAN_CIPHER_SUITE_WEP40</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_CCMP</span><span class="p">,</span>
	<span class="n">CCKM_KRK_CIPHER_SUITE</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_SMS4</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_rate_legacy</span><span class="p">(</span><span class="n">s32</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">s32</span> <span class="n">legacy</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">5500</span><span class="p">,</span> <span class="mi">11000</span><span class="p">,</span>
		<span class="mi">6000</span><span class="p">,</span> <span class="mi">9000</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span> <span class="mi">18000</span><span class="p">,</span> <span class="mi">24000</span><span class="p">,</span>
		<span class="mi">36000</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="mi">54000</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">legacy</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">legacy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_rate_ht20</span><span class="p">(</span><span class="n">s32</span> <span class="n">rate</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mcs</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">sgi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">s32</span> <span class="n">ht20</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">6500</span><span class="p">,</span> <span class="mi">13000</span><span class="p">,</span> <span class="mi">19500</span><span class="p">,</span> <span class="mi">26000</span><span class="p">,</span> <span class="mi">39000</span><span class="p">,</span>
		<span class="mi">52000</span><span class="p">,</span> <span class="mi">58500</span><span class="p">,</span> <span class="mi">65000</span><span class="p">,</span> <span class="mi">72200</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ht20</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">ht20</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ht20</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="cm">/* last rate uses sgi */</span>
				<span class="o">*</span><span class="n">sgi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">sgi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="o">*</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_rate_ht40</span><span class="p">(</span><span class="n">s32</span> <span class="n">rate</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mcs</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">sgi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">s32</span> <span class="n">ht40</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">13500</span><span class="p">,</span> <span class="mi">27000</span><span class="p">,</span> <span class="mi">40500</span><span class="p">,</span> <span class="mi">54000</span><span class="p">,</span>
		<span class="mi">81000</span><span class="p">,</span> <span class="mi">108000</span><span class="p">,</span> <span class="mi">121500</span><span class="p">,</span> <span class="mi">135000</span><span class="p">,</span>
		<span class="mi">150000</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ht40</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">ht40</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ht40</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="cm">/* last rate uses sgi */</span>
				<span class="o">*</span><span class="n">sgi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">sgi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="o">*</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_get_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">station_info</span> <span class="o">*</span><span class="n">sinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sgi</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mcs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">STATS_UPDATE_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_get_stats_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">left</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">,</span>
						<span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATS_UPDATE_PEND</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span>
						<span class="n">WMI_TIMEOUT</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">left</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">target_stats</span><span class="p">.</span><span class="n">rx_byte</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">target_stats</span><span class="p">.</span><span class="n">rx_byte</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_RX_BYTES</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">target_stats</span><span class="p">.</span><span class="n">rx_pkt</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_RX_PACKETS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">target_stats</span><span class="p">.</span><span class="n">tx_byte</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">target_stats</span><span class="p">.</span><span class="n">tx_byte</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_TX_BYTES</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">target_stats</span><span class="p">.</span><span class="n">tx_pkt</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_TX_PACKETS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">target_stats</span><span class="p">.</span><span class="n">cs_rssi</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_SIGNAL</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">target_stats</span><span class="p">.</span><span class="n">tx_ucast_rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_rate_legacy</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">legacy</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_rate_ht20</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sgi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RATE_INFO_FLAGS_SHORT_GI</span><span class="p">;</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">mcs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">mcs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RATE_INFO_FLAGS_MCS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_rate_ht40</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sgi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RATE_INFO_FLAGS_SHORT_GI</span><span class="p">;</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">mcs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">mcs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RATE_INFO_FLAGS_40_MHZ_WIDTH</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RATE_INFO_FLAGS_MCS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
			   <span class="s">&quot;invalid rate from stats: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="n">ath6kl_debug_war</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">ATH6KL_WAR_INVALID_RATE</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_TX_BITRATE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DTIM_PERIOD_AVAIL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">INFRA_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_BSS_PARAM</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">assoc_bss_dtim_period</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">bss_param</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">assoc_bss_beacon_int</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_set_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">cfg80211_pmksa</span> <span class="o">*</span><span class="n">pmksa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_setpmkid_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				       <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_del_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">cfg80211_pmksa</span> <span class="o">*</span><span class="n">pmksa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_setpmkid_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				       <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_flush_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_setpmkid_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					       <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wow_usr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="o">*</span><span class="n">wow</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">[</span><span class="n">WOW_MASK_SIZE</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Configure the patterns that we received from the user. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wow</span><span class="o">-&gt;</span><span class="n">n_patterns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Convert given nl80211 specific mask value to equivalent</span>
<span class="cm">		 * driver specific mask value and send it to the chip along</span>
<span class="cm">		 * with patterns. For example, If the mask value defined in</span>
<span class="cm">		 * struct cfg80211_wowlan is 0xA (equivalent binary is 1010),</span>
<span class="cm">		 * then equivalent driver specific mask value is</span>
<span class="cm">		 * &quot;0xFF 0x00 0xFF 0x00&quot;.</span>
<span class="cm">		 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mask</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">wow</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern_len</span><span class="p">;</span> <span class="n">pos</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wow</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">[</span><span class="n">pos</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pos</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)))</span>
				<span class="n">mask</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Note: Pattern&#39;s offset is not passed as part of wowlan</span>
<span class="cm">		 * parameter from CFG layer. So it&#39;s always passed as ZERO</span>
<span class="cm">		 * to the firmware. It means, given WOW patterns are always</span>
<span class="cm">		 * matched from the first byte of received pkt in the firmware.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_add_wow_pattern_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
				<span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">WOW_LIST_ID</span><span class="p">,</span>
				<span class="n">wow</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern_len</span><span class="p">,</span>
				<span class="mi">0</span> <span class="cm">/* pattern offset */</span><span class="p">,</span>
				<span class="n">wow</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wow</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">)</span>
		<span class="o">*</span><span class="n">filter</span> <span class="o">|=</span> <span class="n">WOW_FILTER_OPTION_NWK_DISASSOC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wow</span><span class="o">-&gt;</span><span class="n">magic_pkt</span><span class="p">)</span>
		<span class="o">*</span><span class="n">filter</span> <span class="o">|=</span> <span class="n">WOW_FILTER_OPTION_MAGIC_PACKET</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wow</span><span class="o">-&gt;</span><span class="n">gtk_rekey_failure</span><span class="p">)</span>
		<span class="o">*</span><span class="n">filter</span> <span class="o">|=</span> <span class="n">WOW_FILTER_OPTION_GTK_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wow</span><span class="o">-&gt;</span><span class="n">eap_identity_req</span><span class="p">)</span>
		<span class="o">*</span><span class="n">filter</span> <span class="o">|=</span> <span class="n">WOW_FILTER_OPTION_EAP_REQ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wow</span><span class="o">-&gt;</span><span class="n">four_way_handshake</span><span class="p">)</span>
		<span class="o">*</span><span class="n">filter</span> <span class="o">|=</span> <span class="n">WOW_FILTER_OPTION_8021X_4WAYHS</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wow_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">unicst_pattern</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">unicst_mask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x7f</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">unicst_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">arp_pattern</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x06</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">arp_mask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">arp_offset</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">discvr_pattern</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">discvr_mask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">discvr_offset</span> <span class="o">=</span> <span class="mi">38</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">dhcp_pattern</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x43</span> <span class="cm">/* port 67 */</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">dhcp_mask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span> <span class="cm">/* port 67 */</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">dhcp_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Setup unicast IP, EAPOL-like and ARP pkt pattern */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_add_wow_pattern_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
			<span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">WOW_LIST_ID</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">unicst_pattern</span><span class="p">),</span> <span class="n">unicst_offset</span><span class="p">,</span>
			<span class="n">unicst_pattern</span><span class="p">,</span> <span class="n">unicst_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to add WOW unicast IP pattern</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup all ARP pkt pattern */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_add_wow_pattern_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
			<span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">WOW_LIST_ID</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">arp_pattern</span><span class="p">),</span> <span class="n">arp_offset</span><span class="p">,</span>
			<span class="n">arp_pattern</span><span class="p">,</span> <span class="n">arp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to add WOW ARP pattern</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup multicast pattern for mDNS 224.0.0.251,</span>
<span class="cm">	 * SSDP 239.255.255.250 and LLMNR  224.0.0.252</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_add_wow_pattern_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
			<span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">WOW_LIST_ID</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">discvr_pattern</span><span class="p">),</span> <span class="n">discvr_offset</span><span class="p">,</span>
			<span class="n">discvr_pattern</span><span class="p">,</span> <span class="n">discvr_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to add WOW mDNS/SSDP/LLMNR pattern</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup all DHCP broadcast pkt pattern */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_add_wow_pattern_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
			<span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">WOW_LIST_ID</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">dhcp_pattern</span><span class="p">),</span> <span class="n">dhcp_offset</span><span class="p">,</span>
			<span class="n">dhcp_pattern</span><span class="p">,</span> <span class="n">dhcp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to add WOW DHCP broadcast pattern</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wow_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">discvr_pattern</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">discvr_mask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">discvr_offset</span> <span class="o">=</span> <span class="mi">38</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac_mask</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Setup unicast pkt pattern */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mac_mask</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_add_wow_pattern_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
				<span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">WOW_LIST_ID</span><span class="p">,</span>
				<span class="n">ETH_ALEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
				<span class="n">mac_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to add WOW unicast pattern</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup multicast pattern for mDNS 224.0.0.251,</span>
<span class="cm">	 * SSDP 239.255.255.250 and LLMNR 224.0.0.252</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_MULTICAST</span> <span class="o">&amp;&amp;</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_add_wow_pattern_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
				<span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">WOW_LIST_ID</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">discvr_pattern</span><span class="p">),</span> <span class="n">discvr_offset</span><span class="p">,</span>
				<span class="n">discvr_pattern</span><span class="p">,</span> <span class="n">discvr_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to add WOW mDNS/SSDP/LLMNR pattern</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_hsleep_mode_procsed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">HOST_SLEEP_MODE_CMD_PROCESSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_ctrl_ep_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ctrl_ep</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_host_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">HOST_SLEEP_MODE_CMD_PROCESSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_host_sleep_mode_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						 <span class="n">ATH6KL_HOST_MODE_ASLEEP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">left</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">,</span>
						<span class="n">is_hsleep_mode_procsed</span><span class="p">(</span><span class="n">vif</span><span class="p">),</span>
						<span class="n">WMI_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;timeout, didn&#39;t get host sleep cmd processed event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;error while waiting for host sleep cmd processed event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">left</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ctrl_ep</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">,</span>
							<span class="n">is_ctrl_ep_empty</span><span class="p">(</span><span class="n">ar</span><span class="p">),</span>
							<span class="n">WMI_TIMEOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;clear wmi ctrl data timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;clear wmi ctrl data failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wow_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="o">*</span><span class="n">wow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">filter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">bmiss_time</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">ips</span><span class="p">[</span><span class="n">MAX_IP_ADDRS</span><span class="p">];</span>

	<span class="cm">/* The FW currently can&#39;t support multi-vif WoW properly. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">num_vif</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wow</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wow</span><span class="o">-&gt;</span><span class="n">n_patterns</span> <span class="o">&gt;</span> <span class="n">WOW_MAX_FILTERS_PER_LIST</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NETDEV_MCAST_ALL_ON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_mcast_filter_cmd</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
						<span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear existing WOW patterns */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WOW_MAX_FILTERS_PER_LIST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ath6kl_wmi_del_wow_pattern_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					       <span class="n">WOW_LIST_ID</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Skip the default WOW pattern configuration</span>
<span class="cm">	 * if the driver receives any WOW patterns from</span>
<span class="cm">	 * the user.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wow</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wow_usr</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">wow</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">filter</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wow_ap</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wow_sta</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">!=</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_listeninterval_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						    <span class="n">ATH6KL_MAX_WOW_LISTEN_INTL</span><span class="p">,</span>
						    <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* Set listen interval x 15 times as bmiss time */</span>
		<span class="n">bmiss_time</span> <span class="o">=</span> <span class="n">ATH6KL_MAX_WOW_LISTEN_INTL</span> <span class="o">*</span> <span class="mi">15</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmiss_time</span> <span class="o">&gt;</span> <span class="n">ATH6KL_MAX_BMISS_TIME</span><span class="p">)</span>
			<span class="n">bmiss_time</span> <span class="o">=</span> <span class="n">ATH6KL_MAX_BMISS_TIME</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_bmisstime_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					       <span class="n">bmiss_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_scanparams_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						<span class="mh">0xFFFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ATH6KL_STATE_SUSPENDING</span><span class="p">;</span>

	<span class="cm">/* Setup own IP addr for ARP agent. */</span>
	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rtnl</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_arp</span><span class="p">;</span>

	<span class="n">ifa</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ips</span><span class="p">));</span>

	<span class="cm">/* Configure IP addr only if IP address count &lt; MAX_IP_ADDRS */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_IP_ADDRS</span> <span class="o">&amp;&amp;</span> <span class="n">ifa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ips</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">;</span>
		<span class="n">ifa</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">;</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;total IP addr count is exceeding fw limit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_ip_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">ips</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ips</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;fail to setup ip for arp agent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">skip_arp:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_wow_mode_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					  <span class="n">ATH6KL_WOW_MODE_ENABLE</span><span class="p">,</span>
					  <span class="n">filter</span><span class="p">,</span>
					  <span class="n">WOW_HOST_REQ_DELAY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_host_sleep</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_wow_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ATH6KL_STATE_RESUMING</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_host_sleep_mode_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						 <span class="n">ATH6KL_HOST_MODE_AWAKE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;Failed to configure host sleep mode for wow resume: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ret</span><span class="p">);</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ATH6KL_STATE_WOW</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">!=</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_scanparams_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_listeninterval_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">listen_intvl_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_bmisstime_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					       <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bmiss_time_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ATH6KL_STATE_ON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NETDEV_MCAST_ALL_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_mcast_filter_cmd</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_deepsleep_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;deepsleep failed as wmi is not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_cfg80211_stop_all</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="cm">/* Save the current power mode before enabling power save */</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">saved_pwr_mode</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">pwr_mode</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_powermode_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REC_POWER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Disable WOW mode */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_wow_mode_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					  <span class="n">ATH6KL_WOW_MODE_DISABLE</span><span class="p">,</span>
					  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Flush all non control pkts in TX path */</span>
	<span class="n">ath6kl_tx_data_cleanup</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_host_sleep</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_deepsleep_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">pwr_mode</span> <span class="o">!=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">saved_pwr_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_powermode_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">saved_pwr_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_host_sleep_mode_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						 <span class="n">ATH6KL_HOST_MODE_AWAKE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ATH6KL_STATE_ON</span><span class="p">;</span>

	<span class="cm">/* Reset scan parameter to default values */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_scanparams_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_cfg80211_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">ath6kl_cfg_suspend_mode</span> <span class="n">mode</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="o">*</span><span class="n">wow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ath6kl_state</span> <span class="n">prev_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATH6KL_CFG_SUSPEND_WOW</span>:

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_SUSPEND</span><span class="p">,</span> <span class="s">&quot;wow mode suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Flush all non control pkts in TX path */</span>
		<span class="n">ath6kl_tx_data_cleanup</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

		<span class="n">prev_state</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wow_suspend</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">wow</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">prev_state</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ATH6KL_STATE_WOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATH6KL_CFG_SUSPEND_DEEPSLEEP</span>:

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_SUSPEND</span><span class="p">,</span> <span class="s">&quot;deep sleep suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_deepsleep_suspend</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;deepsleep suspend failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ATH6KL_STATE_DEEPSLEEP</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATH6KL_CFG_SUSPEND_CUTPOWER</span>:

		<span class="n">ath6kl_cfg80211_stop_all</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ATH6KL_STATE_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_SUSPEND</span><span class="p">,</span>
				   <span class="s">&quot;suspend hw off, no action for cutpower</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_SUSPEND</span><span class="p">,</span> <span class="s">&quot;suspend cutting power</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_init_hw_stop</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;failed to stop hw during suspend: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ATH6KL_STATE_CUTPOWER</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATH6KL_CFG_SUSPEND_SCHED_SCAN</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Nothing needed for schedule scan, firmware is already in</span>
<span class="cm">		 * wow mode and sleeping most of the time.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">ath6kl_cfg80211_scan_complete_event</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath6kl_cfg80211_suspend</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ath6kl_cfg80211_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span>  <span class="n">ATH6KL_STATE_WOW</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_SUSPEND</span><span class="p">,</span> <span class="s">&quot;wow mode resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wow_resume</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;wow mode resume failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATH6KL_STATE_DEEPSLEEP</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_SUSPEND</span><span class="p">,</span> <span class="s">&quot;deep sleep resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_deepsleep_resume</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;deep sleep resume failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATH6KL_STATE_CUTPOWER</span>:
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_SUSPEND</span><span class="p">,</span> <span class="s">&quot;resume restoring power</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_init_hw_start</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;Failed to boot hw in resume: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATH6KL_STATE_SCHED_SCAN</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath6kl_cfg80211_resume</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="cm">/* hif layer decides what suspend mode to use */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ath6kl_cfg80211_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="o">*</span><span class="n">wow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ath6kl_hif_suspend</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">wow</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ath6kl_cfg80211_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ath6kl_hif_resume</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME: WOW suspend mode is selected if the host sdio controller supports</span>
<span class="cm"> * both sdio irq wake up and keep power. The target pulls sdio data line to</span>
<span class="cm"> * wake up the host when WOW pattern matches. This causes sdio irq handler</span>
<span class="cm"> * is being called in the host side which internally hits ath6kl&#39;s RX path.</span>
<span class="cm"> *</span>
<span class="cm"> * Since sdio interrupt is not disabled, RX path executes even before</span>
<span class="cm"> * the host executes the actual resume operation from PM module.</span>
<span class="cm"> *</span>
<span class="cm"> * In the current scenario, WOW resume should happen before start processing</span>
<span class="cm"> * any data from the target. So It&#39;s required to perform WOW resume in RX path.</span>
<span class="cm"> * Ideally we should perform WOW resume only in the actual platform</span>
<span class="cm"> * resume path. This area needs bit rework to avoid WOW resume in RX path.</span>
<span class="cm"> *</span>
<span class="cm"> * ath6kl_check_wow_status() is called from ath6kl_rx().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ath6kl_check_wow_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ATH6KL_STATE_SUSPENDING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ATH6KL_STATE_WOW</span><span class="p">)</span>
		<span class="n">ath6kl_cfg80211_resume</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="kt">void</span> <span class="nf">ath6kl_check_wow_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_set_htcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span>
			    <span class="n">bool</span> <span class="n">ht_enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_htcap</span> <span class="o">*</span><span class="n">htcap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">htcap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">htcap</span><span class="o">-&gt;</span><span class="n">ht_enable</span> <span class="o">==</span> <span class="n">ht_enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ht_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set default ht capabilities */</span>
		<span class="n">htcap</span><span class="o">-&gt;</span><span class="n">ht_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">htcap</span><span class="o">-&gt;</span><span class="n">cap_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="o">?</span>
				   <span class="n">ath6kl_g_htcap</span> <span class="o">:</span> <span class="n">ath6kl_a_htcap</span><span class="p">;</span>
		<span class="n">htcap</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MAX_AMPDU_16K</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* Disable ht */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">htcap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">htcap</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_set_htcap_cmd</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					<span class="n">band</span><span class="p">,</span> <span class="n">htcap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_restore_htcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">band</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">band</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_set_htcap</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
				<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_is_p2p_ie</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_EID_VENDOR_SPECIFIC</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
		<span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x6f</span> <span class="o">&amp;&amp;</span>
		<span class="n">pos</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x9a</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x09</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_set_ap_probe_resp_ies</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
					<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ies</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ies_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Filter out P2P IE(s) since they will be included depending on</span>
<span class="cm">	 * the Probe Request frame in ath6kl_send_go_probe_resp().</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ies</span> <span class="o">&amp;&amp;</span> <span class="n">ies_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ies_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ies</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">ies</span> <span class="o">+</span> <span class="n">ies_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ies</span> <span class="o">+</span> <span class="n">ies_len</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_is_p2p_ie</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_appie_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
				       <span class="n">WMI_FRAME_PROBE_RESP</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_set_ies</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">cfg80211_beacon_data</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* this also clears IE in fw if it&#39;s not set */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_appie_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
				       <span class="n">WMI_FRAME_BEACON</span><span class="p">,</span>
				       <span class="n">info</span><span class="o">-&gt;</span><span class="n">beacon_ies</span><span class="p">,</span>
				       <span class="n">info</span><span class="o">-&gt;</span><span class="n">beacon_ies_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* this also clears IE in fw if it&#39;s not set */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ath6kl_set_ap_probe_resp_ies</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">proberesp_ies</span><span class="p">,</span>
					   <span class="n">info</span><span class="o">-&gt;</span><span class="n">proberesp_ies_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* this also clears IE in fw if it&#39;s not set */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_appie_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
				       <span class="n">WMI_FRAME_ASSOC_RESP</span><span class="p">,</span>
				       <span class="n">info</span><span class="o">-&gt;</span><span class="n">assocresp_ies</span><span class="p">,</span>
				       <span class="n">info</span><span class="o">-&gt;</span><span class="n">assocresp_ies_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * &#39;dev&#39; could be NULL if a channel change is required for the hardware</span>
<span class="cm">	 * device itself, instead of a particular VIF.</span>
<span class="cm">	 *</span>
<span class="cm">	 * FIXME: To be handled properly when monitor mode is supported.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: center_freq=%u hw_value=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_chan</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_ch_type</span> <span class="o">=</span> <span class="n">channel_type</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_ch_band</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_get_rsn_capab</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_beacon_data</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">rsn_capab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rsn_ie</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rsn_ie_len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rsn_ie</span> <span class="o">=</span> <span class="n">cfg80211_find_ie</span><span class="p">(</span><span class="n">WLAN_EID_RSN</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">tail_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsn_ie</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">rsn_ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* skip element id and length */</span>
	<span class="n">rsn_ie</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* skip version */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsn_ie_len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">rsn_ie</span> <span class="o">+=</span>  <span class="mi">2</span><span class="p">;</span>
	<span class="n">rsn_ie_len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* skip group cipher suite */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsn_ie_len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rsn_ie</span> <span class="o">+=</span>  <span class="mi">4</span><span class="p">;</span>
	<span class="n">rsn_ie_len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* skip pairwise cipher suite */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsn_ie_len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">rsn_ie</span><span class="p">);</span>
	<span class="n">rsn_ie</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cnt</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">rsn_ie_len</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cnt</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* skip akm suite */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsn_ie_len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">rsn_ie</span><span class="p">);</span>
	<span class="n">rsn_ie</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cnt</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">rsn_ie_len</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cnt</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsn_ie_len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">rsn_capab</span><span class="p">,</span> <span class="n">rsn_ie</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_start_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">cfg80211_ap_settings</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">hidden</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ies</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ies_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_connect_cmd</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rsn_capab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_mode</span> <span class="o">!=</span> <span class="n">AP_NETWORK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ath6kl_set_ies</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">);</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ap_mode_bkey</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* TODO:</span>
<span class="cm">	 * info-&gt;interval</span>
<span class="cm">	 * info-&gt;dtim_period</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">ies</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ies</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">head</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">head_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ies_len</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">head</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">head_len</span> <span class="o">-</span> <span class="n">ies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ssid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hidden_ssid</span> <span class="o">!=</span> <span class="n">NL80211_HIDDEN_SSID_NOT_IN_USE</span><span class="p">)</span>
		<span class="n">hidden</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ath6kl_wmi_ap_hidden_ssid</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">hidden</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_set_auth_type</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">n_akm_suites</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">akm_suites</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_AKM_SUITE_8021X</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">wpa_versions</span> <span class="o">&amp;</span> <span class="n">NL80211_WPA_VERSION_1</span><span class="p">)</span>
				<span class="n">p</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">|=</span> <span class="n">WPA_AUTH</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">wpa_versions</span> <span class="o">&amp;</span> <span class="n">NL80211_WPA_VERSION_2</span><span class="p">)</span>
				<span class="n">p</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">|=</span> <span class="n">WPA2_AUTH</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_AKM_SUITE_PSK</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">wpa_versions</span> <span class="o">&amp;</span> <span class="n">NL80211_WPA_VERSION_1</span><span class="p">)</span>
				<span class="n">p</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">|=</span> <span class="n">WPA_PSK_AUTH</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">wpa_versions</span> <span class="o">&amp;</span> <span class="n">NL80211_WPA_VERSION_2</span><span class="p">)</span>
				<span class="n">p</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">|=</span> <span class="n">WPA2_PSK_AUTH</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">p</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">NONE_AUTH</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">auth_mode</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">n_ciphers_pairwise</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">ciphers_pairwise</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
			<span class="n">p</span><span class="p">.</span><span class="n">prwise_crypto_type</span> <span class="o">|=</span> <span class="n">WEP_CRYPT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
			<span class="n">p</span><span class="p">.</span><span class="n">prwise_crypto_type</span> <span class="o">|=</span> <span class="n">TKIP_CRYPT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
			<span class="n">p</span><span class="p">.</span><span class="n">prwise_crypto_type</span> <span class="o">|=</span> <span class="n">AES_CRYPT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_SMS4</span>:
			<span class="n">p</span><span class="p">.</span><span class="n">prwise_crypto_type</span> <span class="o">|=</span> <span class="n">WAPI_CRYPT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">prwise_crypto_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">.</span><span class="n">prwise_crypto_type</span> <span class="o">=</span> <span class="n">NONE_CRYPT</span><span class="p">;</span>
		<span class="n">ath6kl_set_cipher</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">n_ciphers_pairwise</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ath6kl_set_cipher</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">ciphers_pairwise</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="n">p</span><span class="p">.</span><span class="n">grp_crypto_type</span> <span class="o">=</span> <span class="n">WEP_CRYPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">p</span><span class="p">.</span><span class="n">grp_crypto_type</span> <span class="o">=</span> <span class="n">TKIP_CRYPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">p</span><span class="p">.</span><span class="n">grp_crypto_type</span> <span class="o">=</span> <span class="n">AES_CRYPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_SMS4</span>:
		<span class="n">p</span><span class="p">.</span><span class="n">grp_crypto_type</span> <span class="o">=</span> <span class="n">WAPI_CRYPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">p</span><span class="p">.</span><span class="n">grp_crypto_type</span> <span class="o">=</span> <span class="n">NONE_CRYPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ath6kl_set_cipher</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">p</span><span class="p">.</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">AP_NETWORK</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_mode</span><span class="p">;</span>

	<span class="n">p</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">dot11_auth_mode</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">dot11_auth_mode</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">ch</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_chan</span><span class="p">);</span>

	<span class="cm">/* Enable uAPSD support by default */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ath6kl_wmi_ap_set_apsd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">.</span><span class="n">nw_subtype</span> <span class="o">=</span> <span class="n">SUBTYPE_P2PGO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Due to firmware limitation, it is not possible to</span>
<span class="cm">		 * do P2P mgmt operations in AP mode</span>
<span class="cm">		 */</span>
		<span class="n">p</span><span class="p">.</span><span class="n">nw_subtype</span> <span class="o">=</span> <span class="n">SUBTYPE_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">inactivity_timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_inact_period</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						  <span class="n">info</span><span class="o">-&gt;</span><span class="n">inactivity_timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_set_htcap</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_ch_band</span><span class="p">,</span>
			     <span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_ch_type</span> <span class="o">!=</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the PTKSA replay counter in the RSN IE. Supplicant</span>
<span class="cm">	 * will use the RSN IE in M3 message and firmware has to</span>
<span class="cm">	 * advertise the same in beacon/probe response. Send</span>
<span class="cm">	 * the complete RSN IE capability field to firmware</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_get_rsn_capab</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rsn_capab</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">ATH6KL_FW_CAPABILITY_RSN_CAP_OVERRIDE</span><span class="p">,</span>
		     <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_capabilities</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_ie_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					    <span class="n">WLAN_EID_RSN</span><span class="p">,</span> <span class="n">WMI_RSN_IE_CAPB</span><span class="p">,</span>
					    <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rsn_capab</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">rsn_capab</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ath6kl_wmi_ap_profile_commit</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_change_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cfg80211_beacon_data</span> <span class="o">*</span><span class="n">beacon</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_cfg80211_ready</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_mode</span> <span class="o">!=</span> <span class="n">AP_NETWORK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ath6kl_set_ies</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">beacon</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_stop_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">!=</span> <span class="n">AP_NETWORK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

	<span class="n">ath6kl_wmi_disconnect_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Restore ht setting in firmware */</span>
	<span class="k">return</span> <span class="n">ath6kl_restore_htcap</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">bcast_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_del_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">mac</span> <span class="o">?</span> <span class="n">mac</span> <span class="o">:</span> <span class="n">bcast_addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_ap_set_mlme</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">WMI_AP_DEAUTH</span><span class="p">,</span>
				      <span class="n">addr</span><span class="p">,</span> <span class="n">WLAN_REASON_PREV_AUTH_NOT_VALID</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_change_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">station_parameters</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">!=</span> <span class="n">AP_NETWORK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* Use this only for authorizing/unauthorizing a station */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_flags_mask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">sta_flags_set</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_STA_FLAG_AUTHORIZED</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ath6kl_wmi_ap_set_mlme</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					      <span class="n">WMI_AP_MLME_AUTHORIZE</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ath6kl_wmi_ap_set_mlme</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
				      <span class="n">WMI_AP_MLME_UNAUTHORIZE</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_remain_on_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">duration</span><span class="p">,</span>
				    <span class="n">u64</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>

	<span class="cm">/* TODO: if already pending or ongoing remain-on-channel,</span>
<span class="cm">	 * return -EBUSY */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="o">++</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">last_roc_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Do not use 0 as the cookie value */</span>
		<span class="n">id</span> <span class="o">=</span> <span class="o">++</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">last_roc_id</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_remain_on_chnl_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					     <span class="n">chan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">,</span> <span class="n">duration</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cancel_remain_on_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">u64</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">!=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">last_roc_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">last_cancel_roc_id</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_cancel_remain_on_chnl_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_send_go_probe_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p2p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p2p_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>

	<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* Include P2P IE(s) from the frame generated in user space. */</span>

	<span class="n">p2p</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p2p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">p2p_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">probe_resp</span><span class="p">.</span><span class="n">variable</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_is_p2p_ie</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">p2p</span> <span class="o">+</span> <span class="n">p2p_len</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">p2p_len</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_send_probe_response_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span>
						 <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">p2p</span><span class="p">,</span> <span class="n">p2p_len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p2p</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_mgmt_powersave_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">id</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">freq</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">wait</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				     <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
				     <span class="n">bool</span> <span class="o">*</span><span class="n">more_data</span><span class="p">,</span>
				     <span class="n">bool</span> <span class="n">no_cck</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_psq_empty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_mgmt_buff</span> <span class="o">*</span><span class="n">mgmt_buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">mgmt_buf_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>

	<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">ath6kl_find_sta</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;</span> <span class="n">STA_PS_SLEEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;</span> <span class="n">STA_PS_POLLED</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Queue the frames if the STA is sleeping */</span>
			<span class="n">mgmt_buf_size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_mgmt_buff</span><span class="p">);</span>
			<span class="n">mgmt_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">mgmt_buf_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mgmt_buf</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
			<span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
			<span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="n">wait</span><span class="p">;</span>
			<span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">no_cck</span> <span class="o">=</span> <span class="n">no_cck</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
			<span class="n">is_psq_empty</span> <span class="o">=</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mgmt_psq_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mgmt_psq</span><span class="p">);</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">mgmt_psq_len</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * If this is the first pkt getting queued</span>
<span class="cm">			 * for this STA, update the PVB for this</span>
<span class="cm">			 * STA.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_psq_empty</span><span class="p">)</span>
				<span class="n">ath6kl_wmi_set_pvb_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						       <span class="n">conn</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * This tx is because of a PsPoll.</span>
<span class="cm">		 * Determine if MoreData bit has to be set.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mgmt_psq_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="o">*</span><span class="n">more_data</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Check if SSID length is greater than DIRECT- */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_is_p2p_go_ssid</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
	<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* variable[1] contains the SSID tag length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="o">&amp;</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">probe_resp</span><span class="p">.</span><span class="n">variable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">probe_resp</span><span class="p">.</span><span class="n">variable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">P2P_WILDCARD_SSID_LEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_mgmt_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">bool</span> <span class="n">offchan</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">,</span>
			  <span class="n">bool</span> <span class="n">channel_type_valid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">,</span>
			  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">bool</span> <span class="n">no_cck</span><span class="p">,</span>
			  <span class="n">bool</span> <span class="n">dont_wait_for_ack</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">more_data</span><span class="p">,</span> <span class="n">queued</span><span class="p">;</span>

	<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ath6kl_is_p2p_go_ssid</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Send Probe Response frame in GO mode using a separate WMI</span>
<span class="cm">		 * command to allow the target to fill in the generic IEs.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* TX status not supported */</span>
		<span class="k">return</span> <span class="n">ath6kl_send_go_probe_resp</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
						 <span class="n">chan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">send_action_id</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * 0 is a reserved value in the WMI command and shall not be</span>
<span class="cm">		 * used for the command.</span>
<span class="cm">		 */</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">send_action_id</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="cm">/* AP mode Power saving processing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queued</span> <span class="o">=</span> <span class="n">ath6kl_mgmt_powersave_ap</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span>
					<span class="n">id</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">,</span>
					<span class="n">wait</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
					<span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">more_data</span><span class="p">,</span> <span class="n">no_cck</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queued</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ath6kl_wmi_send_mgmt_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
					<span class="n">chan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">,</span> <span class="n">wait</span><span class="p">,</span>
					<span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">no_cck</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_mgmt_frame_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="n">u16</span> <span class="n">frame_type</span><span class="p">,</span> <span class="n">bool</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;%s: frame_type=0x%x reg=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_PROBE_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Note: This notification callback is not allowed to sleep, so</span>
<span class="cm">		 * we cannot send WMI_PROBE_REQ_REPORT_CMD here. Instead, we</span>
<span class="cm">		 * hardcode target to report Probe Request frames all the time.</span>
<span class="cm">		 */</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">probe_req_report</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_sscan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cfg80211_sched_scan_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ath6kl_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">interval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ATH6KL_STATE_ON</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">sme_state</span> <span class="o">!=</span> <span class="n">SME_DISCONNECTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* The FW currently can&#39;t support multi-vif WoW properly. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">num_vif</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ath6kl_cfg80211_scan_complete_event</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_set_probed_ssids</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">,</span>
				      <span class="n">request</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* fw uses seconds, also make sure that it&#39;s &gt;0 */</span>
	<span class="n">interval</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="n">ath6kl_wmi_scanparams_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
				  <span class="n">interval</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span>
				  <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bg_scan_period</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_wow_mode_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					  <span class="n">ATH6KL_WOW_MODE_ENABLE</span><span class="p">,</span>
					  <span class="n">WOW_FILTER_SSID</span><span class="p">,</span>
					  <span class="n">WOW_HOST_REQ_DELAY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;Failed to enable wow with ssid filter: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* this also clears IE in fw if it&#39;s not set */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_appie_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
				       <span class="n">WMI_FRAME_PROBE_REQ</span><span class="p">,</span>
				       <span class="n">request</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;Failed to set probe request IE for scheduled scan: %d&quot;</span><span class="p">,</span>
			    <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_host_sleep_mode_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						 <span class="n">ATH6KL_HOST_MODE_ASLEEP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;Failed to enable host sleep mode for sched scan: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ATH6KL_STATE_SCHED_SCAN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_sscan_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">stopped</span><span class="p">;</span>

	<span class="n">stopped</span> <span class="o">=</span> <span class="n">__ath6kl_cfg80211_sscan_stop</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stopped</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_txrx_stypes</span>
<span class="n">ath6kl_mgmt_stypes</span><span class="p">[</span><span class="n">NUM_NL80211_IFTYPES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_ACTION</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_PROBE_RESP</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span>
		<span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_ACTION</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_PROBE_REQ</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_IFTYPE_AP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_ACTION</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_PROBE_RESP</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span>
		<span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_ACTION</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_PROBE_REQ</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_ACTION</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_PROBE_RESP</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span>
		<span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_ACTION</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_PROBE_REQ</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_ACTION</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_PROBE_RESP</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span>
		<span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_ACTION</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_STYPE_PROBE_REQ</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cfg80211_ops</span> <span class="n">ath6kl_cfg80211_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">add_virtual_intf</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_add_iface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_virtual_intf</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_del_iface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_virtual_intf</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_change_iface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_key</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_add_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_get_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_key</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_del_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_default_key</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_set_default_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wiphy_params</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_set_wiphy_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tx_power</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_set_txpower</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tx_power</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_get_txpower</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_power_mgmt</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_set_power_mgmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">join_ibss</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_join_ibss</span><span class="p">,</span>
	<span class="p">.</span><span class="n">leave_ibss</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_leave_ibss</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_station</span> <span class="o">=</span> <span class="n">ath6kl_get_station</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pmksa</span> <span class="o">=</span> <span class="n">ath6kl_set_pmksa</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_pmksa</span> <span class="o">=</span> <span class="n">ath6kl_del_pmksa</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_pmksa</span> <span class="o">=</span> <span class="n">ath6kl_flush_pmksa</span><span class="p">,</span>
	<span class="n">CFG80211_TESTMODE_CMD</span><span class="p">(</span><span class="n">ath6kl_tm_cmd</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">__ath6kl_cfg80211_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">__ath6kl_cfg80211_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">set_channel</span> <span class="o">=</span> <span class="n">ath6kl_set_channel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_ap</span> <span class="o">=</span> <span class="n">ath6kl_start_ap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_beacon</span> <span class="o">=</span> <span class="n">ath6kl_change_beacon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_ap</span> <span class="o">=</span> <span class="n">ath6kl_stop_ap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_station</span> <span class="o">=</span> <span class="n">ath6kl_del_station</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_station</span> <span class="o">=</span> <span class="n">ath6kl_change_station</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remain_on_channel</span> <span class="o">=</span> <span class="n">ath6kl_remain_on_channel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cancel_remain_on_channel</span> <span class="o">=</span> <span class="n">ath6kl_cancel_remain_on_channel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mgmt_tx</span> <span class="o">=</span> <span class="n">ath6kl_mgmt_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mgmt_frame_register</span> <span class="o">=</span> <span class="n">ath6kl_mgmt_frame_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sched_scan_start</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_sscan_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sched_scan_stop</span> <span class="o">=</span> <span class="n">ath6kl_cfg80211_sscan_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ath6kl_cfg80211_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath6kl_cfg80211_sscan_disable</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">sme_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SME_DISCONNECTED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SME_CONNECTING</span>:
		<span class="n">cfg80211_connect_result</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">WLAN_STATUS_UNSPECIFIED_FAILURE</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SME_CONNECTED</span>:
		<span class="n">cfg80211_disconnected</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ath6kl_wmi_disconnect_cmd</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">);</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">sme_state</span> <span class="o">=</span> <span class="n">SME_DISCONNECTED</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* disable scanning */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_wmi_scanparams_cmd</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;failed to disable scan during stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ath6kl_cfg80211_scan_complete_event</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_cfg80211_stop_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">ath6kl_vif_first</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* save the current power mode before enabling power save */</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">saved_pwr_mode</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">pwr_mode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_wmi_powermode_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REC_POWER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;ath6kl_deep_sleep_enable: wmi_powermode_cmd failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: we should take ar-&gt;list_lock to protect changes in the</span>
<span class="cm">	 * vif_list, but that&#39;s not trivial to do as ath6kl_cfg80211_stop()</span>
<span class="cm">	 * sleeps.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">ath6kl_cfg80211_stop</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_cfg80211_vif_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">aggr_cntxt</span> <span class="o">=</span> <span class="n">aggr_init</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">aggr_cntxt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to initialize aggr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">disconnect_timer</span><span class="p">,</span> <span class="n">disconnect_timer_handler</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">sched_scan_timer</span><span class="p">,</span> <span class="n">ath6kl_wmi_sscan_timer</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">vif</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">WMM_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">if_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">mc_filter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_cfg80211_vif_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_mc_filter</span> <span class="o">*</span><span class="n">mc_filter</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">aggr_module_destroy</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">aggr_cntxt</span><span class="p">);</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">avail_idx_map</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">ADHOC_NETWORK</span><span class="p">)</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ibss_if_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">mc_filter</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc_filter</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">unregister_netdevice</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">num_vif</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">ath6kl_interface_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">fw_vif_idx</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">nw_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vif</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">ether_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ar</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">wiphy_dev</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">));</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">iftype</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span> <span class="o">=</span> <span class="n">fw_vif_idx</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">nw_type</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_mode</span> <span class="o">=</span> <span class="n">nw_type</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">listen_intvl_t</span> <span class="o">=</span> <span class="n">ATH6KL_DEFAULT_LISTEN_INTVAL</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">bmiss_time_t</span> <span class="o">=</span> <span class="n">ATH6KL_DEFAULT_BMISS_TIME</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">bg_scan_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">htcap</span><span class="p">.</span><span class="n">ht_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_vif_idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fw_vif_idx</span><span class="p">))</span> <span class="o">|</span>
				     <span class="mh">0x2</span><span class="p">;</span>

	<span class="n">init_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">ath6kl_init_control_info</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_cfg80211_vif_init</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdevice</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">avail_idx_map</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">fw_vif_idx</span><span class="p">);</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">sme_state</span> <span class="o">=</span> <span class="n">SME_DISCONNECTED</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WLAN_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">wlan_pwr_state</span> <span class="o">=</span> <span class="n">WLAN_POWER_STATE_ON</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">NETDEV_REGISTERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ibss_if_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ndev</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">aggr_module_destroy</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">aggr_cntxt</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_cfg80211_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">band_2gig</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">band_5gig</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">ht</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">mgmt_stypes</span> <span class="o">=</span> <span class="n">ath6kl_mgmt_stypes</span><span class="p">;</span>

	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_remain_on_channel_duration</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>

	<span class="cm">/* set device pointer for wiphy */</span>
	<span class="n">set_wiphy_dev</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_AP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">p2p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span> <span class="o">|</span>
					  <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* max num of ssids that can be probed during scanning */</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ssids</span> <span class="o">=</span> <span class="n">MAX_PROBED_SSID_INDEX</span><span class="p">;</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ie_len</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="cm">/* FIX: what is correct limit? */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WMI_11AN_CAP</span>:
		<span class="n">ht</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_11A_CAP</span>:
		<span class="n">band_5gig</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_11GN_CAP</span>:
		<span class="n">ht</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_11G_CAP</span>:
		<span class="n">band_2gig</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_11AGN_CAP</span>:
		<span class="n">ht</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_11AG_CAP</span>:
		<span class="n">band_2gig</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">band_5gig</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;invalid phy capability!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Even if the fw has HT support, advertise HT cap only when</span>
<span class="cm">	 * the firmware has support to override RSN capability, otherwise</span>
<span class="cm">	 * 4-way handshake would fail.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ht</span> <span class="o">&amp;&amp;</span>
	      <span class="n">test_bit</span><span class="p">(</span><span class="n">ATH6KL_FW_CAPABILITY_RSN_CAP_OVERRIDE</span><span class="p">,</span>
		       <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_capabilities</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ath6kl_band_2ghz</span><span class="p">.</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ath6kl_band_2ghz</span><span class="p">.</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ath6kl_band_5ghz</span><span class="p">.</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ath6kl_band_5ghz</span><span class="p">.</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">band_2gig</span><span class="p">)</span>
		<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ath6kl_band_2ghz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">band_5gig</span><span class="p">)</span>
		<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ath6kl_band_5ghz</span><span class="p">;</span>

	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">signal_type</span> <span class="o">=</span> <span class="n">CFG80211_SIGNAL_TYPE_MBM</span><span class="p">;</span>

	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">cipher_suites</span> <span class="o">=</span> <span class="n">cipher_suites</span><span class="p">;</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_cipher_suites</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cipher_suites</span><span class="p">);</span>

	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">WIPHY_WOWLAN_MAGIC_PKT</span> <span class="o">|</span>
			      <span class="n">WIPHY_WOWLAN_DISCONNECT</span> <span class="o">|</span>
			      <span class="n">WIPHY_WOWLAN_GTK_REKEY_FAILURE</span>  <span class="o">|</span>
			      <span class="n">WIPHY_WOWLAN_SUPPORTS_GTK_REKEY</span> <span class="o">|</span>
			      <span class="n">WIPHY_WOWLAN_EAP_IDENTITY_REQ</span>   <span class="o">|</span>
			      <span class="n">WIPHY_WOWLAN_4WAY_HANDSHAKE</span><span class="p">;</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">.</span><span class="n">n_patterns</span> <span class="o">=</span> <span class="n">WOW_MAX_FILTERS_PER_LIST</span><span class="p">;</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">.</span><span class="n">pattern_min_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">.</span><span class="n">pattern_max_len</span> <span class="o">=</span> <span class="n">WOW_PATTERN_SIZE</span><span class="p">;</span>

	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_sched_scan_ssids</span> <span class="o">=</span> <span class="n">MAX_PROBED_SSID_INDEX</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIPHY_FLAG_SUPPORTS_FW_ROAM</span> <span class="o">|</span>
			    <span class="n">WIPHY_FLAG_HAVE_AP_SME</span> <span class="o">|</span>
			    <span class="n">WIPHY_FLAG_HAS_REMAIN_ON_CHANNEL</span> <span class="o">|</span>
			    <span class="n">WIPHY_FLAG_AP_PROBE_RESP_OFFLOAD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATH6KL_FW_CAPABILITY_SCHED_SCAN</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_capabilities</span><span class="p">))</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIPHY_FLAG_SUPPORTS_SCHED_SCAN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATH6KL_FW_CAPABILITY_INACTIVITY_TIMEOUT</span><span class="p">,</span>
		     <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_capabilities</span><span class="p">))</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">NL80211_FEATURE_INACTIVITY_TIMER</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">probe_resp_offload</span> <span class="o">=</span>
		<span class="n">NL80211_PROBE_RESP_OFFLOAD_SUPPORT_WPS</span> <span class="o">|</span>
		<span class="n">NL80211_PROBE_RESP_OFFLOAD_SUPPORT_WPS2</span> <span class="o">|</span>
		<span class="n">NL80211_PROBE_RESP_OFFLOAD_SUPPORT_P2P</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wiphy_register</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;couldn&#39;t register wiphy device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy_registered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_cfg80211_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wiphy_unregister</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy_registered</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="nf">ath6kl_cfg80211_create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="cm">/* create a new wiphy for use with cfg80211 */</span>
	<span class="n">wiphy</span> <span class="o">=</span> <span class="n">wiphy_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ath6kl_cfg80211_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wiphy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;couldn&#39;t allocate wiphy device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wiphy</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ar</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Note: ar variable must not be accessed after calling this! */</span>
<span class="kt">void</span> <span class="nf">ath6kl_cfg80211_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_MAX_NUM_STA</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">aggr_conn</span><span class="p">);</span>

	<span class="n">wiphy_free</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
