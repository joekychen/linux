<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath6kl › init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2011 Atheros Communications Inc.</span>
<span class="cm"> * Copyright (c) 2011-2012 Qualcomm Atheros, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdio_func.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;cfg80211.h&quot;</span>
<span class="cp">#include &quot;target.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;hif-ops.h&quot;</span>
<span class="cp">#include &quot;htc-ops.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath6kl_hw</span> <span class="n">hw_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>				<span class="o">=</span> <span class="n">AR6003_HW_2_0_VERSION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="s">&quot;ar6003 hw 2.0&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dataset_patch_addr</span>		<span class="o">=</span> <span class="mh">0x57e884</span><span class="p">,</span>
		<span class="p">.</span><span class="n">app_load_addr</span>			<span class="o">=</span> <span class="mh">0x543180</span><span class="p">,</span>
		<span class="p">.</span><span class="n">board_ext_data_addr</span>		<span class="o">=</span> <span class="mh">0x57e500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reserved_ram_size</span>		<span class="o">=</span> <span class="mi">6912</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refclk_hz</span>			<span class="o">=</span> <span class="mi">26000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">uarttx_pin</span>			<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>

		<span class="cm">/* hw2.0 needs override address hardcoded */</span>
		<span class="p">.</span><span class="n">app_start_override_addr</span>	<span class="o">=</span> <span class="mh">0x944C00</span><span class="p">,</span>

		<span class="p">.</span><span class="n">fw</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">dir</span>		<span class="o">=</span> <span class="n">AR6003_HW_2_0_FW_DIR</span><span class="p">,</span>
			<span class="p">.</span><span class="n">otp</span>		<span class="o">=</span> <span class="n">AR6003_HW_2_0_OTP_FILE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">fw</span>		<span class="o">=</span> <span class="n">AR6003_HW_2_0_FIRMWARE_FILE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">tcmd</span>		<span class="o">=</span> <span class="n">AR6003_HW_2_0_TCMD_FIRMWARE_FILE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">patch</span>		<span class="o">=</span> <span class="n">AR6003_HW_2_0_PATCH_FILE</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">fw_board</span>		<span class="o">=</span> <span class="n">AR6003_HW_2_0_BOARD_DATA_FILE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fw_default_board</span>	<span class="o">=</span> <span class="n">AR6003_HW_2_0_DEFAULT_BOARD_DATA_FILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>				<span class="o">=</span> <span class="n">AR6003_HW_2_1_1_VERSION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="s">&quot;ar6003 hw 2.1.1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dataset_patch_addr</span>		<span class="o">=</span> <span class="mh">0x57ff74</span><span class="p">,</span>
		<span class="p">.</span><span class="n">app_load_addr</span>			<span class="o">=</span> <span class="mh">0x1234</span><span class="p">,</span>
		<span class="p">.</span><span class="n">board_ext_data_addr</span>		<span class="o">=</span> <span class="mh">0x542330</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reserved_ram_size</span>		<span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refclk_hz</span>			<span class="o">=</span> <span class="mi">26000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">uarttx_pin</span>			<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">testscript_addr</span>		<span class="o">=</span> <span class="mh">0x57ef74</span><span class="p">,</span>

		<span class="p">.</span><span class="n">fw</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">dir</span>		<span class="o">=</span> <span class="n">AR6003_HW_2_1_1_FW_DIR</span><span class="p">,</span>
			<span class="p">.</span><span class="n">otp</span>		<span class="o">=</span> <span class="n">AR6003_HW_2_1_1_OTP_FILE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">fw</span>		<span class="o">=</span> <span class="n">AR6003_HW_2_1_1_FIRMWARE_FILE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">tcmd</span>		<span class="o">=</span> <span class="n">AR6003_HW_2_1_1_TCMD_FIRMWARE_FILE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">patch</span>		<span class="o">=</span> <span class="n">AR6003_HW_2_1_1_PATCH_FILE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">utf</span>		<span class="o">=</span> <span class="n">AR6003_HW_2_1_1_UTF_FIRMWARE_FILE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">testscript</span>	<span class="o">=</span> <span class="n">AR6003_HW_2_1_1_TESTSCRIPT_FILE</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">fw_board</span>		<span class="o">=</span> <span class="n">AR6003_HW_2_1_1_BOARD_DATA_FILE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fw_default_board</span> <span class="o">=</span> <span class="n">AR6003_HW_2_1_1_DEFAULT_BOARD_DATA_FILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>				<span class="o">=</span> <span class="n">AR6004_HW_1_0_VERSION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="s">&quot;ar6004 hw 1.0&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dataset_patch_addr</span>		<span class="o">=</span> <span class="mh">0x57e884</span><span class="p">,</span>
		<span class="p">.</span><span class="n">app_load_addr</span>			<span class="o">=</span> <span class="mh">0x1234</span><span class="p">,</span>
		<span class="p">.</span><span class="n">board_ext_data_addr</span>		<span class="o">=</span> <span class="mh">0x437000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reserved_ram_size</span>		<span class="o">=</span> <span class="mi">19456</span><span class="p">,</span>
		<span class="p">.</span><span class="n">board_addr</span>			<span class="o">=</span> <span class="mh">0x433900</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refclk_hz</span>			<span class="o">=</span> <span class="mi">26000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">uarttx_pin</span>			<span class="o">=</span> <span class="mi">11</span><span class="p">,</span>

		<span class="p">.</span><span class="n">fw</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">dir</span>		<span class="o">=</span> <span class="n">AR6004_HW_1_0_FW_DIR</span><span class="p">,</span>
			<span class="p">.</span><span class="n">fw</span>		<span class="o">=</span> <span class="n">AR6004_HW_1_0_FIRMWARE_FILE</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">fw_board</span>		<span class="o">=</span> <span class="n">AR6004_HW_1_0_BOARD_DATA_FILE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fw_default_board</span>	<span class="o">=</span> <span class="n">AR6004_HW_1_0_DEFAULT_BOARD_DATA_FILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>				<span class="o">=</span> <span class="n">AR6004_HW_1_1_VERSION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="s">&quot;ar6004 hw 1.1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dataset_patch_addr</span>		<span class="o">=</span> <span class="mh">0x57e884</span><span class="p">,</span>
		<span class="p">.</span><span class="n">app_load_addr</span>			<span class="o">=</span> <span class="mh">0x1234</span><span class="p">,</span>
		<span class="p">.</span><span class="n">board_ext_data_addr</span>		<span class="o">=</span> <span class="mh">0x437000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reserved_ram_size</span>		<span class="o">=</span> <span class="mi">11264</span><span class="p">,</span>
		<span class="p">.</span><span class="n">board_addr</span>			<span class="o">=</span> <span class="mh">0x43d400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refclk_hz</span>			<span class="o">=</span> <span class="mi">40000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">uarttx_pin</span>			<span class="o">=</span> <span class="mi">11</span><span class="p">,</span>

		<span class="p">.</span><span class="n">fw</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">dir</span>		<span class="o">=</span> <span class="n">AR6004_HW_1_1_FW_DIR</span><span class="p">,</span>
			<span class="p">.</span><span class="n">fw</span>		<span class="o">=</span> <span class="n">AR6004_HW_1_1_FIRMWARE_FILE</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">fw_board</span>		<span class="o">=</span> <span class="n">AR6004_HW_1_1_BOARD_DATA_FILE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fw_default_board</span>	<span class="o">=</span> <span class="n">AR6004_HW_1_1_DEFAULT_BOARD_DATA_FILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>				<span class="o">=</span> <span class="n">AR6004_HW_1_2_VERSION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="s">&quot;ar6004 hw 1.2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dataset_patch_addr</span>		<span class="o">=</span> <span class="mh">0x436ecc</span><span class="p">,</span>
		<span class="p">.</span><span class="n">app_load_addr</span>			<span class="o">=</span> <span class="mh">0x1234</span><span class="p">,</span>
		<span class="p">.</span><span class="n">board_ext_data_addr</span>		<span class="o">=</span> <span class="mh">0x437000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reserved_ram_size</span>		<span class="o">=</span> <span class="mi">9216</span><span class="p">,</span>
		<span class="p">.</span><span class="n">board_addr</span>			<span class="o">=</span> <span class="mh">0x435c00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refclk_hz</span>			<span class="o">=</span> <span class="mi">40000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">uarttx_pin</span>			<span class="o">=</span> <span class="mi">11</span><span class="p">,</span>

		<span class="p">.</span><span class="n">fw</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">dir</span>		<span class="o">=</span> <span class="n">AR6004_HW_1_2_FW_DIR</span><span class="p">,</span>
			<span class="p">.</span><span class="n">fw</span>		<span class="o">=</span> <span class="n">AR6004_HW_1_2_FIRMWARE_FILE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">fw_board</span>		<span class="o">=</span> <span class="n">AR6004_HW_1_2_BOARD_DATA_FILE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fw_default_board</span>	<span class="o">=</span> <span class="n">AR6004_HW_1_2_DEFAULT_BOARD_DATA_FILE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Include definitions here that can be used to tune the WLAN module</span>
<span class="cm"> * behavior. Different customers can tune the behavior as per their needs,</span>
<span class="cm"> * here.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This configuration item enable/disable keepalive support.</span>
<span class="cm"> * Keepalive support: In the absence of any data traffic to AP, null</span>
<span class="cm"> * frames will be sent to the AP at periodic interval, to keep the association</span>
<span class="cm"> * active. This configuration item defines the periodic interval.</span>
<span class="cm"> * Use value of zero to disable keepalive support</span>
<span class="cm"> * Default: 60 seconds</span>
<span class="cm"> */</span>
<span class="cp">#define WLAN_CONFIG_KEEP_ALIVE_INTERVAL 60</span>

<span class="cm">/*</span>
<span class="cm"> * This configuration item sets the value of disconnect timeout</span>
<span class="cm"> * Firmware delays sending the disconnec event to the host for this</span>
<span class="cm"> * timeout after is gets disconnected from the current AP.</span>
<span class="cm"> * If the firmware successly roams within the disconnect timeout</span>
<span class="cm"> * it sends a new connect event</span>
<span class="cm"> */</span>
<span class="cp">#define WLAN_CONFIG_DISCONNECT_TIMEOUT 10</span>


<span class="cp">#define ATH6KL_DATA_OFFSET    64</span>
<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ath6kl_buf_alloc</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reserved</span><span class="p">;</span>

	<span class="cm">/* Add chacheline space at front and back of buffer */</span>
	<span class="n">reserved</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">L1_CACHE_BYTES</span><span class="p">)</span> <span class="o">+</span> <span class="n">ATH6KL_DATA_OFFSET</span> <span class="o">+</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_packet</span><span class="p">)</span> <span class="o">+</span> <span class="n">ATH6KL_HTC_ALIGN_BYTES</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">reserved</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">reserved</span> <span class="o">-</span> <span class="n">L1_CACHE_BYTES</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_init_profile_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">));</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">dot11_auth_mode</span> <span class="o">=</span> <span class="n">OPEN_AUTH</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">NONE_AUTH</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto</span> <span class="o">=</span> <span class="n">NONE_CRYPT</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">grp_crypto</span> <span class="o">=</span> <span class="n">NONE_CRYPT</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">grp_crypto_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wep_key_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wep_key_list</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">req_bssid</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">));</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_set_host_app_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_app_area</span> <span class="n">host_app_area</span><span class="p">;</span>

	<span class="cm">/* Fetch the address of the host_app_area_s</span>
<span class="cm">	 * instance in the host interest area */</span>
	<span class="n">address</span> <span class="o">=</span> <span class="n">ath6kl_get_hi_item_addr</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">HI_ITEM</span><span class="p">(</span><span class="n">hi_app_host_interest</span><span class="p">));</span>
	<span class="n">address</span> <span class="o">=</span> <span class="n">TARG_VTOP</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_diag_read32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">address</span> <span class="o">=</span> <span class="n">TARG_VTOP</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">host_app_area</span><span class="p">.</span><span class="n">wmi_protocol_ver</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">WMI_PROTOCOL_VERSION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_diag_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">host_app_area</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_app_area</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_ac2_ep_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">ac</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ac2ep_map</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ep2ac_map</span><span class="p">[</span><span class="n">ep</span><span class="p">]</span> <span class="o">=</span> <span class="n">ac</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* connect to a service */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_connectservice</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">htc_service_connect_req</span>  <span class="o">*</span><span class="n">con_req</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_service_connect_resp</span> <span class="n">response</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">response</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">response</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_conn_service</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">,</span> <span class="n">con_req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">response</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to connect to %s service status:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">desc</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">con_req</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WMI_CONTROL_SVC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span>
			<span class="n">ath6kl_wmi_set_control_ep</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">endpoint</span><span class="p">);</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ctrl_ep</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">endpoint</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_DATA_BE_SVC</span>:
		<span class="n">set_ac2_ep_map</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">WMM_AC_BE</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">endpoint</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_DATA_BK_SVC</span>:
		<span class="n">set_ac2_ep_map</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">WMM_AC_BK</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">endpoint</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_DATA_VI_SVC</span>:
		<span class="n">set_ac2_ep_map</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">WMM_AC_VI</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">endpoint</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WMI_DATA_VO_SVC</span>:
		<span class="n">set_ac2_ep_map</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">WMM_AC_VO</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">endpoint</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;service id is not mapped %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con_req</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_init_service_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_service_connect_req</span> <span class="n">connect</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">connect</span><span class="p">));</span>

	<span class="cm">/* these fields are the same for all service endpoints */</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">tx_comp_multi</span> <span class="o">=</span> <span class="n">ath6kl_tx_complete</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">ath6kl_rx</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_refill</span> <span class="o">=</span> <span class="n">ath6kl_rx_refill</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">tx_full</span> <span class="o">=</span> <span class="n">ath6kl_tx_queue_full</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the max queue depth so that our ath6kl_tx_queue_full handler</span>
<span class="cm">	 * gets called.</span>
<span class="cm">	*/</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">max_txq_depth</span> <span class="o">=</span> <span class="n">MAX_DEFAULT_SEND_QUEUE_DEPTH</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_refill_thresh</span> <span class="o">=</span> <span class="n">ATH6KL_MAX_RX_BUFFERS</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_refill_thresh</span><span class="p">)</span>
		<span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_refill_thresh</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* connect to control service */</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">svc_id</span> <span class="o">=</span> <span class="n">WMI_CONTROL_SVC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_connectservice</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connect</span><span class="p">,</span> <span class="s">&quot;WMI CONTROL&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">connect</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HTC_FLGS_TX_BNDL_PAD_EN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Limit the HTC message size on the send path, although e can</span>
<span class="cm">	 * receive A-MSDU frames of 4K, we will only send ethernet-sized</span>
<span class="cm">	 * (802.3) frames on the send path.</span>
<span class="cm">	 */</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">max_rxmsg_sz</span> <span class="o">=</span> <span class="n">WMI_MAX_TX_DATA_FRAME_LENGTH</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * To reduce the amount of committed memory for larger A_MSDU</span>
<span class="cm">	 * frames, use the recv-alloc threshold mechanism for larger</span>
<span class="cm">	 * packets.</span>
<span class="cm">	 */</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_alloc_thresh</span> <span class="o">=</span> <span class="n">ATH6KL_BUFFER_SIZE</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_allocthresh</span> <span class="o">=</span> <span class="n">ath6kl_alloc_amsdu_rxbuf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For the remaining data services set the connection flag to</span>
<span class="cm">	 * reduce dribbling, if configured to do so.</span>
<span class="cm">	 */</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">conn_flags</span> <span class="o">|=</span> <span class="n">HTC_CONN_FLGS_REDUCE_CRED_DRIB</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">conn_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HTC_CONN_FLGS_THRESH_MASK</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">conn_flags</span> <span class="o">|=</span> <span class="n">HTC_CONN_FLGS_THRESH_LVL_HALF</span><span class="p">;</span>

	<span class="n">connect</span><span class="p">.</span><span class="n">svc_id</span> <span class="o">=</span> <span class="n">WMI_DATA_BE_SVC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_connectservice</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connect</span><span class="p">,</span> <span class="s">&quot;WMI DATA BE&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* connect to back-ground map this to WMI LOW_PRI */</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">svc_id</span> <span class="o">=</span> <span class="n">WMI_DATA_BK_SVC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_connectservice</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connect</span><span class="p">,</span> <span class="s">&quot;WMI DATA BK&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* connect to Video service, map this to to HI PRI */</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">svc_id</span> <span class="o">=</span> <span class="n">WMI_DATA_VI_SVC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_connectservice</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connect</span><span class="p">,</span> <span class="s">&quot;WMI DATA VI&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Connect to VO service, this is currently not mapped to a WMI</span>
<span class="cm">	 * priority stream due to historical reasons. WMI originally</span>
<span class="cm">	 * defined 3 priorities over 3 mailboxes We can change this when</span>
<span class="cm">	 * WMI is reworked so that priorities are not dependent on</span>
<span class="cm">	 * mailboxes.</span>
<span class="cm">	 */</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">svc_id</span> <span class="o">=</span> <span class="n">WMI_DATA_VO_SVC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_connectservice</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connect</span><span class="p">,</span> <span class="s">&quot;WMI DATA VO&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_init_control_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath6kl_init_profile_info</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">def_txkey_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wep_key_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wep_key_list</span><span class="p">));</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">ch_hint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set HTC/Mbox operational parameters, this can only be called when the</span>
<span class="cm"> * target is in the BMI phase.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_set_htc_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mbox_isr_yield_val</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">htc_ctrl_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">blk_size</span><span class="p">;</span>

	<span class="n">blk_size</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">mbox_info</span><span class="p">.</span><span class="n">block_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">htc_ctrl_buf</span><span class="p">)</span>
		<span class="n">blk_size</span> <span class="o">|=</span>  <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">htc_ctrl_buf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* set the host interest area for the block size */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_mbox_io_block_sz</span><span class="p">,</span> <span class="n">blk_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;bmi_write_memory for IO block size failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span> <span class="s">&quot;block size set: %d (target addr:0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">blk_size</span><span class="p">,</span>
		   <span class="n">ath6kl_get_hi_item_addr</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">HI_ITEM</span><span class="p">(</span><span class="n">hi_mbox_io_block_sz</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mbox_isr_yield_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set the host interest area for the mbox ISR yield limit */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_mbox_isr_yield_limit</span><span class="p">,</span>
					       <span class="n">mbox_isr_yield_val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;bmi_write_memory for yield limit failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_target_config_wlan_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure the device for rx dot11 header rules. &quot;0,0&quot; are the</span>
<span class="cm">	 * default values. Required if checksum offload is needed. Set</span>
<span class="cm">	 * RxMetaVersion to 2.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_rx_frame_format_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
						 <span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_meta_ver</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unable to set the rx frame format: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">conf_flags</span> <span class="o">&amp;</span> <span class="n">ATH6KL_CONF_IGNORE_PS_FAIL_EVT_IN_SCAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_pmparams_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					      <span class="n">IGNORE_PS_FAIL_DURING_SCAN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unable to set power save fail event policy: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">conf_flags</span> <span class="o">&amp;</span> <span class="n">ATH6KL_CONF_IGNORE_ERP_BARKER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_lpreamble_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						   <span class="n">WMI_FOLLOW_BARKER_IN_ERP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unable to set barker preamble policy: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_keepalive_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
					   <span class="n">WLAN_CONFIG_KEEP_ALIVE_INTERVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unable to set keep alive interval: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_disctimeout_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
					 <span class="n">WLAN_CONFIG_DISCONNECT_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unable to set disconnect timeout: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">conf_flags</span> <span class="o">&amp;</span> <span class="n">ATH6KL_CONF_ENABLE_TX_BURST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_wmm_txop</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">WMI_TXOP_DISABLED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unable to set txop bursting: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">p2p</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">idx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_info_req_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
					      <span class="n">P2P_FLAG_CAPABILITIES_REQ</span> <span class="o">|</span>
					      <span class="n">P2P_FLAG_MACADDR_REQ</span> <span class="o">|</span>
					      <span class="n">P2P_FLAG_HMODEL_REQ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span>
				   <span class="s">&quot;failed to request P2P capabilities (%d) - assuming P2P not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ret</span><span class="p">);</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">p2p</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">p2p</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">idx</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Enable Probe Request reporting for P2P */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_probe_report_req_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span>
				   <span class="s">&quot;failed to enable Probe Request reporting (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_configure_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">param</span><span class="p">,</span> <span class="n">ram_reserved_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fw_iftype</span><span class="p">,</span> <span class="n">fw_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fw_submode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">param</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">conf_flags</span> <span class="o">&amp;</span> <span class="n">ATH6KL_CONF_UART_DEBUG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_serial_enable</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;bmi_write_memory for uart debug failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: Even though the firmware interface type is</span>
<span class="cm">	 * chosen as BSS_STA for all three interfaces, can</span>
<span class="cm">	 * be configured to IBSS/AP as long as the fw submode</span>
<span class="cm">	 * remains normal mode (0 - AP, STA and IBSS). But</span>
<span class="cm">	 * due to an target assert in firmware only one interface is</span>
<span class="cm">	 * configured for now.</span>
<span class="cm">	 */</span>
	<span class="n">fw_iftype</span> <span class="o">=</span> <span class="n">HI_OPTION_FW_MODE_BSS_STA</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">fw_mode</span> <span class="o">|=</span> <span class="n">fw_iftype</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">HI_OPTION_FW_MODE_BITS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Submodes when fw does not support dynamic interface</span>
<span class="cm">	 * switching:</span>
<span class="cm">	 *		vif[0] - AP/STA/IBSS</span>
<span class="cm">	 *		vif[1] - &quot;P2P dev&quot;/&quot;P2P GO&quot;/&quot;P2P Client&quot;</span>
<span class="cm">	 *		vif[2] - &quot;P2P dev&quot;/&quot;P2P GO&quot;/&quot;P2P Client&quot;</span>
<span class="cm">	 * Otherwise, All the interface are initialized to p2p dev.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATH6KL_FW_CAPABILITY_STA_P2PDEV_DUPLEX</span><span class="p">,</span>
		     <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_capabilities</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">fw_submode</span> <span class="o">|=</span> <span class="n">HI_OPTION_FW_SUBMODE_P2PDEV</span> <span class="o">&lt;&lt;</span>
				<span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">HI_OPTION_FW_SUBMODE_BITS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">max_norm_iface</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">fw_submode</span> <span class="o">|=</span> <span class="n">HI_OPTION_FW_SUBMODE_NONE</span> <span class="o">&lt;&lt;</span>
				<span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">HI_OPTION_FW_SUBMODE_BITS</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">max_norm_iface</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">fw_submode</span> <span class="o">|=</span> <span class="n">HI_OPTION_FW_SUBMODE_P2PDEV</span> <span class="o">&lt;&lt;</span>
				<span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">HI_OPTION_FW_SUBMODE_BITS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">p2p</span> <span class="o">&amp;&amp;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">fw_submode</span> <span class="o">=</span> <span class="n">HI_OPTION_FW_SUBMODE_P2PDEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_app_host_interest</span><span class="p">,</span>
				  <span class="n">HTC_PROTOCOL_VERSION</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;bmi_write_memory for htc version failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set the firmware mode to STA/IBSS/AP */</span>
	<span class="n">param</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_bmi_read_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_option_flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;bmi_read_memory for setting fwmode failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">param</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span> <span class="o">&lt;&lt;</span> <span class="n">HI_OPTION_NUM_DEV_SHIFT</span><span class="p">);</span>
	<span class="n">param</span> <span class="o">|=</span> <span class="n">fw_mode</span> <span class="o">&lt;&lt;</span> <span class="n">HI_OPTION_FW_MODE_SHIFT</span><span class="p">;</span>
	<span class="n">param</span> <span class="o">|=</span> <span class="n">fw_submode</span> <span class="o">&lt;&lt;</span> <span class="n">HI_OPTION_FW_SUBMODE_SHIFT</span><span class="p">;</span>

	<span class="n">param</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">HI_OPTION_MAC_ADDR_METHOD_SHIFT</span><span class="p">);</span>
	<span class="n">param</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">HI_OPTION_FW_BRIDGE_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_option_flag</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;bmi_write_memory for setting fwmode failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span> <span class="s">&quot;firmware mode set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hardcode the address use for the extended board data</span>
<span class="cm">	 * Ideally this should be pre-allocate by the OS at boot time</span>
<span class="cm">	 * But since it is a new feature and board data is loaded</span>
<span class="cm">	 * at init time, we have to workaround this from host.</span>
<span class="cm">	 * It is difficult to patch the firmware boot code,</span>
<span class="cm">	 * but possible in theory.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span> <span class="o">==</span> <span class="n">TARGET_TYPE_AR6003</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">board_ext_data_addr</span><span class="p">;</span>
		<span class="n">ram_reserved_size</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">reserved_ram_size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_board_ext_data</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;bmi_write_memory for hi_board_ext_data failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_end_ram_reserve_sz</span><span class="p">,</span>
					  <span class="n">ram_reserved_size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;bmi_write_memory for hi_end_ram_reserve_sz failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* set the block size for the target */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_set_htc_params</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">MBOX_YIELD_LIMIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="cm">/* use default number of control buffers */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* Configure GPIO AR600x UART */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_dbg_uart_txpin</span><span class="p">,</span>
				       <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">uarttx_pin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Configure target refclk_hz */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_refclk_hz</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">refclk_hz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* firmware upload */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_get_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="o">**</span><span class="n">fw</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">fw_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">fw_len</span> <span class="o">=</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_OF</span>
<span class="cm">/*</span>
<span class="cm"> * Check the device tree for a board-id and use it to construct</span>
<span class="cm"> * the pathname to the firmware file.  Used (for now) to find a</span>
<span class="cm"> * fallback to the &quot;bdata.bin&quot; file--typically a symlink to the</span>
<span class="cm"> * appropriate board-specific file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">check_device_tree</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">board_id_prop</span> <span class="o">=</span> <span class="s">&quot;atheros,board-id&quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">board_filename</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">board_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">for_each_compatible_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;atheros,ath6kl&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">board_id</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">board_id_prop</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">board_id</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;No </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> property on %s node.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">board_id_prop</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">board_filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">board_filename</span><span class="p">),</span>
			 <span class="s">&quot;%s/bdata.%s.bin&quot;</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">board_id</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_get_fw</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">board_filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to get DT board file %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">board_filename</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">check_device_tree</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_OF */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_fetch_board_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw_board</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">filename</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw_board</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_get_fw</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* managed to get proper board file */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_device_tree</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* got board file from device tree */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* there was no proper board file, try to use default instead */</span>
	<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;Failed to get board file %s (%d), trying to find default board file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">filename</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">filename</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw_default_board</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_get_fw</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to get default board file %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">filename</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;WARNING! No proper board file was not found, instead using a default board file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;Most likely your hardware won&#39;t work as specified. Install correct board file!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_fetch_otp_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_otp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">otp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span>
			   <span class="s">&quot;no OTP file configured for this hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span>
		 <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">otp</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_get_fw</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_otp</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_otp_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to get OTP file %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">filename</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_fetch_testmode_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">testmode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;testmode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">testmode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">testmode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">utf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;testmode 2 not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span>
			 <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">utf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">tcmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;testmode 1 not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span>
			 <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">tcmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">TESTMODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_get_fw</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to get testmode %d firmware file %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">testmode</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_fetch_fw_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* FIXME: remove WARN_ON() as we won&#39;t support FW API 1 for long */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">fw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span>
		 <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">fw</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_get_fw</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to get firmware file %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">filename</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_fetch_patch_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_patch</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">patch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span>
		 <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">patch</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_get_fw</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_patch</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_patch_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to get patch file %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">filename</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_fetch_testscript_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">testmode</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_testscript</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">testscript</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span>
		 <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">testscript</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_get_fw</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_testscript</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_testscript_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to get testscript file %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">filename</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_fetch_fw_api1</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_fetch_otp_file</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_fetch_fw_file</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_fetch_patch_file</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_fetch_testscript_file</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_fetch_fw_apin</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">magic_len</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_fw_ie</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">ie_id</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="cm">/* magic also includes the null byte, check that as well */</span>
	<span class="n">magic_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ATH6KL_FIRMWARE_MAGIC</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">magic_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ATH6KL_FIRMWARE_MAGIC</span><span class="p">,</span> <span class="n">magic_len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">-=</span> <span class="n">magic_len</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">+=</span> <span class="n">magic_len</span><span class="p">;</span>

	<span class="cm">/* loop elements */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_fw_ie</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* hdr is unaligned! */</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_fw_ie</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

		<span class="n">ie_id</span> <span class="o">=</span> <span class="n">le32_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="n">le32_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ie_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ie_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ATH6KL_FW_IE_OTP_IMAGE</span>:
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;found otp image ie (%zd B)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ie_len</span><span class="p">);</span>

			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_otp</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_otp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_otp_len</span> <span class="o">=</span> <span class="n">ie_len</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATH6KL_FW_IE_FW_IMAGE</span>:
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;found fw image ie (%zd B)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ie_len</span><span class="p">);</span>

			<span class="cm">/* in testmode we already might have a fw file */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">ie_len</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">);</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_len</span> <span class="o">=</span> <span class="n">ie_len</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATH6KL_FW_IE_PATCH_IMAGE</span>:
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;found patch image ie (%zd B)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ie_len</span><span class="p">);</span>

			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_patch</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_patch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_patch_len</span> <span class="o">=</span> <span class="n">ie_len</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATH6KL_FW_IE_RESERVED_RAM_SIZE</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">reserved_ram_size</span> <span class="o">=</span> <span class="n">le32_to_cpup</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span>
				   <span class="s">&quot;found reserved ram size ie 0x%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">reserved_ram_size</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATH6KL_FW_IE_CAPABILITIES</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ie_len</span> <span class="o">&lt;</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">ATH6KL_FW_CAPABILITY_MAX</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span>
				   <span class="s">&quot;found firmware capabilities ie (%zd B)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ie_len</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH6KL_FW_CAPABILITY_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">bit</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">))</span>
					<span class="n">__set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_capabilities</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;capabilities&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
					<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_capabilities</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_capabilities</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATH6KL_FW_IE_PATCH_ADDR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ie_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dataset_patch_addr</span> <span class="o">=</span> <span class="n">le32_to_cpup</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span>
				   <span class="s">&quot;found patch address ie 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dataset_patch_addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATH6KL_FW_IE_BOARD_ADDR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ie_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">board_addr</span> <span class="o">=</span> <span class="n">le32_to_cpup</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span>
				   <span class="s">&quot;found board address ie 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">board_addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATH6KL_FW_IE_VIF_MAX</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ie_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">le32_to_cpup</span><span class="p">(</span><span class="n">val</span><span class="p">),</span>
					    <span class="n">ATH6KL_VIF_MAX</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">p2p</span><span class="p">)</span>
				<span class="n">ar</span><span class="o">-&gt;</span><span class="n">max_norm_iface</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span>
				   <span class="s">&quot;found vif max ie %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;Unknown fw ie: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">le32_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">ie_len</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">ie_len</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_init_fetch_firmwares</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_fetch_board_file</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_fetch_testmode_file</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_fetch_fw_apin</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">ATH6KL_FW_API3_FILE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_api</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_fetch_fw_apin</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">ATH6KL_FW_API2_FILE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_api</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_fetch_fw_api1</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_api</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;using fw api %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_api</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_upload_board_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">board_address</span><span class="p">,</span> <span class="n">board_ext_address</span><span class="p">,</span> <span class="n">param</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">board_data_size</span><span class="p">,</span> <span class="n">board_ext_data_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine where in Target RAM to write Board Data.</span>
<span class="cm">	 * For AR6004, host determine Target RAM address for</span>
<span class="cm">	 * writing board data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">board_addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">board_address</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">board_addr</span><span class="p">;</span>
		<span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_board_data</span><span class="p">,</span>
				      <span class="n">board_address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath6kl_bmi_read_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_board_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">board_address</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* determine where in target ram to write extended board data */</span>
	<span class="n">ath6kl_bmi_read_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_board_ext_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">board_ext_address</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span> <span class="o">==</span> <span class="n">TARGET_TYPE_AR6003</span> <span class="o">&amp;&amp;</span>
	    <span class="n">board_ext_address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to get board file target address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TARGET_TYPE_AR6003</span>:
		<span class="n">board_data_size</span> <span class="o">=</span> <span class="n">AR6003_BOARD_DATA_SZ</span><span class="p">;</span>
		<span class="n">board_ext_data_size</span> <span class="o">=</span> <span class="n">AR6003_BOARD_EXT_DATA_SZ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">board_data_size</span> <span class="o">+</span> <span class="n">board_ext_data_size</span><span class="p">))</span>
			<span class="n">board_ext_data_size</span> <span class="o">=</span> <span class="n">AR6003_BOARD_EXT_DATA_SZ_V2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TARGET_TYPE_AR6004</span>:
		<span class="n">board_data_size</span> <span class="o">=</span> <span class="n">AR6004_BOARD_DATA_SZ</span><span class="p">;</span>
		<span class="n">board_ext_data_size</span> <span class="o">=</span> <span class="n">AR6004_BOARD_EXT_DATA_SZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board_ext_address</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board_len</span> <span class="o">==</span> <span class="p">(</span><span class="n">board_data_size</span> <span class="o">+</span> <span class="n">board_ext_data_size</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* write extended board data */</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span>
			   <span class="s">&quot;writing extended board data to 0x%x (%d B)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">board_ext_address</span><span class="p">,</span> <span class="n">board_ext_data_size</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_bmi_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">board_ext_address</span><span class="p">,</span>
				       <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board</span> <span class="o">+</span> <span class="n">board_data_size</span><span class="p">,</span>
				       <span class="n">board_ext_data_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to write extended board data: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* record that extended board data is initialized */</span>
		<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">board_ext_data_size</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_board_ext_data_config</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board_len</span> <span class="o">&lt;</span> <span class="n">board_data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Too small board file: %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board_len</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;writing board file to 0x%x (%d B)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">board_address</span><span class="p">,</span> <span class="n">board_data_size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_bmi_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">board_address</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_board</span><span class="p">,</span>
			       <span class="n">board_data_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Board file bmi write failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* record the fact that Board Data IS initialized */</span>
	<span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_board_data_initialized</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_upload_otp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">param</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">from_hw</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_otp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">address</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">app_load_addr</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;writing otp to 0x%x (%zd B)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span>
		   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_otp_len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_bmi_fast_download</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_otp</span><span class="p">,</span>
				       <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_otp_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to upload OTP file: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read firmware start address */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_bmi_read_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_app_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to read hi_app_start: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">app_start_override_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">app_start_override_addr</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
		<span class="n">from_hw</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;app_start_override_addr%s 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">from_hw</span> <span class="o">?</span> <span class="s">&quot; (from hw)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">app_start_override_addr</span><span class="p">);</span>

	<span class="cm">/* execute the OTP code */</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;executing OTP at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">app_start_override_addr</span><span class="p">);</span>
	<span class="n">param</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ath6kl_bmi_execute</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">app_start_override_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_upload_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">address</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">app_load_addr</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;writing firmware to 0x%x (%zd B)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">address</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_bmi_fast_download</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to write firmware: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set starting address for firmware</span>
<span class="cm">	 * Don&#39;t need to setup app_start override addr on AR6004</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span> <span class="o">!=</span> <span class="n">TARGET_TYPE_AR6004</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">address</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">app_start_override_addr</span><span class="p">;</span>
		<span class="n">ath6kl_bmi_set_app_start</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_upload_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_patch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">address</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dataset_patch_addr</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;writing patch to 0x%x (%zd B)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">address</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_patch_len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_bmi_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_patch</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_patch_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to write patch file: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_dset_list_head</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_upload_testscript</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">testmode</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_testscript</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">address</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">testscript_addr</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;writing testscript to 0x%x (%zd B)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">address</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_testscript_len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_bmi_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_testscript</span><span class="p">,</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_testscript_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Failed to write testscript file: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_ota_testscript</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_end_ram_reserve_sz</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="n">ath6kl_bmi_write_hi32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">hi_test_apps_related</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_init_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">param</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span> <span class="o">!=</span> <span class="n">TARGET_TYPE_AR6003</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span> <span class="o">!=</span> <span class="n">TARGET_TYPE_AR6004</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* temporarily disable system sleep */</span>
	<span class="n">address</span> <span class="o">=</span> <span class="n">MBOX_BASE_ADDRESS</span> <span class="o">+</span> <span class="n">LOCAL_SCRATCH_ADDRESS</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_reg_read</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">options</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

	<span class="n">param</span> <span class="o">|=</span> <span class="n">ATH6KL_OPTION_SLEEP_DISABLE</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_reg_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">address</span> <span class="o">=</span> <span class="n">RTC_BASE_ADDRESS</span> <span class="o">+</span> <span class="n">SYSTEM_SLEEP_ADDRESS</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_reg_read</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">sleep</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

	<span class="n">param</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">SYSTEM_SLEEP_DISABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_reg_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span> <span class="s">&quot;old options: %d, old sleep: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">options</span><span class="p">,</span> <span class="n">sleep</span><span class="p">);</span>

	<span class="cm">/* program analog PLL register */</span>
	<span class="cm">/* no need to control 40/44MHz clock on AR6004 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span> <span class="o">!=</span> <span class="n">TARGET_TYPE_AR6004</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_reg_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">ATH6KL_ANALOG_PLL_REGISTER</span><span class="p">,</span>
					      <span class="mh">0xF9104001</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="cm">/* Run at 80/88MHz by default */</span>
		<span class="n">param</span> <span class="o">=</span> <span class="n">SM</span><span class="p">(</span><span class="n">CPU_CLOCK_STANDARD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">address</span> <span class="o">=</span> <span class="n">RTC_BASE_ADDRESS</span> <span class="o">+</span> <span class="n">CPU_CLOCK_ADDRESS</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_reg_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">param</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">address</span> <span class="o">=</span> <span class="n">RTC_BASE_ADDRESS</span> <span class="o">+</span> <span class="n">LPO_CAL_ADDRESS</span><span class="p">;</span>
	<span class="n">param</span> <span class="o">=</span> <span class="n">SM</span><span class="p">(</span><span class="n">LPO_CAL_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_reg_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* WAR to avoid SDIO CRC err */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">target_ver</span> <span class="o">==</span> <span class="n">AR6003_HW_2_0_VERSION</span> <span class="o">||</span>
	    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">target_ver</span> <span class="o">==</span> <span class="n">AR6003_HW_2_1_1_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;temporary war to avoid sdio crc error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">param</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>

		<span class="n">address</span> <span class="o">=</span> <span class="n">GPIO_BASE_ADDRESS</span> <span class="o">+</span> <span class="n">GPIO_PIN10_ADDRESS</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_reg_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">address</span> <span class="o">=</span> <span class="n">GPIO_BASE_ADDRESS</span> <span class="o">+</span> <span class="n">GPIO_PIN11_ADDRESS</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_reg_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">address</span> <span class="o">=</span> <span class="n">GPIO_BASE_ADDRESS</span> <span class="o">+</span> <span class="n">GPIO_PIN12_ADDRESS</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_reg_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">address</span> <span class="o">=</span> <span class="n">GPIO_BASE_ADDRESS</span> <span class="o">+</span> <span class="n">GPIO_PIN13_ADDRESS</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_reg_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write EEPROM data to Target RAM */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_upload_board_file</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* transfer One time Programmable data */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_upload_otp</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Download Target firmware */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_upload_firmware</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_upload_patch</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Download the test script */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_upload_testscript</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Restore system sleep */</span>
	<span class="n">address</span> <span class="o">=</span> <span class="n">RTC_BASE_ADDRESS</span> <span class="o">+</span> <span class="n">SYSTEM_SLEEP_ADDRESS</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_reg_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">sleep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">address</span> <span class="o">=</span> <span class="n">MBOX_BASE_ADDRESS</span> <span class="o">+</span> <span class="n">LOCAL_SCRATCH_ADDRESS</span><span class="p">;</span>
	<span class="n">param</span> <span class="o">=</span> <span class="n">options</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_bmi_reg_write</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_init_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ath6kl_hw</span> <span class="o">*</span><span class="n">uninitialized_var</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hw_list</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">target_ver</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hw_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;Unsupported hardware version: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">target_ver</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span>
		   <span class="s">&quot;target_ver 0x%x target_type 0x%x dataset_patch 0x%x app_load_addr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">target_ver</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">,</span>
		   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dataset_patch_addr</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">app_load_addr</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span>
		   <span class="s">&quot;app_start_override_addr 0x%x board_ext_data_addr 0x%x reserved_ram_size 0x%x&quot;</span><span class="p">,</span>
		   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">app_start_override_addr</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">board_ext_data_addr</span><span class="p">,</span>
		   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">reserved_ram_size</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span>
		   <span class="s">&quot;refclk_hz %d uarttx_pin %d&quot;</span><span class="p">,</span>
		   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">refclk_hz</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">uarttx_pin</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ath6kl_init_get_hif_name</span><span class="p">(</span><span class="k">enum</span> <span class="n">ath6kl_hif_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATH6KL_HIF_TYPE_SDIO</span>:
		<span class="k">return</span> <span class="s">&quot;sdio&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATH6KL_HIF_TYPE_USB</span>:
		<span class="k">return</span> <span class="s">&quot;usb&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_init_hw_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;hw start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_hif_power_on</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_configure_target</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_power_off</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_init_upload</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_power_off</span><span class="p">;</span>

	<span class="cm">/* Do we need to finish the BMI phase */</span>
	<span class="cm">/* FIXME: return error from ath6kl_bmi_done() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_bmi_done</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_power_off</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The reason we have to wait for the target here is that the</span>
<span class="cm">	 * driver layer has to init BMI in order to set the host block</span>
<span class="cm">	 * size.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_htc_wait_target</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_power_off</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_init_service_ep</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_cleanup_scatter</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* setup credit distribution */</span>
	<span class="n">ath6kl_htc_credit_setup</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">credit_state_info</span><span class="p">);</span>

	<span class="cm">/* start HTC */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_htc_start</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME: call this */</span>
		<span class="n">ath6kl_cookie_cleanup</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cleanup_scatter</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for Wmi event to be ready */</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">,</span>
						    <span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_READY</span><span class="p">,</span>
							     <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">),</span>
						    <span class="n">WMI_TIMEOUT</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;firmware booted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FIRST_BOOT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_info</span><span class="p">(</span><span class="s">&quot;%s %s fw %s api %d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">ath6kl_init_get_hif_name</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hif_type</span><span class="p">),</span>
			    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span>
			    <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_api</span><span class="p">,</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">TESTMODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; testmode&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">abi_ver</span> <span class="o">!=</span> <span class="n">ATH6KL_ABI_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;abi version mismatch: host(0x%x), target(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ATH6KL_ABI_VERSION</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">abi_ver</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_htc_stop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span> <span class="o">||</span> <span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;wmi is not ready or wait was interrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_htc_stop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span> <span class="s">&quot;%s: wmi is ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* communicate the wmi protocol verision to the target */</span>
	<span class="cm">/* FIXME: return error */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ath6kl_set_host_app_area</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unable to set the host app area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_target_config_wlan_params</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_htc_stop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ATH6KL_STATE_ON</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_htc_stop:</span>
	<span class="n">ath6kl_htc_stop</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">);</span>
<span class="nl">err_cleanup_scatter:</span>
	<span class="n">ath6kl_hif_cleanup_scatter</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
<span class="nl">err_power_off:</span>
	<span class="n">ath6kl_hif_power_off</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_init_hw_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;hw stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ath6kl_htc_stop</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">);</span>

	<span class="n">ath6kl_hif_stop</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">ath6kl_bmi_reset</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_hif_power_off</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;failed to power off hif: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ATH6KL_STATE_OFF</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME: move this to cfg80211.c and rename to ath6kl_cfg80211_vif_stop() */</span>
<span class="kt">void</span> <span class="nf">ath6kl_cleanup_vif</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">bool</span> <span class="n">wmi_ready</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">bcast_mac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>
	<span class="n">bool</span> <span class="n">discon_issued</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WLAN_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wmi_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">discon_issued</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ath6kl_disconnect</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">disconnect_timer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">discon_issued</span><span class="p">)</span>
			<span class="n">ath6kl_disconnect_event</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">DISCONNECT_CMD</span><span class="p">,</span>
						<span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">&amp;</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="o">?</span>
						<span class="n">bcast_mac</span> <span class="o">:</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg80211_scan_done</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_stop_txrx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_vif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">DESTROY_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;down_interruptible failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_MAX_NUM_STA</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">aggr_reset_state</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">aggr_conn</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">tmp_vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
		<span class="n">ath6kl_cleanup_vif</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">));</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">ath6kl_cfg80211_vif_cleanup</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WMI_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * After wmi_shudown all WMI events will be dropped. We</span>
<span class="cm">	 * need to cleanup the buffers allocated in AP mode and</span>
<span class="cm">	 * give disconnect notification to stack, which usually</span>
<span class="cm">	 * happens in the disconnect_event. Simulate the disconnect</span>
<span class="cm">	 * event by calling the function directly. Sometimes</span>
<span class="cm">	 * disconnect_event will be received when the debug logs</span>
<span class="cm">	 * are collected.</span>
<span class="cm">	 */</span>
	<span class="n">ath6kl_wmi_shutdown</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WMI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span> <span class="s">&quot;%s: shut down htc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ath6kl_htc_stop</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_target</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to reset the device if we can. The driver may have been</span>
<span class="cm">	 * configure NOT to reset the target during a debug session.</span>
<span class="cm">	 */</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span>
		   <span class="s">&quot;attempting to reset target on instance destroy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ath6kl_reset_device</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WLAN_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath6kl_stop_txrx</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
