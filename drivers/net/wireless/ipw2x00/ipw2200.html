<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ipw2x00 › ipw2200.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ipw2200.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>

<span class="cm">  Copyright(c) 2003 - 2006 Intel Corporation. All rights reserved.</span>

<span class="cm">  802.11 status code portion of this file from ethereal-0.10.6:</span>
<span class="cm">    Copyright 2000, Axis Communications AB</span>
<span class="cm">    Ethereal - Network traffic analyzer</span>
<span class="cm">    By Gerald Combs &lt;gerald@ethereal.com&gt;</span>
<span class="cm">    Copyright 1998 Gerald Combs</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms of version 2 of the GNU General Public License as</span>
<span class="cm">  published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc., 59</span>
<span class="cm">  Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in the</span>
<span class="cm">  file called LICENSE.</span>

<span class="cm">  Contact Information:</span>
<span class="cm">  Intel Linux Wireless &lt;ilw@linux.intel.com&gt;</span>
<span class="cm">  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>

<span class="cm">******************************************************************************/</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211-wext.h&gt;</span>
<span class="cp">#include &quot;ipw2200.h&quot;</span>
<span class="cp">#include &quot;ipw.h&quot;</span>


<span class="cp">#ifndef KBUILD_EXTMOD</span>
<span class="cp">#define VK &quot;k&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define VK</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_IPW2200_DEBUG</span>
<span class="cp">#define VD &quot;d&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define VD</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
<span class="cp">#define VM &quot;m&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define VM</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
<span class="cp">#define VP &quot;p&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define VP</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_IPW2200_RADIOTAP</span>
<span class="cp">#define VR &quot;r&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define VR</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_IPW2200_QOS</span>
<span class="cp">#define VQ &quot;q&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define VQ</span>
<span class="cp">#endif</span>

<span class="cp">#define IPW2200_VERSION &quot;1.2.2&quot; VK VD VM VP VR VQ</span>
<span class="cp">#define DRV_DESCRIPTION	&quot;Intel(R) PRO/Wireless 2200/2915 Network Driver&quot;</span>
<span class="cp">#define DRV_COPYRIGHT	&quot;Copyright(c) 2003-2006 Intel Corporation&quot;</span>
<span class="cp">#define DRV_VERSION     IPW2200_VERSION</span>

<span class="cp">#define ETH_P_80211_STATS (ETH_P_80211_RAW + 1)</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRV_COPYRIGHT</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;ipw2200-ibss.fw&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;ipw2200-sniffer.fw&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;ipw2200-bss.fw&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cmdlog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">default_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">network_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">ipw_debug_level</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">associate</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">auto_create</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">led_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bt_coexist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hwcrypto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">roaming</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ipw_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;b&#39;</span><span class="p">,</span> <span class="sc">&#39;g&#39;</span><span class="p">,</span> <span class="sc">&#39;?&#39;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">antenna</span> <span class="o">=</span> <span class="n">CFG_SYS_ANTENNA_BOTH</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rtap_iface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     <span class="cm">/* def: 0 -- do not create rtap interface */</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">ipw2200_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">90</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">120</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">180</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">240</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">480</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">540</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define ipw2200_a_rates		(ipw2200_rates + 4)</span>
<span class="cp">#define ipw2200_num_a_rates	8</span>
<span class="cp">#define ipw2200_bg_rates	(ipw2200_rates + 0)</span>
<span class="cp">#define ipw2200_num_bg_rates	12</span>

<span class="cm">/* Ugly macro to convert literal channel numbers into their mhz equivalents</span>
<span class="cm"> * There are certianly some conditions that will break this (like feeding it &#39;30&#39;)</span>
<span class="cm"> * but they shouldn&#39;t arise since nothing talks on channel 30. */</span>
<span class="cp">#define ieee80211chan2mhz(x) \</span>
<span class="cp">	(((x) &lt;= 14) ? \</span>
<span class="cp">	(((x) == 14) ? 2484 : ((x) * 5) + 2407) : \</span>
<span class="cp">	((x) + 1000) * 5)</span>

<span class="cp">#ifdef CONFIG_IPW2200_QOS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qos_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qos_burst_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qos_no_ack_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">burst_duration_CCK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">burst_duration_OFDM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">libipw_qos_parameters</span> <span class="n">def_qos_parameters_OFDM</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">QOS_TX0_CW_MIN_OFDM</span><span class="p">,</span> <span class="n">QOS_TX1_CW_MIN_OFDM</span><span class="p">,</span> <span class="n">QOS_TX2_CW_MIN_OFDM</span><span class="p">,</span>
	 <span class="n">QOS_TX3_CW_MIN_OFDM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">QOS_TX0_CW_MAX_OFDM</span><span class="p">,</span> <span class="n">QOS_TX1_CW_MAX_OFDM</span><span class="p">,</span> <span class="n">QOS_TX2_CW_MAX_OFDM</span><span class="p">,</span>
	 <span class="n">QOS_TX3_CW_MAX_OFDM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">QOS_TX0_AIFS</span><span class="p">,</span> <span class="n">QOS_TX1_AIFS</span><span class="p">,</span> <span class="n">QOS_TX2_AIFS</span><span class="p">,</span> <span class="n">QOS_TX3_AIFS</span><span class="p">},</span>
	<span class="p">{</span><span class="n">QOS_TX0_ACM</span><span class="p">,</span> <span class="n">QOS_TX1_ACM</span><span class="p">,</span> <span class="n">QOS_TX2_ACM</span><span class="p">,</span> <span class="n">QOS_TX3_ACM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">QOS_TX0_TXOP_LIMIT_OFDM</span><span class="p">,</span> <span class="n">QOS_TX1_TXOP_LIMIT_OFDM</span><span class="p">,</span>
	 <span class="n">QOS_TX2_TXOP_LIMIT_OFDM</span><span class="p">,</span> <span class="n">QOS_TX3_TXOP_LIMIT_OFDM</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">libipw_qos_parameters</span> <span class="n">def_qos_parameters_CCK</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">QOS_TX0_CW_MIN_CCK</span><span class="p">,</span> <span class="n">QOS_TX1_CW_MIN_CCK</span><span class="p">,</span> <span class="n">QOS_TX2_CW_MIN_CCK</span><span class="p">,</span>
	 <span class="n">QOS_TX3_CW_MIN_CCK</span><span class="p">},</span>
	<span class="p">{</span><span class="n">QOS_TX0_CW_MAX_CCK</span><span class="p">,</span> <span class="n">QOS_TX1_CW_MAX_CCK</span><span class="p">,</span> <span class="n">QOS_TX2_CW_MAX_CCK</span><span class="p">,</span>
	 <span class="n">QOS_TX3_CW_MAX_CCK</span><span class="p">},</span>
	<span class="p">{</span><span class="n">QOS_TX0_AIFS</span><span class="p">,</span> <span class="n">QOS_TX1_AIFS</span><span class="p">,</span> <span class="n">QOS_TX2_AIFS</span><span class="p">,</span> <span class="n">QOS_TX3_AIFS</span><span class="p">},</span>
	<span class="p">{</span><span class="n">QOS_TX0_ACM</span><span class="p">,</span> <span class="n">QOS_TX1_ACM</span><span class="p">,</span> <span class="n">QOS_TX2_ACM</span><span class="p">,</span> <span class="n">QOS_TX3_ACM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">QOS_TX0_TXOP_LIMIT_CCK</span><span class="p">,</span> <span class="n">QOS_TX1_TXOP_LIMIT_CCK</span><span class="p">,</span> <span class="n">QOS_TX2_TXOP_LIMIT_CCK</span><span class="p">,</span>
	 <span class="n">QOS_TX3_TXOP_LIMIT_CCK</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">libipw_qos_parameters</span> <span class="n">def_parameters_OFDM</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">DEF_TX0_CW_MIN_OFDM</span><span class="p">,</span> <span class="n">DEF_TX1_CW_MIN_OFDM</span><span class="p">,</span> <span class="n">DEF_TX2_CW_MIN_OFDM</span><span class="p">,</span>
	 <span class="n">DEF_TX3_CW_MIN_OFDM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DEF_TX0_CW_MAX_OFDM</span><span class="p">,</span> <span class="n">DEF_TX1_CW_MAX_OFDM</span><span class="p">,</span> <span class="n">DEF_TX2_CW_MAX_OFDM</span><span class="p">,</span>
	 <span class="n">DEF_TX3_CW_MAX_OFDM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DEF_TX0_AIFS</span><span class="p">,</span> <span class="n">DEF_TX1_AIFS</span><span class="p">,</span> <span class="n">DEF_TX2_AIFS</span><span class="p">,</span> <span class="n">DEF_TX3_AIFS</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DEF_TX0_ACM</span><span class="p">,</span> <span class="n">DEF_TX1_ACM</span><span class="p">,</span> <span class="n">DEF_TX2_ACM</span><span class="p">,</span> <span class="n">DEF_TX3_ACM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DEF_TX0_TXOP_LIMIT_OFDM</span><span class="p">,</span> <span class="n">DEF_TX1_TXOP_LIMIT_OFDM</span><span class="p">,</span>
	 <span class="n">DEF_TX2_TXOP_LIMIT_OFDM</span><span class="p">,</span> <span class="n">DEF_TX3_TXOP_LIMIT_OFDM</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">libipw_qos_parameters</span> <span class="n">def_parameters_CCK</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">DEF_TX0_CW_MIN_CCK</span><span class="p">,</span> <span class="n">DEF_TX1_CW_MIN_CCK</span><span class="p">,</span> <span class="n">DEF_TX2_CW_MIN_CCK</span><span class="p">,</span>
	 <span class="n">DEF_TX3_CW_MIN_CCK</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DEF_TX0_CW_MAX_CCK</span><span class="p">,</span> <span class="n">DEF_TX1_CW_MAX_CCK</span><span class="p">,</span> <span class="n">DEF_TX2_CW_MAX_CCK</span><span class="p">,</span>
	 <span class="n">DEF_TX3_CW_MAX_CCK</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DEF_TX0_AIFS</span><span class="p">,</span> <span class="n">DEF_TX1_AIFS</span><span class="p">,</span> <span class="n">DEF_TX2_AIFS</span><span class="p">,</span> <span class="n">DEF_TX3_AIFS</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DEF_TX0_ACM</span><span class="p">,</span> <span class="n">DEF_TX1_ACM</span><span class="p">,</span> <span class="n">DEF_TX2_ACM</span><span class="p">,</span> <span class="n">DEF_TX3_ACM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DEF_TX0_TXOP_LIMIT_CCK</span><span class="p">,</span> <span class="n">DEF_TX1_TXOP_LIMIT_CCK</span><span class="p">,</span> <span class="n">DEF_TX2_TXOP_LIMIT_CCK</span><span class="p">,</span>
	 <span class="n">DEF_TX3_TXOP_LIMIT_CCK</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">qos_oui</span><span class="p">[</span><span class="n">QOS_OUI_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xF2</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">from_priority_to_tx_queue</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IPW_TX_QUEUE_1</span><span class="p">,</span> <span class="n">IPW_TX_QUEUE_2</span><span class="p">,</span> <span class="n">IPW_TX_QUEUE_2</span><span class="p">,</span> <span class="n">IPW_TX_QUEUE_1</span><span class="p">,</span>
	<span class="n">IPW_TX_QUEUE_3</span><span class="p">,</span> <span class="n">IPW_TX_QUEUE_3</span><span class="p">,</span> <span class="n">IPW_TX_QUEUE_4</span><span class="p">,</span> <span class="n">IPW_TX_QUEUE_4</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">ipw_qos_get_burst_duration</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw_send_qos_params_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">libipw_qos_parameters</span>
				       <span class="o">*</span><span class="n">qos_param</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw_send_qos_info_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">libipw_qos_information_element</span>
				     <span class="o">*</span><span class="n">qos_param</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_QOS */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">ipw_get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw_remove_current_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw_queue_tx_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">clx2_tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qindex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw_queue_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw_queue_tx_hcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hcmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sync</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw_tx_queue_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipw_rx_queue</span> <span class="o">*</span><span class="n">ipw_rx_queue_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw_rx_queue_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_rx_queue</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw_rx_queue_replenish</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw_bg_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw_bg_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">init_supported_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipw_supported_rates</span> <span class="o">*</span><span class="n">prates</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw_set_hwcrypto_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw_send_wep_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snprint_line</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">out</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">out</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;%08X&quot;</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span>
			<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot;%02X &quot;</span><span class="p">,</span>
					<span class="n">data</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">)]);</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot;   &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">)];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isascii</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">isprint</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
				<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>

			<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">printk_buf</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">81</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">ofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ipw_debug_level</span> <span class="o">&amp;</span> <span class="n">level</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprint_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">ofs</span><span class="p">],</span>
			     <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="mi">16U</span><span class="p">),</span> <span class="n">ofs</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
		<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="mi">16U</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snprintk_buf</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span> <span class="n">output</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">out</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span> <span class="o">=</span> <span class="n">snprint_line</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">ofs</span><span class="p">],</span>
				   <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">16U</span><span class="p">),</span> <span class="n">ofs</span><span class="p">);</span>

		<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">output</span> <span class="o">+=</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">16U</span><span class="p">);</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* alias for 32-bit indirect read (for SRAM/reg above 4K), with debug wrapper */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">_ipw_read_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">);</span>
<span class="cp">#define ipw_read_reg32(a, b) _ipw_read_reg32(a, b)</span>

<span class="cm">/* alias for 8-bit indirect read (for SRAM/reg above 4K), with debug wrapper */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">_ipw_read_reg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">ipw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">);</span>
<span class="cp">#define ipw_read_reg8(a, b) _ipw_read_reg8(a, b)</span>

<span class="cm">/* 8-bit indirect write (for SRAM/reg above 4K), with debug wrapper */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">_ipw_write_reg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ipw_write_reg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">u32</span> <span class="n">b</span><span class="p">,</span> <span class="n">u8</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot;%s %d: write_indirect8(0x%08X, 0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span>
		     <span class="n">__LINE__</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">_ipw_write_reg8</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 16-bit indirect write (for SRAM/reg above 4K), with debug wrapper */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">_ipw_write_reg16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ipw_write_reg16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">u32</span> <span class="n">b</span><span class="p">,</span> <span class="n">u16</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot;%s %d: write_indirect16(0x%08X, 0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span>
		     <span class="n">__LINE__</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">_ipw_write_reg16</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 32-bit indirect write (for SRAM/reg above 4K), with debug wrapper */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">_ipw_write_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ipw_write_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">u32</span> <span class="n">b</span><span class="p">,</span> <span class="n">u32</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot;%s %d: write_indirect32(0x%08X, 0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span>
		     <span class="n">__LINE__</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span><span class="p">));</span>
	<span class="n">_ipw_write_reg32</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 8-bit direct write (low 4K) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_ipw_write8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">ipw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ofs</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">hw_base</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 8-bit direct write (for low 4K of SRAM/regs), with debug wrapper */</span>
<span class="cp">#define ipw_write8(ipw, ofs, val) do { \</span>
<span class="cp">	IPW_DEBUG_IO(&quot;%s %d: write_direct8(0x%08X, 0x%08X)\n&quot;, __FILE__, \</span>
<span class="cp">			__LINE__, (u32)(ofs), (u32)(val)); \</span>
<span class="cp">	_ipw_write8(ipw, ofs, val); \</span>
<span class="cp">} while (0)</span>

<span class="cm">/* 16-bit direct write (low 4K) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_ipw_write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">ipw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ofs</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">hw_base</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 16-bit direct write (for low 4K of SRAM/regs), with debug wrapper */</span>
<span class="cp">#define ipw_write16(ipw, ofs, val) do { \</span>
<span class="cp">	IPW_DEBUG_IO(&quot;%s %d: write_direct16(0x%08X, 0x%08X)\n&quot;, __FILE__, \</span>
<span class="cp">			__LINE__, (u32)(ofs), (u32)(val)); \</span>
<span class="cp">	_ipw_write16(ipw, ofs, val); \</span>
<span class="cp">} while (0)</span>

<span class="cm">/* 32-bit direct write (low 4K) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_ipw_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">ipw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ofs</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">hw_base</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 32-bit direct write (for low 4K of SRAM/regs), with debug wrapper */</span>
<span class="cp">#define ipw_write32(ipw, ofs, val) do { \</span>
<span class="cp">	IPW_DEBUG_IO(&quot;%s %d: write_direct32(0x%08X, 0x%08X)\n&quot;, __FILE__, \</span>
<span class="cp">			__LINE__, (u32)(ofs), (u32)(val)); \</span>
<span class="cp">	_ipw_write32(ipw, ofs, val); \</span>
<span class="cp">} while (0)</span>

<span class="cm">/* 8-bit direct read (low 4K) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">_ipw_read8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">ipw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">hw_base</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* alias to 8-bit direct read (low 4K of SRAM/regs), with debug wrapper */</span>
<span class="cp">#define ipw_read8(ipw, ofs) ({ \</span>
<span class="cp">	IPW_DEBUG_IO(&quot;%s %d: read_direct8(0x%08X)\n&quot;, __FILE__, __LINE__, \</span>
<span class="cp">			(u32)(ofs)); \</span>
<span class="cp">	_ipw_read8(ipw, ofs); \</span>
<span class="cp">})</span>

<span class="cm">/* 16-bit direct read (low 4K) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">_ipw_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">ipw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readw</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">hw_base</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* alias to 16-bit direct read (low 4K of SRAM/regs), with debug wrapper */</span>
<span class="cp">#define ipw_read16(ipw, ofs) ({ \</span>
<span class="cp">	IPW_DEBUG_IO(&quot;%s %d: read_direct16(0x%08X)\n&quot;, __FILE__, __LINE__, \</span>
<span class="cp">			(u32)(ofs)); \</span>
<span class="cp">	_ipw_read16(ipw, ofs); \</span>
<span class="cp">})</span>

<span class="cm">/* 32-bit direct read (low 4K) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_ipw_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">ipw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">hw_base</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* alias to 32-bit direct read (low 4K of SRAM/regs), with debug wrapper */</span>
<span class="cp">#define ipw_read32(ipw, ofs) ({ \</span>
<span class="cp">	IPW_DEBUG_IO(&quot;%s %d: read_direct32(0x%08X)\n&quot;, __FILE__, __LINE__, \</span>
<span class="cp">			(u32)(ofs)); \</span>
<span class="cp">	_ipw_read32(ipw, ofs); \</span>
<span class="cp">})</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">_ipw_read_indirect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="cm">/* alias to multi-byte read (SRAM/regs above 4K), with debug wrapper */</span>
<span class="cp">#define ipw_read_indirect(a, b, c, d) ({ \</span>
<span class="cp">	IPW_DEBUG_IO(&quot;%s %d: read_indirect(0x%08X) %u bytes\n&quot;, __FILE__, \</span>
<span class="cp">			__LINE__, (u32)(b), (u32)(d)); \</span>
<span class="cp">	_ipw_read_indirect(a, b, c, d); \</span>
<span class="cp">})</span>

<span class="cm">/* alias to multi-byte read (SRAM/regs above 4K), with debug wrapper */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">_ipw_write_indirect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">num</span><span class="p">);</span>
<span class="cp">#define ipw_write_indirect(a, b, c, d) do { \</span>
<span class="cp">	IPW_DEBUG_IO(&quot;%s %d: write_indirect(0x%08X) %u bytes\n&quot;, __FILE__, \</span>
<span class="cp">			__LINE__, (u32)(b), (u32)(d)); \</span>
<span class="cp">	_ipw_write_indirect(a, b, c, d); \</span>
<span class="cp">} while (0)</span>

<span class="cm">/* 32-bit indirect write (above 4K) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_ipw_write_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot; %p : reg = 0x%8X : value = 0x%8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_ADDR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_DATA</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 8-bit indirect write (above 4K) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_ipw_write_reg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">aligned_addr</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">IPW_INDIRECT_ADDR_MASK</span><span class="p">;</span>	<span class="cm">/* dword align */</span>
	<span class="n">u32</span> <span class="n">dif_len</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">-</span> <span class="n">aligned_addr</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot; reg = 0x%8X : value = 0x%8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_ADDR</span><span class="p">,</span> <span class="n">aligned_addr</span><span class="p">);</span>
	<span class="n">_ipw_write8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_DATA</span> <span class="o">+</span> <span class="n">dif_len</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 16-bit indirect write (above 4K) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_ipw_write_reg16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">aligned_addr</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">IPW_INDIRECT_ADDR_MASK</span><span class="p">;</span>	<span class="cm">/* dword align */</span>
	<span class="n">u32</span> <span class="n">dif_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">aligned_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x1ul</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot; reg = 0x%8X : value = 0x%8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_ADDR</span><span class="p">,</span> <span class="n">aligned_addr</span><span class="p">);</span>
	<span class="n">_ipw_write16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_DATA</span> <span class="o">+</span> <span class="n">dif_len</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 8-bit indirect read (above 4K) */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">_ipw_read_reg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">word</span><span class="p">;</span>
	<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_ADDR</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">IPW_INDIRECT_ADDR_MASK</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot; reg = 0x%8X :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">word</span> <span class="o">=</span> <span class="n">_ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_DATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 32-bit indirect read (above 4K) */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">_ipw_read_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot;%p : reg = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_ADDR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">_ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_DATA</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot; reg = 0x%4X : value = 0x%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* General purpose, no alignment requirement, iterative (multi-byte) read, */</span>
<span class="cm">/*    for area above 1st 4K of SRAM/reg space */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_ipw_read_indirect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">aligned_addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">IPW_INDIRECT_ADDR_MASK</span><span class="p">;</span>	<span class="cm">/* dword align */</span>
	<span class="n">u32</span> <span class="n">dif_len</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">aligned_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot;addr = %i, buf = %p, num = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the first dword (or portion) byte by byte */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dif_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_ADDR</span><span class="p">,</span> <span class="n">aligned_addr</span><span class="p">);</span>
		<span class="cm">/* Start reading at aligned_addr + dif_len */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dif_len</span><span class="p">;</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">num</span><span class="o">--</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">_ipw_read8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_DATA</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">aligned_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read all of the middle dwords as dwords, with auto-increment */</span>
	<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_AUTOINC_ADDR</span><span class="p">,</span> <span class="n">aligned_addr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">num</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">buf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">aligned_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">num</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">_ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_AUTOINC_DATA</span><span class="p">);</span>

	<span class="cm">/* Read the last dword (or portion) byte by byte */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">num</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_ADDR</span><span class="p">,</span> <span class="n">aligned_addr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">num</span><span class="o">--</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">ipw_read8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_DATA</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* General purpose, no alignment requirement, iterative (multi-byte) write, */</span>
<span class="cm">/*    for area above 1st 4K of SRAM/reg space */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_ipw_write_indirect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">aligned_addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">IPW_INDIRECT_ADDR_MASK</span><span class="p">;</span>	<span class="cm">/* dword align */</span>
	<span class="n">u32</span> <span class="n">dif_len</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">aligned_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot;addr = %i, buf = %p, num = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write the first dword (or portion) byte by byte */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dif_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_ADDR</span><span class="p">,</span> <span class="n">aligned_addr</span><span class="p">);</span>
		<span class="cm">/* Start writing at aligned_addr + dif_len */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dif_len</span><span class="p">;</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">num</span><span class="o">--</span><span class="p">,</span> <span class="n">buf</span><span class="o">++</span><span class="p">)</span>
			<span class="n">_ipw_write8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_DATA</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">aligned_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write all of the middle dwords as dwords, with auto-increment */</span>
	<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_AUTOINC_ADDR</span><span class="p">,</span> <span class="n">aligned_addr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">num</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">buf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">aligned_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">num</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_AUTOINC_DATA</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* Write the last dword (or portion) byte by byte */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">num</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_ADDR</span><span class="p">,</span> <span class="n">aligned_addr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">num</span><span class="o">--</span><span class="p">,</span> <span class="n">buf</span><span class="o">++</span><span class="p">)</span>
			<span class="n">_ipw_write8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INDIRECT_DATA</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* General purpose, no alignment requirement, iterative (multi-byte) write, */</span>
<span class="cm">/*    for 1st 4K of SRAM/regs space */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_write_direct</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy_toio</span><span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_base</span> <span class="o">+</span> <span class="n">addr</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set bit(s) in low 4K of SRAM/regs */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ipw_set_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Clear bit(s) in low 4K of SRAM/regs */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ipw_clear_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__ipw_enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INT_ENABLED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_INT_ENABLED</span><span class="p">;</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_MASK_R</span><span class="p">,</span> <span class="n">IPW_INTA_MASK_ALL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__ipw_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INT_ENABLED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_INT_ENABLED</span><span class="p">;</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_MASK_R</span><span class="p">,</span> <span class="o">~</span><span class="n">IPW_INTA_MASK_ALL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ipw_enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__ipw_enable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ipw_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__ipw_disable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ipw_error_desc</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_OK</span>:
		<span class="k">return</span> <span class="s">&quot;ERROR_OK&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_FAIL</span>:
		<span class="k">return</span> <span class="s">&quot;ERROR_FAIL&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_MEMORY_UNDERFLOW</span>:
		<span class="k">return</span> <span class="s">&quot;MEMORY_UNDERFLOW&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_MEMORY_OVERFLOW</span>:
		<span class="k">return</span> <span class="s">&quot;MEMORY_OVERFLOW&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_BAD_PARAM</span>:
		<span class="k">return</span> <span class="s">&quot;BAD_PARAM&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_BAD_CHECKSUM</span>:
		<span class="k">return</span> <span class="s">&quot;BAD_CHECKSUM&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_NMI_INTERRUPT</span>:
		<span class="k">return</span> <span class="s">&quot;NMI_INTERRUPT&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_BAD_DATABASE</span>:
		<span class="k">return</span> <span class="s">&quot;BAD_DATABASE&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_ALLOC_FAIL</span>:
		<span class="k">return</span> <span class="s">&quot;ALLOC_FAIL&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_DMA_UNDERRUN</span>:
		<span class="k">return</span> <span class="s">&quot;DMA_UNDERRUN&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_DMA_STATUS</span>:
		<span class="k">return</span> <span class="s">&quot;DMA_STATUS&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_DINO_ERROR</span>:
		<span class="k">return</span> <span class="s">&quot;DINO_ERROR&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_EEPROM_ERROR</span>:
		<span class="k">return</span> <span class="s">&quot;EEPROM_ERROR&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_SYSASSERT</span>:
		<span class="k">return</span> <span class="s">&quot;SYSASSERT&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_FW_ERROR_FATAL_ERROR</span>:
		<span class="k">return</span> <span class="s">&quot;FATAL_ERROR&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="s">&quot;UNKNOWN_ERROR&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_dump_error_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ipw_fw_error</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Error allocating and capturing error log.  &quot;</span>
			  <span class="s">&quot;Nothing to dump.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Start IPW Error Log Dump:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Status: 0x%08X, Config: %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">error</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">elem_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;%s %i 0x%08x  0x%08x  0x%08x  0x%08x  0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ipw_error_desc</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">),</span>
			  <span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">time</span><span class="p">,</span>
			  <span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blink1</span><span class="p">,</span>
			  <span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blink2</span><span class="p">,</span>
			  <span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">link1</span><span class="p">,</span>
			  <span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">link2</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">log_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;%i</span><span class="se">\t</span><span class="s">0x%08x</span><span class="se">\t</span><span class="s">%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">error</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">time</span><span class="p">,</span>
			  <span class="n">error</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ipw_is_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INIT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_get_ordinal</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ord</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">field_info</span><span class="p">,</span> <span class="n">field_len</span><span class="p">,</span> <span class="n">field_count</span><span class="p">,</span> <span class="n">total_len</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;ordinal = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ord</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span> <span class="o">||</span> <span class="o">!</span><span class="n">val</span> <span class="o">||</span> <span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;Invalid argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* verify device ordinal tables have been initialized */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">table0_addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">table1_addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">table2_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;Access ordinals before initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">IPW_ORD_TABLE_ID_MASK</span> <span class="o">&amp;</span> <span class="n">ord</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPW_ORD_TABLE_0_MASK</span>:
		<span class="cm">/*</span>
<span class="cm">		 * TABLE 0: Direct access to a table of 32 bit values</span>
<span class="cm">		 *</span>
<span class="cm">		 * This is a very simple table with the data directly</span>
<span class="cm">		 * read from the table</span>
<span class="cm">		 */</span>

		<span class="cm">/* remove the table id from the ordinal */</span>
		<span class="n">ord</span> <span class="o">&amp;=</span> <span class="n">IPW_ORD_TABLE_VALUE_MASK</span><span class="p">;</span>

		<span class="cm">/* boundary check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ord</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table0_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;ordinal value (%i) longer then &quot;</span>
				      <span class="s">&quot;max (%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ord</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table0_len</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* verify we have enough room to store the value */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;ordinal buffer length too small, &quot;</span>
				      <span class="s">&quot;need %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;Reading TABLE0[%i] from offset 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ord</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table0_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ord</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">ord</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">)</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table0_addr</span> <span class="o">+</span> <span class="n">ord</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IPW_ORD_TABLE_1_MASK</span>:
		<span class="cm">/*</span>
<span class="cm">		 * TABLE 1: Indirect access to a table of 32 bit values</span>
<span class="cm">		 *</span>
<span class="cm">		 * This is a fairly large table of u32 values each</span>
<span class="cm">		 * representing starting addr for the data (which is</span>
<span class="cm">		 * also a u32)</span>
<span class="cm">		 */</span>

		<span class="cm">/* remove the table id from the ordinal */</span>
		<span class="n">ord</span> <span class="o">&amp;=</span> <span class="n">IPW_ORD_TABLE_VALUE_MASK</span><span class="p">;</span>

		<span class="cm">/* boundary check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ord</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table1_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;ordinal value too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* verify we have enough room to store the value */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;ordinal buffer length too small, &quot;</span>
				      <span class="s">&quot;need %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">)</span> <span class="o">=</span>
		    <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">table1_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ord</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)));</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IPW_ORD_TABLE_2_MASK</span>:
		<span class="cm">/*</span>
<span class="cm">		 * TABLE 2: Indirect access to a table of variable sized values</span>
<span class="cm">		 *</span>
<span class="cm">		 * This table consist of six values, each containing</span>
<span class="cm">		 *     - dword containing the starting offset of the data</span>
<span class="cm">		 *     - dword containing the lengh in the first 16bits</span>
<span class="cm">		 *       and the count in the second 16bits</span>
<span class="cm">		 */</span>

		<span class="cm">/* remove the table id from the ordinal */</span>
		<span class="n">ord</span> <span class="o">&amp;=</span> <span class="n">IPW_ORD_TABLE_VALUE_MASK</span><span class="p">;</span>

		<span class="cm">/* boundary check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ord</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table2_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;ordinal value too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get the address of statistic */</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table2_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ord</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>

		<span class="cm">/* get the second DW of statistics ;</span>
<span class="cm">		 * two 16-bit words - first is length, second is count */</span>
		<span class="n">field_info</span> <span class="o">=</span>
		    <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table2_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ord</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

		<span class="cm">/* get each entry length */</span>
		<span class="n">field_len</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">field_info</span><span class="p">);</span>

		<span class="cm">/* get number of entries */</span>
		<span class="n">field_count</span> <span class="o">=</span> <span class="o">*</span><span class="p">(((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">field_info</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* abort if not enough memory */</span>
		<span class="n">total_len</span> <span class="o">=</span> <span class="n">field_len</span> <span class="o">*</span> <span class="n">field_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total_len</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">total_len</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">total_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">total_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;addr = 0x%08x, total_len = %i, &quot;</span>
			      <span class="s">&quot;field_info = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">addr</span><span class="p">,</span> <span class="n">total_len</span><span class="p">,</span> <span class="n">field_info</span><span class="p">);</span>
		<span class="n">ipw_read_indirect</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">total_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;Invalid ordinal!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_init_ordinals</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">table0_addr</span> <span class="o">=</span> <span class="n">IPW_ORDINALS_TABLE_LOWER</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">table0_len</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table0_addr</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;table 0 offset at 0x%08x, len = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table0_addr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table0_len</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">table1_addr</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORDINALS_TABLE_1</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">table1_len</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table1_addr</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;table 1 offset at 0x%08x, len = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table1_addr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table1_len</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">table2_addr</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORDINALS_TABLE_2</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">table2_len</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table2_addr</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">table2_len</span> <span class="o">&amp;=</span> <span class="mh">0x0000ffff</span><span class="p">;</span>	<span class="cm">/* use first two bytes */</span>

	<span class="n">IPW_DEBUG_ORD</span><span class="p">(</span><span class="s">&quot;table 2 offset at 0x%08x, len = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table2_addr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">table2_len</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ipw_register_toggle</span><span class="p">(</span><span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPW_START_STANDBY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">IPW_GATE_ODMA</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPW_GATE_ODMA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">IPW_GATE_IDMA</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPW_GATE_IDMA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">IPW_GATE_ADMA</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPW_GATE_ADMA</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LED behavior:</span>
<span class="cm"> * - On radio ON, turn on any LEDs that require to be on during start</span>
<span class="cm"> * - On initialization, start unassociated blink</span>
<span class="cm"> * - On association, disable unassociated blink</span>
<span class="cm"> * - On disassociation, start unassociated blink</span>
<span class="cm"> * - On radio OFF, turn off any LEDs started during radio on</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#define LD_TIME_LINK_ON msecs_to_jiffies(300)</span>
<span class="cp">#define LD_TIME_LINK_OFF msecs_to_jiffies(2700)</span>
<span class="cp">#define LD_TIME_ACT_ON msecs_to_jiffies(250)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_led_link_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">led</span><span class="p">;</span>

	<span class="cm">/* If configured to not use LEDs, or nic_type is 1,</span>
<span class="cm">	 * then we don&#39;t toggle a LINK led */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_NO_LED</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nic_type</span> <span class="o">==</span> <span class="n">EEPROM_NIC_TYPE_1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_LED_LINK_ON</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Link LED On</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">led</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_REG</span><span class="p">);</span>
		<span class="n">led</span> <span class="o">|=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_association_on</span><span class="p">;</span>

		<span class="n">led</span> <span class="o">=</span> <span class="n">ipw_register_toggle</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>

		<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Reg: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>
		<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_REG</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_LED_LINK_ON</span><span class="p">;</span>

		<span class="cm">/* If we aren&#39;t associated, schedule turning the LED off */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_link_off</span><span class="p">,</span>
					      <span class="n">LD_TIME_LINK_ON</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_led_link_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">led_link_on</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_led_link_on</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_led_link_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">led</span><span class="p">;</span>

	<span class="cm">/* If configured not to use LEDs, or nic type is 1,</span>
<span class="cm">	 * then we don&#39;t goggle the LINK led. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_NO_LED</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nic_type</span> <span class="o">==</span> <span class="n">EEPROM_NIC_TYPE_1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_LED_LINK_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_REG</span><span class="p">);</span>
		<span class="n">led</span> <span class="o">&amp;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_association_off</span><span class="p">;</span>
		<span class="n">led</span> <span class="o">=</span> <span class="n">ipw_register_toggle</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>

		<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Reg: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>
		<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_REG</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>

		<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Link LED Off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_LED_LINK_ON</span><span class="p">;</span>

		<span class="cm">/* If we aren&#39;t associated and the radio is on, schedule</span>
<span class="cm">		 * turning the LED on (blink while unassociated) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_link_on</span><span class="p">,</span>
					      <span class="n">LD_TIME_LINK_OFF</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_led_link_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">led_link_off</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_led_link_off</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ipw_led_activity_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">led</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_NO_LED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_LED_ACT_ON</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">led</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_REG</span><span class="p">);</span>
		<span class="n">led</span> <span class="o">|=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_activity_on</span><span class="p">;</span>

		<span class="n">led</span> <span class="o">=</span> <span class="n">ipw_register_toggle</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>

		<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Reg: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>
		<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_REG</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>

		<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Activity LED On</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_LED_ACT_ON</span><span class="p">;</span>

		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_act_off</span><span class="p">);</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_act_off</span><span class="p">,</span> <span class="n">LD_TIME_ACT_ON</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Reschedule LED off for full time period */</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_act_off</span><span class="p">);</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_act_off</span><span class="p">,</span> <span class="n">LD_TIME_ACT_ON</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">void ipw_led_activity_on(struct ipw_priv *priv)</span>
<span class="c">{</span>
<span class="c">	unsigned long flags;</span>
<span class="c">	spin_lock_irqsave(&amp;priv-&gt;lock, flags);</span>
<span class="c">	__ipw_led_activity_on(priv);</span>
<span class="c">	spin_unlock_irqrestore(&amp;priv-&gt;lock, flags);</span>
<span class="c">}</span>
<span class="cp">#endif  /*  0  */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_led_activity_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">led</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_NO_LED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_LED_ACT_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_REG</span><span class="p">);</span>
		<span class="n">led</span> <span class="o">&amp;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_activity_off</span><span class="p">;</span>

		<span class="n">led</span> <span class="o">=</span> <span class="n">ipw_register_toggle</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>

		<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Reg: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>
		<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_REG</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>

		<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Activity LED Off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_LED_ACT_ON</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_led_activity_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">led_act_off</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_led_activity_off</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_led_band_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">led</span><span class="p">;</span>

	<span class="cm">/* Only nic type 1 supports mode LEDs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_NO_LED</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nic_type</span> <span class="o">!=</span> <span class="n">EEPROM_NIC_TYPE_1</span> <span class="o">||</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">led</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led</span> <span class="o">|=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_ofdm_on</span><span class="p">;</span>
		<span class="n">led</span> <span class="o">&amp;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_association_off</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Mode LED On: 802.11a</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led</span> <span class="o">|=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_ofdm_on</span><span class="p">;</span>
		<span class="n">led</span> <span class="o">|=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_association_on</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Mode LED On: 802.11g</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">led</span> <span class="o">&amp;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_ofdm_off</span><span class="p">;</span>
		<span class="n">led</span> <span class="o">|=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_association_on</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Mode LED On: 802.11b</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">led</span> <span class="o">=</span> <span class="n">ipw_register_toggle</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Reg: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>
	<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_REG</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_led_band_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">led</span><span class="p">;</span>

	<span class="cm">/* Only nic type 1 supports mode LEDs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_NO_LED</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nic_type</span> <span class="o">!=</span> <span class="n">EEPROM_NIC_TYPE_1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">led</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_REG</span><span class="p">);</span>
	<span class="n">led</span> <span class="o">&amp;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_ofdm_off</span><span class="p">;</span>
	<span class="n">led</span> <span class="o">&amp;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_association_off</span><span class="p">;</span>

	<span class="n">led</span> <span class="o">=</span> <span class="n">ipw_register_toggle</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Reg: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>
	<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_REG</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_led_radio_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipw_led_link_on</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_led_radio_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipw_led_activity_off</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw_led_link_off</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_led_link_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set the Link Led on for all nic types */</span>
	<span class="n">ipw_led_link_on</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_led_link_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipw_led_activity_off</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw_led_link_off</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">)</span>
		<span class="n">ipw_led_radio_off</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_led_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nic_type</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">EEPROM_NIC_TYPE</span><span class="p">];</span>

	<span class="cm">/* Set the default PINs for the link and activity leds */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_activity_on</span> <span class="o">=</span> <span class="n">IPW_ACTIVITY_LED</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_activity_off</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">IPW_ACTIVITY_LED</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_association_on</span> <span class="o">=</span> <span class="n">IPW_ASSOCIATED_LED</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_association_off</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">IPW_ASSOCIATED_LED</span><span class="p">);</span>

	<span class="cm">/* Set the default PINs for the OFDM leds */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_ofdm_on</span> <span class="o">=</span> <span class="n">IPW_OFDM_LED</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_ofdm_off</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">IPW_OFDM_LED</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nic_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EEPROM_NIC_TYPE_1</span>:
		<span class="cm">/* In this NIC type, the LEDs are reversed.... */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_activity_on</span> <span class="o">=</span> <span class="n">IPW_ASSOCIATED_LED</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_activity_off</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">IPW_ASSOCIATED_LED</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_association_on</span> <span class="o">=</span> <span class="n">IPW_ACTIVITY_LED</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_association_off</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">IPW_ACTIVITY_LED</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_NO_LED</span><span class="p">))</span>
			<span class="n">ipw_led_band_on</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="cm">/* And we don&#39;t blink link LEDs for this nic, so</span>
<span class="cm">		 * just return here */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EEPROM_NIC_TYPE_3</span>:
	<span class="k">case</span> <span class="n">EEPROM_NIC_TYPE_2</span>:
	<span class="k">case</span> <span class="n">EEPROM_NIC_TYPE_4</span>:
	<span class="k">case</span> <span class="n">EEPROM_NIC_TYPE_0</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Unknown NIC type from EEPROM: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nic_type</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nic_type</span> <span class="o">=</span> <span class="n">EEPROM_NIC_TYPE_0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_NO_LED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span>
			<span class="n">ipw_led_link_on</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ipw_led_link_off</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_led_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipw_led_activity_off</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw_led_link_off</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw_led_band_off</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_link_on</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_link_off</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_act_off</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The following adds a new attribute to the sysfs representation</span>
<span class="cm"> * of this device driver (i.e. a new file in /sys/bus/pci/drivers/ipw/)</span>
<span class="cm"> * used for controlling the debug level.</span>
<span class="cm"> *</span>
<span class="cm"> * See the level definitions in ipw for details.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_debug_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ipw_debug_level</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_debug_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span><span class="p">)</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">buf</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: %s is not in hex or decimal form.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ipw_debug_level</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">show_debug_level</span><span class="p">,</span> <span class="n">store_debug_level</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">ipw_get_event_log_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* length = 1st dword in log */</span>
	<span class="k">return</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_LOG</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_capture_event_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">log_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_event</span> <span class="o">*</span><span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">log_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EVENT_LOG</span><span class="p">);</span>
		<span class="n">ipw_read_indirect</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
				  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">log</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">log</span><span class="p">)</span> <span class="o">*</span> <span class="n">log_len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipw_fw_error</span> <span class="o">*</span><span class="nf">ipw_alloc_error_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_fw_error</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">log_len</span> <span class="o">=</span> <span class="n">ipw_get_event_log_len</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">base</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ERROR_LOG</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">elem_len</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">)</span> <span class="o">*</span> <span class="n">elem_len</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">)</span> <span class="o">*</span> <span class="n">log_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Memory allocation for firmware error log &quot;</span>
			  <span class="s">&quot;failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">elem_len</span> <span class="o">=</span> <span class="n">elem_len</span><span class="p">;</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">log_len</span> <span class="o">=</span> <span class="n">log_len</span><span class="p">;</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipw_error_elem</span> <span class="o">*</span><span class="p">)</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">;</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">log</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipw_event</span> <span class="o">*</span><span class="p">)(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span> <span class="o">+</span> <span class="n">elem_len</span><span class="p">);</span>

	<span class="n">ipw_capture_event_log</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">log_len</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">elem_len</span><span class="p">)</span>
		<span class="n">ipw_read_indirect</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">base</span><span class="p">),</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">)</span> <span class="o">*</span> <span class="n">elem_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_event_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">log_len</span> <span class="o">=</span> <span class="n">ipw_get_event_log_len</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">log_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_event</span> <span class="o">*</span><span class="n">log</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* not using min() because of its strict type checking */</span>
	<span class="n">log_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">log</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">log_len</span> <span class="o">?</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">log</span><span class="p">)</span> <span class="o">*</span> <span class="n">log_len</span> <span class="o">:</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">log</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">log_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">log</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to allocate memory for log</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">log_len</span> <span class="o">=</span> <span class="n">log_size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">log</span><span class="p">);</span>
	<span class="n">ipw_capture_event_log</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">log_len</span><span class="p">,</span> <span class="n">log</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%08X&quot;</span><span class="p">,</span> <span class="n">log_len</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">log_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s">%08X%08X%08X&quot;</span><span class="p">,</span>
				<span class="n">log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">time</span><span class="p">,</span> <span class="n">log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">event</span><span class="p">,</span> <span class="n">log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">log</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">event_log</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_event_log</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;%08lX%08X%08X%08X&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">jiffies</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">elem_len</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">elem_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s">%08X%08X%08X%08X%08X%08X%08X&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">time</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blink1</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blink2</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">link1</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">link2</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">%08X&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">log_len</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">log_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s">%08X%08X%08X&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">time</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">event</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">clear_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_error</span><span class="p">,</span> <span class="n">clear_error</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_cmd_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog_len</span><span class="p">;</span>
	     <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog_pos</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
	     <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span>
		    <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			     <span class="s">&quot;</span><span class="se">\n</span><span class="s">%08lX%08X%08X%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jiffies</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">retcode</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span>
		    <span class="n">snprintk_buf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">,</span>
				 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">cmd_log</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_cmd_log</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw_prom_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw_prom_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_rtap_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtap_iface</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;Interface is up.  Cannot unregister.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ipw_prom_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">rtap_iface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rtap_iface</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_prom_alloc</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">rtap_iface</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to register promiscuous network &quot;</span>
			  <span class="s">&quot;device (error %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_rtap_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtap_iface</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;1&#39;</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">rtap_iface</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">show_rtap_iface</span><span class="p">,</span>
		   <span class="n">store_rtap_iface</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_rtap_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Attempting to set filter without &quot;</span>
			  <span class="s">&quot;rtap_iface enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_priv</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Setting rtap filter to &quot;</span> <span class="n">BIT_FMT16</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">BIT_ARG16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_priv</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_rtap_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%04X&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_priv</span> <span class="o">?</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_priv</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">rtap_filter</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">show_rtap_filter</span><span class="p">,</span>
		   <span class="n">store_rtap_filter</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_scan_age</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_scan_age</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;00000000&quot;</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">count</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span><span class="p">)</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: user supplied invalid value.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;set scan_age = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">scan_age</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_scan_age</span><span class="p">,</span> <span class="n">store_scan_age</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_NO_LED</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Disabling LED control.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_NO_LED</span><span class="p">;</span>
		<span class="n">ipw_led_shutdown</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_LED</span><span class="p">(</span><span class="s">&quot;Enabling LED control.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_NO_LED</span><span class="p">;</span>
		<span class="n">ipw_led_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_led</span><span class="p">,</span> <span class="n">store_led</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_cfg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_nic_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;TYPE: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nic_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">nic_type</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_nic_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_ucode_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_get_ordinal</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_UCODE_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ucode_version</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_ucode_version</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_rtc</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_get_ordinal</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_RTC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_rtc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Add a device attribute to view/control the delay between eeprom</span>
<span class="cm"> * operations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_eeprom_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">eeprom_delay</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_eeprom_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">eeprom_delay</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">eeprom_delay</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">show_eeprom_delay</span><span class="p">,</span> <span class="n">store_eeprom_delay</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_command_event_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">IPW_INTERNAL_CMD_EVENT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_command_event_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">IPW_INTERNAL_CMD_EVENT</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">command_event_reg</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">show_command_event_reg</span><span class="p">,</span> <span class="n">store_command_event_reg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_mem_gpio_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x301100</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_mem_gpio_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x301100</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">mem_gpio_reg</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">show_mem_gpio_reg</span><span class="p">,</span> <span class="n">store_mem_gpio_reg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_indirect_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INDIRECT_DWORD</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">indirect_dword</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_indirect_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">indirect_dword</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_INDIRECT_DWORD</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">indirect_dword</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">show_indirect_dword</span><span class="p">,</span> <span class="n">store_indirect_dword</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_indirect_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INDIRECT_BYTE</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">ipw_read_reg8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">indirect_byte</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_indirect_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">indirect_byte</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_INDIRECT_BYTE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">indirect_byte</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">show_indirect_byte</span><span class="p">,</span> <span class="n">store_indirect_byte</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_direct_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_DIRECT_DWORD</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">direct_dword</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_direct_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">direct_dword</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_DIRECT_DWORD</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">direct_dword</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">show_direct_dword</span><span class="p">,</span> <span class="n">store_direct_dword</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rf_kill_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_RF_KILL_HW</span><span class="p">;</span>
		<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_RF_KILL_HW</span><span class="p">;</span>
		<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_HW</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_rf_kill</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* 0 - RF kill not enabled</span>
<span class="cm">	   1 - SW based RF kill active (sysfs)</span>
<span class="cm">	   2 - HW based RF kill active</span>
<span class="cm">	   3 - Both HW and SW baed RF kill active */</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_SW</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x1</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">rf_kill_active</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x2</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_radio_kill_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">disable_radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">disable_radio</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span>
	    <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_SW</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_RF_KILL</span><span class="p">(</span><span class="s">&quot;Manual SW RF Kill set to: RADIO  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">disable_radio</span> <span class="o">?</span> <span class="s">&quot;OFF&quot;</span> <span class="o">:</span> <span class="s">&quot;ON&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable_radio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_RF_KILL_SW</span><span class="p">;</span>

		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">);</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_direct_scan</span><span class="p">);</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_passive_scan</span><span class="p">);</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_RF_KILL_SW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rf_kill_active</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_RF_KILL</span><span class="p">(</span><span class="s">&quot;Can not turn radio back on - &quot;</span>
					  <span class="s">&quot;disabled by HW switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Make sure the RF_KILL check timer is running */</span>
			<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">);</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">,</span>
					      <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_rf_kill</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">ipw_radio_kill_sw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;1&#39;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">rf_kill</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_rf_kill</span><span class="p">,</span> <span class="n">store_rf_kill</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_speed_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_SPEED_SCAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed_scan</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">],</span> <span class="s">&quot;%d &quot;</span><span class="p">,</span>
				       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed_scan</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">len</span> <span class="o">+</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">],</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_speed_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* list of space separated channels to scan, optionally ending with 0 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">channel</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="n">MAX_SPEED_SCAN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed_scan</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">libipw_is_valid_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">channel</span><span class="p">))</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed_scan</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;Skipping invalid channel request: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">channel</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\t&#39;</span><span class="p">)</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_SPEED_SCAN</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed_scan_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_SPEED_SCAN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">speed_scan</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_speed_scan</span><span class="p">,</span>
		   <span class="n">store_speed_scan</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_net_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_NET_STATS</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_net_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;1&#39;</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_NET_STATS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_NET_STATS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">net_stats</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">show_net_stats</span><span class="p">,</span> <span class="n">store_net_stats</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">libipw_geo</span> <span class="o">*</span><span class="n">geo</span> <span class="o">=</span> <span class="n">libipw_get_geo</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">],</span>
		      <span class="s">&quot;Displaying %d channels in 2.4Ghz band &quot;</span>
		      <span class="s">&quot;(802.11bg):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">],</span> <span class="s">&quot;%d: BSS%s%s, %s, Band %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">,</span>
			       <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_RADAR_DETECT</span> <span class="o">?</span>
			       <span class="s">&quot; (radar spectrum)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_NO_IBSS</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_RADAR_DETECT</span><span class="p">))</span>
			       <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;, IBSS&quot;</span><span class="p">,</span>
			       <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span> <span class="o">?</span>
			       <span class="s">&quot;passive only&quot;</span> <span class="o">:</span> <span class="s">&quot;active/passive&quot;</span><span class="p">,</span>
			       <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_B_ONLY</span> <span class="o">?</span>
			       <span class="s">&quot;B&quot;</span> <span class="o">:</span> <span class="s">&quot;B/G&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">],</span>
		       <span class="s">&quot;Displaying %d channels in 5.2Ghz band &quot;</span>
		       <span class="s">&quot;(802.11a):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a_channels</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">],</span> <span class="s">&quot;%d: BSS%s%s, %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">,</span>
			       <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_RADAR_DETECT</span> <span class="o">?</span>
			       <span class="s">&quot; (radar spectrum)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_NO_IBSS</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_RADAR_DETECT</span><span class="p">))</span>
			       <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;, IBSS&quot;</span><span class="p">,</span>
			       <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span> <span class="o">?</span>
			       <span class="s">&quot;passive only&quot;</span> <span class="o">:</span> <span class="s">&quot;active/passive&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">show_channels</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">notify_wx_assoc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_irq_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">inta</span><span class="p">,</span> <span class="n">inta_mask</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">inta</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_RW</span><span class="p">);</span>
	<span class="n">inta_mask</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_MASK_R</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Hardware disappeared */</span>
		<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;TASKLET INTA == 0xFFFFFFFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Only handle the cached INTA values */</span>
		<span class="n">inta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">inta</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">IPW_INTA_MASK_ALL</span> <span class="o">&amp;</span> <span class="n">inta_mask</span><span class="p">);</span>

	<span class="cm">/* Add any cached INTA values that need to be handled */</span>
	<span class="n">inta</span> <span class="o">|=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">isr_inta</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* handle all the justifications for the interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_RX_TRANSFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipw_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_RX_TRANSFER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_TX_CMD_QUEUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Command completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_queue_tx_reclaim</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_cmd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_HCMD_ACTIVE</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_TX_CMD_QUEUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_TX_QUEUE_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;TX_QUEUE_1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_queue_tx_reclaim</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_TX_QUEUE_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_TX_QUEUE_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;TX_QUEUE_2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_queue_tx_reclaim</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_TX_QUEUE_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_TX_QUEUE_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;TX_QUEUE_3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_queue_tx_reclaim</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_TX_QUEUE_3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_TX_QUEUE_4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;TX_QUEUE_4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_queue_tx_reclaim</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_TX_QUEUE_4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_STATUS_CHANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;STATUS_CHANGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_STATUS_CHANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_BEACON_PERIOD_EXPIRED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;TX_PERIOD_EXPIRED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_BEACON_PERIOD_EXPIRED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_SLAVE_MODE_HOST_CMD_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;HOST_CMD_DONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_SLAVE_MODE_HOST_CMD_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_FW_INITIALIZATION_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;FW_INITIALIZATION_DONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_FW_INITIALIZATION_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_FW_CARD_DISABLE_PHY_OFF_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;PHY_OFF_DONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_FW_CARD_DISABLE_PHY_OFF_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_RF_KILL_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_RF_KILL</span><span class="p">(</span><span class="s">&quot;RF_KILL_DONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_RF_KILL_HW</span><span class="p">;</span>
		<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">);</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">);</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_direct_scan</span><span class="p">);</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_passive_scan</span><span class="p">);</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_down</span><span class="p">);</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_RF_KILL_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_FATAL_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;Firmware error detected.  Restarting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;Sysfs &#39;error&#39; log already exists.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipw_debug_level</span> <span class="o">&amp;</span> <span class="n">IPW_DL_FW_ERRORS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ipw_fw_error</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span>
				    <span class="n">ipw_alloc_error_log</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
				<span class="n">ipw_dump_error_log</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">ipw_alloc_error_log</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
				<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;Sysfs &#39;error&#39; log captured.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;Error allocating sysfs &#39;error&#39; &quot;</span>
					     <span class="s">&quot;log.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipw_debug_level</span> <span class="o">&amp;</span> <span class="n">IPW_DL_FW_ERRORS</span><span class="p">)</span>
				<span class="n">ipw_dump_error_log</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* XXX: If hardware encryption is for WPA/WPA2,</span>
<span class="cm">		 * we have to notify the supplicant. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">encrypt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_ASSOCIATED</span><span class="p">;</span>
			<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Keep the restart process from trying to send host</span>
<span class="cm">		 * commands by clearing the INIT status bit */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_INIT</span><span class="p">;</span>

		<span class="cm">/* Cancel currently queued command. */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_HCMD_ACTIVE</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>

		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_restart</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_FATAL_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_PARITY_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">IPW_INTA_BIT_PARITY_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">handled</span> <span class="o">!=</span> <span class="n">inta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unhandled INTA bits 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inta</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">handled</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* enable all interrupts */</span>
	<span class="n">ipw_enable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define IPW_CMD(x) case IPW_CMD_ ## x : return #x</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_cmd_string</span><span class="p">(</span><span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">HOST_COMPLETE</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">POWER_DOWN</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">SYSTEM_CONFIG</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">MULTICAST_ADDRESS</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">SSID</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">ADAPTER_ADDRESS</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">PORT_TYPE</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">RTS_THRESHOLD</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">FRAG_THRESHOLD</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">POWER_MODE</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">WEP_KEY</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">TGI_TX_KEY</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">SCAN_REQUEST</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">SCAN_REQUEST_EXT</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">ASSOCIATE</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">SUPPORTED_RATES</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">SCAN_ABORT</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">TX_FLUSH</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">QOS_PARAMETERS</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">DINO_CONFIG</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">RSN_CAPABILITIES</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">RX_KEY</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">CARD_DISABLE</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">SEED_NUMBER</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">TX_POWER</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">COUNTRY_INFO</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">AIRONET_INFO</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">AP_TX_POWER</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">CCKM_INFO</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">CCX_VER_INFO</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">SET_CALIBRATION</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">SENSITIVITY_CALIB</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">RETRY_LIMIT</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">IPW_PRE_POWER_DOWN</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">VAP_BEACON_TEMPLATE</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">VAP_DTIM_PERIOD</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">EXT_SUPPORTED_RATES</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">VAP_LOCAL_TX_PWR_CONSTRAINT</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">VAP_QUIET_INTERVALS</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">VAP_CHANNEL_SWITCH</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">VAP_MANDATORY_CHANNELS</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">VAP_CELL_PWR_LIMIT</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">VAP_CF_PARAM_SET</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">VAP_SET_BEACONING_STATE</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">MEASUREMENT</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">POWER_CAPABILITY</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">SUPPORTED_CHANNELS</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">TPC_REPORT</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">WME_INFO</span><span class="p">);</span>
		<span class="n">IPW_CMD</span><span class="p">(</span><span class="n">PRODUCTION_COMMAND</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define HOST_COMPLETE_TIMEOUT HZ</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ipw_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">host_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_HCMD_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to send %s: Already sending a command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">get_cmd_string</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_HCMD_ACTIVE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog_pos</span><span class="p">].</span><span class="n">jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog_pos</span><span class="p">].</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog_pos</span><span class="p">].</span><span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog_pos</span><span class="p">].</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog_pos</span><span class="p">].</span><span class="n">retcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;%s command (#%d) %d bytes: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">get_cmd_string</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
		     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

<span class="cp">#ifndef DEBUG_CMD_WEP_KEY</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">IPW_CMD_WEP_KEY</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;WEP_KEY command masked out for secure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">printk_buf</span><span class="p">(</span><span class="n">IPW_DL_HOST_COMMAND</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_queue_tx_hcmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_HCMD_ACTIVE</span><span class="p">;</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to send %s: Reason %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">get_cmd_string</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">),</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">HOST_COMPLETE_TIMEOUT</span><span class="p">;</span>
<span class="nl">again:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">,</span>
					      <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span>
						<span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_HCMD_ACTIVE</span><span class="p">),</span>
					      <span class="n">end</span> <span class="o">-</span> <span class="n">now</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_HCMD_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to send %s: Command timed out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">get_cmd_string</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_HCMD_ACTIVE</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_HW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to send %s: Aborted due to RF kill switch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">get_cmd_string</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog_pos</span><span class="o">++</span><span class="p">].</span><span class="n">retcode</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog_pos</span> <span class="o">%=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_cmd_simple</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">command</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">__ipw_send_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_cmd_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">command</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">command</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">,</span>
		<span class="p">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">__ipw_send_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_host_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_simple</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_HOST_COMPLETE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_system_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_SYSTEM_CONFIG</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_ssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">ssid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span> <span class="o">||</span> <span class="o">!</span><span class="n">ssid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_SSID</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">),</span>
				<span class="n">ssid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_adapter_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span> <span class="o">||</span> <span class="o">!</span><span class="n">mac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Setting MAC to %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_ADAPTER_ADDRESS</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_adapter_restart</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ipw_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">))</span>
		<span class="n">ipw_remove_current_network</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_up</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to up device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_adapter_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">adapter_restart</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_adapter_restart</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw_abort_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>

<span class="cp">#define IPW_SCAN_CHECK_WATCHDOG	(5 * HZ)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_scan_check</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCAN_ABORTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Scan completion watchdog resetting &quot;</span>
			       <span class="s">&quot;adapter after (%dms).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">IPW_SCAN_CHECK_WATCHDOG</span><span class="p">));</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_restart</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCANNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Scan completion watchdog aborting scan &quot;</span>
			       <span class="s">&quot;after (%dms).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">IPW_SCAN_CHECK_WATCHDOG</span><span class="p">));</span>
		<span class="n">ipw_abort_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_check</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_scan_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">scan_check</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_scan_check</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_scan_request_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ipw_scan_request_ext</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_SCAN_REQUEST_EXT</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">),</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_scan_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_simple</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_SCAN_ABORT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_set_sensitivity</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sens</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_sensitivity_calib</span> <span class="n">calib</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">beacon_rssi_raw</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sens</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_SENSITIVITY_CALIB</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">calib</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">calib</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_associate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ipw_associate</span> <span class="o">*</span><span class="n">associate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span> <span class="o">||</span> <span class="o">!</span><span class="n">associate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_ASSOCIATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">associate</span><span class="p">),</span>
				<span class="n">associate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_supported_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ipw_supported_rates</span> <span class="o">*</span><span class="n">rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span> <span class="o">||</span> <span class="o">!</span><span class="n">rates</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_SUPPORTED_RATES</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rates</span><span class="p">),</span>
				<span class="n">rates</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_set_random_seed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_SEED_NUMBER</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_card_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phy_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">phy_off</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_CARD_DISABLE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_tx_power</span> <span class="o">*</span><span class="n">power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span> <span class="o">||</span> <span class="o">!</span><span class="n">power</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_TX_POWER</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">power</span><span class="p">),</span> <span class="n">power</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_set_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">libipw_geo</span> <span class="o">*</span><span class="n">geo</span> <span class="o">=</span> <span class="n">libipw_get_geo</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipw_tx_power</span> <span class="n">tx_power</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">max_power</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_power</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_power</span><span class="p">));</span>

	<span class="cm">/* configure device for &#39;G&#39; band */</span>
	<span class="n">tx_power</span><span class="p">.</span><span class="n">ieee_mode</span> <span class="o">=</span> <span class="n">IPW_G_MODE</span><span class="p">;</span>
	<span class="n">tx_power</span><span class="p">.</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_power</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_power</span><span class="p">;</span>
		<span class="n">tx_power</span><span class="p">.</span><span class="n">channels_tx_power</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel_number</span> <span class="o">=</span>
		    <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">tx_power</span><span class="p">.</span><span class="n">channels_tx_power</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_power</span> <span class="o">=</span> <span class="n">max_power</span> <span class="o">?</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">max_power</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power</span><span class="p">)</span> <span class="o">:</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_send_tx_power</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_power</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* configure device to also handle &#39;B&#39; band */</span>
	<span class="n">tx_power</span><span class="p">.</span><span class="n">ieee_mode</span> <span class="o">=</span> <span class="n">IPW_B_MODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_send_tx_power</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_power</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* configure device to also handle &#39;A&#39; band */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">abg_true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_power</span><span class="p">.</span><span class="n">ieee_mode</span> <span class="o">=</span> <span class="n">IPW_A_MODE</span><span class="p">;</span>
		<span class="n">tx_power</span><span class="p">.</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a_channels</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_power</span><span class="p">.</span><span class="n">num_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_power</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_power</span><span class="p">;</span>
			<span class="n">tx_power</span><span class="p">.</span><span class="n">channels_tx_power</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel_number</span> <span class="o">=</span>
			    <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">tx_power</span><span class="p">.</span><span class="n">channels_tx_power</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_power</span> <span class="o">=</span> <span class="n">max_power</span> <span class="o">?</span>
			    <span class="n">min</span><span class="p">(</span><span class="n">max_power</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power</span><span class="p">)</span> <span class="o">:</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipw_send_tx_power</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_power</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_rts_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_rts_threshold</span> <span class="n">rts_threshold</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rts</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_RTS_THRESHOLD</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">rts_threshold</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rts_threshold</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_frag_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">frag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_frag_threshold</span> <span class="n">frag_threshold</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">frag_threshold</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_FRAG_THRESHOLD</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">frag_threshold</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">frag_threshold</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_power_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">param</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If on battery, set to 3, if AC set to CAM, else user</span>
<span class="cm">	 * level */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPW_POWER_BATTERY</span>:
		<span class="n">param</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IPW_POWER_INDEX_3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_POWER_AC</span>:
		<span class="n">param</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IPW_POWER_MODE_CAM</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">param</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_POWER_MODE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">param</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_retry_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">slimit</span><span class="p">,</span> <span class="n">u8</span> <span class="n">llimit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_retry_limit</span> <span class="n">retry_limit</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">short_retry_limit</span> <span class="o">=</span> <span class="n">slimit</span><span class="p">,</span>
		<span class="p">.</span><span class="n">long_retry_limit</span> <span class="o">=</span> <span class="n">llimit</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_RETRY_LIMIT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">retry_limit</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">retry_limit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The IPW device contains a Microwire compatible EEPROM that stores</span>
<span class="cm"> * various data like the MAC address.  Usually the firmware has exclusive</span>
<span class="cm"> * access to the eeprom, but during device initialization (before the</span>
<span class="cm"> * device driver has sent the HostComplete command to the firmware) the</span>
<span class="cm"> * device driver has read access to the EEPROM by way of indirect addressing</span>
<span class="cm"> * through a couple of memory mapped registers.</span>
<span class="cm"> *</span>
<span class="cm"> * The following is a simplified implementation for pulling data out of the</span>
<span class="cm"> * the eeprom, along with some helper functions to find information in</span>
<span class="cm"> * the per device private data&#39;s copy of the eeprom.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: To better understand how these functions work (i.e what is a chip</span>
<span class="cm"> *       select and why do have to keep driving the eeprom clock?), read</span>
<span class="cm"> *       just about any data sheet for a Microwire compatible EEPROM.</span>
<span class="cm"> */</span>

<span class="cm">/* write a 32 bit value into the indirect accessor register */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">eeprom_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FW_MEM_REG_EEPROM_ACCESS</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* the eeprom requires some time to complete the operation */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">eeprom_delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* perform a chip select operation */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">eeprom_cs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">eeprom_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">eeprom_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EEPROM_BIT_CS</span><span class="p">);</span>
	<span class="n">eeprom_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EEPROM_BIT_CS</span> <span class="o">|</span> <span class="n">EEPROM_BIT_SK</span><span class="p">);</span>
	<span class="n">eeprom_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EEPROM_BIT_CS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* perform a chip select operation */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">eeprom_disable_cs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">eeprom_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EEPROM_BIT_CS</span><span class="p">);</span>
	<span class="n">eeprom_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">eeprom_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EEPROM_BIT_SK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* push a single bit down to the eeprom */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">eeprom_write_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">bit</span> <span class="o">?</span> <span class="n">EEPROM_BIT_DI</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">eeprom_write_reg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">EEPROM_BIT_CS</span> <span class="o">|</span> <span class="n">d</span><span class="p">);</span>
	<span class="n">eeprom_write_reg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">EEPROM_BIT_CS</span> <span class="o">|</span> <span class="n">d</span> <span class="o">|</span> <span class="n">EEPROM_BIT_SK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* push an opcode followed by an address down to the eeprom */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">eeprom_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">op</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">eeprom_cs</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">eeprom_write_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">eeprom_write_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">op</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">eeprom_write_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">op</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eeprom_write_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* pull 16 bits off the eeprom, one bit at a time */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">eeprom_read_u16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Send READ Opcode */</span>
	<span class="n">eeprom_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EEPROM_CMD_READ</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* Send dummy bit */</span>
	<span class="n">eeprom_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EEPROM_BIT_CS</span><span class="p">);</span>

	<span class="cm">/* Read the byte off the eeprom one bit at a time */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">eeprom_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EEPROM_BIT_CS</span> <span class="o">|</span> <span class="n">EEPROM_BIT_SK</span><span class="p">);</span>
		<span class="n">eeprom_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EEPROM_BIT_CS</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">FW_MEM_REG_EEPROM_ACCESS</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">EEPROM_BIT_DO</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Send another dummy bit */</span>
	<span class="n">eeprom_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">eeprom_disable_cs</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* helper function for pulling the mac address out of the private */</span>
<span class="cm">/* data&#39;s copy of the eeprom data                                 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">eeprom_parse_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">EEPROM_MAC_ADDRESS</span><span class="p">],</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Either the device driver (i.e. the host) or the firmware can</span>
<span class="cm"> * load eeprom data into the designated region in SRAM.  If neither</span>
<span class="cm"> * happens then the FW will shutdown with a fatal error.</span>
<span class="cm"> *</span>
<span class="cm"> * In order to signal the FW to load the EEPROM, the EEPROM_LOAD_DISABLE</span>
<span class="cm"> * bit needs region of shared SRAM needs to be non-zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_eeprom_init_sram</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">eeprom</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_TRACE</span><span class="p">(</span><span class="s">&quot;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* read entire contents of eeprom into private buffer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">eeprom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">eeprom_read_u16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	   If the data looks correct, then copy it to our private</span>
<span class="cm">	   copy.  Otherwise let the firmware know to perform the operation</span>
<span class="cm">	   on its own.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">EEPROM_VERSION</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Writing EEPROM data into SRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* write the eeprom data to sram */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPW_EEPROM_IMAGE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ipw_write8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EEPROM_DATA</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/* Do not load eeprom data on fatal error or suspend */</span>
		<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EEPROM_LOAD_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Enabling FW initializationg of SRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Load eeprom data on fatal error or suspend */</span>
		<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EEPROM_LOAD_DISABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_TRACE</span><span class="p">(</span><span class="s">&quot;&lt;&lt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_zero_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_AUTOINC_ADDR</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
		<span class="n">_ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_AUTOINC_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ipw_fw_dma_reset_command_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipw_zero_memory</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_SHARED_SRAM_DMA_CONTROL</span><span class="p">,</span>
			<span class="n">CB_NUMBER_OF_ELEMENTS_SMALL</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">command_block</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_fw_dma_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>				<span class="cm">/* start dma engine but no transfers yet */</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&gt;&gt; :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Start the dma */</span>
	<span class="n">ipw_fw_dma_reset_command_blocks</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Write CB base address */</span>
	<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_DMA_I_CB_BASE</span><span class="p">,</span> <span class="n">IPW_SHARED_SRAM_DMA_CONTROL</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&lt;&lt; :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_fw_dma_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&gt;&gt; :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* set the Stop and Abort bit */</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">DMA_CONTROL_SMALL_CB_CONST_VALUE</span> <span class="o">|</span> <span class="n">DMA_CB_STOP_AND_ABORT</span><span class="p">;</span>
	<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_DMA_I_DMA_CONTROL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram_desc</span><span class="p">.</span><span class="n">last_cb_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&lt;&lt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_fw_dma_write_command_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">command_block</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">address</span> <span class="o">=</span>
	    <span class="n">IPW_SHARED_SRAM_DMA_CONTROL</span> <span class="o">+</span>
	    <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">command_block</span><span class="p">)</span> <span class="o">*</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&gt;&gt; :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ipw_write_indirect</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">cb</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">command_block</span><span class="p">));</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&lt;&lt; :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_fw_dma_kick</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&gt;&gt; :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram_desc</span><span class="p">.</span><span class="n">last_cb_index</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ipw_fw_dma_write_command_block</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram_desc</span><span class="p">.</span><span class="n">cb_list</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>

	<span class="cm">/* Enable the DMA in the CSR register */</span>
	<span class="n">ipw_clear_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RESET_REG</span><span class="p">,</span>
		      <span class="n">IPW_RESET_REG_MASTER_DISABLED</span> <span class="o">|</span>
		      <span class="n">IPW_RESET_REG_STOP_MASTER</span><span class="p">);</span>

	<span class="cm">/* Set the Start bit. */</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">DMA_CONTROL_SMALL_CB_CONST_VALUE</span> <span class="o">|</span> <span class="n">DMA_CB_START</span><span class="p">;</span>
	<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_DMA_I_DMA_CONTROL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&lt;&lt; :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_fw_dma_dump_command_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">register_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cb_fields_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&gt;&gt; :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">address</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_DMA_I_CURRENT_CB</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_FW_INFO</span><span class="p">(</span><span class="s">&quot;Current CB is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>

	<span class="cm">/* Read the DMA Controlor register */</span>
	<span class="n">register_value</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_DMA_I_DMA_CONTROL</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_FW_INFO</span><span class="p">(</span><span class="s">&quot;IPW_DMA_I_DMA_CONTROL is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">register_value</span><span class="p">);</span>

	<span class="cm">/* Print the CB values */</span>
	<span class="n">cb_fields_address</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">register_value</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cb_fields_address</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_FW_INFO</span><span class="p">(</span><span class="s">&quot;Current CB Control Field is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">register_value</span><span class="p">);</span>

	<span class="n">cb_fields_address</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">register_value</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cb_fields_address</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_FW_INFO</span><span class="p">(</span><span class="s">&quot;Current CB Source Field is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">register_value</span><span class="p">);</span>

	<span class="n">cb_fields_address</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">register_value</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cb_fields_address</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_FW_INFO</span><span class="p">(</span><span class="s">&quot;Current CB Destination Field is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">register_value</span><span class="p">);</span>

	<span class="n">cb_fields_address</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">register_value</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cb_fields_address</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_FW_INFO</span><span class="p">(</span><span class="s">&quot;Current CB Status Field is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">register_value</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&gt;&gt; :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_fw_dma_command_block_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">current_cb_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">current_cb_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&lt;&lt; :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">current_cb_address</span> <span class="o">=</span> <span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_DMA_I_CURRENT_CB</span><span class="p">);</span>

	<span class="n">current_cb_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_cb_address</span> <span class="o">-</span> <span class="n">IPW_SHARED_SRAM_DMA_CONTROL</span><span class="p">)</span> <span class="o">/</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">command_block</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_FW_INFO</span><span class="p">(</span><span class="s">&quot;Current CB index 0x%x address = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">current_cb_index</span><span class="p">,</span> <span class="n">current_cb_address</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&gt;&gt; :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">current_cb_index</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_fw_dma_add_command_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">src_address</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">dest_address</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">length</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">interrupt_enabled</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_last</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u32</span> <span class="n">control</span> <span class="o">=</span> <span class="n">CB_VALID</span> <span class="o">|</span> <span class="n">CB_SRC_LE</span> <span class="o">|</span> <span class="n">CB_DEST_LE</span> <span class="o">|</span> <span class="n">CB_SRC_AUTOINC</span> <span class="o">|</span>
	    <span class="n">CB_SRC_IO_GATED</span> <span class="o">|</span> <span class="n">CB_DEST_AUTOINC</span> <span class="o">|</span> <span class="n">CB_SRC_SIZE_LONG</span> <span class="o">|</span>
	    <span class="n">CB_DEST_SIZE_LONG</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">command_block</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last_cb_element</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_FW_INFO</span><span class="p">(</span><span class="s">&quot;src_address=0x%x dest_address=0x%x length=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">src_address</span><span class="p">,</span> <span class="n">dest_address</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram_desc</span><span class="p">.</span><span class="n">last_cb_index</span> <span class="o">&gt;=</span> <span class="n">CB_NUMBER_OF_ELEMENTS_SMALL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">last_cb_element</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram_desc</span><span class="p">.</span><span class="n">last_cb_index</span><span class="p">;</span>
	<span class="n">cb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram_desc</span><span class="p">.</span><span class="n">cb_list</span><span class="p">[</span><span class="n">last_cb_element</span><span class="p">];</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram_desc</span><span class="p">.</span><span class="n">last_cb_index</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Calculate the new CB control word */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_enabled</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">CB_INT_ENABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_last</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">CB_LAST_VALID</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">|=</span> <span class="n">length</span><span class="p">;</span>

	<span class="cm">/* Calculate the CB Element&#39;s checksum value */</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">control</span> <span class="o">^</span> <span class="n">src_address</span> <span class="o">^</span> <span class="n">dest_address</span><span class="p">;</span>

	<span class="cm">/* Copy the Source and Destination addresses */</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">dest_addr</span> <span class="o">=</span> <span class="n">dest_address</span><span class="p">;</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">source_addr</span> <span class="o">=</span> <span class="n">src_address</span><span class="p">;</span>

	<span class="cm">/* Copy the Control Word last */</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">control</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_fw_dma_add_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">src_address</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest_address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_FW_INFO</span><span class="p">(</span><span class="s">&quot;nr=%d dest_address=0x%x len=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">nr</span><span class="p">,</span> <span class="n">dest_address</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="n">CB_MAX_LENGTH</span><span class="p">,</span> <span class="n">CB_MAX_LENGTH</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw_fw_dma_add_command_block</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">src_address</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						   <span class="n">dest_address</span> <span class="o">+</span>
						   <span class="n">i</span> <span class="o">*</span> <span class="n">CB_MAX_LENGTH</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
						   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_FW_INFO</span><span class="p">(</span><span class="s">&quot;: Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">IPW_DEBUG_FW_INFO</span><span class="p">(</span><span class="s">&quot;: Added new cb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&lt;&lt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_fw_dma_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">previous_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">watchdog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&gt;&gt; :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">current_index</span> <span class="o">=</span> <span class="n">ipw_fw_dma_command_block_index</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_FW_INFO</span><span class="p">(</span><span class="s">&quot;sram_desc.last_cb_index:0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram_desc</span><span class="p">.</span><span class="n">last_cb_index</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">current_index</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram_desc</span><span class="p">.</span><span class="n">last_cb_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">previous_index</span> <span class="o">=</span> <span class="n">current_index</span><span class="p">;</span>
		<span class="n">current_index</span> <span class="o">=</span> <span class="n">ipw_fw_dma_command_block_index</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">previous_index</span> <span class="o">&lt;</span> <span class="n">current_index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">watchdog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">watchdog</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_FW_INFO</span><span class="p">(</span><span class="s">&quot;Timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ipw_fw_dma_dump_command_block</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="n">ipw_fw_dma_abort</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ipw_fw_dma_abort</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/*Disable the DMA in the CSR register */</span>
	<span class="n">ipw_set_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RESET_REG</span><span class="p">,</span>
		    <span class="n">IPW_RESET_REG_MASTER_DISABLED</span> <span class="o">|</span> <span class="n">IPW_RESET_REG_STOP_MASTER</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;&lt;&lt; dmaWaitSync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_remove_current_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">,</span> <span class="o">*</span><span class="n">safe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">safe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">network</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">libipw_network</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Check that card is still alive.</span>
<span class="cm"> * Reads debug register from domain0.</span>
<span class="cm"> * If card is present, pre-defined value should</span>
<span class="cm"> * be found there.</span>
<span class="cm"> *</span>
<span class="cm"> * @param priv</span>
<span class="cm"> * @return 1 if card is present, 0 otherwise</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ipw_alive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xd55555d5</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* timeout in msec, attempted in 10-msec quanta */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_poll_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* These functions load the firmware and micro code for the operation of</span>
<span class="cm"> * the ipw hardware.  It assumes the buffer has all the bits for the</span>
<span class="cm"> * image and the caller is handling the memory allocation and clean up.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_stop_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_TRACE</span><span class="p">(</span><span class="s">&quot;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* stop master. typical delay - 0 */</span>
	<span class="n">ipw_set_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RESET_REG</span><span class="p">,</span> <span class="n">IPW_RESET_REG_STOP_MASTER</span><span class="p">);</span>

	<span class="cm">/* timeout is in msec, polled in 10-msec quanta */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_poll_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RESET_REG</span><span class="p">,</span>
			  <span class="n">IPW_RESET_REG_MASTER_DISABLED</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;wait for stop master failed after 100ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;stop master %dms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_arc_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_TRACE</span><span class="p">(</span><span class="s">&quot;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">ipw_clear_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RESET_REG</span><span class="p">,</span> <span class="n">CBD_RESET_REG_PRINCETON_RESET</span><span class="p">);</span>

	<span class="cm">/* no one knows timing, for safety add some delay */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">fw_chunk</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_load_ucode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">image</span><span class="p">;</span>

	<span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_TRACE</span><span class="p">(</span><span class="s">&quot;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_stop_master</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">IPW_SHARED_LOWER_BOUND</span><span class="p">;</span>
	     <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">IPW_REGISTER_DOMAIN1_END</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* no ucode (yet) */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">));</span>
	<span class="cm">/* destroy DMA queues */</span>
	<span class="cm">/* reset sequence */</span>

	<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_MEM_HALT_AND_RESET</span><span class="p">,</span> <span class="n">IPW_BIT_HALT_RESET_ON</span><span class="p">);</span>
	<span class="n">ipw_arc_release</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_MEM_HALT_AND_RESET</span><span class="p">,</span> <span class="n">IPW_BIT_HALT_RESET_OFF</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* reset PHY */</span>
	<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTERNAL_CMD_EVENT</span><span class="p">,</span> <span class="n">IPW_BASEBAND_POWER_DOWN</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTERNAL_CMD_EVENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* enable ucode store */</span>
	<span class="n">ipw_write_reg8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_BASEBAND_CONTROL_STATUS</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">ipw_write_reg8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_BASEBAND_CONTROL_STATUS</span><span class="p">,</span> <span class="n">DINO_ENABLE_CS</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* write ucode */</span>
	<span class="cm">/**</span>
<span class="cm">	 * @bug</span>
<span class="cm">	 * Do NOT set indirect address register once and then</span>
<span class="cm">	 * store data to indirect data register in the loop.</span>
<span class="cm">	 * It seems very reasonable, but in this case DINO do not</span>
<span class="cm">	 * accept ucode. It is essential to set address each time.</span>
<span class="cm">	 */</span>
	<span class="cm">/* load new ipw uCode */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ipw_write_reg16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_BASEBAND_CONTROL_STORE</span><span class="p">,</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

	<span class="cm">/* enable DINO */</span>
	<span class="n">ipw_write_reg8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_BASEBAND_CONTROL_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ipw_write_reg8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_BASEBAND_CONTROL_STATUS</span><span class="p">,</span> <span class="n">DINO_ENABLE_SYSTEM</span><span class="p">);</span>

	<span class="cm">/* this is where the igx / win driver deveates from the VAP driver. */</span>

	<span class="cm">/* wait for alive response */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* poll for incoming data */</span>
		<span class="n">cr</span> <span class="o">=</span> <span class="n">ipw_read_reg8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_BASEBAND_CONTROL_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="n">DINO_RXFIFO_DATA</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="n">DINO_RXFIFO_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* alive_command_responce size is NOT multiple of 4 */</span>
		<span class="n">__le32</span> <span class="n">response_buffer</span><span class="p">[(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">response_buffer</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">response_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ipw_read_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
						       <span class="n">IPW_BASEBAND_RX_FIFO_READ</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">,</span> <span class="n">response_buffer</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">.</span><span class="n">alive_command</span> <span class="o">==</span> <span class="mi">1</span>
		    <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">.</span><span class="n">ucode_valid</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">IPW_DEBUG_INFO</span>
			    <span class="p">(</span><span class="s">&quot;Microcode OK, rev. %d (0x%x) dev. %d (0x%x) &quot;</span>
			     <span class="s">&quot;of %02d/%02d/%02d %02d:%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">.</span><span class="n">software_revision</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">.</span><span class="n">software_revision</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">.</span><span class="n">device_identifier</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">.</span><span class="n">device_identifier</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">.</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">.</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">.</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">.</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dino_alive</span><span class="p">.</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Microcode is not alive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;No alive response from DINO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* disable DINO, otherwise for some reason</span>
<span class="cm">	   firmware have problem getting alive resp. */</span>
	<span class="n">ipw_write_reg8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_BASEBAND_CONTROL_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total_nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_pool</span> <span class="o">*</span><span class="n">pool</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">**</span><span class="n">virts</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">phys</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_TRACE</span><span class="p">(</span><span class="s">&quot;&lt;&lt; :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">virts</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">CB_NUMBER_OF_ELEMENTS_SMALL</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">virts</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">phys</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">CB_NUMBER_OF_ELEMENTS_SMALL</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">virts</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;ipw2200&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">CB_MAX_LENGTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;pci_pool_create failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">virts</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start the Dma */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw_fw_dma_enable</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* the DMA is already ready this would be a bug. */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram_desc</span><span class="p">.</span><span class="n">last_cb_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">chunk_len</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">chunk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_chunk</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_chunk</span><span class="p">);</span>
		<span class="n">chunk_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

		<span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk_len</span> <span class="o">+</span> <span class="n">CB_MAX_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">CB_MAX_LENGTH</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">virts</span><span class="p">[</span><span class="n">total_nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">phys</span><span class="p">[</span><span class="n">total_nr</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">virts</span><span class="p">[</span><span class="n">total_nr</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">chunk_len</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="n">CB_MAX_LENGTH</span><span class="p">,</span>
				     <span class="n">CB_MAX_LENGTH</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">virts</span><span class="p">[</span><span class="n">total_nr</span><span class="p">],</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">start</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">total_nr</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* We don&#39;t support fw chunk larger than 64*8K */</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">total_nr</span> <span class="o">&gt;</span> <span class="n">CB_NUMBER_OF_ELEMENTS_SMALL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* build DMA packet and queue up for sending */</span>
		<span class="cm">/* dma to chunk-&gt;address, the chunk-&gt;length bytes from data +</span>
<span class="cm">		 * offeset*/</span>
		<span class="cm">/* Dma loading */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw_fw_dma_add_buffer</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys</span><span class="p">[</span><span class="n">total_nr</span> <span class="o">-</span> <span class="n">nr</span><span class="p">],</span>
					    <span class="n">nr</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">),</span>
					    <span class="n">chunk_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;dmaAddBuffer Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">chunk_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Run the DMA and wait for the answer */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw_fw_dma_kick</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;dmaKick Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw_fw_dma_wait</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;dmaWaitSync Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">total_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">virts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">pool</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">virts</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* stop nic */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_stop_nic</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* stop */</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RESET_REG</span><span class="p">,</span> <span class="n">IPW_RESET_REG_STOP_MASTER</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_poll_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RESET_REG</span><span class="p">,</span>
			  <span class="n">IPW_RESET_REG_MASTER_DISABLED</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;wait for reg master disabled failed after 500ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipw_set_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RESET_REG</span><span class="p">,</span> <span class="n">CBD_RESET_REG_PRINCETON_RESET</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_start_nic</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_TRACE</span><span class="p">(</span><span class="s">&quot;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* prvHwStartNic  release ARC */</span>
	<span class="n">ipw_clear_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RESET_REG</span><span class="p">,</span>
		      <span class="n">IPW_RESET_REG_MASTER_DISABLED</span> <span class="o">|</span>
		      <span class="n">IPW_RESET_REG_STOP_MASTER</span> <span class="o">|</span>
		      <span class="n">CBD_RESET_REG_PRINCETON_RESET</span><span class="p">);</span>

	<span class="cm">/* enable power management */</span>
	<span class="n">ipw_set_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_GP_CNTRL_RW</span><span class="p">,</span>
		    <span class="n">IPW_GP_CNTRL_BIT_HOST_ALLOWS_STANDBY</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_TRACE</span><span class="p">(</span><span class="s">&quot;&lt;&lt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_init_nic</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_TRACE</span><span class="p">(</span><span class="s">&quot;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* reset */</span>
	<span class="cm">/*prvHwInitNic */</span>
	<span class="cm">/* set &quot;initialization complete&quot; bit to move adapter to D0 state */</span>
	<span class="n">ipw_set_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_GP_CNTRL_RW</span><span class="p">,</span> <span class="n">IPW_GP_CNTRL_BIT_INIT_DONE</span><span class="p">);</span>

	<span class="cm">/* low-level PLL activation */</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_READ_INT_REGISTER</span><span class="p">,</span>
		    <span class="n">IPW_BIT_INT_HOST_SRAM_READ_INT_REGISTER</span><span class="p">);</span>

	<span class="cm">/* wait for clock stabilization */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_poll_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_GP_CNTRL_RW</span><span class="p">,</span>
			  <span class="n">IPW_GP_CNTRL_BIT_CLOCK_READY</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;FAILED wait for clock stablization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* assert SW reset */</span>
	<span class="n">ipw_set_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RESET_REG</span><span class="p">,</span> <span class="n">IPW_RESET_REG_SW_RESET</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* set &quot;initialization complete&quot; bit to move adapter to D0 state */</span>
	<span class="n">ipw_set_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_GP_CNTRL_RW</span><span class="p">,</span> <span class="n">IPW_GP_CNTRL_BIT_INIT_DONE</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_TRACE</span><span class="p">(</span><span class="s">&quot;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Call this function from process context, it will sleep in request_firmware.</span>
<span class="cm"> * Probe is an ok place to call this from.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_reset_nic</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_TRACE</span><span class="p">(</span><span class="s">&quot;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_init_nic</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Clear the &#39;host command active&#39; bit... */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_HCMD_ACTIVE</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STATUS_SCANNING</span> <span class="o">|</span> <span class="n">STATUS_SCAN_ABORTING</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_state</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_TRACE</span><span class="p">(</span><span class="s">&quot;&lt;&lt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">ipw_fw</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">ver</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">boot_size</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">ucode_size</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">fw_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_get_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">raw</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_fw</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* ask firmware_class module to get the boot firmware off disk */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;%s request_firmware failed: Reason %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">raw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;%s is too small (%zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">raw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fw</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">raw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">raw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw</span><span class="p">)</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">boot_size</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">ucode_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;%s is too small or corrupt (%zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">raw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Read firmware &#39;%s&#39; image v%d.%d (%zd bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">ver</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">ver</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		       <span class="p">(</span><span class="o">*</span><span class="n">raw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IPW_RX_BUF_SIZE (3000)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_rx_queue_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ipw_rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_free</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">);</span>

	<span class="cm">/* Fill the rx_used queue with _all_ of the Rx buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_FREE_BUFFERS</span> <span class="o">+</span> <span class="n">RX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* In the reset function, these buffers may have been allocated</span>
<span class="cm">		 * to an SKB, so we need to unmap and free potential storage */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_addr</span><span class="p">,</span>
					 <span class="n">IPW_RX_BUF_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set us so that we have processed and used all buffers, but have</span>
<span class="cm">	 * not restocked the Rx queue with fresh buffers */</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fw_loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">raw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_firmware</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_loaded</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">raw</span><span class="p">);</span>
		<span class="n">raw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">fw_loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define free_firmware() do {} while (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_PM</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">raw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">ipw_fw</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">boot_img</span><span class="p">,</span> <span class="o">*</span><span class="n">ucode_img</span><span class="p">,</span> <span class="o">*</span><span class="n">fw_img</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ipw2200-ibss.fw&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
	<span class="k">case</span> <span class="n">IW_MODE_MONITOR</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ipw2200-sniffer.fw&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ipw2200-bss.fw&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_loaded</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_get_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raw</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">fw</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">raw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">boot_img</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ucode_img</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">boot_size</span><span class="p">)];</span>
	<span class="n">fw_img</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">boot_size</span><span class="p">)</span> <span class="o">+</span>
			   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">ucode_size</span><span class="p">)];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">=</span> <span class="n">ipw_rx_queue_alloc</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ipw_rx_queue_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to initialize Rx queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="nl">retry:</span>
	<span class="cm">/* Ensure interrupts are disabled */</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_MASK_R</span><span class="p">,</span> <span class="o">~</span><span class="n">IPW_INTA_MASK_ALL</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_INT_ENABLED</span><span class="p">;</span>

	<span class="cm">/* ack pending interrupts */</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_RW</span><span class="p">,</span> <span class="n">IPW_INTA_MASK_ALL</span><span class="p">);</span>

	<span class="n">ipw_stop_nic</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_reset_nic</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to reset NIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipw_zero_memory</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_NIC_SRAM_LOWER_BOUND</span><span class="p">,</span>
			<span class="n">IPW_NIC_SRAM_UPPER_BOUND</span> <span class="o">-</span> <span class="n">IPW_NIC_SRAM_LOWER_BOUND</span><span class="p">);</span>

	<span class="cm">/* DMA the initial boot firmware into the device */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_load_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">boot_img</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">boot_size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to load boot firmware: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* kick start the device */</span>
	<span class="n">ipw_start_nic</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* wait for the device to finish its initial startup sequence */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_poll_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_RW</span><span class="p">,</span>
			  <span class="n">IPW_INTA_BIT_FW_INITIALIZATION_DONE</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;device failed to boot initial fw image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;initial device response after %dms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* ack fw init done interrupt */</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_RW</span><span class="p">,</span> <span class="n">IPW_INTA_BIT_FW_INITIALIZATION_DONE</span><span class="p">);</span>

	<span class="cm">/* DMA the ucode into the device */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_load_ucode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ucode_img</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">ucode_size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to load ucode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* stop nic */</span>
	<span class="n">ipw_stop_nic</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* DMA bss firmware into the device */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_load_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fw_img</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw_size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to load firmware: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">fw_loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_EEPROM_LOAD_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_queue_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to initialize queues</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure interrupts are disabled */</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_MASK_R</span><span class="p">,</span> <span class="o">~</span><span class="n">IPW_INTA_MASK_ALL</span><span class="p">);</span>
	<span class="cm">/* ack pending interrupts */</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_RW</span><span class="p">,</span> <span class="n">IPW_INTA_MASK_ALL</span><span class="p">);</span>

	<span class="cm">/* kick start the device */</span>
	<span class="n">ipw_start_nic</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_RW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPW_INTA_BIT_PARITY_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;Parity error.  Retrying init.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retries</span><span class="o">--</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;TODO: Handle parity error -- schedule restart?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* wait for the device */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_poll_bit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_RW</span><span class="p">,</span>
			  <span class="n">IPW_INTA_BIT_FW_INITIALIZATION_DONE</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;device failed to start within 500ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;device response after %dms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* ack fw init done interrupt */</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_RW</span><span class="p">,</span> <span class="n">IPW_INTA_BIT_FW_INITIALIZATION_DONE</span><span class="p">);</span>

	<span class="cm">/* read eeprom data and initialize the eeprom region of sram */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ipw_eeprom_init_sram</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* enable interrupts */</span>
	<span class="n">ipw_enable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Ensure our queue has valid packets */</span>
	<span class="n">ipw_rx_queue_replenish</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RX_READ_INDEX</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>

	<span class="cm">/* ack pending interrupts */</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_RW</span><span class="p">,</span> <span class="n">IPW_INTA_MASK_ALL</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_PM</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">raw</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipw_rx_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ipw_tx_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">raw</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">fw_loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">raw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * DMA services</span>
<span class="cm"> *</span>
<span class="cm"> * Theory of operation</span>
<span class="cm"> *</span>
<span class="cm"> * A queue is a circular buffers with &#39;Read&#39; and &#39;Write&#39; pointers.</span>
<span class="cm"> * 2 empty entries always kept in the buffer to protect from overflow.</span>
<span class="cm"> *</span>
<span class="cm"> * For Tx queue, there are low mark and high mark limits. If, after queuing</span>
<span class="cm"> * the packet for Tx, free space become &lt; low mark, Tx queue stopped. When</span>
<span class="cm"> * reclaiming packets (on &#39;tx done IRQ), if free space become &gt; high mark,</span>
<span class="cm"> * Tx queue resumed.</span>
<span class="cm"> *</span>
<span class="cm"> * The IPW operates with six queues, one receive queue in the device&#39;s</span>
<span class="cm"> * sram, one transmit queue for sending commands to the device firmware,</span>
<span class="cm"> * and four transmit queues for data.</span>
<span class="cm"> *</span>
<span class="cm"> * The four transmit queues allow for performing quality of service (qos)</span>
<span class="cm"> * transmissions as per the 802.11 protocol.  Currently Linux does not</span>
<span class="cm"> * provide a mechanism to the user for utilizing prioritized queues, so</span>
<span class="cm"> * we only utilize the first data transmit queue (queue1).</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * Driver allocates buffers of this size for Rx</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * ipw_rx_queue_space - Return number of free slots available in queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_rx_queue_space</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ipw_rx_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">-</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="n">RX_QUEUE_SIZE</span><span class="p">;</span>
	<span class="cm">/* keep some buffer to not confuse full and empty queue */</span>
	<span class="n">s</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ipw_tx_queue_space</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">clx2_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">-</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>			<span class="cm">/* keep some reserve to not confuse empty and full situations */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ipw_queue_inc_wrap</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">++</span><span class="n">index</span> <span class="o">==</span> <span class="n">n_bd</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Initialize common DMA queue structure</span>
<span class="cm"> *</span>
<span class="cm"> * @param q                queue to init</span>
<span class="cm"> * @param count            Number of BD&#39;s to allocate. Should be power of 2</span>
<span class="cm"> * @param read_register    Address for &#39;read&#39; register</span>
<span class="cm"> *                         (not offset within BAR, full address)</span>
<span class="cm"> * @param write_register   Address for &#39;write&#39; register</span>
<span class="cm"> *                         (not offset within BAR, full address)</span>
<span class="cm"> * @param base_register    Address for &#39;base&#39; register</span>
<span class="cm"> *                         (not offset within BAR, full address)</span>
<span class="cm"> * @param size             Address for &#39;size&#39; register</span>
<span class="cm"> *                         (not offset within BAR, full address)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_queue_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">clx2_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">u32</span> <span class="n">read</span><span class="p">,</span> <span class="n">u32</span> <span class="n">write</span><span class="p">,</span> <span class="n">u32</span> <span class="n">base</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">low_mark</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">low_mark</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">low_mark</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">high_mark</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">high_mark</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">high_mark</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">reg_r</span> <span class="o">=</span> <span class="n">read</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">reg_w</span> <span class="o">=</span> <span class="n">write</span><span class="p">;</span>

	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">_ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_queue_tx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">clx2_tx_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">u32</span> <span class="n">read</span><span class="p">,</span> <span class="n">u32</span> <span class="n">write</span><span class="p">,</span> <span class="n">u32</span> <span class="n">base</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">txb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">txb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">count</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">txb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;vmalloc for auxiliary BD structures failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">bd</span> <span class="o">=</span>
	    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;pci_alloc_consistent(%zd) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">txb</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipw_queue_init</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Free one TFD, those at index [txq-&gt;q.last_used].</span>
<span class="cm"> * Do NOT advance any indexes</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev</span>
<span class="cm"> * @param txq</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_queue_tx_free_tfd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">clx2_tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tfd_frame</span> <span class="o">*</span><span class="n">bd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">last_used</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* classify bd */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">control_flags</span><span class="p">.</span><span class="n">message_type</span> <span class="o">==</span> <span class="n">TX_HOST_COMMAND_TYPE</span><span class="p">)</span>
		<span class="cm">/* nothing to cleanup after for host commands */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">num_chunks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">NUM_TFD_CHUNKS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Too many chunks: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">num_chunks</span><span class="p">));</span>
		<span class="cm">/** @todo issue fatal error, it is quite serious situation */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* unmap chunks if any */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">num_chunks</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">chunk_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">chunk_len</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txb</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">last_used</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">libipw_txb_free</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txb</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">last_used</span><span class="p">]);</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txb</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">last_used</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Deallocate DMA queue.</span>
<span class="cm"> *</span>
<span class="cm"> * Empty queue by removing and destroying all BD&#39;s.</span>
<span class="cm"> * Free all buffers.</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev</span>
<span class="cm"> * @param q</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_queue_tx_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">clx2_tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clx2_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* first, empty all BD&#39;s */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span> <span class="o">!=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">last_used</span><span class="p">;</span>
	     <span class="n">q</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">=</span> <span class="n">ipw_queue_inc_wrap</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">last_used</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipw_queue_tx_free_tfd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* free buffers belonging to queue itself */</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">,</span>
			    <span class="n">q</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txb</span><span class="p">);</span>

	<span class="cm">/* 0 fill whole structure */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">txq</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Destroy all DMA queues and structures</span>
<span class="cm"> *</span>
<span class="cm"> * @param priv</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_tx_queue_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Tx CMD queue */</span>
	<span class="n">ipw_queue_tx_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_cmd</span><span class="p">);</span>

	<span class="cm">/* Tx queues */</span>
	<span class="n">ipw_queue_tx_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">ipw_queue_tx_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">ipw_queue_tx_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">ipw_queue_tx_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_create_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* First 3 bytes are manufacturer */</span>
	<span class="n">bssid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">bssid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">bssid</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* Last bytes are random */</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ETH_ALEN</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">bssid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>	<span class="cm">/* clear multicast bit */</span>
	<span class="n">bssid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>	<span class="cm">/* set local assignment bit (IEEE802) */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ipw_add_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_station_entry</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_stations</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Another node is active in network */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">missed_adhoc_beacons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_CHANNEL</span><span class="p">))</span>
				<span class="cm">/* when other nodes drop out, we drop out */</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_ADHOC_PERSIST</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_STATIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IPW_INVALID_STATION</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Adding AdHoc station: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>

	<span class="n">entry</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">entry</span><span class="p">.</span><span class="n">support_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">ipw_write_direct</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_STATION_TABLE_LOWER</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">entry</span><span class="p">),</span>
			 <span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_stations</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ipw_find_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_stations</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">IPW_INVALID_STATION</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_send_disassociate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">quiet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Disassociating while associating.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">disassociate</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Disassociating while not associated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Disassocation attempt from %pM &quot;</span>
			<span class="s">&quot;on channel %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STATUS_ASSOCIATING</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_DISASSOCIATING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">quiet</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">assoc_type</span> <span class="o">=</span> <span class="n">HC_DISASSOC_QUIET</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">assoc_type</span> <span class="o">=</span> <span class="n">HC_DISASSOCIATE</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_send_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Attempt to send [dis]associate command &quot;</span>
			     <span class="s">&quot;failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_disassociate</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipw_send_disassociate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_disassociate</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">disassociate</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_system_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">system_config</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_all_data_frames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_non_directed_frames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_all_mgmt_bcpr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_all_mgmt_frames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">ipw_send_system_config</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ipw_status_code</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipw_status_code</span> <span class="n">ipw_status_codes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="s">&quot;Successful&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01</span><span class="p">,</span> <span class="s">&quot;Unspecified failure&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0A</span><span class="p">,</span> <span class="s">&quot;Cannot support all requested capabilities in the &quot;</span>
	 <span class="s">&quot;Capability information field&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="s">&quot;Reassociation denied due to inability to confirm that &quot;</span>
	 <span class="s">&quot;association exists&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0C</span><span class="p">,</span> <span class="s">&quot;Association denied due to reason outside the scope of this &quot;</span>
	 <span class="s">&quot;standard&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0D</span><span class="p">,</span>
	 <span class="s">&quot;Responding station does not support the specified authentication &quot;</span>
	 <span class="s">&quot;algorithm&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0E</span><span class="p">,</span>
	 <span class="s">&quot;Received an Authentication frame with authentication sequence &quot;</span>
	 <span class="s">&quot;transaction sequence number out of expected sequence&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0F</span><span class="p">,</span> <span class="s">&quot;Authentication rejected because of challenge failure&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x10</span><span class="p">,</span> <span class="s">&quot;Authentication rejected due to timeout waiting for next &quot;</span>
	 <span class="s">&quot;frame in sequence&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="s">&quot;Association denied because AP is unable to handle additional &quot;</span>
	 <span class="s">&quot;associated stations&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x12</span><span class="p">,</span>
	 <span class="s">&quot;Association denied due to requesting station not supporting all &quot;</span>
	 <span class="s">&quot;of the datarates in the BSSBasicServiceSet Parameter&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x13</span><span class="p">,</span>
	 <span class="s">&quot;Association denied due to requesting station not supporting &quot;</span>
	 <span class="s">&quot;short preamble operation&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x14</span><span class="p">,</span>
	 <span class="s">&quot;Association denied due to requesting station not supporting &quot;</span>
	 <span class="s">&quot;PBCC encoding&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x15</span><span class="p">,</span>
	 <span class="s">&quot;Association denied due to requesting station not supporting &quot;</span>
	 <span class="s">&quot;channel agility&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x19</span><span class="p">,</span>
	 <span class="s">&quot;Association denied due to requesting station not supporting &quot;</span>
	 <span class="s">&quot;short slot operation&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1A</span><span class="p">,</span>
	 <span class="s">&quot;Association denied due to requesting station not supporting &quot;</span>
	 <span class="s">&quot;DSSS-OFDM operation&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x28</span><span class="p">,</span> <span class="s">&quot;Invalid Information Element&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x29</span><span class="p">,</span> <span class="s">&quot;Group Cipher is not valid&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x2A</span><span class="p">,</span> <span class="s">&quot;Pairwise Cipher is not valid&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x2B</span><span class="p">,</span> <span class="s">&quot;AKMP is not valid&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x2C</span><span class="p">,</span> <span class="s">&quot;Unsupported RSN IE version&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x2D</span><span class="p">,</span> <span class="s">&quot;Invalid RSN IE Capabilities&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x2E</span><span class="p">,</span> <span class="s">&quot;Cipher suite is rejected per security policy&quot;</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ipw_get_status_code</span><span class="p">(</span><span class="n">u16</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipw_status_codes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipw_status_codes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ipw_status_codes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reason</span><span class="p">;</span>
	<span class="k">return</span> <span class="s">&quot;Unknown status value.&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="kr">inline</span> <span class="nf">average_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">average</span> <span class="o">*</span><span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">avg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">avg</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define DEPTH_RSSI 8</span>
<span class="cp">#define DEPTH_NOISE 16</span>
<span class="k">static</span> <span class="n">s16</span> <span class="nf">exponential_average</span><span class="p">(</span><span class="n">s16</span> <span class="n">prev_avg</span><span class="p">,</span> <span class="n">s16</span> <span class="n">val</span><span class="p">,</span> <span class="n">u8</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">prev_avg</span> <span class="o">+</span>  <span class="n">val</span><span class="p">)</span><span class="o">/</span><span class="n">depth</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">average_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">average</span> <span class="o">*</span><span class="n">avg</span><span class="p">,</span> <span class="n">s16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">avg</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">-=</span> <span class="n">avg</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">];</span>
	<span class="n">avg</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">avg</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">==</span> <span class="n">AVG_ENTRIES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">avg</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s16</span> <span class="nf">average_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">average</span> <span class="o">*</span><span class="n">avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unlikely</span><span class="p">(</span><span class="n">avg</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">avg</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">/</span> <span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">avg</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">/</span> <span class="n">AVG_ENTRIES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_reset_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">average_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">average_missed_beacons</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">exp_avg_rssi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">60</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">exp_avg_noise</span> <span class="o">=</span> <span class="o">-</span><span class="mi">85</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_missed_beacons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rx_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_tx_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_tx_failures</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Firmware managed, reset only when NIC is restarted, so we have to</span>
<span class="cm">	 * normalize on the current value */</span>
	<span class="n">ipw_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_RX_ERR_CRC</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rx_err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ipw_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_TX_FAILURE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_tx_failures</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Driver managed, reset with each association */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">missed_adhoc_beacons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">missed_beacons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ipw_get_max_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span><span class="p">;</span>
	<span class="cm">/* If currently associated in B mode, restrict the maximum</span>
<span class="cm">	 * rate match to B rates */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">ieee_mode</span> <span class="o">==</span> <span class="n">IPW_B_MODE</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">LIBIPW_CCK_RATES_MASK</span><span class="p">;</span>

	<span class="cm">/* TODO: Verify that the rate is supported by the current rates</span>
<span class="cm">	 * list. */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">i</span><span class="p">))</span>
		<span class="n">i</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LIBIPW_CCK_RATE_1MB_MASK</span>:
		<span class="k">return</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_CCK_RATE_2MB_MASK</span>:
		<span class="k">return</span> <span class="mi">2000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_CCK_RATE_5MB_MASK</span>:
		<span class="k">return</span> <span class="mi">5500000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_6MB_MASK</span>:
		<span class="k">return</span> <span class="mi">6000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_9MB_MASK</span>:
		<span class="k">return</span> <span class="mi">9000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_CCK_RATE_11MB_MASK</span>:
		<span class="k">return</span> <span class="mi">11000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_12MB_MASK</span>:
		<span class="k">return</span> <span class="mi">12000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_18MB_MASK</span>:
		<span class="k">return</span> <span class="mi">18000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_24MB_MASK</span>:
		<span class="k">return</span> <span class="mi">24000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_36MB_MASK</span>:
		<span class="k">return</span> <span class="mi">36000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_48MB_MASK</span>:
		<span class="k">return</span> <span class="mi">48000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_54MB_MASK</span>:
		<span class="k">return</span> <span class="mi">54000000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_B</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">11000000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">54000000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ipw_get_current_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rate</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">&gt;</span> <span class="n">IPW_REAL_RATE_RX_PACKET_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_TX_CURR_RATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rate</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;failed querying ordinals.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">ipw_get_max_rate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_1MB</span>:
		<span class="k">return</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_2MB</span>:
		<span class="k">return</span> <span class="mi">2000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_5MB</span>:
		<span class="k">return</span> <span class="mi">5500000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_6MB</span>:
		<span class="k">return</span> <span class="mi">6000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_9MB</span>:
		<span class="k">return</span> <span class="mi">9000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_11MB</span>:
		<span class="k">return</span> <span class="mi">11000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_12MB</span>:
		<span class="k">return</span> <span class="mi">12000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_18MB</span>:
		<span class="k">return</span> <span class="mi">18000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_24MB</span>:
		<span class="k">return</span> <span class="mi">24000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_36MB</span>:
		<span class="k">return</span> <span class="mi">36000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_48MB</span>:
		<span class="k">return</span> <span class="mi">48000000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_54MB</span>:
		<span class="k">return</span> <span class="mi">54000000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IPW_STATS_INTERVAL (2 * HZ)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_gather_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">rx_err_delta</span><span class="p">,</span> <span class="n">rx_packets_delta</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_failures</span><span class="p">,</span> <span class="n">tx_failures_delta</span><span class="p">,</span> <span class="n">tx_packets_delta</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">missed_beacons_percent</span><span class="p">,</span> <span class="n">missed_beacons_delta</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">s16</span> <span class="n">rssi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">beacon_quality</span><span class="p">,</span> <span class="n">signal_quality</span><span class="p">,</span> <span class="n">tx_quality</span><span class="p">,</span> <span class="n">rx_quality</span><span class="p">,</span>
	    <span class="n">rate_quality</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update the statistics */</span>
	<span class="n">ipw_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_MISSED_BEACONS</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">missed_beacons</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">missed_beacons_delta</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">missed_beacons</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_missed_beacons</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_missed_beacons</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">missed_beacons</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">missed_beacons_percent</span> <span class="o">=</span> <span class="n">missed_beacons_delta</span> <span class="o">*</span>
		    <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">))</span> <span class="o">/</span>
		    <span class="p">(</span><span class="n">IPW_STATS_INTERVAL</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">missed_beacons_percent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">average_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">average_missed_beacons</span><span class="p">,</span> <span class="n">missed_beacons_percent</span><span class="p">);</span>

	<span class="n">ipw_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_RX_ERR_CRC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rx_err_delta</span> <span class="o">=</span> <span class="n">rx_err</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rx_err</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rx_err</span> <span class="o">=</span> <span class="n">rx_err</span><span class="p">;</span>

	<span class="n">ipw_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_TX_FAILURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_failures</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">tx_failures_delta</span> <span class="o">=</span> <span class="n">tx_failures</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_tx_failures</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_tx_failures</span> <span class="o">=</span> <span class="n">tx_failures</span><span class="p">;</span>

	<span class="n">rx_packets_delta</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rx_packets</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rx_packets</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>

	<span class="n">tx_packets_delta</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_tx_packets</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_tx_packets</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>

	<span class="cm">/* Calculate quality based on the following:</span>
<span class="cm">	 *</span>
<span class="cm">	 * Missed beacon: 100% = 0, 0% = 70% missed</span>
<span class="cm">	 * Rate: 60% = 1Mbs, 100% = Max</span>
<span class="cm">	 * Rx and Tx errors represent a straight % of total Rx/Tx</span>
<span class="cm">	 * RSSI: 100% = &gt; -50,  0% = &lt; -80</span>
<span class="cm">	 * Rx errors: 100% = 0, 0% = 50% missed</span>
<span class="cm">	 *</span>
<span class="cm">	 * The lowest computed quality is used.</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
<span class="cp">#define BEACON_THRESHOLD 5</span>
	<span class="n">beacon_quality</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">missed_beacons_percent</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beacon_quality</span> <span class="o">&lt;</span> <span class="n">BEACON_THRESHOLD</span><span class="p">)</span>
		<span class="n">beacon_quality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">beacon_quality</span> <span class="o">=</span> <span class="p">(</span><span class="n">beacon_quality</span> <span class="o">-</span> <span class="n">BEACON_THRESHOLD</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span>
		    <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">BEACON_THRESHOLD</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_STATS</span><span class="p">(</span><span class="s">&quot;Missed beacon: %3d%% (%d%%)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">beacon_quality</span><span class="p">,</span> <span class="n">missed_beacons_percent</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rate</span> <span class="o">=</span> <span class="n">ipw_get_current_rate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">max_rate</span> <span class="o">=</span> <span class="n">ipw_get_max_rate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">rate_quality</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rate</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">/</span> <span class="n">max_rate</span> <span class="o">+</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">IPW_DEBUG_STATS</span><span class="p">(</span><span class="s">&quot;Rate quality : %3d%% (%dMbs)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rate_quality</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rate</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_packets_delta</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="n">rx_packets_delta</span> <span class="o">+</span> <span class="n">rx_err_delta</span><span class="p">)</span>
		<span class="n">rx_quality</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="n">rx_err_delta</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span>
		    <span class="p">(</span><span class="n">rx_packets_delta</span> <span class="o">+</span> <span class="n">rx_err_delta</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rx_quality</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">IPW_DEBUG_STATS</span><span class="p">(</span><span class="s">&quot;Rx quality   : %3d%% (%u errors, %u packets)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rx_quality</span><span class="p">,</span> <span class="n">rx_err_delta</span><span class="p">,</span> <span class="n">rx_packets_delta</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_packets_delta</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="n">tx_packets_delta</span> <span class="o">+</span> <span class="n">tx_failures_delta</span><span class="p">)</span>
		<span class="n">tx_quality</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="n">tx_failures_delta</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span>
		    <span class="p">(</span><span class="n">tx_packets_delta</span> <span class="o">+</span> <span class="n">tx_failures_delta</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tx_quality</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">IPW_DEBUG_STATS</span><span class="p">(</span><span class="s">&quot;Tx quality   : %3d%% (%u errors, %u packets)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tx_quality</span><span class="p">,</span> <span class="n">tx_failures_delta</span><span class="p">,</span> <span class="n">tx_packets_delta</span><span class="p">);</span>

	<span class="n">rssi</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">exp_avg_rssi</span><span class="p">;</span>
	<span class="n">signal_quality</span> <span class="o">=</span>
	    <span class="p">(</span><span class="mi">100</span> <span class="o">*</span>
	     <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">perfect_rssi</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">worst_rssi</span><span class="p">)</span> <span class="o">*</span>
	     <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">perfect_rssi</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">worst_rssi</span><span class="p">)</span> <span class="o">-</span>
	     <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">perfect_rssi</span> <span class="o">-</span> <span class="n">rssi</span><span class="p">)</span> <span class="o">*</span>
	     <span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">perfect_rssi</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">worst_rssi</span><span class="p">)</span> <span class="o">+</span>
	      <span class="mi">62</span> <span class="o">*</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">perfect_rssi</span> <span class="o">-</span> <span class="n">rssi</span><span class="p">)))</span> <span class="o">/</span>
	    <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">perfect_rssi</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">worst_rssi</span><span class="p">)</span> <span class="o">*</span>
	     <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">perfect_rssi</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">worst_rssi</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">signal_quality</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">signal_quality</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">signal_quality</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">signal_quality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_STATS</span><span class="p">(</span><span class="s">&quot;Signal level : %3d%% (%d dBm)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">signal_quality</span><span class="p">,</span> <span class="n">rssi</span><span class="p">);</span>

	<span class="n">quality</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">rx_quality</span><span class="p">,</span> <span class="n">signal_quality</span><span class="p">);</span>
	<span class="n">quality</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">tx_quality</span><span class="p">,</span> <span class="n">quality</span><span class="p">);</span>
	<span class="n">quality</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">rate_quality</span><span class="p">,</span> <span class="n">quality</span><span class="p">);</span>
	<span class="n">quality</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">beacon_quality</span><span class="p">,</span> <span class="n">quality</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quality</span> <span class="o">==</span> <span class="n">beacon_quality</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_STATS</span><span class="p">(</span><span class="s">&quot;Quality (%d%%): Clamped to missed beacons.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">quality</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quality</span> <span class="o">==</span> <span class="n">rate_quality</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_STATS</span><span class="p">(</span><span class="s">&quot;Quality (%d%%): Clamped to rate quality.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">quality</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quality</span> <span class="o">==</span> <span class="n">tx_quality</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_STATS</span><span class="p">(</span><span class="s">&quot;Quality (%d%%): Clamped to Tx quality.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">quality</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quality</span> <span class="o">==</span> <span class="n">rx_quality</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_STATS</span><span class="p">(</span><span class="s">&quot;Quality (%d%%): Clamped to Rx quality.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">quality</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quality</span> <span class="o">==</span> <span class="n">signal_quality</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_STATS</span><span class="p">(</span><span class="s">&quot;Quality (%d%%): Clamped to signal quality.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">quality</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">=</span> <span class="n">quality</span><span class="p">;</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gather_stats</span><span class="p">,</span> <span class="n">IPW_STATS_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_gather_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">gather_stats</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_gather_stats</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Missed beacon behavior:</span>
<span class="cm"> * 1st missed -&gt; roaming_threshold, just wait, don&#39;t do any scan/roam.</span>
<span class="cm"> * roaming_threshold -&gt; disassociate_threshold, scan and roam for better signal.</span>
<span class="cm"> * Above disassociate threshold, give up and stop scanning.</span>
<span class="cm"> * Roaming is disabled if disassociate_threshold &lt;= roaming_threshold  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_handle_missed_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">missed_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">notif_missed_beacons</span> <span class="o">=</span> <span class="n">missed_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">missed_count</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">disassociate_threshold</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If associated and we&#39;ve hit the missed</span>
<span class="cm">		 * beacon threshold, disassociate, turn</span>
<span class="cm">		 * off roaming, and abort any active scans */</span>
		<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_INFO</span> <span class="o">|</span> <span class="n">IPW_DL_NOTIF</span> <span class="o">|</span>
			  <span class="n">IPW_DL_STATE</span> <span class="o">|</span> <span class="n">IPW_DL_ASSOC</span><span class="p">,</span>
			  <span class="s">&quot;Missed beacon: %d - disassociate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">missed_count</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_ROAMING</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCANNING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_INFO</span> <span class="o">|</span> <span class="n">IPW_DL_NOTIF</span> <span class="o">|</span>
				  <span class="n">IPW_DL_STATE</span><span class="p">,</span>
				  <span class="s">&quot;Aborting scan with missed beacon.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">abort_scan</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">disassociate</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ROAMING</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we are currently roaming, then just</span>
<span class="cm">		 * print a debug statement... */</span>
		<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span><span class="p">,</span>
			  <span class="s">&quot;Missed beacon: %d - roam in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">missed_count</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">roaming</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">missed_count</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">roaming_threshold</span> <span class="o">&amp;&amp;</span>
	     <span class="n">missed_count</span> <span class="o">&lt;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">disassociate_threshold</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If we are not already roaming, set the ROAM</span>
<span class="cm">		 * bit in the status and kick off a scan.</span>
<span class="cm">		 * This can happen several times before we reach</span>
<span class="cm">		 * disassociate_threshold. */</span>
		<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span><span class="p">,</span>
			  <span class="s">&quot;Missed beacon: %d - initiate &quot;</span>
			  <span class="s">&quot;roaming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">missed_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ROAMING</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_ROAMING</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCANNING</span><span class="p">))</span>
				<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCANNING</span> <span class="o">&amp;&amp;</span>
	    <span class="n">missed_count</span> <span class="o">&gt;</span> <span class="n">IPW_MB_SCAN_CANCEL_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Stop scan to keep fw from getting</span>
<span class="cm">		 * stuck (only if we aren&#39;t roaming --</span>
<span class="cm">		 * otherwise we&#39;ll never scan more than 2 or 3</span>
<span class="cm">		 * channels..) */</span>
		<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_INFO</span> <span class="o">|</span> <span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span><span class="p">,</span>
			  <span class="s">&quot;Aborting scan with missed beacon.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">abort_scan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_NOTIF</span><span class="p">(</span><span class="s">&quot;Missed beacon: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">missed_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_scan_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">scan_event</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_scan_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Only userspace-requested scan completion events go out immediately */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">user_requested_scan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event</span><span class="p">))</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event</span><span class="p">,</span>
					      <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">4000</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">user_requested_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event</span><span class="p">);</span>

		<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Handle host notification packet.</span>
<span class="cm"> * Called from interrupt routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_rx_notification</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ipw_rx_notification</span> <span class="o">*</span><span class="n">notif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_NOTIF</span><span class="p">(</span><span class="s">&quot;type = %i (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">notif</span><span class="o">-&gt;</span><span class="n">subtype</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">subtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HOST_NOTIFICATION_STATUS_ASSOCIATED</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">notif_association</span> <span class="o">*</span><span class="n">assoc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">assoc</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">CMAS_ASSOCIATED</span>:<span class="p">{</span>
					<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
						  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span>
						  <span class="s">&quot;associated: &#39;%s&#39; %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span>
							     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">),</span>
						  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>

					<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
						<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
						       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>

					<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
						<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
						       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

						<span class="cm">/* clear out the station table */</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_stations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

						<span class="n">IPW_DEBUG_ASSOC</span>
						    <span class="p">(</span><span class="s">&quot;queueing adhoc check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">schedule_delayed_work</span><span class="p">(</span>
							<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_check</span><span class="p">,</span>
							<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span>
							<span class="n">assoc_request</span><span class="p">.</span>
							<span class="n">beacon_interval</span><span class="p">));</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_ASSOCIATING</span><span class="p">;</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">;</span>
					<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">system_config</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPW2200_QOS</span>
<span class="cp">#define IPW_GET_PACKET_STYPE(x) WLAN_FC_GET_STYPE( \</span>
<span class="cp">			 le16_to_cpu(((struct ieee80211_hdr *)(x))-&gt;frame_control))</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_AUTH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					    <span class="p">(</span><span class="n">IPW_GET_PACKET_STYPE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">)</span>
					     <span class="o">==</span> <span class="n">IEEE80211_STYPE_ASSOC_RESP</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="k">sizeof</span>
						     <span class="p">(</span><span class="k">struct</span>
						      <span class="n">libipw_assoc_response</span><span class="p">)</span>
						     <span class="o">&lt;=</span> <span class="n">size</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">2314</span><span class="p">))</span> <span class="p">{</span>
							<span class="k">struct</span>
							<span class="n">libipw_rx_stats</span>
							    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
								<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
							<span class="p">};</span>

							<span class="n">IPW_DEBUG_QOS</span>
							    <span class="p">(</span><span class="s">&quot;QoS Associate &quot;</span>
							     <span class="s">&quot;size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
							<span class="n">libipw_rx_mgt</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span>
									 <span class="n">ieee</span><span class="p">,</span>
									 <span class="p">(</span><span class="k">struct</span>
									  <span class="n">libipw_hdr_4addr</span>
									  <span class="o">*</span><span class="p">)</span>
									 <span class="o">&amp;</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
<span class="cp">#endif</span>

					<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">);</span>

					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="k">case</span> <span class="n">CMAS_AUTHENTICATED</span>:<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span>
					    <span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span>
						      <span class="n">STATUS_AUTH</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">struct</span> <span class="n">notif_authenticate</span> <span class="o">*</span><span class="n">auth</span>
						    <span class="o">=</span> <span class="o">&amp;</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">auth</span><span class="p">;</span>
						<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span>
							  <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
							  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span>
							  <span class="s">&quot;deauthenticated: &#39;%s&#39; &quot;</span>
							  <span class="s">&quot;%pM&quot;</span>
							  <span class="s">&quot;: (0x%04X) - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							  <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span>
								     <span class="n">priv</span><span class="o">-&gt;</span>
								     <span class="n">essid</span><span class="p">,</span>
								     <span class="n">priv</span><span class="o">-&gt;</span>
								     <span class="n">essid_len</span><span class="p">),</span>
							  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
							  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span>
							  <span class="n">ipw_get_status_code</span>
							  <span class="p">(</span><span class="n">le16_to_cpu</span>
							   <span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)));</span>

						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span>
						    <span class="o">~</span><span class="p">(</span><span class="n">STATUS_ASSOCIATING</span> <span class="o">|</span>
						      <span class="n">STATUS_AUTH</span> <span class="o">|</span>
						      <span class="n">STATUS_ASSOCIATED</span><span class="p">);</span>

						<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_down</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
						  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span>
						  <span class="s">&quot;authenticated: &#39;%s&#39; %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span>
							     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">),</span>
						  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="k">case</span> <span class="n">CMAS_INIT</span>:<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_AUTH</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">struct</span>
						    <span class="n">libipw_assoc_response</span>
						<span class="o">*</span><span class="n">resp</span><span class="p">;</span>
						<span class="n">resp</span> <span class="o">=</span>
						    <span class="p">(</span><span class="k">struct</span>
						     <span class="n">libipw_assoc_response</span>
						     <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">;</span>
						<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span>
							  <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
							  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span>
							  <span class="s">&quot;association failed (0x%04X): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span>
							  <span class="n">ipw_get_status_code</span>
							  <span class="p">(</span><span class="n">le16_to_cpu</span>
							   <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)));</span>
					<span class="p">}</span>

					<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
						  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span>
						  <span class="s">&quot;disassociated: &#39;%s&#39; %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span>
							     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">),</span>
						  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>

					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span>
					    <span class="o">~</span><span class="p">(</span><span class="n">STATUS_DISASSOCIATING</span> <span class="o">|</span>
					      <span class="n">STATUS_ASSOCIATING</span> <span class="o">|</span>
					      <span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_AUTH</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span>
						<span class="n">capability</span> <span class="o">&amp;</span>
						<span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">))</span>
						<span class="n">ipw_remove_current_network</span>
						    <span class="p">(</span><span class="n">priv</span><span class="p">);</span>

					<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_down</span><span class="p">);</span>

					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="k">case</span> <span class="n">CMAS_RX_ASSOC_RESP</span>:
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;assoc: unknown (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">assoc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">HOST_NOTIFICATION_STATUS_AUTHENTICATE</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">notif_authenticate</span> <span class="o">*</span><span class="n">auth</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">auth</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">CMAS_AUTHENTICATED</span>:
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span><span class="p">,</span>
					  <span class="s">&quot;authenticated: &#39;%s&#39; %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span>
						     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">),</span>
					  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_AUTH</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">CMAS_INIT</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_AUTH</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
						  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span>
						  <span class="s">&quot;authentication failed (0x%04X): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span>
						  <span class="n">ipw_get_status_code</span><span class="p">(</span><span class="n">le16_to_cpu</span>
								      <span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span>
								       <span class="n">status</span><span class="p">)));</span>
				<span class="p">}</span>
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
					  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span>
					  <span class="s">&quot;deauthenticated: &#39;%s&#39; %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span>
						     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">),</span>
					  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>

				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STATUS_ASSOCIATING</span> <span class="o">|</span>
						  <span class="n">STATUS_AUTH</span> <span class="o">|</span>
						  <span class="n">STATUS_ASSOCIATED</span><span class="p">);</span>

				<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_down</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">CMAS_TX_AUTH_SEQ_1</span>:
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
					  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span> <span class="s">&quot;AUTH_SEQ_1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMAS_RX_AUTH_SEQ_2</span>:
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
					  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span> <span class="s">&quot;AUTH_SEQ_2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMAS_AUTH_SEQ_1_PASS</span>:
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
					  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span> <span class="s">&quot;AUTH_SEQ_1_PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMAS_AUTH_SEQ_1_FAIL</span>:
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
					  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span> <span class="s">&quot;AUTH_SEQ_1_FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMAS_TX_AUTH_SEQ_3</span>:
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
					  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span> <span class="s">&quot;AUTH_SEQ_3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMAS_RX_AUTH_SEQ_4</span>:
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
					  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span> <span class="s">&quot;RX_AUTH_SEQ_4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMAS_AUTH_SEQ_2_PASS</span>:
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
					  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span> <span class="s">&quot;AUTH_SEQ_2_PASS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMAS_AUTH_SEQ_2_FAIL</span>:
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
					  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span> <span class="s">&quot;AUT_SEQ_2_FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMAS_TX_ASSOC</span>:
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
					  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span> <span class="s">&quot;TX_ASSOC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMAS_RX_ASSOC_RESP</span>:
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
					  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span> <span class="s">&quot;RX_ASSOC_RESP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMAS_ASSOCIATED</span>:
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span>
					  <span class="n">IPW_DL_ASSOC</span><span class="p">,</span> <span class="s">&quot;ASSOCIATED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">IPW_DEBUG_NOTIF</span><span class="p">(</span><span class="s">&quot;auth: failure - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">auth</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">HOST_NOTIFICATION_STATUS_SCAN_CHANNEL_RESULT</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">notif_channel_result</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span>
			    <span class="o">&amp;</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">channel_result</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Scan result for channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">x</span><span class="o">-&gt;</span><span class="n">channel_num</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Scan result of wrong size %d &quot;</span>
					       <span class="s">&quot;(should be %zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">HOST_NOTIFICATION_STATUS_SCAN_COMPLETED</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">notif_scan_complete</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scan_complete</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">IPW_DEBUG_SCAN</span>
				    <span class="p">(</span><span class="s">&quot;Scan completed: type %d, %d channels, &quot;</span>
				     <span class="s">&quot;%d status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">scan_type</span><span class="p">,</span>
				     <span class="n">x</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Scan completed of wrong size %d &quot;</span>
					  <span class="s">&quot;(should be %zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="p">(</span><span class="n">STATUS_SCANNING</span> <span class="o">|</span> <span class="n">STATUS_SCAN_ABORTING</span><span class="p">);</span>

			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_state</span><span class="p">);</span>
			<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_check</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_EXIT_PENDING</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scans</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SCAN_FORCED</span><span class="p">;</span>
				<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_SCAN_FORCED</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_MONITOR */</span><span class="cp"></span>

			<span class="cm">/* Do queued direct scans first */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_DIRECT_SCAN_PENDING</span><span class="p">)</span>
				<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_direct_scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span>
					      <span class="n">STATUS_ASSOCIATING</span> <span class="o">|</span>
					      <span class="n">STATUS_ROAMING</span> <span class="o">|</span>
					      <span class="n">STATUS_DISASSOCIATING</span><span class="p">)))</span>
				<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">associate</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ROAMING</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">SCAN_COMPLETED_STATUS_COMPLETE</span><span class="p">)</span>
					<span class="cm">/* If a scan completed and we are in roam mode, then</span>
<span class="cm">					 * the scan that completed was the one requested as a</span>
<span class="cm">					 * result of entering roam... so, schedule the</span>
<span class="cm">					 * roam work */</span>
					<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">roam</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="cm">/* Don&#39;t schedule if we aborted the scan */</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_ROAMING</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCAN_PENDING</span><span class="p">)</span>
				<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_BACKGROUND_SCAN</span>
				 <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span>
				<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">,</span>
						      <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">HZ</span><span class="p">));</span>

			<span class="cm">/* Send an empty event to user space.</span>
<span class="cm">			 * We don&#39;t send the received data on the event because</span>
<span class="cm">			 * it would require us to do complex transcoding, and</span>
<span class="cm">			 * we want to minimise the work done in the irq handler</span>
<span class="cm">			 * Use a request to extract the data.</span>
<span class="cm">			 * Also, we generate this even for any scan, regardless</span>
<span class="cm">			 * on how the scan was initiated. User space can just</span>
<span class="cm">			 * sync on periodic scan to get fresh data...</span>
<span class="cm">			 * Jean II */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">SCAN_COMPLETED_STATUS_COMPLETE</span><span class="p">)</span>
				<span class="n">handle_scan_event</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">HOST_NOTIFICATION_STATUS_FRAG_LENGTH</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">notif_frag_length</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frag_len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
				<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Frag length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">frag_length</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Frag length of wrong size %d &quot;</span>
					  <span class="s">&quot;(should be %zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">HOST_NOTIFICATION_STATUS_LINK_DETERIORATION</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">notif_link_deterioration</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span>
			    <span class="o">&amp;</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">link_deterioration</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span><span class="p">,</span>
					<span class="s">&quot;link deterioration: type %d, cnt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">x</span><span class="o">-&gt;</span><span class="n">silence_notification_type</span><span class="p">,</span>
					<span class="n">x</span><span class="o">-&gt;</span><span class="n">silence_count</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_link_deterioration</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Link Deterioration of wrong size %d &quot;</span>
					  <span class="s">&quot;(should be %zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">HOST_NOTIFICATION_DINO_CONFIG_RESPONSE</span>:<span class="p">{</span>
			<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Dino config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hcmd</span>
			    <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">HOST_CMD_DINO_CONFIG</span><span class="p">)</span>
				<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unexpected DINO_CONFIG_RESPONSE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">HOST_NOTIFICATION_STATUS_BEACON_STATE</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">notif_beacon_state</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon_state</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">IPW_ERROR</span>
				    <span class="p">(</span><span class="s">&quot;Beacon state of wrong size %d (should &quot;</span>
				     <span class="s">&quot;be %zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">HOST_NOTIFICATION_STATUS_BEACON_MISSING</span><span class="p">)</span>
				<span class="n">ipw_handle_missed_beacon</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
							 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span>
								     <span class="n">number</span><span class="p">));</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">HOST_NOTIFICATION_STATUS_TGI_TX_KEY</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">notif_tgi_tx_key</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tgi_tx_key</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;TGi Tx Key: state 0x%02x sec type &quot;</span>
					  <span class="s">&quot;0x%02x station %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">x</span><span class="o">-&gt;</span><span class="n">key_state</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">security_type</span><span class="p">,</span>
					  <span class="n">x</span><span class="o">-&gt;</span><span class="n">station_index</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">IPW_ERROR</span>
			    <span class="p">(</span><span class="s">&quot;TGi Tx Key of wrong size %d (should be %zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">HOST_NOTIFICATION_CALIB_KEEP_RESULTS</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">notif_calibration</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">calibration</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">calib</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">));</span>
				<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;TODO: Calibration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">IPW_ERROR</span>
			    <span class="p">(</span><span class="s">&quot;Calibration of wrong size %d (should be %zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">HOST_NOTIFICATION_NOISE_STATS</span>:<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">exp_avg_noise</span> <span class="o">=</span>
				    <span class="n">exponential_average</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">exp_avg_noise</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">noise</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span>
				    <span class="n">DEPTH_NOISE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">IPW_ERROR</span>
			    <span class="p">(</span><span class="s">&quot;Noise stat is wrong size %d (should be %zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">IPW_DEBUG_NOTIF</span><span class="p">(</span><span class="s">&quot;Unknown notification: &quot;</span>
				<span class="s">&quot;subtype=%d,flags=0x%2x,size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">notif</span><span class="o">-&gt;</span><span class="n">subtype</span><span class="p">,</span> <span class="n">notif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Destroys all DMA structures and initialise them again</span>
<span class="cm"> *</span>
<span class="cm"> * @param priv</span>
<span class="cm"> * @return error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_queue_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/** @todo customize queue sizes */</span>
	<span class="kt">int</span> <span class="n">nTx</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="n">nTxCmd</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ipw_tx_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="cm">/* Tx CMD queue */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_queue_tx_init</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_cmd</span><span class="p">,</span> <span class="n">nTxCmd</span><span class="p">,</span>
			       <span class="n">IPW_TX_CMD_QUEUE_READ_INDEX</span><span class="p">,</span>
			       <span class="n">IPW_TX_CMD_QUEUE_WRITE_INDEX</span><span class="p">,</span>
			       <span class="n">IPW_TX_CMD_QUEUE_BD_BASE</span><span class="p">,</span>
			       <span class="n">IPW_TX_CMD_QUEUE_BD_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Tx Cmd queue init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Tx queue(s) */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_queue_tx_init</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nTx</span><span class="p">,</span>
			       <span class="n">IPW_TX_QUEUE_0_READ_INDEX</span><span class="p">,</span>
			       <span class="n">IPW_TX_QUEUE_0_WRITE_INDEX</span><span class="p">,</span>
			       <span class="n">IPW_TX_QUEUE_0_BD_BASE</span><span class="p">,</span> <span class="n">IPW_TX_QUEUE_0_BD_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Tx 0 queue init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_queue_tx_init</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nTx</span><span class="p">,</span>
			       <span class="n">IPW_TX_QUEUE_1_READ_INDEX</span><span class="p">,</span>
			       <span class="n">IPW_TX_QUEUE_1_WRITE_INDEX</span><span class="p">,</span>
			       <span class="n">IPW_TX_QUEUE_1_BD_BASE</span><span class="p">,</span> <span class="n">IPW_TX_QUEUE_1_BD_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Tx 1 queue init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_queue_tx_init</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nTx</span><span class="p">,</span>
			       <span class="n">IPW_TX_QUEUE_2_READ_INDEX</span><span class="p">,</span>
			       <span class="n">IPW_TX_QUEUE_2_WRITE_INDEX</span><span class="p">,</span>
			       <span class="n">IPW_TX_QUEUE_2_BD_BASE</span><span class="p">,</span> <span class="n">IPW_TX_QUEUE_2_BD_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Tx 2 queue init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_queue_tx_init</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">nTx</span><span class="p">,</span>
			       <span class="n">IPW_TX_QUEUE_3_READ_INDEX</span><span class="p">,</span>
			       <span class="n">IPW_TX_QUEUE_3_WRITE_INDEX</span><span class="p">,</span>
			       <span class="n">IPW_TX_QUEUE_3_BD_BASE</span><span class="p">,</span> <span class="n">IPW_TX_QUEUE_3_BD_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Tx 3 queue init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* statistics */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_bufs_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_pend_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

      <span class="nl">error:</span>
	<span class="n">ipw_tx_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Reclaim Tx queue entries no more used by NIC.</span>
<span class="cm"> *</span>
<span class="cm"> * When FW advances &#39;R&#39; index, all entries between old and</span>
<span class="cm"> * new &#39;R&#39; index need to be reclaimed. As result, some free space</span>
<span class="cm"> * forms. If there is enough free space (&gt; low mark), wake Tx queue.</span>
<span class="cm"> *</span>
<span class="cm"> * @note Need to protect against garbage in &#39;R&#39; index</span>
<span class="cm"> * @param priv</span>
<span class="cm"> * @param txq</span>
<span class="cm"> * @param qindex</span>
<span class="cm"> * @return Number of used entries remains in the queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_queue_tx_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">clx2_tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hw_tail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">used</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clx2_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>

	<span class="n">hw_tail</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">reg_r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_tail</span> <span class="o">&gt;=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span>
		    <span class="p">(</span><span class="s">&quot;Read index for DMA queue (%d) is out of range [0-%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">hw_tail</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">!=</span> <span class="n">hw_tail</span><span class="p">;</span>
	     <span class="n">q</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">=</span> <span class="n">ipw_queue_inc_wrap</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">last_used</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipw_queue_tx_free_tfd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="nl">done:</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ipw_tx_queue_space</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">low_mark</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">qindex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="n">used</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span> <span class="o">-</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">last_used</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">used</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">used</span> <span class="o">+=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_queue_tx_hcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hcmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clx2_tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clx2_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tfd_frame</span> <span class="o">*</span><span class="n">tfd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_tx_queue_space</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sync</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;No space for Tx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tfd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span><span class="p">];</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txb</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tfd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tfd</span><span class="p">));</span>
	<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">control_flags</span><span class="p">.</span><span class="n">message_type</span> <span class="o">=</span> <span class="n">TX_HOST_COMMAND_TYPE</span><span class="p">;</span>
	<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">control_flags</span><span class="p">.</span><span class="n">control_bits</span> <span class="o">=</span> <span class="n">TFD_NEED_IRQ_MASK</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hcmd_seq</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">hcmd</span><span class="p">;</span>
	<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span> <span class="o">=</span> <span class="n">ipw_queue_inc_wrap</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">);</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">reg_w</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span><span class="p">);</span>
	<span class="n">_ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Rx theory of operation</span>
<span class="cm"> *</span>
<span class="cm"> * The host allocates 32 DMA target addresses and passes the host address</span>
<span class="cm"> * to the firmware at register IPW_RFDS_TABLE_LOWER + N * RFD_SIZE where N is</span>
<span class="cm"> * 0 to 31</span>
<span class="cm"> *</span>
<span class="cm"> * Rx Queue Indexes</span>
<span class="cm"> * The host/firmware share two index registers for managing the Rx buffers.</span>
<span class="cm"> *</span>
<span class="cm"> * The READ index maps to the first position that the firmware may be writing</span>
<span class="cm"> * to -- the driver can read up to (but not including) this position and get</span>
<span class="cm"> * good data.</span>
<span class="cm"> * The READ index is managed by the firmware once the card is enabled.</span>
<span class="cm"> *</span>
<span class="cm"> * The WRITE index maps to the last position the driver has read from -- the</span>
<span class="cm"> * position preceding WRITE is the last slot the firmware can place a packet.</span>
<span class="cm"> *</span>
<span class="cm"> * The queue is empty (no good data) if WRITE = READ - 1, and is full if</span>
<span class="cm"> * WRITE = READ.</span>
<span class="cm"> *</span>
<span class="cm"> * During initialization the host sets up the READ queue position to the first</span>
<span class="cm"> * INDEX position, and WRITE to the last (READ - 1 wrapped)</span>
<span class="cm"> *</span>
<span class="cm"> * When the firmware places a packet in a buffer it will advance the READ index</span>
<span class="cm"> * and fire the RX interrupt.  The driver can then query the READ index and</span>
<span class="cm"> * process as many packets as possible, moving the WRITE index forward as it</span>
<span class="cm"> * resets the Rx queue buffers with new memory.</span>
<span class="cm"> *</span>
<span class="cm"> * The management in the driver is as follows:</span>
<span class="cm"> * + A list of pre-allocated SKBs is stored in ipw-&gt;rxq-&gt;rx_free.  When</span>
<span class="cm"> *   ipw-&gt;rxq-&gt;free_count drops to or below RX_LOW_WATERMARK, work is scheduled</span>
<span class="cm"> *   to replensish the ipw-&gt;rxq-&gt;rx_free.</span>
<span class="cm"> * + In ipw_rx_queue_replenish (scheduled) if &#39;processed&#39; != &#39;read&#39; then the</span>
<span class="cm"> *   ipw-&gt;rxq is replenished and the READ INDEX is updated (updating the</span>
<span class="cm"> *   &#39;processed&#39; and &#39;read&#39; driver indexes as well)</span>
<span class="cm"> * + A received packet is processed and handed to the kernel network stack,</span>
<span class="cm"> *   detached from the ipw-&gt;rxq.  The driver &#39;processed&#39; index is updated.</span>
<span class="cm"> * + The Host/Firmware ipw-&gt;rxq is replenished at tasklet time from the rx_free</span>
<span class="cm"> *   list. If there are no allocated buffers in ipw-&gt;rxq-&gt;rx_free, the READ</span>
<span class="cm"> *   INDEX is not incremented and ipw-&gt;status(RX_STALLED) is set.  If there</span>
<span class="cm"> *   were enough free buffers and RX_STALLED is set it is cleared.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Driver sequence:</span>
<span class="cm"> *</span>
<span class="cm"> * ipw_rx_queue_alloc()       Allocates rx_free</span>
<span class="cm"> * ipw_rx_queue_replenish()   Replenishes rx_free list from rx_used, and calls</span>
<span class="cm"> *                            ipw_rx_queue_restock</span>
<span class="cm"> * ipw_rx_queue_restock()     Moves available buffers from rx_free into Rx</span>
<span class="cm"> *                            queue, updates firmware pointers, and updates</span>
<span class="cm"> *                            the WRITE index.  If insufficient rx_free buffers</span>
<span class="cm"> *                            are available, schedules ipw_rx_queue_replenish</span>
<span class="cm"> *</span>
<span class="cm"> * -- enable interrupts --</span>
<span class="cm"> * ISR - ipw_rx()             Detach ipw_rx_mem_buffers from pool up to the</span>
<span class="cm"> *                            READ INDEX, detaching the SKB from the pool.</span>
<span class="cm"> *                            Moves the packet buffer from queue to rx_used.</span>
<span class="cm"> *                            Calls ipw_rx_queue_restock to refill any empty</span>
<span class="cm"> *                            slots.</span>
<span class="cm"> * ...</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * If there are slots in the RX queue that  need to be restocked,</span>
<span class="cm"> * and we have free pre-allocated buffers, fill the ranks as much</span>
<span class="cm"> * as we can pulling from rx_free.</span>
<span class="cm"> *</span>
<span class="cm"> * This moves the &#39;write&#39; index forward to catch up with &#39;processed&#39;, and</span>
<span class="cm"> * also updates the memory address in the firmware to reference the new</span>
<span class="cm"> * target buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_rx_queue_restock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_rx_mem_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">write</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ipw_rx_queue_space</span><span class="p">(</span><span class="n">rxq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">element</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_free</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">rxb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_rx_mem_buffer</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>

		<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RFDS_TABLE_LOWER</span> <span class="o">+</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">*</span> <span class="n">RFD_SIZE</span><span class="p">,</span>
			    <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">]</span> <span class="o">=</span> <span class="n">rxb</span><span class="p">;</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_QUEUE_SIZE</span><span class="p">;</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* If the pre-allocated buffer pool is dropping low, schedule to</span>
<span class="cm">	 * refill it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span> <span class="o">&lt;=</span> <span class="n">RX_LOW_WATERMARK</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_replenish</span><span class="p">);</span>

	<span class="cm">/* If we&#39;ve added more space for the firmware to place data, tell it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write</span> <span class="o">!=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
		<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RX_WRITE_INDEX</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Move all used packet from rx_used to rx_free, allocating a new SKB for each.</span>
<span class="cm"> * Also restock the Rx queue via ipw_rx_queue_restock.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called as a scheduled work item (except for during intialization)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_rx_queue_replenish</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_rx_mem_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">element</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">rxb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_rx_mem_buffer</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">IPW_RX_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: Can not allocate SKB buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="cm">/* We don&#39;t reschedule replenish work here -- we will</span>
<span class="cm">			 * call the restock method and if it still needs</span>
<span class="cm">			 * more buffers it will schedule replenish */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>

		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span>
		    <span class="n">pci_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				   <span class="n">IPW_RX_BUF_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_free</span><span class="p">);</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ipw_rx_queue_restock</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_rx_queue_replenish</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">rx_replenish</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_rx_queue_replenish</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Assumes that the skb field of the buffers in &#39;pool&#39; is kept accurate.</span>
<span class="cm"> * If an SKB has been detached, the POOL needs to have its SKB set to NULL</span>
<span class="cm"> * This free routine walks the list of POOL entries and if SKB is set to</span>
<span class="cm"> * non NULL it is unmapped and freed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_rx_queue_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxq</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_QUEUE_SIZE</span> <span class="o">+</span> <span class="n">RX_FREE_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_addr</span><span class="p">,</span>
					 <span class="n">IPW_RX_BUF_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rxq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipw_rx_queue</span> <span class="o">*</span><span class="nf">ipw_rx_queue_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rxq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rxq</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">rxq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;memory allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_free</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">);</span>

	<span class="cm">/* Fill the rx_used queue with _all_ of the Rx buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_FREE_BUFFERS</span> <span class="o">+</span> <span class="n">RX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">);</span>

	<span class="cm">/* Set us so that we have processed and used all buffers, but have</span>
<span class="cm">	 * not restocked the Rx queue with fresh buffers */</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rxq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_is_rate_in_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ieee_mode</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LIBIPW_BASIC_RATE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee_mode</span> <span class="o">==</span> <span class="n">IEEE_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_6MB</span>:
			<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_6MB_MASK</span> <span class="o">?</span>
			    <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_9MB</span>:
			<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_9MB_MASK</span> <span class="o">?</span>
			    <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_12MB</span>:
			<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span>
			    <span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_12MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_18MB</span>:
			<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span>
			    <span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_18MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_24MB</span>:
			<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span>
			    <span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_24MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_36MB</span>:
			<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span>
			    <span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_36MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_48MB</span>:
			<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span>
			    <span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_48MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_54MB</span>:
			<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span>
			    <span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_54MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* B and G mixed */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LIBIPW_CCK_RATE_1MB</span>:
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CCK_RATE_1MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_CCK_RATE_2MB</span>:
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CCK_RATE_2MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_CCK_RATE_5MB</span>:
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CCK_RATE_5MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_CCK_RATE_11MB</span>:
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CCK_RATE_11MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If we are limited to B modulations, bail at this point */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee_mode</span> <span class="o">==</span> <span class="n">IEEE_B</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* G */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_6MB</span>:
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_6MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_9MB</span>:
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_9MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_12MB</span>:
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_12MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_18MB</span>:
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_18MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_24MB</span>:
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_24MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_36MB</span>:
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_36MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_48MB</span>:
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_48MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LIBIPW_OFDM_RATE_54MB</span>:
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_54MB_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_compatible_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipw_supported_rates</span> <span class="o">*</span><span class="n">rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_rates</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rates</span><span class="p">));</span>
	<span class="n">num_rates</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">IPW_MAX_RATES</span><span class="p">);</span>
	<span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_rates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw_is_rate_in_mask</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span>
					 <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LIBIPW_BASIC_RATE_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Adding masked mandatory &quot;</span>
					       <span class="s">&quot;rate %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Rate %02X masked : 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">num_rates</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">IPW_MAX_RATES</span> <span class="o">-</span> <span class="n">num_rates</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_rates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw_is_rate_in_mask</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span>
					 <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LIBIPW_BASIC_RATE_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Adding masked mandatory &quot;</span>
					       <span class="s">&quot;rate %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Rate %02X masked : 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_copy_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_supported_rates</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">ipw_supported_rates</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dest</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">dest</span><span class="o">-&gt;</span><span class="n">num_rates</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TODO: Look at sniffed packets in the air to determine if the basic rate</span>
<span class="cm"> * mask should ever be used -- right now all callers to add the scan rates are</span>
<span class="cm"> * set with the modulation = CCK, so BASIC_RATE_MASK is never set... */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_add_cck_scan_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_supported_rates</span> <span class="o">*</span><span class="n">rates</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">modulation</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rate_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">basic_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">LIBIPW_OFDM_MODULATION</span> <span class="o">==</span> <span class="n">modulation</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">LIBIPW_BASIC_RATE_MASK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CCK_RATE_1MB_MASK</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">LIBIPW_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">LIBIPW_CCK_RATE_1MB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CCK_RATE_2MB_MASK</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">LIBIPW_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">LIBIPW_CCK_RATE_2MB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CCK_RATE_5MB_MASK</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_mask</span> <span class="o">|</span>
		    <span class="n">LIBIPW_CCK_RATE_5MB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CCK_RATE_11MB_MASK</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_mask</span> <span class="o">|</span>
		    <span class="n">LIBIPW_CCK_RATE_11MB</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_add_ofdm_scan_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_supported_rates</span> <span class="o">*</span><span class="n">rates</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="n">modulation</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rate_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">basic_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">LIBIPW_OFDM_MODULATION</span> <span class="o">==</span> <span class="n">modulation</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">LIBIPW_BASIC_RATE_MASK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_6MB_MASK</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_mask</span> <span class="o">|</span>
		    <span class="n">LIBIPW_OFDM_RATE_6MB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_9MB_MASK</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">LIBIPW_OFDM_RATE_9MB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_12MB_MASK</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_mask</span> <span class="o">|</span>
		    <span class="n">LIBIPW_OFDM_RATE_12MB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_18MB_MASK</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">LIBIPW_OFDM_RATE_18MB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_24MB_MASK</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_mask</span> <span class="o">|</span>
		    <span class="n">LIBIPW_OFDM_RATE_24MB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_36MB_MASK</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">LIBIPW_OFDM_RATE_36MB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_48MB_MASK</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">LIBIPW_OFDM_RATE_48MB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_RATE_54MB_MASK</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">LIBIPW_OFDM_RATE_54MB</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ipw_network_match</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_supported_rates</span> <span class="n">rates</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_find_adhoc_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ipw_network_match</span> <span class="o">*</span><span class="n">match</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">roaming</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_supported_rates</span> <span class="n">rates</span><span class="p">;</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>

	<span class="cm">/* Verify that this network&#39;s capability is compatible with the</span>
<span class="cm">	 * current mode (AdHoc or Infrastructure) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded due to &quot;</span>
				<span class="s">&quot;capability mismatch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">roaming</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If we are roaming, then ensure check if this is a valid</span>
<span class="cm">		 * network to try and roam to */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">!=</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
			   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
					<span class="s">&quot;because of non-network ESSID.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
						   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If an ESSID has been configured then compare the broadcast</span>
<span class="cm">		 * ESSID to ours */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_ESSID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">memcmp</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span>
			    <span class="n">min</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">))))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">escaped</span><span class="p">[</span><span class="n">IW_ESSID_MAX_SIZE</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

			<span class="n">strncpy</span><span class="p">(</span><span class="n">escaped</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">escaped</span><span class="p">));</span>
			<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
					<span class="s">&quot;because of ESSID mismatch: &#39;%s&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">escaped</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
					<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span>
						   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If the old network rate is better than this one, don&#39;t bother</span>
<span class="cm">	 * testing everything else. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;Network &#39;%s excluded because newer than &quot;</span>
				<span class="s">&quot;current network.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;Network &#39;%s excluded because newer than &quot;</span>
				<span class="s">&quot;current network.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now go through and see if the requested network is valid... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of age: %ums.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span>
						 <span class="n">network</span><span class="o">-&gt;</span><span class="n">last_scanned</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_CHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of channel mismatch: %d != %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Verify privacy compatibility */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of privacy mismatch: %s != %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span>
				<span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
				<span class="n">network</span><span class="o">-&gt;</span>
				<span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span>
				<span class="s">&quot;off&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of the same BSSID match: %pM&quot;</span>
				<span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
						  <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Filter out any incompatible freq / mode combinations */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">libipw_is_valid_mode</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of invalid frequency/mode &quot;</span>
				<span class="s">&quot;combination.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure that the rates supported by the driver are compatible with</span>
<span class="cm">	 * this AP, including verification of basic rates (mandatory) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw_compatible_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rates</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because configured rate mask excludes &quot;</span>
				<span class="s">&quot;AP mandatory rate.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">.</span><span class="n">num_rates</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of no compatible rates.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: Perform any further minimal comparititive tests.  We do not</span>
<span class="cm">	 * want to put too much policy logic here; intelligent scan selection</span>
<span class="cm">	 * should occur within a generic IEEE 802.11 user space tool.  */</span>

	<span class="cm">/* Set up &#39;new&#39; AP to this network */</span>
	<span class="n">ipw_copy_rates</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rates</span><span class="p">);</span>
	<span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span> <span class="o">=</span> <span class="n">network</span><span class="p">;</span>
	<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; is a viable match.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_merge_adhoc_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">merge_networks</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_network_match</span> <span class="n">match</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* First pass through ROAM process -- look for a better</span>
<span class="cm">		 * network */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">network</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="p">)</span>
				<span class="n">ipw_find_adhoc_network</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span>
						       <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">network</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;No better ADHOC in this network to &quot;</span>
					<span class="s">&quot;merge to.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_MERGE</span><span class="p">(</span><span class="s">&quot;remove network %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span>
						   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">));</span>
			<span class="n">ipw_remove_current_network</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span> <span class="o">=</span> <span class="n">match</span><span class="p">.</span><span class="n">network</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_best_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ipw_network_match</span> <span class="o">*</span><span class="n">match</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span><span class="p">,</span> <span class="kt">int</span> <span class="n">roaming</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_supported_rates</span> <span class="n">rates</span><span class="p">;</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>

	<span class="cm">/* Verify that this network&#39;s capability is compatible with the</span>
<span class="cm">	 * current mode (AdHoc or Infrastructure) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_ESS</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded due to &quot;</span>
				<span class="s">&quot;capability mismatch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">roaming</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If we are roaming, then ensure check if this is a valid</span>
<span class="cm">		 * network to try and roam to */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">!=</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
			   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
					<span class="s">&quot;because of non-network ESSID.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
						   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If an ESSID has been configured then compare the broadcast</span>
<span class="cm">		 * ESSID to ours */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_ESSID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">memcmp</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span>
			    <span class="n">min</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">))))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">escaped</span><span class="p">[</span><span class="n">IW_ESSID_MAX_SIZE</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">escaped</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">escaped</span><span class="p">));</span>
			<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
					<span class="s">&quot;because of ESSID mismatch: &#39;%s&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">escaped</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
					<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span>
						   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If the old network rate is better than this one, don&#39;t bother</span>
<span class="cm">	 * testing everything else. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span> <span class="o">&amp;&amp;</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rssi</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">escaped</span><span class="p">[</span><span class="n">IW_ESSID_MAX_SIZE</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">escaped</span><span class="p">,</span>
			<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">escaped</span><span class="p">));</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded because &quot;</span>
				<span class="s">&quot;&#39;%s (%pM)&#39; has a stronger signal.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">escaped</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If this network has already had an association attempt within the</span>
<span class="cm">	 * last 3 seconds, do not try and associate again... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">last_associate</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">last_associate</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">3UL</span><span class="p">),</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of storming (%ums since last &quot;</span>
				<span class="s">&quot;assoc attempt).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span>
						 <span class="n">network</span><span class="o">-&gt;</span><span class="n">last_associate</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now go through and see if the requested network is valid... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of age: %ums.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span>
						 <span class="n">network</span><span class="o">-&gt;</span><span class="n">last_scanned</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_CHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of channel mismatch: %d != %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Verify privacy compatibility */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of privacy mismatch: %s != %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span>
				<span class="s">&quot;off&quot;</span><span class="p">,</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span>
				<span class="n">WLAN_CAPABILITY_PRIVACY</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_BSSID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of BSSID mismatch: %pM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Filter out any incompatible freq / mode combinations */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">libipw_is_valid_mode</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of invalid frequency/mode &quot;</span>
				<span class="s">&quot;combination.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Filter out invalid channel in current GEO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">libipw_is_valid_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of invalid channel in current GEO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure that the rates supported by the driver are compatible with</span>
<span class="cm">	 * this AP, including verification of basic rates (mandatory) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw_compatible_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rates</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because configured rate mask excludes &quot;</span>
				<span class="s">&quot;AP mandatory rate.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">.</span><span class="n">num_rates</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; excluded &quot;</span>
				<span class="s">&quot;because of no compatible rates.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					   <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: Perform any further minimal comparititive tests.  We do not</span>
<span class="cm">	 * want to put too much policy logic here; intelligent scan selection</span>
<span class="cm">	 * should occur within a generic IEEE 802.11 user space tool.  */</span>

	<span class="cm">/* Set up &#39;new&#39; AP to this network */</span>
	<span class="n">ipw_copy_rates</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rates</span><span class="p">);</span>
	<span class="n">match</span><span class="o">-&gt;</span><span class="n">network</span> <span class="o">=</span> <span class="n">network</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Network &#39;%s (%pM)&#39; is a viable match.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_adhoc_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">libipw_geo</span> <span class="o">*</span><span class="n">geo</span> <span class="o">=</span> <span class="n">libipw_get_geo</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For the purposes of scanning, we can set our wireless mode</span>
<span class="cm">	 * to trigger scans across combinations of bands, but when it</span>
<span class="cm">	 * comes to creating a new ad-hoc network, we have tell the FW</span>
<span class="cm">	 * exactly which band to use.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We also have the possibility of an invalid channel for the</span>
<span class="cm">	 * chossen band.  Attempting to create a new ad-hoc network</span>
<span class="cm">	 * with an invalid channel for wireless mode will trigger a</span>
<span class="cm">	 * FW fatal error.</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">libipw_is_valid_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LIBIPW_52GHZ_BAND</span>:
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_A</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">libipw_channel_to_index</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;Overriding invalid channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LIBIPW_24GHZ_BAND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_G</span><span class="p">)</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_G</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_B</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">libipw_channel_to_index</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;Overriding invalid channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;Overriding invalid channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_A</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_G</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_B</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">network</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_ADHOC_PERSIST</span><span class="p">;</span>
	<span class="n">ipw_create_bssid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_PREAMBLE_LONG</span><span class="p">))</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span><span class="p">)</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">.</span><span class="n">num_rates</span><span class="p">,</span> <span class="n">MAX_RATES_LENGTH</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">.</span><span class="n">supported_rates</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">);</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">.</span><span class="n">num_rates</span> <span class="o">-</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">.</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">],</span>
	       <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">);</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">last_associate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>	<span class="cm">/* Default */</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* Default */</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">atim_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Default */</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_send_tgi_tx_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_tgi_tx_key</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">key_id</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">SCM_TEMPORAL_KEY_LENGTH</span><span class="p">);</span>
	<span class="n">key</span><span class="p">.</span><span class="n">security_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">station_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* always 0 for BSS */</span>
	<span class="n">key</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* 0 for new key; previous value of counter (after fatal error) */</span>
	<span class="n">key</span><span class="p">.</span><span class="n">tx_counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">key</span><span class="p">.</span><span class="n">tx_counter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_TGI_TX_KEY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_send_wep_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_wep_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">key</span><span class="p">.</span><span class="n">cmd_id</span> <span class="o">=</span> <span class="n">DINO_CMD_WEP_KEY</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">seq_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Note: AES keys cannot be set for multiple times.</span>
<span class="cm">	 * Only set it at the first time. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">key</span><span class="p">.</span><span class="n">key_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">|</span> <span class="n">type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">key</span><span class="p">.</span><span class="n">key_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">key</span><span class="p">.</span><span class="n">key_size</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">key</span><span class="p">.</span><span class="n">key_size</span><span class="p">);</span>

		<span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_WEP_KEY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_set_hw_decrypt_unicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_3</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">disable_unicast_decryption</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_2</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">disable_unicast_decryption</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_1</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">disable_unicast_decryption</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_0</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">disable_unicast_decryption</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_set_hw_decrypt_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_3</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">disable_multicast_decryption</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_2</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">disable_multicast_decryption</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_1</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">disable_multicast_decryption</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_0</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">disable_multicast_decryption</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_set_hwcrypto_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_ACTIVE_KEY</span><span class="p">)</span>
			<span class="n">ipw_send_tgi_tx_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					    <span class="n">DCT_FLAG_EXT_SECURITY_CCM</span><span class="p">,</span>
					    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">active_key</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_mc_decrypt</span><span class="p">)</span>
			<span class="n">ipw_send_wep_keys</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DCW_WEP_KEY_SEC_TYPE_CCM</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_ACTIVE_KEY</span><span class="p">)</span>
			<span class="n">ipw_send_tgi_tx_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					    <span class="n">DCT_FLAG_EXT_SECURITY_TKIP</span><span class="p">,</span>
					    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">active_key</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_1</span>:
		<span class="n">ipw_send_wep_keys</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DCW_WEP_KEY_SEC_TYPE_WEP</span><span class="p">);</span>
		<span class="n">ipw_set_hw_decrypt_unicast</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>
		<span class="n">ipw_set_hw_decrypt_multicast</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_0</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_adhoc_check</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">missed_adhoc_beacons</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">disassociate_threshold</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_ADHOC_PERSIST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_INFO</span> <span class="o">|</span> <span class="n">IPW_DL_NOTIF</span> <span class="o">|</span>
			  <span class="n">IPW_DL_STATE</span> <span class="o">|</span> <span class="n">IPW_DL_ASSOC</span><span class="p">,</span>
			  <span class="s">&quot;Missed beacon: %d - disassociate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">missed_adhoc_beacons</span><span class="p">);</span>
		<span class="n">ipw_remove_current_network</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_check</span><span class="p">,</span>
			      <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_adhoc_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">adhoc_check</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_adhoc_check</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_debug_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Scan completed, no valid APs matched &quot;</span>
		       <span class="s">&quot;[CFG 0x%08X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_CHANNEL</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Channel locked to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Channel unlocked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_ESSID</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;ESSID locked to &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;ESSID unlocked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_BSSID</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;BSSID locked to %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;BSSID unlocked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;PRIVACY on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;PRIVACY off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;RATE MASK: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_set_fixed_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO: Verify that this works... */</span>
	<span class="k">struct</span> <span class="n">ipw_fixed_rate</span> <span class="n">fr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">new_tx_rates</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span><span class="p">;</span>

	<span class="cm">/* Identify &#39;current FW band&#39; and match it with the fixed</span>
<span class="cm">	 * Tx rates */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">freq_band</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LIBIPW_52GHZ_BAND</span>:	<span class="cm">/* A only */</span>
		<span class="cm">/* IEEE_A */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LIBIPW_OFDM_RATES_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Invalid fixed rate mask */</span>
			<span class="n">IPW_DEBUG_WX</span>
			    <span class="p">(</span><span class="s">&quot;invalid fixed rate mask in ipw_set_fixed_rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">new_tx_rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">new_tx_rates</span> <span class="o">&gt;&gt;=</span> <span class="n">LIBIPW_OFDM_SHIFT_MASK_A</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>		<span class="cm">/* 2.4Ghz or Mixed */</span>
		<span class="cm">/* IEEE_B */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_B</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_tx_rates</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LIBIPW_CCK_RATES_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Invalid fixed rate mask */</span>
				<span class="n">IPW_DEBUG_WX</span>
				    <span class="p">(</span><span class="s">&quot;invalid fixed rate mask in ipw_set_fixed_rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">new_tx_rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* IEEE_G */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_tx_rates</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LIBIPW_CCK_RATES_MASK</span> <span class="o">|</span>
				    <span class="n">LIBIPW_OFDM_RATES_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Invalid fixed rate mask */</span>
			<span class="n">IPW_DEBUG_WX</span>
			    <span class="p">(</span><span class="s">&quot;invalid fixed rate mask in ipw_set_fixed_rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">new_tx_rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">LIBIPW_OFDM_RATE_6MB_MASK</span> <span class="o">&amp;</span> <span class="n">new_tx_rates</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">LIBIPW_OFDM_RATE_6MB_MASK</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">new_tx_rates</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LIBIPW_OFDM_RATE_6MB_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">LIBIPW_OFDM_RATE_9MB_MASK</span> <span class="o">&amp;</span> <span class="n">new_tx_rates</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">LIBIPW_OFDM_RATE_9MB_MASK</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">new_tx_rates</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LIBIPW_OFDM_RATE_9MB_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">LIBIPW_OFDM_RATE_12MB_MASK</span> <span class="o">&amp;</span> <span class="n">new_tx_rates</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">LIBIPW_OFDM_RATE_12MB_MASK</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">new_tx_rates</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LIBIPW_OFDM_RATE_12MB_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">new_tx_rates</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fr</span><span class="p">.</span><span class="n">tx_rates</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">new_tx_rates</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_MEM_FIXED_OVERRIDE</span><span class="p">);</span>
	<span class="n">ipw_write_reg32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_abort_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCAN_ABORTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Ignoring concurrent scan abort request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SCAN_ABORTING</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_send_scan_abort</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Request to abort scan failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_add_scan_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ipw_scan_request_ext</span> <span class="o">*</span><span class="n">scan</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">scan_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">channel_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">libipw_geo</span> <span class="o">*</span><span class="n">geo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">geo</span> <span class="o">=</span> <span class="n">libipw_get_geo</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">freq_band</span> <span class="o">&amp;</span> <span class="n">LIBIPW_52GHZ_BAND</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">channel_index</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">channel_index</span><span class="o">++</span><span class="p">;</span>
			<span class="n">scan</span><span class="o">-&gt;</span><span class="n">channels_list</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">ipw_set_scan_type</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">,</span>
					  <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
					  <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span> <span class="o">?</span>
					  <span class="n">IPW_SCAN_PASSIVE_FULL_DWELL_SCAN</span> <span class="o">:</span>
					  <span class="n">scan_type</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="n">channel_index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scan</span><span class="o">-&gt;</span><span class="n">channels_list</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">IPW_A_MODE</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">channel_index</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
			<span class="n">channel_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">freq_band</span> <span class="o">&amp;</span> <span class="n">LIBIPW_24GHZ_BAND</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">channel_index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_SPEED_SCAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">channels</span><span class="p">[</span><span class="n">LIBIPW_24GHZ_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
				<span class="cm">/* nop out the list */</span>
				<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="p">};</span>

			<span class="n">u8</span> <span class="n">channel</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">channel_index</span> <span class="o">&lt;</span> <span class="n">IPW_SCAN_CHANNELS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">channel</span> <span class="o">=</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed_scan</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed_scan_pos</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed_scan_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">channel</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed_scan</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">channel</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed_scan_pos</span><span class="o">++</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* If this channel has already been</span>
<span class="cm">				 * added in scan, break from loop</span>
<span class="cm">				 * and this will be the first channel</span>
<span class="cm">				 * in the next scan.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">channels</span><span class="p">[</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">speed_scan_pos</span><span class="o">++</span><span class="p">;</span>
				<span class="n">channel_index</span><span class="o">++</span><span class="p">;</span>
				<span class="n">scan</span><span class="o">-&gt;</span><span class="n">channels_list</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
				<span class="n">index</span> <span class="o">=</span>
				    <span class="n">libipw_channel_to_index</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
				<span class="n">ipw_set_scan_type</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">,</span>
						  <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">index</span><span class="p">].</span>
						  <span class="n">flags</span> <span class="o">&amp;</span>
						  <span class="n">LIBIPW_CH_PASSIVE_ONLY</span> <span class="o">?</span>
						  <span class="n">IPW_SCAN_PASSIVE_FULL_DWELL_SCAN</span>
						  <span class="o">:</span> <span class="n">scan_type</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">channel_index</span><span class="o">++</span><span class="p">;</span>
				<span class="n">scan</span><span class="o">-&gt;</span><span class="n">channels_list</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
				<span class="n">ipw_set_scan_type</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">,</span>
						  <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						  <span class="n">flags</span> <span class="o">&amp;</span>
						  <span class="n">LIBIPW_CH_PASSIVE_ONLY</span> <span class="o">?</span>
						  <span class="n">IPW_SCAN_PASSIVE_FULL_DWELL_SCAN</span>
						  <span class="o">:</span> <span class="n">scan_type</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="n">channel_index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scan</span><span class="o">-&gt;</span><span class="n">channels_list</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">IPW_B_MODE</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">channel_index</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_passive_dwell_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* staying on passive channels longer than the DTIM interval during a</span>
<span class="cm">	 * scan, while associated, causes the firmware to cancel the scan</span>
<span class="cm">	 * without notification. Hence, don&#39;t stay on passive channels longer</span>
<span class="cm">	 * than the beacon interval.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span>
	    <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">120</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_request_scan_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_scan_request_ext</span> <span class="n">scan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scan_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INIT</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_EXIT_PENDING</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">direct</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">direct_scan_ssid_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Direct scan requested but no SSID to scan for</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_DIRECT_SCAN_PENDING</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCANNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Concurrent scan requested.  Queuing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">direct</span> <span class="o">?</span> <span class="n">STATUS_DIRECT_SCAN_PENDING</span> <span class="o">:</span>
					<span class="n">STATUS_SCAN_PENDING</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCAN_FORCED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCAN_ABORTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Scan request while abort pending.  Queuing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">direct</span> <span class="o">?</span> <span class="n">STATUS_DIRECT_SCAN_PENDING</span> <span class="o">:</span>
					<span class="n">STATUS_SCAN_PENDING</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Queuing scan due to RF Kill activation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">direct</span> <span class="o">?</span> <span class="n">STATUS_DIRECT_SCAN_PENDING</span> <span class="o">:</span>
					<span class="n">STATUS_SCAN_PENDING</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan</span><span class="p">));</span>
	<span class="n">scan</span><span class="p">.</span><span class="n">full_scan_index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">libipw_get_scans</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IW_SCAN_TYPE_PASSIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;use passive scanning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">scan_type</span> <span class="o">=</span> <span class="n">IPW_SCAN_PASSIVE_FULL_DWELL_SCAN</span><span class="p">;</span>
		<span class="n">scan</span><span class="p">.</span><span class="n">dwell_time</span><span class="p">[</span><span class="n">IPW_SCAN_PASSIVE_FULL_DWELL_SCAN</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ipw_passive_dwell_time</span><span class="p">(</span><span class="n">priv</span><span class="p">));</span>
		<span class="n">ipw_add_scan_channels</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan</span><span class="p">,</span> <span class="n">scan_type</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">send_request</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use active scan by default. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_SPEED_SCAN</span><span class="p">)</span>
		<span class="n">scan</span><span class="p">.</span><span class="n">dwell_time</span><span class="p">[</span><span class="n">IPW_SCAN_ACTIVE_BROADCAST_SCAN</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">scan</span><span class="p">.</span><span class="n">dwell_time</span><span class="p">[</span><span class="n">IPW_SCAN_ACTIVE_BROADCAST_SCAN</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">scan</span><span class="p">.</span><span class="n">dwell_time</span><span class="p">[</span><span class="n">IPW_SCAN_ACTIVE_BROADCAST_AND_DIRECT_SCAN</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">scan</span><span class="p">.</span><span class="n">dwell_time</span><span class="p">[</span><span class="n">IPW_SCAN_PASSIVE_FULL_DWELL_SCAN</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ipw_passive_dwell_time</span><span class="p">(</span><span class="n">priv</span><span class="p">));</span>
	<span class="n">scan</span><span class="p">.</span><span class="n">dwell_time</span><span class="p">[</span><span class="n">IPW_SCAN_ACTIVE_DIRECT_SCAN</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">libipw_is_valid_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LIBIPW_52GHZ_BAND</span>:
			<span class="n">band</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">IPW_A_MODE</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LIBIPW_24GHZ_BAND</span>:
			<span class="n">band</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">IPW_B_MODE</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">band</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">IPW_B_MODE</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">scan</span><span class="p">.</span><span class="n">channels_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>
		<span class="n">scan</span><span class="p">.</span><span class="n">channels_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">ipw_set_scan_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPW_SCAN_PASSIVE_FULL_DWELL_SCAN</span><span class="p">);</span>

		<span class="cm">/* NOTE:  The card will sit on this channel for this time</span>
<span class="cm">		 * period.  Scan aborts are timing sensitive and frequently</span>
<span class="cm">		 * result in firmware restarts.  As such, it is best to</span>
<span class="cm">		 * set a small dwell_time here and just keep re-issuing</span>
<span class="cm">		 * scans.  Otherwise fast channel hopping will not actually</span>
<span class="cm">		 * hop channels.</span>
<span class="cm">		 *</span>
<span class="cm">		 * TODO: Move SPEED SCAN support to all modes and bands */</span>
		<span class="n">scan</span><span class="p">.</span><span class="n">dwell_time</span><span class="p">[</span><span class="n">IPW_SCAN_PASSIVE_FULL_DWELL_SCAN</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_MONITOR */</span><span class="cp"></span>
		<span class="cm">/* Honor direct scans first, otherwise if we are roaming make</span>
<span class="cm">		 * this a direct scan for the current network.  Finally,</span>
<span class="cm">		 * ensure that every other scan is a fast channel hop scan */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">direct</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_send_ssid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">direct_scan_ssid</span><span class="p">,</span>
			                    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">direct_scan_ssid_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Attempt to send SSID command  &quot;</span>
					     <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">scan_type</span> <span class="o">=</span> <span class="n">IPW_SCAN_ACTIVE_BROADCAST_AND_DIRECT_SCAN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ROAMING</span><span class="p">)</span>
			   <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span>
			       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_ESSID</span><span class="p">)</span>
			       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="p">.</span><span class="n">full_scan_index</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_send_ssid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Attempt to send SSID command &quot;</span>
					     <span class="s">&quot;failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">scan_type</span> <span class="o">=</span> <span class="n">IPW_SCAN_ACTIVE_BROADCAST_AND_DIRECT_SCAN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">scan_type</span> <span class="o">=</span> <span class="n">IPW_SCAN_ACTIVE_BROADCAST_SCAN</span><span class="p">;</span>

		<span class="n">ipw_add_scan_channels</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan</span><span class="p">,</span> <span class="n">scan_type</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="nl">send_request:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_send_scan_request_ext</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Sending scan command failed: %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SCANNING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">direct</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_DIRECT_SCAN_PENDING</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">direct_scan_ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_SCAN_PENDING</span><span class="p">;</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_check</span><span class="p">,</span> <span class="n">IPW_SCAN_CHECK_WATCHDOG</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_request_passive_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">request_passive_scan</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">ipw_request_scan_helper</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IW_SCAN_TYPE_PASSIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_request_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">request_scan</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">ipw_request_scan_helper</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IW_SCAN_TYPE_ACTIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_request_direct_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">request_direct_scan</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">ipw_request_scan_helper</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IW_SCAN_TYPE_ACTIVE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_abort_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">abort_scan</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_abort_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wpa_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is called when wpa_supplicant loads and closes the driver</span>
<span class="cm">	 * interface. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_enabled</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wpa_set_auth_algs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">libipw_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">libipw_security</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SEC_AUTH_MODE</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_SHARED_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_OPEN_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_LEAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WLAN_AUTH_LEAP</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_wpa_assoc_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">wpa_ie</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">wpa_ie_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* make sure WPA is enabled */</span>
	<span class="n">ipw_wpa_enable</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_set_rsn_capa</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">capabilities</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;HOST_CMD_RSN_CAPABILITIES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_RSN_CAPABILITIES</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
				<span class="n">capabilities</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * WE-18 support</span>
<span class="cm"> */</span>

<span class="cm">/* SIOCSIWGENIE */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_genie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">libipw_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">MAX_WPA_IE_LEN</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">extra</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipw_wpa_assoc_frame</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
      <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SIOCGIWGENIE */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_genie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">libipw_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>

      <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wext_cipher2level</span><span class="p">(</span><span class="kt">int</span> <span class="n">cipher</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_NONE</span>:
		<span class="k">return</span> <span class="n">SEC_LEVEL_0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_WEP40</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_WEP104</span>:
		<span class="k">return</span> <span class="n">SEC_LEVEL_1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_TKIP</span>:
		<span class="k">return</span> <span class="n">SEC_LEVEL_2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_CCMP</span>:
		<span class="k">return</span> <span class="n">SEC_LEVEL_3</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* SIOCSIWAUTH */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">libipw_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
		<span class="n">ipw_set_hw_decrypt_unicast</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					   <span class="n">wext_cipher2level</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
		<span class="n">ipw_set_hw_decrypt_multicast</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					     <span class="n">wext_cipher2level</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * ipw2200 does not use these parameters</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_TKIP_COUNTERMEASURES</span>:
		<span class="n">crypt</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt</span> <span class="o">||</span> <span class="o">!</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_flags</span> <span class="o">||</span> <span class="o">!</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_flags</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_flags</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_CRYPTO_TKIP_COUNTERMEASURES</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_CRYPTO_TKIP_COUNTERMEASURES</span><span class="p">;</span>

		<span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:<span class="p">{</span>
			<span class="cm">/* HACK:</span>
<span class="cm">			 *</span>
<span class="cm">			 * wpa_supplicant calls set_wpa_enabled when the driver</span>
<span class="cm">			 * is loaded and unloaded, regardless of if WPA is being</span>
<span class="cm">			 * used.  No other calls are made which can be used to</span>
<span class="cm">			 * determine if encryption will be used or not prior to</span>
<span class="cm">			 * association being expected.  If encryption is not being</span>
<span class="cm">			 * used, drop_unencrypted is set to false, else true -- we</span>
<span class="cm">			 * can use this to determine if the CAP_PRIVACY_ON bit should</span>
<span class="cm">			 * be set.</span>
<span class="cm">			 */</span>
			<span class="k">struct</span> <span class="n">libipw_security</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SEC_ENABLED</span><span class="p">,</span>
				<span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			<span class="p">};</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
			<span class="cm">/* We only change SEC_LEVEL for open mode. Others</span>
<span class="cm">			 * are set by ipw_wpa_set_encryption.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
				<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
				<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw_wpa_set_auth_algs</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw_wpa_enable</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_RX_UNENCRYPTED_EAPOL</span>:
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee802_1x</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_PRIVACY_INVOKED</span>:
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SIOCGIWAUTH */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">libipw_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * wpa_supplicant will control these internally</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_TKIP_COUNTERMEASURES</span>:
		<span class="n">crypt</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt</span> <span class="o">||</span> <span class="o">!</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_flags</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_flags</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">IEEE80211_CRYPTO_TKIP_COUNTERMEASURES</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_enabled</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_RX_UNENCRYPTED_EAPOL</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee802_1x</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_ROAMING_CONTROL</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_PRIVACY_INVOKED</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SIOCSIWENCODEEXT */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwcrypto</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">==</span> <span class="n">IW_ENCODE_ALG_TKIP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* IPW HW can&#39;t build TKIP MIC,</span>
<span class="cm">			   host decryption still needed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_GROUP_KEY</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_mc_decrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt_msdu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt_msdu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_mc_decrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">libipw_wx_set_encodeext</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* SIOCGIWENCODEEXT */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">libipw_wx_get_encodeext</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* SIOCSIWMLME */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_mlme</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_mlme</span> <span class="o">*</span><span class="n">mlme</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_mlme</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">reason</span><span class="p">;</span>

	<span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MLME_DEAUTH</span>:
		<span class="cm">/* silently ignore */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_MLME_DISASSOC</span>:
		<span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPW2200_QOS</span>

<span class="cm">/* QoS */</span>
<span class="cm">/*</span>
<span class="cm">* get the modulation type of the current network or</span>
<span class="cm">* the card current mode</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">ipw_qos_current_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span> <span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IPW_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS network/card mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* Handle management frame beacon and probe response</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_qos_handle_probe_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">active_network</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">libipw_qos_parameters</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">)</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_QOS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">active_network</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_QOS_PARAMETERS</span><span class="p">))</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">active_network</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_QOS_PARAMETERS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">old_param_count</span> <span class="o">!=</span>
		     <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">old_param_count</span> <span class="o">=</span>
			    <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">;</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">);</span>
			<span class="n">IPW_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS parameters change call &quot;</span>
				      <span class="s">&quot;qos_activate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_B</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_B</span><span class="p">))</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">def_parameters_CCK</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">def_parameters_OFDM</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">active_network</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS was disabled call qos_activate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">active_network</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">==</span>
				     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
					    <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">merge_networks</span><span class="p">);</span>
				<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* This function set up the firmware to support QoS. It sends</span>
<span class="cm">* IPW_CMD_QOS_PARAMETERS and IPW_CMD_WME_INFO</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_qos_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">libipw_qos_data</span> <span class="o">*</span><span class="n">qos_network_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">libipw_qos_parameters</span> <span class="n">qos_parameters</span><span class="p">[</span><span class="n">QOS_QOS_SETS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">libipw_qos_parameters</span> <span class="o">*</span><span class="n">active_one</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">libipw_qos_parameters</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">burst_duration</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">ipw_qos_current_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">active_one</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">qos_parameters</span><span class="p">[</span><span class="n">QOS_PARAM_SET_DEF_CCK</span><span class="p">]);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">active_one</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">def_qos_parm_CCK</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">active_one</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">qos_parameters</span><span class="p">[</span><span class="n">QOS_PARAM_SET_DEF_OFDM</span><span class="p">]);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">active_one</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">def_qos_parm_OFDM</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qos_network_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IEEE_B</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS activate network mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
			<span class="n">active_one</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">def_parameters_CCK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">active_one</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">def_parameters_OFDM</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qos_parameters</span><span class="p">[</span><span class="n">QOS_PARAM_SET_ACTIVE</span><span class="p">],</span> <span class="n">active_one</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">burst_duration</span> <span class="o">=</span> <span class="n">ipw_qos_get_burst_duration</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QOS_QUEUE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">qos_parameters</span><span class="p">[</span><span class="n">QOS_PARAM_SET_ACTIVE</span><span class="p">].</span><span class="n">tx_op_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">burst_duration</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IEEE_B</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS activate IBSS network mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">type</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">qos_enable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">active_one</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">def_parameters_CCK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">active_one</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">def_qos_parm_CCK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">qos_enable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">active_one</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">def_parameters_OFDM</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">active_one</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">def_qos_parm_OFDM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qos_parameters</span><span class="p">[</span><span class="n">QOS_PARAM_SET_ACTIVE</span><span class="p">],</span> <span class="n">active_one</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">active</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">active_one</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">qos_network_data</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">);</span>
		<span class="n">qos_network_data</span><span class="o">-&gt;</span><span class="n">old_param_count</span> <span class="o">=</span>
		    <span class="n">qos_network_data</span><span class="o">-&gt;</span><span class="n">param_count</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qos_parameters</span><span class="p">[</span><span class="n">QOS_PARAM_SET_ACTIVE</span><span class="p">],</span> <span class="n">active_one</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">active</span> <span class="o">=</span> <span class="n">qos_network_data</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">burst_duration</span> <span class="o">=</span> <span class="n">ipw_qos_get_burst_duration</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QOS_QUEUE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">qos_parameters</span><span class="p">[</span><span class="n">QOS_PARAM_SET_ACTIVE</span><span class="p">].</span>
				    <span class="n">tx_op_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">burst_duration</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS sending IPW_CMD_QOS_PARAMETERS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_send_qos_params_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					  <span class="p">(</span><span class="k">struct</span> <span class="n">libipw_qos_parameters</span> <span class="o">*</span><span class="p">)</span>
					  <span class="o">&amp;</span><span class="p">(</span><span class="n">qos_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS IPW_CMD_QOS_PARAMETERS failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* send IPW_CMD_WME_INFO to the firmware</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_qos_set_info_element</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">libipw_qos_information_element</span> <span class="n">qos_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">qos_info</span><span class="p">.</span><span class="n">elementID</span> <span class="o">=</span> <span class="n">QOS_ELEMENT_ID</span><span class="p">;</span>
	<span class="n">qos_info</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">libipw_qos_information_element</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">qos_info</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">QOS_VERSION_1</span><span class="p">;</span>
	<span class="n">qos_info</span><span class="p">.</span><span class="n">ac_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">qos_info</span><span class="p">.</span><span class="n">qui</span><span class="p">,</span> <span class="n">qos_oui</span><span class="p">,</span> <span class="n">QOS_OUI_LEN</span><span class="p">);</span>
	<span class="n">qos_info</span><span class="p">.</span><span class="n">qui_type</span> <span class="o">=</span> <span class="n">QOS_OUI_TYPE</span><span class="p">;</span>
	<span class="n">qos_info</span><span class="p">.</span><span class="n">qui_subtype</span> <span class="o">=</span> <span class="n">QOS_OUI_INFO_SUB_TYPE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw_send_qos_info_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qos_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS error calling ipw_send_qos_info_command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* Set the QoS parameter with the association request structure</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_qos_association</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">libipw_qos_data</span> <span class="o">*</span><span class="n">qos_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">libipw_qos_data</span> <span class="n">ibss_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">));</span>

		<span class="n">qos_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ibss_data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
		<span class="n">qos_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_qos_activate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">qos_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">policy_support</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HC_QOS_SUPPORT_ASSOC</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">qos_enable</span> <span class="o">&amp;&amp;</span> <span class="n">qos_data</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS will be enabled for this association</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">policy_support</span> <span class="o">|=</span> <span class="n">HC_QOS_SUPPORT_ASSOC</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ipw_qos_set_info_element</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* handling the beaconing responses. if we get different QoS setting</span>
<span class="cm">* off the network from the associated setting, adjust the QoS</span>
<span class="cm">* setting</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_qos_association_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">libipw_qos_parameters</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">set_qos_param</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">network</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_QOS_PARAMETERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">libipw_qos_data</span><span class="p">));</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">old_param_count</span> <span class="o">!=</span>
		     <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_qos_param</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">old_param_count</span> <span class="o">=</span>
			    <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_B</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_B</span><span class="p">))</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">def_parameters_CCK</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">def_parameters_OFDM</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_qos_param</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_qos_param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ipw_qos_get_burst_duration</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_MODULATION</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">burst_duration_CCK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">burst_duration_OFDM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* Initialize the setting of QoS global</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_qos_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">burst_enable</span><span class="p">,</span> <span class="n">u32</span> <span class="n">burst_duration_CCK</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">burst_duration_OFDM</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">qos_enable</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">qos_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">def_qos_parm_CCK</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">def_qos_parameters_CCK</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">def_qos_parm_OFDM</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">def_qos_parameters_OFDM</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS is enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">def_qos_parm_CCK</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">def_parameters_CCK</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">def_qos_parm_OFDM</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">def_parameters_OFDM</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS is not enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">burst_enable</span> <span class="o">=</span> <span class="n">burst_enable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">burst_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">burst_duration_CCK</span> <span class="o">=</span> <span class="n">burst_duration_CCK</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">burst_duration_OFDM</span> <span class="o">=</span> <span class="n">burst_duration_OFDM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">burst_duration_CCK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">burst_duration_OFDM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* map the packet priority to the right TX Queue</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_get_tx_queue_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priority</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="o">||</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">qos_enable</span><span class="p">)</span>
		<span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">from_priority_to_tx_queue</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_is_qos_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">libipw_qos_data</span> <span class="o">*</span><span class="n">qos_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">active</span><span class="p">,</span> <span class="n">supported</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unicast</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">daddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qos_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unicast</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">qos_data</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">qos_data</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">qos_data</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">active</span> <span class="o">=</span> <span class="n">qos_data</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
	<span class="n">supported</span> <span class="o">=</span> <span class="n">qos_data</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>
	<span class="n">IPW_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS  %d network is QoS active %d  supported %d  &quot;</span>
		      <span class="s">&quot;unicast %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">qos_enable</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">supported</span><span class="p">,</span> <span class="n">unicast</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">active</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">qos_enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">* add QoS parameter to the TX command</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_qos_set_tx_queue_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">priority</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">tfd_data</span> <span class="o">*</span><span class="n">tfd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tx_queue_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">tx_queue_id</span> <span class="o">=</span> <span class="n">from_priority_to_tx_queue</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">tx_flags_ext</span> <span class="o">|=</span> <span class="n">DCT_FLAG_EXT_QOS_ENABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">qos_no_ack_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">tx_queue_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DCT_FLAG_ACK_REQD</span><span class="p">;</span>
		<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">tfd</span><span class="p">.</span><span class="n">tfd_26</span><span class="p">.</span><span class="n">mchdr</span><span class="p">.</span><span class="n">qos_ctrl</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CTRL_QOS_NO_ACK</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* background support to run QoS activate functionality</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_qos_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">qos_activate</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span>
		<span class="n">ipw_qos_activate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_handle_probe_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">libipw_probe_response</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">active_network</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			      <span class="p">(</span><span class="n">network</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="p">));</span>

	<span class="n">ipw_qos_handle_probe_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">active_network</span><span class="p">,</span> <span class="n">network</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_handle_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">libipw_beacon</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">active_network</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			      <span class="p">(</span><span class="n">network</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="p">));</span>

	<span class="n">ipw_qos_handle_probe_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">active_network</span><span class="p">,</span> <span class="n">network</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_handle_assoc_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">libipw_assoc_response</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ipw_qos_association_resp</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">network</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_qos_params_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">libipw_qos_parameters</span>
				       <span class="o">*</span><span class="n">qos_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_QOS_PARAMETERS</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">qos_param</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">qos_param</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_send_qos_info_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">libipw_qos_information_element</span>
				     <span class="o">*</span><span class="n">qos_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ipw_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_CMD_WME_INFO</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">qos_param</span><span class="p">),</span>
				<span class="n">qos_param</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_QOS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_associate_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ipw_supported_rates</span> <span class="o">*</span><span class="n">rates</span><span class="p">,</span> <span class="kt">int</span> <span class="n">roaming</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_FIXED_RATE</span><span class="p">)</span>
		<span class="n">ipw_set_fixed_rate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_ESSID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">network</span><span class="o">-&gt;</span><span class="n">last_associate</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">auth_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">AUTH_SHARED_KEY</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">auth_key</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">active_key</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">SEC_LEVEL_1</span><span class="p">)</span>
			<span class="n">ipw_send_wep_keys</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DCW_WEP_KEY_SEC_TYPE_WEP</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WLAN_AUTH_LEAP</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">AUTH_LEAP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">AUTH_OPEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">policy_support</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x02</span><span class="p">);</span>	<span class="cm">/* RSN active */</span>
		<span class="n">ipw_set_rsn_capa</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span>
				 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * It is valid for our ieee device to support multiple modes, but</span>
<span class="cm">	 * when it comes to associating to a given network we have to choose</span>
<span class="cm">	 * just one mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_A</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">ieee_mode</span> <span class="o">=</span> <span class="n">IPW_A_MODE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_G</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">ieee_mode</span> <span class="o">=</span> <span class="n">IPW_G_MODE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_B</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">ieee_mode</span> <span class="o">=</span> <span class="n">IPW_B_MODE</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_PREAMBLE_LONG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">preamble_length</span> <span class="o">=</span> <span class="n">DCT_FLAG_SHORT_PREAMBLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">preamble_length</span> <span class="o">=</span> <span class="n">DCT_FLAG_LONG_PREAMBLE</span><span class="p">;</span>

		<span class="cm">/* Clear the short preamble if we won&#39;t be supporting it */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;=</span>
		    <span class="o">~</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear capability bits that aren&#39;t used in Ad Hoc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;=</span>
		    <span class="o">~</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_SHORT_SLOT_TIME</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;%ssociation attempt: &#39;%s&#39;, channel %d, &quot;</span>
			<span class="s">&quot;802.11%c [%d], %s[:%s], enc=%s%s%s%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">roaming</span> <span class="o">?</span> <span class="s">&quot;Rea&quot;</span> <span class="o">:</span> <span class="s">&quot;A&quot;</span><span class="p">,</span>
			<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">),</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			<span class="n">ipw_modes</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">ieee_mode</span><span class="p">],</span>
			<span class="n">rates</span><span class="o">-&gt;</span><span class="n">num_rates</span><span class="p">,</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">preamble_length</span> <span class="o">==</span>
			 <span class="n">DCT_FLAG_LONG_PREAMBLE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;long&quot;</span> <span class="o">:</span> <span class="s">&quot;short&quot;</span><span class="p">,</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span>
			<span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span> <span class="o">?</span> <span class="s">&quot;short&quot;</span> <span class="o">:</span> <span class="s">&quot;long&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span> <span class="o">?</span> <span class="s">&quot;on &quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span> <span class="o">?</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_SHARED_KEY</span> <span class="o">?</span> <span class="s">&quot;(shared)&quot;</span> <span class="o">:</span>
			 <span class="s">&quot;(open)&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span> <span class="o">?</span> <span class="s">&quot; key=&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span> <span class="o">?</span>
			<span class="sc">&#39;1&#39;</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">active_key</span> <span class="o">:</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span> <span class="o">?</span> <span class="sc">&#39;.&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">assoc_type</span> <span class="o">=</span> <span class="n">HC_IBSS_START</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">assoc_tsf_msw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">assoc_tsf_lsw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">roaming</span><span class="p">))</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">assoc_type</span> <span class="o">=</span> <span class="n">HC_REASSOCIATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">assoc_type</span> <span class="o">=</span> <span class="n">HC_ASSOCIATE</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">assoc_tsf_msw</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">assoc_tsf_lsw</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">dest</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">atim_window</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">atim_window</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">atim_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">listen_interval</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_send_ssid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Attempt to send SSID command failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rates</span><span class="o">-&gt;</span><span class="n">ieee_mode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">ieee_mode</span><span class="p">;</span>
	<span class="n">rates</span><span class="o">-&gt;</span><span class="n">purpose</span> <span class="o">=</span> <span class="n">IPW_RATE_CONNECT</span><span class="p">;</span>
	<span class="n">ipw_send_supported_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rates</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">ieee_mode</span> <span class="o">==</span> <span class="n">IPW_G_MODE</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">dot11g_auto_detection</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">dot11g_auto_detection</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">answer_broadcast_ssid_probe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">answer_broadcast_ssid_probe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_send_system_config</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Attempt to send sys config command failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Association sensitivity: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rssi</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_set_sensitivity</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rssi</span> <span class="o">+</span> <span class="n">IPW_RSSI_TO_DBM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Attempt to send associate command failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If preemption is enabled, it is possible for the association</span>
<span class="cm">	 * to complete before we return from ipw_send_associate.  Therefore</span>
<span class="cm">	 * we have to be sure and update our priviate data first.</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_SECURITY_UPDATED</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span> <span class="o">=</span> <span class="n">network</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPW2200_QOS</span>
	<span class="n">ipw_qos_association</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">network</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_send_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Attempt to send associate command failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_STATE</span><span class="p">,</span> <span class="s">&quot;associating: &#39;%s&#39; %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">),</span>
		  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_roam</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_network_match</span> <span class="n">match</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span>
	<span class="p">};</span>

	<span class="cm">/* The roaming process is as follows:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1.  Missed beacon threshold triggers the roaming process by</span>
<span class="cm">	 *     setting the status ROAM bit and requesting a scan.</span>
<span class="cm">	 * 2.  When the scan completes, it schedules the ROAM work</span>
<span class="cm">	 * 3.  The ROAM work looks at all of the known networks for one that</span>
<span class="cm">	 *     is a better network than the currently associated.  If none</span>
<span class="cm">	 *     found, the ROAM process is over (ROAM bit cleared)</span>
<span class="cm">	 * 4.  If a better network is found, a disassociation request is</span>
<span class="cm">	 *     sent.</span>
<span class="cm">	 * 5.  When the disassociation completes, the roam work is again</span>
<span class="cm">	 *     scheduled.  The second time through, the driver is no longer</span>
<span class="cm">	 *     associated, and the newly selected network is sent an</span>
<span class="cm">	 *     association request.</span>
<span class="cm">	 * 6.  At this point ,the roaming process is complete and the ROAM</span>
<span class="cm">	 *     status bit is cleared.</span>
<span class="cm">	 */</span>

	<span class="cm">/* If we are no longer associated, and the roaming bit is no longer</span>
<span class="cm">	 * set, then we are not actively roaming, so just return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_ROAMING</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First pass through ROAM process -- look for a better</span>
<span class="cm">		 * network */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">rssi</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rssi</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rssi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">128</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">network</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="p">)</span>
				<span class="n">ipw_best_network</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">rssi</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">network</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;No better APs in this network to &quot;</span>
					<span class="s">&quot;roam to.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_ROAMING</span><span class="p">;</span>
			<span class="n">ipw_debug_config</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ipw_send_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span> <span class="o">=</span> <span class="n">match</span><span class="p">.</span><span class="n">network</span><span class="p">;</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Second pass through ROAM process -- request association */</span>
	<span class="n">ipw_compatible_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match</span><span class="p">.</span><span class="n">rates</span><span class="p">);</span>
	<span class="n">ipw_associate_network</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match</span><span class="p">.</span><span class="n">rates</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_ROAMING</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_roam</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">roam</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_roam</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_associate</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">network</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_network_match</span> <span class="n">match</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">network</span> <span class="o">=</span> <span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">ipw_supported_rates</span> <span class="o">*</span><span class="n">rates</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Not attempting association (monitor mode)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Not attempting association (already in &quot;</span>
				<span class="s">&quot;progress)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_DISASSOCIATING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Not attempting association (in &quot;</span>
				<span class="s">&quot;disassociating)</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">associate</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw_is_init</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCANNING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Not attempting association (scanning or not &quot;</span>
				<span class="s">&quot;initialized)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_ASSOCIATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CFG_STATIC_ESSID</span> <span class="o">|</span> <span class="n">CFG_STATIC_BSSID</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Not attempting association (associate=0)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Protect our use of the network_list */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
	    <span class="n">ipw_best_network</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">network</span> <span class="o">=</span> <span class="n">match</span><span class="p">.</span><span class="n">network</span><span class="p">;</span>
	<span class="n">rates</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">match</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">network</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_ADHOC_CREATE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_ESSID</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Use oldest network if the free list is empty */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">oldest</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">libipw_network</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>

			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">oldest</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">&lt;</span> <span class="n">oldest</span><span class="o">-&gt;</span><span class="n">last_scanned</span><span class="p">))</span>
					<span class="n">oldest</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* If there are no more slots, expire the oldest */</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oldest</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">target</span> <span class="o">=</span> <span class="n">oldest</span><span class="p">;</span>
			<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Expired &#39;%s&#39; (%pM) from &quot;</span>
					<span class="s">&quot;network list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
						   <span class="n">target</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
					<span class="n">target</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">element</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">network</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">libipw_network</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">ipw_adhoc_create</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">network</span><span class="p">);</span>
		<span class="n">rates</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* If we reached the end of the list, then we don&#39;t have any valid</span>
<span class="cm">	 * matching APs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">network</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipw_debug_config</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCANNING</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_SPEED_SCAN</span><span class="p">))</span>
				<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">,</span>
						      <span class="n">SCAN_INTERVAL</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipw_associate_network</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_associate</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">associate</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_rebuild_decrypted_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_3</span>:
		<span class="cm">/* Remove CCMP HDR */</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">LIBIPW_3ADDR_LEN</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">LIBIPW_3ADDR_LEN</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">LIBIPW_3ADDR_LEN</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* CCMP_HDR_LEN + CCMP_MIC_LEN */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_2</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_1</span>:
		<span class="cm">/* Remove IV */</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">LIBIPW_3ADDR_LEN</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">LIBIPW_3ADDR_LEN</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">LIBIPW_3ADDR_LEN</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>	<span class="cm">/* IV + ICV */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unknown security level %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_handle_data_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ipw_rx_mem_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">libipw_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">libipw_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_rx_packet</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rx_packet</span> <span class="o">*</span><span class="p">)</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* We received data from the HW, so stop the watchdog */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* We only process data packets if the</span>
<span class="cm">	 * interface is open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="n">IPW_RX_FRAME_SIZE</span><span class="p">)</span> <span class="o">&gt;</span>
		     <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span><span class="o">++</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Corruption detected! Oh no!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span><span class="o">++</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Dropping packet while interface is not up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Advance skb-&gt;data to the start of the actual payload */</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rx_packet</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">data</span><span class="p">));</span>

	<span class="cm">/* Set the size of the skb to the size of the frame */</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">length</span><span class="p">));</span>

	<span class="n">IPW_DEBUG_RX</span><span class="p">(</span><span class="s">&quot;Rx packet of %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* HW decrypt will not clear the WEP bit, MIC, PN, etc. */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">libipw_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MONITOR</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">?</span>
	     <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_mc_decrypt</span> <span class="o">:</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span><span class="p">))</span>
		<span class="n">ipw_rebuild_decrypted_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">libipw_rx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>			<span class="cm">/* libipw_rx succeeded, so it now owns the SKB */</span>
		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">__ipw_led_activity_on</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPW2200_RADIOTAP</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_handle_data_packet_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ipw_rx_mem_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">libipw_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_rx_packet</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rx_packet</span> <span class="o">*</span><span class="p">)</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_rx_frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>

	<span class="cm">/* initial pull of some data */</span>
	<span class="n">u16</span> <span class="n">received_channel</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">received_channel</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">antennaAndPhy</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">antennaAndPhy</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">antsignal</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">rssi_dbm</span> <span class="o">-</span> <span class="n">IPW_RSSI_TO_DBM</span><span class="p">;</span>	<span class="cm">/* call it signed anyhow */</span>
	<span class="n">u16</span> <span class="n">pktrate</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>

	<span class="cm">/* Magic struct that slots into the radiotap header -- no reason</span>
<span class="cm">	 * to build this manually element by element, we can write it much</span>
<span class="cm">	 * more efficiently than we can parse it. ORDER MATTERS HERE */</span>
	<span class="k">struct</span> <span class="n">ipw_rt_hdr</span> <span class="o">*</span><span class="n">ipw_rt</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="cm">/* We received data from the HW, so stop the watchdog */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* We only process data packets if the</span>
<span class="cm">	 * interface is open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="n">IPW_RX_FRAME_SIZE</span><span class="p">)</span> <span class="o">&gt;</span>
		     <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span><span class="o">++</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Corruption detected! Oh no!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span><span class="o">++</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Dropping packet while interface is not up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Libpcap 0.9.3+ can handle variable length radiotap, so we&#39;ll use</span>
<span class="cm">	 * that now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">IPW_RX_BUF_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rt_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* FIXME: Should alloc bigger skb instead */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span><span class="o">++</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Dropping too large packet in monitor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* copy the frame itself */</span>
	<span class="n">memmove</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rt_hdr</span><span class="p">),</span>
		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">IPW_RX_FRAME_SIZE</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">ipw_rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rt_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_hdr</span><span class="p">.</span><span class="n">it_version</span> <span class="o">=</span> <span class="n">PKTHDR_RADIOTAP_VERSION</span><span class="p">;</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_hdr</span><span class="p">.</span><span class="n">it_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* always good to zero */</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_hdr</span><span class="p">.</span><span class="n">it_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rt_hdr</span><span class="p">));</span>	<span class="cm">/* total header+data */</span>

	<span class="cm">/* Big bitfield of all the fields we provide in radiotap */</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_hdr</span><span class="p">.</span><span class="n">it_present</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_TSFT</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_FLAGS</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_RATE</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_CHANNEL</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_DBM_ANTSIGNAL</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_DBM_ANTNOISE</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_ANTENNA</span><span class="p">));</span>

	<span class="cm">/* Zero the flags, we&#39;ll add to them as we go */</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_tsf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">parent_tsf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
			       <span class="n">frame</span><span class="o">-&gt;</span><span class="n">parent_tsf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			       <span class="n">frame</span><span class="o">-&gt;</span><span class="n">parent_tsf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>  <span class="o">|</span>
			       <span class="n">frame</span><span class="o">-&gt;</span><span class="n">parent_tsf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Convert signal to DBM */</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_dbmsignal</span> <span class="o">=</span> <span class="n">antsignal</span><span class="p">;</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_dbmnoise</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">);</span>

	<span class="cm">/* Convert the channel data and set the flags */</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_channel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee80211chan2mhz</span><span class="p">(</span><span class="n">received_channel</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">received_channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 802.11a */</span>
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_chbitmask</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">IEEE80211_CHAN_OFDM</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_5GHZ</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">antennaAndPhy</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 802.11b */</span>
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_chbitmask</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">IEEE80211_CHAN_CCK</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_2GHZ</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* 802.11g */</span>
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_chbitmask</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_CHAN_OFDM</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_2GHZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set the rate in multiples of 500k/s */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pktrate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_1MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_2MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_5MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_6MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_9MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_11MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_12MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_18MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_24MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_36MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_48MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_54MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">108</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* antenna number */</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_antenna</span> <span class="o">=</span> <span class="p">(</span><span class="n">antennaAndPhy</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* Is this right? */</span>

	<span class="cm">/* set the preamble flag if we have it */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">antennaAndPhy</span> <span class="o">&amp;</span> <span class="mi">64</span><span class="p">))</span>
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">|=</span> <span class="n">IEEE80211_RADIOTAP_F_SHORTPRE</span><span class="p">;</span>

	<span class="cm">/* Set the size of the skb to the size of the frame */</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rt_hdr</span><span class="p">));</span>

	<span class="n">IPW_DEBUG_RX</span><span class="p">(</span><span class="s">&quot;Rx packet of %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">libipw_rx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>			<span class="cm">/* libipw_rx succeeded, so it now owns the SKB */</span>
		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/* no LED during capture */</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
<span class="cp">#define libipw_is_probe_response(fc) \</span>
<span class="cp">   ((fc &amp; IEEE80211_FCTL_FTYPE) == IEEE80211_FTYPE_MGMT &amp;&amp; \</span>
<span class="cp">    (fc &amp; IEEE80211_FCTL_STYPE) == IEEE80211_STYPE_PROBE_RESP )</span>

<span class="cp">#define libipw_is_management(fc) \</span>
<span class="cp">   ((fc &amp; IEEE80211_FCTL_FTYPE) == IEEE80211_FTYPE_MGMT)</span>

<span class="cp">#define libipw_is_control(fc) \</span>
<span class="cp">   ((fc &amp; IEEE80211_FCTL_FTYPE) == IEEE80211_FTYPE_CTL)</span>

<span class="cp">#define libipw_is_data(fc) \</span>
<span class="cp">   ((fc &amp; IEEE80211_FCTL_FTYPE) == IEEE80211_FTYPE_DATA)</span>

<span class="cp">#define libipw_is_assoc_request(fc) \</span>
<span class="cp">   ((fc &amp; IEEE80211_FCTL_STYPE) == IEEE80211_STYPE_ASSOC_REQ)</span>

<span class="cp">#define libipw_is_reassoc_request(fc) \</span>
<span class="cp">   ((fc &amp; IEEE80211_FCTL_STYPE) == IEEE80211_STYPE_REASSOC_REQ)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_handle_promiscuous_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ipw_rx_mem_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">libipw_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_rx_packet</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rx_packet</span> <span class="o">*</span><span class="p">)</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_rx_frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_rt_hdr</span> <span class="o">*</span><span class="n">ipw_rt</span><span class="p">;</span>

	<span class="cm">/* First cache any information we need before we overwrite</span>
<span class="cm">	 * the information provided in the skb from the hardware */</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">received_channel</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_flags</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">antennaAndPhy</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">signal</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">rssi_dbm</span> <span class="o">-</span> <span class="n">IPW_RSSI_TO_DBM</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">noise</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdr_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_priv</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">;</span>

	<span class="cm">/* If the filter is set to not include Rx frames then return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_NO_RX</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We received data from the HW, so stop the watchdog */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="n">IPW_RX_FRAME_SIZE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Corruption detected! Oh no!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We only process data packets if the interface is open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Dropping packet while interface is not up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Libpcap 0.9.3+ can handle variable length radiotap, so we&#39;ll use</span>
<span class="cm">	 * that now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">IPW_RX_BUF_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rt_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* FIXME: Should alloc bigger skb instead */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Dropping too large packet in monitor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">IPW_RX_FRAME_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">libipw_is_management</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_NO_MGMT</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_MGMT_HEADER_ONLY</span><span class="p">)</span>
			<span class="n">hdr_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">libipw_is_control</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_NO_CTL</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_CTL_HEADER_ONLY</span><span class="p">)</span>
			<span class="n">hdr_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">libipw_is_data</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_NO_DATA</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_DATA_HEADER_ONLY</span><span class="p">)</span>
			<span class="n">hdr_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy the SKB since this is for the promiscuous side */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_copy</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;skb_clone failed for promiscuous copy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* copy the frame data to write after where the radiotap header goes */</span>
	<span class="n">ipw_rt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr_only</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">libipw_get_hdrlen</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_hdr</span><span class="p">.</span><span class="n">it_version</span> <span class="o">=</span> <span class="n">PKTHDR_RADIOTAP_VERSION</span><span class="p">;</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_hdr</span><span class="p">.</span><span class="n">it_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* always good to zero */</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_hdr</span><span class="p">.</span><span class="n">it_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ipw_rt</span><span class="p">));</span>	<span class="cm">/* total header+data */</span>

	<span class="cm">/* Set the size of the skb to the size of the frame */</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ipw_rt</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Big bitfield of all the fields we provide in radiotap */</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_hdr</span><span class="p">.</span><span class="n">it_present</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_TSFT</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_FLAGS</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_RATE</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_CHANNEL</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_DBM_ANTSIGNAL</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_DBM_ANTNOISE</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_ANTENNA</span><span class="p">));</span>

	<span class="cm">/* Zero the flags, we&#39;ll add to them as we go */</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_tsf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">parent_tsf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
			       <span class="n">frame</span><span class="o">-&gt;</span><span class="n">parent_tsf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			       <span class="n">frame</span><span class="o">-&gt;</span><span class="n">parent_tsf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>  <span class="o">|</span>
			       <span class="n">frame</span><span class="o">-&gt;</span><span class="n">parent_tsf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Convert to DBM */</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_dbmsignal</span> <span class="o">=</span> <span class="n">signal</span><span class="p">;</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_dbmnoise</span> <span class="o">=</span> <span class="n">noise</span><span class="p">;</span>

	<span class="cm">/* Convert the channel data and set the flags */</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_channel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee80211chan2mhz</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 802.11a */</span>
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_chbitmask</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">IEEE80211_CHAN_OFDM</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_5GHZ</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* 802.11b */</span>
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_chbitmask</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">IEEE80211_CHAN_CCK</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_2GHZ</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* 802.11g */</span>
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_chbitmask</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_CHAN_OFDM</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_2GHZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set the rate in multiples of 500k/s */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_1MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_2MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_5MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_6MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_9MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_11MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_12MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_18MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_24MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_36MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_48MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_TX_RATE_54MB</span>:
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">108</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* antenna number */</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_antenna</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* set the preamble flag if we have it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">))</span>
		<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">|=</span> <span class="n">IEEE80211_RADIOTAP_F_SHORTPRE</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_RX</span><span class="p">(</span><span class="s">&quot;Rx packet of %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">libipw_rx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_network_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">libipw_hdr_4addr</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Filter incoming packets to determine if they are targeted toward</span>
<span class="cm">	 * this network, discarding packets coming from ourselves */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:	<span class="cm">/* Header: Dest. | Source    | BSSID */</span>
		<span class="cm">/* packets from our adapter are dropped (echo) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* {broad,multi}cast packets to our BSSID go through */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="cm">/* packets to our adapter go through */</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
			       <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:	<span class="cm">/* Header: Dest. | BSSID | Source */</span>
		<span class="cm">/* packets from our adapter are dropped (echo) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* {broad,multi}cast packets to our BSS go through */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="cm">/* packets to our adapter go through */</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
			       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IPW_PACKET_RETRY_TIME HZ</span>

<span class="k">static</span>  <span class="kt">int</span> <span class="nf">is_duplicate_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">libipw_hdr_4addr</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_FRAG</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">last_seq</span><span class="p">,</span> <span class="o">*</span><span class="n">last_frag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">last_time</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ipw_ibss_seq</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">%</span> <span class="n">IPW_IBSS_MAC_HASH_SIZE</span><span class="p">;</span>

			<span class="n">__list_for_each</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibss_mac_hash</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">entry</span> <span class="o">=</span>
				    <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_ibss_seq</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibss_mac_hash</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">IPW_ERROR</span>
					    <span class="p">(</span><span class="s">&quot;Cannot malloc new mac entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
				<span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
				<span class="n">entry</span><span class="o">-&gt;</span><span class="n">frag_num</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
				<span class="n">entry</span><span class="o">-&gt;</span><span class="n">packet_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
				<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibss_mac_hash</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">last_seq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">;</span>
			<span class="n">last_frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">frag_num</span><span class="p">;</span>
			<span class="n">last_time</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">packet_time</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
		<span class="n">last_seq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_seq_num</span><span class="p">;</span>
		<span class="n">last_frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_frag_num</span><span class="p">;</span>
		<span class="n">last_time</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_packet_time</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">last_seq</span> <span class="o">==</span> <span class="n">seq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="o">*</span><span class="n">last_time</span> <span class="o">+</span> <span class="n">IPW_PACKET_RETRY_TIME</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">last_frag</span> <span class="o">==</span> <span class="n">frag</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">last_frag</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">frag</span><span class="p">)</span>
			<span class="cm">/* out-of-order fragment */</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">last_seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>

	<span class="o">*</span><span class="n">last_frag</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
	<span class="o">*</span><span class="n">last_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">drop:</span>
	<span class="cm">/* Comment this line now since we observed the card receives</span>
<span class="cm">	 * duplicate packets but the FCTL_RETRY bit is not set in the</span>
<span class="cm">	 * IBSS mode with fragmentation enabled.</span>
<span class="cm">	 BUG_ON(!(le16_to_cpu(header-&gt;frame_control) &amp; IEEE80211_FCTL_RETRY)); */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_handle_mgmt_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ipw_rx_mem_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">libipw_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_rx_packet</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rx_packet</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">libipw_hdr_4addr</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">libipw_hdr_4addr</span> <span class="o">*</span><span class="p">)</span>
	    <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">IPW_RX_FRAME_SIZE</span><span class="p">);</span>

	<span class="n">libipw_rx_mgt</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">stats</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">))</span> <span class="o">==</span>
	      <span class="n">IEEE80211_STYPE_PROBE_RESP</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">))</span> <span class="o">==</span>
	      <span class="n">IEEE80211_STYPE_BEACON</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
			<span class="n">ipw_add_station</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_NET_STATS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;sending stat packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Set the size of the skb to the size of the full</span>
<span class="cm">		 * ipw header and 802.11 frame */</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">IPW_RX_FRAME_SIZE</span><span class="p">);</span>

		<span class="cm">/* Advance past the ipw packet header to the 802.11 frame */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IPW_RX_FRAME_SIZE</span><span class="p">);</span>

		<span class="cm">/* Push the libipw_rx_stats before the 802.11 frame */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stats</span><span class="p">)),</span> <span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stats</span><span class="p">));</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

		<span class="cm">/* Point raw at the libipw_stats */</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_80211_STATS</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Main entry function for receiving a packet with 80211 headers.  This</span>
<span class="cm"> * should be called when ever the FW has notified us that there is a new</span>
<span class="cm"> * skb in the receive queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_rx_mem_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_rx_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">libipw_hdr_4addr</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">network_packet</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fill_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RX_READ_INDEX</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_RX_WRITE_INDEX</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_rx_queue_space</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">RX_QUEUE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">fill_rx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxb</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rxb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;Queue not allocated!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
					    <span class="n">IPW_RX_BUF_SIZE</span><span class="p">,</span>
					    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rx_packet</span> <span class="o">*</span><span class="p">)</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_RX</span><span class="p">(</span><span class="s">&quot;Packet: type=%02X seq=%02X bits=%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">message_type</span><span class="p">,</span>
			     <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">rx_seq_num</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">control_bits</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">message_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RX_FRAME_TYPE</span>:	<span class="cm">/* 802.11 frame */</span>  <span class="p">{</span>
				<span class="k">struct</span> <span class="n">libipw_rx_stats</span> <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">rssi_dbm</span> <span class="o">-</span>
					    <span class="n">IPW_RSSI_TO_DBM</span><span class="p">,</span>
					<span class="p">.</span><span class="n">signal</span> <span class="o">=</span>
					    <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">rssi_dbm</span> <span class="o">-</span>
					    <span class="n">IPW_RSSI_TO_DBM</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">,</span>
					<span class="p">.</span><span class="n">noise</span> <span class="o">=</span>
					    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">noise</span><span class="p">),</span>
					<span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">rate</span><span class="p">,</span>
					<span class="p">.</span><span class="n">mac_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">,</span>
					<span class="p">.</span><span class="n">received_channel</span> <span class="o">=</span>
					    <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">received_channel</span><span class="p">,</span>
					<span class="p">.</span><span class="n">freq</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span>
					     <span class="n">control</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">?</span>
					    <span class="n">LIBIPW_24GHZ_BAND</span> <span class="o">:</span>
					    <span class="n">LIBIPW_52GHZ_BAND</span><span class="p">,</span>
					<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">length</span><span class="p">),</span>
				<span class="p">};</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">rssi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">stats</span><span class="p">.</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_STATMASK_RSSI</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">signal</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">stats</span><span class="p">.</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_STATMASK_SIGNAL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">noise</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">stats</span><span class="p">.</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_STATMASK_NOISE</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">stats</span><span class="p">.</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_STATMASK_RATE</span><span class="p">;</span>

				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">))</span>
		<span class="n">ipw_handle_promiscuous_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rxb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IPW2200_RADIOTAP</span>

                <span class="n">ipw_handle_data_packet_monitor</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					       <span class="n">rxb</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">ipw_handle_data_packet</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rxb</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
<span class="cp">#endif</span>

				<span class="n">header</span> <span class="o">=</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">libipw_hdr_4addr</span> <span class="o">*</span><span class="p">)(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span>
								   <span class="n">data</span> <span class="o">+</span>
								   <span class="n">IPW_RX_FRAME_SIZE</span><span class="p">);</span>
				<span class="cm">/* TODO: Check Ad-Hoc dest/source and make sure</span>
<span class="cm">				 * that we are actually parsing these packets</span>
<span class="cm">				 * correctly -- we should probably use the</span>
<span class="cm">				 * frame control of the packet and disregard</span>
<span class="cm">				 * the current iw_mode */</span>

				<span class="n">network_packet</span> <span class="o">=</span>
				    <span class="n">is_network_packet</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">network_packet</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rssi</span> <span class="o">=</span>
					    <span class="n">stats</span><span class="p">.</span><span class="n">rssi</span><span class="p">;</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">exp_avg_rssi</span> <span class="o">=</span>
					    <span class="n">exponential_average</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">exp_avg_rssi</span><span class="p">,</span>
					    <span class="n">stats</span><span class="p">.</span><span class="n">rssi</span><span class="p">,</span> <span class="n">DEPTH_RSSI</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">IPW_DEBUG_RX</span><span class="p">(</span><span class="s">&quot;Frame: len=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">length</span><span class="p">));</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;</span>
				    <span class="n">libipw_get_hdrlen</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span>
						    <span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">IPW_DEBUG_DROP</span>
					    <span class="p">(</span><span class="s">&quot;Received packet is too small. &quot;</span>
					     <span class="s">&quot;Dropping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">switch</span> <span class="p">(</span><span class="n">WLAN_FC_GET_TYPE</span>
					<span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">)))</span> <span class="p">{</span>

				<span class="k">case</span> <span class="n">IEEE80211_FTYPE_MGMT</span>:
					<span class="n">ipw_handle_mgmt_packet</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rxb</span><span class="p">,</span>
							       <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">IEEE80211_FTYPE_CTL</span>:
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">IEEE80211_FTYPE_DATA</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">network_packet</span> <span class="o">||</span>
						     <span class="n">is_duplicate_packet</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
									 <span class="n">header</span><span class="p">)))</span>
					<span class="p">{</span>
						<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Dropping: &quot;</span>
							       <span class="s">&quot;%pM, &quot;</span>
							       <span class="s">&quot;%pM, &quot;</span>
							       <span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							       <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span>
							       <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
							       <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">ipw_handle_data_packet</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rxb</span><span class="p">,</span>
							       <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>

					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">case</span> <span class="n">RX_HOST_NOTIFICATION_TYPE</span>:<span class="p">{</span>
				<span class="n">IPW_DEBUG_RX</span>
				    <span class="p">(</span><span class="s">&quot;Notification: subtype=%02X flags=%02X size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">notification</span><span class="p">.</span><span class="n">subtype</span><span class="p">,</span>
				     <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">notification</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span>
				     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">notification</span><span class="p">.</span><span class="n">size</span><span class="p">));</span>
				<span class="n">ipw_rx_notification</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">notification</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="nl">default:</span>
			<span class="n">IPW_DEBUG_RX</span><span class="p">(</span><span class="s">&quot;Bad Rx packet of type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">message_type</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* For now we just don&#39;t re-use anything.  We can tweak this</span>
<span class="cm">		 * later to try and re-use notification packets and SKBs that</span>
<span class="cm">		 * fail to Rx correctly */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
				 <span class="n">IPW_RX_BUF_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_QUEUE_SIZE</span><span class="p">;</span>

		<span class="cm">/* If there are a lot of unsued frames, restock the Rx queue</span>
<span class="cm">		 * so the ucode won&#39;t assert */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fill_rx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">ipw_rx_queue_replenish</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Backtrack one entry */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">ipw_rx_queue_restock</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define DEFAULT_RTS_THRESHOLD     2304U</span>
<span class="cp">#define MIN_RTS_THRESHOLD         1U</span>
<span class="cp">#define MAX_RTS_THRESHOLD         2304U</span>
<span class="cp">#define DEFAULT_BEACON_INTERVAL   100U</span>
<span class="cp">#define	DEFAULT_SHORT_RETRY_LIMIT 7U</span>
<span class="cp">#define	DEFAULT_LONG_RETRY_LIMIT  4U</span>

<span class="cm">/**</span>
<span class="cm"> * ipw_sw_reset</span>
<span class="cm"> * @option: options to control different reset behaviour</span>
<span class="cm"> * 	    0 = reset everything except the &#39;disable&#39; module_param</span>
<span class="cm"> * 	    1 = reset everything and print out driver info (for probe only)</span>
<span class="cm"> * 	    2 = reset everything</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_sw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">option</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">band</span><span class="p">,</span> <span class="n">modulation</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_mode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">;</span>

	<span class="cm">/* Initialize module parameter values here */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We default to disabling the LED code as right now it causes</span>
<span class="cm">	 * too many systems to lock up... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led_support</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_NO_LED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">associate</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_ASSOCIATE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Auto associate disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">auto_create</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_ADHOC_CREATE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Auto adhoc creation disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_STATIC_ESSID</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable</span> <span class="o">&amp;&amp;</span> <span class="n">option</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_RF_KILL_SW</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Radio disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">default_channel</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_STATIC_CHANNEL</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">default_channel</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Bind to static channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">default_channel</span><span class="p">);</span>
		<span class="cm">/* TODO: Validate that provided channel is in range */</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_IPW2200_QOS</span>
	<span class="n">ipw_qos_init</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">qos_enable</span><span class="p">,</span> <span class="n">qos_burst_enable</span><span class="p">,</span>
		     <span class="n">burst_duration_CCK</span><span class="p">,</span> <span class="n">burst_duration_OFDM</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_QOS */</span><span class="cp"></span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">network_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_MONITOR</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPW2200_RADIOTAP</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_IEEE80211_RADIOTAP</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_IEEE80211</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwcrypto</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt_msdu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_mc_decrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Hardware crypto [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwcrypto</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

	<span class="cm">/* IPW2200/2915 is abled to do hardware fragmentation. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_open_frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x4223</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x4224</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span>
			       <span class="s">&quot;: Detected Intel PRO/Wireless 2915ABG Network &quot;</span>
			       <span class="s">&quot;Connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">abg_true</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">LIBIPW_52GHZ_BAND</span> <span class="o">|</span> <span class="n">LIBIPW_24GHZ_BAND</span><span class="p">;</span>
		<span class="n">modulation</span> <span class="o">=</span> <span class="n">LIBIPW_OFDM_MODULATION</span> <span class="o">|</span>
		    <span class="n">LIBIPW_CCK_MODULATION</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">IPW_2915ABG</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_A</span> <span class="o">|</span> <span class="n">IEEE_G</span> <span class="o">|</span> <span class="n">IEEE_B</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span>
			       <span class="s">&quot;: Detected Intel PRO/Wireless 2200BG Network &quot;</span>
			       <span class="s">&quot;Connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">abg_true</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">LIBIPW_24GHZ_BAND</span><span class="p">;</span>
		<span class="n">modulation</span> <span class="o">=</span> <span class="n">LIBIPW_OFDM_MODULATION</span> <span class="o">|</span>
		    <span class="n">LIBIPW_CCK_MODULATION</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">IPW_2200BG</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_G</span> <span class="o">|</span> <span class="n">IEEE_B</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">freq_band</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">modulation</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">=</span> <span class="n">LIBIPW_DEFAULT_RATES_MASK</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">disassociate_threshold</span> <span class="o">=</span> <span class="n">IPW_MB_DISASSOCIATE_THRESHOLD_DEFAULT</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">roaming_threshold</span> <span class="o">=</span> <span class="n">IPW_MB_ROAMING_THRESHOLD_DEFAULT</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">DEFAULT_RTS_THRESHOLD</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span> <span class="o">=</span> <span class="n">DEFAULT_SHORT_RETRY_LIMIT</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span> <span class="o">=</span> <span class="n">DEFAULT_LONG_RETRY_LIMIT</span><span class="p">;</span>

	<span class="cm">/* If power management is turned on, default to AC mode */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">IPW_POWER_AC</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power</span> <span class="o">=</span> <span class="n">IPW_TX_POWER_DEFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">old_mode</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This file defines the Wireless Extension handlers.  It does not</span>
<span class="cm"> * define any methods of hardware manipulation and relies on the</span>
<span class="cm"> * functions defined in ipw_main to provide the HW interaction.</span>
<span class="cm"> *</span>
<span class="cm"> * The exception to this is the use of the ipw_get_ordinal()</span>
<span class="cm"> * function used to poll the hardware vs. making unnecessary calls.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Setting channel to ANY (0)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_STATIC_CHANNEL</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Attempting to associate with new &quot;</span>
				<span class="s">&quot;parameters.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipw_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_STATIC_CHANNEL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Request to set channel to current value (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Setting channel to %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCANNING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Scan abort triggered due to &quot;</span>
				       <span class="s">&quot;channel change.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ipw_abort_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCANNING</span><span class="p">);</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCANNING</span><span class="p">)</span>
			<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Still scanning...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Took %dms to abort current scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="mi">1000</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_MONITOR */</span><span class="cp"></span>

	<span class="cm">/* Network configuration changed -- force [re]association */</span>
	<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;[re]association triggered due to channel change.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">ipw_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">libipw_geo</span> <span class="o">*</span><span class="n">geo</span> <span class="o">=</span> <span class="n">libipw_get_geo</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">fwrq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">band</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Freq/Channel -&gt; any</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw_set_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* if setting by freq convert to channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">libipw_freq_to_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">band</span> <span class="o">=</span> <span class="n">libipw_is_valid_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">channel</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">libipw_channel_to_index</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">LIBIPW_24GHZ_BAND</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">:</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Invalid Ad-Hoc channel for 802.11a</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Freq/Channel -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw_set_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If we are associated, trying to associate, or have a statically</span>
<span class="cm">	 * configured CHANNEL then return that; otherwise return ANY */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_CHANNEL</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUS_ASSOCIATING</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">libipw_channel_to_index</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">libipw_is_valid_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LIBIPW_52GHZ_BAND</span>:
			<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LIBIPW_24GHZ_BAND</span>:
			<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET Freq/Channel -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Set MODE: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
	<span class="k">case</span> <span class="n">IW_MODE_MONITOR</span>:
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MODE_AUTO</span>:
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ipw_sw_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_IPW2200_RADIOTAP</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_IEEE80211_RADIOTAP</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_IEEE80211</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_MONITOR */</span><span class="cp"></span>

	<span class="cm">/* Free the existing firmware and reset the fw_loaded</span>
<span class="cm">	 * flag so ipw_load() will bring in the new firmware */</span>
	<span class="n">free_firmware</span><span class="p">();</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_restart</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">;</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Get MODE -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Values are in microsecond */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">s32</span> <span class="n">timeout_duration</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">350000</span><span class="p">,</span>
	<span class="mi">250000</span><span class="p">,</span>
	<span class="mi">75000</span><span class="p">,</span>
	<span class="mi">37000</span><span class="p">,</span>
	<span class="mi">25000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s32</span> <span class="n">period_duration</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">400000</span><span class="p">,</span>
	<span class="mi">700000</span><span class="p">,</span>
	<span class="mi">1000000</span><span class="p">,</span>
	<span class="mi">1000000</span><span class="p">,</span>
	<span class="mi">1000000</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">libipw_geo</span> <span class="o">*</span><span class="n">geo</span> <span class="o">=</span> <span class="n">libipw_get_geo</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">range</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">range</span><span class="p">));</span>

	<span class="cm">/* 54Mbs == ~27 Mb/s real (802.11g) */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">27</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="cm">/* TODO: Find real max RSSI and stick here */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>	<span class="cm">/* Updated all three */</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>
	<span class="cm">/* TODO: Find real &#39;good&#39; to &#39;bad&#39; threshold value for RSSI */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* FIXME to real average level */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>	<span class="cm">/* Updated all three */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">.</span><span class="n">num_rates</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">IW_MAX_BITRATES</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">.</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">*</span>
		    <span class="mi">500000</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_rts</span> <span class="o">=</span> <span class="n">DEFAULT_RTS_THRESHOLD</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_frag</span> <span class="o">=</span> <span class="n">MIN_FRAG_THRESHOLD</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_frag</span> <span class="o">=</span> <span class="n">MAX_FRAG_THRESHOLD</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_encoding_sizes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_encoding_tokens</span> <span class="o">=</span> <span class="n">WEP_KEYS</span><span class="p">;</span>

	<span class="cm">/* Set the Wireless Extension versions */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_compiled</span> <span class="o">=</span> <span class="n">WIRELESS_EXT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_source</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE_B</span> <span class="o">|</span> <span class="n">IEEE_G</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IW_MAX_FREQUENCIES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">i</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">m</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a_channels</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IW_MAX_FREQUENCIES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">i</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">m</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_frequency</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Event capability (kernel + driver) */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">IW_EVENT_CAPA_K_0</span> <span class="o">|</span>
				<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">SIOCGIWTHRSPY</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">SIOCGIWAP</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">SIOCGIWSCAN</span><span class="p">));</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IW_EVENT_CAPA_K_1</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">enc_capa</span> <span class="o">=</span> <span class="n">IW_ENC_CAPA_WPA</span> <span class="o">|</span> <span class="n">IW_ENC_CAPA_WPA2</span> <span class="o">|</span>
		<span class="n">IW_ENC_CAPA_CIPHER_TKIP</span> <span class="o">|</span> <span class="n">IW_ENC_CAPA_CIPHER_CCMP</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">scan_capa</span> <span class="o">=</span> <span class="n">IW_SCAN_CAPA_ESSID</span> <span class="o">|</span> <span class="n">IW_SCAN_CAPA_TYPE</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET Range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">any</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">off</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">any</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* we disable mandatory BSSID association */</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Setting AP BSSID to ANY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_STATIC_BSSID</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;Attempting to associate with new &quot;</span>
				<span class="s">&quot;parameters.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipw_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_STATIC_BSSID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;BSSID set to current BSSID.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Setting mandatory BSSID to %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* Network configuration changed -- force [re]association */</span>
	<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;[re]association triggered due to BSSID change.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">ipw_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* If we are associated, trying to associate, or have a statically</span>
<span class="cm">	 * configured BSSID then return that; otherwise return ANY */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_BSSID</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Getting WAP BSSID: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>

        <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Setting ESSID to ANY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
                <span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_STATIC_ESSID</span><span class="p">;</span>
                <span class="n">ipw_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
                <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_STATIC_ESSID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">==</span> <span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;ESSID set to current ESSID.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Setting ESSID: &#39;%s&#39; (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">length</span><span class="p">),</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>

	<span class="cm">/* Network configuration changed -- force [re]association */</span>
	<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;[re]association triggered due to ESSID change.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">ipw_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>

	<span class="cm">/* If we are associated, trying to associate, or have a statically</span>
<span class="cm">	 * configured ESSID then return that; otherwise return ANY */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_ESSID</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Getting essid: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* active */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Getting essid: ANY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* active */</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_nick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Setting nick to &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_TRACE</span><span class="p">(</span><span class="s">&quot;&lt;&lt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_nick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Getting nick</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* active */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_sens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Setting roaming threshold to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Setting disassociate threshold to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">fixed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">roaming_threshold</span> <span class="o">=</span> <span class="n">IPW_MB_ROAMING_THRESHOLD_DEFAULT</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">disassociate_threshold</span> <span class="o">=</span> <span class="n">IPW_MB_DISASSOCIATE_THRESHOLD_DEFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">IPW_MB_ROAMING_THRESHOLD_MAX</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">IPW_MB_ROAMING_THRESHOLD_MIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">roaming_threshold</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">disassociate_threshold</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
      <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_sens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">roaming_threshold</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET roaming threshold -&gt; %s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span> <span class="o">?</span> <span class="s">&quot;OFF&quot;</span> <span class="o">:</span> <span class="s">&quot;ON&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO: We should use semaphores or locks for access to priv */</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">target_rate</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fixed</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* value = -1, fixed = 0 means auto only, so we should use all rates offered by AP */</span>
	<span class="cm">/* value = X, fixed = 1 means only rate X */</span>
	<span class="cm">/* value = X, fixed = 0 means all rates lower equal X */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">LIBIPW_DEFAULT_RATES_MASK</span><span class="p">;</span>
		<span class="cm">/* Now we should reassociate */</span>
		<span class="k">goto</span> <span class="n">apply</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fixed</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">1000000</span> <span class="o">||</span> <span class="o">!</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_CCK_RATE_1MB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">1000000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">apply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">2000000</span> <span class="o">||</span> <span class="o">!</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_CCK_RATE_2MB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">2000000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">apply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">5500000</span> <span class="o">||</span> <span class="o">!</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_CCK_RATE_5MB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">5500000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">apply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">6000000</span> <span class="o">||</span> <span class="o">!</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_OFDM_RATE_6MB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">6000000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">apply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">9000000</span> <span class="o">||</span> <span class="o">!</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_OFDM_RATE_9MB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">9000000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">apply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">11000000</span> <span class="o">||</span> <span class="o">!</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_CCK_RATE_11MB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">11000000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">apply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">12000000</span> <span class="o">||</span> <span class="o">!</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_OFDM_RATE_12MB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">12000000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">apply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">18000000</span> <span class="o">||</span> <span class="o">!</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_OFDM_RATE_18MB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">18000000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">apply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">24000000</span> <span class="o">||</span> <span class="o">!</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_OFDM_RATE_24MB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">24000000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">apply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">36000000</span> <span class="o">||</span> <span class="o">!</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_OFDM_RATE_36MB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">36000000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">apply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">48000000</span> <span class="o">||</span> <span class="o">!</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_OFDM_RATE_48MB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">48000000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">apply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">54000000</span> <span class="o">||</span> <span class="o">!</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_OFDM_RATE_54MB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">54000000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">apply</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;invalid rate specified, returning error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

      <span class="nl">apply:</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Setting rate mask to 0x%08X [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">mask</span><span class="p">,</span> <span class="n">fixed</span> <span class="o">?</span> <span class="s">&quot;fixed&quot;</span> <span class="o">:</span> <span class="s">&quot;sub-rates&quot;</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="n">LIBIPW_DEFAULT_RATES_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_FIXED_RATE</span><span class="p">;</span>
		<span class="n">ipw_set_fixed_rate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_FIXED_RATE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Mask set to current mask.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* Network configuration changed -- force [re]association */</span>
	<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;[re]association triggered due to rates change.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">ipw_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rate</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_FIXED_RATE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET Rate -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">disabled</span> <span class="o">||</span> <span class="o">!</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">DEFAULT_RTS_THRESHOLD</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">MIN_RTS_THRESHOLD</span> <span class="o">||</span>
		    <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">MAX_RTS_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipw_send_rts_threshold</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET RTS Threshold -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no auto select */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">DEFAULT_RTS_THRESHOLD</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET RTS Threshold -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_txpow</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_radio_kill_sw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">IPW_TX_POWER_DEFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">IW_TXPOW_DBM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">IPW_TX_POWER_MAX</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">IPW_TX_POWER_MIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_set_tx_power</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
      <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_txpow</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_TXPOW_DBM</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET TX Power -&gt; %s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span> <span class="o">?</span> <span class="s">&quot;OFF&quot;</span> <span class="o">:</span> <span class="s">&quot;ON&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">disabled</span> <span class="o">||</span> <span class="o">!</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">fts</span> <span class="o">=</span> <span class="n">DEFAULT_FTS</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">MIN_FRAG_THRESHOLD</span> <span class="o">||</span>
		    <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">MAX_FRAG_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">fts</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipw_send_frag_threshold</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Frag Threshold -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">fts</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no auto select */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">DEFAULT_FTS</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET Frag Threshold -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LIFETIME</span> <span class="o">||</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_SHORT</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LONG</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipw_send_retry_limit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET retry limit -&gt; short:%d long:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LONG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_LONG</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_SHORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_SHORT</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET retry -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_scan_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_scan_req</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">work</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">user_requested_scan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_scan_req</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_SCAN_THIS_ESSID</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">,</span>
			              <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">direct_scan_ssid</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">direct_scan_ssid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">direct_scan_ssid_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">work</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_direct_scan</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">==</span> <span class="n">IW_SCAN_TYPE_PASSIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">work</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_passive_scan</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Normal active broadcast scan */</span>
		<span class="n">work</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Start scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">libipw_wx_get_scan</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">libipw_wx_set_encode</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

	<span class="cm">/* In IBSS mode, we need to notify the firmware to update</span>
<span class="cm">	 * the beacon info after we changed the capability. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span>
		<span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">libipw_wx_get_encode</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">IPW_POWER_LEVEL</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_send_power_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_POWER_MODE_CAM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;failed setting power mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Power Management Mode -&gt; off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_MODE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_POWER_ON</span>:	<span class="cm">/* If not specified */</span>
	<span class="k">case</span> <span class="n">IW_POWER_MODE</span>:	<span class="cm">/* If set all mask */</span>
	<span class="k">case</span> <span class="n">IW_POWER_ALL_R</span>:	<span class="cm">/* If explicitly state all */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* Otherwise we don&#39;t support it */</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET PM Mode: %X not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If the user hasn&#39;t specified a power management mode yet, default</span>
<span class="cm">	 * to BATTERY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IPW_POWER_LEVEL</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">)</span> <span class="o">==</span> <span class="n">IPW_POWER_AC</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">IPW_POWER_ENABLED</span> <span class="o">|</span> <span class="n">IPW_POWER_BATTERY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">IPW_POWER_ENABLED</span> <span class="o">|</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_send_power_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_POWER_LEVEL</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;failed setting power mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Power Management Mode -&gt; 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">&amp;</span> <span class="n">IPW_POWER_ENABLED</span><span class="p">))</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET Power Management Mode -&gt; %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_powermode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;</span> <span class="n">IPW_POWER_LIMIT</span><span class="p">))</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">IPW_POWER_AC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IPW_POWER_LEVEL</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_send_power_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;failed setting power mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">IPW_POWER_ENABLED</span> <span class="o">|</span> <span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_WX_STRING 80</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_powermode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">IPW_POWER_LEVEL</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">extra</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MAX_WX_STRING</span><span class="p">,</span> <span class="s">&quot;Power save level: %d &quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPW_POWER_AC</span>:
		<span class="n">p</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MAX_WX_STRING</span> <span class="o">-</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">extra</span><span class="p">),</span> <span class="s">&quot;(AC)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPW_POWER_BATTERY</span>:
		<span class="n">p</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MAX_WX_STRING</span> <span class="o">-</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">extra</span><span class="p">),</span> <span class="s">&quot;(BATTERY)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MAX_WX_STRING</span> <span class="o">-</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">extra</span><span class="p">),</span>
			      <span class="s">&quot;(Timeout %dms, Period %dms)&quot;</span><span class="p">,</span>
			      <span class="n">timeout_duration</span><span class="p">[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
			      <span class="n">period_duration</span><span class="p">[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">&amp;</span> <span class="n">IPW_POWER_ENABLED</span><span class="p">))</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MAX_WX_STRING</span> <span class="o">-</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">extra</span><span class="p">),</span> <span class="s">&quot; OFF&quot;</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">extra</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_wireless_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">modulation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IEEE_MODE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;Attempt to set invalid wireless mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">==</span> <span class="n">IPW_2915ABG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">abg_true</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">band</span> <span class="o">|=</span> <span class="n">LIBIPW_52GHZ_BAND</span><span class="p">;</span>
			<span class="n">modulation</span> <span class="o">|=</span> <span class="n">LIBIPW_OFDM_MODULATION</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">abg_true</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;Attempt to set 2200BG into &quot;</span>
				    <span class="s">&quot;802.11a mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">abg_true</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">band</span> <span class="o">|=</span> <span class="n">LIBIPW_24GHZ_BAND</span><span class="p">;</span>
		<span class="n">modulation</span> <span class="o">|=</span> <span class="n">LIBIPW_CCK_MODULATION</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">abg_true</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">band</span> <span class="o">|=</span> <span class="n">LIBIPW_24GHZ_BAND</span><span class="p">;</span>
		<span class="n">modulation</span> <span class="o">|=</span> <span class="n">LIBIPW_OFDM_MODULATION</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">abg_true</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">freq_band</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">modulation</span><span class="p">;</span>
	<span class="n">init_supported_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">);</span>

	<span class="cm">/* Network configuration changed -- force [re]association */</span>
	<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;[re]association triggered due to mode change.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipw_send_supported_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">);</span>
		<span class="n">ipw_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update the band LEDs */</span>
	<span class="n">ipw_led_band_on</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;PRIV SET MODE: %c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_A</span> <span class="o">?</span> <span class="sc">&#39;a&#39;</span> <span class="o">:</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span>
		     <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_B</span> <span class="o">?</span> <span class="sc">&#39;b&#39;</span> <span class="o">:</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE_G</span> <span class="o">?</span> <span class="sc">&#39;g&#39;</span> <span class="o">:</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_wireless_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE_A</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;802.11a (1)&quot;</span><span class="p">,</span> <span class="n">MAX_WX_STRING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_B</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;802.11b (2)&quot;</span><span class="p">,</span> <span class="n">MAX_WX_STRING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_A</span> <span class="o">|</span> <span class="n">IEEE_B</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;802.11ab (3)&quot;</span><span class="p">,</span> <span class="n">MAX_WX_STRING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_G</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;802.11g (4)&quot;</span><span class="p">,</span> <span class="n">MAX_WX_STRING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_A</span> <span class="o">|</span> <span class="n">IEEE_G</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;802.11ag (5)&quot;</span><span class="p">,</span> <span class="n">MAX_WX_STRING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_B</span> <span class="o">|</span> <span class="n">IEEE_G</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;802.11bg (6)&quot;</span><span class="p">,</span> <span class="n">MAX_WX_STRING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_A</span> <span class="o">|</span> <span class="n">IEEE_B</span> <span class="o">|</span> <span class="n">IEEE_G</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;802.11abg (7)&quot;</span><span class="p">,</span> <span class="n">MAX_WX_STRING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="n">MAX_WX_STRING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;PRIV GET MODE: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_preamble</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="cm">/* Switching from SHORT -&gt; LONG requires a disassociation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_PREAMBLE_LONG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_PREAMBLE_LONG</span><span class="p">;</span>

			<span class="cm">/* Network configuration changed -- force [re]association */</span>
			<span class="n">IPW_DEBUG_ASSOC</span>
			    <span class="p">(</span><span class="s">&quot;[re]association triggered due to preamble change.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
				<span class="n">ipw_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_PREAMBLE_LONG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_get_preamble</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_PREAMBLE_LONG</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;long (1)&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;auto (0)&quot;</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_set_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">parms</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET MONITOR: %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IPW2200_RADIOTAP</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_IEEE80211_RADIOTAP</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_IEEE80211</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_restart</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ipw_set_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_restart</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_MONITOR */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_restart</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wx_sw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu_sec</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="p">{</span>
			     <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">,</span>
			     <span class="p">},</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SW_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw_sw_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_firmware</span><span class="p">();</span>
		<span class="n">ipw_adapter_restart</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* The SW reset bit might have been toggled on by the &#39;disable&#39;</span>
<span class="cm">	 * module parameter, so take appropriate action */</span>
	<span class="n">ipw_radio_kill_sw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_SW</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">libipw_wx_set_encode</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu_sec</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Configuration likely changed -- force [re]association */</span>
		<span class="n">IPW_DEBUG_ASSOC</span><span class="p">(</span><span class="s">&quot;[re]association triggered due to sw &quot;</span>
				<span class="s">&quot;reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">ipw_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Rebase the WE IOCTLs to zero for the handler array */</span>
<span class="k">static</span> <span class="n">iw_handler</span> <span class="n">ipw_wx_handlers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWNAME</span><span class="p">,</span> <span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">cfg80211_wext_giwname</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWFREQ</span><span class="p">,</span> <span class="n">ipw_wx_set_freq</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWFREQ</span><span class="p">,</span> <span class="n">ipw_wx_get_freq</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWMODE</span><span class="p">,</span> <span class="n">ipw_wx_set_mode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWMODE</span><span class="p">,</span> <span class="n">ipw_wx_get_mode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWSENS</span><span class="p">,</span> <span class="n">ipw_wx_set_sens</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWSENS</span><span class="p">,</span> <span class="n">ipw_wx_get_sens</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRANGE</span><span class="p">,</span> <span class="n">ipw_wx_get_range</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWAP</span><span class="p">,</span> <span class="n">ipw_wx_set_wap</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="n">ipw_wx_get_wap</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWSCAN</span><span class="p">,</span> <span class="n">ipw_wx_set_scan</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="n">ipw_wx_get_scan</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWESSID</span><span class="p">,</span> <span class="n">ipw_wx_set_essid</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWESSID</span><span class="p">,</span> <span class="n">ipw_wx_get_essid</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWNICKN</span><span class="p">,</span> <span class="n">ipw_wx_set_nick</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWNICKN</span><span class="p">,</span> <span class="n">ipw_wx_get_nick</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWRATE</span><span class="p">,</span> <span class="n">ipw_wx_set_rate</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRATE</span><span class="p">,</span> <span class="n">ipw_wx_get_rate</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWRTS</span><span class="p">,</span> <span class="n">ipw_wx_set_rts</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRTS</span><span class="p">,</span> <span class="n">ipw_wx_get_rts</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWFRAG</span><span class="p">,</span> <span class="n">ipw_wx_set_frag</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWFRAG</span><span class="p">,</span> <span class="n">ipw_wx_get_frag</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWTXPOW</span><span class="p">,</span> <span class="n">ipw_wx_set_txpow</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWTXPOW</span><span class="p">,</span> <span class="n">ipw_wx_get_txpow</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWRETRY</span><span class="p">,</span> <span class="n">ipw_wx_set_retry</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRETRY</span><span class="p">,</span> <span class="n">ipw_wx_get_retry</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWENCODE</span><span class="p">,</span> <span class="n">ipw_wx_set_encode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWENCODE</span><span class="p">,</span> <span class="n">ipw_wx_get_encode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWPOWER</span><span class="p">,</span> <span class="n">ipw_wx_set_power</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWPOWER</span><span class="p">,</span> <span class="n">ipw_wx_get_power</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWSPY</span><span class="p">,</span> <span class="n">iw_handler_set_spy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWSPY</span><span class="p">,</span> <span class="n">iw_handler_get_spy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWTHRSPY</span><span class="p">,</span> <span class="n">iw_handler_set_thrspy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWTHRSPY</span><span class="p">,</span> <span class="n">iw_handler_get_thrspy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWGENIE</span><span class="p">,</span> <span class="n">ipw_wx_set_genie</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWGENIE</span><span class="p">,</span> <span class="n">ipw_wx_get_genie</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWMLME</span><span class="p">,</span> <span class="n">ipw_wx_set_mlme</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWAUTH</span><span class="p">,</span> <span class="n">ipw_wx_set_auth</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWAUTH</span><span class="p">,</span> <span class="n">ipw_wx_get_auth</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWENCODEEXT</span><span class="p">,</span> <span class="n">ipw_wx_set_encodeext</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWENCODEEXT</span><span class="p">,</span> <span class="n">ipw_wx_get_encodeext</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">IPW_PRIV_SET_POWER</span> <span class="o">=</span> <span class="n">SIOCIWFIRSTPRIV</span><span class="p">,</span>
	<span class="n">IPW_PRIV_GET_POWER</span><span class="p">,</span>
	<span class="n">IPW_PRIV_SET_MODE</span><span class="p">,</span>
	<span class="n">IPW_PRIV_GET_MODE</span><span class="p">,</span>
	<span class="n">IPW_PRIV_SET_PREAMBLE</span><span class="p">,</span>
	<span class="n">IPW_PRIV_GET_PREAMBLE</span><span class="p">,</span>
	<span class="n">IPW_PRIV_RESET</span><span class="p">,</span>
	<span class="n">IPW_PRIV_SW_RESET</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
	<span class="n">IPW_PRIV_SET_MONITOR</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="n">ipw_priv_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IPW_PRIV_SET_POWER</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">set_args</span> <span class="o">=</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;set_power&quot;</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IPW_PRIV_GET_POWER</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">get_args</span> <span class="o">=</span> <span class="n">IW_PRIV_TYPE_CHAR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="n">MAX_WX_STRING</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;get_power&quot;</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IPW_PRIV_SET_MODE</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">set_args</span> <span class="o">=</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;set_mode&quot;</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IPW_PRIV_GET_MODE</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">get_args</span> <span class="o">=</span> <span class="n">IW_PRIV_TYPE_CHAR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="n">MAX_WX_STRING</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;get_mode&quot;</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IPW_PRIV_SET_PREAMBLE</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">set_args</span> <span class="o">=</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;set_preamble&quot;</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IPW_PRIV_GET_PREAMBLE</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">get_args</span> <span class="o">=</span> <span class="n">IW_PRIV_TYPE_CHAR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="n">IFNAMSIZ</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;get_preamble&quot;</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="n">IPW_PRIV_RESET</span><span class="p">,</span>
	 <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="n">IPW_PRIV_SW_RESET</span><span class="p">,</span>
	 <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;sw_reset&quot;</span><span class="p">},</span>
<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
	<span class="p">{</span>
	 <span class="n">IPW_PRIV_SET_MONITOR</span><span class="p">,</span>
	 <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;monitor&quot;</span><span class="p">},</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_MONITOR */</span><span class="cp"></span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">iw_handler</span> <span class="n">ipw_priv_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ipw_wx_set_powermode</span><span class="p">,</span>
	<span class="n">ipw_wx_get_powermode</span><span class="p">,</span>
	<span class="n">ipw_wx_set_wireless_mode</span><span class="p">,</span>
	<span class="n">ipw_wx_get_wireless_mode</span><span class="p">,</span>
	<span class="n">ipw_wx_set_preamble</span><span class="p">,</span>
	<span class="n">ipw_wx_get_preamble</span><span class="p">,</span>
	<span class="n">ipw_wx_reset</span><span class="p">,</span>
	<span class="n">ipw_wx_sw_reset</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
	<span class="n">ipw_wx_set_monitor</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="n">ipw_wx_handler_def</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">standard</span> <span class="o">=</span> <span class="n">ipw_wx_handlers</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_standard</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipw_wx_handlers</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipw_priv_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private_args</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipw_priv_args</span><span class="p">),</span>
	<span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">ipw_priv_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_args</span> <span class="o">=</span> <span class="n">ipw_priv_args</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wireless_stats</span> <span class="o">=</span> <span class="n">ipw_get_wireless_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Get wireless statistics.</span>
<span class="cm"> * Called by /proc/net/wireless</span>
<span class="cm"> * Also called by SIOCGIWSTATS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="nf">ipw_get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">wstats</span><span class="p">;</span>

	<span class="n">wstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">;</span>

	<span class="cm">/* if hw is disabled, then ipw_get_ordinal() can&#39;t be called.</span>
<span class="cm">	 * netdev-&gt;get_wireless_stats seems to be called before fw is</span>
<span class="cm">	 * initialized.  STATUS_ASSOCIATED will only be set if the hw is up</span>
<span class="cm">	 * and associated; if not associcated, the values are all meaningless</span>
<span class="cm">	 * anyway, so set them all to NULL and INVALID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">miss</span><span class="p">.</span><span class="n">beacon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">|=</span> <span class="n">IW_QUAL_NOISE_INVALID</span> <span class="o">|</span>
		    <span class="n">IW_QUAL_QUAL_INVALID</span> <span class="o">|</span> <span class="n">IW_QUAL_LEVEL_INVALID</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">wstats</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">quality</span><span class="p">;</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">exp_avg_rssi</span><span class="p">;</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">exp_avg_noise</span><span class="p">;</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_QUAL_UPDATED</span> <span class="o">|</span> <span class="n">IW_QUAL_LEVEL_UPDATED</span> <span class="o">|</span>
	    <span class="n">IW_QUAL_NOISE_UPDATED</span> <span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>

	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">miss</span><span class="p">.</span><span class="n">beacon</span> <span class="o">=</span> <span class="n">average_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">average_missed_beacons</span><span class="p">);</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">retries</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_tx_failures</span><span class="p">;</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee_stats</span><span class="p">.</span><span class="n">rx_discards_undecryptable</span><span class="p">;</span>

<span class="cm">/*	if (ipw_get_ordinal(priv, IPW_ORD_STAT_TX_RETRY, &amp;tx_retry, &amp;len))</span>
<span class="cm">	goto fail_get_ordinal;</span>
<span class="cm">	wstats-&gt;discard.retries += tx_retry; */</span>

	<span class="k">return</span> <span class="n">wstats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* net device stuff */</span>

<span class="k">static</span>  <span class="kt">void</span> <span class="nf">init_sys_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_sys_config</span> <span class="o">*</span><span class="n">sys_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sys_config</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_sys_config</span><span class="p">));</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">bt_coexistence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">answer_broadcast_ssid_probe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">accept_all_data_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">accept_non_directed_frames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">exclude_unicast_unencrypted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">disable_unicast_decryption</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">exclude_multicast_unencrypted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">disable_multicast_decryption</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">antenna</span> <span class="o">&lt;</span> <span class="n">CFG_SYS_ANTENNA_BOTH</span> <span class="o">||</span> <span class="n">antenna</span> <span class="o">&gt;</span> <span class="n">CFG_SYS_ANTENNA_B</span><span class="p">)</span>
		<span class="n">antenna</span> <span class="o">=</span> <span class="n">CFG_SYS_ANTENNA_BOTH</span><span class="p">;</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">antenna_diversity</span> <span class="o">=</span> <span class="n">antenna</span><span class="p">;</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">pass_crc_to_host</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* TODO: See if 1 gives us FCS */</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">dot11g_auto_detection</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">enable_cts_to_self</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">bt_coexist_collision_thr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">pass_noise_stats_to_host</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 1 -- fix for 256 */</span>
	<span class="n">sys_config</span><span class="o">-&gt;</span><span class="n">silence_threshold</span> <span class="o">=</span> <span class="mh">0x1e</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;dev-&gt;open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_net_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;dev-&gt;close</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">todo:</span>

<span class="cm">modify to send one tfd per fragment instead of using chunking.  otherwise</span>
<span class="cm">we need to heavily modify the libipw_skb_to_txb.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_tx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">libipw_txb</span> <span class="o">*</span><span class="n">txb</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">pri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">libipw_hdr_3addrqos</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">libipw_hdr_3addrqos</span> <span class="o">*</span><span class="p">)</span>
	    <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tfd_frame</span> <span class="o">*</span><span class="n">tfd</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPW2200_QOS</span>
	<span class="kt">int</span> <span class="n">tx_id</span> <span class="o">=</span> <span class="n">ipw_get_tx_queue_number</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">pri</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">clx2_tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">tx_id</span><span class="p">];</span>
<span class="cp">#else</span>
	<span class="k">struct</span> <span class="n">clx2_tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">clx2_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">unicast</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">libipw_get_hdrlen</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
		<span class="n">unicast</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">ipw_find_station</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">IPW_INVALID_STATION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">ipw_add_station</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">IPW_INVALID_STATION</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;Attempt to send data to &quot;</span>
					    <span class="s">&quot;invalid cell: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
	<span class="nl">default:</span>
		<span class="n">unicast</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">);</span>
		<span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tfd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span><span class="p">];</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txb</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span><span class="p">]</span> <span class="o">=</span> <span class="n">txb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tfd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tfd</span><span class="p">));</span>
	<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">station_number</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">control_flags</span><span class="p">.</span><span class="n">message_type</span> <span class="o">=</span> <span class="n">TX_FRAME_TYPE</span><span class="p">;</span>
	<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">control_flags</span><span class="p">.</span><span class="n">control_bits</span> <span class="o">=</span> <span class="n">TFD_NEED_IRQ_MASK</span><span class="p">;</span>

	<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">cmd_id</span> <span class="o">=</span> <span class="n">DINO_CMD_TX</span><span class="p">;</span>
	<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">payload_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">ieee_mode</span> <span class="o">==</span> <span class="n">IPW_B_MODE</span><span class="p">)</span>
		<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tx_flags_ext</span> <span class="o">|=</span> <span class="n">DCT_FLAG_EXT_MODE_CCK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tx_flags_ext</span> <span class="o">|=</span> <span class="n">DCT_FLAG_EXT_MODE_OFDM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_request</span><span class="p">.</span><span class="n">preamble_length</span> <span class="o">==</span> <span class="n">DCT_FLAG_SHORT_PREAMBLE</span><span class="p">)</span>
		<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">DCT_FLAG_SHORT_PREAMBLE</span><span class="p">;</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tfd</span><span class="p">.</span><span class="n">tfd_24</span><span class="p">.</span><span class="n">mchdr</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">unicast</span><span class="p">))</span>
		<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">DCT_FLAG_ACK_REQD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">encrypted</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SEC_LEVEL_3</span>:
			<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tfd</span><span class="p">.</span><span class="n">tfd_24</span><span class="p">.</span><span class="n">mchdr</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">|=</span>
			    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">);</span>
			<span class="cm">/* XXX: ACK flag must be set for CCMP even if it</span>
<span class="cm">			 * is a multicast/broadcast packet, because CCMP</span>
<span class="cm">			 * group communication encrypted by GTK is</span>
<span class="cm">			 * actually done by the AP. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unicast</span><span class="p">)</span>
				<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">DCT_FLAG_ACK_REQD</span><span class="p">;</span>

			<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DCT_FLAG_NO_WEP</span><span class="p">;</span>
			<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tx_flags_ext</span> <span class="o">|=</span> <span class="n">DCT_FLAG_EXT_SECURITY_CCM</span><span class="p">;</span>
			<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">key_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">key_index</span> <span class="o">|=</span> <span class="n">DCT_WEP_INDEX_USE_IMMEDIATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SEC_LEVEL_2</span>:
			<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tfd</span><span class="p">.</span><span class="n">tfd_24</span><span class="p">.</span><span class="n">mchdr</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">|=</span>
			    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">);</span>
			<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DCT_FLAG_NO_WEP</span><span class="p">;</span>
			<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tx_flags_ext</span> <span class="o">|=</span> <span class="n">DCT_FLAG_EXT_SECURITY_TKIP</span><span class="p">;</span>
			<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">key_index</span> <span class="o">=</span> <span class="n">DCT_WEP_INDEX_USE_IMMEDIATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SEC_LEVEL_1</span>:
			<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tfd</span><span class="p">.</span><span class="n">tfd_24</span><span class="p">.</span><span class="n">mchdr</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">|=</span>
			    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">);</span>
			<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">key_index</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_sizes</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">]</span> <span class="o">&lt;=</span>
			    <span class="mi">40</span><span class="p">)</span>
				<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">key_index</span> <span class="o">|=</span> <span class="n">DCT_WEP_KEY_64Bit</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">key_index</span> <span class="o">|=</span> <span class="n">DCT_WEP_KEY_128Bit</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SEC_LEVEL_0</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unknown security level %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* No hardware encryption */</span>
		<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">DCT_FLAG_NO_WEP</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPW2200_QOS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_STYPE_QOS_DATA</span><span class="p">)</span>
		<span class="n">ipw_qos_set_tx_queue_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">pri</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">));</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_QOS */</span><span class="cp"></span>

	<span class="cm">/* payload */</span>
	<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">num_chunks</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">min</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">NUM_TFD_CHUNKS</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span>
						 <span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">));</span>
	<span class="n">IPW_DEBUG_FRAG</span><span class="p">(</span><span class="s">&quot;%i fragments being sent as %i chunks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">num_chunks</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">num_chunks</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_FRAG</span><span class="p">(</span><span class="s">&quot;Adding fragment %i of %i (%d bytes).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">num_chunks</span><span class="p">),</span>
			       <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;Dumping TX packet frag %i of %i (%d bytes):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">i</span><span class="p">,</span> <span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">num_chunks</span><span class="p">,</span>
			     <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="n">printk_buf</span><span class="p">(</span><span class="n">IPW_DL_TX</span><span class="p">,</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">,</span>
			   <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">);</span>

		<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">chunk_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span>
				<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
				 <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">,</span>
				 <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">,</span>
				 <span class="n">PCI_DMA_TODEVICE</span><span class="p">));</span>
		<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">chunk_len</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">remaining_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">remaining_bytes</span> <span class="o">+=</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Trying to reallocate for %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">remaining_bytes</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">remaining_bytes</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">chunk_len</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">remaining_bytes</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">;</span>

				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Adding frag %d %d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">j</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span>
				       <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">chunk_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span>
					<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					 <span class="n">remaining_bytes</span><span class="p">,</span>
					 <span class="n">PCI_DMA_TODEVICE</span><span class="p">));</span>

			<span class="n">le32_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tfd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">num_chunks</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* kick DMA */</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span> <span class="o">=</span> <span class="n">ipw_queue_inc_wrap</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">);</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">reg_w</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_empty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_tx_queue_space</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">high_mark</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

      <span class="nl">drop:</span>
	<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Silently dropping Tx packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">libipw_txb_free</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_net_is_queue_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IPW2200_QOS</span>
	<span class="kt">int</span> <span class="n">tx_id</span> <span class="o">=</span> <span class="n">ipw_get_tx_queue_number</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">pri</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">clx2_tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">tx_id</span><span class="p">];</span>
<span class="cp">#else</span>
	<span class="k">struct</span> <span class="n">clx2_tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_QOS */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_tx_queue_space</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">high_mark</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_handle_promiscuous_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">libipw_txb</span> <span class="o">*</span><span class="n">txb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">libipw_rx_stats</span> <span class="n">dummystats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_priv</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdr_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_NO_TX</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummystats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dummystats</span><span class="p">));</span>

	<span class="cm">/* Filtering of fragment chains is done against the first fragment */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">libipw_is_management</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_NO_MGMT</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_MGMT_HEADER_ONLY</span><span class="p">)</span>
			<span class="n">hdr_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">libipw_is_control</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_NO_CTL</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_CTL_HEADER_ONLY</span><span class="p">)</span>
			<span class="n">hdr_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">libipw_is_data</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_NO_DATA</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&amp;</span> <span class="n">IPW_PROM_DATA_HEADER_ONLY</span><span class="p">)</span>
			<span class="n">hdr_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">n</span><span class="o">&lt;</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_radiotap_header</span> <span class="o">*</span><span class="n">rt_hdr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdr_only</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">libipw_get_hdrlen</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="n">dst</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rt_hdr</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dst</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">rt_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rt_hdr</span><span class="p">));</span>

		<span class="n">rt_hdr</span><span class="o">-&gt;</span><span class="n">it_version</span> <span class="o">=</span> <span class="n">PKTHDR_RADIOTAP_VERSION</span><span class="p">;</span>
		<span class="n">rt_hdr</span><span class="o">-&gt;</span><span class="n">it_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rt_hdr</span><span class="o">-&gt;</span><span class="n">it_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* after all, it&#39;s just an idea */</span>
		<span class="n">rt_hdr</span><span class="o">-&gt;</span><span class="n">it_present</span> <span class="o">|=</span>  <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_CHANNEL</span><span class="p">);</span>

		<span class="o">*</span><span class="p">(</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">))</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
			<span class="n">ieee80211chan2mhz</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> 	<span class="cm">/* 802.11a */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">))</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_CHAN_OFDM</span> <span class="o">|</span>
					     <span class="n">IEEE80211_CHAN_5GHZ</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_B</span><span class="p">)</span> <span class="cm">/* 802.11b */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">))</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_CHAN_CCK</span> <span class="o">|</span>
					     <span class="n">IEEE80211_CHAN_2GHZ</span><span class="p">);</span>
		<span class="k">else</span> 		<span class="cm">/* 802.11g */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">))</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_CHAN_OFDM</span> <span class="o">|</span>
				 <span class="n">IEEE80211_CHAN_2GHZ</span><span class="p">);</span>

		<span class="n">rt_hdr</span><span class="o">-&gt;</span><span class="n">it_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">libipw_rx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummystats</span><span class="p">))</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">ipw_net_hard_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">libipw_txb</span> <span class="o">*</span><span class="n">txb</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">netdev_tx_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;dev-&gt;xmit(%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">payload_size</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtap_iface</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">))</span>
		<span class="n">ipw_handle_promiscuous_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">txb</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw_tx_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">txb</span><span class="p">,</span> <span class="n">pri</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">NETDEV_TX_OK</span><span class="p">)</span>
		<span class="n">__ipw_led_activity_on</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_net_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_net_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_CUSTOM_MAC</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Setting MAC to %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_restart</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_ethtool_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">vers</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">date</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vers</span><span class="p">);</span>
	<span class="n">ipw_get_ordinal</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_FW_VERSION</span><span class="p">,</span> <span class="n">vers</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">date</span><span class="p">);</span>
	<span class="n">ipw_get_ordinal</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_FW_DATE</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span> <span class="s">&quot;%s (%s)&quot;</span><span class="p">,</span>
		 <span class="n">vers</span><span class="p">,</span> <span class="n">date</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">eedump_len</span> <span class="o">=</span> <span class="n">IPW_EEPROM_IMAGE_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ipw_ethtool_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_ethtool_get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">IPW_EEPROM_IMAGE_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_ethtool_get_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">IPW_EEPROM_IMAGE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">],</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_ethtool_set_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">IPW_EEPROM_IMAGE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">],</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPW_EEPROM_IMAGE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ipw_write8</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">IPW_EEPROM_DATA</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ipw_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ipw_ethtool_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">ipw_ethtool_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_len</span> <span class="o">=</span> <span class="n">ipw_ethtool_get_eeprom_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom</span> <span class="o">=</span> <span class="n">ipw_ethtool_get_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_eeprom</span> <span class="o">=</span> <span class="n">ipw_ethtool_set_eeprom</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ipw_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inta</span><span class="p">,</span> <span class="n">inta_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INT_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* IRQ is disabled */</span>
		<span class="k">goto</span> <span class="n">none</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">inta</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_RW</span><span class="p">);</span>
	<span class="n">inta_mask</span> <span class="o">=</span> <span class="n">ipw_read32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_MASK_R</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Hardware disappeared */</span>
		<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;IRQ INTA == 0xFFFFFFFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">none</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IPW_INTA_MASK_ALL</span> <span class="o">&amp;</span> <span class="n">inta_mask</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Shared interrupt */</span>
		<span class="k">goto</span> <span class="n">none</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* tell the device to stop sending interrupts */</span>
	<span class="n">__ipw_disable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* ack current interrupts */</span>
	<span class="n">inta</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">IPW_INTA_MASK_ALL</span> <span class="o">&amp;</span> <span class="n">inta_mask</span><span class="p">);</span>
	<span class="n">ipw_write32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_INTA_RW</span><span class="p">,</span> <span class="n">inta</span><span class="p">);</span>

	<span class="cm">/* Cache INTA value for our tasklet */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">isr_inta</span> <span class="o">=</span> <span class="n">inta</span><span class="p">;</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
      <span class="nl">none:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_rf_kill</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rf_kill_active</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_RF_KILL</span><span class="p">(</span><span class="s">&quot;RF Kill active, rescheduling GPIO check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* RF Kill is now disabled, so bring the device back up */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_RF_KILL</span><span class="p">(</span><span class="s">&quot;HW RF Kill no longer active, restarting &quot;</span>
				  <span class="s">&quot;device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* we can not do an adapter restart while inside an irq lock */</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_restart</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">IPW_DEBUG_RF_KILL</span><span class="p">(</span><span class="s">&quot;HW RF Kill deactivated.  SW RF Kill still &quot;</span>
				  <span class="s">&quot;enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

      <span class="nl">exit_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_rf_kill</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">rf_kill</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_rf_kill</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_link_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_seq_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_frag_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_packet_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_direct_scan</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_passive_scan</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event</span><span class="p">);</span>
	<span class="n">ipw_reset_stats</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="cm">/* Ensure the rate is updated immediately */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rate</span> <span class="o">=</span> <span class="n">ipw_get_current_rate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw_gather_stats</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw_led_link_up</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_BACKGROUND_SCAN</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_link_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">link_up</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_link_up</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_link_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipw_led_link_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Cancel any queued work ... */</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_direct_scan</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_passive_scan</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_check</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gather_stats</span><span class="p">);</span>

	<span class="n">ipw_reset_stats</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_EXIT_PENDING</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Queue up another scan... */</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_link_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">link_down</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_link_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ipw_setup_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_state</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_check</span><span class="p">,</span> <span class="n">ipw_bg_adhoc_check</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">associate</span><span class="p">,</span> <span class="n">ipw_bg_associate</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">disassociate</span><span class="p">,</span> <span class="n">ipw_bg_disassociate</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">system_config</span><span class="p">,</span> <span class="n">ipw_system_config</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_replenish</span><span class="p">,</span> <span class="n">ipw_bg_rx_queue_replenish</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_restart</span><span class="p">,</span> <span class="n">ipw_bg_adapter_restart</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">,</span> <span class="n">ipw_bg_rf_kill</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">,</span> <span class="n">ipw_bg_up</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">,</span> <span class="n">ipw_bg_down</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">,</span> <span class="n">ipw_request_scan</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_direct_scan</span><span class="p">,</span> <span class="n">ipw_request_direct_scan</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_passive_scan</span><span class="p">,</span> <span class="n">ipw_request_passive_scan</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event</span><span class="p">,</span> <span class="n">ipw_scan_event</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gather_stats</span><span class="p">,</span> <span class="n">ipw_bg_gather_stats</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">abort_scan</span><span class="p">,</span> <span class="n">ipw_bg_abort_scan</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">roam</span><span class="p">,</span> <span class="n">ipw_bg_roam</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_check</span><span class="p">,</span> <span class="n">ipw_bg_scan_check</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">,</span> <span class="n">ipw_bg_link_up</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_down</span><span class="p">,</span> <span class="n">ipw_bg_link_down</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_link_on</span><span class="p">,</span> <span class="n">ipw_bg_led_link_on</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_link_off</span><span class="p">,</span> <span class="n">ipw_bg_led_link_off</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_act_off</span><span class="p">,</span> <span class="n">ipw_bg_led_activity_off</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">merge_networks</span><span class="p">,</span> <span class="n">ipw_merge_adhoc_network</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPW2200_QOS</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">,</span> <span class="n">ipw_bg_qos_activate</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_QOS */</span><span class="cp"></span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span>
		     <span class="n">ipw_irq_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shim__set_security</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">libipw_security</span> <span class="o">*</span><span class="n">sec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">encode_alg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">encode_alg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">key_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">key_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				       <span class="n">sec</span><span class="o">-&gt;</span><span class="n">key_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SECURITY_UPDATED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SEC_LEVEL_1</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_ACTIVE_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">active_key</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">active_key</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">active_key</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_ACTIVE_KEY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEC_ACTIVE_KEY</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SECURITY_UPDATED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEC_ACTIVE_KEY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_AUTH_MODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">!=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">auth_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">auth_mode</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_AUTH_MODE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">CAP_SHARED_KEY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CAP_SHARED_KEY</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SECURITY_UPDATED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_ENABLED</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">enabled</span> <span class="o">!=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_ENABLED</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SECURITY_UPDATED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">CAP_PRIVACY_ON</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CAP_PRIVACY_ON</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_ENCRYPT</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">encrypt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_LEVEL</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">!=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SECURITY_UPDATED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_ENCRYPT</span><span class="p">))</span>
		<span class="n">ipw_set_hwcrypto_keys</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* To match current functionality of ipw2100 (which works well w/</span>
<span class="cm">	 * various supplicants, we don&#39;t force a disassociate if the</span>
<span class="cm">	 * privacy capability changes ... */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if ((priv-&gt;status &amp; (STATUS_ASSOCIATED | STATUS_ASSOCIATING)) &amp;&amp;</span>
<span class="c">	    (((priv-&gt;assoc_request.capability &amp;</span>
<span class="c">	       cpu_to_le16(WLAN_CAPABILITY_PRIVACY)) &amp;&amp; !sec-&gt;enabled) ||</span>
<span class="c">	     (!(priv-&gt;assoc_request.capability &amp;</span>
<span class="c">		cpu_to_le16(WLAN_CAPABILITY_PRIVACY)) &amp;&amp; sec-&gt;enabled))) {</span>
<span class="c">		IPW_DEBUG_ASSOC(&quot;Disassociating due to capability &quot;</span>
<span class="c">				&quot;change.\n&quot;);</span>
<span class="c">		ipw_disassociate(priv);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_supported_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipw_supported_rates</span> <span class="o">*</span><span class="n">rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO: Mask out rates based on priv-&gt;rates_mask */</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rates</span><span class="p">));</span>
	<span class="cm">/* configure supported rates */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">freq_band</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LIBIPW_52GHZ_BAND</span>:
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">ieee_mode</span> <span class="o">=</span> <span class="n">IPW_A_MODE</span><span class="p">;</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">purpose</span> <span class="o">=</span> <span class="n">IPW_RATE_CAPABILITIES</span><span class="p">;</span>
		<span class="n">ipw_add_ofdm_scan_rates</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">LIBIPW_CCK_MODULATION</span><span class="p">,</span>
					<span class="n">LIBIPW_OFDM_DEFAULT_RATES_MASK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>		<span class="cm">/* Mixed or 2.4Ghz */</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">ieee_mode</span> <span class="o">=</span> <span class="n">IPW_G_MODE</span><span class="p">;</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">purpose</span> <span class="o">=</span> <span class="n">IPW_RATE_CAPABILITIES</span><span class="p">;</span>
		<span class="n">ipw_add_cck_scan_rates</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">LIBIPW_CCK_MODULATION</span><span class="p">,</span>
				       <span class="n">LIBIPW_CCK_DEFAULT_RATES_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">LIBIPW_OFDM_MODULATION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipw_add_ofdm_scan_rates</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">LIBIPW_CCK_MODULATION</span><span class="p">,</span>
						<span class="n">LIBIPW_OFDM_DEFAULT_RATES_MASK</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is only called from ipw_up, which resets/reloads the firmware</span>
<span class="cm">	   so, we don&#39;t need to first disable the card before we configure</span>
<span class="cm">	   it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_set_tx_power</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* initialize adapter address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_send_adapter_address</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* set basic system config settings */</span>
	<span class="n">init_sys_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">);</span>

	<span class="cm">/* Support Bluetooth if we have BT h/w on board, and user wants to.</span>
<span class="cm">	 * Does not support BT priority yet (don&#39;t abort or defer our Tx) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bt_coexist</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bt_caps</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">EEPROM_SKU_CAPABILITY</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bt_caps</span> <span class="o">&amp;</span> <span class="n">EEPROM_SKU_CAP_BT_CHANNEL_SIG</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">bt_coexistence</span>
			    <span class="o">|=</span> <span class="n">CFG_BT_COEXISTENCE_SIGNAL_CHNL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bt_caps</span> <span class="o">&amp;</span> <span class="n">EEPROM_SKU_CAP_BT_OOB</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">bt_coexistence</span>
			    <span class="o">|=</span> <span class="n">CFG_BT_COEXISTENCE_OOB</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_all_data_frames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_non_directed_frames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_all_mgmt_bcpr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_all_mgmt_frames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">answer_broadcast_ssid_probe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">answer_broadcast_ssid_probe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_send_system_config</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">init_supported_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_send_supported_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Set request-to-send threshold */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipw_send_rts_threshold</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_IPW2200_QOS</span>
	<span class="n">IPW_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS: call ipw_qos_activate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ipw_qos_activate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_QOS */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_set_random_seed</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* final state transition to the RUN state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_send_host_complete</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_INIT</span><span class="p">;</span>

	<span class="n">ipw_led_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw_led_radio_on</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">notif_missed_beacons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set hardware WEP key if it is configured. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY_ON</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">SEC_LEVEL_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span><span class="p">))</span>
		<span class="n">ipw_set_hwcrypto_keys</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">error:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE:</span>
<span class="cm"> *</span>
<span class="cm"> * These tables have been tested in conjunction with the</span>
<span class="cm"> * Intel PRO/Wireless 2200BG and 2915ABG Network Connection Adapters.</span>
<span class="cm"> *</span>
<span class="cm"> * Altering this values, using it on other hardware, or in geographies</span>
<span class="cm"> * not intended for resale of the above mentioned Intel adapters has</span>
<span class="cm"> * not been tested.</span>
<span class="cm"> *</span>
<span class="cm"> * Remember to update the table in README.ipw2200 when changing this</span>
<span class="cm"> * table.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">libipw_geo</span> <span class="n">ipw_geos</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>			<span class="cm">/* Restricted */</span>
	 <span class="s">&quot;---&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">}},</span>
	 <span class="p">},</span>

	<span class="p">{</span>			<span class="cm">/* Custom US/Canada */</span>
	 <span class="s">&quot;ZZF&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">}},</span>
	 <span class="p">.</span><span class="n">a_channels</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">5180</span><span class="p">,</span> <span class="mi">36</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5200</span><span class="p">,</span> <span class="mi">40</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5220</span><span class="p">,</span> <span class="mi">44</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5240</span><span class="p">,</span> <span class="mi">48</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5260</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5280</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5300</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5320</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">}},</span>
	 <span class="p">},</span>

	<span class="p">{</span>			<span class="cm">/* Rest of World */</span>
	 <span class="s">&quot;ZZD&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">},</span> <span class="p">{</span><span class="mi">2467</span><span class="p">,</span> <span class="mi">12</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2472</span><span class="p">,</span> <span class="mi">13</span><span class="p">}},</span>
	 <span class="p">},</span>

	<span class="p">{</span>			<span class="cm">/* Custom USA &amp; Europe &amp; High */</span>
	 <span class="s">&quot;ZZA&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">}},</span>
	 <span class="p">.</span><span class="n">a_channels</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">5180</span><span class="p">,</span> <span class="mi">36</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5200</span><span class="p">,</span> <span class="mi">40</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5220</span><span class="p">,</span> <span class="mi">44</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5240</span><span class="p">,</span> <span class="mi">48</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5260</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5280</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5300</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5320</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5745</span><span class="p">,</span> <span class="mi">149</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5765</span><span class="p">,</span> <span class="mi">153</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5785</span><span class="p">,</span> <span class="mi">157</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5805</span><span class="p">,</span> <span class="mi">161</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5825</span><span class="p">,</span> <span class="mi">165</span><span class="p">}},</span>
	 <span class="p">},</span>

	<span class="p">{</span>			<span class="cm">/* Custom NA &amp; Europe */</span>
	 <span class="s">&quot;ZZB&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">}},</span>
	 <span class="p">.</span><span class="n">a_channels</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">5180</span><span class="p">,</span> <span class="mi">36</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5200</span><span class="p">,</span> <span class="mi">40</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5220</span><span class="p">,</span> <span class="mi">44</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5240</span><span class="p">,</span> <span class="mi">48</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5260</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5280</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5300</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5320</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5745</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5765</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5785</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5805</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5825</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">}},</span>
	 <span class="p">},</span>

	<span class="p">{</span>			<span class="cm">/* Custom Japan */</span>
	 <span class="s">&quot;ZZC&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">}},</span>
	 <span class="p">.</span><span class="n">a_channels</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">5170</span><span class="p">,</span> <span class="mi">34</span><span class="p">},</span> <span class="p">{</span><span class="mi">5190</span><span class="p">,</span> <span class="mi">38</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5210</span><span class="p">,</span> <span class="mi">42</span><span class="p">},</span> <span class="p">{</span><span class="mi">5230</span><span class="p">,</span> <span class="mi">46</span><span class="p">}},</span>
	 <span class="p">},</span>

	<span class="p">{</span>			<span class="cm">/* Custom */</span>
	 <span class="s">&quot;ZZM&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">}},</span>
	 <span class="p">},</span>

	<span class="p">{</span>			<span class="cm">/* Europe */</span>
	 <span class="s">&quot;ZZE&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">},</span> <span class="p">{</span><span class="mi">2467</span><span class="p">,</span> <span class="mi">12</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2472</span><span class="p">,</span> <span class="mi">13</span><span class="p">}},</span>
	 <span class="p">.</span><span class="n">a_channels</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">5180</span><span class="p">,</span> <span class="mi">36</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5200</span><span class="p">,</span> <span class="mi">40</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5220</span><span class="p">,</span> <span class="mi">44</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5240</span><span class="p">,</span> <span class="mi">48</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5260</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5280</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5300</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5320</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5500</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5520</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5540</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5560</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5580</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5600</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5620</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5640</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5660</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5680</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5700</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">}},</span>
	 <span class="p">},</span>

	<span class="p">{</span>			<span class="cm">/* Custom Japan */</span>
	 <span class="s">&quot;ZZJ&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">},</span> <span class="p">{</span><span class="mi">2467</span><span class="p">,</span> <span class="mi">12</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2472</span><span class="p">,</span> <span class="mi">13</span><span class="p">},</span> <span class="p">{</span><span class="mi">2484</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">LIBIPW_CH_B_ONLY</span><span class="p">}},</span>
	 <span class="p">.</span><span class="n">a_channels</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">5170</span><span class="p">,</span> <span class="mi">34</span><span class="p">},</span> <span class="p">{</span><span class="mi">5190</span><span class="p">,</span> <span class="mi">38</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5210</span><span class="p">,</span> <span class="mi">42</span><span class="p">},</span> <span class="p">{</span><span class="mi">5230</span><span class="p">,</span> <span class="mi">46</span><span class="p">}},</span>
	 <span class="p">},</span>

	<span class="p">{</span>			<span class="cm">/* Rest of World */</span>
	 <span class="s">&quot;ZZR&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">},</span> <span class="p">{</span><span class="mi">2467</span><span class="p">,</span> <span class="mi">12</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2472</span><span class="p">,</span> <span class="mi">13</span><span class="p">},</span> <span class="p">{</span><span class="mi">2484</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">LIBIPW_CH_B_ONLY</span> <span class="o">|</span>
			     <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">}},</span>
	 <span class="p">},</span>

	<span class="p">{</span>			<span class="cm">/* High Band */</span>
	 <span class="s">&quot;ZZH&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2467</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2472</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">}},</span>
	 <span class="p">.</span><span class="n">a_channels</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">5745</span><span class="p">,</span> <span class="mi">149</span><span class="p">},</span> <span class="p">{</span><span class="mi">5765</span><span class="p">,</span> <span class="mi">153</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5785</span><span class="p">,</span> <span class="mi">157</span><span class="p">},</span> <span class="p">{</span><span class="mi">5805</span><span class="p">,</span> <span class="mi">161</span><span class="p">}},</span>
	 <span class="p">},</span>

	<span class="p">{</span>			<span class="cm">/* Custom Europe */</span>
	 <span class="s">&quot;ZZG&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2467</span><span class="p">,</span> <span class="mi">12</span><span class="p">},</span> <span class="p">{</span><span class="mi">2472</span><span class="p">,</span> <span class="mi">13</span><span class="p">}},</span>
	 <span class="p">.</span><span class="n">a_channels</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">5180</span><span class="p">,</span> <span class="mi">36</span><span class="p">},</span> <span class="p">{</span><span class="mi">5200</span><span class="p">,</span> <span class="mi">40</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5220</span><span class="p">,</span> <span class="mi">44</span><span class="p">},</span> <span class="p">{</span><span class="mi">5240</span><span class="p">,</span> <span class="mi">48</span><span class="p">}},</span>
	 <span class="p">},</span>

	<span class="p">{</span>			<span class="cm">/* Europe */</span>
	 <span class="s">&quot;ZZK&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2467</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2472</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">}},</span>
	 <span class="p">.</span><span class="n">a_channels</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">5180</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5200</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5220</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5240</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5260</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5280</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5300</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5320</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5500</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5520</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5540</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5560</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5580</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5600</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5620</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5640</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5660</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5680</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5700</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5745</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5765</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5785</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5805</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5825</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">}},</span>
	 <span class="p">},</span>

	<span class="p">{</span>			<span class="cm">/* Europe */</span>
	 <span class="s">&quot;ZZL&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">}},</span>
	 <span class="p">.</span><span class="n">a_channels</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">5180</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5200</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5220</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5240</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5260</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5280</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5300</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5320</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5745</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5765</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5785</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5805</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">},</span>
	       <span class="p">{</span><span class="mi">5825</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">}},</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define MAX_HW_RESTARTS 5</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/* Age scan list entries found before suspend */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">suspend_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">libipw_networks_age</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">suspend_time</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">suspend_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_EXIT_PENDING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdlog</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">cmdlog</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">),</span>
				       <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Error allocating %d command log entries.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">cmdlog</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog_len</span> <span class="o">=</span> <span class="n">cmdlog</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_HW_RESTARTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Load the microcode, firmware, and eeprom.</span>
<span class="cm">		 * Also start the clocks. */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_load</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to load firmware: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ipw_init_ordinals</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_CUSTOM_MAC</span><span class="p">))</span>
			<span class="n">eeprom_parse_mac</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipw_geos</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">EEPROM_COUNTRY_CODE</span><span class="p">],</span>
				    <span class="n">ipw_geos</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipw_geos</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;SKU [%c%c%c] not recognized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">EEPROM_COUNTRY_CODE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">],</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">EEPROM_COUNTRY_CODE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">EEPROM_COUNTRY_CODE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">libipw_set_geo</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw_geos</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;Could not set geography.&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_SW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;Radio disabled by module parameter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rf_kill_active</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IPW_WARNING</span><span class="p">(</span><span class="s">&quot;Radio Frequency Kill Switch is On:</span><span class="se">\n</span><span class="s">&quot;</span>
				    <span class="s">&quot;Kill switch must be turned off for &quot;</span>
				    <span class="s">&quot;wireless networking to work.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipw_config</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Configured device on count %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

			<span class="cm">/* If configure to try and auto-associate, kick</span>
<span class="cm">			 * off a scan. */</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Device configuration failed: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Failed to config device on retry %d of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="n">MAX_HW_RESTARTS</span><span class="p">);</span>

		<span class="cm">/* We had an error bringing up the hardware, so take it</span>
<span class="cm">		 * all the way back down so we can try again */</span>
		<span class="n">ipw_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* tried to restart and config the device for as long as our</span>
<span class="cm">	 * patience could withstand */</span>
	<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to initialize device after %d attempts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_up</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCANNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Aborting scan during shutdown.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipw_abort_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Disassociating during shutdown.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ipw_led_shutdown</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Wait up to 1s for status to change to not scanning and not</span>
<span class="cm">	 * associated (disassociation can take a while for a ful 802.11</span>
<span class="cm">	 * exchange */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span>
			     <span class="p">(</span><span class="n">STATUS_DISASSOCIATING</span> <span class="o">|</span>
			      <span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_SCANNING</span><span class="p">));</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUS_DISASSOCIATING</span> <span class="o">|</span>
			    <span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_SCANNING</span><span class="p">))</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Still associated or scanning...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Took %dms to de-init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Attempt to disable the card */</span>
	<span class="n">ipw_send_card_disable</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_INIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">exit_pending</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_EXIT_PENDING</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_EXIT_PENDING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_is_init</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">ipw_deinit</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Wipe out the EXIT_PENDING status bit if we are not actually</span>
<span class="cm">	 * exiting the module */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exit_pending</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_EXIT_PENDING</span><span class="p">;</span>

	<span class="cm">/* tell the device to stop sending interrupts */</span>
	<span class="n">ipw_disable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Clear all bits but the RF Kill */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="n">STATUS_RF_KILL_MASK</span> <span class="o">|</span> <span class="n">STATUS_EXIT_PENDING</span><span class="p">;</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="n">ipw_stop_nic</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">ipw_led_radio_off</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_bg_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ipw_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_wdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">libipw_geo</span> <span class="o">*</span><span class="n">geo</span> <span class="o">=</span> <span class="n">libipw_get_geo</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* fill-out priv-&gt;ieee-&gt;bg_band */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">bg_band</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bg_band</span><span class="p">;</span>

		<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
		<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span><span class="p">;</span>
		<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_channel</span><span class="p">),</span>
					    <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* translate geo-&gt;bg to bg_band.channels */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
			<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">center_freq</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span><span class="p">;</span>
			<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_power</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_power</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">)</span>
				<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
					<span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_NO_IBSS</span><span class="p">)</span>
				<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
					<span class="n">IEEE80211_CHAN_NO_IBSS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_RADAR_DETECT</span><span class="p">)</span>
				<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
					<span class="n">IEEE80211_CHAN_RADAR</span><span class="p">;</span>
			<span class="cm">/* No equivalent for LIBIPW_CH_80211H_RULES,</span>
<span class="cm">			   LIBIPW_CH_UNIFORM_SPREADING, or</span>
<span class="cm">			   LIBIPW_CH_B_ONLY... */</span>
		<span class="p">}</span>
		<span class="cm">/* point at bitrate info */</span>
		<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">ipw2200_bg_rates</span><span class="p">;</span>
		<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ipw2200_num_bg_rates</span><span class="p">;</span>

		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">bg_band</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill-out priv-&gt;ieee-&gt;a_band */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">a_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">a_band</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">a_band</span><span class="p">;</span>

		<span class="n">a_band</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
		<span class="n">a_band</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a_channels</span><span class="p">;</span>
		<span class="n">a_band</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">a_channels</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_channel</span><span class="p">),</span>
					   <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* translate geo-&gt;a to a_band.channels */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
			<span class="n">a_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">center_freq</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span><span class="p">;</span>
			<span class="n">a_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">a_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_power</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_power</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">)</span>
				<span class="n">a_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
					<span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_NO_IBSS</span><span class="p">)</span>
				<span class="n">a_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
					<span class="n">IEEE80211_CHAN_NO_IBSS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_RADAR_DETECT</span><span class="p">)</span>
				<span class="n">a_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
					<span class="n">IEEE80211_CHAN_RADAR</span><span class="p">;</span>
			<span class="cm">/* No equivalent for LIBIPW_CH_80211H_RULES,</span>
<span class="cm">			   LIBIPW_CH_UNIFORM_SPREADING, or</span>
<span class="cm">			   LIBIPW_CH_B_ONLY... */</span>
		<span class="p">}</span>
		<span class="cm">/* point at bitrate info */</span>
		<span class="n">a_band</span><span class="o">-&gt;</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">ipw2200_a_rates</span><span class="p">;</span>
		<span class="n">a_band</span><span class="o">-&gt;</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ipw2200_num_a_rates</span><span class="p">;</span>

		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_band</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">cipher_suites</span> <span class="o">=</span> <span class="n">ipw_cipher_suites</span><span class="p">;</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_cipher_suites</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipw_cipher_suites</span><span class="p">);</span>

	<span class="n">set_wiphy_dev</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* With that information in place, we can now register the wiphy... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wiphy_register</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PCI driver stuff */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">card_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2701</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2702</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2711</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2712</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2721</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2722</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2731</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2732</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2741</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x103c</span><span class="p">,</span> <span class="mh">0x2741</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2742</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2751</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2752</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2753</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2754</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2761</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2762</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x104f</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x4220</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* BG */</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x4221</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* BG */</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x4223</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* ABG */</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x4224</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* ABG */</span>

	<span class="cm">/* required last entry */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">ipw_sysfs_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rf_kill</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_direct_dword</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_indirect_byte</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_indirect_dword</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_mem_gpio_reg</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_command_event_reg</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_nic_type</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_cfg</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_error</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_event_log</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_cmd_log</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_eeprom_delay</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ucode_version</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rtc</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_scan_age</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_led</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_speed_scan</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_net_stats</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_channels</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rtap_iface</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rtap_filter</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">ipw_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* put in device directory */</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ipw_sysfs_entries</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_prom_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_prom_priv</span> <span class="o">*</span><span class="n">prom_priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">prom_priv</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;prom dev-&gt;open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_all_data_frames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_non_directed_frames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_all_mgmt_bcpr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_all_mgmt_frames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ipw_send_system_config</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_prom_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_prom_priv</span> <span class="o">*</span><span class="n">prom_priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">prom_priv</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;prom dev-&gt;stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_all_data_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_non_directed_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_all_mgmt_bcpr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_config</span><span class="p">.</span><span class="n">accept_all_mgmt_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ipw_send_system_config</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">ipw_prom_hard_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;prom dev-&gt;xmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ipw_prom_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> 		<span class="o">=</span> <span class="n">ipw_prom_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ipw_prom_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ipw_prom_hard_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">libipw_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_prom_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span> <span class="o">=</span> <span class="n">alloc_libipw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_prom_priv</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_priv</span><span class="o">-&gt;</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_priv</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rtap%d&quot;</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_IEEE80211_RADIOTAP</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipw_prom_netdev_ops</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_MONITOR</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_libipw</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_prom_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">);</span>
	<span class="n">free_libipw</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prom_net_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ipw_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ipw_net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ipw_net_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">ipw_net_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">ipw_net_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">libipw_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">libipw_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ipw_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">net_dev</span> <span class="o">=</span> <span class="n">alloc_libipw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_priv</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">net_dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">ipw_debug_level</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPW_IBSS_MAC_HASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibss_mac_hash</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_libipw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: No suitable DMA available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_pci_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_pci_disable_device</span><span class="p">;</span>

	<span class="cm">/* We disable the RETRY_TIMEOUT register (0x41) to keep</span>
<span class="cm">	 * PCI Tx retries from interfering with C3 CPU state */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff00ff</span><span class="p">);</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_pci_release_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;pci_resource_len = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;pci_resource_base = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_setup_deferred_work</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to setup deferred work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipw_sw_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ipw_isr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Error allocating IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hard_start_xmit</span> <span class="o">=</span> <span class="n">ipw_net_hard_start_xmit</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span> <span class="o">=</span> <span class="n">shim__set_security</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_queue_full</span> <span class="o">=</span> <span class="n">ipw_net_is_queue_full</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPW2200_QOS</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_qos_active</span> <span class="o">=</span> <span class="n">ipw_is_qos_active</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">handle_probe_response</span> <span class="o">=</span> <span class="n">ipw_handle_beacon</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">handle_beacon</span> <span class="o">=</span> <span class="n">ipw_handle_probe_response</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">handle_assoc_response</span> <span class="o">=</span> <span class="n">ipw_handle_assoc_response</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_QOS */</span><span class="cp"></span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">perfect_rssi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">20</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">worst_rssi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">85</span><span class="p">;</span>

	<span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipw_netdev_ops</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">.</span><span class="n">spy_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">;</span>
	<span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">wireless_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">;</span>
	<span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipw_wx_handler_def</span><span class="p">;</span>
	<span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipw_ethtool_ops</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;failed to create sysfs device attributes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_up</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_remove_sysfs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw_wdev_init</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;failed to register wireless device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_remove_sysfs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;failed to register network device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unregister_wiphy</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtap_iface</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">err</span> <span class="o">=</span> <span class="n">ipw_prom_alloc</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to register promiscuous network &quot;</span>
				  <span class="s">&quot;device (error %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_unregister_wiphy</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: Detected geography %s (%d 802.11bg &quot;</span>
	       <span class="s">&quot;channels, %d 802.11a channels)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">bg_channels</span><span class="p">,</span>
	       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">a_channels</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">out_unregister_wiphy:</span>
	<span class="n">wiphy_unregister</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">a_band</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bg_band</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
      <span class="nl">out_remove_sysfs:</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw_attribute_group</span><span class="p">);</span>
      <span class="nl">out_release_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
      <span class="nl">out_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_base</span><span class="p">);</span>
      <span class="nl">out_pci_release_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
      <span class="nl">out_pci_disable_device:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="nl">out_free_libipw:</span>
	<span class="n">free_libipw</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">ipw_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_EXIT_PENDING</span><span class="p">;</span>
	<span class="n">ipw_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw_attribute_group</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipw_rx_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ipw_tx_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdlog</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure all works are inactive */</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_check</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">associate</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">disassociate</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">system_config</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_replenish</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_restart</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_scan</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_direct_scan</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">request_passive_scan</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gather_stats</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">abort_scan</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">roam</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_check</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_down</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_link_on</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_link_off</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_act_off</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">merge_networks</span><span class="p">);</span>

	<span class="cm">/* Free MAC hash list for ADHOC */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPW_IBSS_MAC_HASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibss_mac_hash</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw_ibss_seq</span><span class="p">,</span> <span class="n">list</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
	<span class="n">ipw_prom_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_base</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* wiphy_unregister needs to be here, before free_libipw */</span>
	<span class="n">wiphy_unregister</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">a_band</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bg_band</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">free_libipw</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">free_firmware</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_pci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Going into suspend...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Take down the device; powers it off, etc. */</span>
	<span class="n">ipw_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Remove the PRESENT state of the device */</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">suspend_at</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Coming out of suspend...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: pci_enable_device failed on resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Suspend/Resume resets the PCI configuration space, so we have to</span>
<span class="cm">	 * re-disable the RETRY_TIMEOUT register (0x41) to keep PCI Tx retries</span>
<span class="cm">	 * from interfering with C3 CPU state. pci_restore_state won&#39;t help</span>
<span class="cm">	 * here since it only restores the first 64 bytes pci config header.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff00ff</span><span class="p">);</span>

	<span class="cm">/* Set the device back into the PRESENT state; this will also wake</span>
<span class="cm">	 * the queue of needed */</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">suspend_time</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">suspend_at</span><span class="p">;</span>

	<span class="cm">/* Bring the device back up */</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_pci_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Take down the device; powers it off, etc. */</span>
	<span class="n">ipw_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* driver initialization stuff */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">ipw_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">card_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ipw_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ipw_pci_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ipw_pci_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ipw_pci_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">ipw_pci_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ipw_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: &quot;</span> <span class="n">DRV_DESCRIPTION</span> <span class="s">&quot;, &quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: &quot;</span> <span class="n">DRV_COPYRIGHT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipw_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to initialize PCI module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipw_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_debug_level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to create driver sysfs file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipw_driver</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ipw_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipw_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_debug_level</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipw_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">disable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable</span><span class="p">,</span> <span class="s">&quot;manually disable the radio (default 0 [radio on])&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">associate</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">associate</span><span class="p">,</span> <span class="s">&quot;auto associate when scanning (default off)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">auto_create</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">auto_create</span><span class="p">,</span> <span class="s">&quot;auto create adhoc network (default on)&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">led_support</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="s">&quot;enable led control on some systems (default 1 on)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;debug output mask&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">default_channel</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="s">&quot;channel to limit associate to (default 0 [ANY])&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPW2200_PROMISCUOUS</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rtap_iface</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rtap_iface</span><span class="p">,</span> <span class="s">&quot;create the rtap interface (1 - create, default 0)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_IPW2200_QOS</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">qos_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qos_enable</span><span class="p">,</span> <span class="s">&quot;enable all QoS functionalitis&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">qos_burst_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qos_burst_enable</span><span class="p">,</span> <span class="s">&quot;enable QoS burst mode&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">qos_no_ack_mask</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qos_no_ack_mask</span><span class="p">,</span> <span class="s">&quot;mask Tx_Queue to no ack&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">burst_duration_CCK</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">burst_duration_CCK</span><span class="p">,</span> <span class="s">&quot;set CCK burst value&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">burst_duration_OFDM</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">burst_duration_OFDM</span><span class="p">,</span> <span class="s">&quot;set OFDM burst value&quot;</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2200_QOS */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_IPW2200_MONITOR</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">network_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;network mode (0=BSS,1=IBSS,2=Monitor)&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">network_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;network mode (0=BSS,1=IBSS)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">bt_coexist</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bt_coexist</span><span class="p">,</span> <span class="s">&quot;enable bluetooth coexistence (default off)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">hwcrypto</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hwcrypto</span><span class="p">,</span> <span class="s">&quot;enable hardware crypto (default off)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">cmdlog</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cmdlog</span><span class="p">,</span>
		 <span class="s">&quot;allocate a ring buffer for logging firmware commands&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">roaming</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">roaming</span><span class="p">,</span> <span class="s">&quot;enable roaming support (default on)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">antenna</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">antenna</span><span class="p">,</span> <span class="s">&quot;select antenna 1=Main, 3=Aux, default 0 [both], 2=slow_diversity (choose the one with lower background noise)&quot;</span><span class="p">);</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">ipw_exit</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">ipw_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
