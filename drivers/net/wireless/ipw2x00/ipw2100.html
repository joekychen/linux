<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ipw2x00 › ipw2100.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ipw2100.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>

<span class="cm">  Copyright(c) 2003 - 2006 Intel Corporation. All rights reserved.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms of version 2 of the GNU General Public License as</span>
<span class="cm">  published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc., 59</span>
<span class="cm">  Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in the</span>
<span class="cm">  file called LICENSE.</span>

<span class="cm">  Contact Information:</span>
<span class="cm">  Intel Linux Wireless &lt;ilw@linux.intel.com&gt;</span>
<span class="cm">  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>

<span class="cm">  Portions of this file are based on the sample_* files provided by Wireless</span>
<span class="cm">  Extensions 0.26 package and copyright (c) 1997-2003 Jean Tourrilhes</span>
<span class="cm">  &lt;jt@hpl.hp.com&gt;</span>

<span class="cm">  Portions of this file are based on the Host AP project,</span>
<span class="cm">  Copyright (c) 2001-2002, SSH Communications Security Corp and Jouni Malinen</span>
<span class="cm">    &lt;j@w1.fi&gt;</span>
<span class="cm">  Copyright (c) 2002-2003, Jouni Malinen &lt;j@w1.fi&gt;</span>

<span class="cm">  Portions of ipw2100_mod_firmware_load, ipw2100_do_mod_firmware_load, and</span>
<span class="cm">  ipw2100_fw_load are loosely based on drivers/sound/sound_firmware.c</span>
<span class="cm">  available in the 2.4.25 kernel sources, and are copyright (c) Alan Cox</span>

<span class="cm">******************************************************************************/</span>
<span class="cm">/*</span>

<span class="cm"> Initial driver on which this is based was developed by Janusz Gorycki,</span>
<span class="cm"> Maciej Urbaniak, and Maciej Sosnowski.</span>

<span class="cm"> Promiscuous mode support added by Jacek Wysoczynski and Maciej Urbaniak.</span>

<span class="cm">Theory of Operation</span>

<span class="cm">Tx - Commands and Data</span>

<span class="cm">Firmware and host share a circular queue of Transmit Buffer Descriptors (TBDs)</span>
<span class="cm">Each TBD contains a pointer to the physical (dma_addr_t) address of data being</span>
<span class="cm">sent to the firmware as well as the length of the data.</span>

<span class="cm">The host writes to the TBD queue at the WRITE index.  The WRITE index points</span>
<span class="cm">to the _next_ packet to be written and is advanced when after the TBD has been</span>
<span class="cm">filled.</span>

<span class="cm">The firmware pulls from the TBD queue at the READ index.  The READ index points</span>
<span class="cm">to the currently being read entry, and is advanced once the firmware is</span>
<span class="cm">done with a packet.</span>

<span class="cm">When data is sent to the firmware, the first TBD is used to indicate to the</span>
<span class="cm">firmware if a Command or Data is being sent.  If it is Command, all of the</span>
<span class="cm">command information is contained within the physical address referred to by the</span>
<span class="cm">TBD.  If it is Data, the first TBD indicates the type of data packet, number</span>
<span class="cm">of fragments, etc.  The next TBD then refers to the actual packet location.</span>

<span class="cm">The Tx flow cycle is as follows:</span>

<span class="cm">1) ipw2100_tx() is called by kernel with SKB to transmit</span>
<span class="cm">2) Packet is move from the tx_free_list and appended to the transmit pending</span>
<span class="cm">   list (tx_pend_list)</span>
<span class="cm">3) work is scheduled to move pending packets into the shared circular queue.</span>
<span class="cm">4) when placing packet in the circular queue, the incoming SKB is DMA mapped</span>
<span class="cm">   to a physical address.  That address is entered into a TBD.  Two TBDs are</span>
<span class="cm">   filled out.  The first indicating a data packet, the second referring to the</span>
<span class="cm">   actual payload data.</span>
<span class="cm">5) the packet is removed from tx_pend_list and placed on the end of the</span>
<span class="cm">   firmware pending list (fw_pend_list)</span>
<span class="cm">6) firmware is notified that the WRITE index has</span>
<span class="cm">7) Once the firmware has processed the TBD, INTA is triggered.</span>
<span class="cm">8) For each Tx interrupt received from the firmware, the READ index is checked</span>
<span class="cm">   to see which TBDs are done being processed.</span>
<span class="cm">9) For each TBD that has been processed, the ISR pulls the oldest packet</span>
<span class="cm">   from the fw_pend_list.</span>
<span class="cm">10)The packet structure contained in the fw_pend_list is then used</span>
<span class="cm">   to unmap the DMA address and to free the SKB originally passed to the driver</span>
<span class="cm">   from the kernel.</span>
<span class="cm">11)The packet structure is placed onto the tx_free_list</span>

<span class="cm">The above steps are the same for commands, only the msg_free_list/msg_pend_list</span>
<span class="cm">are used instead of tx_free_list/tx_pend_list</span>

<span class="cm">...</span>

<span class="cm">Critical Sections / Locking :</span>

<span class="cm">There are two locks utilized.  The first is the low level lock (priv-&gt;low_lock)</span>
<span class="cm">that protects the following:</span>

<span class="cm">- Access to the Tx/Rx queue lists via priv-&gt;low_lock. The lists are as follows:</span>

<span class="cm">  tx_free_list : Holds pre-allocated Tx buffers.</span>
<span class="cm">    TAIL modified in __ipw2100_tx_process()</span>
<span class="cm">    HEAD modified in ipw2100_tx()</span>

<span class="cm">  tx_pend_list : Holds used Tx buffers waiting to go into the TBD ring</span>
<span class="cm">    TAIL modified ipw2100_tx()</span>
<span class="cm">    HEAD modified by ipw2100_tx_send_data()</span>

<span class="cm">  msg_free_list : Holds pre-allocated Msg (Command) buffers</span>
<span class="cm">    TAIL modified in __ipw2100_tx_process()</span>
<span class="cm">    HEAD modified in ipw2100_hw_send_command()</span>

<span class="cm">  msg_pend_list : Holds used Msg buffers waiting to go into the TBD ring</span>
<span class="cm">    TAIL modified in ipw2100_hw_send_command()</span>
<span class="cm">    HEAD modified in ipw2100_tx_send_commands()</span>

<span class="cm">  The flow of data on the TX side is as follows:</span>

<span class="cm">  MSG_FREE_LIST + COMMAND =&gt; MSG_PEND_LIST =&gt; TBD =&gt; MSG_FREE_LIST</span>
<span class="cm">  TX_FREE_LIST + DATA =&gt; TX_PEND_LIST =&gt; TBD =&gt; TX_FREE_LIST</span>

<span class="cm">  The methods that work on the TBD ring are protected via priv-&gt;low_lock.</span>

<span class="cm">- The internal data state of the device itself</span>
<span class="cm">- Access to the firmware read/write indexes for the BD queues</span>
<span class="cm">  and associated logic</span>

<span class="cm">All external entry functions are locked with the priv-&gt;action_lock to ensure</span>
<span class="cm">that only one external action is invoked at a time.</span>


<span class="cm">*/</span>

<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/stringify.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/pm_qos.h&gt;</span>

<span class="cp">#include &lt;net/lib80211.h&gt;</span>

<span class="cp">#include &quot;ipw2100.h&quot;</span>
<span class="cp">#include &quot;ipw.h&quot;</span>

<span class="cp">#define IPW2100_VERSION &quot;git-1.2.2&quot;</span>

<span class="cp">#define DRV_NAME	&quot;ipw2100&quot;</span>
<span class="cp">#define DRV_VERSION	IPW2100_VERSION</span>
<span class="cp">#define DRV_DESCRIPTION	&quot;Intel(R) PRO/Wireless 2100 Network Driver&quot;</span>
<span class="cp">#define DRV_COPYRIGHT	&quot;Copyright(c) 2003-2006 Intel Corporation&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pm_qos_request</span> <span class="n">ipw2100_pm_qos_req</span><span class="p">;</span>

<span class="cm">/* Debugging stuff */</span>
<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
<span class="cp">#define IPW2100_RX_DEBUG	</span><span class="cm">/* Reception debugging */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRV_COPYRIGHT</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">network_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">associate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ipw2100_fw</span> <span class="n">ipw2100_firmware</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">network_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">associate</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;debug level&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;network mode (0=BSS,1=IBSS,2=Monitor)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="s">&quot;channel&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">associate</span><span class="p">,</span> <span class="s">&quot;auto associate when scanning (default off)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable</span><span class="p">,</span> <span class="s">&quot;manually disable the radio (default 0 [radio on])&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">ipw2100_debug_level</span> <span class="o">=</span> <span class="n">IPW_DL_NONE</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
<span class="cp">#define IPW_DEBUG(level, message...) \</span>
<span class="cp">do { \</span>
<span class="cp">	if (ipw2100_debug_level &amp; (level)) { \</span>
<span class="cp">		printk(KERN_DEBUG &quot;ipw2100: %c %s &quot;, \</span>
<span class="cp">                       in_interrupt() ? &#39;I&#39; : &#39;U&#39;,  __func__); \</span>
<span class="cp">		printk(message); \</span>
<span class="cp">	} \</span>
<span class="cp">} while (0)</span>
<span class="cp">#else</span>
<span class="cp">#define IPW_DEBUG(level, message...) do {} while (0)</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2100_DEBUG */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;unused&quot;</span><span class="p">,</span>		<span class="cm">/* HOST_ATTENTION */</span>
	<span class="s">&quot;HOST_COMPLETE&quot;</span><span class="p">,</span>
	<span class="s">&quot;unused&quot;</span><span class="p">,</span>		<span class="cm">/* SLEEP */</span>
	<span class="s">&quot;unused&quot;</span><span class="p">,</span>		<span class="cm">/* HOST_POWER_DOWN */</span>
	<span class="s">&quot;unused&quot;</span><span class="p">,</span>
	<span class="s">&quot;SYSTEM_CONFIG&quot;</span><span class="p">,</span>
	<span class="s">&quot;unused&quot;</span><span class="p">,</span>		<span class="cm">/* SET_IMR */</span>
	<span class="s">&quot;SSID&quot;</span><span class="p">,</span>
	<span class="s">&quot;MANDATORY_BSSID&quot;</span><span class="p">,</span>
	<span class="s">&quot;AUTHENTICATION_TYPE&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAPTER_ADDRESS&quot;</span><span class="p">,</span>
	<span class="s">&quot;PORT_TYPE&quot;</span><span class="p">,</span>
	<span class="s">&quot;INTERNATIONAL_MODE&quot;</span><span class="p">,</span>
	<span class="s">&quot;CHANNEL&quot;</span><span class="p">,</span>
	<span class="s">&quot;RTS_THRESHOLD&quot;</span><span class="p">,</span>
	<span class="s">&quot;FRAG_THRESHOLD&quot;</span><span class="p">,</span>
	<span class="s">&quot;POWER_MODE&quot;</span><span class="p">,</span>
	<span class="s">&quot;TX_RATES&quot;</span><span class="p">,</span>
	<span class="s">&quot;BASIC_TX_RATES&quot;</span><span class="p">,</span>
	<span class="s">&quot;WEP_KEY_INFO&quot;</span><span class="p">,</span>
	<span class="s">&quot;unused&quot;</span><span class="p">,</span>
	<span class="s">&quot;unused&quot;</span><span class="p">,</span>
	<span class="s">&quot;unused&quot;</span><span class="p">,</span>
	<span class="s">&quot;unused&quot;</span><span class="p">,</span>
	<span class="s">&quot;WEP_KEY_INDEX&quot;</span><span class="p">,</span>
	<span class="s">&quot;WEP_FLAGS&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADD_MULTICAST&quot;</span><span class="p">,</span>
	<span class="s">&quot;CLEAR_ALL_MULTICAST&quot;</span><span class="p">,</span>
	<span class="s">&quot;BEACON_INTERVAL&quot;</span><span class="p">,</span>
	<span class="s">&quot;ATIM_WINDOW&quot;</span><span class="p">,</span>
	<span class="s">&quot;CLEAR_STATISTICS&quot;</span><span class="p">,</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;TX_POWER_INDEX&quot;</span><span class="p">,</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;BROADCAST_SCAN&quot;</span><span class="p">,</span>
	<span class="s">&quot;CARD_DISABLE&quot;</span><span class="p">,</span>
	<span class="s">&quot;PREFERRED_BSSID&quot;</span><span class="p">,</span>
	<span class="s">&quot;SET_SCAN_OPTIONS&quot;</span><span class="p">,</span>
	<span class="s">&quot;SCAN_DWELL_TIME&quot;</span><span class="p">,</span>
	<span class="s">&quot;SWEEP_TABLE&quot;</span><span class="p">,</span>
	<span class="s">&quot;AP_OR_STATION_TABLE&quot;</span><span class="p">,</span>
	<span class="s">&quot;GROUP_ORDINALS&quot;</span><span class="p">,</span>
	<span class="s">&quot;SHORT_RETRY_LIMIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;LONG_RETRY_LIMIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;unused&quot;</span><span class="p">,</span>		<span class="cm">/* SAVE_CALIBRATION */</span>
	<span class="s">&quot;unused&quot;</span><span class="p">,</span>		<span class="cm">/* RESTORE_CALIBRATION */</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;HOST_PRE_POWER_DOWN&quot;</span><span class="p">,</span>
	<span class="s">&quot;unused&quot;</span><span class="p">,</span>		<span class="cm">/* HOST_INTERRUPT_COALESCING */</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;CARD_DISABLE_PHY_OFF&quot;</span><span class="p">,</span>
	<span class="s">&quot;MSDU_TX_RATES&quot;</span><span class="p">,</span>
	<span class="s">&quot;undefined&quot;</span><span class="p">,</span>
	<span class="s">&quot;SET_STATION_STAT_BITS&quot;</span><span class="p">,</span>
	<span class="s">&quot;CLEAR_STATIONS_STAT_BITS&quot;</span><span class="p">,</span>
	<span class="s">&quot;LEAP_ROGUE_MODE&quot;</span><span class="p">,</span>
	<span class="s">&quot;SET_SECURITY_INFORMATION&quot;</span><span class="p">,</span>
	<span class="s">&quot;DISASSOCIATION_BSSID&quot;</span><span class="p">,</span>
	<span class="s">&quot;SET_WPA_ASS_IE&quot;</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">ipw2100_frequencies</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2412</span><span class="p">,</span> <span class="mi">2417</span><span class="p">,</span> <span class="mi">2422</span><span class="p">,</span> <span class="mi">2427</span><span class="p">,</span>
	<span class="mi">2432</span><span class="p">,</span> <span class="mi">2437</span><span class="p">,</span> <span class="mi">2442</span><span class="p">,</span> <span class="mi">2447</span><span class="p">,</span>
	<span class="mi">2452</span><span class="p">,</span> <span class="mi">2457</span><span class="p">,</span> <span class="mi">2462</span><span class="p">,</span> <span class="mi">2467</span><span class="p">,</span>
	<span class="mi">2472</span><span class="p">,</span> <span class="mi">2484</span>
<span class="p">};</span>

<span class="cp">#define FREQ_COUNT	ARRAY_SIZE(ipw2100_frequencies)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">ipw2100_bg_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define RATE_COUNT ARRAY_SIZE(ipw2100_bg_rates)</span>

<span class="cm">/* Pre-decl until we get the code solid and then we can clean it up */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw2100_tx_send_commands</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw2100_tx_send_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw2100_adapter_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw2100_queues_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw2100_queues_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw2100_queues_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw2100_fw_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ipw2100_fw</span> <span class="o">*</span><span class="n">fw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw2100_get_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipw2100_fw</span> <span class="o">*</span><span class="n">fw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw2100_get_fwversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">max</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw2100_get_ucodeversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">max</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw2100_release_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ipw2100_fw</span> <span class="o">*</span><span class="n">fw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw2100_ucode_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ipw2100_fw</span> <span class="o">*</span><span class="n">fw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw2100_wx_event_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">ipw2100_wx_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="n">ipw2100_wx_handler_def</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">read_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot;r: 0x%08X =&gt; 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot;w: 0x%08X &lt;= 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">read_register_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot;r: 0x%08X =&gt; %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">read_register_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot;r: 0x%08X =&gt; %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_register_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">iowrite16</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot;w: 0x%08X &lt;= %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_register_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">iowrite8</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_IO</span><span class="p">(</span><span class="s">&quot;w: 0x%08X =&lt; %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">read_nic_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_ADDRESS</span><span class="p">,</span>
		       <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">IPW_REG_INDIRECT_ADDR_MASK</span><span class="p">);</span>
	<span class="n">read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_nic_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_ADDRESS</span><span class="p">,</span>
		       <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">IPW_REG_INDIRECT_ADDR_MASK</span><span class="p">);</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">read_nic_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_ADDRESS</span><span class="p">,</span>
		       <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">IPW_REG_INDIRECT_ADDR_MASK</span><span class="p">);</span>
	<span class="n">read_register_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_nic_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_ADDRESS</span><span class="p">,</span>
		       <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">IPW_REG_INDIRECT_ADDR_MASK</span><span class="p">);</span>
	<span class="n">write_register_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">read_nic_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_ADDRESS</span><span class="p">,</span>
		       <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">IPW_REG_INDIRECT_ADDR_MASK</span><span class="p">);</span>
	<span class="n">read_register_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_nic_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_ADDRESS</span><span class="p">,</span>
		       <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">IPW_REG_INDIRECT_ADDR_MASK</span><span class="p">);</span>
	<span class="n">write_register_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_nic_auto_inc_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_AUTOINCREMENT_ADDRESS</span><span class="p">,</span>
		       <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">IPW_REG_INDIRECT_ADDR_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_nic_dword_auto_inc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_AUTOINCREMENT_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_nic_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span>
				    <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">aligned_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aligned_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dif_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* read first nibble byte by byte */</span>
	<span class="n">aligned_addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x3</span><span class="p">);</span>
	<span class="n">dif_len</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">aligned_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dif_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Start reading at aligned_addr + dif_len */</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_ADDRESS</span><span class="p">,</span>
			       <span class="n">aligned_addr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dif_len</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">buf</span><span class="o">++</span><span class="p">)</span>
			<span class="n">write_register_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">IPW_REG_INDIRECT_ACCESS_DATA</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
					    <span class="o">*</span><span class="n">buf</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">dif_len</span><span class="p">;</span>
		<span class="n">aligned_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read DWs through autoincrement registers */</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_AUTOINCREMENT_ADDRESS</span><span class="p">,</span> <span class="n">aligned_addr</span><span class="p">);</span>
	<span class="n">aligned_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x3</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">aligned_len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">aligned_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_AUTOINCREMENT_DATA</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* copy the last nibble */</span>
	<span class="n">dif_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">aligned_len</span><span class="p">;</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_ADDRESS</span><span class="p">,</span> <span class="n">aligned_addr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dif_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">buf</span><span class="o">++</span><span class="p">)</span>
		<span class="n">write_register_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_DATA</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				    <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_nic_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">aligned_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aligned_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dif_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* read first nibble byte by byte */</span>
	<span class="n">aligned_addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x3</span><span class="p">);</span>
	<span class="n">dif_len</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">aligned_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dif_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Start reading at aligned_addr + dif_len */</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_ADDRESS</span><span class="p">,</span>
			       <span class="n">aligned_addr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dif_len</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">buf</span><span class="o">++</span><span class="p">)</span>
			<span class="n">read_register_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">IPW_REG_INDIRECT_ACCESS_DATA</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
					   <span class="n">buf</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">dif_len</span><span class="p">;</span>
		<span class="n">aligned_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read DWs through autoincrement registers */</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_AUTOINCREMENT_ADDRESS</span><span class="p">,</span> <span class="n">aligned_addr</span><span class="p">);</span>
	<span class="n">aligned_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x3</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">aligned_len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">aligned_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_AUTOINCREMENT_DATA</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* copy the last nibble */</span>
	<span class="n">dif_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">aligned_len</span><span class="p">;</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_ADDRESS</span><span class="p">,</span> <span class="n">aligned_addr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dif_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">buf</span><span class="o">++</span><span class="p">)</span>
		<span class="n">read_register_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INDIRECT_ACCESS_DATA</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ipw2100_hw_is_adapter_in_system</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dbg</span><span class="p">;</span>

	<span class="n">read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_DOA_DEBUG_AREA_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dbg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dbg</span> <span class="o">==</span> <span class="n">IPW_DATA_DOA_DEBUG_VALUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_get_ordinal</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ord</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_ordinals</span> <span class="o">*</span><span class="n">ordinals</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ordinals</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">field_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">field_len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">field_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">total_length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ordinals</span><span class="o">-&gt;</span><span class="n">table1_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: attempt to use fw ordinals &quot;</span>
		       <span class="s">&quot;before they have been loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ORDINAL_TABLE_ONE</span><span class="p">(</span><span class="n">ordinals</span><span class="p">,</span> <span class="n">ord</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IPW_ORD_TAB_1_ENTRY_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">IPW_ORD_TAB_1_ENTRY_SIZE</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
			       <span class="s">&quot;: ordinal buffer length too small, need %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">IPW_ORD_TAB_1_ENTRY_SIZE</span><span class="p">);</span>

			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span>
			       <span class="n">ordinals</span><span class="o">-&gt;</span><span class="n">table1_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ord</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">IPW_ORD_TAB_1_ENTRY_SIZE</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ORDINAL_TABLE_TWO</span><span class="p">(</span><span class="n">ordinals</span><span class="p">,</span> <span class="n">ord</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">ord</span> <span class="o">-=</span> <span class="n">IPW_START_ORD_TAB_2</span><span class="p">;</span>

		<span class="cm">/* get the address of statistic */</span>
		<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span>
			       <span class="n">ordinals</span><span class="o">-&gt;</span><span class="n">table2_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ord</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>

		<span class="cm">/* get the second DW of statistics ;</span>
<span class="cm">		 * two 16-bit words - first is length, second is count */</span>
		<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span>
			       <span class="n">ordinals</span><span class="o">-&gt;</span><span class="n">table2_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ord</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
			       <span class="o">&amp;</span><span class="n">field_info</span><span class="p">);</span>

		<span class="cm">/* get each entry length */</span>
		<span class="n">field_len</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">field_info</span><span class="p">);</span>

		<span class="cm">/* get number of entries */</span>
		<span class="n">field_count</span> <span class="o">=</span> <span class="o">*</span><span class="p">(((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">field_info</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* abort if no enough memory */</span>
		<span class="n">total_length</span> <span class="o">=</span> <span class="n">field_len</span> <span class="o">*</span> <span class="n">field_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total_length</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">total_length</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">total_length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">total_length</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* read the ordinal data from the SRAM */</span>
		<span class="n">read_nic_memory</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">total_length</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: ordinal %d neither in table 1 nor &quot;</span>
	       <span class="s">&quot;in table 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ord</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_ordinal</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ord</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">val</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="o">*</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_ordinals</span> <span class="o">*</span><span class="n">ordinals</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ordinals</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ORDINAL_TABLE_ONE</span><span class="p">(</span><span class="n">ordinals</span><span class="p">,</span> <span class="n">ord</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">!=</span> <span class="n">IPW_ORD_TAB_1_ENTRY_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">IPW_ORD_TAB_1_ENTRY_SIZE</span><span class="p">;</span>
			<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;wrong size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span>
			       <span class="n">ordinals</span><span class="o">-&gt;</span><span class="n">table1_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ord</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>

		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>

		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">IPW_ORD_TAB_1_ENTRY_SIZE</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;wrong table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ORDINAL_TABLE_TWO</span><span class="p">(</span><span class="n">ordinals</span><span class="p">,</span> <span class="n">ord</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">snprint_line</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">out</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">out</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;%08X&quot;</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span>
			<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot;%02X &quot;</span><span class="p">,</span>
					<span class="n">data</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">)]);</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot;   &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">)];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isascii</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">isprint</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
				<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>

			<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">out</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">out</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">printk_buf</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">81</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">ofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ipw2100_debug_level</span> <span class="o">&amp;</span> <span class="n">level</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">snprint_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">ofs</span><span class="p">],</span>
				    <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="mi">16U</span><span class="p">),</span> <span class="n">ofs</span><span class="p">));</span>
		<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="mi">16U</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define MAX_RESET_BACKOFF 10</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">schedule_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>

	<span class="cm">/* If we haven&#39;t received a reset request within the backoff period,</span>
<span class="cm">	 * then we can reset the backoff interval so this reset occurs</span>
<span class="cm">	 * immediately */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_backoff</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_backoff</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_backoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RESET_PENDING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Scheduling firmware restart (%ds).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_backoff</span><span class="p">);</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_RESET_PENDING</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_backoff</span><span class="p">)</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">,</span>
					      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_backoff</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_backoff</span> <span class="o">&lt;</span> <span class="n">MAX_RESET_BACKOFF</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_backoff</span><span class="o">++</span><span class="p">;</span>

		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Firmware restart already in progress.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="p">}</span>

<span class="cp">#define HOST_COMPLETE_TIMEOUT (2 * HZ)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_hw_send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">host_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_tx_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Sending %s command (#%d), %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">command_types</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command</span><span class="p">],</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command</span><span class="p">,</span>
		     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_length</span><span class="p">);</span>
	<span class="n">printk_buf</span><span class="p">(</span><span class="n">IPW_DL_HC</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_parameters</span><span class="p">,</span>
		   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_length</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span>
		    <span class="p">(</span><span class="s">&quot;Attempt to send command while hardware in fatal error condition.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RUNNING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span>
		    <span class="p">(</span><span class="s">&quot;Attempt to send command while hardware is not running.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_CMD_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span>
		    <span class="p">(</span><span class="s">&quot;Attempt to send command while another command is pending.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_free_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;no available msg buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_CMD_ACTIVE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">messages_sent</span><span class="o">++</span><span class="p">;</span>

	<span class="n">element</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_free_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>

	<span class="n">packet</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_tx_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">jiffy_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* initialize the firmware command packet */</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_reg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_reg1</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command1</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_len_reg</span> <span class="o">=</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_length</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_sequence</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_params_reg</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_parameters</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_params_reg</span><span class="p">));</span>

	<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
	<span class="n">DEC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_free_stat</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_pend_list</span><span class="p">);</span>
	<span class="n">INC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_pend_stat</span><span class="p">);</span>

	<span class="n">ipw2100_tx_send_commands</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw2100_tx_send_data</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must wait for this command to complete before another</span>
<span class="cm">	 * command can be sent...  but if we wait more than 3 seconds</span>
<span class="cm">	 * then there is a problem.</span>
<span class="cm">	 */</span>

	<span class="n">err</span> <span class="o">=</span>
	    <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">,</span>
					     <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span>
					       <span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_CMD_ACTIVE</span><span class="p">),</span>
					     <span class="n">HOST_COMPLETE_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Command completion failed out after %dms.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="n">HOST_COMPLETE_TIMEOUT</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">));</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span> <span class="o">=</span> <span class="n">IPW2100_ERR_MSG_TIMEOUT</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_CMD_ACTIVE</span><span class="p">;</span>
		<span class="n">schedule_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s: firmware fatal error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* !!!!! HACK TEST !!!!!</span>
<span class="cm">	 * When lots of debug trace statements are enabled, the driver</span>
<span class="cm">	 * doesn&#39;t seem to have as many firmware restart cycles...</span>
<span class="cm">	 *</span>
<span class="cm">	 * As a test, we&#39;re sticking in a 1/100s delay here */</span>
	<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">fail_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Verify the values and data access of the hardware</span>
<span class="cm"> * No locks needed or used.  No functions called.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">val1</span> <span class="o">=</span> <span class="mh">0x76543210</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val2</span> <span class="o">=</span> <span class="mh">0xFEDCBA98</span><span class="p">;</span>

	<span class="cm">/* Domain 0 check - all values should be DOA_DEBUG */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">address</span> <span class="o">=</span> <span class="n">IPW_REG_DOA_DEBUG_AREA_START</span><span class="p">;</span>
	     <span class="n">address</span> <span class="o">&lt;</span> <span class="n">IPW_REG_DOA_DEBUG_AREA_END</span><span class="p">;</span> <span class="n">address</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data1</span> <span class="o">!=</span> <span class="n">IPW_DATA_DOA_DEBUG_VALUE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Domain 1 check - use arbitrary read/write compare  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">address</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The memory area is not used now */</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_DOMAIN_1_OFFSET</span> <span class="o">+</span> <span class="mh">0x32</span><span class="p">,</span>
			       <span class="n">val1</span><span class="p">);</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_DOMAIN_1_OFFSET</span> <span class="o">+</span> <span class="mh">0x36</span><span class="p">,</span>
			       <span class="n">val2</span><span class="p">);</span>
		<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_DOMAIN_1_OFFSET</span> <span class="o">+</span> <span class="mh">0x32</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data1</span><span class="p">);</span>
		<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_DOMAIN_1_OFFSET</span> <span class="o">+</span> <span class="mh">0x36</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val1</span> <span class="o">==</span> <span class="n">data1</span> <span class="o">&amp;&amp;</span> <span class="n">val2</span> <span class="o">==</span> <span class="n">data2</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Loop until the CARD_DISABLED bit is the same value as the</span>
<span class="cm"> * supplied parameter</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: See if it would be more efficient to do a wait/wake</span>
<span class="cm"> *       cycle and have the completion event trigger the wakeup</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#define IPW_CARD_DISABLE_COMPLETE_WAIT		    100	</span><span class="c1">// 100 milli</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wait_for_card_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">card_state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card_state</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">IPW_CARD_DISABLE_COMPLETE_WAIT</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_CARD_DISABLED</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">card_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Query of CARD_DISABLED ordinal &quot;</span>
				       <span class="s">&quot;failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* We&#39;ll break out if either the HW state says it is</span>
<span class="cm">		 * in the state we want, or if HOST_COMPLETE command</span>
<span class="cm">		 * finishes */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">card_state</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ENABLED</span><span class="p">)</span> <span class="o">?</span>
		     <span class="n">IPW_HW_STATE_ENABLED</span> <span class="o">:</span> <span class="n">IPW_HW_STATE_DISABLED</span><span class="p">)</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">IPW_HW_STATE_ENABLED</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_ENABLED</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_ENABLED</span><span class="p">;</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;ipw2100_wait_for_card_state to %s state timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">state</span> <span class="o">?</span> <span class="s">&quot;DISABLED&quot;</span> <span class="o">:</span> <span class="s">&quot;ENABLED&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*********************************************************************</span>
<span class="cm">    Procedure   :   sw_reset_and_clock</span>
<span class="cm">    Purpose     :   Asserts s/w reset, asserts clock initialization</span>
<span class="cm">                    and waits for clock stabilization</span>
<span class="cm"> ********************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sw_reset_and_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>assert s/w reset</p></td><td class="code"><div class="highlight"><pre>	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_RESET_REG</span><span class="p">,</span>
		       <span class="n">IPW_AUX_HOST_RESET_REG_SW_RESET</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>wait for clock stabilization</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">IPW_WAIT_RESET_ARC_COMPLETE_DELAY</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>check clock ready bit</p></td><td class="code"><div class="highlight"><pre>		<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_RESET_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">IPW_AUX_HOST_RESET_REG_PRINCETON_RESET</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="c1">// TODO: better error value</span>

	<span class="cm">/* set &quot;initialization complete&quot; bit to move adapter to</span>
<span class="cm">	 * D0 state */</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_GP_CNTRL</span><span class="p">,</span>
		       <span class="n">IPW_AUX_HOST_GP_CNTRL_BIT_INIT_DONE</span><span class="p">);</span>

	<span class="cm">/* wait for clock stabilization */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">IPW_WAIT_CLOCK_STABILIZATION_DELAY</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

		<span class="cm">/* check clock ready bit */</span>
		<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_GP_CNTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">IPW_AUX_HOST_GP_CNTRL_BIT_CLOCK_READY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">10000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* TODO: better error value */</span>

	<span class="cm">/* set D0 standby bit */</span>
	<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_GP_CNTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_GP_CNTRL</span><span class="p">,</span>
		       <span class="n">r</span> <span class="o">|</span> <span class="n">IPW_AUX_HOST_GP_CNTRL_BIT_HOST_ALLOWS_STANDBY</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*********************************************************************</span>
<span class="cm">    Procedure   :   ipw2100_download_firmware</span>
<span class="cm">    Purpose     :   Initiaze adapter after power on.</span>
<span class="cm">                    The sequence is:</span>
<span class="cm">                    1. assert s/w reset first!</span>
<span class="cm">                    2. awake clocks &amp; wait for clock stabilization</span>
<span class="cm">                    3. hold ARC (don&#39;t ask me why...)</span>
<span class="cm">                    4. load Dino ucode and reset/clock init again</span>
<span class="cm">                    5. zero-out shared mem</span>
<span class="cm">                    6. download f/w</span>
<span class="cm"> *******************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_download_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_PM</span>
	<span class="cm">/* Fetch the firmware and microcode */</span>
	<span class="k">struct</span> <span class="n">ipw2100_fw</span> <span class="n">ipw2100_firmware</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ERROR</span><span class="p">(</span><span class="s">&quot;%s: ipw2100_download_firmware called after &quot;</span>
				<span class="s">&quot;fatal error %d.  Interface must be brought down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw2100_firmware</span><span class="p">.</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_get_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw2100_firmware</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_ERROR</span><span class="p">(</span><span class="s">&quot;%s: ipw2100_get_firmware failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span> <span class="o">=</span> <span class="n">IPW2100_ERR_FW_LOAD</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_get_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw2100_firmware</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ERROR</span><span class="p">(</span><span class="s">&quot;%s: ipw2100_get_firmware failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span> <span class="o">=</span> <span class="n">IPW2100_ERR_FW_LOAD</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_version</span> <span class="o">=</span> <span class="n">ipw2100_firmware</span><span class="p">.</span><span class="n">version</span><span class="p">;</span>

	<span class="cm">/* s/w reset and clock stabilization */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sw_reset_and_clock</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ERROR</span><span class="p">(</span><span class="s">&quot;%s: sw_reset_and_clock failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_verify</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ERROR</span><span class="p">(</span><span class="s">&quot;%s: ipw2100_verify failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Hold ARC */</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span>
			<span class="n">IPW_INTERNAL_REGISTER_HALT_AND_RESET</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>

	<span class="cm">/* allow ARC to run */</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_RESET_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* load microcode */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_ucode_download</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw2100_firmware</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s: Error loading microcode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* release ARC */</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span>
			<span class="n">IPW_INTERNAL_REGISTER_HALT_AND_RESET</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="cm">/* s/w reset and clock stabilization (again!!!) */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sw_reset_and_clock</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: %s: sw_reset_and_clock failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* load f/w */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_fw_download</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw2100_firmware</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ERROR</span><span class="p">(</span><span class="s">&quot;%s: Error loading firmware: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifndef CONFIG_PM</span>
	<span class="cm">/*</span>
<span class="cm">	 * When the .resume method of the driver is called, the other</span>
<span class="cm">	 * part of the system, i.e. the ide driver could still stay in</span>
<span class="cm">	 * the suspend stage. This prevents us from loading the firmware</span>
<span class="cm">	 * from the disk.  --YZ</span>
<span class="cm">	 */</span>

	<span class="cm">/* free any storage allocated for firmware image */</span>
	<span class="n">ipw2100_release_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw2100_firmware</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* zero out Domain 1 area indirectly (Si requirement) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">address</span> <span class="o">=</span> <span class="n">IPW_HOST_FW_SHARED_AREA0</span><span class="p">;</span>
	     <span class="n">address</span> <span class="o">&lt;</span> <span class="n">IPW_HOST_FW_SHARED_AREA0_END</span><span class="p">;</span> <span class="n">address</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">address</span> <span class="o">=</span> <span class="n">IPW_HOST_FW_SHARED_AREA1</span><span class="p">;</span>
	     <span class="n">address</span> <span class="o">&lt;</span> <span class="n">IPW_HOST_FW_SHARED_AREA1_END</span><span class="p">;</span> <span class="n">address</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">address</span> <span class="o">=</span> <span class="n">IPW_HOST_FW_SHARED_AREA2</span><span class="p">;</span>
	     <span class="n">address</span> <span class="o">&lt;</span> <span class="n">IPW_HOST_FW_SHARED_AREA2_END</span><span class="p">;</span> <span class="n">address</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">address</span> <span class="o">=</span> <span class="n">IPW_HOST_FW_SHARED_AREA3</span><span class="p">;</span>
	     <span class="n">address</span> <span class="o">&lt;</span> <span class="n">IPW_HOST_FW_SHARED_AREA3_END</span><span class="p">;</span> <span class="n">address</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">address</span> <span class="o">=</span> <span class="n">IPW_HOST_FW_INTERRUPT_AREA</span><span class="p">;</span>
	     <span class="n">address</span> <span class="o">&lt;</span> <span class="n">IPW_HOST_FW_INTERRUPT_AREA_END</span><span class="p">;</span> <span class="n">address</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">fail:</span>
	<span class="n">ipw2100_release_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw2100_firmware</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ipw2100_enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INT_ENABLED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_INT_ENABLED</span><span class="p">;</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA_MASK</span><span class="p">,</span> <span class="n">IPW_INTERRUPT_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ipw2100_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INT_ENABLED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_INT_ENABLED</span><span class="p">;</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA_MASK</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_initialize_ordinals</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_ordinals</span> <span class="o">*</span><span class="n">ord</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ordinals</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_MEM_HOST_SHARED_ORDINALS_TABLE_1</span><span class="p">,</span>
		      <span class="o">&amp;</span><span class="n">ord</span><span class="o">-&gt;</span><span class="n">table1_addr</span><span class="p">);</span>

	<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_MEM_HOST_SHARED_ORDINALS_TABLE_2</span><span class="p">,</span>
		      <span class="o">&amp;</span><span class="n">ord</span><span class="o">-&gt;</span><span class="n">table2_addr</span><span class="p">);</span>

	<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">ord</span><span class="o">-&gt;</span><span class="n">table1_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ord</span><span class="o">-&gt;</span><span class="n">table1_size</span><span class="p">);</span>
	<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">ord</span><span class="o">-&gt;</span><span class="n">table2_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ord</span><span class="o">-&gt;</span><span class="n">table2_size</span><span class="p">);</span>

	<span class="n">ord</span><span class="o">-&gt;</span><span class="n">table2_size</span> <span class="o">&amp;=</span> <span class="mh">0x0000FFFF</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;table 1 size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ord</span><span class="o">-&gt;</span><span class="n">table1_size</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;table 2 size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ord</span><span class="o">-&gt;</span><span class="n">table2_size</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ipw2100_hw_set_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set GPIO 3 writable by FW; GPIO 1 writable</span>
<span class="cm">	 * by driver and enable clock</span>
<span class="cm">	 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">IPW_BIT_GPIO_GPIO3_MASK</span> <span class="o">|</span> <span class="n">IPW_BIT_GPIO_GPIO1_ENABLE</span> <span class="o">|</span>
	       <span class="n">IPW_BIT_GPIO_LED_OFF</span><span class="p">);</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_GPIO</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rf_kill_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define MAX_RF_KILL_CHECKS 5</span>
<span class="cp">#define RF_KILL_CHECK_DELAY 40</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">&amp;</span> <span class="n">HW_FEATURE_RFKILL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_RF_KILL_HW</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RF_KILL_CHECKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">RF_KILL_CHECK_DELAY</span><span class="p">);</span>
		<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_GPIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">IPW_BIT_GPIO_RF_KILL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_RF_KILL_HW</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_RF_KILL_HW</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_get_hw_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * EEPROM_SRAM_DB_START_ADDRESS using ordinal in ordinal table 1</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_get_ordinal</span>
	    <span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_EEPROM_SRAM_DB_BLOCK_START_ADDRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;failed querying ordinals at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;EEPROM address: %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * EEPROM version is the byte at offset 0xfd in firmware</span>
<span class="cm">	 * We read 4 bytes, then shift out the byte we actually want */</span>
	<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_version</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;EEPROM version: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_version</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  HW RF Kill enable is bit 0 in byte at offset 0x21 in firmware</span>
<span class="cm">	 *</span>
<span class="cm">	 *  notice that the EEPROM bit is reverse polarity, i.e.</span>
<span class="cm">	 *     bit = 0  signifies HW RF kill switch is supported</span>
<span class="cm">	 *     bit = 1  signifies HW RF kill switch is NOT supported</span>
<span class="cm">	 */</span>
	<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">HW_FEATURE_RFKILL</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;HW RF Kill: %ssupported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">&amp;</span> <span class="n">HW_FEATURE_RFKILL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not &quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start firmware execution after power on and intialization</span>
<span class="cm"> * The sequence is:</span>
<span class="cm"> *  1. Release ARC</span>
<span class="cm"> *  2. Wait for f/w initialization completes;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_start_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inta</span><span class="p">,</span> <span class="n">inta_mask</span><span class="p">,</span> <span class="n">gpio</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RUNNING</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the hw - drive adapter to DO state by setting</span>
<span class="cm">	 * init_done bit. Wait for clk_ready bit and Download</span>
<span class="cm">	 * fw &amp; dino ucode</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_download_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: %s: Failed to power on the adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear the Tx, Rx and Msg queues and the r/w indexes</span>
<span class="cm">	 * in the firmware RBD and TBD ring queue */</span>
	<span class="n">ipw2100_queues_initialize</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">ipw2100_hw_set_gpio</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* TODO -- Look at disabling interrupts here to make sure none</span>
<span class="cm">	 * get fired during FW initialization */</span>

	<span class="cm">/* Release ARC - clear reset bit */</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_RESET_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* wait for f/w intialization complete */</span>
	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;Waiting for f/w initialization to complete...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">40</span><span class="p">));</span>
		<span class="cm">/* Todo... wait for sync command ... */</span>

		<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inta</span><span class="p">);</span>

		<span class="cm">/* check &quot;init done&quot; bit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW2100_INTA_FW_INIT_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reset &quot;init done&quot; bit */</span>
			<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span>
				       <span class="n">IPW2100_INTA_FW_INIT_DONE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check error conditions : we check these after the firmware</span>
<span class="cm">		 * check so that if there is an error, the interrupt handler</span>
<span class="cm">		 * will see it and the adapter will be reset */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">IPW2100_INTA_FATAL_ERROR</span> <span class="o">|</span> <span class="n">IPW2100_INTA_PARITY_ERROR</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* clear error conditions */</span>
			<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span>
				       <span class="n">IPW2100_INTA_FATAL_ERROR</span> <span class="o">|</span>
				       <span class="n">IPW2100_INTA_PARITY_ERROR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Clear out any pending INTAs since we aren&#39;t supposed to have</span>
<span class="cm">	 * interrupts enabled at this point... */</span>
	<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inta</span><span class="p">);</span>
	<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inta_mask</span><span class="p">);</span>
	<span class="n">inta</span> <span class="o">&amp;=</span> <span class="n">IPW_INTERRUPT_MASK</span><span class="p">;</span>
	<span class="cm">/* Clear out any pending interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">inta_mask</span><span class="p">)</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="n">inta</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_FW</span><span class="p">(</span><span class="s">&quot;f/w initialization complete: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: %s: Firmware did not initialize.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allow firmware to write to GPIO1 &amp; GPIO3 */</span>
	<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_GPIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio</span><span class="p">);</span>

	<span class="n">gpio</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IPW_BIT_GPIO_GPIO1_MASK</span> <span class="o">|</span> <span class="n">IPW_BIT_GPIO_GPIO3_MASK</span><span class="p">);</span>

	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_GPIO</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>

	<span class="cm">/* Ready to receive commands */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_RUNNING</span><span class="p">;</span>

	<span class="cm">/* The adapter has been reset; we are not associated */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STATUS_ASSOCIATING</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ipw2100_reset_fatalerror</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_errors</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_index</span> <span class="o">%=</span> <span class="n">IPW2100_ERROR_QUEUE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* NOTE: Our interrupt is disabled when this method is called */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_power_cycle_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Power cycling the hardware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ipw2100_hw_set_gpio</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Step 1. Stop Master Assert */</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_RESET_REG</span><span class="p">,</span>
		       <span class="n">IPW_AUX_HOST_RESET_REG_STOP_MASTER</span><span class="p">);</span>

	<span class="cm">/* Step 2. Wait for stop Master Assert</span>
<span class="cm">	 *         (not more than 50us, otherwise ret error */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">IPW_WAIT_RESET_MASTER_ASSERT_COMPLETE_DELAY</span><span class="p">);</span>
		<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_RESET_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">IPW_AUX_HOST_RESET_REG_MASTER_DISABLED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_RESET_PENDING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span>
		    <span class="p">(</span><span class="s">&quot;exit - waited too long for master assert stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_RESET_REG</span><span class="p">,</span>
		       <span class="n">IPW_AUX_HOST_RESET_REG_SW_RESET</span><span class="p">);</span>

	<span class="cm">/* Reset any fatal_error conditions */</span>
	<span class="n">ipw2100_reset_fatalerror</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* At this point, the adapter is now stopped and disabled */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STATUS_RUNNING</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATING</span> <span class="o">|</span>
			  <span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_ENABLED</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send the CARD_DISABLE_PHY_OFF command to the card to disable it</span>
<span class="cm"> *</span>
<span class="cm"> * After disabling, if the card was associated, a STATUS_ASSN_LOST will be sent.</span>
<span class="cm"> *</span>
<span class="cm"> * STATUS_CARD_DISABLE_NOTIFICATION will be sent regardless of</span>
<span class="cm"> * if STATUS_ASSN_LOST is sent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_hw_phy_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#define HW_PHY_OFF_LOOP_DELAY (HZ / 5000)</span>

	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">CARD_DISABLE_PHY_OFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;CARD_DISABLE_PHY_OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Turn off the radio */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2500</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW2100_CONTROL_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
		<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW2100_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="n">IPW2100_CONTROL_PHY_OFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">val2</span> <span class="o">&amp;</span> <span class="n">IPW2100_COMMAND_PHY_OFF</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">HW_PHY_OFF_LOOP_DELAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_enable_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">HOST_COMPLETE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;HOST_COMPLETE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ENABLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rf_kill_active</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Command aborted due to RF kill active.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Failed to send HOST_COMPLETE command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_wait_for_card_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_HW_STATE_ENABLED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: card not responding to init command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_hang_check</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_hang_check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hang_check</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

      <span class="nl">fail_up:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_hw_stop_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define HW_POWER_DOWN_DELAY (msecs_to_jiffies(100))</span>

	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">HOST_PRE_POWER_DOWN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RUNNING</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_STOPPING</span><span class="p">;</span>

	<span class="cm">/* We can only shut down the card if the firmware is operational.  So,</span>
<span class="cm">	 * if we haven&#39;t reset since a fatal_error, then we can not send the</span>
<span class="cm">	 * shutdown commands. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First, make sure the adapter is enabled so that the PHY_OFF</span>
<span class="cm">		 * command can shut it down */</span>
		<span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_phy_off</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
			       <span class="s">&quot;: Error disabling radio %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If in D0-standby mode going directly to D3 may cause a</span>
<span class="cm">		 * PCI bus violation.  Therefore we must change out of the D0</span>
<span class="cm">		 * state.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Sending the PREPARE_FOR_POWER_DOWN will restrict the</span>
<span class="cm">		 * hardware from going into standby mode and will transition</span>
<span class="cm">		 * out of D0-standby if it is already in that state.</span>
<span class="cm">		 *</span>
<span class="cm">		 * STATUS_PREPARE_POWER_DOWN_COMPLETE will be sent by the</span>
<span class="cm">		 * driver upon completion.  Once received, the driver can</span>
<span class="cm">		 * proceed to the D3 state.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Prepare for power down command to fw.  This command would</span>
<span class="cm">		 * take HW out of D0-standby and prepare it for D3 state.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Currently FW does not support event notification for this</span>
<span class="cm">		 * event. Therefore, skip waiting for it.  Just wait a fixed</span>
<span class="cm">		 * 100ms</span>
<span class="cm">		 */</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;HOST_PRE_POWER_DOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: &quot;</span>
			       <span class="s">&quot;%s: Power down command failed: Error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">HW_POWER_DOWN_DELAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_ENABLED</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set GPIO 3 writable by FW; GPIO 1 writable</span>
<span class="cm">	 * by driver and enable clock</span>
<span class="cm">	 */</span>
	<span class="n">ipw2100_hw_set_gpio</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Power down adapter.  Sequence:</span>
<span class="cm">	 * 1. Stop master assert (RESET_REG[9]=1)</span>
<span class="cm">	 * 2. Wait for stop master (RESET_REG[8]==1)</span>
<span class="cm">	 * 3. S/w reset assert (RESET_REG[7] = 1)</span>
<span class="cm">	 */</span>

	<span class="cm">/* Stop master assert */</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_RESET_REG</span><span class="p">,</span>
		       <span class="n">IPW_AUX_HOST_RESET_REG_STOP_MASTER</span><span class="p">);</span>

	<span class="cm">/* wait stop master not more than 50 usec.</span>
<span class="cm">	 * Otherwise return error. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="cm">/* Check master stop bit */</span>
		<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_RESET_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">IPW_AUX_HOST_RESET_REG_MASTER_DISABLED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: %s: Could now power down adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* assert s/w reset */</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_RESET_REG</span><span class="p">,</span>
		       <span class="n">IPW_AUX_HOST_RESET_REG_SW_RESET</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STATUS_RUNNING</span> <span class="o">|</span> <span class="n">STATUS_STOPPING</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_disable_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">CARD_DISABLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;CARD_DISABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ENABLED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Make sure we clear the associated state */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_hang_check</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_hang_check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hang_check</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_mutex</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: exit - failed to send CARD_DISABLE command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_wait_for_card_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_HW_STATE_DISABLED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: exit - card failed to change to DISABLED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;TODO: implement scan state machine</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

      <span class="nl">fail_up:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_scan_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">SET_SCAN_OPTIONS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">8</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;setting scan options</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_ASSOCIATE</span><span class="p">))</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IPW_SCAN_NOASSOCIATE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IPW_SCAN_MIXED_CELL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_PASSIVE_SCAN</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IPW_SCAN_PASSIVE</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_mask</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;SET_SCAN_OPTIONS 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_start_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">BROADCAST_SCAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">4</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;START_SCAN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* No scanning if in monitor mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCANNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Scan requested while already in scan...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Not clearing here; doing so makes iwlist always return nothing...</span>
<span class="cm">	 *</span>
<span class="cm">	 * We should modify the table logic to use aging tables vs. clearing</span>
<span class="cm">	 * the table on each scan start.</span>
<span class="cm">	 */</span>
	<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;starting scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SCANNING</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_SCANNING</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">libipw_geo</span> <span class="n">ipw_geos</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>			<span class="cm">/* Restricted */</span>
	 <span class="s">&quot;---&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg_channels</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bg</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">11</span><span class="p">},</span> <span class="p">{</span><span class="mi">2467</span><span class="p">,</span> <span class="mi">12</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">2472</span><span class="p">,</span> <span class="mi">13</span><span class="p">},</span> <span class="p">{</span><span class="mi">2484</span><span class="p">,</span> <span class="mi">14</span><span class="p">}},</span>
	 <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">deferred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ord_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Age scan list entries found before suspend */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">suspend_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">libipw_networks_age</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">suspend_time</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">suspend_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Quiet if manually disabled. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_SW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Radio is disabled by Manual Disable &quot;</span>
			       <span class="s">&quot;switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the ipw2100 hardware really doesn&#39;t want power management delays</span>
<span class="cm">	 * longer than 175usec</span>
<span class="cm">	 */</span>
	<span class="n">pm_qos_update_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipw2100_pm_qos_req</span><span class="p">,</span> <span class="mi">175</span><span class="p">);</span>

	<span class="cm">/* If the interrupt is enabled, turn it off... */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ipw2100_disable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Reset any fatal_error conditions */</span>
	<span class="n">ipw2100_reset_fatalerror</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_POWERED</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RESET_PENDING</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Power cycle the card ... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_power_cycle_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
			       <span class="s">&quot;: %s: Could not cycle adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_POWERED</span><span class="p">;</span>

	<span class="cm">/* Load the firmware, start the clocks, etc. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_start_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: %s: Failed to start the firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipw2100_initialize_ordinals</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Determine capabilities of this particular HW configuration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_get_hw_features</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: %s: Failed to determine HW features.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the geo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">libipw_set_geo</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw_geos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;Could not set geo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">freq_band</span> <span class="o">=</span> <span class="n">LIBIPW_24GHZ_BAND</span><span class="p">;</span>

	<span class="n">lock</span> <span class="o">=</span> <span class="n">LOCK_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_set_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_PERS_DB_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ord_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: %s: Failed to clear ordinal lock.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_SCANNING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rf_kill_active</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Radio is disabled by RF switch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_rf_kill</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_rf_kill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">,</span>
					      <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">HZ</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">deferred</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Turn on the interrupt so that commands can be processed */</span>
	<span class="n">ipw2100_enable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Send all of the commands that must be sent prior to</span>
<span class="cm">	 * HOST_COMPLETE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_adapter_setup</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s: Failed to start the card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">deferred</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable the adapter - sends HOST_COMPLETE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: &quot;</span>
			       <span class="s">&quot;%s: failed in call to enable adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ipw2100_hw_stop_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Start a scan . . . */</span>
		<span class="n">ipw2100_set_scan_options</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">ipw2100_start_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

      <span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ap_addr</span> <span class="o">=</span> <span class="p">{</span>
			    <span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">associated</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">;</span>

	<span class="cm">/* Kill the RF switch timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_rf_kill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_rf_kill</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Kill the firmware hang check timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_hang_check</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_hang_check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hang_check</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Kill any pending resets */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RESET_PENDING</span><span class="p">)</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>

	<span class="cm">/* Make sure the interrupt is on so that FW commands will be</span>
<span class="cm">	 * processed correctly */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ipw2100_enable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_hw_stop_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s: Error stopping adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Do not disable the interrupt until _after_ we disable</span>
<span class="cm">	 * the adaptor.  Otherwise the CARD_DISABLE command will never</span>
<span class="cm">	 * be ack&#39;d by the firmware */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ipw2100_disable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pm_qos_update_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipw2100_pm_qos_req</span><span class="p">,</span> <span class="n">PM_QOS_DEFAULT_VALUE</span><span class="p">);</span>

	<span class="cm">/* We have to signal any supplicant if we are disassociating */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">associated</span><span class="p">)</span>
		<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">libipw_geo</span> <span class="o">*</span><span class="n">geo</span> <span class="o">=</span> <span class="n">libipw_get_geo</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* fill-out priv-&gt;ieee-&gt;bg_band */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">bg_band</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bg_band</span><span class="p">;</span>

		<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
		<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span><span class="p">;</span>
		<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_channel</span><span class="p">),</span>
					    <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipw2100_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* translate geo-&gt;bg to bg_band.channels */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
			<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">center_freq</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span><span class="p">;</span>
			<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_power</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_power</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_PASSIVE_ONLY</span><span class="p">)</span>
				<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
					<span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_NO_IBSS</span><span class="p">)</span>
				<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
					<span class="n">IEEE80211_CHAN_NO_IBSS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LIBIPW_CH_RADAR_DETECT</span><span class="p">)</span>
				<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
					<span class="n">IEEE80211_CHAN_RADAR</span><span class="p">;</span>
			<span class="cm">/* No equivalent for LIBIPW_CH_80211H_RULES,</span>
<span class="cm">			   LIBIPW_CH_UNIFORM_SPREADING, or</span>
<span class="cm">			   LIBIPW_CH_B_ONLY... */</span>
		<span class="p">}</span>
		<span class="cm">/* point at bitrate info */</span>
		<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">ipw2100_bg_rates</span><span class="p">;</span>
		<span class="n">bg_band</span><span class="o">-&gt;</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">RATE_COUNT</span><span class="p">;</span>

		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">bg_band</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">cipher_suites</span> <span class="o">=</span> <span class="n">ipw_cipher_suites</span><span class="p">;</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_cipher_suites</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipw_cipher_suites</span><span class="p">);</span>

	<span class="n">set_wiphy_dev</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wiphy_register</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_reset_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_priv</span><span class="p">,</span> <span class="n">reset_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ap_addr</span> <span class="o">=</span> <span class="p">{</span>
			    <span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">associated</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;: %s: Restarting adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">resets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SECURITY_UPDATED</span><span class="p">;</span>

	<span class="cm">/* Force a power cycle even if interface hasn&#39;t been opened</span>
<span class="cm">	 * yet */</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_RESET_PENDING</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="cm">/* stop timed checks so that they don&#39;t interfere with reset */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_hang_check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hang_check</span><span class="p">);</span>

	<span class="cm">/* We have to signal any supplicant if we are disassociating */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">associated</span><span class="p">)</span>
		<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ipw2100_up</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_indicate_associated</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#define MAC_ASSOCIATION_READ_DELAY (HZ)</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">essid_len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">essid</span><span class="p">[</span><span class="n">IW_ESSID_MAX_SIZE</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">txrate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">txratename</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * TBD: BSSID is usually 00:00:00:00:00:00 here and not</span>
<span class="cm">	 *      an actual MAC of the AP. Seems like FW sets this</span>
<span class="cm">	 *      address too late. Read it later and expose through</span>
<span class="cm">	 *      /proc or schedule a later task to query and update</span>
<span class="cm">	 */</span>

	<span class="n">essid_len</span> <span class="o">=</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_ASSN_SSID</span><span class="p">,</span>
				  <span class="n">essid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">essid_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;failed querying ordinals at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_CURRENT_TX_RATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txrate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;failed querying ordinals at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_OUR_FREQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;failed querying ordinals at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_ASSN_AP_BSSID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;failed querying ordinals at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">txrate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TX_RATE_1_MBIT</span>:
		<span class="n">txratename</span> <span class="o">=</span> <span class="s">&quot;1Mbps&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_RATE_2_MBIT</span>:
		<span class="n">txratename</span> <span class="o">=</span> <span class="s">&quot;2Mbsp&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_RATE_5_5_MBIT</span>:
		<span class="n">txratename</span> <span class="o">=</span> <span class="s">&quot;5.5Mbps&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_RATE_11_MBIT</span>:
		<span class="n">txratename</span> <span class="o">=</span> <span class="s">&quot;11Mbps&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Unknown rate: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txrate</span><span class="p">);</span>
		<span class="n">txratename</span> <span class="o">=</span> <span class="s">&quot;unknown rate&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Associated with &#39;%s&#39; at %s, channel %d (BSSID=%pM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="n">essid_len</span><span class="p">),</span>
		       <span class="n">txratename</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>

	<span class="cm">/* now we copy read ssid into dev */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_ESSID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="n">essid_len</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_start</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_event_work</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">essid</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ssid_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">SSID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="n">ssid_len</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;SSID: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssid_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Bug in FW currently doesn&#39;t honor bit 0 in SET_SCAN_OPTIONS to</span>
<span class="cm">	 * disable auto association -- so we cheat by setting a bogus SSID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssid_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_ASSOCIATE</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">bogus</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">bogus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x18</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NOTE:  We always send the SSID command even if the provided ESSID is</span>
<span class="cm">	 * the same as what we currently think is set. */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span> <span class="o">+</span> <span class="n">ssid_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span> <span class="o">-</span> <span class="n">ssid_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">=</span> <span class="n">ssid_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_indicate_association_lost</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>

	<span class="n">IPW_DEBUG</span><span class="p">(</span><span class="n">IPW_DL_NOTIF</span> <span class="o">|</span> <span class="n">IPW_DL_STATE</span> <span class="o">|</span> <span class="n">IPW_DL_ASSOC</span><span class="p">,</span>
		  <span class="s">&quot;disassociated: &#39;%s&#39; %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">),</span>
		  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_STOPPING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Card is stopping itself, discard ASSN_LOST.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RUNNING</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SECURITY_UPDATED</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">security_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_event_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_indicate_rf_kill</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: RF Kill state changed to radio OFF.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* RF_KILL is now enabled (else we wouldn&#39;t be here) */</span>
	<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_RF_KILL_HW</span><span class="p">;</span>

	<span class="cm">/* Make sure the RF Kill check timer is running */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_rf_kill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">);</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">,</span> <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">HZ</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_scan_event</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>

	<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_scan_event_later</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">send_scan_event</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_priv</span><span class="p">,</span>
					<span class="n">scan_event_later</span><span class="p">.</span><span class="n">work</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_scan_event_now</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">send_scan_event</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_priv</span><span class="p">,</span>
					<span class="n">scan_event_now</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_scan_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;scan complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Age the scan results... */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scans</span><span class="o">++</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_SCANNING</span><span class="p">;</span>

	<span class="cm">/* Only userspace-requested scan completion events go out immediately */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">user_requested_scan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event_later</span><span class="p">))</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event_later</span><span class="p">,</span>
					      <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">4000</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">user_requested_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event_later</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event_now</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
<span class="cp">#define IPW2100_HANDLER(v, f) { v, f, # v }</span>
<span class="k">struct</span> <span class="n">ipw2100_status_indicator</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span> <span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="cp">#define IPW2100_HANDLER(v, f) { v, f }</span>
<span class="k">struct</span> <span class="n">ipw2100_status_indicator</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span> <span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">);</span>
<span class="p">};</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2100_DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_indicate_scanning</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Scanning...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SCANNING</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipw2100_status_indicator</span> <span class="n">status_handlers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IPW2100_HANDLER</span><span class="p">(</span><span class="n">IPW_STATE_INITIALIZED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">IPW2100_HANDLER</span><span class="p">(</span><span class="n">IPW_STATE_COUNTRY_FOUND</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">IPW2100_HANDLER</span><span class="p">(</span><span class="n">IPW_STATE_ASSOCIATED</span><span class="p">,</span> <span class="n">isr_indicate_associated</span><span class="p">),</span>
	<span class="n">IPW2100_HANDLER</span><span class="p">(</span><span class="n">IPW_STATE_ASSN_LOST</span><span class="p">,</span> <span class="n">isr_indicate_association_lost</span><span class="p">),</span>
	<span class="n">IPW2100_HANDLER</span><span class="p">(</span><span class="n">IPW_STATE_ASSN_CHANGED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">IPW2100_HANDLER</span><span class="p">(</span><span class="n">IPW_STATE_SCAN_COMPLETE</span><span class="p">,</span> <span class="n">isr_scan_complete</span><span class="p">),</span>
	<span class="n">IPW2100_HANDLER</span><span class="p">(</span><span class="n">IPW_STATE_ENTERED_PSP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">IPW2100_HANDLER</span><span class="p">(</span><span class="n">IPW_STATE_LEFT_PSP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">IPW2100_HANDLER</span><span class="p">(</span><span class="n">IPW_STATE_RF_KILL</span><span class="p">,</span> <span class="n">isr_indicate_rf_kill</span><span class="p">),</span>
	<span class="n">IPW2100_HANDLER</span><span class="p">(</span><span class="n">IPW_STATE_DISABLED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">IPW2100_HANDLER</span><span class="p">(</span><span class="n">IPW_STATE_POWER_DOWN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">IPW2100_HANDLER</span><span class="p">(</span><span class="n">IPW_STATE_SCANNING</span><span class="p">,</span> <span class="n">isr_indicate_scanning</span><span class="p">),</span>
	<span class="n">IPW2100_HANDLER</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_status_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">IPW_STATE_SCANNING</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SCANNING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Scan detected while associated, with &quot;</span>
			       <span class="s">&quot;no scan request.  Restarting firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Wake up any sleeping jobs */</span>
		<span class="n">schedule_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">status_handlers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">status_handlers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_NOTIF</span><span class="p">(</span><span class="s">&quot;Status change: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">status_handlers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status_handlers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb</span><span class="p">)</span>
				<span class="n">status_handlers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_NOTIF</span><span class="p">(</span><span class="s">&quot;unknown status received: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_rx_complete_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ipw2100_cmd_header</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_reg</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">command_types</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;Command completed &#39;%s (%d)&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">command_types</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_reg</span><span class="p">],</span>
			     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_reg</span> <span class="o">==</span> <span class="n">HOST_COMPLETE</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_ENABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_reg</span> <span class="o">==</span> <span class="n">CARD_DISABLE</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_ENABLED</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_CMD_ACTIVE</span><span class="p">;</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">frame_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;COMMAND_STATUS_VAL&quot;</span><span class="p">,</span>
	<span class="s">&quot;STATUS_CHANGE_VAL&quot;</span><span class="p">,</span>
	<span class="s">&quot;P80211_DATA_VAL&quot;</span><span class="p">,</span>
	<span class="s">&quot;P8023_DATA_VAL&quot;</span><span class="p">,</span>
	<span class="s">&quot;HOST_NOTIFICATION_VAL&quot;</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_alloc_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ipw2100_rx_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_rx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">rxp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_rx</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_rx</span><span class="p">),</span>
					  <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="cm">/* NOTE: pci_map_single does not return an error code, and 0 is a valid</span>
<span class="cm">	 *       dma_addr */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SEARCH_ERROR   0xffffffff</span>
<span class="cp">#define SEARCH_FAIL    0xfffffffe</span>
<span class="cp">#define SEARCH_SUCCESS 0xfffffff0</span>
<span class="cp">#define SEARCH_DISCARD 0</span>
<span class="cp">#define SEARCH_SNAPSHOT 1</span>

<span class="cp">#define SNAPSHOT_ADDR(ofs) (priv-&gt;snapshot[((ofs) &gt;&gt; 12) &amp; 0xff] + ((ofs) &amp; 0xfff))</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_snapshot_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x30</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef IPW2100_DEBUG_C3</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_snapshot_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x30</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Error allocating snapshot &quot;</span>
				       <span class="s">&quot;buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">[</span><span class="o">--</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ipw2100_match_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">in_buf</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">in_buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SEARCH_SNAPSHOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw2100_snapshot_alloc</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">SEARCH_DISCARD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">SEARCH_FAIL</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x30000</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SEARCH_SNAPSHOT</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">SNAPSHOT_ADDR</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">SEARCH_FAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">!=</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">s</span> <span class="o">=</span> <span class="n">in_buf</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">s</span><span class="o">++</span><span class="p">;</span>
				<span class="n">d</span><span class="o">++</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">s</span> <span class="o">-</span> <span class="n">in_buf</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SEARCH_DISCARD</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * 0) Disconnect the SKB from the firmware (just unmap)</span>
<span class="cm"> * 1) Pack the ETH header into the SKB</span>
<span class="cm"> * 2) Pass the SKB to the network stack</span>
<span class="cm"> *</span>
<span class="cm"> * When packet is provided by the firmware, it contains the following:</span>
<span class="cm"> *</span>
<span class="cm"> * .  libipw_hdr</span>
<span class="cm"> * .  libipw_snap_hdr</span>
<span class="cm"> *</span>
<span class="cm"> * The size of the constructed ethernet</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#ifdef IPW2100_RX_DEBUG</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">packet_data</span><span class="p">[</span><span class="n">IPW_RX_NIC_BUFFER_LENGTH</span><span class="p">];</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_corruption_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef IPW2100_DEBUG_C3</span>
	<span class="k">struct</span> <span class="n">ipw2100_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">.</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">match</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;: PCI latency error detected at 0x%04zX.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_status</span><span class="p">));</span>

<span class="cp">#ifdef IPW2100_DEBUG_C3</span>
	<span class="cm">/* Halt the firmware so we can get a good image */</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_RESET_REG</span><span class="p">,</span>
		       <span class="n">IPW_AUX_HOST_RESET_REG_STOP_MASTER</span><span class="p">);</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">IPW_WAIT_RESET_MASTER_ASSERT_COMPLETE_DELAY</span><span class="p">);</span>
		<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_RESET_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">IPW_AUX_HOST_RESET_REG_MASTER_DISABLED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">j</span><span class="o">--</span><span class="p">);</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">ipw2100_match_buf</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">status</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_status</span><span class="p">),</span>
				  <span class="n">SEARCH_SNAPSHOT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">&lt;</span> <span class="n">SEARCH_SUCCESS</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: DMA status match in Firmware at &quot;</span>
			       <span class="s">&quot;offset 0x%06X, length %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_status</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: No DMA status match in &quot;</span>
			       <span class="s">&quot;Firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">printk_buf</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">.</span><span class="n">drv</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_status</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_QUEUE_LENGTH</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span> <span class="o">=</span> <span class="n">IPW2100_ERR_C3_CORRUPTION</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">schedule_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">libipw_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">.</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ipw2100_rx_packet</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">IPW_DEBUG_RX</span><span class="p">(</span><span class="s">&quot;Handler...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_size</span> <span class="o">&gt;</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: frame_size (%u) &gt; skb_tailroom (%u)!&quot;</span>
			       <span class="s">&quot;  Dropping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">,</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">));</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span><span class="o">++</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Dropping packet while interface is not up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MONITOR</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Dropping packet while not associated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			 <span class="n">packet</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_rx</span><span class="p">),</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">);</span>

<span class="cp">#ifdef IPW2100_RX_DEBUG</span>
	<span class="cm">/* Make a copy of the frame so we can dump it to the logs if</span>
<span class="cm">	 * libipw_rx fails */</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">packet_data</span><span class="p">,</span>
				  <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">,</span>
					     <span class="n">IPW_RX_NIC_BUFFER_LENGTH</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">libipw_rx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef IPW2100_RX_DEBUG</span>
		<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;%s: Non consumed packet:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">printk_buf</span><span class="p">(</span><span class="n">IPW_DL_DROP</span><span class="p">,</span> <span class="n">packet_data</span><span class="p">,</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* libipw_rx failed, so it didn&#39;t free the SKB */</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We need to allocate a new SKB and attach it to the RDB. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ipw2100_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">packet</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: &quot;</span>
		       <span class="s">&quot;%s: Unable to allocate SKB onto RBD ring - disabling &quot;</span>
		       <span class="s">&quot;adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* TODO: schedule adapter shutdown */</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;TODO: Shutdown adapter...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update the RDB entry */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">.</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">host_addr</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_rx_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">libipw_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">.</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ipw2100_rx_packet</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* Magic struct that slots into the radiotap header -- no reason</span>
<span class="cm">	 * to build this manually element by element, we can write it much</span>
<span class="cm">	 * more efficiently than we can parse it. ORDER MATTERS HERE */</span>
	<span class="k">struct</span> <span class="n">ipw_rt_hdr</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_radiotap_header</span> <span class="n">rt_hdr</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">rt_dbmsignal</span><span class="p">;</span> <span class="cm">/* signal in dbM, kluged to signed */</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">ipw_rt</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_RX</span><span class="p">(</span><span class="s">&quot;Handler...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_size</span> <span class="o">&gt;</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rt_hdr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: frame_size (%u) &gt; skb_tailroom (%u)!&quot;</span>
			       <span class="s">&quot;  Dropping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">,</span>
			       <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">));</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span><span class="o">++</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Dropping packet while interface is not up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_CRC_CHECK</span> <span class="o">&amp;&amp;</span>
		     <span class="n">status</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPW_STATUS_FLAG_CRC_ERROR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_RX</span><span class="p">(</span><span class="s">&quot;CRC error in packet.  Dropping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_rx</span><span class="p">),</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">memmove</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rt_hdr</span><span class="p">),</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">);</span>

	<span class="n">ipw_rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rt_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_hdr</span><span class="p">.</span><span class="n">it_version</span> <span class="o">=</span> <span class="n">PKTHDR_RADIOTAP_VERSION</span><span class="p">;</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_hdr</span><span class="p">.</span><span class="n">it_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* always good to zero */</span>
	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_hdr</span><span class="p">.</span><span class="n">it_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rt_hdr</span><span class="p">));</span> <span class="cm">/* total hdr+data */</span>

	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_hdr</span><span class="p">.</span><span class="n">it_present</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_DBM_ANTSIGNAL</span><span class="p">);</span>

	<span class="n">ipw_rt</span><span class="o">-&gt;</span><span class="n">rt_dbmsignal</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">+</span> <span class="n">IPW2100_RSSI_TO_DBM</span><span class="p">;</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw_rt_hdr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">libipw_rx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* libipw_rx failed, so it didn&#39;t free the SKB */</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We need to allocate a new SKB and attach it to the RDB. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ipw2100_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">packet</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WARNING</span><span class="p">(</span>
			<span class="s">&quot;%s: Unable to allocate SKB onto RBD ring - disabling &quot;</span>
			<span class="s">&quot;adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* TODO: schedule adapter shutdown */</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;TODO: Shutdown adapter...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update the RDB entry */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">.</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">host_addr</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_corruption_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">.</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ipw2100_rx</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">frame_type</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">status_fields</span> <span class="o">&amp;</span> <span class="n">STATUS_TYPE_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">frame_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">COMMAND_STATUS_VAL</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">.</span><span class="n">command</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">STATUS_CHANGE_VAL</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">.</span><span class="n">status</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">HOST_NOTIFICATION_VAL</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">.</span><span class="n">notification</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">P80211_DATA_VAL</span>:
	<span class="k">case</span> <span class="n">P8023_DATA_VAL</span>:
<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">WLAN_FC_GET_TYPE</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IEEE80211_FTYPE_MGMT</span>:
		<span class="k">case</span> <span class="n">IEEE80211_FTYPE_CTL</span>:
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEEE80211_FTYPE_DATA</span>:
			<span class="k">return</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_size</span> <span class="o">&gt;</span>
				<span class="n">IPW_MAX_802_11_PAYLOAD_LENGTH</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ipw2100 interrupts are disabled at this point, and the ISR</span>
<span class="cm"> * is the only code that calls this method.  So, we do not need</span>
<span class="cm"> * to play with any locks.</span>
<span class="cm"> *</span>
<span class="cm"> * RX Queue works as follows:</span>
<span class="cm"> *</span>
<span class="cm"> * Read index - firmware places packet in entry identified by the</span>
<span class="cm"> *              Read index and advances Read index.  In this manner,</span>
<span class="cm"> *              Read index will always point to the next packet to</span>
<span class="cm"> *              be filled--but not yet valid.</span>
<span class="cm"> *</span>
<span class="cm"> * Write index - driver fills this entry with an unused RBD entry.</span>
<span class="cm"> *               This entry has not filled by the firmware yet.</span>
<span class="cm"> *</span>
<span class="cm"> * In between the W and R indexes are the RBDs that have been received</span>
<span class="cm"> * but not yet processed.</span>
<span class="cm"> *</span>
<span class="cm"> * The process of handling packets will start at WRITE + 1 and advance</span>
<span class="cm"> * until it reaches the READ index.</span>
<span class="cm"> *</span>
<span class="cm"> * The WRITE index is cached in the variable &#39;priv-&gt;rx_queue.next&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ipw2100_rx_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_bd_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_status_queue</span> <span class="o">*</span><span class="n">sq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_rx_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">frame_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_rx</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">libipw_rx_stats</span> <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mac_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_MEM_HOST_SHARED_RX_READ_INDEX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_MEM_HOST_SHARED_RX_WRITE_INDEX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_RX</span><span class="p">(</span><span class="s">&quot;exit - bad read index</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* IPW_DEBUG_RX(&quot;r = %d : w = %d : processing = %d\n&quot;,</span>
<span class="cm">		   r, rxq-&gt;next, i); */</span>

		<span class="n">packet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* Sync the DMA for the RX buffer so CPU is sure to get</span>
<span class="cm">		 * the correct values */</span>
		<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_rx</span><span class="p">),</span>
					    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ipw2100_corruption_check</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ipw2100_corruption_detected</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">increment</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">u</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">rxp</span><span class="p">;</span>
		<span class="n">frame_type</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status_fields</span> <span class="o">&amp;</span> <span class="n">STATUS_TYPE_MASK</span><span class="p">;</span>
		<span class="n">stats</span><span class="p">.</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rssi</span> <span class="o">+</span> <span class="n">IPW2100_RSSI_TO_DBM</span><span class="p">;</span>
		<span class="n">stats</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frame_size</span><span class="p">;</span>

		<span class="n">stats</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">rssi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">stats</span><span class="p">.</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">LIBIPW_STATMASK_RSSI</span><span class="p">;</span>
		<span class="n">stats</span><span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">LIBIPW_24GHZ_BAND</span><span class="p">;</span>

		<span class="n">IPW_DEBUG_RX</span><span class="p">(</span><span class="s">&quot;%s: &#39;%s&#39; frame type received (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">frame_types</span><span class="p">[</span><span class="n">frame_type</span><span class="p">],</span>
			     <span class="n">stats</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">frame_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">COMMAND_STATUS_VAL</span>:
			<span class="cm">/* Reset Rx watchdog */</span>
			<span class="n">isr_rx_complete_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATUS_CHANGE_VAL</span>:
			<span class="n">isr_status_change</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">P80211_DATA_VAL</span>:
		<span class="k">case</span> <span class="n">P8023_DATA_VAL</span>:
<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">isr_rx_monitor</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">libipw_hdr_3addr</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">WLAN_FC_GET_TYPE</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IEEE80211_FTYPE_MGMT</span>:
				<span class="n">libipw_rx_mgt</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">.</span><span class="n">header</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">IEEE80211_FTYPE_CTL</span>:
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">IEEE80211_FTYPE_DATA</span>:
				<span class="n">isr_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	      <span class="nl">increment:</span>
		<span class="cm">/* clear status field associated with this RBD */</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* backtrack one entry, wrapping to end if at 0 */</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">?</span> <span class="n">i</span> <span class="o">:</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span>
			       <span class="n">IPW_MEM_HOST_SHARED_RX_WRITE_INDEX</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * __ipw2100_tx_process</span>
<span class="cm"> *</span>
<span class="cm"> * This routine will determine whether the next packet on</span>
<span class="cm"> * the fw_pend_list has been processed by the firmware yet.</span>
<span class="cm"> *</span>
<span class="cm"> * If not, then it does nothing and returns.</span>
<span class="cm"> *</span>
<span class="cm"> * If so, then it removes the item from the fw_pend_list, frees</span>
<span class="cm"> * any associated storage, and places the item back on the</span>
<span class="cm"> * free list of its source (either msg_free_list or tx_free_list)</span>
<span class="cm"> *</span>
<span class="cm"> * TX Queue works as follows:</span>
<span class="cm"> *</span>
<span class="cm"> * Read index - points to the next TBD that the firmware will</span>
<span class="cm"> *              process.  The firmware will read the data, and once</span>
<span class="cm"> *              done processing, it will advance the Read index.</span>
<span class="cm"> *</span>
<span class="cm"> * Write index - driver fills this entry with an constructed TBD</span>
<span class="cm"> *               entry.  The Write index is not advanced until the</span>
<span class="cm"> *               packet has been configured.</span>
<span class="cm"> *</span>
<span class="cm"> * In between the W and R indexes are the TBDs that have NOT been</span>
<span class="cm"> * processed.  Lagging behind the R index are packets that have</span>
<span class="cm"> * been processed but have not been freed by the driver.</span>
<span class="cm"> *</span>
<span class="cm"> * In order to free old storage, an internal index will be maintained</span>
<span class="cm"> * that points to the next packet to be freed.  When all used</span>
<span class="cm"> * packets have been freed, the oldest index will be the same as the</span>
<span class="cm"> * firmware&#39;s read index.</span>
<span class="cm"> *</span>
<span class="cm"> * The OLDEST index is cached in the variable &#39;priv-&gt;tx_queue.oldest&#39;</span>
<span class="cm"> *</span>
<span class="cm"> * Because the TBD structure can not contain arbitrary data, the</span>
<span class="cm"> * driver must keep an internal queue of cached allocations such that</span>
<span class="cm"> * it can put that data back into the tx_free_list and msg_free_list</span>
<span class="cm"> * for use by future command and data packets.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ipw2100_tx_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_bd_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_bd</span> <span class="o">*</span><span class="n">tbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_tx_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">descriptors_used</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">frag_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pend_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">element</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pend_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>

	<span class="n">packet</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_tx_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">tbd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="cm">/* Determine how many TBD entries must be finished... */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">COMMAND</span>:
		<span class="cm">/* COMMAND uses only one slot; don&#39;t advance */</span>
		<span class="n">descriptors_used</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">oldest</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DATA</span>:
		<span class="cm">/* DATA uses two slots; advance and loop position. */</span>
		<span class="n">descriptors_used</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">-&gt;</span><span class="n">num_fragments</span><span class="p">;</span>
		<span class="n">frag_num</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">-&gt;</span><span class="n">num_fragments</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">oldest</span> <span class="o">+</span> <span class="n">frag_num</span><span class="p">;</span>
		<span class="n">e</span> <span class="o">%=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s: Bad fw_pend_list entry!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if the last TBD is not done by NIC yet, then packet is</span>
<span class="cm">	 * not ready to be released.</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_MEM_HOST_SHARED_TX_QUEUE_READ_INDEX</span><span class="p">,</span>
		      <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_MEM_HOST_SHARED_TX_QUEUE_WRITE_INDEX</span><span class="p">,</span>
		      <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s: write index mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * txq-&gt;next is the index of the last packet written txq-&gt;oldest is</span>
<span class="cm">	 * the index of the r is the index of the next packet to be read by</span>
<span class="cm">	 * firmware</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Quick graphic to help you visualize the following</span>
<span class="cm">	 * if / else statement</span>
<span class="cm">	 *</span>
<span class="cm">	 * ===&gt;|                     s----&gt;|===============</span>
<span class="cm">	 *                               e&gt;|</span>
<span class="cm">	 * | a | b | c | d | e | f | g | h | i | j | k | l</span>
<span class="cm">	 *       r----&gt;|</span>
<span class="cm">	 *               w</span>
<span class="cm">	 *</span>
<span class="cm">	 * w - updated by driver</span>
<span class="cm">	 * r - updated by firmware</span>
<span class="cm">	 * s - start of oldest BD entry (txq-&gt;oldest)</span>
<span class="cm">	 * e - end of oldest BD entry</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">w</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="n">r</span> <span class="o">||</span> <span class="n">e</span> <span class="o">&gt;=</span> <span class="n">w</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">e</span> <span class="o">&gt;=</span> <span class="n">w</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;exit - no processed packets ready to release.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
	<span class="n">DEC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pend_stat</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
	<span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">oldest</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;TX%d V=%p P=%04X T=%04X L=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			     <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">nic</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_bd</span><span class="p">)),</span>
			     <span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">host_addr</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_length</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>

			<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;TX%d V=%p P=%04X T=%04X L=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				     <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">nic</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_bd</span><span class="p">)),</span>
				     <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">host_addr</span><span class="p">,</span>
				     <span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_length</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DATA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">oldest</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">txType</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s: Queue mismatch.  &quot;</span>
			       <span class="s">&quot;Expecting DATA TBD but pulled &quot;</span>
			       <span class="s">&quot;something else: ids %d=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">oldest</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

		<span class="cm">/* DATA packet; we have to unmap and free the SKB */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frag_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tbd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">];</span>

			<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;TX%d P=%08x L=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span>
				     <span class="n">tbd</span><span class="o">-&gt;</span><span class="n">host_addr</span><span class="p">,</span> <span class="n">tbd</span><span class="o">-&gt;</span><span class="n">buf_length</span><span class="p">);</span>

			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					 <span class="n">tbd</span><span class="o">-&gt;</span><span class="n">host_addr</span><span class="p">,</span>
					 <span class="n">tbd</span><span class="o">-&gt;</span><span class="n">buf_length</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">libipw_txb_free</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="p">);</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_list</span><span class="p">);</span>
		<span class="n">INC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_stat</span><span class="p">);</span>

		<span class="cm">/* We have a free slot in the Tx queue, so wake up the</span>
<span class="cm">		 * transmit layer if it is stopped. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>

		<span class="cm">/* A packet was processed by the hardware, so update the</span>
<span class="cm">		 * watchdog */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">COMMAND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">oldest</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">txType</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s: Queue mismatch.  &quot;</span>
			       <span class="s">&quot;Expecting COMMAND TBD but pulled &quot;</span>
			       <span class="s">&quot;something else: ids %d=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">oldest</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_command_reg</span> <span class="o">&lt;</span>
		    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">command_types</span><span class="p">))</span>
			<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;Command &#39;%s (%d)&#39; processed: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">command_types</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd</span><span class="o">-&gt;</span>
						   <span class="n">host_command_reg</span><span class="p">],</span>
				     <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd</span><span class="o">-&gt;</span>
				     <span class="n">host_command_reg</span><span class="p">,</span>
				     <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_status_reg</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_free_list</span><span class="p">);</span>
		<span class="n">INC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_free_stat</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* advance oldest used TBD pointer to start of next entry */</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">oldest</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
	<span class="cm">/* increase available TBDs number */</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">available</span> <span class="o">+=</span> <span class="n">descriptors_used</span><span class="p">;</span>
	<span class="n">SET_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_stat</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;packet latency (send to process)  %ld jiffies</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">jiffies</span> <span class="o">-</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">jiffy_start</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pend_list</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__ipw2100_tx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">__ipw2100_tx_process</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">)</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: &quot;</span>
		       <span class="s">&quot;%s: Driver is running slow (%d iters).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_tx_send_commands</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_tx_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_bd_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_bd</span> <span class="o">*</span><span class="n">tbd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_pend_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* if there isn&#39;t enough space in TBD queue, then</span>
<span class="cm">		 * don&#39;t stuff a new one in.</span>
<span class="cm">		 * NOTE: 3 are needed as a command will take one,</span>
<span class="cm">		 *       and there is a minimum of 2 that must be</span>
<span class="cm">		 *       maintained between the r and w indexes</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">available</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;no room in tx_queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">element</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_pend_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
		<span class="n">DEC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_pend_stat</span><span class="p">);</span>

		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_tx_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;using TBD at virt=%p, phys=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">],</span>
			     <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">nic</span> <span class="o">+</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">*</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_bd</span><span class="p">)));</span>

		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="n">tbd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">];</span>

		<span class="cm">/* initialize TBD */</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">host_addr</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd_phys</span><span class="p">;</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">buf_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_cmd_header</span><span class="p">);</span>
		<span class="cm">/* not marking number of fragments causes problems</span>
<span class="cm">		 * with f/w debug version */</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">num_fragments</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span>
		    <span class="n">IPW_BD_STATUS_TX_FRAME_COMMAND</span> <span class="o">|</span>
		    <span class="n">IPW_BD_STATUS_TX_INTERRUPT_ENABLE</span><span class="p">;</span>

		<span class="cm">/* update TBD queue counters */</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">++</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">%=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">available</span><span class="o">--</span><span class="p">;</span>
		<span class="n">DEC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_stat</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pend_list</span><span class="p">);</span>
		<span class="n">INC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pend_stat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* kick off the DMA by notifying firmware the</span>
<span class="cm">		 * write index has moved; make sure TBD stores are sync&#39;d */</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span>
			       <span class="n">IPW_MEM_HOST_SHARED_TX_QUEUE_WRITE_INDEX</span><span class="p">,</span>
			       <span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ipw2100_tx_send_data</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_tx_send_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_tx_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_bd_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_bd</span> <span class="o">*</span><span class="n">tbd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_data_header</span> <span class="o">*</span><span class="n">ipw_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">libipw_hdr_3addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pend_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* if there isn&#39;t enough space in TBD queue, then</span>
<span class="cm">		 * don&#39;t stuff a new one in.</span>
<span class="cm">		 * NOTE: 4 are needed as a data will take two,</span>
<span class="cm">		 *       and there is a minimum of 2 that must be</span>
<span class="cm">		 *       maintained between the r and w indexes</span>
<span class="cm">		 */</span>
		<span class="n">element</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pend_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_tx_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">&gt;</span>
			     <span class="n">IPW_MAX_BDS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* TODO: Support merging buffers if more than</span>
<span class="cm">			 * IPW_MAX_BDS are used */</span>
			<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Maximum BD threshold exceeded.  &quot;</span>
				       <span class="s">&quot;Increase fragmentation level.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">available</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;no room in tx_queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
		<span class="n">DEC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pend_stat</span><span class="p">);</span>

		<span class="n">tbd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">];</span>

		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="n">ipw_hdr</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">libipw_hdr_3addr</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span>
		    <span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* To DS: Addr1 = BSSID, Addr2 = SA,</span>
<span class="cm">			   Addr3 = DA */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ipw_hdr</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ipw_hdr</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* not From/To DS: Addr1 = DA, Addr2 = SA,</span>
<span class="cm">			   Addr3 = BSSID */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ipw_hdr</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ipw_hdr</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ipw_hdr</span><span class="o">-&gt;</span><span class="n">host_command_reg</span> <span class="o">=</span> <span class="n">SEND</span><span class="p">;</span>
		<span class="n">ipw_hdr</span><span class="o">-&gt;</span><span class="n">host_command_reg1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* For now we only support host based encryption */</span>
		<span class="n">ipw_hdr</span><span class="o">-&gt;</span><span class="n">needs_encryption</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ipw_hdr</span><span class="o">-&gt;</span><span class="n">encrypted</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">encrypted</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ipw_hdr</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">=</span>
			    <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">frag_size</span> <span class="o">-</span>
			    <span class="n">LIBIPW_3ADDR_LEN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ipw_hdr</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">host_addr</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">data_phys</span><span class="p">;</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">buf_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_data_header</span><span class="p">);</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">num_fragments</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span>
		    <span class="n">IPW_BD_STATUS_TX_FRAME_802_3</span> <span class="o">|</span>
		    <span class="n">IPW_BD_STATUS_TX_FRAME_NOT_LAST_FRAGMENT</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">++</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">%=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>

		<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;data header tbd TX%d P=%08x L=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">packet</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">tbd</span><span class="o">-&gt;</span><span class="n">host_addr</span><span class="p">,</span> <span class="n">tbd</span><span class="o">-&gt;</span><span class="n">buf_length</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">IPW_DEBUG_FRAG</span><span class="p">(</span><span class="s">&quot;fragment Tx: %d frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tbd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span>
				    <span class="n">IPW_BD_STATUS_TX_FRAME_802_3</span> <span class="o">|</span>
				    <span class="n">IPW_BD_STATUS_TX_INTERRUPT_ENABLE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span>
				    <span class="n">IPW_BD_STATUS_TX_FRAME_802_3</span> <span class="o">|</span>
				    <span class="n">IPW_BD_STATUS_TX_FRAME_NOT_LAST_FRAGMENT</span><span class="p">;</span>

			<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">buf_length</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span>
			    <span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">LIBIPW_3ADDR_LEN</span><span class="p">;</span>

			<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">host_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
							<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span>
							<span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span>
							<span class="n">data</span> <span class="o">+</span>
							<span class="n">LIBIPW_3ADDR_LEN</span><span class="p">,</span>
							<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">buf_length</span><span class="p">,</span>
							<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

			<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;data frag tbd TX%d P=%08x L=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">tbd</span><span class="o">-&gt;</span><span class="n">host_addr</span><span class="p">,</span>
				     <span class="n">tbd</span><span class="o">-&gt;</span><span class="n">buf_length</span><span class="p">);</span>

			<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						       <span class="n">tbd</span><span class="o">-&gt;</span><span class="n">host_addr</span><span class="p">,</span>
						       <span class="n">tbd</span><span class="o">-&gt;</span><span class="n">buf_length</span><span class="p">,</span>
						       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">++</span><span class="p">;</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">%=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">available</span> <span class="o">-=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
		<span class="n">SET_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_stat</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pend_list</span><span class="p">);</span>
		<span class="n">INC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pend_stat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* kick off the DMA by notifying firmware the</span>
<span class="cm">		 * write index has moved; make sure TBD stores are sync&#39;d */</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span>
			       <span class="n">IPW_MEM_HOST_SHARED_TX_QUEUE_WRITE_INDEX</span><span class="p">,</span>
			       <span class="n">txq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_irq_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inta</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ipw2100_disable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inta</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_ISR</span><span class="p">(</span><span class="s">&quot;enter - INTA: 0x%08lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTERRUPT_MASK</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">in_isr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">interrupts</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* We do not loop and keep polling for more interrupts as this</span>
<span class="cm">	 * is frowned upon and doesn&#39;t play nicely with other potentially</span>
<span class="cm">	 * chained IRQs */</span>
	<span class="n">IPW_DEBUG_ISR</span><span class="p">(</span><span class="s">&quot;INTA: 0x%08lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW_INTERRUPT_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW2100_INTA_FATAL_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: Fatal interrupt. Scheduling firmware restart.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">inta_other</span><span class="o">++</span><span class="p">;</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="n">IPW2100_INTA_FATAL_ERROR</span><span class="p">);</span>

		<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_NIC_FATAL_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span><span class="p">);</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Fatal error value: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span><span class="p">);</span>

		<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_ERROR_ADDR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Fatal error address value: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="cm">/* Wake up any sleeping jobs */</span>
		<span class="n">schedule_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW2100_INTA_PARITY_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: ***** PARITY ERROR INTERRUPT !!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">inta_other</span><span class="o">++</span><span class="p">;</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="n">IPW2100_INTA_PARITY_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW2100_INTA_RX_TRANSFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ISR</span><span class="p">(</span><span class="s">&quot;RX interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_interrupts</span><span class="o">++</span><span class="p">;</span>

		<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="n">IPW2100_INTA_RX_TRANSFER</span><span class="p">);</span>

		<span class="n">__ipw2100_rx_process</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">__ipw2100_tx_complete</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW2100_INTA_TX_TRANSFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ISR</span><span class="p">(</span><span class="s">&quot;TX interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_interrupts</span><span class="o">++</span><span class="p">;</span>

		<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="n">IPW2100_INTA_TX_TRANSFER</span><span class="p">);</span>

		<span class="n">__ipw2100_tx_complete</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">ipw2100_tx_send_commands</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">ipw2100_tx_send_data</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW2100_INTA_TX_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ISR</span><span class="p">(</span><span class="s">&quot;TX complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">inta_other</span><span class="o">++</span><span class="p">;</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="n">IPW2100_INTA_TX_COMPLETE</span><span class="p">);</span>

		<span class="n">__ipw2100_tx_complete</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW2100_INTA_EVENT_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ipw2100_handle_event(dev); */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">inta_other</span><span class="o">++</span><span class="p">;</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="n">IPW2100_INTA_EVENT_INTERRUPT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW2100_INTA_FW_INIT_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ISR</span><span class="p">(</span><span class="s">&quot;FW init done interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">inta_other</span><span class="o">++</span><span class="p">;</span>

		<span class="n">read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IPW2100_INTA_FATAL_ERROR</span> <span class="o">|</span>
			   <span class="n">IPW2100_INTA_PARITY_ERROR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span>
				       <span class="n">IPW2100_INTA_FATAL_ERROR</span> <span class="o">|</span>
				       <span class="n">IPW2100_INTA_PARITY_ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="n">IPW2100_INTA_FW_INIT_DONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW2100_INTA_STATUS_CHANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ISR</span><span class="p">(</span><span class="s">&quot;Status change interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">inta_other</span><span class="o">++</span><span class="p">;</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="n">IPW2100_INTA_STATUS_CHANGE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IPW2100_INTA_SLAVE_MODE_HOST_COMMAND_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ISR</span><span class="p">(</span><span class="s">&quot;slave host mode interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">inta_other</span><span class="o">++</span><span class="p">;</span>
		<span class="n">write_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span>
			       <span class="n">IPW2100_INTA_SLAVE_MODE_HOST_COMMAND_DONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">in_isr</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ipw2100_enable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_ISR</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ipw2100_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inta</span><span class="p">,</span> <span class="n">inta_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">);</span>

	<span class="cm">/* We check to see if we should be ignoring interrupts before</span>
<span class="cm">	 * we touch the hardware.  During ucode load if we try and handle</span>
<span class="cm">	 * an interrupt we can cause keyboard problems as well as cause</span>
<span class="cm">	 * the ucode to fail to initialize */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INT_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Shared IRQ */</span>
		<span class="k">goto</span> <span class="n">none</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inta_mask</span><span class="p">);</span>
	<span class="n">read_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_REG_INTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inta</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Hardware disappeared */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: IRQ INTA == 0xFFFFFFFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">none</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">inta</span> <span class="o">&amp;=</span> <span class="n">IPW_INTERRUPT_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">inta_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Shared interrupt */</span>
		<span class="k">goto</span> <span class="n">none</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We disable the hardware interrupt here just to prevent unneeded</span>
<span class="cm">	 * calls to be made.  We disable this again within the actual</span>
<span class="cm">	 * work tasklet, so if another part of the code re-enables the</span>
<span class="cm">	 * interrupt, that is fine */</span>
	<span class="n">ipw2100_disable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
      <span class="nl">none:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">ipw2100_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">libipw_txb</span> <span class="o">*</span><span class="n">txb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_tx_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Can not transmit when not connected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_list</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_unlock</span><span class="p">;</span>

	<span class="n">element</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="n">packet</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_tx_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span> <span class="o">=</span> <span class="n">txb</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_TX</span><span class="p">(</span><span class="s">&quot;Sending fragment (%d bytes):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">printk_buf</span><span class="p">(</span><span class="n">IPW_DL_TX</span><span class="p">,</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">jiffy_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
	<span class="n">DEC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_stat</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pend_list</span><span class="p">);</span>
	<span class="n">INC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pend_stat</span><span class="p">);</span>

	<span class="n">ipw2100_tx_send_data</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">fail_unlock:</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_msg_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span> <span class="o">=</span>
	    <span class="n">kmalloc</span><span class="p">(</span><span class="n">IPW_COMMAND_POOL_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_tx_packet</span><span class="p">),</span>
		    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPW_COMMAND_POOL_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_cmd_header</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: &quot;</span>
			       <span class="s">&quot;%s: PCI alloc failed for msg &quot;</span>
			       <span class="s">&quot;buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_cmd_header</span><span class="p">));</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMMAND</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_cmd_header</span> <span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd_phys</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">IPW_COMMAND_POOL_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_cmd_header</span><span class="p">),</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span>
				    <span class="n">cmd_phys</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_msg_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_free_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_pend_list</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPW_COMMAND_POOL_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_free_list</span><span class="p">);</span>
	<span class="n">SET_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_free_stat</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_msg_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPW_COMMAND_POOL_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_cmd_header</span><span class="p">),</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">c_struct</span><span class="p">.</span>
				    <span class="n">cmd_phys</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;[%08X] &quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%08X &quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">out</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_cfg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_capability</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">capability</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_capability</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#define IPW2100_REG(x) { IPW_ ##x, #x }</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">hw_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">IPW2100_REG</span><span class="p">(</span><span class="n">REG_GP_CNTRL</span><span class="p">),</span>
	    <span class="n">IPW2100_REG</span><span class="p">(</span><span class="n">REG_GPIO</span><span class="p">),</span>
	    <span class="n">IPW2100_REG</span><span class="p">(</span><span class="n">REG_INTA</span><span class="p">),</span>
	    <span class="n">IPW2100_REG</span><span class="p">(</span><span class="n">REG_INTA_MASK</span><span class="p">),</span> <span class="n">IPW2100_REG</span><span class="p">(</span><span class="n">REG_RESET_REG</span><span class="p">),};</span>
<span class="cp">#define IPW2100_NIC(x, s) { x, #x, s }</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">nic_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">IPW2100_NIC</span><span class="p">(</span><span class="n">IPW2100_CONTROL_REG</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	    <span class="n">IPW2100_NIC</span><span class="p">(</span><span class="mh">0x210014</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">IPW2100_NIC</span><span class="p">(</span><span class="mh">0x210000</span><span class="p">,</span> <span class="mi">1</span><span class="p">),};</span>
<span class="cp">#define IPW2100_ORD(x, d) { IPW_ORD_ ##x, #x, d }</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ord_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_HOST_REQUESTS</span><span class="p">,</span> <span class="s">&quot;requested Host Tx&#39;s (MSDU)&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_HOST_COMPLETE</span><span class="p">,</span>
				<span class="s">&quot;successful Host Tx&#39;s (MSDU)&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_DIR_DATA</span><span class="p">,</span>
				<span class="s">&quot;successful Directed Tx&#39;s (MSDU)&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_DIR_DATA1</span><span class="p">,</span>
				<span class="s">&quot;successful Directed Tx&#39;s (MSDU) @ 1MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_DIR_DATA2</span><span class="p">,</span>
				<span class="s">&quot;successful Directed Tx&#39;s (MSDU) @ 2MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_DIR_DATA5_5</span><span class="p">,</span>
				<span class="s">&quot;successful Directed Tx&#39;s (MSDU) @ 5_5MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_DIR_DATA11</span><span class="p">,</span>
				<span class="s">&quot;successful Directed Tx&#39;s (MSDU) @ 11MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_NODIR_DATA1</span><span class="p">,</span>
				<span class="s">&quot;successful Non_Directed Tx&#39;s (MSDU) @ 1MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_NODIR_DATA2</span><span class="p">,</span>
				<span class="s">&quot;successful Non_Directed Tx&#39;s (MSDU) @ 2MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_NODIR_DATA5_5</span><span class="p">,</span>
				<span class="s">&quot;successful Non_Directed Tx&#39;s (MSDU) @ 5.5MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_NODIR_DATA11</span><span class="p">,</span>
				<span class="s">&quot;successful Non_Directed Tx&#39;s (MSDU) @ 11MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_NULL_DATA</span><span class="p">,</span> <span class="s">&quot;successful NULL data Tx&#39;s&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_RTS</span><span class="p">,</span> <span class="s">&quot;successful Tx RTS&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_CTS</span><span class="p">,</span> <span class="s">&quot;successful Tx CTS&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_ACK</span><span class="p">,</span> <span class="s">&quot;successful Tx ACK&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_ASSN</span><span class="p">,</span> <span class="s">&quot;successful Association Tx&#39;s&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_ASSN_RESP</span><span class="p">,</span>
				<span class="s">&quot;successful Association response Tx&#39;s&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_REASSN</span><span class="p">,</span>
				<span class="s">&quot;successful Reassociation Tx&#39;s&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_REASSN_RESP</span><span class="p">,</span>
				<span class="s">&quot;successful Reassociation response Tx&#39;s&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_PROBE</span><span class="p">,</span>
				<span class="s">&quot;probes successfully transmitted&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_PROBE_RESP</span><span class="p">,</span>
				<span class="s">&quot;probe responses successfully transmitted&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_BEACON</span><span class="p">,</span> <span class="s">&quot;tx beacon&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_ATIM</span><span class="p">,</span> <span class="s">&quot;Tx ATIM&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_DISASSN</span><span class="p">,</span>
				<span class="s">&quot;successful Disassociation TX&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_AUTH</span><span class="p">,</span> <span class="s">&quot;successful Authentication Tx&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_DEAUTH</span><span class="p">,</span>
				<span class="s">&quot;successful Deauthentication TX&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_TOTAL_BYTES</span><span class="p">,</span>
				<span class="s">&quot;Total successful Tx data bytes&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_RETRIES</span><span class="p">,</span> <span class="s">&quot;Tx retries&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_RETRY1</span><span class="p">,</span> <span class="s">&quot;Tx retries at 1MBPS&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_RETRY2</span><span class="p">,</span> <span class="s">&quot;Tx retries at 2MBPS&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_RETRY5_5</span><span class="p">,</span> <span class="s">&quot;Tx retries at 5.5MBPS&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_RETRY11</span><span class="p">,</span> <span class="s">&quot;Tx retries at 11MBPS&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_FAILURES</span><span class="p">,</span> <span class="s">&quot;Tx Failures&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_MAX_TRIES_IN_HOP</span><span class="p">,</span>
				<span class="s">&quot;times max tries in a hop failed&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_DISASSN_FAIL</span><span class="p">,</span>
				<span class="s">&quot;times disassociation failed&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_ERR_CTS</span><span class="p">,</span> <span class="s">&quot;missed/bad CTS frames&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_TX_ERR_ACK</span><span class="p">,</span> <span class="s">&quot;tx err due to acks&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_HOST</span><span class="p">,</span> <span class="s">&quot;packets passed to host&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_DIR_DATA</span><span class="p">,</span> <span class="s">&quot;directed packets&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_DIR_DATA1</span><span class="p">,</span> <span class="s">&quot;directed packets at 1MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_DIR_DATA2</span><span class="p">,</span> <span class="s">&quot;directed packets at 2MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_DIR_DATA5_5</span><span class="p">,</span>
				<span class="s">&quot;directed packets at 5.5MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_DIR_DATA11</span><span class="p">,</span> <span class="s">&quot;directed packets at 11MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_NODIR_DATA</span><span class="p">,</span> <span class="s">&quot;nondirected packets&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_NODIR_DATA1</span><span class="p">,</span>
				<span class="s">&quot;nondirected packets at 1MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_NODIR_DATA2</span><span class="p">,</span>
				<span class="s">&quot;nondirected packets at 2MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_NODIR_DATA5_5</span><span class="p">,</span>
				<span class="s">&quot;nondirected packets at 5.5MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_NODIR_DATA11</span><span class="p">,</span>
				<span class="s">&quot;nondirected packets at 11MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_NULL_DATA</span><span class="p">,</span> <span class="s">&quot;null data rx&#39;s&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_RTS</span><span class="p">,</span> <span class="s">&quot;Rx RTS&quot;</span><span class="p">),</span> <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_CTS</span><span class="p">,</span>
								    <span class="s">&quot;Rx CTS&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_ACK</span><span class="p">,</span> <span class="s">&quot;Rx ACK&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_CFEND</span><span class="p">,</span> <span class="s">&quot;Rx CF End&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_CFEND_ACK</span><span class="p">,</span> <span class="s">&quot;Rx CF End + CF Ack&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_ASSN</span><span class="p">,</span> <span class="s">&quot;Association Rx&#39;s&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_ASSN_RESP</span><span class="p">,</span> <span class="s">&quot;Association response Rx&#39;s&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_REASSN</span><span class="p">,</span> <span class="s">&quot;Reassociation Rx&#39;s&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_REASSN_RESP</span><span class="p">,</span>
				<span class="s">&quot;Reassociation response Rx&#39;s&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_PROBE</span><span class="p">,</span> <span class="s">&quot;probe Rx&#39;s&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_PROBE_RESP</span><span class="p">,</span> <span class="s">&quot;probe response Rx&#39;s&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_BEACON</span><span class="p">,</span> <span class="s">&quot;Rx beacon&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_ATIM</span><span class="p">,</span> <span class="s">&quot;Rx ATIM&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_DISASSN</span><span class="p">,</span> <span class="s">&quot;disassociation Rx&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_AUTH</span><span class="p">,</span> <span class="s">&quot;authentication Rx&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_DEAUTH</span><span class="p">,</span> <span class="s">&quot;deauthentication Rx&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_TOTAL_BYTES</span><span class="p">,</span>
				<span class="s">&quot;Total rx data bytes received&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_ERR_CRC</span><span class="p">,</span> <span class="s">&quot;packets with Rx CRC error&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_ERR_CRC1</span><span class="p">,</span> <span class="s">&quot;Rx CRC errors at 1MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_ERR_CRC2</span><span class="p">,</span> <span class="s">&quot;Rx CRC errors at 2MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_ERR_CRC5_5</span><span class="p">,</span> <span class="s">&quot;Rx CRC errors at 5.5MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_ERR_CRC11</span><span class="p">,</span> <span class="s">&quot;Rx CRC errors at 11MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_DUPLICATE1</span><span class="p">,</span>
				<span class="s">&quot;duplicate rx packets at 1MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_DUPLICATE2</span><span class="p">,</span>
				<span class="s">&quot;duplicate rx packets at 2MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_DUPLICATE5_5</span><span class="p">,</span>
				<span class="s">&quot;duplicate rx packets at 5.5MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_DUPLICATE11</span><span class="p">,</span>
				<span class="s">&quot;duplicate rx packets at 11MB&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_DUPLICATE</span><span class="p">,</span> <span class="s">&quot;duplicate rx packets&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">PERS_DB_LOCK</span><span class="p">,</span> <span class="s">&quot;locking fw permanent  db&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">PERS_DB_SIZE</span><span class="p">,</span> <span class="s">&quot;size of fw permanent  db&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">PERS_DB_ADDR</span><span class="p">,</span> <span class="s">&quot;address of fw permanent  db&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_INVALID_PROTOCOL</span><span class="p">,</span>
				<span class="s">&quot;rx frames with invalid protocol&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">SYS_BOOT_TIME</span><span class="p">,</span> <span class="s">&quot;Boot time&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_NO_BUFFER</span><span class="p">,</span>
				<span class="s">&quot;rx frames rejected due to no buffer&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_MISSING_FRAG</span><span class="p">,</span>
				<span class="s">&quot;rx frames dropped due to missing fragment&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_ORPHAN_FRAG</span><span class="p">,</span>
				<span class="s">&quot;rx frames dropped due to non-sequential fragment&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_ORPHAN_FRAME</span><span class="p">,</span>
				<span class="s">&quot;rx frames dropped due to unmatched 1st frame&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_FRAG_AGEOUT</span><span class="p">,</span>
				<span class="s">&quot;rx frames dropped due to uncompleted frame&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_RX_ICV_ERRORS</span><span class="p">,</span>
				<span class="s">&quot;ICV errors during decryption&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_PSP_SUSPENSION</span><span class="p">,</span> <span class="s">&quot;times adapter suspended&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_PSP_BCN_TIMEOUT</span><span class="p">,</span> <span class="s">&quot;beacon timeout&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_PSP_POLL_TIMEOUT</span><span class="p">,</span>
				<span class="s">&quot;poll response timeouts&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_PSP_NONDIR_TIMEOUT</span><span class="p">,</span>
				<span class="s">&quot;timeouts waiting for last {broad,multi}cast pkt&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_PSP_RX_DTIMS</span><span class="p">,</span> <span class="s">&quot;PSP DTIMs received&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_PSP_RX_TIMS</span><span class="p">,</span> <span class="s">&quot;PSP TIMs received&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_PSP_STATION_ID</span><span class="p">,</span> <span class="s">&quot;PSP Station ID&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">LAST_ASSN_TIME</span><span class="p">,</span> <span class="s">&quot;RTC time of last association&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_PERCENT_MISSED_BCNS</span><span class="p">,</span>
				<span class="s">&quot;current calculation of % missed beacons&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_PERCENT_RETRIES</span><span class="p">,</span>
				<span class="s">&quot;current calculation of % missed tx retries&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">ASSOCIATED_AP_PTR</span><span class="p">,</span>
				<span class="s">&quot;0 if not associated, else pointer to AP table entry&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">AVAILABLE_AP_CNT</span><span class="p">,</span>
				<span class="s">&quot;AP&#39;s decsribed in the AP table&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">AP_LIST_PTR</span><span class="p">,</span> <span class="s">&quot;Ptr to list of available APs&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_AP_ASSNS</span><span class="p">,</span> <span class="s">&quot;associations&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_ASSN_FAIL</span><span class="p">,</span> <span class="s">&quot;association failures&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_ASSN_RESP_FAIL</span><span class="p">,</span>
				<span class="s">&quot;failures due to response fail&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_FULL_SCANS</span><span class="p">,</span> <span class="s">&quot;full scans&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">CARD_DISABLED</span><span class="p">,</span> <span class="s">&quot;Card Disabled&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_ROAM_INHIBIT</span><span class="p">,</span>
				<span class="s">&quot;times roaming was inhibited due to activity&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">RSSI_AT_ASSN</span><span class="p">,</span>
				<span class="s">&quot;RSSI of associated AP at time of association&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_ASSN_CAUSE1</span><span class="p">,</span>
				<span class="s">&quot;reassociation: no probe response or TX on hop&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_ASSN_CAUSE2</span><span class="p">,</span>
				<span class="s">&quot;reassociation: poor tx/rx quality&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_ASSN_CAUSE3</span><span class="p">,</span>
				<span class="s">&quot;reassociation: tx/rx quality (excessive AP load&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_ASSN_CAUSE4</span><span class="p">,</span>
				<span class="s">&quot;reassociation: AP RSSI level&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_ASSN_CAUSE5</span><span class="p">,</span>
				<span class="s">&quot;reassociations due to load leveling&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_AUTH_FAIL</span><span class="p">,</span> <span class="s">&quot;times authentication failed&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STAT_AUTH_RESP_FAIL</span><span class="p">,</span>
				<span class="s">&quot;times authentication response failed&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">STATION_TABLE_CNT</span><span class="p">,</span>
				<span class="s">&quot;entries in association table&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">RSSI_AVG_CURR</span><span class="p">,</span> <span class="s">&quot;Current avg RSSI&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">POWER_MGMT_MODE</span><span class="p">,</span> <span class="s">&quot;Power mode - 0=CAM, 1=PSP&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">COUNTRY_CODE</span><span class="p">,</span>
				<span class="s">&quot;IEEE country code as recv&#39;d from beacon&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">COUNTRY_CHANNELS</span><span class="p">,</span>
				<span class="s">&quot;channels supported by country&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">RESET_CNT</span><span class="p">,</span> <span class="s">&quot;adapter resets (warm)&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">BEACON_INTERVAL</span><span class="p">,</span> <span class="s">&quot;Beacon interval&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">ANTENNA_DIVERSITY</span><span class="p">,</span>
				<span class="s">&quot;TRUE if antenna diversity is disabled&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">DTIM_PERIOD</span><span class="p">,</span> <span class="s">&quot;beacon intervals between DTIMs&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">OUR_FREQ</span><span class="p">,</span>
				<span class="s">&quot;current radio freq lower digits - channel ID&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">RTC_TIME</span><span class="p">,</span> <span class="s">&quot;current RTC time&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">PORT_TYPE</span><span class="p">,</span> <span class="s">&quot;operating mode&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">CURRENT_TX_RATE</span><span class="p">,</span> <span class="s">&quot;current tx rate&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">SUPPORTED_RATES</span><span class="p">,</span> <span class="s">&quot;supported tx rates&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">ATIM_WINDOW</span><span class="p">,</span> <span class="s">&quot;current ATIM Window&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">BASIC_RATES</span><span class="p">,</span> <span class="s">&quot;basic tx rates&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">NIC_HIGHEST_RATE</span><span class="p">,</span> <span class="s">&quot;NIC highest tx rate&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">AP_HIGHEST_RATE</span><span class="p">,</span> <span class="s">&quot;AP highest tx rate&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">CAPABILITIES</span><span class="p">,</span>
				<span class="s">&quot;Management frame capability field&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">AUTH_TYPE</span><span class="p">,</span> <span class="s">&quot;Type of authentication&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">RADIO_TYPE</span><span class="p">,</span> <span class="s">&quot;Adapter card platform type&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">RTS_THRESHOLD</span><span class="p">,</span>
				<span class="s">&quot;Min packet length for RTS handshaking&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">INT_MODE</span><span class="p">,</span> <span class="s">&quot;International mode&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">FRAGMENTATION_THRESHOLD</span><span class="p">,</span>
				<span class="s">&quot;protocol frag threshold&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">EEPROM_SRAM_DB_BLOCK_START_ADDRESS</span><span class="p">,</span>
				<span class="s">&quot;EEPROM offset in SRAM&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">EEPROM_SRAM_DB_BLOCK_SIZE</span><span class="p">,</span>
				<span class="s">&quot;EEPROM size in SRAM&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">EEPROM_SKU_CAPABILITY</span><span class="p">,</span> <span class="s">&quot;EEPROM SKU Capability&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">EEPROM_IBSS_11B_CHANNELS</span><span class="p">,</span>
				<span class="s">&quot;EEPROM IBSS 11b channel set&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">MAC_VERSION</span><span class="p">,</span> <span class="s">&quot;MAC Version&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">MAC_REVISION</span><span class="p">,</span> <span class="s">&quot;MAC Revision&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">RADIO_VERSION</span><span class="p">,</span> <span class="s">&quot;Radio Version&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">NIC_MANF_DATE_TIME</span><span class="p">,</span> <span class="s">&quot;MANF Date/Time STAMP&quot;</span><span class="p">),</span>
	    <span class="n">IPW2100_ORD</span><span class="p">(</span><span class="n">UCODE_VERSION</span><span class="p">,</span> <span class="s">&quot;Ucode Version&quot;</span><span class="p">),};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%30s [Address ] : Hex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;Register&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hw_data</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%30s [%08X] : %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">hw_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">out</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">registers</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_registers</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_hardware</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%30s [Address ] : Hex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;NIC entry&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nic_data</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">tmp8</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">tmp16</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">tmp32</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">nic_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nic_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp8</span><span class="p">);</span>
			<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%30s [%08X] : %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">nic_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">nic_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
				       <span class="n">tmp8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nic_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp16</span><span class="p">);</span>
			<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%30s [%08X] : %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">nic_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">nic_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
				       <span class="n">tmp16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nic_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
			<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%30s [%08X] : %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">nic_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">nic_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
				       <span class="n">tmp32</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">out</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">hardware</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_hardware</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">81</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">&gt;=</span> <span class="mh">0x30000</span><span class="p">)</span>
		<span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* sysfs provides us PAGE_SIZE buffer */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">128</span> <span class="o">&amp;&amp;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="mh">0x30000</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				    <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">SNAPSHOT_ADDR</span><span class="p">(</span><span class="n">loop</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">loop</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dump_raw</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span>
				       <span class="s">&quot;%c%c%c%c&quot;</span>
				       <span class="s">&quot;%c%c%c%c&quot;</span>
				       <span class="s">&quot;%c%c%c%c&quot;</span>
				       <span class="s">&quot;%c%c%c%c&quot;</span><span class="p">,</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0x0</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0x1</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0x2</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0x3</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0x4</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0x5</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0x6</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0x7</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0x8</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0x9</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0xa</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0xb</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0xc</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0xd</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0xe</span><span class="p">],</span>
				       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">)[</span><span class="mh">0xf</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">snprint_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">),</span>
						    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">loop</span><span class="p">));</span>
		<span class="n">loop</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>		<span class="cm">/* kill unused-var warning for debug-only code */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;1&#39;</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">tolower</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="sc">&#39;o&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">tolower</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Setting memory dump to RAW mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dump_raw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">tolower</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="sc">&#39;o&#39;</span> <span class="o">&amp;&amp;</span>
				   <span class="n">tolower</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="sc">&#39;f&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Setting memory dump to HEX mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dump_raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tolower</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="sc">&#39;r&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Resetting firmware snapshot.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ipw2100_snapshot_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Usage: 0|on = HEX, 1|off = RAW, &quot;</span>
			       <span class="s">&quot;reset = clear memory snapshot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_memory</span><span class="p">,</span> <span class="n">store_memory</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_ordinals</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val_len</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ord_data</span><span class="p">))</span>
		<span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* sysfs provides us PAGE_SIZE buffer */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">128</span> <span class="o">&amp;&amp;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ord_data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ord_data</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">val_len</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;[0x%02X] = ERROR    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ord_data</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">index</span><span class="p">,</span>
				       <span class="n">ord_data</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">desc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;[0x%02X] = 0x%08X %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ord_data</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">index</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
				       <span class="n">ord_data</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">loop</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ordinals</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_ordinals</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;interrupts: %d {tx: %d, rx: %d, other: %d}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">interrupts</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_interrupts</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_interrupts</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">inta_other</span><span class="p">);</span>
	<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;firmware resets: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">resets</span><span class="p">);</span>
	<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;firmware hangs: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hangs</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
	<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;packet mismatch image: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="s">&quot;YES&quot;</span> <span class="o">:</span> <span class="s">&quot;NO&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">out</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_stats</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_switch_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s: Could not disable adapter %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
	<span class="k">case</span> <span class="n">IW_MODE_MONITOR</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_mode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_IEEE80211_RADIOTAP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2100_MONITOR */</span><span class="cp"></span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="cm">/* Indicate ipw2100_download_firmware download firmware</span>
<span class="cm">	 * from disk instead of memory. */</span>
	<span class="n">ipw2100_firmware</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Resetting on mode change.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_backoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">schedule_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_internals</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define DUMP_VAR(x,y) len += sprintf(buf + len, # x &quot;: %&quot; y &quot;\n&quot;, priv-&gt; x)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;connected: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">get_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_start</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;not connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">],</span> <span class="s">&quot;p&quot;</span><span class="p">);</span>
	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;08lx&quot;</span><span class="p">);</span>
	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">&quot;08lx&quot;</span><span class="p">);</span>
	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">capability</span><span class="p">,</span> <span class="s">&quot;08lx&quot;</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span>
	    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;last_rtc: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rtc</span><span class="p">);</span>

	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">fatal_error</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>
	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">stop_hang_check</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>
	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">stop_rf_kill</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>
	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">messages_sent</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>

	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">tx_pend_stat</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>
	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">tx_pend_stat</span><span class="p">.</span><span class="n">hi</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>

	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">tx_free_stat</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>
	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">tx_free_stat</span><span class="p">.</span><span class="n">lo</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>

	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">msg_free_stat</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>
	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">msg_free_stat</span><span class="p">.</span><span class="n">lo</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>

	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">msg_pend_stat</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>
	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">msg_pend_stat</span><span class="p">.</span><span class="n">hi</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>

	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">fw_pend_stat</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>
	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">fw_pend_stat</span><span class="p">.</span><span class="n">hi</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>

	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">txq_stat</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>
	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">txq_stat</span><span class="p">.</span><span class="n">lo</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>

	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scans</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>
	<span class="n">DUMP_VAR</span><span class="p">(</span><span class="n">reset_backoff</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">internals</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_internals</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bssinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">essid</span><span class="p">[</span><span class="n">IW_ESSID_MAX_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">essid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">essid</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bssid</span><span class="p">));</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_ASSN_SSID</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;failed querying ordinals at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bssid</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_ASSN_AP_BSSID</span><span class="p">,</span>
				  <span class="n">bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;failed querying ordinals at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_OUR_FREQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;failed querying ordinals at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;ESSID: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">essid</span><span class="p">);</span>
	<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;BSSID:   %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>
	<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;Channel: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">out</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">bssinfo</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_bssinfo</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_debug_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ipw2100_debug_level</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_debug_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span><span class="p">)</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">buf</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;: %s is not in hex or decimal form.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ipw2100_debug_level</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_debug_level</span><span class="p">,</span>
		   <span class="n">store_debug_level</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2100_DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_fatal_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span><span class="p">)</span>
		<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">IPW2100_ERROR_QUEUE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_errors</span><span class="p">[(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_index</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span>
					<span class="n">IPW2100_ERROR_QUEUE</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">out</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%d. 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_errors</span><span class="p">[(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_index</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span>
						  <span class="n">IPW2100_ERROR_QUEUE</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">out</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_fatal_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">schedule_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">fatal_error</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_fatal_error</span><span class="p">,</span>
		   <span class="n">store_fatal_error</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_scan_age</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_scan_age</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;00000000&quot;</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">count</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>		<span class="cm">/* kill unused-var warning for debug-only code */</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span><span class="p">)</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: user supplied invalid value.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;set scan_age = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">scan_age</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_scan_age</span><span class="p">,</span> <span class="n">store_scan_age</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_rf_kill</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* 0 - RF kill not enabled</span>
<span class="cm">	   1 - SW based RF kill active (sysfs)</span>
<span class="cm">	   2 - HW based RF kill active</span>
<span class="cm">	   3 - Both HW and SW baed RF kill active */</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_SW</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x1</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">rf_kill_active</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x2</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw_radio_kill_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">disable_radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">disable_radio</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_SW</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_RF_KILL</span><span class="p">(</span><span class="s">&quot;Manual SW RF Kill set to: RADIO  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">disable_radio</span> <span class="o">?</span> <span class="s">&quot;OFF&quot;</span> <span class="o">:</span> <span class="s">&quot;ON&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable_radio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_RF_KILL_SW</span><span class="p">;</span>
		<span class="n">ipw2100_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_RF_KILL_SW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rf_kill_active</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_RF_KILL</span><span class="p">(</span><span class="s">&quot;Can not turn radio back on - &quot;</span>
					  <span class="s">&quot;disabled by HW switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Make sure the RF_KILL check timer is running */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_rf_kill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">);</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">,</span>
					      <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">HZ</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">schedule_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_rf_kill</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">ipw_radio_kill_sw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;1&#39;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">rf_kill</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_rf_kill</span><span class="p">,</span> <span class="n">store_rf_kill</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">ipw2100_sysfs_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hardware</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_registers</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ordinals</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_pci</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stats</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_internals</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_bssinfo</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_memory</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_scan_age</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_fatal_error</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rf_kill</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_cfg</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_capability</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">ipw2100_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ipw2100_sysfs_entries</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">status_queue_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_status_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_status</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">drv</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_status</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
							  <span class="n">q</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WARNING</span><span class="p">(</span><span class="s">&quot;Can not allocate status queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">status_queue_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">.</span><span class="n">drv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">.</span><span class="n">drv</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">.</span><span class="n">nic</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">.</span><span class="n">drv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bd_queue_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ipw2100_bd_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_bd_queue</span><span class="p">));</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_bd</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">drv</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span>
		    <span class="p">(</span><span class="s">&quot;can&#39;t allocate shared memory for buffer descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd_queue_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_bd_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">drv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd_queue_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipw2100_bd_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="n">u32</span> <span class="n">base</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">r</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;initializing bd queue at virt=%p, phys=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">);</span>

	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">);</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">oldest</span><span class="p">);</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_kill_works</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_rf_kill</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_hang_check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">security_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_event_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hang_check</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event_now</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event_later</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_tx_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bd_queue_allocate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span> <span class="n">TX_QUEUE_LENGTH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_ERROR</span><span class="p">(</span><span class="s">&quot;%s: failed bd_queue_allocate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span> <span class="o">=</span>
	    <span class="n">kmalloc</span><span class="p">(</span><span class="n">TX_PENDED_QUEUE_LENGTH</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_tx_packet</span><span class="p">),</span>
		    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: %s: alloc failed form tx buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">bd_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_PENDED_QUEUE_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_data_header</span><span class="p">),</span>
					 <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span>
			       <span class="s">&quot;: %s: PCI alloc failed for tx &quot;</span> <span class="s">&quot;buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">DATA</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_data_header</span> <span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">data_phys</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">TX_PENDED_QUEUE_LENGTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_data_header</span><span class="p">),</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span>
				    <span class="n">data_phys</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_tx_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * reinitialize packet info lists</span>
<span class="cm">	 */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pend_list</span><span class="p">);</span>
	<span class="n">INIT_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pend_stat</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * reinitialize lists</span>
<span class="cm">	 */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pend_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_list</span><span class="p">);</span>
	<span class="n">INIT_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pend_stat</span><span class="p">);</span>
	<span class="n">INIT_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_stat</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_PENDED_QUEUE_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We simply drop any SKBs that have been queued for</span>
<span class="cm">		 * transmit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">libipw_txb_free</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span>
					   <span class="n">txb</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">SET_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_stat</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">oldest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">available</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">entries</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_stat</span><span class="p">);</span>
	<span class="n">SET_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_stat</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">available</span><span class="p">);</span>

	<span class="n">bd_queue_initialize</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span>
			    <span class="n">IPW_MEM_HOST_SHARED_TX_QUEUE_BD_BASE</span><span class="p">,</span>
			    <span class="n">IPW_MEM_HOST_SHARED_TX_QUEUE_BD_SIZE</span><span class="p">,</span>
			    <span class="n">IPW_MEM_HOST_SHARED_TX_QUEUE_READ_INDEX</span><span class="p">,</span>
			    <span class="n">IPW_MEM_HOST_SHARED_TX_QUEUE_WRITE_INDEX</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_tx_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bd_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_PENDED_QUEUE_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">libipw_txb_free</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span>
					   <span class="n">txb</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_data_header</span><span class="p">),</span>
					    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span>
					    <span class="n">data</span><span class="p">,</span>
					    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span>
					    <span class="n">data_phys</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_rx_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bd_queue_allocate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">,</span> <span class="n">RX_QUEUE_LENGTH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;failed bd_queue_allocate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">status_queue_allocate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">RX_QUEUE_LENGTH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;failed status_queue_allocate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bd_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate packets</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">RX_QUEUE_LENGTH</span> <span class="o">*</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_rx_packet</span><span class="p">),</span>
				   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;can&#39;t allocate rx packet buffer table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">bd_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">);</span>

		<span class="n">status_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_QUEUE_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ipw2100_rx_packet</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* The BD holds the cache aligned address */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">.</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">host_addr</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">.</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_length</span> <span class="o">=</span> <span class="n">IPW_RX_NIC_BUFFER_LENGTH</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">.</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status_fields</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">RX_QUEUE_LENGTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dma_addr</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_rx_packet</span><span class="p">),</span>
				 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bd_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">);</span>

	<span class="n">status_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_rx_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">.</span><span class="n">oldest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">.</span><span class="n">available</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">.</span><span class="n">entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">.</span><span class="n">entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">INIT_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq_stat</span><span class="p">);</span>
	<span class="n">SET_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq_stat</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">.</span><span class="n">available</span><span class="p">);</span>

	<span class="n">bd_queue_initialize</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">,</span>
			    <span class="n">IPW_MEM_HOST_SHARED_RX_BD_BASE</span><span class="p">,</span>
			    <span class="n">IPW_MEM_HOST_SHARED_RX_BD_SIZE</span><span class="p">,</span>
			    <span class="n">IPW_MEM_HOST_SHARED_RX_READ_INDEX</span><span class="p">,</span>
			    <span class="n">IPW_MEM_HOST_SHARED_RX_WRITE_INDEX</span><span class="p">);</span>

	<span class="cm">/* set up the status queue */</span>
	<span class="n">write_register</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">IPW_MEM_HOST_SHARED_RX_STATUS_BASE</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_queue</span><span class="p">.</span><span class="n">nic</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_rx_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bd_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">);</span>
	<span class="n">status_queue_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_QUEUE_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_addr</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_rx</span><span class="p">),</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_read_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">length</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_ADAPTER_MAC</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;MAC address read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;card MAC is %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Firmware Commands</span>
<span class="cm"> *</span>
<span class="cm"> ********************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">ADAPTER_ADDRESS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="n">ETH_ALEN</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;SET_MAC_ADDRESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_CUSTOM_MAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_port_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port_type</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">PORT_TYPE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">port_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPW_BSS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPW_IBSS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;PORT_TYPE: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">port_type</span> <span class="o">==</span> <span class="n">IPW_IBSS</span> <span class="o">?</span> <span class="s">&quot;Ad-Hoc&quot;</span> <span class="o">:</span> <span class="s">&quot;Managed&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span>
			       <span class="s">&quot;: %s: Could not disable adapter %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* send cmd to firmware */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span>
		<span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">channel</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">CHANNEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;CHANNEL: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="cm">/* If BSS then we don&#39;t support channel selection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="n">REG_MIN_CHANNEL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="n">REG_MAX_CHANNEL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Failed to set channel to %d&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_STATIC_CHANNEL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_STATIC_CHANNEL</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_system_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">SYSTEM_CONFIG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">u32</span> <span class="n">ibss_mask</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Set system configuration */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IPW_CFG_IBSS_AUTO_START</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IPW_CFG_IBSS_MASK</span> <span class="o">|</span>
	    <span class="n">IPW_CFG_BSS_MASK</span> <span class="o">|</span> <span class="n">IPW_CFG_802_1x_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_LONG_PREAMBLE</span><span class="p">))</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IPW_CFG_PREAMBLE_AUTO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				  <span class="n">IPW_ORD_EEPROM_IBSS_11B_CHANNELS</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">ibss_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">ibss_mask</span> <span class="o">=</span> <span class="n">IPW_IBSS_11B_DEFAULT_MASK</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_CHANNEL_MASK</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_CHANNEL_MASK</span> <span class="o">&amp;</span> <span class="n">ibss_mask</span><span class="p">;</span>

	<span class="cm">/* 11b only */</span>
	<span class="cm">/*cmd.host_command_parameters[0] |= DIVERSITY_ANTENNA_A; */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="cm">/* If IPv6 is configured in the kernel then we don&#39;t want to filter out all</span>
<span class="cm"> * of the multicast packets as IPv6 needs some. */</span>
<span class="cp">#if !defined(CONFIG_IPV6) &amp;&amp; !defined(CONFIG_IPV6_MODULE)</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">ADD_MULTICAST</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_tx_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rate</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">BASIC_TX_RATES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">4</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">&amp;</span> <span class="n">TX_RATE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set BASIC TX Rate first */</span>
	<span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Set TX Rate */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">TX_RATES</span><span class="p">;</span>
	<span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Set MSDU TX Rate */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">MSDU_TX_RATES</span><span class="p">;</span>
	<span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rates</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_power_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">power_level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">POWER_MODE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">4</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">power_level</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power_level</span> <span class="o">==</span> <span class="n">IPW_POWER_MODE_CAM</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">IPW_POWER_LEVEL</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">IPW_POWER_ENABLED</span> <span class="o">|</span> <span class="n">power_level</span><span class="p">;</span>

<span class="cp">#ifdef IPW2100_TX_POWER</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">IBSS</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_power</span> <span class="o">!=</span> <span class="n">DFTL_IBSS_TX_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set beacon interval */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">TX_POWER_INDEX</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_power</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_rts_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">RTS_THRESHOLD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">4</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">threshold</span> <span class="o">&amp;</span> <span class="n">RTS_DISABLED</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX_RTS_THRESHOLD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RTS_DISABLED</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">int ipw2100_set_fragmentation_threshold(struct ipw2100_priv *priv,</span>
<span class="c">					u32 threshold, int batch_mode)</span>
<span class="c">{</span>
<span class="c">	struct host_command cmd = {</span>
<span class="c">		.host_command = FRAG_THRESHOLD,</span>
<span class="c">		.host_command_sequence = 0,</span>
<span class="c">		.host_command_length = 4,</span>
<span class="c">		.host_command_parameters[0] = 0,</span>
<span class="c">	};</span>
<span class="c">	int err;</span>

<span class="c">	if (!batch_mode) {</span>
<span class="c">		err = ipw2100_disable_adapter(priv);</span>
<span class="c">		if (err)</span>
<span class="c">			return err;</span>
<span class="c">	}</span>

<span class="c">	if (threshold == 0)</span>
<span class="c">		threshold = DEFAULT_FRAG_THRESHOLD;</span>
<span class="c">	else {</span>
<span class="c">		threshold = max(threshold, MIN_FRAG_THRESHOLD);</span>
<span class="c">		threshold = min(threshold, MAX_FRAG_THRESHOLD);</span>
<span class="c">	}</span>

<span class="c">	cmd.host_command_parameters[0] = threshold;</span>

<span class="c">	IPW_DEBUG_HC(&quot;FRAG_THRESHOLD: %u\n&quot;, threshold);</span>

<span class="c">	err = ipw2100_hw_send_command(priv, &amp;cmd);</span>

<span class="c">	if (!batch_mode)</span>
<span class="c">		ipw2100_enable_adapter(priv);</span>

<span class="c">	if (!err)</span>
<span class="c">		priv-&gt;frag_threshold = threshold;</span>

<span class="c">	return err;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_short_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">retry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">SHORT_RETRY_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">4</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">retry</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span> <span class="o">=</span> <span class="n">retry</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_long_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">retry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">LONG_RETRY_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">4</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">retry</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span> <span class="o">=</span> <span class="n">retry</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_mandatory_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">bssid</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">MANDATORY_BSSID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">bssid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ETH_ALEN</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bssid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;MANDATORY_BSSID: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;MANDATORY_BSSID: &lt;clear&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* if BSSID is empty then we disable mandatory bssid mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bssid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span>
		<span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_disassociate_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">DISASSOCIATION_BSSID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="n">ETH_ALEN</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;DISASSOCIATION_BSSID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="cm">/* The Firmware currently ignores the BSSID and just disassociates from</span>
<span class="cm">	 * the currently associated AP -- but in the off chance that a future</span>
<span class="cm">	 * firmware does use the BSSID provided here, we go ahead and try and</span>
<span class="cm">	 * set it to the currently associated AP&#39;s BSSID */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ipw2100_set_wpa_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ipw2100_wpa_assoc_frame</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span>
    <span class="n">__attribute__</span> <span class="p">((</span><span class="n">unused</span><span class="p">));</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_wpa_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ipw2100_wpa_assoc_frame</span> <span class="o">*</span><span class="n">wpa_frame</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">SET_WPA_IE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_wpa_assoc_frame</span><span class="p">),</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;SET_WPA_IE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">,</span> <span class="n">wpa_frame</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_wpa_assoc_frame</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">security_info_params</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">allowed_ciphers</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">auth_mode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">replay_counters_number</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">unicast_using_group</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_security_information</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">auth_mode</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">security_level</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">unicast_using_group</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">SET_SECURITY_INFORMATION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">security_info_params</span><span class="p">)</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">security_info_params</span> <span class="o">*</span><span class="n">security</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">security_info_params</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">security</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">security</span><span class="p">));</span>

	<span class="cm">/* If shared key AP authentication is turned on, then we need to</span>
<span class="cm">	 * configure the firmware to try and use it.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Actual data encryption/decryption is handled by the host. */</span>
	<span class="n">security</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">auth_mode</span><span class="p">;</span>
	<span class="n">security</span><span class="o">-&gt;</span><span class="n">unicast_using_group</span> <span class="o">=</span> <span class="n">unicast_using_group</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">security_level</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_0</span>:
		<span class="n">security</span><span class="o">-&gt;</span><span class="n">allowed_ciphers</span> <span class="o">=</span> <span class="n">IPW_NONE_CIPHER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_1</span>:
		<span class="n">security</span><span class="o">-&gt;</span><span class="n">allowed_ciphers</span> <span class="o">=</span> <span class="n">IPW_WEP40_CIPHER</span> <span class="o">|</span>
		    <span class="n">IPW_WEP104_CIPHER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_2</span>:
		<span class="n">security</span><span class="o">-&gt;</span><span class="n">allowed_ciphers</span> <span class="o">=</span> <span class="n">IPW_WEP40_CIPHER</span> <span class="o">|</span>
		    <span class="n">IPW_WEP104_CIPHER</span> <span class="o">|</span> <span class="n">IPW_TKIP_CIPHER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_2_CKIP</span>:
		<span class="n">security</span><span class="o">-&gt;</span><span class="n">allowed_ciphers</span> <span class="o">=</span> <span class="n">IPW_WEP40_CIPHER</span> <span class="o">|</span>
		    <span class="n">IPW_WEP104_CIPHER</span> <span class="o">|</span> <span class="n">IPW_CKIP_CIPHER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_LEVEL_3</span>:
		<span class="n">security</span><span class="o">-&gt;</span><span class="n">allowed_ciphers</span> <span class="o">=</span> <span class="n">IPW_WEP40_CIPHER</span> <span class="o">|</span>
		    <span class="n">IPW_WEP104_CIPHER</span> <span class="o">|</span> <span class="n">IPW_TKIP_CIPHER</span> <span class="o">|</span> <span class="n">IPW_CCMP_CIPHER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_HC</span>
	    <span class="p">(</span><span class="s">&quot;SET_SECURITY_INFORMATION: auth:%d cipher:0x%02X (level %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">security</span><span class="o">-&gt;</span><span class="n">auth_mode</span><span class="p">,</span> <span class="n">security</span><span class="o">-&gt;</span><span class="n">allowed_ciphers</span><span class="p">,</span> <span class="n">security_level</span><span class="p">);</span>

	<span class="n">security</span><span class="o">-&gt;</span><span class="n">replay_counters_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span>
		<span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tx_power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">TX_POWER_INDEX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">4</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tx_power</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_power</span> <span class="o">!=</span> <span class="n">IPW_TX_POWER_DEFAULT</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_power</span> <span class="o">-</span> <span class="n">IPW_TX_POWER_MIN_DBM</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span>
		      <span class="p">(</span><span class="n">IPW_TX_POWER_MAX_DBM</span> <span class="o">-</span> <span class="n">IPW_TX_POWER_MIN_DBM</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power</span> <span class="o">=</span> <span class="n">tx_power</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_ibss_beacon_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					    <span class="n">u32</span> <span class="n">interval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">BEACON_INTERVAL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">4</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_queues_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipw2100_tx_initialize</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw2100_rx_initialize</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw2100_msg_initialize</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_queues_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipw2100_tx_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw2100_rx_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw2100_msg_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_queues_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_tx_allocate</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ipw2100_rx_allocate</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">||</span> <span class="n">ipw2100_msg_allocate</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">fail:</span>
	<span class="n">ipw2100_tx_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw2100_rx_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ipw2100_msg_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IPW_PRIVACY_CAPABLE 0x0008</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_wep_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">WEP_FLAGS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">4</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;WEP_FLAGS: flags = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span>
			       <span class="s">&quot;: %s: Could not disable adapter %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* send cmd to firmware */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span>
		<span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ipw2100_wep_key</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Macros to ease up priting WEP keys */</span>
<span class="cp">#define WEP_FMT_64  &quot;%02X%02X%02X%02X-%02X&quot;</span>
<span class="cp">#define WEP_FMT_128 &quot;%02X%02X%02X%02X-%02X%02X%02X%02X-%02X%02X%02X&quot;</span>
<span class="cp">#define WEP_STR_64(x) x[0],x[1],x[2],x[3],x[4]</span>
<span class="cp">#define WEP_STR_128(x) x[0],x[1],x[2],x[3],x[4],x[5],x[6],x[7],x[8],x[9],x[10]</span>

<span class="cm">/**</span>
<span class="cm"> * Set a the wep key</span>
<span class="cm"> *</span>
<span class="cm"> * @priv: struct to work on</span>
<span class="cm"> * @idx: index of the key we want to set</span>
<span class="cm"> * @key: ptr to the key data to set</span>
<span class="cm"> * @len: length of the buffer at @key</span>
<span class="cm"> * @batch_mode: FIXME perform the operation in batch mode, not</span>
<span class="cm"> *              disabling the device.</span>
<span class="cm"> *</span>
<span class="cm"> * @returns 0 if OK, &lt; 0 errno code on error.</span>
<span class="cm"> *</span>
<span class="cm"> * Fill out a command structure with the new wep key, length an</span>
<span class="cm"> * index and send it down the wire.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">keylen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">?</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">13</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">WEP_KEY_INFO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_wep_key</span><span class="p">),</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">ipw2100_wep_key</span> <span class="o">*</span><span class="n">wep_key</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">.</span><span class="n">host_command_parameters</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;WEP_KEY_INFO: index = %d, len = %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">idx</span><span class="p">,</span> <span class="n">keylen</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* NOTE: We don&#39;t check cached values in case the firmware was reset</span>
<span class="cm">	 * or some other problem is occurring.  If the user is setting the key,</span>
<span class="cm">	 * then we push the change */</span>

	<span class="n">wep_key</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">wep_key</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">keylen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wep_key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wep_key</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">keylen</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Will be optimized out on debug not being configured in */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keylen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_WEP</span><span class="p">(</span><span class="s">&quot;%s: Clearing key %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">wep_key</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">keylen</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">IPW_DEBUG_WEP</span><span class="p">(</span><span class="s">&quot;%s: idx: %d, len: %d key: &quot;</span> <span class="n">WEP_FMT_64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">wep_key</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">wep_key</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			      <span class="n">WEP_STR_64</span><span class="p">(</span><span class="n">wep_key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">IPW_DEBUG_WEP</span><span class="p">(</span><span class="s">&quot;%s: idx: %d, len: %d key: &quot;</span> <span class="n">WEP_FMT_128</span>
			      <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">wep_key</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">wep_key</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			      <span class="n">WEP_STR_128</span><span class="p">(</span><span class="n">wep_key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="cm">/* FIXME: IPG: shouldn&#39;t this prink be in _disable_adapter()? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span>
			       <span class="s">&quot;: %s: Could not disable adapter %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* send cmd to firmware */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err2</span> <span class="o">=</span> <span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_key_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">host_command</span> <span class="o">=</span> <span class="n">WEP_KEY_INDEX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">host_command_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">},</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_HC</span><span class="p">(</span><span class="s">&quot;WEP_KEY_INDEX: index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span>
			       <span class="s">&quot;: %s: Could not disable adapter %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* send cmd to firmware */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_hw_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span>
		<span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_configure_security</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">batch_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">auth_mode</span><span class="p">,</span> <span class="n">sec_level</span><span class="p">,</span> <span class="n">use_group</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RUNNING</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span>
		    <span class="n">ipw2100_set_security_information</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_AUTH_OPEN</span><span class="p">,</span>
						     <span class="n">SEC_LEVEL_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">auth_mode</span> <span class="o">=</span> <span class="n">IPW_AUTH_OPEN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_AUTH_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">)</span>
				<span class="n">auth_mode</span> <span class="o">=</span> <span class="n">IPW_AUTH_SHARED</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WLAN_AUTH_LEAP</span><span class="p">)</span>
				<span class="n">auth_mode</span> <span class="o">=</span> <span class="n">IPW_AUTH_LEAP_CISCO_ID</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sec_level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_LEVEL</span><span class="p">)</span>
			<span class="n">sec_level</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>

		<span class="n">use_group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_UNICAST_GROUP</span><span class="p">)</span>
			<span class="n">use_group</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">unicast_uses_group</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span>
		    <span class="n">ipw2100_set_security_information</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">auth_mode</span><span class="p">,</span> <span class="n">sec_level</span><span class="p">,</span>
						     <span class="n">use_group</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WEP_KEY_LEN</span><span class="p">);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span>
						      <span class="n">key_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ipw2100_set_key_index</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Always enable privacy so the Host can filter WEP packets if</span>
<span class="cm">	 * encrypted data is sent up */</span>
	<span class="n">err</span> <span class="o">=</span>
	    <span class="n">ipw2100_set_wep_flags</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span>
				  <span class="n">enabled</span> <span class="o">?</span> <span class="n">IPW_PRIVACY_CAPABLE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_SECURITY_UPDATED</span><span class="p">;</span>

      <span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_mode</span><span class="p">)</span>
		<span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_security_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_priv</span><span class="p">,</span> <span class="n">security_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="cm">/* If we happen to have reconnected before we get a chance to</span>
<span class="cm">	 * process this, then update the security settings--which causes</span>
<span class="cm">	 * a disassociation to occur */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SECURITY_UPDATED</span><span class="p">)</span>
		<span class="n">ipw2100_configure_security</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shim__set_security</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">libipw_security</span> <span class="o">*</span><span class="n">sec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">force_update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">key_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">key_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				       <span class="n">sec</span><span class="o">-&gt;</span><span class="n">key_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">SEC_LEVEL_1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SECURITY_UPDATED</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_ACTIVE_KEY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">active_key</span> <span class="o">!=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">active_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">active_key</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">active_key</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">active_key</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_ACTIVE_KEY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEC_ACTIVE_KEY</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SECURITY_UPDATED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_AUTH_MODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">!=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">auth_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">auth_mode</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_AUTH_MODE</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SECURITY_UPDATED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_ENABLED</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">enabled</span> <span class="o">!=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_ENABLED</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SECURITY_UPDATED</span><span class="p">;</span>
		<span class="n">force_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_ENCRYPT</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">encrypt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEC_LEVEL</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">!=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_SECURITY_UPDATED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_WEP</span><span class="p">(</span><span class="s">&quot;Security flags: %c %c%c%c%c %c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>

<span class="cm">/* As a temporary work around to enable WPA until we figure out why</span>
<span class="cm"> * wpa_supplicant toggles the security capability of the driver, which</span>
<span class="cm"> * forces a disassocation with force_update...</span>
<span class="cm"> *</span>
<span class="cm"> *	if (force_update || !(priv-&gt;status &amp; STATUS_ASSOCIATED))*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUS_ASSOCIATED</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATING</span><span class="p">)))</span>
		<span class="n">ipw2100_configure_security</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_adapter_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">batch_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_disable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">batch_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2100_MONITOR */</span><span class="cp"></span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_read_mac_address</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_mac_address</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">batch_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_port_type</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">,</span> <span class="n">batch_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">batch_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_system_config</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">batch_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_tx_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rates</span><span class="p">,</span> <span class="n">batch_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Default to power mode OFF */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_power_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_POWER_MODE_CAM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_rts_threshold</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_BSSID</span><span class="p">)</span>
		<span class="n">bssid</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bssid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_mandatory_bssid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">batch_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_ESSID</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_essid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">,</span>
					<span class="n">batch_mode</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_essid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">batch_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_configure_security</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">batch_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span>
		    <span class="n">ipw2100_set_ibss_beacon_interval</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
						     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">,</span>
						     <span class="n">batch_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_tx_power</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	   err = ipw2100_set_fragmentation_threshold(</span>
<span class="cm">	   priv, priv-&gt;frag_threshold, batch_mode);</span>
<span class="cm">	   if (err)</span>
<span class="cm">	   return err;</span>
<span class="cm">	 */</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * EXTERNALLY CALLED METHODS</span>
<span class="cm"> *</span>
<span class="cm"> *************************************************************************/</span>

<span class="cm">/* This method is called by the network layer -- not to be confused with</span>
<span class="cm"> * ipw2100_set_mac_address() declared above called by this driver (and this</span>
<span class="cm"> * method as well) to talk to the firmware */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_set_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_CUSTOM_MAC</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_mac_address</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_backoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="n">ipw2100_reset_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;dev-&gt;open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_tx_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Flush the TX queue ... */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pend_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">element</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pend_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_tx_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
		<span class="n">DEC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pend_stat</span><span class="p">);</span>

		<span class="n">libipw_txb_free</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span><span class="p">);</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">d_struct</span><span class="p">.</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_list</span><span class="p">);</span>
		<span class="n">INC_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_stat</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TODO:  Fix this function... its just wrong</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: TX timed out.  Scheduling firmware restart.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">schedule_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wpa_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is called when wpa_supplicant loads and closes the driver</span>
<span class="cm">	 * interface. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_enabled</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wpa_set_auth_algs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">libipw_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">libipw_security</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SEC_AUTH_MODE</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_SHARED_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_OPEN_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_LEAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WLAN_AUTH_LEAP</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_wpa_assoc_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="kt">char</span> <span class="o">*</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wpa_ie_len</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ipw2100_wpa_assoc_frame</span> <span class="n">frame</span><span class="p">;</span>

	<span class="n">frame</span><span class="p">.</span><span class="n">fixed_ie_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* copy WPA IE */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">var_ie</span><span class="p">,</span> <span class="n">wpa_ie</span><span class="p">,</span> <span class="n">wpa_ie_len</span><span class="p">);</span>
	<span class="n">frame</span><span class="p">.</span><span class="n">var_ie_len</span> <span class="o">=</span> <span class="n">wpa_ie_len</span><span class="p">;</span>

	<span class="cm">/* make sure WPA is enabled */</span>
	<span class="n">ipw2100_wpa_enable</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ipw2100_set_wpa_ie</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw_ethtool_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">fw_ver</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">ucode_ver</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>

	<span class="n">ipw2100_get_fwversion</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fw_ver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_ver</span><span class="p">));</span>
	<span class="n">ipw2100_get_ucodeversion</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ucode_ver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ucode_ver</span><span class="p">));</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span> <span class="s">&quot;%s:%d:%s&quot;</span><span class="p">,</span>
		 <span class="n">fw_ver</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_version</span><span class="p">,</span> <span class="n">ucode_ver</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ipw2100_ethtool_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ipw2100_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ipw2100_ethtool_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">ipw_ethtool_get_drvinfo</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_hang_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_priv</span><span class="p">,</span> <span class="n">hang_check</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rtc</span> <span class="o">=</span> <span class="mh">0xa5a5a5a5</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If fatal_error is set then we need to restart */</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Hardware fatal error detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_RTC_TIME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">rtc</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rtc</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check if firmware is hung */</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Firmware RTC stalled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Kill timer */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_hang_check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hangs</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Restart the NIC */</span>
		<span class="n">schedule_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rtc</span> <span class="o">=</span> <span class="n">rtc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_hang_check</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hang_check</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_rf_kill</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_priv</span><span class="p">,</span> <span class="n">rf_kill</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rf_kill_active</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_RF_KILL</span><span class="p">(</span><span class="s">&quot;RF Kill active, rescheduling GPIO check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_rf_kill</span><span class="p">)</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">,</span>
					      <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">HZ</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* RF Kill is now disabled, so bring the device back up */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_RF_KILL</span><span class="p">(</span><span class="s">&quot;HW RF Kill no longer active, restarting &quot;</span>
				  <span class="s">&quot;device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">schedule_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">IPW_DEBUG_RF_KILL</span><span class="p">(</span><span class="s">&quot;HW RF Kill deactivated.  SW RF Kill still &quot;</span>
				  <span class="s">&quot;enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

      <span class="nl">exit_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ipw2100_irq_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ipw2100_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ipw2100_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ipw2100_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">libipw_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">libipw_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">ipw2100_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">ipw2100_set_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Look into using netdev destructor to shutdown libipw? */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">ipw2100_alloc_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span>
					       <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_libipw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hard_start_xmit</span> <span class="o">=</span> <span class="n">ipw2100_tx</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span> <span class="o">=</span> <span class="n">shim__set_security</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">perfect_rssi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">20</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">worst_rssi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">85</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipw2100_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipw2100_ethtool_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipw2100_wx_handler_def</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">.</span><span class="n">libipw</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* NOTE: We don&#39;t use the wireless_handlers hook</span>
<span class="cm">	 * in dev as the system will start throwing WX requests</span>
<span class="cm">	 * to us before we&#39;re actually initialized and it just</span>
<span class="cm">	 * ends up causing problems.  So, we just handle</span>
<span class="cm">	 * the WX extensions through the ipw2100_ioctl interface */</span>

	<span class="cm">/* memset() puts everything to 0, so we only have explicitly set</span>
<span class="cm">	 * those values that need to be something else */</span>

	<span class="cm">/* If power management is turned on, default to AUTO mode */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">IPW_POWER_AUTO</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_CRC_CHECK</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee802_1x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Set module parameters */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">network_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_MONITOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_RF_KILL_SW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">REG_MIN_CHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="n">REG_MAX_CHANNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_STATIC_CHANNEL</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">associate</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_ASSOCIATE</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">DEFAULT_BEACON_INTERVAL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span> <span class="o">=</span> <span class="n">DEFAULT_SHORT_RETRY_LIMIT</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span> <span class="o">=</span> <span class="n">DEFAULT_LONG_RETRY_LIMIT</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">DEFAULT_RTS_THRESHOLD</span> <span class="o">|</span> <span class="n">RTS_DISABLED</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_threshold</span> <span class="o">=</span> <span class="n">DEFAULT_FTS</span> <span class="o">|</span> <span class="n">FRAG_DISABLED</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power</span> <span class="o">=</span> <span class="n">IPW_TX_POWER_DEFAULT</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rates</span> <span class="o">=</span> <span class="n">DEFAULT_TX_RATES</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">,</span> <span class="s">&quot;ipw2100&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">low_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter_mutex</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_free_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_pend_list</span><span class="p">);</span>
	<span class="n">INIT_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_free_stat</span><span class="p">);</span>
	<span class="n">INIT_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_pend_stat</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pend_list</span><span class="p">);</span>
	<span class="n">INIT_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_stat</span><span class="p">);</span>
	<span class="n">INIT_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pend_stat</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pend_list</span><span class="p">);</span>
	<span class="n">INIT_STAT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pend_stat</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">,</span> <span class="n">ipw2100_reset_adapter</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">security_work</span><span class="p">,</span> <span class="n">ipw2100_security_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_event_work</span><span class="p">,</span> <span class="n">ipw2100_wx_event_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hang_check</span><span class="p">,</span> <span class="n">ipw2100_hang_check</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">,</span> <span class="n">ipw2100_rf_kill</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event_now</span><span class="p">,</span> <span class="n">ipw2100_scan_event_now</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_event_later</span><span class="p">,</span> <span class="n">ipw2100_scan_event_later</span><span class="p">);</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span>
		     <span class="n">ipw2100_irq_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* NOTE:  We do not start the deferred work for status checks yet */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_rf_kill</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_hang_check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_pci_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;weird - resource type is not memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;Error calling ioremap_nocache.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate and initialize our net_device */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ipw2100_alloc_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;Error calling ipw2100_alloc_device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up PCI mappings for device */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;Error calling pci_enable_device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;Error calling pci_set_dma_mask.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;Error calling pci_request_regions.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We disable the RETRY_TIMEOUT register (0x41) to keep</span>
<span class="cm">	 * PCI Tx retries from interfering with C3 CPU state */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff00ff</span><span class="p">);</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipw2100_hw_is_adapter_in_system</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;Device not found via register read.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Force interrupts to be shut off on the device */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_INT_ENABLED</span><span class="p">;</span>
	<span class="n">ipw2100_disable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Allocate and initialize the Tx/Rx queues and lists */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_queues_allocate</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;Error calling ipw2100_queues_allocate.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ipw2100_queues_initialize</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			  <span class="n">ipw2100_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;Error calling request_irq: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Attempting to register device...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span>
	       <span class="s">&quot;: Detected Intel PRO/Wireless 2100 Network Connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_up</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_wdev_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Bring up the interface.  Pre 0.46, after we registered the</span>
<span class="cm">	 * network device we would call ipw2100_up.  This introduced a race</span>
<span class="cm">	 * condition with newer hotplug configurations (network was coming</span>
<span class="cm">	 * up and making calls before the device was initialized).</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;Error calling register_netdev.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">registered</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Bound to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">));</span>

	<span class="cm">/* perform this after register_netdev so that dev-&gt;name is set */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw2100_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_unlock</span><span class="p">;</span>

	<span class="cm">/* If the RF Kill switch is disabled, go ahead and complete the</span>
<span class="cm">	 * startup sequence */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Enable the adapter - sends HOST_COMPLETE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_enable_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span>
			       <span class="s">&quot;: %s: failed in call to enable adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ipw2100_hw_stop_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Start a scan . . . */</span>
		<span class="n">ipw2100_set_scan_options</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">ipw2100_start_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_INITIALIZED</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

      <span class="nl">fail_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
      <span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">registered</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">registered</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_unregister</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bg_band</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ipw2100_hw_stop_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="n">ipw2100_disable_interrupts</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

		<span class="n">ipw2100_kill_works</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="cm">/* These are safe to call even if they weren&#39;t allocated */</span>
		<span class="n">ipw2100_queues_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ipw2100_attribute_group</span><span class="p">);</span>

		<span class="n">free_libipw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">ipw2100_pci_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_INITIALIZED</span><span class="p">;</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw2100_attribute_group</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_firmware</span><span class="p">.</span><span class="n">version</span><span class="p">)</span>
		<span class="n">ipw2100_release_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipw2100_firmware</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Take down the hardware */</span>
	<span class="n">ipw2100_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Release the mutex so that the network subsystem can</span>
<span class="cm">	 * complete any needed calls into the driver... */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>

	<span class="cm">/* Unregister the device first - this results in close()</span>
<span class="cm">	 * being called if the device is open.  If we free storage</span>
<span class="cm">	 * first, then close() will crash.</span>
<span class="cm">	 * FIXME: remove the comment above. */</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ipw2100_kill_works</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">ipw2100_queues_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Free potential debugging firmware snapshot */</span>
	<span class="n">ipw2100_snapshot_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* wiphy_unregister needs to be here, before free_libipw */</span>
	<span class="n">wiphy_unregister</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bg_band</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">free_libipw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Going into suspend...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Take down the device; powers it off, etc. */</span>
		<span class="n">ipw2100_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Remove the PRESENT state of the device */</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">suspend_at</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IPW2100_PM_DISABLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Coming out of suspend...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: pci_enable_device failed on resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Suspend/Resume resets the PCI configuration space, so we have to</span>
<span class="cm">	 * re-disable the RETRY_TIMEOUT register (0x41) to keep PCI Tx retries</span>
<span class="cm">	 * from interfering with C3 CPU state. pci_restore_state won&#39;t help</span>
<span class="cm">	 * here since it only restores the first 64 bytes pci config header.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff00ff</span><span class="p">);</span>

	<span class="cm">/* Set the device back into the PRESENT state; this will also wake</span>
<span class="cm">	 * the queue of needed */</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">suspend_time</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">suspend_at</span><span class="p">;</span>

	<span class="cm">/* Bring the device back up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_SW</span><span class="p">))</span>
		<span class="n">ipw2100_up</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="cm">/* Take down the device; powers it off, etc. */</span>
	<span class="n">ipw2100_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define IPW2100_DEV_ID(x) { PCI_VENDOR_ID_INTEL, 0x1043, 0x8086, x }</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">ipw2100_pci_id_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2520</span><span class="p">),</span>	<span class="cm">/* IN 2100A mPCI 3A */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2521</span><span class="p">),</span>	<span class="cm">/* IN 2100A mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2524</span><span class="p">),</span>	<span class="cm">/* IN 2100A mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2525</span><span class="p">),</span>	<span class="cm">/* IN 2100A mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2526</span><span class="p">),</span>	<span class="cm">/* IN 2100A mPCI Gen A3 */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2522</span><span class="p">),</span>	<span class="cm">/* IN 2100 mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2523</span><span class="p">),</span>	<span class="cm">/* IN 2100 mPCI 3A */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2527</span><span class="p">),</span>	<span class="cm">/* IN 2100 mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2528</span><span class="p">),</span>	<span class="cm">/* IN 2100 mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2529</span><span class="p">),</span>	<span class="cm">/* IN 2100 mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x252B</span><span class="p">),</span>	<span class="cm">/* IN 2100 mPCI 3A */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x252C</span><span class="p">),</span>	<span class="cm">/* IN 2100 mPCI 3A */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x252D</span><span class="p">),</span>	<span class="cm">/* IN 2100 mPCI 3A */</span>

	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2550</span><span class="p">),</span>	<span class="cm">/* IB 2100A mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2551</span><span class="p">),</span>	<span class="cm">/* IB 2100 mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2553</span><span class="p">),</span>	<span class="cm">/* IB 2100 mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2554</span><span class="p">),</span>	<span class="cm">/* IB 2100 mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2555</span><span class="p">),</span>	<span class="cm">/* IB 2100 mPCI 3B */</span>

	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2560</span><span class="p">),</span>	<span class="cm">/* DE 2100A mPCI 3A */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2562</span><span class="p">),</span>	<span class="cm">/* DE 2100A mPCI 3A */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2563</span><span class="p">),</span>	<span class="cm">/* DE 2100A mPCI 3A */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2561</span><span class="p">),</span>	<span class="cm">/* DE 2100 mPCI 3A */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2565</span><span class="p">),</span>	<span class="cm">/* DE 2100 mPCI 3A */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2566</span><span class="p">),</span>	<span class="cm">/* DE 2100 mPCI 3A */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2567</span><span class="p">),</span>	<span class="cm">/* DE 2100 mPCI 3A */</span>

	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2570</span><span class="p">),</span>	<span class="cm">/* GA 2100 mPCI 3B */</span>

	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2580</span><span class="p">),</span>	<span class="cm">/* TO 2100A mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2582</span><span class="p">),</span>	<span class="cm">/* TO 2100A mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2583</span><span class="p">),</span>	<span class="cm">/* TO 2100A mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2581</span><span class="p">),</span>	<span class="cm">/* TO 2100 mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2585</span><span class="p">),</span>	<span class="cm">/* TO 2100 mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2586</span><span class="p">),</span>	<span class="cm">/* TO 2100 mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2587</span><span class="p">),</span>	<span class="cm">/* TO 2100 mPCI 3B */</span>

	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2590</span><span class="p">),</span>	<span class="cm">/* SO 2100A mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2592</span><span class="p">),</span>	<span class="cm">/* SO 2100A mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2591</span><span class="p">),</span>	<span class="cm">/* SO 2100 mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2593</span><span class="p">),</span>	<span class="cm">/* SO 2100 mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2596</span><span class="p">),</span>	<span class="cm">/* SO 2100 mPCI 3B */</span>
	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x2598</span><span class="p">),</span>	<span class="cm">/* SO 2100 mPCI 3B */</span>

	<span class="n">IPW2100_DEV_ID</span><span class="p">(</span><span class="mh">0x25A0</span><span class="p">),</span>	<span class="cm">/* HP 2100 mPCI 3B */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ipw2100_pci_id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">ipw2100_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ipw2100_pci_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ipw2100_pci_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ipw2100_pci_remove_one</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ipw2100_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ipw2100_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">ipw2100_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Initialize the ipw2100 driver/module</span>
<span class="cm"> *</span>
<span class="cm"> * @returns 0 if ok, &lt; 0 errno node con error.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: we cannot init the /proc stuff until the PCI driver is there,</span>
<span class="cm"> * or we risk an unlikely race condition on someone accessing</span>
<span class="cm"> * uninitialized data in the PCI dev struct through /proc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ipw2100_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_DESCRIPTION</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_COPYRIGHT</span><span class="p">);</span>

	<span class="n">pm_qos_add_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipw2100_pm_qos_req</span><span class="p">,</span> <span class="n">PM_QOS_CPU_DMA_LATENCY</span><span class="p">,</span>
			   <span class="n">PM_QOS_DEFAULT_VALUE</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipw2100_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
	<span class="n">ipw2100_debug_level</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipw2100_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">driver_attr_debug_level</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Cleanup ipw2100 driver registration</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ipw2100_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: IPG: check that we have no instances of the devices open */</span>
<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipw2100_pci_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_debug_level</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipw2100_pci_driver</span><span class="p">);</span>
	<span class="n">pm_qos_remove_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipw2100_pm_qos_req</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ipw2100_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ipw2100_exit</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;unassociated&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;IEEE 802.11b&quot;</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">fwrq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if setting by freq convert to channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="mf">2.412e8</span> <span class="o">&amp;&amp;</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="mf">2.487e8</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">&lt;</span> <span class="n">REG_MAX_CHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="n">ipw2100_frequencies</span><span class="p">[</span><span class="n">c</span><span class="p">]))</span>
				<span class="n">c</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* hack to fall through */</span>
			<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Set the channel */</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Freq/Channel -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If we are associated, trying to associate, or have a statically</span>
<span class="cm">	 * configured CHANNEL then return that; otherwise return ANY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_CHANNEL</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET Freq/Channel -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Mode -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
	<span class="k">case</span> <span class="n">IW_MODE_MONITOR</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_switch_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IW_MODE_MONITOR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2100_MONITOR */</span><span class="cp"></span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_switch_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IW_MODE_ADHOC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
	<span class="k">case</span> <span class="n">IW_MODE_AUTO</span>:
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_switch_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IW_MODE_INFRA</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">;</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET Mode -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define POWER_MODES 5</span>

<span class="cm">/* Values are in microsecond */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">s32</span> <span class="n">timeout_duration</span><span class="p">[</span><span class="n">POWER_MODES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">350000</span><span class="p">,</span>
	<span class="mi">250000</span><span class="p">,</span>
	<span class="mi">75000</span><span class="p">,</span>
	<span class="mi">37000</span><span class="p">,</span>
	<span class="mi">25000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s32</span> <span class="n">period_duration</span><span class="p">[</span><span class="n">POWER_MODES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">400000</span><span class="p">,</span>
	<span class="mi">700000</span><span class="p">,</span>
	<span class="mi">1000000</span><span class="p">,</span>
	<span class="mi">1000000</span><span class="p">,</span>
	<span class="mi">1000000</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span><span class="p">;</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">range</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">range</span><span class="p">));</span>

	<span class="cm">/* Let&#39;s try to keep this struct in the same order as in</span>
<span class="cm">	 * linux/include/wireless.h</span>
<span class="cm">	 */</span>

	<span class="cm">/* TODO: See what values we can set, and remove the ones we can&#39;t</span>
<span class="cm">	 * set, or fill them with some default data.</span>
<span class="cm">	 */</span>

	<span class="cm">/* ~5 Mb/s real (802.11b) */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><pre><code> range-&gt;sensitivity;     /* signal level threshold range */
</code></pre></td><td class="code"><div class="highlight"><pre>	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="cm">/* TODO: Find real max RSSI and stick here */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>	<span class="cm">/* Updated all three */</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>	<span class="cm">/* &gt; 8% missed beacons is &#39;bad&#39; */</span>
	<span class="cm">/* TODO: Find real &#39;good&#39; to &#39;bad&#39; threshold value for RSSI */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">IPW2100_RSSI_TO_DBM</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>	<span class="cm">/* Updated all three */</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span> <span class="o">=</span> <span class="n">RATE_COUNT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IW_MAX_BITRATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipw2100_bg_rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_rts</span> <span class="o">=</span> <span class="n">MIN_RTS_THRESHOLD</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_rts</span> <span class="o">=</span> <span class="n">MAX_RTS_THRESHOLD</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_frag</span> <span class="o">=</span> <span class="n">MIN_FRAG_THRESHOLD</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_frag</span> <span class="o">=</span> <span class="n">MAX_FRAG_THRESHOLD</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_pmp</span> <span class="o">=</span> <span class="n">period_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* Minimal PM period */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_pmp</span> <span class="o">=</span> <span class="n">period_duration</span><span class="p">[</span><span class="n">POWER_MODES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>	<span class="cm">/* Maximal PM period */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_pmt</span> <span class="o">=</span> <span class="n">timeout_duration</span><span class="p">[</span><span class="n">POWER_MODES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>	<span class="cm">/* Minimal PM timeout */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_pmt</span> <span class="o">=</span> <span class="n">timeout_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* Maximal PM timeout */</span>

	<span class="cm">/* How to decode max/min PM period */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">pmp_flags</span> <span class="o">=</span> <span class="n">IW_POWER_PERIOD</span><span class="p">;</span>
	<span class="cm">/* How to decode max/min PM period */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">pmt_flags</span> <span class="o">=</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">;</span>
	<span class="cm">/* What PM options are supported */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">pm_capa</span> <span class="o">=</span> <span class="n">IW_POWER_TIMEOUT</span> <span class="o">|</span> <span class="n">IW_POWER_PERIOD</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>	<span class="cm">/* Different token sizes */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_encoding_sizes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Number of entry in the list */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_encoding_tokens</span> <span class="o">=</span> <span class="n">WEP_KEYS</span><span class="p">;</span>	<span class="cm">/* Max number of tokens */</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><pre><code> range-&gt;encoding_login_index;            /* token index for login token */
</code></pre></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">txpower_capa</span> <span class="o">=</span> <span class="n">IW_TXPOW_DBM</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_txpower</span> <span class="o">=</span> <span class="n">IW_MAX_TXPOWER</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="p">(</span><span class="n">IPW_TX_POWER_MAX_DBM</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IW_MAX_TXPOWER</span><span class="p">;</span>
		     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">level</span> <span class="o">-=</span>
		     <span class="p">((</span><span class="n">IPW_TX_POWER_MAX_DBM</span> <span class="o">-</span>
		       <span class="n">IPW_TX_POWER_MIN_DBM</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">IW_MAX_TXPOWER</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">txpower_capa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_txpower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the Wireless Extension versions */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_compiled</span> <span class="o">=</span> <span class="n">WIRELESS_EXT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_source</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><pre><code> range-&gt;retry_capa;      /* What retry options are supported */
 range-&gt;retry_flags;     /* How to decode max/min retry limit */
 range-&gt;r_time_flags;    /* How to decode max/min retry life */
 range-&gt;min_retry;       /* Minimal number of retries */
 range-&gt;max_retry;       /* Maximal number of retries */
 range-&gt;min_r_time;      /* Minimal retry lifetime */
 range-&gt;max_r_time;      /* Maximal retry lifetime */
</code></pre></td><td class="code"><div class="highlight"><pre>	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">FREQ_COUNT</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FREQ_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>TODO: Include only legal frequencies for some countries
             if (local->channel_mask &amp; (1 &lt;&lt; i)) {</p></td><td class="code"><div class="highlight"><pre>		<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">m</span> <span class="o">=</span> <span class="n">ipw2100_frequencies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">val</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><pre><code>         }
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">IW_MAX_FREQUENCIES</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_frequency</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Event capability (kernel + driver) */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">IW_EVENT_CAPA_K_0</span> <span class="o">|</span>
				<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">SIOCGIWAP</span><span class="p">));</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IW_EVENT_CAPA_K_1</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">enc_capa</span> <span class="o">=</span> <span class="n">IW_ENC_CAPA_WPA</span> <span class="o">|</span> <span class="n">IW_ENC_CAPA_WPA2</span> <span class="o">|</span>
		<span class="n">IW_ENC_CAPA_CIPHER_TKIP</span> <span class="o">|</span> <span class="n">IW_ENC_CAPA_CIPHER_CCMP</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET Range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">any</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">off</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>sanity checks</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">any</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* we disable mandatory BSSID association */</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;exit - disable mandatory BSSID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_STATIC_BSSID</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_mandatory_bssid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_STATIC_BSSID</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mandatory_bssid_mac</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_mandatory_bssid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET BSSID -&gt; %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">);</span>

      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* If we are associated, trying to associate, or have a statically</span>
<span class="cm">	 * configured BSSID then return that; otherwise return ANY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_BSSID</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Getting WAP BSSID: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">essid</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>	<span class="cm">/* ANY */</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;&amp;</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="n">essid</span> <span class="o">=</span> <span class="n">extra</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Setting ESSID to ANY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_STATIC_ESSID</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_essid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_STATIC_ESSID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">==</span> <span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;ESSID set to current ESSID.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Setting ESSID: &#39;%s&#39; (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="n">length</span><span class="p">),</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_essid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>

	<span class="cm">/* If we are associated, trying to associate, or have a statically</span>
<span class="cm">	 * configured ESSID then return that; otherwise return ANY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_ESSID</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Getting essid: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* active */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Getting essid: ANY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* active */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_nick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Nickname -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_nick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* active */</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET Nickname -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">target_rate</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">1000000</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span> <span class="o">&amp;&amp;</span> <span class="n">target_rate</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">))</span>
		<span class="n">rate</span> <span class="o">|=</span> <span class="n">TX_RATE_1_MBIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">2000000</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span> <span class="o">&amp;&amp;</span> <span class="n">target_rate</span> <span class="o">&gt;</span> <span class="mi">2000000</span><span class="p">))</span>
		<span class="n">rate</span> <span class="o">|=</span> <span class="n">TX_RATE_2_MBIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">5500000</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span> <span class="o">&amp;&amp;</span> <span class="n">target_rate</span> <span class="o">&gt;</span> <span class="mi">5500000</span><span class="p">))</span>
		<span class="n">rate</span> <span class="o">|=</span> <span class="n">TX_RATE_5_5_MBIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="mi">11000000</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span> <span class="o">&amp;&amp;</span> <span class="n">target_rate</span> <span class="o">&gt;</span> <span class="mi">11000000</span><span class="p">))</span>
		<span class="n">rate</span> <span class="o">|=</span> <span class="n">TX_RATE_11_MBIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">DEFAULT_TX_RATES</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_tx_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Rate -&gt; %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ENABLED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_CURRENT_TX_RATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;failed querying ordinals.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TX_RATE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TX_RATE_1_MBIT</span>:
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_RATE_2_MBIT</span>:
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_RATE_5_5_MBIT</span>:
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">5500000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_RATE_11_MBIT</span>:
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">11000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET Rate -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>

      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Auto RTS not yet supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">fixed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">|</span> <span class="n">RTS_DISABLED</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">2304</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_rts_threshold</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET RTS Threshold -&gt; 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RTS_DISABLED</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* no auto select */</span>

	<span class="cm">/* If RTS is set to the default value, then it is disabled */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">&amp;</span> <span class="n">RTS_DISABLED</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET RTS Threshold -&gt; 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_txpow</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw_radio_kill_sw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">disabled</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_TXPOW_TYPE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IW_TXPOW_DBM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">fixed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">IPW_TX_POWER_DEFAULT</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">IPW_TX_POWER_MIN_DBM</span> <span class="o">||</span>
		    <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">IPW_TX_POWER_MAX_DBM</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_tx_power</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET TX Power -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_txpow</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power</span> <span class="o">==</span> <span class="n">IPW_TX_POWER_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">IPW_TX_POWER_MAX_DBM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_TXPOW_DBM</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET TX Power -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">fixed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_threshold</span> <span class="o">|=</span> <span class="n">FRAG_DISABLED</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">fts</span> <span class="o">=</span> <span class="n">DEFAULT_FTS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">MIN_FRAG_THRESHOLD</span> <span class="o">||</span>
		    <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">MAX_FRAG_THRESHOLD</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">fts</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_threshold</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">fts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Frag Threshold -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">fts</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_threshold</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FRAG_DISABLED</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no auto select */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_threshold</span> <span class="o">&amp;</span> <span class="n">FRAG_DISABLED</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET Frag Threshold -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LIFETIME</span> <span class="o">||</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_SHORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_short_retry</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Short Retry Limit -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LONG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_long_retry</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Long Retry Limit -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_short_retry</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_long_retry</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Both Retry Limits -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>

      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* can&#39;t be disabled */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LONG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_LONG</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span> <span class="o">!=</span>
		     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_SHORT</span> <span class="o">:</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">;</span>

		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET Retry -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Initiating scan...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">user_requested_scan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_set_scan_options</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">||</span> <span class="n">ipw2100_start_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Start scan failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* TODO: Mark a scan as pending so when hardware initialized</span>
<span class="cm">		 *       a scan starts */</span>
	<span class="p">}</span>

      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">libipw_wx_get_scan</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Implementation based on code in hostap-driver v0.1.3 hostap_ioctl.c</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * No check of STATUS_INITIALIZED required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">libipw_wx_set_encode</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">libipw_wx_get_encode</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">IPW_POWER_LEVEL</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_power_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_POWER_MODE_CAM</span><span class="p">);</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Power Management Mode -&gt; off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_MODE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_POWER_ON</span>:	<span class="cm">/* If not specified */</span>
	<span class="k">case</span> <span class="n">IW_POWER_MODE</span>:	<span class="cm">/* If set all mask */</span>
	<span class="k">case</span> <span class="n">IW_POWER_ALL_R</span>:	<span class="cm">/* If explicitly state all */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* Otherwise we don&#39;t support it */</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET PM Mode: %X not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If the user hasn&#39;t specified a power management mode yet, default</span>
<span class="cm">	 * to BATTERY */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">IPW_POWER_ENABLED</span> <span class="o">|</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_power_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_POWER_LEVEL</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">));</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;SET Power Management Mode -&gt; 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">);</span>

      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">&amp;</span> <span class="n">IPW_POWER_ENABLED</span><span class="p">))</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;GET Power Management Mode -&gt; %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * WE-18 WPA support</span>
<span class="cm"> */</span>

<span class="cm">/* SIOCSIWGENIE */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_genie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">libipw_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">MAX_WPA_IE_LEN</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">extra</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipw2100_wpa_assoc_frame</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SIOCGIWGENIE */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_genie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">libipw_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SIOCSIWAUTH */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">libipw_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * ipw2200 does not use these parameters</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_TKIP_COUNTERMEASURES</span>:
		<span class="n">crypt</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt</span> <span class="o">||</span> <span class="o">!</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_flags</span> <span class="o">||</span> <span class="o">!</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_flags</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_flags</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_CRYPTO_TKIP_COUNTERMEASURES</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_CRYPTO_TKIP_COUNTERMEASURES</span><span class="p">;</span>

		<span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:<span class="p">{</span>
			<span class="cm">/* HACK:</span>
<span class="cm">			 *</span>
<span class="cm">			 * wpa_supplicant calls set_wpa_enabled when the driver</span>
<span class="cm">			 * is loaded and unloaded, regardless of if WPA is being</span>
<span class="cm">			 * used.  No other calls are made which can be used to</span>
<span class="cm">			 * determine if encryption will be used or not prior to</span>
<span class="cm">			 * association being expected.  If encryption is not being</span>
<span class="cm">			 * used, drop_unencrypted is set to false, else true -- we</span>
<span class="cm">			 * can use this to determine if the CAP_PRIVACY_ON bit should</span>
<span class="cm">			 * be set.</span>
<span class="cm">			 */</span>
			<span class="k">struct</span> <span class="n">libipw_security</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SEC_ENABLED</span><span class="p">,</span>
				<span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			<span class="p">};</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
			<span class="cm">/* We only change SEC_LEVEL for open mode. Others</span>
<span class="cm">			 * are set by ipw_wpa_set_encryption.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
				<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
				<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw2100_wpa_set_auth_algs</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ipw2100_wpa_enable</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_RX_UNENCRYPTED_EAPOL</span>:
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee802_1x</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>case IW<em>AUTH</em>ROAMING_CONTROL:</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">IW_AUTH_PRIVACY_INVOKED</span>:
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SIOCGIWAUTH */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">libipw_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * wpa_supplicant will control these internally</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_TKIP_COUNTERMEASURES</span>:
		<span class="n">crypt</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt</span> <span class="o">||</span> <span class="o">!</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPW_DEBUG_WARNING</span><span class="p">(</span><span class="s">&quot;Can&#39;t get TKIP countermeasures: &quot;</span>
					  <span class="s">&quot;crypt not set!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_flags</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">IEEE80211_CRYPTO_TKIP_COUNTERMEASURES</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_enabled</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_RX_UNENCRYPTED_EAPOL</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee802_1x</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_ROAMING_CONTROL</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_PRIVACY_INVOKED</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SIOCSIWENCODEEXT */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">libipw_wx_set_encodeext</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* SIOCGIWENCODEEXT */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">libipw_wx_get_encodeext</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* SIOCSIWMLME */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_mlme</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_mlme</span> <span class="o">*</span><span class="n">mlme</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_mlme</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">reason</span><span class="p">;</span>

	<span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MLME_DEAUTH</span>:</pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>silently ignore</p></td><td class="code"><div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_MLME_DISASSOC</span>:
		<span class="n">ipw2100_disassociate_bssid</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * IWPRIV handlers</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_promisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">parms</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_switch_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IW_MODE_MONITOR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_switch_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_mode</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">)</span>
		<span class="n">schedule_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_powermode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;</span> <span class="n">POWER_MODES</span><span class="p">))</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">IPW_POWER_AUTO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IPW_POWER_LEVEL</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mode</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_set_power_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_POWER_STRING 80</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_powermode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">IPW_POWER_LEVEL</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">);</span>
	<span class="n">s32</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">period</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">&amp;</span> <span class="n">IPW_POWER_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">MAX_POWER_STRING</span><span class="p">,</span>
			 <span class="s">&quot;Power save level: %d (Off)&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IPW_POWER_MODE_CAM</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">MAX_POWER_STRING</span><span class="p">,</span>
				 <span class="s">&quot;Power save level: %d (None)&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPW_POWER_AUTO</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">MAX_POWER_STRING</span><span class="p">,</span>
				 <span class="s">&quot;Power save level: %d (Auto)&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout_duration</span><span class="p">[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">period</span> <span class="o">=</span> <span class="n">period_duration</span><span class="p">[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">MAX_POWER_STRING</span><span class="p">,</span>
				 <span class="s">&quot;Power save level: %d &quot;</span>
				 <span class="s">&quot;(Timeout %dms, Period %dms)&quot;</span><span class="p">,</span>
				 <span class="n">level</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">period</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_preamble</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_LONG_PREAMBLE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_LONG_PREAMBLE</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipw2100_system_config</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_preamble</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_LONG_PREAMBLE</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;long (1)&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;auto (0)&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_set_crc_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">CFG_CRC_CHECK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_CRC_CHECK</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_wx_get_crc_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This can be called at any time.  No action lock required</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_CRC_CHECK</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;CRC checked (1)&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;CRC ignored (0)&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2100_MONITOR */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">iw_handler</span> <span class="n">ipw2100_wx_handlers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWNAME</span><span class="p">,</span> <span class="n">ipw2100_wx_get_name</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWFREQ</span><span class="p">,</span> <span class="n">ipw2100_wx_set_freq</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWFREQ</span><span class="p">,</span> <span class="n">ipw2100_wx_get_freq</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWMODE</span><span class="p">,</span> <span class="n">ipw2100_wx_set_mode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWMODE</span><span class="p">,</span> <span class="n">ipw2100_wx_get_mode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRANGE</span><span class="p">,</span> <span class="n">ipw2100_wx_get_range</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWAP</span><span class="p">,</span> <span class="n">ipw2100_wx_set_wap</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="n">ipw2100_wx_get_wap</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWMLME</span><span class="p">,</span> <span class="n">ipw2100_wx_set_mlme</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWSCAN</span><span class="p">,</span> <span class="n">ipw2100_wx_set_scan</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="n">ipw2100_wx_get_scan</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWESSID</span><span class="p">,</span> <span class="n">ipw2100_wx_set_essid</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWESSID</span><span class="p">,</span> <span class="n">ipw2100_wx_get_essid</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWNICKN</span><span class="p">,</span> <span class="n">ipw2100_wx_set_nick</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWNICKN</span><span class="p">,</span> <span class="n">ipw2100_wx_get_nick</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWRATE</span><span class="p">,</span> <span class="n">ipw2100_wx_set_rate</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRATE</span><span class="p">,</span> <span class="n">ipw2100_wx_get_rate</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWRTS</span><span class="p">,</span> <span class="n">ipw2100_wx_set_rts</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRTS</span><span class="p">,</span> <span class="n">ipw2100_wx_get_rts</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWFRAG</span><span class="p">,</span> <span class="n">ipw2100_wx_set_frag</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWFRAG</span><span class="p">,</span> <span class="n">ipw2100_wx_get_frag</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWTXPOW</span><span class="p">,</span> <span class="n">ipw2100_wx_set_txpow</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWTXPOW</span><span class="p">,</span> <span class="n">ipw2100_wx_get_txpow</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWRETRY</span><span class="p">,</span> <span class="n">ipw2100_wx_set_retry</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRETRY</span><span class="p">,</span> <span class="n">ipw2100_wx_get_retry</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWENCODE</span><span class="p">,</span> <span class="n">ipw2100_wx_set_encode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWENCODE</span><span class="p">,</span> <span class="n">ipw2100_wx_get_encode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWPOWER</span><span class="p">,</span> <span class="n">ipw2100_wx_set_power</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWPOWER</span><span class="p">,</span> <span class="n">ipw2100_wx_get_power</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWGENIE</span><span class="p">,</span> <span class="n">ipw2100_wx_set_genie</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWGENIE</span><span class="p">,</span> <span class="n">ipw2100_wx_get_genie</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWAUTH</span><span class="p">,</span> <span class="n">ipw2100_wx_set_auth</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWAUTH</span><span class="p">,</span> <span class="n">ipw2100_wx_get_auth</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWENCODEEXT</span><span class="p">,</span> <span class="n">ipw2100_wx_set_encodeext</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWENCODEEXT</span><span class="p">,</span> <span class="n">ipw2100_wx_get_encodeext</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define IPW2100_PRIV_SET_MONITOR	SIOCIWFIRSTPRIV</span>
<span class="cp">#define IPW2100_PRIV_RESET		SIOCIWFIRSTPRIV+1</span>
<span class="cp">#define IPW2100_PRIV_SET_POWER		SIOCIWFIRSTPRIV+2</span>
<span class="cp">#define IPW2100_PRIV_GET_POWER		SIOCIWFIRSTPRIV+3</span>
<span class="cp">#define IPW2100_PRIV_SET_LONGPREAMBLE	SIOCIWFIRSTPRIV+4</span>
<span class="cp">#define IPW2100_PRIV_GET_LONGPREAMBLE	SIOCIWFIRSTPRIV+5</span>
<span class="cp">#define IPW2100_PRIV_SET_CRC_CHECK	SIOCIWFIRSTPRIV+6</span>
<span class="cp">#define IPW2100_PRIV_GET_CRC_CHECK	SIOCIWFIRSTPRIV+7</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="n">ipw2100_private_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
	<span class="p">{</span>
	 <span class="n">IPW2100_PRIV_SET_MONITOR</span><span class="p">,</span>
	 <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;monitor&quot;</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="n">IPW2100_PRIV_RESET</span><span class="p">,</span>
	 <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span><span class="p">},</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2100_MONITOR */</span><span class="cp"></span>

	<span class="p">{</span>
	 <span class="n">IPW2100_PRIV_SET_POWER</span><span class="p">,</span>
	 <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;set_power&quot;</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="n">IPW2100_PRIV_GET_POWER</span><span class="p">,</span>
	 <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_CHAR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="n">MAX_POWER_STRING</span><span class="p">,</span>
	 <span class="s">&quot;get_power&quot;</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="n">IPW2100_PRIV_SET_LONGPREAMBLE</span><span class="p">,</span>
	 <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;set_preamble&quot;</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="n">IPW2100_PRIV_GET_LONGPREAMBLE</span><span class="p">,</span>
	 <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_CHAR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;get_preamble&quot;</span><span class="p">},</span>
<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
	<span class="p">{</span>
	 <span class="n">IPW2100_PRIV_SET_CRC_CHECK</span><span class="p">,</span>
	 <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;set_crc_check&quot;</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="n">IPW2100_PRIV_GET_CRC_CHECK</span><span class="p">,</span>
	 <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_CHAR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;get_crc_check&quot;</span><span class="p">},</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2100_MONITOR */</span><span class="cp"></span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">iw_handler</span> <span class="n">ipw2100_private_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
	<span class="n">ipw2100_wx_set_promisc</span><span class="p">,</span>
	<span class="n">ipw2100_wx_reset</span><span class="p">,</span>
<span class="cp">#else				</span><span class="cm">/* CONFIG_IPW2100_MONITOR */</span><span class="cp"></span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2100_MONITOR */</span><span class="cp"></span>
	<span class="n">ipw2100_wx_set_powermode</span><span class="p">,</span>
	<span class="n">ipw2100_wx_get_powermode</span><span class="p">,</span>
	<span class="n">ipw2100_wx_set_preamble</span><span class="p">,</span>
	<span class="n">ipw2100_wx_get_preamble</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
	<span class="n">ipw2100_wx_set_crc_check</span><span class="p">,</span>
	<span class="n">ipw2100_wx_get_crc_check</span><span class="p">,</span>
<span class="cp">#else				</span><span class="cm">/* CONFIG_IPW2100_MONITOR */</span><span class="cp"></span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_IPW2100_MONITOR */</span><span class="cp"></span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Get wireless statistics.</span>
<span class="cm"> * Called by /proc/net/wireless</span>
<span class="cm"> * Also called by SIOCGIWSTATS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="nf">ipw2100_wx_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">POOR</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
		<span class="n">FAIR</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="n">GOOD</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
		<span class="n">VERY_GOOD</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
		<span class="n">EXCELLENT</span> <span class="o">=</span> <span class="mi">95</span><span class="p">,</span>
		<span class="n">PERFECT</span> <span class="o">=</span> <span class="mi">100</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">rssi_qual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_qual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">beacon_qual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quality</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">libipw_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">wstats</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rssi</span><span class="p">,</span> <span class="n">tx_retries</span><span class="p">,</span> <span class="n">missed_beacons</span><span class="p">,</span> <span class="n">tx_failures</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ord_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>

	<span class="n">wstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">;</span>

	<span class="cm">/* if hw is disabled, then ipw2100_get_ordinal() can&#39;t be called.</span>
<span class="cm">	 * ipw2100_wx_wireless_stats seems to be called before fw is</span>
<span class="cm">	 * initialized.  STATUS_ASSOCIATED will only be set if the hw is up</span>
<span class="cm">	 * and associated; if not associcated, the values are all meaningless</span>
<span class="cm">	 * anyway, so set them all to NULL and INVALID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">miss</span><span class="p">.</span><span class="n">beacon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">|=</span> <span class="n">IW_QUAL_NOISE_INVALID</span> <span class="o">|</span>
		    <span class="n">IW_QUAL_QUAL_INVALID</span> <span class="o">|</span> <span class="n">IW_QUAL_LEVEL_INVALID</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">wstats</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_PERCENT_MISSED_BCNS</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">missed_beacons</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ord_len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_get_ordinal</span><span class="p">;</span>

	<span class="cm">/* If we don&#39;t have a connection the quality and level is 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_RSSI_AVG_CURR</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">rssi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ord_len</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail_get_ordinal</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">rssi</span> <span class="o">+</span> <span class="n">IPW2100_RSSI_TO_DBM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">rssi_qual</span> <span class="o">=</span> <span class="n">rssi</span> <span class="o">*</span> <span class="n">POOR</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">rssi_qual</span> <span class="o">=</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">FAIR</span> <span class="o">-</span> <span class="n">POOR</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">POOR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>
			<span class="n">rssi_qual</span> <span class="o">=</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">-</span> <span class="mi">15</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">GOOD</span> <span class="o">-</span> <span class="n">FAIR</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">FAIR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span>
			<span class="n">rssi_qual</span> <span class="o">=</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">VERY_GOOD</span> <span class="o">-</span> <span class="n">GOOD</span><span class="p">)</span> <span class="o">/</span>
			    <span class="mi">10</span> <span class="o">+</span> <span class="n">GOOD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rssi_qual</span> <span class="o">=</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">-</span> <span class="mi">30</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">PERFECT</span> <span class="o">-</span> <span class="n">VERY_GOOD</span><span class="p">)</span> <span class="o">/</span>
			    <span class="mi">10</span> <span class="o">+</span> <span class="n">VERY_GOOD</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_PERCENT_RETRIES</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">tx_retries</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ord_len</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail_get_ordinal</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tx_retries</span> <span class="o">&gt;</span> <span class="mi">75</span><span class="p">)</span>
			<span class="n">tx_qual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="n">tx_retries</span><span class="p">)</span> <span class="o">*</span> <span class="n">POOR</span> <span class="o">/</span> <span class="mi">15</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tx_retries</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">)</span>
			<span class="n">tx_qual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">75</span> <span class="o">-</span> <span class="n">tx_retries</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">FAIR</span> <span class="o">-</span> <span class="n">POOR</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">POOR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tx_retries</span> <span class="o">&gt;</span> <span class="mi">65</span><span class="p">)</span>
			<span class="n">tx_qual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">70</span> <span class="o">-</span> <span class="n">tx_retries</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">GOOD</span> <span class="o">-</span> <span class="n">FAIR</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">FAIR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tx_retries</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>
			<span class="n">tx_qual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">65</span> <span class="o">-</span> <span class="n">tx_retries</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">VERY_GOOD</span> <span class="o">-</span> <span class="n">GOOD</span><span class="p">)</span> <span class="o">/</span>
			    <span class="mi">15</span> <span class="o">+</span> <span class="n">GOOD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tx_qual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span> <span class="o">-</span> <span class="n">tx_retries</span><span class="p">)</span> <span class="o">*</span>
			    <span class="p">(</span><span class="n">PERFECT</span> <span class="o">-</span> <span class="n">VERY_GOOD</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span> <span class="o">+</span> <span class="n">VERY_GOOD</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">missed_beacons</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>
			<span class="n">beacon_qual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">60</span> <span class="o">-</span> <span class="n">missed_beacons</span><span class="p">)</span> <span class="o">*</span> <span class="n">POOR</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">missed_beacons</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">)</span>
			<span class="n">beacon_qual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span> <span class="o">-</span> <span class="n">missed_beacons</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">FAIR</span> <span class="o">-</span> <span class="n">POOR</span><span class="p">)</span> <span class="o">/</span>
			    <span class="mi">10</span> <span class="o">+</span> <span class="n">POOR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">missed_beacons</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">beacon_qual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">40</span> <span class="o">-</span> <span class="n">missed_beacons</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">GOOD</span> <span class="o">-</span> <span class="n">FAIR</span><span class="p">)</span> <span class="o">/</span>
			    <span class="mi">18</span> <span class="o">+</span> <span class="n">FAIR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">missed_beacons</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
			<span class="n">beacon_qual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">missed_beacons</span><span class="p">)</span> <span class="o">*</span>
			    <span class="p">(</span><span class="n">VERY_GOOD</span> <span class="o">-</span> <span class="n">GOOD</span><span class="p">)</span> <span class="o">/</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">GOOD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">beacon_qual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span> <span class="o">-</span> <span class="n">missed_beacons</span><span class="p">)</span> <span class="o">*</span>
			    <span class="p">(</span><span class="n">PERFECT</span> <span class="o">-</span> <span class="n">VERY_GOOD</span><span class="p">)</span> <span class="o">/</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">VERY_GOOD</span><span class="p">;</span>

		<span class="n">quality</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">tx_qual</span><span class="p">,</span> <span class="n">rssi_qual</span><span class="p">);</span>
		<span class="n">quality</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">beacon_qual</span><span class="p">,</span> <span class="n">quality</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPW2100_DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">beacon_qual</span> <span class="o">==</span> <span class="n">quality</span><span class="p">)</span>
			<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Quality clamped by Missed Beacons</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tx_qual</span> <span class="o">==</span> <span class="n">quality</span><span class="p">)</span>
			<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Quality clamped by Tx Retries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">quality</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Quality clamped by Signal Strength</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Quality not clamped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">quality</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">rssi</span> <span class="o">+</span> <span class="n">IPW2100_RSSI_TO_DBM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">|=</span> <span class="n">IW_QUAL_NOISE_INVALID</span><span class="p">;</span>

	<span class="cm">/* FIXME: this is percent and not a # */</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">miss</span><span class="p">.</span><span class="n">beacon</span> <span class="o">=</span> <span class="n">missed_beacons</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_TX_FAILURES</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">tx_failures</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ord_len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_get_ordinal</span><span class="p">;</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">retries</span> <span class="o">=</span> <span class="n">tx_failures</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">wstats</span><span class="p">;</span>

      <span class="nl">fail_get_ordinal:</span>
	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;failed querying ordinals.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="n">ipw2100_wx_handler_def</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">standard</span> <span class="o">=</span> <span class="n">ipw2100_wx_handlers</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_standard</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipw2100_wx_handlers</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipw2100_private_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private_args</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipw2100_private_args</span><span class="p">),</span>
	<span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span> <span class="o">*</span><span class="p">)</span> <span class="n">ipw2100_private_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_args</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="o">*</span><span class="p">)</span><span class="n">ipw2100_private_args</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wireless_stats</span> <span class="o">=</span> <span class="n">ipw2100_wx_wireless_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_wx_event_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_priv</span><span class="p">,</span> <span class="n">wx_event_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_STOPPING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>

	<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>

	<span class="cm">/* Fetch BSSID from the hardware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUS_ASSOCIATING</span> <span class="o">|</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_RF_KILL_MASK</span> <span class="o">||</span>
	    <span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_ASSN_AP_BSSID</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We now have the BSSID, so can finish setting to the full</span>
<span class="cm">		 * associated state */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_ASSOCIATING</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">;</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ASSOCIATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPW_DEBUG_WX</span><span class="p">(</span><span class="s">&quot;Configuring ESSID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
		<span class="cm">/* This is a disassociation event, so kick the firmware to</span>
<span class="cm">		 * look for another AP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">CFG_STATIC_ESSID</span><span class="p">)</span>
			<span class="n">ipw2100_set_essid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">,</span>
					  <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ipw2100_set_essid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">action_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define IPW2100_FW_MAJOR_VERSION 1</span>
<span class="cp">#define IPW2100_FW_MINOR_VERSION 3</span>

<span class="cp">#define IPW2100_FW_MINOR(x) ((x &amp; 0xff) &gt;&gt; 8)</span>
<span class="cp">#define IPW2100_FW_MAJOR(x) (x &amp; 0xff)</span>

<span class="cp">#define IPW2100_FW_VERSION ((IPW2100_FW_MINOR_VERSION &lt;&lt; 8) | \</span>
<span class="cp">                             IPW2100_FW_MAJOR_VERSION)</span>

<span class="cp">#define IPW2100_FW_PREFIX &quot;ipw2100-&quot; __stringify(IPW2100_FW_MAJOR_VERSION) \</span>
<span class="cp">&quot;.&quot; __stringify(IPW2100_FW_MINOR_VERSION)</span>

<span class="cp">#define IPW2100_FW_NAME(x) IPW2100_FW_PREFIX &quot;&quot; x &quot;.fw&quot;</span>

<span class="cm">/*</span>

<span class="cm">BINARY FIRMWARE HEADER FORMAT</span>

<span class="cm">offset      length   desc</span>
<span class="cm">0           2        version</span>
<span class="cm">2           2        mode == 0:BSS,1:IBSS,2:MONITOR</span>
<span class="cm">4           4        fw_len</span>
<span class="cm">8           4        uc_len</span>
<span class="cm">C           fw_len   firmware data</span>
<span class="cm">12 + fw_len uc_len   microcode data</span>

<span class="cm">*/</span>

<span class="k">struct</span> <span class="n">ipw2100_fw_header</span> <span class="p">{</span>
	<span class="kt">short</span> <span class="n">version</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fw_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uc_size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_mod_firmware_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_fw</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipw2100_fw_header</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_fw_header</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IPW2100_FW_MAJOR</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IPW2100_FW_MAJOR_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: Firmware image not compatible &quot;</span>
		       <span class="s">&quot;(detected version id of %u). &quot;</span>
		       <span class="s">&quot;See Documentation/networking/README.ipw2100</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">h</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fw</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_fw_header</span><span class="p">);</span>
	<span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">fw_size</span><span class="p">;</span>
	<span class="n">fw</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">fw_size</span><span class="p">;</span>
	<span class="n">fw</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">uc_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_get_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipw2100_fw</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%s: Using hotplug firmware load.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">IPW2100_FW_NAME</span><span class="p">(</span><span class="s">&quot;-i&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
	<span class="k">case</span> <span class="n">IW_MODE_MONITOR</span>:
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">IPW2100_FW_NAME</span><span class="p">(</span><span class="s">&quot;-p&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
	<span class="nl">default:</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">IPW2100_FW_NAME</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: &quot;</span>
		       <span class="s">&quot;%s: Firmware &#39;%s&#39; not available or load failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IPW_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;firmware data %p size %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		       <span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">ipw2100_mod_firmware_load</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">IPW2100_FW_NAME</span><span class="p">(</span><span class="s">&quot;-i&quot;</span><span class="p">));</span>
<span class="cp">#ifdef CONFIG_IPW2100_MONITOR</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">IPW2100_FW_NAME</span><span class="p">(</span><span class="s">&quot;-p&quot;</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">IPW2100_FW_NAME</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">));</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipw2100_release_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ipw2100_fw</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fw</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="p">);</span>
	<span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_get_fwversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">ver</span><span class="p">[</span><span class="n">MAX_FW_VERSION_LEN</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="n">MAX_FW_VERSION_LEN</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* firmware version is an ascii string (max len of 14) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_STAT_FW_VER_NUM</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_get_ucodeversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ver</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ver</span><span class="p">);</span>
	<span class="cm">/* microcode version is a 32 bit integer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipw2100_get_ordinal</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IPW_ORD_UCODE_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="s">&quot;%08X&quot;</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * On exit, the firmware will have been freed from the fw list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_fw_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipw2100_fw</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* firmware is constructed of N contiguous entries, each entry is</span>
<span class="cm">	 * structured as:</span>
<span class="cm">	 *</span>
<span class="cm">	 * offset    sie         desc</span>
<span class="cm">	 * 0         4           address to write to</span>
<span class="cm">	 * 4         2           length of data run</span>
<span class="cm">	 * 6         length      data</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">firmware_data</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">firmware_data_left</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">firmware_data_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">firmware_data</span><span class="p">);</span>
		<span class="n">firmware_data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">firmware_data_left</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">firmware_data</span><span class="p">);</span>
		<span class="n">firmware_data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">firmware_data_left</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: &quot;</span>
			       <span class="s">&quot;Invalid firmware run-length of %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">write_nic_memory</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">firmware_data</span><span class="p">);</span>
		<span class="n">firmware_data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">firmware_data_left</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">symbol_alive_response</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">cmd_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">seq_num</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ucode_rev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">eeprom_valid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">valid_flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">IEEE_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pcb_rev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clock_settle_time</span><span class="p">;</span>	<span class="c1">// 1us LSB</span>
	<span class="n">u16</span> <span class="n">powerup_settle_time</span><span class="p">;</span>	<span class="c1">// 1us LSB</span>
	<span class="n">u16</span> <span class="n">hop_settle_time</span><span class="p">;</span>	<span class="c1">// 1us LSB</span>
	<span class="n">u8</span> <span class="n">date</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		<span class="c1">// month, day, year</span>
	<span class="n">u8</span> <span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>		<span class="c1">// hours, minutes</span>
	<span class="n">u8</span> <span class="n">ucode_valid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipw2100_ucode_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipw2100_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ipw2100_fw</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">microcode_data</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">microcode_data_left</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">symbol_alive_response</span> <span class="n">response</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Symbol control */</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW2100_CONTROL_REG</span><span class="p">,</span> <span class="mh">0x703</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW2100_CONTROL_REG</span><span class="p">,</span> <span class="mh">0x707</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* HW config */</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210014</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">);</span>	<span class="cm">/* fifo width =16 */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210014</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">);</span>	<span class="cm">/* fifo width =16 */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* EN_CS_ACCESS bit to reset control store pointer */</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* copy microcode from buffer into Symbol */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">microcode_data_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210010</span><span class="p">,</span> <span class="o">*</span><span class="n">microcode_data</span><span class="o">++</span><span class="p">);</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210010</span><span class="p">,</span> <span class="o">*</span><span class="n">microcode_data</span><span class="o">++</span><span class="p">);</span>
		<span class="n">microcode_data_left</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* EN_CS_ACCESS bit to reset the control store pointer */</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Enable System (Reg 0)</span>
<span class="cm">	 * first enable causes garbage in RX FIFO */</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210000</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Reset External Baseband Reg */</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW2100_CONTROL_REG</span><span class="p">,</span> <span class="mh">0x703</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IPW2100_CONTROL_REG</span><span class="p">,</span> <span class="mh">0x707</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* HW Config (Reg 5) */</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210014</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">);</span>	<span class="c1">// fifo width =16</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210014</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">);</span>	<span class="c1">// fifo width =16</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Enable System (Reg 0)</span>
<span class="cm">	 * second enable should be OK */</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="c1">// clear enable system</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210000</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>	<span class="c1">// set enable system</span>

	<span class="cm">/* check Symbol is enabled - upped this from 5 as it wasn&#39;t always</span>
<span class="cm">	 * catching the update */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="cm">/* check Dino is enabled bit */</span>
		<span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s: Error initializing Symbol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get Symbol alive response */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Read alive response structure */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">symbol_alive_response</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x210004</span><span class="p">,</span> <span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">response</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">response</span><span class="p">.</span><span class="n">cmd_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">ucode_valid</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span>
		       <span class="s">&quot;: %s: No response from Symbol - hw not alive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">printk_buf</span><span class="p">(</span><span class="n">IPW_DL_ERROR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">response</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">response</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
