<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › rtlwifi › core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009-2012  Realtek Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * wlanfae &lt;wlanfae@realtek.com&gt;</span>
<span class="cm"> * Realtek Corporation, No. 2, Innovation Road II, Hsinchu Science Park,</span>
<span class="cm"> * Hsinchu 300, Taiwan.</span>
<span class="cm"> *</span>
<span class="cm"> * Larry Finger &lt;Larry.Finger@lwfinger.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#include &quot;wifi.h&quot;</span>
<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;cam.h&quot;</span>
<span class="cp">#include &quot;base.h&quot;</span>
<span class="cp">#include &quot;pci.h&quot;</span>
<span class="cp">#include &quot;ps.h&quot;</span>

<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="kt">void</span> <span class="nf">rtl_fw_cb</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">firmware</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;Firmware callback routine entered!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">firmware_loading_complete</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">firmware</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Firmware %s not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fw_name</span><span class="p">);</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">max_fw_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">max_fw_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;Firmware is too big!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">firmware</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">pfirmware</span><span class="p">,</span> <span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">firmware</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">fwsize</span> <span class="o">=</span> <span class="n">firmware</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">firmware</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;Can&#39;t register mac80211 hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">mac80211_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">RTL_STATUS_INTERFACE_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/*init rfkill */</span>
	<span class="n">rtl_init_rfkill</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl_fw_cb</span><span class="p">);</span>

<span class="cm">/*mutex for start &amp; stop is must here. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_op_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_hal_stop</span><span class="p">(</span><span class="n">rtlhal</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RTL_STATUS_INTERFACE_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">intf_ops</span><span class="o">-&gt;</span><span class="n">adapter_start</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">rtl_watch_dog_timer_callback</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_op_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_hal_stop</span><span class="p">(</span><span class="n">rtlhal</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfpwr_state</span> <span class="o">==</span> <span class="n">ERFOFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtl_ips_nic_on</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">=</span> <span class="n">MAC80211_NOLINK</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PEER_UNKNOWN</span><span class="p">;</span>

	<span class="cm">/*reset sec info */</span>
	<span class="n">rtl_cam_reset_sec_info</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtl_deinit_deferred_work</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">intf_ops</span><span class="o">-&gt;</span><span class="n">adapter_stop</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_op_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_tcb_desc</span> <span class="n">tcb_desc</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcb_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl_tcb_desc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">is_hal_stop</span><span class="p">(</span><span class="n">rtlhal</span><span class="p">)</span> <span class="o">||</span> <span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfpwr_state</span> <span class="o">!=</span> <span class="n">ERFON</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RTL_STATUS_INTERFACE_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">intf_ops</span><span class="o">-&gt;</span><span class="n">waitq_insert</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">intf_ops</span><span class="o">-&gt;</span><span class="n">adapter_tx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcb_desc</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_free:</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_op_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">driver_flags</span> <span class="o">|=</span> <span class="n">IEEE80211_VIF_BEACON_FILTER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span>
			 <span class="s">&quot;vif has been set!! mac-&gt;vif = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtl_ips_nic_on</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon_enabled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;NL80211_IFTYPE_STATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">update_interrupt_mask</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span>
					<span class="p">[</span><span class="n">RTL_IBSS_INT_MASKS</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;NL80211_IFTYPE_ADHOC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">=</span> <span class="n">MAC80211_LINKED</span><span class="p">;</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_bcn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_2_4G</span><span class="p">)</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">=</span> <span class="mh">0xfff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">=</span> <span class="mh">0xff0</span><span class="p">;</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_BASIC_RATE</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">));</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;NL80211_IFTYPE_AP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">=</span> <span class="n">MAC80211_LINKED</span><span class="p">;</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_bcn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_2_4G</span><span class="p">)</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">=</span> <span class="mh">0xfff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">=</span> <span class="mh">0xff0</span><span class="p">;</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_BASIC_RATE</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;operation mode %d is not supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="n">vif</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_network_type</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_ETHER_ADDR</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_op_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>

	<span class="cm">/* Free beacon resources */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon_enabled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">update_interrupt_mask</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span>
					<span class="p">[</span><span class="n">RTL_IBSS_INT_MASKS</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *Note: We assume NL80211_IFTYPE_UNSPECIFIED as</span>
<span class="cm">	 *NO LINK for our hardware.</span>
<span class="cm">	 */</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">=</span> <span class="n">MAC80211_NOLINK</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PEER_UNKNOWN</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_network_type</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_op_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_LISTEN_INTERVAL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*BIT(2)*/</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;IEEE80211_CONF_CHANGE_LISTEN_INTERVAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*For IPS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_IDLE</span><span class="p">)</span>
			<span class="n">rtl_ips_nic_off</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rtl_ips_nic_on</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *although rfoff may not cause by ips, but we will</span>
<span class="cm">		 *check the reason in set_rf_power_state function</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfpwr_state</span> <span class="o">==</span> <span class="n">ERFOFF</span><span class="p">))</span>
			<span class="n">rtl_ips_nic_on</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*For LPS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_PS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">ps_work</span><span class="p">);</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">ps_rfon_wq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">sw_ps_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* sleep here is must, or we may recv the beacon and</span>
<span class="cm">			 * cause mac80211 into wrong ps state, this will cause</span>
<span class="cm">			 * power save nullfunc send fail, and further cause</span>
<span class="cm">			 * pkt loss, So sleep must quickly but not immediatly</span>
<span class="cm">			 * because that will cause nullfunc send by mac80211</span>
<span class="cm">			 * fail, and cause pkt loss, we have tested that 5mA</span>
<span class="cm">			 * is worked very well */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">multi_buffered</span><span class="p">)</span>
				<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">rtl_wq</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">ps_work</span><span class="p">,</span>
						<span class="n">MSECS</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtl_swlps_rf_awake</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">sw_ps_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_RETRY_LIMITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;IEEE80211_CONF_CHANGE_RETRY_LIMITS %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">long_frame_max_tx_count</span><span class="p">);</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">retry_long</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">long_frame_max_tx_count</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">retry_short</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">long_frame_max_tx_count</span><span class="p">;</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_RETRY_LIMIT</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span>
						      <span class="n">long_frame_max_tx_count</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">wide_chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 *because we should back channel to</span>
<span class="cm">		 *current_network.chan in in scanning,</span>
<span class="cm">		 *So if set_chan == current_network.chan</span>
<span class="cm">		 *we should set it.</span>
<span class="cm">		 *because mac80211 tell us wrong bw40</span>
<span class="cm">		 *info for cisco1253 bw20, so we modify</span>
<span class="cm">		 *it here based on UPPER &amp; LOWER</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NL80211_CHAN_HT20</span>:
		<span class="k">case</span> <span class="n">NL80211_CHAN_NO_HT</span>:
			<span class="cm">/* SC */</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">cur_40_prime_sc</span> <span class="o">=</span>
				<span class="n">PRIME_CHNL_OFFSET_DONT_CARE</span><span class="p">;</span>
			<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_chan_bw</span> <span class="o">=</span> <span class="n">HT_CHANNEL_WIDTH_20</span><span class="p">;</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">bw_40</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_CHAN_HT40MINUS</span>:
			<span class="cm">/* SC */</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">cur_40_prime_sc</span> <span class="o">=</span> <span class="n">PRIME_CHNL_OFFSET_UPPER</span><span class="p">;</span>
			<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_chan_bw</span> <span class="o">=</span>
				<span class="n">HT_CHANNEL_WIDTH_20_40</span><span class="p">;</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">bw_40</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="cm">/*wide channel */</span>
			<span class="n">wide_chan</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_CHAN_HT40PLUS</span>:
			<span class="cm">/* SC */</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">cur_40_prime_sc</span> <span class="o">=</span> <span class="n">PRIME_CHNL_OFFSET_LOWER</span><span class="p">;</span>
			<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_chan_bw</span> <span class="o">=</span>
				<span class="n">HT_CHANNEL_WIDTH_20_40</span><span class="p">;</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">bw_40</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="cm">/*wide channel */</span>
			<span class="n">wide_chan</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">bw_40</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
				 <span class="s">&quot;switch case not processed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wide_chan</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">wide_chan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* In scanning, before we go offchannel we may send a ps=1 null</span>
<span class="cm">		 * to AP, and then we may send a ps = 0 null to AP quickly, but</span>
<span class="cm">		 * first null may have caused AP to put lots of packet to hw tx</span>
<span class="cm">		 * buffer. These packets must be tx&#39;d before we go off channel</span>
<span class="cm">		 * so we must delay more time to let AP flush these packets</span>
<span class="cm">		 * before going offchannel, or dis-association or delete BA will</span>
<span class="cm">		 * happen by AP</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">offchan_delay</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">offchan_delay</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_channel</span> <span class="o">=</span> <span class="n">wide_chan</span><span class="p">;</span>

		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">switch_channel</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_channel_access</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_bw_mode</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel_type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_op_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">new_flags</span><span class="p">,</span> <span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;=</span> <span class="n">RTL_SUPPORTED_FILTERS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">changed_flags</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*TODO: we disable broadcase now, so enable here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="n">FIF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_conf</span> <span class="o">|=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">MAC_RCR_AM</span><span class="p">]</span> <span class="o">|</span>
			    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">MAC_RCR_AB</span><span class="p">];</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Enable receive multicast frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_conf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">MAC_RCR_AM</span><span class="p">]</span> <span class="o">|</span>
					  <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">MAC_RCR_AB</span><span class="p">]);</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Disable receive multicast frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_FCSFAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="n">FIF_FCSFAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_conf</span> <span class="o">|=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">MAC_RCR_ACRC32</span><span class="p">];</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Enable receive FCS error frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_conf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">MAC_RCR_ACRC32</span><span class="p">];</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Disable receive FCS error frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* if ssid not set to hw don&#39;t check bssid</span>
<span class="cm">	 * here just used for linked scanning, &amp; linked</span>
<span class="cm">	 * and nolink check bssid is set in set network_type */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&gt;=</span> <span class="n">MAC80211_LINKED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_chk_bssid</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_chk_bssid</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_conf</span> <span class="o">|=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">MAC_RCR_ACF</span><span class="p">];</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Enable receive control frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_conf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">MAC_RCR_ACF</span><span class="p">];</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Disable receive control frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_OTHER_BSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="n">FIF_OTHER_BSS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_conf</span> <span class="o">|=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">MAC_RCR_AAP</span><span class="p">];</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Enable receive other BSS&#39;s frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rx_conf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">MAC_RCR_AAP</span><span class="p">];</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Disable receive other BSS&#39;s frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_op_sta_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_sta_info</span> <span class="o">*</span><span class="n">sta_entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl_sta_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_2_4G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sta_entry</span><span class="o">-&gt;</span><span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_G</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0xf</span><span class="p">)</span>
				<span class="n">sta_entry</span><span class="o">-&gt;</span><span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_B</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span>
				<span class="n">sta_entry</span><span class="o">-&gt;</span><span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_N_24G</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_5G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sta_entry</span><span class="o">-&gt;</span><span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_A</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span>
				<span class="n">sta_entry</span><span class="o">-&gt;</span><span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_N_24G</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* I found some times mac80211 give wrong supp_rates for adhoc*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
			<span class="n">sta_entry</span><span class="o">-&gt;</span><span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_G</span><span class="p">;</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
			 <span class="s">&quot;Add sta addr is %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">update_rate_tbl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_op_sta_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_sta_info</span> <span class="o">*</span><span class="n">sta_entry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
			 <span class="s">&quot;Remove sta addr is %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">sta_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl_sta_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
		<span class="n">sta_entry</span><span class="o">-&gt;</span><span class="n">wireless_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sta_entry</span><span class="o">-&gt;</span><span class="n">ratr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_rtl_get_hal_qnum</span><span class="p">(</span><span class="n">u16</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">qnum</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">qnum</span> <span class="o">=</span> <span class="n">AC3_VO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">qnum</span> <span class="o">=</span> <span class="n">AC2_VI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">qnum</span> <span class="o">=</span> <span class="n">AC0_BE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">qnum</span> <span class="o">=</span> <span class="n">AC1_BK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">qnum</span> <span class="o">=</span> <span class="n">AC0_BE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">qnum</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *for mac80211 VO=0, VI=1, BE=2, BK=3</span>
<span class="cm"> *for rtl819x  BE=0, BK=1, VI=2, VO=3</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_op_conf_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">queue</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">aci</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&gt;=</span> <span class="n">AC_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span>
			 <span class="s">&quot;queue number %d is incorrect!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">aci</span> <span class="o">=</span> <span class="n">_rtl_get_hal_qnum</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">[</span><span class="n">aci</span><span class="p">].</span><span class="n">aifs</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">[</span><span class="n">aci</span><span class="p">].</span><span class="n">cw_min</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">[</span><span class="n">aci</span><span class="p">].</span><span class="n">cw_max</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">[</span><span class="n">aci</span><span class="p">].</span><span class="n">tx_op</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">edca_param</span><span class="p">[</span><span class="n">aci</span><span class="p">],</span> <span class="n">param</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">));</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_qos</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">aci</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_op_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span> <span class="o">&amp;&amp;</span>
		     <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon_enabled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
					 <span class="s">&quot;BSS_CHANGED_BEACON_ENABLED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="cm">/*start hw beacon interrupt. */</span>
				<span class="cm">/*rtlpriv-&gt;cfg-&gt;ops-&gt;set_bcn_reg(hw); */</span>
				<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">update_interrupt_mask</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span>
						<span class="p">[</span><span class="n">RTL_IBSS_INT_MASKS</span><span class="p">],</span>
						<span class="mi">0</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">linked_set_reg</span><span class="p">)</span>
					<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">linked_set_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon_enabled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
					 <span class="s">&quot;ADHOC DISABLE BEACON</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">update_interrupt_mask</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span>
						<span class="p">[</span><span class="n">RTL_IBSS_INT_MASKS</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_INT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_BEACON</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
				 <span class="s">&quot;BSS_CHANGED_BEACON_INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_bcn_intv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*TODO: reference to enum ieee80211_bss_change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we should reset all sec info &amp; cam</span>
<span class="cm">			 * before set cam after linked, we should not</span>
<span class="cm">			 * reset in disassoc, that will cause tkip-&gt;wep</span>
<span class="cm">			 * fail because some flag will be wrong */</span>
			<span class="cm">/* reset sec info */</span>
			<span class="n">rtl_cam_reset_sec_info</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="cm">/* reset cam to fix wep fail issue</span>
<span class="cm">			 * when change from wpa to wep */</span>
			<span class="n">rtl_cam_reset_all_entry</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">=</span> <span class="n">MAC80211_LINKED</span><span class="p">;</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">cnt_after_linked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">linked_set_reg</span><span class="p">)</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">linked_set_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="p">)</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">update_rate_tbl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;BSS_CHANGED_ASSOC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">==</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span>
				<span class="n">rtl_lps_leave</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">=</span> <span class="n">MAC80211_NOLINK</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

			<span class="cm">/* reset sec info */</span>
			<span class="n">rtl_cam_reset_sec_info</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

			<span class="n">rtl_cam_reset_all_entry</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PEER_UNKNOWN</span><span class="p">;</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;BSS_CHANGED_UN_ASSOC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_CTS_PROT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;BSS_CHANGED_ERP_CTS_PROT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">use_cts_protect</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_cts_prot</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_PREAMBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;BSS_CHANGED_ERP_PREAMBLE use short preamble:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_short_preamble</span><span class="p">);</span>

		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">short_preamble</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_short_preamble</span><span class="p">;</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_ACK_PREAMBLE</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">short_preamble</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;BSS_CHANGED_ERP_SLOT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_short_slot</span><span class="p">)</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">slot_time</span> <span class="o">=</span> <span class="n">RTL_SLOT_TIME_9</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">slot_time</span> <span class="o">=</span> <span class="n">RTL_SLOT_TIME_20</span><span class="p">;</span>

		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_SLOT_TIME</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">slot_time</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_HT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;BSS_CHANGED_HT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">get_sta</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_density</span> <span class="o">&gt;</span>
			    <span class="n">mac</span><span class="o">-&gt;</span><span class="n">current_ampdu_density</span><span class="p">)</span>
				<span class="n">mac</span><span class="o">-&gt;</span><span class="n">current_ampdu_density</span> <span class="o">=</span>
				    <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_density</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_factor</span> <span class="o">&lt;</span>
			    <span class="n">mac</span><span class="o">-&gt;</span><span class="n">current_ampdu_factor</span><span class="p">)</span>
				<span class="n">mac</span><span class="o">-&gt;</span><span class="n">current_ampdu_factor</span> <span class="o">=</span>
				    <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_factor</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>

		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_SHORTGI_DENSITY</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">max_mss_density</span><span class="p">));</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_AMPDU_FACTOR</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">current_ampdu_factor</span><span class="p">);</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_AMPDU_MIN_SPACE</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">current_ampdu_density</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BSSID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">basic_rates</span><span class="p">;</span>

		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_BSSID</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>

		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PEER_UNKNOWN</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_network_type</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">get_sta</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_5G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_A</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0xf</span><span class="p">)</span>
				<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_B</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_G</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_2_4G</span><span class="p">)</span>
				<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_N_24G</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_N_5G</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* just station need it, because ibss &amp; ap mode will</span>
<span class="cm">		 * set in sta_add, and will be NULL here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rtl_sta_info</span> <span class="o">*</span><span class="n">sta_entry</span><span class="p">;</span>
			<span class="n">sta_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl_sta_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
			<span class="n">sta_entry</span><span class="o">-&gt;</span><span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ht_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * for cisco 1252 bw20 it&#39;s wrong</span>
<span class="cm">			 * if (ht_cap &amp; IEEE80211_HT_CAP_SUP_WIDTH_20_40) {</span>
<span class="cm">			 *	mac-&gt;bw_40 = true;</span>
<span class="cm">			 * }</span>
<span class="cm">			 * */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BASIC_RATES</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* for 5G must &lt;&lt; RATE_6M_INDEX=4,</span>
<span class="cm">			 * because 5G have no cck rate*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_5G</span><span class="p">)</span>
				<span class="n">basic_rates</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">basic_rates</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">=</span> <span class="n">basic_rates</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_BASIC_RATE</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">basic_rates</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For FW LPS:</span>
<span class="cm">	 * To tell firmware we have connected</span>
<span class="cm">	 * to an AP. For 92SE/CE power save v2.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">fwctrl_lps</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">mstatus</span> <span class="o">=</span> <span class="n">RT_MEDIA_CONNECT</span><span class="p">;</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						      <span class="n">HW_VAR_H2C_FW_JOINBSSRPT</span><span class="p">,</span>
						      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mstatus</span><span class="p">));</span>
				<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">report_linked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">fwctrl_lps</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">mstatus</span> <span class="o">=</span> <span class="n">RT_MEDIA_DISCONNECT</span><span class="p">;</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						      <span class="n">HW_VAR_H2C_FW_JOINBSSRPT</span><span class="p">,</span>
						      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">mstatus</span><span class="p">));</span>
				<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">report_linked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">rtl_op_get_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">tsf</span><span class="p">;</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_CORRECT_TSF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tsf</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">tsf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_op_set_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			   <span class="n">u64</span> <span class="n">tsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">bibss</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">tsf</span> <span class="o">=</span> <span class="n">tsf</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_CORRECT_TSF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">bibss</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_op_reset_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_DUAL_TSF_RST</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_op_sta_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">sta_notify_cmd</span> <span class="n">cmd</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STA_NOTIFY_SLEEP</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STA_NOTIFY_AWAKE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_op_ampdu_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">ieee80211_ampdu_mlme_action</span> <span class="n">action</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ssn</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_START</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;IEEE80211_AMPDU_TX_START: TID:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rtl_tx_agg_start</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">ssn</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_STOP</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;IEEE80211_AMPDU_TX_STOP: TID:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rtl_tx_agg_stop</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_OPERATIONAL</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;IEEE80211_AMPDU_TX_OPERATIONAL:TID:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">rtl_tx_agg_oper</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_START</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;IEEE80211_AMPDU_RX_START:TID:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_STOP</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;IEEE80211_AMPDU_RX_STOP:TID:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;IEEE80211_AMPDU_ERR!!!!:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_op_sw_scan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">act_scanning</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">==</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl_lps_leave</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">=</span> <span class="n">MAC80211_LINKED_SCANNING</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtl_ips_nic_on</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Dual mac */</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">load_imrandiqk_setting_for2g</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">led_control</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">LED_CTL_SITE_SURVEY</span><span class="p">);</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">scan_operation_backup</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SCAN_OPT_BACKUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_op_sw_scan_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MAC80211</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">act_scanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/* Dual mac */</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">load_imrandiqk_setting_for2g</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">==</span> <span class="n">MAC80211_LINKED_SCANNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">=</span> <span class="n">MAC80211_LINKED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* fix fwlps issue */</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_network_type</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">scan_operation_backup</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SCAN_OPT_RESTORE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_op_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">set_key_cmd</span> <span class="n">cmd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">key_type</span> <span class="o">=</span> <span class="n">NO_ENCRYPTION</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key_idx</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">group_key</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">wep_only</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">bcast_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">zero_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mod_params</span><span class="o">-&gt;</span><span class="n">sw_crypto</span> <span class="o">||</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">use_sw_sec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span>
			 <span class="s">&quot;not open hw encryption</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>	<span class="cm">/*User disabled HW-crypto */</span>
	<span class="p">}</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
		 <span class="s">&quot;%s hardware based encryption for keyidx: %d, mac: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">cmd</span> <span class="o">==</span> <span class="n">SET_KEY</span> <span class="o">?</span> <span class="s">&quot;Using&quot;</span> <span class="o">:</span> <span class="s">&quot;Disabling&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">,</span>
		 <span class="n">sta</span> <span class="o">?</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">:</span> <span class="n">bcast_addr</span><span class="p">);</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">being_setkey</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">rtl_ips_nic_on</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="cm">/* &lt;1&gt; get encryption alg */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">WEP40_ENCRYPTION</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;alg:WEP40</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;alg:WEP104</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">WEP104_ENCRYPTION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">TKIP_ENCRYPTION</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;alg:TKIP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">AESCCMP_ENCRYPTION</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;alg:CCMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span> <span class="s">&quot;alg_err:%x!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">WEP40_ENCRYPTION</span> <span class="o">||</span>
			<span class="n">key_type</span> <span class="o">==</span> <span class="n">WEP104_ENCRYPTION</span> <span class="o">||</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">use_defaultkey</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* &lt;2&gt; get key_idx */</span>
	<span class="n">key_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_idx</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="cm">/* &lt;3&gt; if pairwise key enable_hw_sec */</span>
	<span class="n">group_key</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">);</span>

	<span class="cm">/* wep always be group key, but there are two conditions:</span>
<span class="cm">	 * 1) wep only: is just for wep enc, in this condition</span>
<span class="cm">	 * rtlpriv-&gt;sec.pairwise_enc_algorithm == NO_ENCRYPTION</span>
<span class="cm">	 * will be true &amp; enable_hw_sec will be set when wep</span>
<span class="cm">	 * ke setting.</span>
<span class="cm">	 * 2) wep(group) + AES(pairwise): some AP like cisco</span>
<span class="cm">	 * may use it, in this condition enable_hw_sec will not</span>
<span class="cm">	 * be set when wep key setting */</span>
	<span class="cm">/* we must reset sec_info after lingked before set key,</span>
<span class="cm">	 * or some flag will be wrong*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">group_key</span> <span class="o">||</span> <span class="n">key_type</span> <span class="o">==</span> <span class="n">WEP40_ENCRYPTION</span> <span class="o">||</span>
			<span class="n">key_type</span> <span class="o">==</span> <span class="n">WEP104_ENCRYPTION</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">group_key</span><span class="p">)</span>
				<span class="n">wep_only</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_hw_sec</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">group_key</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">pairwise_enc_algorithm</span> <span class="o">==</span> <span class="n">NO_ENCRYPTION</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">pairwise_enc_algorithm</span> <span class="o">==</span>
			    <span class="n">NO_ENCRYPTION</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">WEP40_ENCRYPTION</span> <span class="o">||</span>
			    <span class="n">key_type</span> <span class="o">==</span> <span class="n">WEP104_ENCRYPTION</span><span class="p">))</span>
				<span class="n">wep_only</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">pairwise_enc_algorithm</span> <span class="o">=</span> <span class="n">key_type</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;set enable_hw_sec, key_type:%x(OPEN:0 WEP40:1 TKIP:2 AES:4 WEP104:5)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">key_type</span><span class="p">);</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_hw_sec</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* &lt;4&gt; set key based on cmd */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SET_KEY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wep_only</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;set WEP(group/pairwise) key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Pairwise key with an assigned MAC address. */</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">pairwise_enc_algorithm</span> <span class="o">=</span> <span class="n">key_type</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">group_enc_algorithm</span> <span class="o">=</span> <span class="n">key_type</span><span class="p">;</span>
			<span class="cm">/*set local buf about wep key. */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_buf</span><span class="p">[</span><span class="n">key_idx</span><span class="p">],</span>
			       <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_len</span><span class="p">[</span><span class="n">key_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">zero_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">group_key</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* group key */</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;set group key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* group key */</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">group_enc_algorithm</span> <span class="o">=</span> <span class="n">key_type</span><span class="p">;</span>
			<span class="cm">/*set local buf about group key. */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_buf</span><span class="p">[</span><span class="n">key_idx</span><span class="p">],</span>
			       <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_len</span><span class="p">[</span><span class="n">key_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">bcast_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* pairwise key */</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;set pairwise key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RT_ASSERT</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span>
					  <span class="s">&quot;pairwise key without mac_addr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Pairwise key with an assigned MAC address. */</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">pairwise_enc_algorithm</span> <span class="o">=</span> <span class="n">key_type</span><span class="p">;</span>
			<span class="cm">/*set local buf about pairwise key. */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_buf</span><span class="p">[</span><span class="n">PAIRWISE_KEYIDX</span><span class="p">],</span>
			       <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_len</span><span class="p">[</span><span class="n">PAIRWISE_KEYIDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">pairwise_key</span> <span class="o">=</span>
			    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_buf</span><span class="p">[</span><span class="n">PAIRWISE_KEYIDX</span><span class="p">];</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_key</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span>
					   <span class="n">group_key</span><span class="p">,</span> <span class="n">key_type</span><span class="p">,</span> <span class="n">wep_only</span><span class="p">,</span>
					   <span class="nb">false</span><span class="p">);</span>
		<span class="cm">/* &lt;5&gt; tell mac80211 do something: */</span>
		<span class="cm">/*must use sw generate IV, or can not work !!!!. */</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_IV</span><span class="p">;</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">key_idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">TKIP_ENCRYPTION</span><span class="p">)</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_MMIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISABLE_KEY</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
			 <span class="s">&quot;disable key delete one entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/*set local buf about wep key. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
				<span class="n">rtl_cam_del_entry</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_buf</span><span class="p">[</span><span class="n">key_idx</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_len</span><span class="p">[</span><span class="n">key_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">zero_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 *mac80211 will delete entrys one by one,</span>
<span class="cm">		 *so don&#39;t use rtl_cam_reset_all_entry</span>
<span class="cm">		 *or clear all entry here.</span>
<span class="cm">		 */</span>
		<span class="n">rtl_cam_delete_one_entry</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">);</span>

		<span class="n">rtl_cam_reset_sec_info</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;cmd_err:%x!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">being_setkey</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_op_rfkill_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">bool</span> <span class="n">radio_state</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">blocked</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RTL_STATUS_INTERFACE_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>

	<span class="cm">/*if Radio On return true here */</span>
	<span class="n">radio_state</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">radio_onoff_checking</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">valid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">radio_state</span> <span class="o">!=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">.</span><span class="n">rfkill_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">.</span><span class="n">rfkill_state</span> <span class="o">=</span> <span class="n">radio_state</span><span class="p">;</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;wireless radio switch turned %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">radio_state</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

			<span class="n">blocked</span> <span class="o">=</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">.</span><span class="n">rfkill_state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">blocked</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">conf_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function is called by mac80211 to flush tx buffer</span>
<span class="cm"> * before switch channle or power save, or tx buffer packet</span>
<span class="cm"> * maybe send after offchannel or rf sleep, this may cause</span>
<span class="cm"> * dis-association by AP */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_op_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">drop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">intf_ops</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">)</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">intf_ops</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">drop</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">rtl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">rtl_op_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">rtl_op_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">rtl_op_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span> <span class="o">=</span> <span class="n">rtl_op_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span> <span class="o">=</span> <span class="n">rtl_op_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">rtl_op_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span> <span class="o">=</span> <span class="n">rtl_op_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_add</span> <span class="o">=</span> <span class="n">rtl_op_sta_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_remove</span> <span class="o">=</span> <span class="n">rtl_op_sta_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_key</span> <span class="o">=</span> <span class="n">rtl_op_set_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conf_tx</span> <span class="o">=</span> <span class="n">rtl_op_conf_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span> <span class="o">=</span> <span class="n">rtl_op_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tsf</span> <span class="o">=</span> <span class="n">rtl_op_get_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tsf</span> <span class="o">=</span> <span class="n">rtl_op_set_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_tsf</span> <span class="o">=</span> <span class="n">rtl_op_reset_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_notify</span> <span class="o">=</span> <span class="n">rtl_op_sta_notify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ampdu_action</span> <span class="o">=</span> <span class="n">rtl_op_ampdu_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sw_scan_start</span> <span class="o">=</span> <span class="n">rtl_op_sw_scan_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sw_scan_complete</span> <span class="o">=</span> <span class="n">rtl_op_sw_scan_complete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rfkill_poll</span> <span class="o">=</span> <span class="n">rtl_op_rfkill_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">rtl_op_flush</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
