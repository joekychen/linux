<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › rtlwifi › rtl8192c › dm_common.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>dm_common.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009-2012  Realtek Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * wlanfae &lt;wlanfae@realtek.com&gt;</span>
<span class="cm"> * Realtek Corporation, No. 2, Innovation Road II, Hsinchu Science Park,</span>
<span class="cm"> * Hsinchu 300, Taiwan.</span>
<span class="cm"> *</span>
<span class="cm"> * Larry Finger &lt;Larry.Finger@lwfinger.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &quot;dm_common.h&quot;</span>
<span class="cp">#include &quot;phy_common.h&quot;</span>
<span class="cp">#include &quot;../pci.h&quot;</span>
<span class="cp">#include &quot;../base.h&quot;</span>

<span class="cp">#define BT_RSSI_STATE_NORMAL_POWER	BIT_OFFSET_LEN_MASK_32(0, 1)</span>
<span class="cp">#define BT_RSSI_STATE_AMDPU_OFF		BIT_OFFSET_LEN_MASK_32(1, 1)</span>
<span class="cp">#define BT_RSSI_STATE_SPECIAL_LOW	BIT_OFFSET_LEN_MASK_32(2, 1)</span>
<span class="cp">#define BT_RSSI_STATE_BG_EDCA_LOW	BIT_OFFSET_LEN_MASK_32(3, 1)</span>
<span class="cp">#define BT_RSSI_STATE_TXPOWER_LOW	BIT_OFFSET_LEN_MASK_32(4, 1)</span>

<span class="cp">#define RTLPRIV			(struct rtl_priv *)</span>
<span class="cp">#define GET_UNDECORATED_AVERAGE_RSSI(_priv)	\</span>
<span class="cp">	((RTLPRIV(_priv))-&gt;mac80211.opmode == \</span>
<span class="cp">			     NL80211_IFTYPE_ADHOC) ?	\</span>
<span class="cp">	((RTLPRIV(_priv))-&gt;dm.entry_min_undecoratedsmoothed_pwdb) : \</span>
<span class="cp">	((RTLPRIV(_priv))-&gt;dm.undecorated_smoothed_pwdb)</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ofdmswing_table</span><span class="p">[</span><span class="n">OFDM_TABLE_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x7f8001fe</span><span class="p">,</span>
	<span class="mh">0x788001e2</span><span class="p">,</span>
	<span class="mh">0x71c001c7</span><span class="p">,</span>
	<span class="mh">0x6b8001ae</span><span class="p">,</span>
	<span class="mh">0x65400195</span><span class="p">,</span>
	<span class="mh">0x5fc0017f</span><span class="p">,</span>
	<span class="mh">0x5a400169</span><span class="p">,</span>
	<span class="mh">0x55400155</span><span class="p">,</span>
	<span class="mh">0x50800142</span><span class="p">,</span>
	<span class="mh">0x4c000130</span><span class="p">,</span>
	<span class="mh">0x47c0011f</span><span class="p">,</span>
	<span class="mh">0x43c0010f</span><span class="p">,</span>
	<span class="mh">0x40000100</span><span class="p">,</span>
	<span class="mh">0x3c8000f2</span><span class="p">,</span>
	<span class="mh">0x390000e4</span><span class="p">,</span>
	<span class="mh">0x35c000d7</span><span class="p">,</span>
	<span class="mh">0x32c000cb</span><span class="p">,</span>
	<span class="mh">0x300000c0</span><span class="p">,</span>
	<span class="mh">0x2d4000b5</span><span class="p">,</span>
	<span class="mh">0x2ac000ab</span><span class="p">,</span>
	<span class="mh">0x288000a2</span><span class="p">,</span>
	<span class="mh">0x26000098</span><span class="p">,</span>
	<span class="mh">0x24000090</span><span class="p">,</span>
	<span class="mh">0x22000088</span><span class="p">,</span>
	<span class="mh">0x20000080</span><span class="p">,</span>
	<span class="mh">0x1e400079</span><span class="p">,</span>
	<span class="mh">0x1c800072</span><span class="p">,</span>
	<span class="mh">0x1b00006c</span><span class="p">,</span>
	<span class="mh">0x19800066</span><span class="p">,</span>
	<span class="mh">0x18000060</span><span class="p">,</span>
	<span class="mh">0x16c0005b</span><span class="p">,</span>
	<span class="mh">0x15800056</span><span class="p">,</span>
	<span class="mh">0x14400051</span><span class="p">,</span>
	<span class="mh">0x1300004c</span><span class="p">,</span>
	<span class="mh">0x12000048</span><span class="p">,</span>
	<span class="mh">0x11000044</span><span class="p">,</span>
	<span class="mh">0x10000040</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cckswing_table_ch1ch13</span><span class="p">[</span><span class="n">CCK_TABLE_SIZE</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cckswing_table_ch14</span><span class="p">[</span><span class="n">CCK_TABLE_SIZE</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_diginit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">dm_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>

	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">dig_enable_flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span> <span class="o">=</span> <span class="n">DIG_EXT_PORT_STAGE_MAX</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">pre_igvalue</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">=</span> <span class="n">DIG_STA_DISCONNECT</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">presta_connectstate</span> <span class="o">=</span> <span class="n">DIG_STA_DISCONNECT</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">curmultista_connectstate</span> <span class="o">=</span> <span class="n">DIG_MULTISTA_DISCONNECT</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rssi_lowthresh</span> <span class="o">=</span> <span class="n">DM_DIG_THRESH_LOW</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rssi_highthresh</span> <span class="o">=</span> <span class="n">DM_DIG_THRESH_HIGH</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">fa_lowthresh</span> <span class="o">=</span> <span class="n">DM_FALSEALARM_THRESH_LOW</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">fa_highthresh</span> <span class="o">=</span> <span class="n">DM_FALSEALARM_THRESH_HIGH</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_max</span> <span class="o">=</span> <span class="n">DM_DIG_MAX</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_min</span> <span class="o">=</span> <span class="n">DM_DIG_MIN</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span> <span class="o">=</span> <span class="n">DM_DIG_BACKOFF_DEFAULT</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val_range_max</span> <span class="o">=</span> <span class="n">DM_DIG_BACKOFF_MAX</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val_range_min</span> <span class="o">=</span> <span class="n">DM_DIG_BACKOFF_MIN</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">pre_cck_pd_state</span> <span class="o">=</span> <span class="n">CCK_PD_STAGE_MAX</span><span class="p">;</span>
	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">=</span> <span class="n">CCK_PD_STAGE_MAX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">rtl92c_dm_initial_gain_min_pwdb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">dm_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rssi_val_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">curmultista_connectstate</span> <span class="o">==</span> <span class="n">DIG_MULTISTA_CONNECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">==</span> <span class="n">DIG_STA_CONNECT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rssi_val_min</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span> <span class="o">&gt;</span>
			     <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">:</span>
			    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rssi_val_min</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">==</span> <span class="n">DIG_STA_CONNECT</span> <span class="o">||</span>
		   <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">==</span> <span class="n">DIG_STA_BEFORE_CONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rssi_val_min</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">curmultista_connectstate</span> <span class="o">==</span>
		   <span class="n">DIG_MULTISTA_CONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rssi_val_min</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">rssi_val_min</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_false_alarm_counter_statistics</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">false_alarm_statistics</span> <span class="o">*</span><span class="n">falsealm_cnt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">falsealm_cnt</span><span class="p">);</span>

	<span class="n">ret_value</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM_PHYCOUNTER1</span><span class="p">,</span> <span class="n">MASKDWORD</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_parity_fail</span> <span class="o">=</span> <span class="p">((</span><span class="n">ret_value</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">ret_value</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM_PHYCOUNTER2</span><span class="p">,</span> <span class="n">MASKDWORD</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_rate_illegal</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret_value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_crc8_fail</span> <span class="o">=</span> <span class="p">((</span><span class="n">ret_value</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">ret_value</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM_PHYCOUNTER3</span><span class="p">,</span> <span class="n">MASKDWORD</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_mcs_fail</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret_value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_ofdm_fail</span> <span class="o">=</span> <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_parity_fail</span> <span class="o">+</span>
	    <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_rate_illegal</span> <span class="o">+</span>
	    <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_crc8_fail</span> <span class="o">+</span> <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_mcs_fail</span><span class="p">;</span>

	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_FALSEALARMREPORT</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ret_value</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_FACOUNTERLOWER</span><span class="p">,</span> <span class="n">MASKBYTE0</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_cck_fail</span> <span class="o">=</span> <span class="n">ret_value</span><span class="p">;</span>

	<span class="n">ret_value</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_FACOUNTERUPPER</span><span class="p">,</span> <span class="n">MASKBYTE3</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_cck_fail</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ret_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_parity_fail</span> <span class="o">+</span>
				 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_rate_illegal</span> <span class="o">+</span>
				 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_crc8_fail</span> <span class="o">+</span>
				 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_mcs_fail</span> <span class="o">+</span>
				 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_cck_fail</span><span class="p">);</span>

	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM1_LSTF</span><span class="p">,</span> <span class="mh">0x08000000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM1_LSTF</span><span class="p">,</span> <span class="mh">0x08000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_FALSEALARMREPORT</span><span class="p">,</span> <span class="mh">0x0000c000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_FALSEALARMREPORT</span><span class="p">,</span> <span class="mh">0x0000c000</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
		 <span class="s">&quot;cnt_parity_fail = %d, cnt_rate_illegal = %d, cnt_crc8_fail = %d, cnt_mcs_fail = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_parity_fail</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_rate_illegal</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_crc8_fail</span><span class="p">,</span> <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_mcs_fail</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
		 <span class="s">&quot;cnt_ofdm_fail = %x, cnt_cck_fail = %x, cnt_all = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_ofdm_fail</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_cck_fail</span><span class="p">,</span> <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_all</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_ctrl_initgain_by_fa</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">dm_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value_igi</span> <span class="o">=</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">falsealm_cnt</span><span class="p">.</span><span class="n">cnt_all</span> <span class="o">&lt;</span> <span class="n">DM_DIG_FA_TH0</span><span class="p">)</span>
		<span class="n">value_igi</span><span class="o">--</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">falsealm_cnt</span><span class="p">.</span><span class="n">cnt_all</span> <span class="o">&lt;</span> <span class="n">DM_DIG_FA_TH1</span><span class="p">)</span>
		<span class="n">value_igi</span> <span class="o">+=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">falsealm_cnt</span><span class="p">.</span><span class="n">cnt_all</span> <span class="o">&lt;</span> <span class="n">DM_DIG_FA_TH2</span><span class="p">)</span>
		<span class="n">value_igi</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">falsealm_cnt</span><span class="p">.</span><span class="n">cnt_all</span> <span class="o">&gt;=</span> <span class="n">DM_DIG_FA_TH2</span><span class="p">)</span>
		<span class="n">value_igi</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value_igi</span> <span class="o">&gt;</span> <span class="n">DM_DIG_FA_UPPER</span><span class="p">)</span>
		<span class="n">value_igi</span> <span class="o">=</span> <span class="n">DM_DIG_FA_UPPER</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value_igi</span> <span class="o">&lt;</span> <span class="n">DM_DIG_FA_LOWER</span><span class="p">)</span>
		<span class="n">value_igi</span> <span class="o">=</span> <span class="n">DM_DIG_FA_LOWER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">falsealm_cnt</span><span class="p">.</span><span class="n">cnt_all</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span>
		<span class="n">value_igi</span> <span class="o">=</span> <span class="mh">0x32</span><span class="p">;</span>

	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">=</span> <span class="n">value_igi</span><span class="p">;</span>
	<span class="n">rtl92c_dm_write_dig</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_ctrl_initgain_by_rssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">dm_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">falsealm_cnt</span><span class="p">.</span><span class="n">cnt_all</span> <span class="o">&gt;</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">fa_highthresh</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span>
		    <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val_range_min</span><span class="p">)</span>
			<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span> <span class="o">=</span>
			    <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val_range_min</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">falsealm_cnt</span><span class="p">.</span><span class="n">cnt_all</span> <span class="o">&lt;</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">fa_lowthresh</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span>
		    <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val_range_max</span><span class="p">)</span>
			<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span> <span class="o">=</span>
			    <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val_range_max</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">-</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span><span class="p">)</span> <span class="o">&gt;</span>
	    <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_max</span><span class="p">)</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">=</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_max</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">-</span>
		  <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_min</span><span class="p">)</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">=</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_min</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">=</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">-</span>
		    <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
		 <span class="s">&quot;rssi_val_min = %x backoff_val %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span><span class="p">,</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span><span class="p">);</span>

	<span class="n">rtl92c_dm_write_dig</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_initial_gain_multi_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">initialized</span><span class="p">;</span> <span class="cm">/* initialized to false */</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">dm_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="kt">long</span> <span class="n">rssi_strength</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">multi_sta</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="n">multi_sta</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">multi_sta</span> <span class="o">||</span>
	    <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">!=</span> <span class="n">DIG_STA_DISCONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span> <span class="o">=</span> <span class="n">DIG_EXT_PORT_STAGE_MAX</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">initialized</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span> <span class="o">=</span> <span class="n">DIG_EXT_PORT_STAGE_0</span><span class="p">;</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">rtl92c_dm_write_dig</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">curmultista_connectstate</span> <span class="o">==</span> <span class="n">DIG_MULTISTA_CONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rssi_strength</span> <span class="o">&lt;</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rssi_lowthresh</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span> <span class="o">!=</span> <span class="n">DIG_EXT_PORT_STAGE_1</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span> <span class="o">==</span>
			    <span class="n">DIG_EXT_PORT_STAGE_2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
				<span class="n">rtl92c_dm_write_dig</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span> <span class="o">=</span> <span class="n">DIG_EXT_PORT_STAGE_1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi_strength</span> <span class="o">&gt;</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rssi_highthresh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span> <span class="o">=</span> <span class="n">DIG_EXT_PORT_STAGE_2</span><span class="p">;</span>
			<span class="n">rtl92c_dm_ctrl_initgain_by_fa</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span> <span class="o">!=</span> <span class="n">DIG_EXT_PORT_STAGE_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span> <span class="o">=</span> <span class="n">DIG_EXT_PORT_STAGE_0</span><span class="p">;</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">rtl92c_dm_write_dig</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
		 <span class="s">&quot;curmultista_connectstate = %x dig_ext_port_stage %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">curmultista_connectstate</span><span class="p">,</span>
		 <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_initial_gain_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">dm_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
		 <span class="s">&quot;presta_connectstate = %x, cursta_connectctate = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">presta_connectstate</span><span class="p">,</span>
		 <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">presta_connectstate</span> <span class="o">==</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span>
	    <span class="o">||</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">==</span> <span class="n">DIG_STA_BEFORE_CONNECT</span>
	    <span class="o">||</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">==</span> <span class="n">DIG_STA_CONNECT</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">!=</span> <span class="n">DIG_STA_DISCONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">=</span>
			    <span class="n">rtl92c_dm_initial_gain_min_pwdb</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">rtl92c_dm_ctrl_initgain_by_rssi</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span> <span class="o">=</span> <span class="n">DIG_EXT_PORT_STAGE_MAX</span><span class="p">;</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span> <span class="o">=</span> <span class="n">DM_DIG_BACKOFF_DEFAULT</span><span class="p">;</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">pre_igvalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rtl92c_dm_write_dig</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_cck_packet_detection_thresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">dm_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">==</span> <span class="n">DIG_STA_CONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">=</span> <span class="n">rtl92c_dm_initial_gain_min_pwdb</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">pre_cck_pd_state</span> <span class="o">==</span> <span class="n">CCK_PD_STAGE_LowRssi</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">)</span>
				<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">=</span>
				    <span class="n">CCK_PD_STAGE_LowRssi</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">=</span>
				    <span class="n">CCK_PD_STAGE_HighRssi</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">)</span>
				<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">=</span>
				    <span class="n">CCK_PD_STAGE_LowRssi</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">=</span>
				    <span class="n">CCK_PD_STAGE_HighRssi</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">=</span> <span class="n">CCK_PD_STAGE_MAX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">pre_cck_pd_state</span> <span class="o">!=</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">==</span> <span class="n">CCK_PD_STAGE_LowRssi</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">falsealm_cnt</span><span class="p">.</span><span class="n">cnt_cck_fail</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">)</span>
				<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_fa_state</span> <span class="o">=</span>
				    <span class="n">CCK_FA_STAGE_High</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_fa_state</span> <span class="o">=</span> <span class="n">CCK_FA_STAGE_Low</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">pre_cck_fa_state</span> <span class="o">!=</span>
			    <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_fa_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_fa_state</span> <span class="o">==</span>
				    <span class="n">CCK_FA_STAGE_Low</span><span class="p">)</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_CCA</span><span class="p">,</span> <span class="n">MASKBYTE2</span><span class="p">,</span>
						      <span class="mh">0x83</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_CCA</span><span class="p">,</span> <span class="n">MASKBYTE2</span><span class="p">,</span>
						      <span class="mh">0xcd</span><span class="p">);</span>

				<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">pre_cck_fa_state</span> <span class="o">=</span>
				    <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_fa_state</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_SYSTEM</span><span class="p">,</span> <span class="n">MASKBYTE1</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">IS_92C_SERIAL</span><span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">))</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_FALSEALARMREPORT</span><span class="p">,</span>
					      <span class="n">MASKBYTE2</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_CCA</span><span class="p">,</span> <span class="n">MASKBYTE2</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">);</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_SYSTEM</span><span class="p">,</span> <span class="n">MASKBYTE1</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">IS_92C_SERIAL</span><span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">))</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_FALSEALARMREPORT</span><span class="p">,</span>
					      <span class="n">MASKBYTE2</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">pre_cck_pd_state</span> <span class="o">=</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;CCKPDStage=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;is92C=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">IS_92C_SERIAL</span><span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_ctrl_initgain_by_twoport</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">dm_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">act_scanning</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&gt;=</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">=</span> <span class="n">DIG_STA_CONNECT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">=</span> <span class="n">DIG_STA_DISCONNECT</span><span class="p">;</span>

	<span class="n">rtl92c_dm_initial_gain_sta</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl92c_dm_initial_gain_multi_sta</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl92c_dm_cck_packet_detection_thresh</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">presta_connectstate</span> <span class="o">=</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_dig</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">dm_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_initialgain_enable</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">dig_enable_flag</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rtl92c_dm_ctrl_initgain_by_twoport</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_init_dynamic_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txpower_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">last_dtp_lvl</span> <span class="o">=</span> <span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span> <span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92c_dm_write_dig</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">dm_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;cur_igvalue = 0x%x, pre_igvalue = 0x%x, backoff_val = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">,</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">pre_igvalue</span><span class="p">,</span>
		 <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span><span class="p">);</span>

	<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">&gt;</span> <span class="mh">0x3f</span><span class="p">)</span>
		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">pre_igvalue</span> <span class="o">!=</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XAAGCCORE1</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span>
			      <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">);</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XBAGCCORE1</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span>
			      <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">);</span>

		<span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">pre_igvalue</span> <span class="o">=</span> <span class="n">dm_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl92c_dm_write_dig</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_pwdb_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">tmpentry_max_pwdb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmpentry_min_pwdb</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">h2c_parameter</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmpentry_max_pwdb</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_max_undecoratedsmoothed_pwdb</span> <span class="o">=</span>
		    <span class="n">tmpentry_max_pwdb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_max_undecoratedsmoothed_pwdb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmpentry_min_pwdb</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span> <span class="o">=</span>
		    <span class="n">tmpentry_min_pwdb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">h2c_parameter</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">h2c_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtl92c_fill_h2c_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">H2C_RSSI_REPORT</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">h2c_parameter</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92c_dm_init_edca_turbo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_any_nonbepkts</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_cur_rdlstate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl92c_dm_init_edca_turbo</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_check_edca_turbo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">rtlpcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="k">static</span> <span class="n">u64</span> <span class="n">last_txok_cnt</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u64</span> <span class="n">last_rxok_cnt</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">last_bt_edca_ul</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">last_bt_edca_dl</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cur_txok_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cur_rxok_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">edca_be_ul</span> <span class="o">=</span> <span class="mh">0x5ea42b</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">edca_be_dl</span> <span class="o">=</span> <span class="mh">0x5ea42b</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bt_change_edca</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">last_bt_edca_ul</span> <span class="o">!=</span> <span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_ul</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">last_bt_edca_dl</span> <span class="o">!=</span> <span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_dl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">last_bt_edca_ul</span> <span class="o">=</span> <span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_ul</span><span class="p">;</span>
		<span class="n">last_bt_edca_dl</span> <span class="o">=</span> <span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_dl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_ul</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edca_be_ul</span> <span class="o">=</span> <span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_ul</span><span class="p">;</span>
		<span class="n">bt_change_edca</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_dl</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edca_be_ul</span> <span class="o">=</span> <span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_dl</span><span class="p">;</span>
		<span class="n">bt_change_edca</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">!=</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ht_enable</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_coexistence</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">edca_be_ul</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">))</span>
			<span class="n">edca_be_ul</span> <span class="o">|=</span> <span class="mh">0x005e0000</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">edca_be_dl</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">))</span>
			<span class="n">edca_be_dl</span> <span class="o">|=</span> <span class="mh">0x005e0000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bt_change_edca</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_any_nonbepkts</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">disable_framebursting</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">cur_txok_cnt</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytesunicast</span> <span class="o">-</span> <span class="n">last_txok_cnt</span><span class="p">;</span>
		<span class="n">cur_rxok_cnt</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxbytesunicast</span> <span class="o">-</span> <span class="n">last_rxok_cnt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur_rxok_cnt</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">cur_txok_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_cur_rdlstate</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span>
						<span class="n">REG_EDCA_BE_PARAM</span><span class="p">,</span>
						<span class="n">edca_be_dl</span><span class="p">);</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_cur_rdlstate</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_cur_rdlstate</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span>
						<span class="n">REG_EDCA_BE_PARAM</span><span class="p">,</span>
						<span class="n">edca_be_ul</span><span class="p">);</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_cur_rdlstate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">AC0_BE</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						      <span class="n">HW_VAR_AC_PARAM</span><span class="p">,</span>
						      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">));</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_any_nonbepkts</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">last_txok_cnt</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytesunicast</span><span class="p">;</span>
	<span class="n">last_rxok_cnt</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxbytesunicast</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_txpower_tracking_callback_thermalmeter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span>
							     <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span> <span class="o">=</span> <span class="n">rtl_efuse</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">thermalvalue</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">delta_lck</span><span class="p">,</span> <span class="n">delta_iqk</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ele_a</span><span class="p">,</span> <span class="n">ele_d</span><span class="p">,</span> <span class="n">temp_cck</span><span class="p">,</span> <span class="n">val_x</span><span class="p">,</span> <span class="n">value32</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val_y</span><span class="p">,</span> <span class="n">ele_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ofdm_index</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cck_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ofdm_index_old</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cck_index_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is2t</span> <span class="o">=</span> <span class="n">IS_92C_SERIAL</span><span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
	<span class="n">s8</span> <span class="n">txpwr_level</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="n">u8</span> <span class="n">ofdm_min_index</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">rf</span><span class="p">;</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_trackinginit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;rtl92c_dm_txpower_tracking_callback_thermalmeter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">thermalvalue</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">rtl_get_rfreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RF90_PATH_A</span><span class="p">,</span> <span class="n">RF_T_METER</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;Readback Thermal Meter = 0x%x pre thermal meter 0x%x eeprom_thermalmeter 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">thermalvalue</span><span class="p">,</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span><span class="p">,</span>
		 <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">);</span>

	<span class="n">rtl92c_phy_ap_calibrate</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">-</span>
				     <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is2t</span><span class="p">)</span>
		<span class="n">rf</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">thermalvalue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ele_d</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XATXIQIMBALANCE</span><span class="p">,</span>
				      <span class="n">MASKDWORD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASKOFDM_D</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OFDM_TABLE_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ele_d</span> <span class="o">==</span> <span class="p">(</span><span class="n">ofdmswing_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MASKOFDM_D</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ofdm_index_old</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">;</span>

				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;Initial pathA ele_d reg0x%x = 0x%lx, ofdm_index=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ROFDM0_XATXIQIMBALANCE</span><span class="p">,</span>
					 <span class="n">ele_d</span><span class="p">,</span> <span class="n">ofdm_index_old</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is2t</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ele_d</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XBTXIQIMBALANCE</span><span class="p">,</span>
					      <span class="n">MASKDWORD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASKOFDM_D</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OFDM_TABLE_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ele_d</span> <span class="o">==</span> <span class="p">(</span><span class="n">ofdmswing_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span>
				    <span class="n">MASKOFDM_D</span><span class="p">))</span> <span class="p">{</span>

					<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span>
						 <span class="n">DBG_LOUD</span><span class="p">,</span>
						 <span class="s">&quot;Initial pathB ele_d reg0x%x = 0x%lx, ofdm_index=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">ROFDM0_XBTXIQIMBALANCE</span><span class="p">,</span> <span class="n">ele_d</span><span class="p">,</span>
						 <span class="n">ofdm_index_old</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">temp_cck</span> <span class="o">=</span>
		    <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_TXFILTER2</span><span class="p">,</span> <span class="n">MASKDWORD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASKCCK</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CCK_TABLE_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_inch14</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp_cck</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cckswing_table_ch14</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
					   <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cck_index_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">;</span>

					<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span>
						 <span class="n">DBG_LOUD</span><span class="p">,</span>
						 <span class="s">&quot;Initial reg0x%x = 0x%lx, cck_index=0x%x, ch 14 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">RCCK0_TXFILTER2</span><span class="p">,</span> <span class="n">temp_cck</span><span class="p">,</span>
						 <span class="n">cck_index_old</span><span class="p">,</span>
						 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_inch14</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp_cck</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span>
					   <span class="o">&amp;</span><span class="n">cckswing_table_ch1ch13</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
					   <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cck_index_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">;</span>

					<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span>
						 <span class="n">DBG_LOUD</span><span class="p">,</span>
						 <span class="s">&quot;Initial reg0x%x = 0x%lx, cck_index=0x%x, ch14 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">RCCK0_TXFILTER2</span><span class="p">,</span> <span class="n">temp_cck</span><span class="p">,</span>
						 <span class="n">cck_index_old</span><span class="p">,</span>
						 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_inch14</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span> <span class="o">=</span>
			    <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_lck</span> <span class="o">=</span> <span class="n">thermalvalue</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_iqk</span> <span class="o">=</span> <span class="n">thermalvalue</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ofdm_index_old</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_index</span> <span class="o">=</span> <span class="n">cck_index_old</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span><span class="p">)</span> <span class="o">?</span>
		    <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">-</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span><span class="p">)</span> <span class="o">:</span>
		    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span> <span class="o">-</span> <span class="n">thermalvalue</span><span class="p">);</span>

		<span class="n">delta_lck</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_lck</span><span class="p">)</span> <span class="o">?</span>
		    <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">-</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_lck</span><span class="p">)</span> <span class="o">:</span>
		    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_lck</span> <span class="o">-</span> <span class="n">thermalvalue</span><span class="p">);</span>

		<span class="n">delta_iqk</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_iqk</span><span class="p">)</span> <span class="o">?</span>
		    <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">-</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_iqk</span><span class="p">)</span> <span class="o">:</span>
		    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_iqk</span> <span class="o">-</span> <span class="n">thermalvalue</span><span class="p">);</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;Readback Thermal Meter = 0x%x pre thermal meter 0x%x eeprom_thermalmeter 0x%x delta 0x%x delta_lck 0x%x delta_iqk 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">thermalvalue</span><span class="p">,</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span><span class="p">,</span>
			 <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">delta_lck</span><span class="p">,</span>
			 <span class="n">delta_iqk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">delta_lck</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_lck</span> <span class="o">=</span> <span class="n">thermalvalue</span><span class="p">;</span>
			<span class="n">rtl92c_phy_lc_calibrate</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_track_control</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">delta</span><span class="p">;</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_index</span> <span class="o">-=</span> <span class="n">delta</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_index</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is2t</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;temp OFDM_A_index=0x%x, OFDM_B_index=0x%x, cck_index=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_index</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;temp OFDM_A_index=0x%x, cck_index=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_index</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
					    <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">cck_index</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">cck_index</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_index</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">txpwr_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="n">txpwr_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">26</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span>
					    <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
							<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

						<span class="k">else</span>
							<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">thermalvalue</span> <span class="o">&lt;</span>
						   <span class="n">rtlefuse</span><span class="o">-&gt;</span>
						   <span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpwr_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">27</span> <span class="o">&amp;&amp;</span>
					   <span class="n">txpwr_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">32</span>
					   <span class="o">&amp;&amp;</span> <span class="n">thermalvalue</span> <span class="o">&gt;</span>
					   <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
						<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

					<span class="k">else</span>
						<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpwr_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span>
					   <span class="n">txpwr_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">38</span> <span class="o">&amp;&amp;</span>
					   <span class="n">thermalvalue</span> <span class="o">&gt;</span>
					   <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span>
					   <span class="o">&amp;&amp;</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">txpwr_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">txpwr_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">26</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span>
				    <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
						<span class="n">cck_index</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

					<span class="k">else</span>
						<span class="n">cck_index</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">thermalvalue</span> <span class="o">&lt;</span>
					   <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cck_index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpwr_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">27</span> <span class="o">&amp;&amp;</span>
				   <span class="n">txpwr_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span>
				   <span class="n">thermalvalue</span> <span class="o">&gt;</span>
				   <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">cck_index</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="k">else</span>
					<span class="n">cck_index</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpwr_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span>
				   <span class="n">txpwr_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">38</span> <span class="o">&amp;&amp;</span>
				   <span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span>
				   <span class="o">&amp;&amp;</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cck_index</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">OFDM_TABLE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">OFDM_TABLE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ofdm_min_index</span><span class="p">)</span>
					<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ofdm_min_index</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cck_index</span> <span class="o">&gt;</span> <span class="n">CCK_TABLE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">cck_index</span> <span class="o">=</span> <span class="n">CCK_TABLE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cck_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">cck_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is2t</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;new OFDM_A_index=0x%x, OFDM_B_index=0x%x, cck_index=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ofdm_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ofdm_index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					 <span class="n">cck_index</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;new OFDM_A_index=0x%x, cck_index=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ofdm_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cck_index</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_track_control</span> <span class="o">&amp;&amp;</span> <span class="n">delta</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ele_d</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">ofdmswing_table</span><span class="p">[</span><span class="n">ofdm_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0xFFC00000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">;</span>
			<span class="n">val_x</span> <span class="o">=</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">reg_e94</span><span class="p">;</span>
			<span class="n">val_y</span> <span class="o">=</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">reg_e9c</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">val_x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">val_x</span> <span class="o">&amp;</span> <span class="mh">0x00000200</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">val_x</span> <span class="o">=</span> <span class="n">val_x</span> <span class="o">|</span> <span class="mh">0xFFFFFC00</span><span class="p">;</span>
				<span class="n">ele_a</span> <span class="o">=</span> <span class="p">((</span><span class="n">val_x</span> <span class="o">*</span> <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000003FF</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">val_y</span> <span class="o">&amp;</span> <span class="mh">0x00000200</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">val_y</span> <span class="o">=</span> <span class="n">val_y</span> <span class="o">|</span> <span class="mh">0xFFFFFC00</span><span class="p">;</span>
				<span class="n">ele_c</span> <span class="o">=</span> <span class="p">((</span><span class="n">val_y</span> <span class="o">*</span> <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000003FF</span><span class="p">;</span>

				<span class="n">value32</span> <span class="o">=</span> <span class="p">(</span><span class="n">ele_d</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">((</span><span class="n">ele_c</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ele_a</span><span class="p">;</span>

				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XATXIQIMBALANCE</span><span class="p">,</span>
					      <span class="n">MASKDWORD</span><span class="p">,</span> <span class="n">value32</span><span class="p">);</span>

				<span class="n">value32</span> <span class="o">=</span> <span class="p">(</span><span class="n">ele_c</span> <span class="o">&amp;</span> <span class="mh">0x000003C0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XCTXAFE</span><span class="p">,</span> <span class="n">MASKH4BITS</span><span class="p">,</span>
					      <span class="n">value32</span><span class="p">);</span>

				<span class="n">value32</span> <span class="o">=</span> <span class="p">((</span><span class="n">val_x</span> <span class="o">*</span> <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_ECCATHRESHOLD</span><span class="p">,</span>
					      <span class="n">BIT</span><span class="p">(</span><span class="mi">31</span><span class="p">),</span> <span class="n">value32</span><span class="p">);</span>

				<span class="n">value32</span> <span class="o">=</span> <span class="p">((</span><span class="n">val_y</span> <span class="o">*</span> <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_ECCATHRESHOLD</span><span class="p">,</span>
					      <span class="n">BIT</span><span class="p">(</span><span class="mi">29</span><span class="p">),</span> <span class="n">value32</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XATXIQIMBALANCE</span><span class="p">,</span>
					      <span class="n">MASKDWORD</span><span class="p">,</span>
					      <span class="n">ofdmswing_table</span><span class="p">[</span><span class="n">ofdm_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]);</span>

				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XCTXAFE</span><span class="p">,</span> <span class="n">MASKH4BITS</span><span class="p">,</span>
					      <span class="mh">0x00</span><span class="p">);</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_ECCATHRESHOLD</span><span class="p">,</span>
					      <span class="n">BIT</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">29</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_inch14</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa22</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch1ch13</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa23</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch1ch13</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa24</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch1ch13</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa25</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch1ch13</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa26</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch1ch13</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa27</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch1ch13</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa28</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch1ch13</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa29</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch1ch13</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa22</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch14</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa23</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch14</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa24</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch14</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa25</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch14</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa26</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch14</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa27</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch14</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa28</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch14</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa29</span><span class="p">,</span>
					       <span class="n">cckswing_table_ch14</span><span class="p">[</span><span class="n">cck_index</span><span class="p">]</span>
					       <span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is2t</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ele_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">ofdmswing_table</span><span class="p">[</span><span class="n">ofdm_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&amp;</span>
					 <span class="mh">0xFFC00000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">;</span>

				<span class="n">val_x</span> <span class="o">=</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">reg_eb4</span><span class="p">;</span>
				<span class="n">val_y</span> <span class="o">=</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">reg_ebc</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">val_x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">val_x</span> <span class="o">&amp;</span> <span class="mh">0x00000200</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">val_x</span> <span class="o">=</span> <span class="n">val_x</span> <span class="o">|</span> <span class="mh">0xFFFFFC00</span><span class="p">;</span>
					<span class="n">ele_a</span> <span class="o">=</span> <span class="p">((</span><span class="n">val_x</span> <span class="o">*</span> <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span>
					    <span class="mh">0x000003FF</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">((</span><span class="n">val_y</span> <span class="o">&amp;</span> <span class="mh">0x00000200</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">val_y</span> <span class="o">=</span> <span class="n">val_y</span> <span class="o">|</span> <span class="mh">0xFFFFFC00</span><span class="p">;</span>
					<span class="n">ele_c</span> <span class="o">=</span> <span class="p">((</span><span class="n">val_y</span> <span class="o">*</span> <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span>
					    <span class="mh">0x00003FF</span><span class="p">;</span>

					<span class="n">value32</span> <span class="o">=</span> <span class="p">(</span><span class="n">ele_d</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span>
					    <span class="p">((</span><span class="n">ele_c</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ele_a</span><span class="p">;</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						      <span class="n">ROFDM0_XBTXIQIMBALANCE</span><span class="p">,</span>
						      <span class="n">MASKDWORD</span><span class="p">,</span> <span class="n">value32</span><span class="p">);</span>

					<span class="n">value32</span> <span class="o">=</span> <span class="p">(</span><span class="n">ele_c</span> <span class="o">&amp;</span> <span class="mh">0x000003C0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XDTXAFE</span><span class="p">,</span>
						      <span class="n">MASKH4BITS</span><span class="p">,</span> <span class="n">value32</span><span class="p">);</span>

					<span class="n">value32</span> <span class="o">=</span> <span class="p">((</span><span class="n">val_x</span> <span class="o">*</span> <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_ECCATHRESHOLD</span><span class="p">,</span>
						      <span class="n">BIT</span><span class="p">(</span><span class="mi">27</span><span class="p">),</span> <span class="n">value32</span><span class="p">);</span>

					<span class="n">value32</span> <span class="o">=</span> <span class="p">((</span><span class="n">val_y</span> <span class="o">*</span> <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_ECCATHRESHOLD</span><span class="p">,</span>
						      <span class="n">BIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span> <span class="n">value32</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						      <span class="n">ROFDM0_XBTXIQIMBALANCE</span><span class="p">,</span>
						      <span class="n">MASKDWORD</span><span class="p">,</span>
						      <span class="n">ofdmswing_table</span><span class="p">[</span><span class="n">ofdm_index</span>
								      <span class="p">[</span><span class="mi">1</span><span class="p">]]);</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XDTXAFE</span><span class="p">,</span>
						      <span class="n">MASKH4BITS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_ECCATHRESHOLD</span><span class="p">,</span>
						      <span class="n">BIT</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">);</span>
				<span class="p">}</span>

			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">delta_iqk</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_iqk</span> <span class="o">=</span> <span class="n">thermalvalue</span><span class="p">;</span>
			<span class="n">rtl92c_phy_iq_calibrate</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_track_control</span><span class="p">)</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span> <span class="o">=</span> <span class="n">thermalvalue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;&lt;===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_initialize_txpower_tracking_thermalmeter</span><span class="p">(</span>
						<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_tracking</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_trackinginit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;pMgntInfo-&gt;txpower_tracking = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_tracking</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_initialize_txpower_tracking</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl92c_dm_initialize_txpower_tracking_thermalmeter</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_txpower_tracking_directcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl92c_dm_txpower_tracking_callback_thermalmeter</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_check_txpower_tracking_thermal_meter</span><span class="p">(</span>
						<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">tm_trigger</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_tracking</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tm_trigger</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl_set_rfreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RF90_PATH_A</span><span class="p">,</span> <span class="n">RF_T_METER</span><span class="p">,</span> <span class="n">RFREG_OFFSET_MASK</span><span class="p">,</span>
			      <span class="mh">0x60</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;Trigger 92S Thermal Meter!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tm_trigger</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;Schedule TxPowerTracking direct call!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtl92c_dm_txpower_tracking_directcall</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">tm_trigger</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92c_dm_check_txpower_tracking</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl92c_dm_check_txpower_tracking_thermal_meter</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl92c_dm_check_txpower_tracking</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtl92c_dm_init_rate_adaptive_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rate_adaptive</span> <span class="o">*</span><span class="n">p_ra</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">ra</span><span class="p">);</span>

	<span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">ratr_state</span> <span class="o">=</span> <span class="n">DM_RATR_STA_INIT</span><span class="p">;</span>
	<span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">pre_ratr_state</span> <span class="o">=</span> <span class="n">DM_RATR_STA_INIT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_type</span> <span class="o">==</span> <span class="n">DM_TYPE_BYDRIVER</span><span class="p">)</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">useramask</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">useramask</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl92c_dm_init_rate_adaptive_mask</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_refresh_rate_adaptive_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rate_adaptive</span> <span class="o">*</span><span class="n">p_ra</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">ra</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">low_rssithresh_for_ra</span><span class="p">,</span> <span class="n">high_rssithresh_for_ra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_hal_stop</span><span class="p">(</span><span class="n">rtlhal</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RATE</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;&lt;---- driver is going to unload</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">useramask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RATE</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;&lt;---- driver does not control rate adaptive mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">==</span> <span class="n">MAC80211_LINKED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">pre_ratr_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DM_RATR_STA_HIGH</span>:
			<span class="n">high_rssithresh_for_ra</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
			<span class="n">low_rssithresh_for_ra</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DM_RATR_STA_MIDDLE</span>:
			<span class="n">high_rssithresh_for_ra</span> <span class="o">=</span> <span class="mi">55</span><span class="p">;</span>
			<span class="n">low_rssithresh_for_ra</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DM_RATR_STA_LOW</span>:
			<span class="n">high_rssithresh_for_ra</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
			<span class="n">low_rssithresh_for_ra</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">high_rssithresh_for_ra</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
			<span class="n">low_rssithresh_for_ra</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&gt;</span>
		    <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">high_rssithresh_for_ra</span><span class="p">)</span>
			<span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">ratr_state</span> <span class="o">=</span> <span class="n">DM_RATR_STA_HIGH</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&gt;</span>
			 <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">low_rssithresh_for_ra</span><span class="p">)</span>
			<span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">ratr_state</span> <span class="o">=</span> <span class="n">DM_RATR_STA_MIDDLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">ratr_state</span> <span class="o">=</span> <span class="n">DM_RATR_STA_LOW</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">pre_ratr_state</span> <span class="o">!=</span> <span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">ratr_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RATE</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;RSSI = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span><span class="p">);</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RATE</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;RSSI_LEVEL = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">ratr_state</span><span class="p">);</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RATE</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;PreState = %d, CurState = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">pre_ratr_state</span><span class="p">,</span> <span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">ratr_state</span><span class="p">);</span>

			<span class="cm">/* Only the PCI card uses sta in the update rate table</span>
<span class="cm">			 * callback routine */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">==</span> <span class="n">INTF_PCI</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rcu_read_lock</span><span class="p">();</span>
				<span class="n">sta</span> <span class="o">=</span> <span class="n">ieee80211_find_sta</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">update_rate_tbl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span>
					<span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">ratr_state</span><span class="p">);</span>

			<span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">pre_ratr_state</span> <span class="o">=</span> <span class="n">p_ra</span><span class="o">-&gt;</span><span class="n">ratr_state</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">==</span> <span class="n">INTF_PCI</span><span class="p">)</span>
				<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_init_dynamic_bb_powersaving</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ps_t</span> <span class="o">*</span><span class="n">dm_pstable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_pstable</span><span class="p">;</span>

	<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">pre_ccastate</span> <span class="o">=</span> <span class="n">CCA_MAX</span><span class="p">;</span>
	<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">cur_ccasate</span> <span class="o">=</span> <span class="n">CCA_MAX</span><span class="p">;</span>
	<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">pre_rfstate</span> <span class="o">=</span> <span class="n">RF_MAX</span><span class="p">;</span>
	<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">cur_rfstate</span> <span class="o">=</span> <span class="n">RF_MAX</span><span class="p">;</span>
	<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92c_dm_rf_saving</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bforce_in_normal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ps_t</span> <span class="o">*</span><span class="n">dm_pstable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_pstable</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">initialize</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">reg_874</span><span class="p">,</span> <span class="n">reg_c70</span><span class="p">,</span> <span class="n">reg_85c</span><span class="p">,</span> <span class="n">reg_a74</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initialize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_874</span> <span class="o">=</span> <span class="p">(</span><span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_XCD_RFINTERFACESW</span><span class="p">,</span>
					 <span class="n">MASKDWORD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1CC000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">;</span>

		<span class="n">reg_c70</span> <span class="o">=</span> <span class="p">(</span><span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_AGCPARAMETER1</span><span class="p">,</span>
					 <span class="n">MASKDWORD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

		<span class="n">reg_85c</span> <span class="o">=</span> <span class="p">(</span><span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_XCD_SWITCHCONTROL</span><span class="p">,</span>
					 <span class="n">MASKDWORD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>

		<span class="n">reg_a74</span> <span class="o">=</span> <span class="p">(</span><span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xa74</span><span class="p">,</span> <span class="n">MASKDWORD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>

		<span class="n">initialize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bforce_in_normal</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">pre_rfstate</span> <span class="o">==</span> <span class="n">RF_NORMAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span>
					<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">cur_rfstate</span> <span class="o">=</span> <span class="n">RF_SAVE</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">cur_rfstate</span> <span class="o">=</span> <span class="n">RF_NORMAL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">)</span>
					<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">cur_rfstate</span> <span class="o">=</span> <span class="n">RF_NORMAL</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">cur_rfstate</span> <span class="o">=</span> <span class="n">RF_SAVE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">cur_rfstate</span> <span class="o">=</span> <span class="n">RF_MAX</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">cur_rfstate</span> <span class="o">=</span> <span class="n">RF_NORMAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">pre_rfstate</span> <span class="o">!=</span> <span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">cur_rfstate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">cur_rfstate</span> <span class="o">==</span> <span class="n">RF_SAVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_XCD_RFINTERFACESW</span><span class="p">,</span>
				      <span class="mh">0x1C0000</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_AGCPARAMETER1</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_XCD_SWITCHCONTROL</span><span class="p">,</span>
				      <span class="mh">0xFF000000</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">);</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_XCD_RFINTERFACESW</span><span class="p">,</span>
				      <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xa74</span><span class="p">,</span> <span class="mh">0xF000</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x818</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x818</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_XCD_RFINTERFACESW</span><span class="p">,</span>
				      <span class="mh">0x1CC000</span><span class="p">,</span> <span class="n">reg_874</span><span class="p">);</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_AGCPARAMETER1</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
				      <span class="n">reg_c70</span><span class="p">);</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_XCD_SWITCHCONTROL</span><span class="p">,</span> <span class="mh">0xFF000000</span><span class="p">,</span>
				      <span class="n">reg_85c</span><span class="p">);</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xa74</span><span class="p">,</span> <span class="mh">0xF000</span><span class="p">,</span> <span class="n">reg_a74</span><span class="p">);</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x818</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">pre_rfstate</span> <span class="o">=</span> <span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">cur_rfstate</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl92c_dm_rf_saving</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_dm_dynamic_bb_powersaving</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ps_t</span> <span class="o">*</span><span class="n">dm_pstable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_pstable</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">==</span> <span class="n">MAC80211_NOLINK</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;Not connected to any</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">==</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">=</span>
			    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;AP Client PWDB = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">=</span>
			    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;STA Default Port PWDB = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span> <span class="o">=</span>
		    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span><span class="p">;</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;AP Ext Port PWDB = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dm_pstable</span><span class="o">-&gt;</span><span class="n">rssi_val_min</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_92C_SERIAL</span><span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">))</span>
		<span class="p">;</span><span class="cm">/* rtl92c_dm_1r_cca(hw); */</span>
	<span class="k">else</span>
		<span class="n">rtl92c_dm_rf_saving</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92c_dm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_type</span> <span class="o">=</span> <span class="n">DM_TYPE_BYDRIVER</span><span class="p">;</span>
	<span class="n">rtl92c_dm_diginit</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl92c_dm_init_dynamic_txpower</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl92c_dm_init_edca_turbo</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl92c_dm_init_rate_adaptive_mask</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl92c_dm_initialize_txpower_tracking</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl92c_dm_init_dynamic_bb_powersaving</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl92c_dm_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtl92c_dm_dynamic_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="kt">long</span> <span class="n">undecorated_smoothed_pwdb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txpower_enable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_flag</span> <span class="o">&amp;</span> <span class="n">HAL_DM_HIPWR_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span> <span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&lt;</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;Not connected to any</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span> <span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>

		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">last_dtp_lvl</span> <span class="o">=</span> <span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&gt;=</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">undecorated_smoothed_pwdb</span> <span class="o">=</span>
			    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;AP Client PWDB = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">undecorated_smoothed_pwdb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">undecorated_smoothed_pwdb</span> <span class="o">=</span>
			    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;STA Default Port PWDB = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">undecorated_smoothed_pwdb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">undecorated_smoothed_pwdb</span> <span class="o">=</span>
		    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span><span class="p">;</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;AP Ext Port PWDB = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">undecorated_smoothed_pwdb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&gt;=</span> <span class="n">TX_POWER_NEAR_FIELD_THRESH_LVL2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span> <span class="n">TXHIGHPWRLEVEL_LEVEL1</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;TXHIGHPWRLEVEL_LEVEL1 (TxPwr=0x0)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&lt;</span>
		    <span class="p">(</span><span class="n">TX_POWER_NEAR_FIELD_THRESH_LVL2</span> <span class="o">-</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&gt;=</span>
		    <span class="n">TX_POWER_NEAR_FIELD_THRESH_LVL1</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span> <span class="n">TXHIGHPWRLEVEL_LEVEL1</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;TXHIGHPWRLEVEL_LEVEL1 (TxPwr=0x10)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&lt;</span>
		   <span class="p">(</span><span class="n">TX_POWER_NEAR_FIELD_THRESH_LVL1</span> <span class="o">-</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span> <span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;TXHIGHPWRLEVEL_NORMAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">!=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">last_dtp_lvl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;PHY_SetTxPowerLevel8192S() Channel = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_channel</span><span class="p">);</span>
		<span class="n">rtl92c_phy_set_txpower_level</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_channel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">last_dtp_lvl</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92c_dm_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">bool</span> <span class="n">fw_current_inpsmode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fw_ps_awake</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_FW_PSMODE_STATUS</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fw_current_inpsmode</span><span class="p">));</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_FWLPS_RF_ON</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fw_ps_awake</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfpwr_state</span> <span class="o">==</span> <span class="n">ERFON</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="o">!</span><span class="n">fw_current_inpsmode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					     <span class="n">fw_ps_awake</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfchange_inprogress</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtl92c_dm_pwdb_monitor</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtl92c_dm_dig</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtl92c_dm_false_alarm_counter_statistics</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtl92c_dm_dynamic_bb_powersaving</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtl92c_dm_dynamic_txpower</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtl92c_dm_check_txpower_tracking</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtl92c_dm_refresh_rate_adaptive_mask</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtl92c_dm_bt_coexist</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtl92c_dm_check_edca_turbo</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl92c_dm_watchdog</span><span class="p">);</span>

<span class="n">u8</span> <span class="nf">rtl92c_bt_rssi_state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">rtlpcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">undecorated_smoothed_pwdb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">curr_bt_rssi_state</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">link_state</span> <span class="o">==</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">undecorated_smoothed_pwdb</span> <span class="o">=</span>
				 <span class="n">GET_UNDECORATED_AVERAGE_RSSI</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">undecorated_smoothed_pwdb</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">undecorated_smoothed_pwdb</span> <span class="o">=</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">entry_min_undecoratedsmoothed_pwdb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check RSSI to determine HighPower/NormalPower state for</span>
<span class="cm">	 * BT coexistence. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&gt;=</span> <span class="mi">67</span><span class="p">)</span>
		<span class="n">curr_bt_rssi_state</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">BT_RSSI_STATE_NORMAL_POWER</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&lt;</span> <span class="mi">62</span><span class="p">)</span>
		<span class="n">curr_bt_rssi_state</span> <span class="o">|=</span> <span class="n">BT_RSSI_STATE_NORMAL_POWER</span><span class="p">;</span>

	<span class="cm">/* Check RSSI to determine AMPDU setting for BT coexistence. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&gt;=</span> <span class="mi">40</span><span class="p">)</span>
		<span class="n">curr_bt_rssi_state</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">BT_RSSI_STATE_AMDPU_OFF</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">curr_bt_rssi_state</span> <span class="o">|=</span> <span class="n">BT_RSSI_STATE_AMDPU_OFF</span><span class="p">;</span>

	<span class="cm">/* Marked RSSI state. It will be used to determine BT coexistence</span>
<span class="cm">	 * setting later. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&lt;</span> <span class="mi">35</span><span class="p">)</span>
		<span class="n">curr_bt_rssi_state</span> <span class="o">|=</span>  <span class="n">BT_RSSI_STATE_SPECIAL_LOW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">curr_bt_rssi_state</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">BT_RSSI_STATE_SPECIAL_LOW</span><span class="p">);</span>

	<span class="cm">/* Set Tx Power according to BT status. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span>
		<span class="n">curr_bt_rssi_state</span> <span class="o">|=</span>  <span class="n">BT_RSSI_STATE_TXPOWER_LOW</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)</span>
		<span class="n">curr_bt_rssi_state</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">BT_RSSI_STATE_TXPOWER_LOW</span><span class="p">);</span>

	<span class="cm">/* Check BT state related to BT_Idle in B/G mode. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">curr_bt_rssi_state</span> <span class="o">|=</span>  <span class="n">BT_RSSI_STATE_BG_EDCA_LOW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">curr_bt_rssi_state</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">BT_RSSI_STATE_BG_EDCA_LOW</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr_bt_rssi_state</span> <span class="o">!=</span> <span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_rssi_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_rssi_state</span> <span class="o">=</span> <span class="n">curr_bt_rssi_state</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl92c_bt_rssi_state_change</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rtl92c_bt_state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">rtlpcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">polling</span><span class="p">,</span> <span class="n">ratio_tx</span><span class="p">,</span> <span class="n">ratio_pri</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bt_tx</span><span class="p">,</span> <span class="n">bt_pri</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bt_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cur_service_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">link_state</span> <span class="o">&lt;</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">bt_state</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x4fd</span><span class="p">);</span>
	<span class="n">bt_tx</span> <span class="o">=</span> <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x488</span><span class="p">);</span>
	<span class="n">bt_tx</span> <span class="o">=</span> <span class="n">bt_tx</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
	<span class="n">bt_pri</span> <span class="o">=</span> <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x48c</span><span class="p">);</span>
	<span class="n">bt_pri</span> <span class="o">=</span> <span class="n">bt_pri</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
	<span class="n">polling</span> <span class="o">=</span> <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x490</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bt_tx</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span> <span class="n">bt_pri</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">polling</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span> <span class="n">bt_state</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">bt_state</span> <span class="o">&amp;=</span> <span class="n">BIT_OFFSET_LEN_MASK_32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bt_state</span> <span class="o">!=</span> <span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_cur_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_cur_state</span> <span class="o">=</span> <span class="n">bt_state</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">reg_bt_sco</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">=</span> <span class="n">BT_IDLE</span><span class="p">;</span>

			<span class="n">bt_state</span> <span class="o">=</span> <span class="n">bt_state</span> <span class="o">|</span>
			  <span class="p">((</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_ant_isolation</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
			  <span class="mi">0</span> <span class="o">:</span> <span class="n">BIT_OFFSET_LEN_MASK_32</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span>
			  <span class="n">BIT_OFFSET_LEN_MASK_32</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x4fd</span><span class="p">,</span> <span class="n">bt_state</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ratio_tx</span> <span class="o">=</span> <span class="n">bt_tx</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">polling</span><span class="p">;</span>
	<span class="n">ratio_pri</span> <span class="o">=</span> <span class="n">bt_pri</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">polling</span><span class="p">;</span>
	<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">ratio_tx</span> <span class="o">=</span> <span class="n">ratio_tx</span><span class="p">;</span>
	<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">ratio_pri</span> <span class="o">=</span> <span class="n">ratio_pri</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bt_state</span> <span class="o">&amp;&amp;</span> <span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">reg_bt_sco</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ratio_tx</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span>  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ratio_pri</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">))</span>
			<span class="n">cur_service_type</span> <span class="o">=</span> <span class="n">BT_IDLE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ratio_pri</span> <span class="o">&gt;</span> <span class="mi">110</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ratio_pri</span> <span class="o">&lt;</span> <span class="mi">250</span><span class="p">))</span>
			<span class="n">cur_service_type</span> <span class="o">=</span> <span class="n">BT_SCO</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ratio_tx</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ratio_pri</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">))</span>
			<span class="n">cur_service_type</span> <span class="o">=</span> <span class="n">BT_BUSY</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ratio_tx</span> <span class="o">&gt;=</span> <span class="mi">350</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ratio_tx</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">))</span>
			<span class="n">cur_service_type</span> <span class="o">=</span> <span class="n">BT_OTHERBUSY</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ratio_tx</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">)</span>
			<span class="n">cur_service_type</span> <span class="o">=</span> <span class="n">BT_PAN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cur_service_type</span> <span class="o">=</span> <span class="n">BT_OTHER_ACTION</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur_service_type</span> <span class="o">!=</span> <span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">=</span> <span class="n">cur_service_type</span><span class="p">;</span>
			<span class="n">bt_state</span> <span class="o">=</span> <span class="n">bt_state</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_ant_isolation</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
			   <span class="mi">0</span> <span class="o">:</span> <span class="n">BIT_OFFSET_LEN_MASK_32</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">!=</span> <span class="n">BT_IDLE</span><span class="p">)</span> <span class="o">?</span>
			   <span class="mi">0</span> <span class="o">:</span> <span class="n">BIT_OFFSET_LEN_MASK_32</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

			<span class="cm">/* Add interrupt migration when bt is not ini</span>
<span class="cm">			 * idle state (no traffic). */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">!=</span> <span class="n">BT_IDLE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x504</span><span class="p">,</span> <span class="mh">0x0ccc</span><span class="p">);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x506</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x507</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x506</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x507</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x4fd</span><span class="p">,</span> <span class="n">bt_state</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rtl92c_bt_wifi_connect_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">static</span> <span class="n">bool</span> <span class="n">media_connect</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">link_state</span> <span class="o">&lt;</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">media_connect</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">media_connect</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">media_connect</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">media_connect</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_bt_set_normal</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">rtlpcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">==</span> <span class="n">BT_OTHERBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_ul</span> <span class="o">=</span> <span class="mh">0x5ea72b</span><span class="p">;</span>
		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_dl</span> <span class="o">=</span> <span class="mh">0x5ea72b</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">==</span> <span class="n">BT_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_ul</span> <span class="o">=</span> <span class="mh">0x5eb82f</span><span class="p">;</span>
		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_dl</span> <span class="o">=</span> <span class="mh">0x5eb82f</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">==</span> <span class="n">BT_SCO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">ratio_tx</span> <span class="o">&gt;</span> <span class="mi">160</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_ul</span> <span class="o">=</span> <span class="mh">0x5ea72f</span><span class="p">;</span>
			<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_dl</span> <span class="o">=</span> <span class="mh">0x5ea72f</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_ul</span> <span class="o">=</span> <span class="mh">0x5ea32b</span><span class="p">;</span>
			<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_dl</span> <span class="o">=</span> <span class="mh">0x5ea42b</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_ul</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_dl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">!=</span> <span class="n">BT_IDLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_G</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="p">(</span><span class="n">WIRELESS_MODE_G</span> <span class="o">|</span> <span class="n">WIRELESS_MODE_B</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_rssi_state</span> <span class="o">&amp;</span>
	     <span class="n">BT_RSSI_STATE_BG_EDCA_LOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_ul</span> <span class="o">=</span> <span class="mh">0x5eb82b</span><span class="p">;</span>
		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_dl</span> <span class="o">=</span> <span class="mh">0x5eb82b</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_bt_ant_isolation</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">rtlpcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>


	<span class="cm">/* Only enable HW BT coexist when BT in &quot;Busy&quot; state. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PEER_CISCO</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">==</span> <span class="n">BT_OTHER_ACTION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_GPIO_MUXCFG</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">==</span> <span class="n">BT_BUSY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_rssi_state</span> <span class="o">&amp;</span>
		     <span class="n">BT_RSSI_STATE_NORMAL_POWER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_GPIO_MUXCFG</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">==</span>
			    <span class="n">BT_OTHER_ACTION</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">mode</span> <span class="o">&lt;</span>
			    <span class="n">WIRELESS_MODE_N_24G</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_rssi_state</span> <span class="o">&amp;</span>
			    <span class="n">BT_RSSI_STATE_SPECIAL_LOW</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_GPIO_MUXCFG</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">==</span> <span class="n">BT_PAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_GPIO_MUXCFG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_GPIO_MUXCFG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">==</span> <span class="n">BT_PAN</span><span class="p">)</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_GPIO_PIN_CTRL</span><span class="p">,</span> <span class="mh">0x10100</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_GPIO_PIN_CTRL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_rssi_state</span> <span class="o">&amp;</span>
	    <span class="n">BT_RSSI_STATE_NORMAL_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl92c_bt_set_normal</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_ul</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_dl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">!=</span> <span class="n">BT_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rfreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
				 <span class="n">RF90_PATH_A</span><span class="p">,</span>
				 <span class="mh">0x1e</span><span class="p">,</span>
				 <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rfreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
		     <span class="n">RF90_PATH_A</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>
		     <span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_rfreg_origin_1e</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txpower_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_service</span> <span class="o">!=</span> <span class="n">BT_IDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_rssi_state</span> <span class="o">&amp;</span>
				<span class="n">BT_RSSI_STATE_TXPOWER_LOW</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span>
							<span class="n">TXHIGHPWRLEVEL_BT2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span>
					<span class="n">TXHIGHPWRLEVEL_BT1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span>
				<span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rtl92c_phy_set_txpower_level</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">current_channel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92c_check_bt_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">rtlpcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_cur_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_ant_isolation</span><span class="p">)</span>
			<span class="n">rtl92c_bt_ant_isolation</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_GPIO_MUXCFG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rfreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RF90_PATH_A</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>
				<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_rfreg_origin_1e</span><span class="p">);</span>

		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_ul</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_edca_dl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92c_dm_bt_coexist</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">rtlpcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">bool</span> <span class="n">wifi_connect_change</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bt_state_change</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rssi_state_change</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_coexistence</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">rtlpcipriv</span><span class="o">-&gt;</span><span class="n">bt_coexist</span><span class="p">.</span><span class="n">bt_coexist_type</span> <span class="o">==</span> <span class="n">BT_CSR_BC4</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">wifi_connect_change</span> <span class="o">=</span> <span class="n">rtl92c_bt_wifi_connect_change</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">bt_state_change</span> <span class="o">=</span> <span class="n">rtl92c_bt_state_change</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rssi_state_change</span> <span class="o">=</span> <span class="n">rtl92c_bt_rssi_state_change</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wifi_connect_change</span> <span class="o">||</span> <span class="n">bt_state_change</span> <span class="o">||</span> <span class="n">rssi_state_change</span><span class="p">)</span>
			<span class="n">rtl92c_check_bt_change</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl92c_dm_bt_coexist</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
