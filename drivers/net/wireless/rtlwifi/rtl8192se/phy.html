<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › rtlwifi › rtl8192se › phy.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>phy.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009-2012  Realtek Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * wlanfae &lt;wlanfae@realtek.com&gt;</span>
<span class="cm"> * Realtek Corporation, No. 2, Innovation Road II, Hsinchu Science Park,</span>
<span class="cm"> * Hsinchu 300, Taiwan.</span>
<span class="cm"> *</span>
<span class="cm"> * Larry Finger &lt;Larry.Finger@lwfinger.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#include &quot;../wifi.h&quot;</span>
<span class="cp">#include &quot;../pci.h&quot;</span>
<span class="cp">#include &quot;../ps.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>
<span class="cp">#include &quot;def.h&quot;</span>
<span class="cp">#include &quot;phy.h&quot;</span>
<span class="cp">#include &quot;rf.h&quot;</span>
<span class="cp">#include &quot;dm.h&quot;</span>
<span class="cp">#include &quot;fw.h&quot;</span>
<span class="cp">#include &quot;hw.h&quot;</span>
<span class="cp">#include &quot;table.h&quot;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">_rtl92s_phy_calculate_bit_shift</span><span class="p">(</span><span class="n">u32</span> <span class="n">bitmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">bitmask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">rtl92s_phy_query_bb_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">regaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bitmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">returnvalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">originalvalue</span><span class="p">,</span> <span class="n">bitshift</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;regaddr(%#x), bitmask(%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">regaddr</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">);</span>

	<span class="n">originalvalue</span> <span class="o">=</span> <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">regaddr</span><span class="p">);</span>
	<span class="n">bitshift</span> <span class="o">=</span> <span class="n">_rtl92s_phy_calculate_bit_shift</span><span class="p">(</span><span class="n">bitmask</span><span class="p">);</span>
	<span class="n">returnvalue</span> <span class="o">=</span> <span class="p">(</span><span class="n">originalvalue</span> <span class="o">&amp;</span> <span class="n">bitmask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">bitshift</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;BBR MASK=0x%x Addr[0x%x]=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">bitmask</span><span class="p">,</span> <span class="n">regaddr</span><span class="p">,</span> <span class="n">originalvalue</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">returnvalue</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92s_phy_set_bb_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">regaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bitmask</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">originalvalue</span><span class="p">,</span> <span class="n">bitshift</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
		 <span class="s">&quot;regaddr(%#x), bitmask(%#x), data(%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">regaddr</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">!=</span> <span class="n">MASKDWORD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">originalvalue</span> <span class="o">=</span> <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">regaddr</span><span class="p">);</span>
		<span class="n">bitshift</span> <span class="o">=</span> <span class="n">_rtl92s_phy_calculate_bit_shift</span><span class="p">(</span><span class="n">bitmask</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="n">originalvalue</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">bitmask</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="n">bitshift</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">regaddr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
		 <span class="s">&quot;regaddr(%#x), bitmask(%#x), data(%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">regaddr</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">_rtl92s_phy_rf_serial_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">radio_path</span> <span class="n">rfpath</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bb_reg_def</span> <span class="o">*</span><span class="n">pphyreg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">rfpath</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">newoffset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmplong</span><span class="p">,</span> <span class="n">tmplong2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rfpi_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">retvalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">&amp;=</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">newoffset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">tmplong</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_XA_HSSIPARAMETER2</span><span class="p">,</span> <span class="n">MASKDWORD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfpath</span> <span class="o">==</span> <span class="n">RF90_PATH_A</span><span class="p">)</span>
		<span class="n">tmplong2</span> <span class="o">=</span> <span class="n">tmplong</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmplong2</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pphyreg</span><span class="o">-&gt;</span><span class="n">rfhssi_para2</span><span class="p">,</span> <span class="n">MASKDWORD</span><span class="p">);</span>

	<span class="n">tmplong2</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmplong2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">BLSSI_READADDRESS</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">newoffset</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BLSSI_READEDGE</span><span class="p">;</span>

	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_XA_HSSIPARAMETER2</span><span class="p">,</span> <span class="n">MASKDWORD</span><span class="p">,</span>
		      <span class="n">tmplong</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">BLSSI_READEDGE</span><span class="p">));</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pphyreg</span><span class="o">-&gt;</span><span class="n">rfhssi_para2</span><span class="p">,</span> <span class="n">MASKDWORD</span><span class="p">,</span> <span class="n">tmplong2</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_XA_HSSIPARAMETER2</span><span class="p">,</span> <span class="n">MASKDWORD</span><span class="p">,</span> <span class="n">tmplong</span> <span class="o">|</span>
		      <span class="n">BLSSI_READEDGE</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfpath</span> <span class="o">==</span> <span class="n">RF90_PATH_A</span><span class="p">)</span>
		<span class="n">rfpi_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_XA_HSSIPARAMETER1</span><span class="p">,</span>
						<span class="n">BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rfpath</span> <span class="o">==</span> <span class="n">RF90_PATH_B</span><span class="p">)</span>
		<span class="n">rfpi_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_XB_HSSIPARAMETER1</span><span class="p">,</span>
						<span class="n">BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfpi_enable</span><span class="p">)</span>
		<span class="n">retvalue</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pphyreg</span><span class="o">-&gt;</span><span class="n">rflssi_readbackpi</span><span class="p">,</span>
					 <span class="n">BLSSI_READBACK_DATA</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">retvalue</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pphyreg</span><span class="o">-&gt;</span><span class="n">rflssi_readback</span><span class="p">,</span>
					 <span class="n">BLSSI_READBACK_DATA</span><span class="p">);</span>

	<span class="n">retvalue</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pphyreg</span><span class="o">-&gt;</span><span class="n">rflssi_readback</span><span class="p">,</span>
				 <span class="n">BLSSI_READBACK_DATA</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;RFR-%d Addr[0x%x]=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rfpath</span><span class="p">,</span> <span class="n">pphyreg</span><span class="o">-&gt;</span><span class="n">rflssi_readback</span><span class="p">,</span> <span class="n">retvalue</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retvalue</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92s_phy_rf_serial_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">radio_path</span> <span class="n">rfpath</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bb_reg_def</span> <span class="o">*</span><span class="n">pphyreg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">rfpath</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">data_and_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">newoffset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">&amp;=</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">newoffset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">data_and_addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">newoffset</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x000fffff</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0fffffff</span><span class="p">;</span>
	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pphyreg</span><span class="o">-&gt;</span><span class="n">rf3wire_offset</span><span class="p">,</span> <span class="n">MASKDWORD</span><span class="p">,</span> <span class="n">data_and_addr</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;RFW-%d Addr[0x%x]=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rfpath</span><span class="p">,</span> <span class="n">pphyreg</span><span class="o">-&gt;</span><span class="n">rf3wire_offset</span><span class="p">,</span> <span class="n">data_and_addr</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">u32</span> <span class="nf">rtl92s_phy_query_rf_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">radio_path</span> <span class="n">rfpath</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">regaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bitmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">original_value</span><span class="p">,</span> <span class="n">readback_value</span><span class="p">,</span> <span class="n">bitshift</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
		 <span class="s">&quot;regaddr(%#x), rfpath(%#x), bitmask(%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">regaddr</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_lock</span><span class="p">);</span>

	<span class="n">original_value</span> <span class="o">=</span> <span class="n">_rtl92s_phy_rf_serial_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">,</span> <span class="n">regaddr</span><span class="p">);</span>

	<span class="n">bitshift</span> <span class="o">=</span> <span class="n">_rtl92s_phy_calculate_bit_shift</span><span class="p">(</span><span class="n">bitmask</span><span class="p">);</span>
	<span class="n">readback_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">original_value</span> <span class="o">&amp;</span> <span class="n">bitmask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">bitshift</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_lock</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
		 <span class="s">&quot;regaddr(%#x), rfpath(%#x), bitmask(%#x), original_value(%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">regaddr</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">,</span> <span class="n">original_value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">readback_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92s_phy_set_rf_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">radio_path</span> <span class="n">rfpath</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">regaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bitmask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">original_value</span><span class="p">,</span> <span class="n">bitshift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_pathmap</span> <span class="o">&gt;&gt;</span> <span class="n">rfpath</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
		 <span class="s">&quot;regaddr(%#x), bitmask(%#x), data(%#x), rfpath(%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">regaddr</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">!=</span> <span class="n">RFREG_OFFSET_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">original_value</span> <span class="o">=</span> <span class="n">_rtl92s_phy_rf_serial_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">,</span>
							    <span class="n">regaddr</span><span class="p">);</span>
		<span class="n">bitshift</span> <span class="o">=</span> <span class="n">_rtl92s_phy_calculate_bit_shift</span><span class="p">(</span><span class="n">bitmask</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="n">original_value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">bitmask</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="n">bitshift</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">_rtl92s_phy_rf_serial_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">,</span> <span class="n">regaddr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_lock</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
		 <span class="s">&quot;regaddr(%#x), bitmask(%#x), data(%#x), rfpath(%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">regaddr</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92s_phy_scan_operation_backup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">operation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_hal_stop</span><span class="p">(</span><span class="n">rtlhal</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">operation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SCAN_OPT_BACKUP</span>:
			<span class="n">rtl92s_phy_set_fw_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">FW_CMD_PAUSE_DM_BY_SCAN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCAN_OPT_RESTORE</span>:
			<span class="n">rtl92s_phy_set_fw_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">FW_CMD_RESUME_DM_BY_SCAN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
				 <span class="s">&quot;Unknown operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92s_phy_set_bw_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">ch_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">reg_bw_opmode</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SCAN</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;Switch to %s bandwidth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_chan_bw</span> <span class="o">==</span> <span class="n">HT_CHANNEL_WIDTH_20</span> <span class="o">?</span>
		 <span class="s">&quot;20MHz&quot;</span> <span class="o">:</span> <span class="s">&quot;40MHz&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">set_bwmode_inprogress</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_hal_stop</span><span class="p">(</span><span class="n">rtlhal</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">set_bwmode_inprogress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">reg_bw_opmode</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">BW_OPMODE</span><span class="p">);</span>
	<span class="cm">/* dummy read */</span>
	<span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RRSR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_chan_bw</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HT_CHANNEL_WIDTH_20</span>:
		<span class="n">reg_bw_opmode</span> <span class="o">|=</span> <span class="n">BW_OPMODE_20MHZ</span><span class="p">;</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">BW_OPMODE</span><span class="p">,</span> <span class="n">reg_bw_opmode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HT_CHANNEL_WIDTH_20_40</span>:
		<span class="n">reg_bw_opmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BW_OPMODE_20MHZ</span><span class="p">;</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">BW_OPMODE</span><span class="p">,</span> <span class="n">reg_bw_opmode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;unknown bandwidth: %#X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_chan_bw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_chan_bw</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HT_CHANNEL_WIDTH_20</span>:
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_RFMOD</span><span class="p">,</span> <span class="n">BRFMOD</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA1_RFMOD</span><span class="p">,</span> <span class="n">BRFMOD</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">VERSION_8192S_BCUT</span><span class="p">)</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RFPGA0_ANALOGPARAMETER2</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HT_CHANNEL_WIDTH_20_40</span>:
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_RFMOD</span><span class="p">,</span> <span class="n">BRFMOD</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA1_RFMOD</span><span class="p">,</span> <span class="n">BRFMOD</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_SYSTEM</span><span class="p">,</span> <span class="n">BCCK_SIDEBAND</span><span class="p">,</span>
				<span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">cur_40_prime_sc</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM1_LSTF</span><span class="p">,</span> <span class="mh">0xC00</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">cur_40_prime_sc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">VERSION_8192S_BCUT</span><span class="p">)</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RFPGA0_ANALOGPARAMETER2</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;unknown bandwidth: %#X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_chan_bw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtl92s_phy_rf6052_set_bandwidth</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_chan_bw</span><span class="p">);</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">set_bwmode_inprogress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SCAN</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;&lt;==</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_rtl92s_phy_set_sw_chnl_cmdarray</span><span class="p">(</span><span class="k">struct</span> <span class="n">swchnlcmd</span> <span class="o">*</span><span class="n">cmdtable</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">cmdtableidx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmdtablesz</span><span class="p">,</span> <span class="k">enum</span> <span class="n">swchnlcmd_id</span> <span class="n">cmdid</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">para1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">para2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">msdelay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">swchnlcmd</span> <span class="o">*</span><span class="n">pcmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdtable</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_ASSERT</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="s">&quot;cmdtable cannot be NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdtableidx</span> <span class="o">&gt;=</span> <span class="n">cmdtablesz</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">pcmd</span> <span class="o">=</span> <span class="n">cmdtable</span> <span class="o">+</span> <span class="n">cmdtableidx</span><span class="p">;</span>
	<span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmdid</span> <span class="o">=</span> <span class="n">cmdid</span><span class="p">;</span>
	<span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">para1</span> <span class="o">=</span> <span class="n">para1</span><span class="p">;</span>
	<span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">para2</span> <span class="o">=</span> <span class="n">para2</span><span class="p">;</span>
	<span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">msdelay</span> <span class="o">=</span> <span class="n">msdelay</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_rtl92s_phy_sw_chnl_step_by_step</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
	     <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">stage</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">step</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">swchnlcmd</span> <span class="n">precommoncmd</span><span class="p">[</span><span class="n">MAX_PRECMD_CNT</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">precommoncmdcnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swchnlcmd</span> <span class="n">postcommoncmd</span><span class="p">[</span><span class="n">MAX_POSTCMD_CNT</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">postcommoncmdcnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swchnlcmd</span> <span class="n">rfdependcmd</span><span class="p">[</span><span class="n">MAX_RFDEPENDCMD_CNT</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">rfdependcmdcnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swchnlcmd</span> <span class="o">*</span><span class="n">currentcmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rfpath</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_total_rfpath</span> <span class="o">=</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">num_total_rfpath</span><span class="p">;</span>

	<span class="n">precommoncmdcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">_rtl92s_phy_set_sw_chnl_cmdarray</span><span class="p">(</span><span class="n">precommoncmd</span><span class="p">,</span> <span class="n">precommoncmdcnt</span><span class="o">++</span><span class="p">,</span>
			<span class="n">MAX_PRECMD_CNT</span><span class="p">,</span> <span class="n">CMDID_SET_TXPOWEROWER_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">_rtl92s_phy_set_sw_chnl_cmdarray</span><span class="p">(</span><span class="n">precommoncmd</span><span class="p">,</span> <span class="n">precommoncmdcnt</span><span class="o">++</span><span class="p">,</span>
			<span class="n">MAX_PRECMD_CNT</span><span class="p">,</span> <span class="n">CMDID_END</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">postcommoncmdcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">_rtl92s_phy_set_sw_chnl_cmdarray</span><span class="p">(</span><span class="n">postcommoncmd</span><span class="p">,</span> <span class="n">postcommoncmdcnt</span><span class="o">++</span><span class="p">,</span>
			<span class="n">MAX_POSTCMD_CNT</span><span class="p">,</span> <span class="n">CMDID_END</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rfdependcmdcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RT_ASSERT</span><span class="p">((</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">),</span>
		  <span class="s">&quot;invalid channel for Zebra: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">_rtl92s_phy_set_sw_chnl_cmdarray</span><span class="p">(</span><span class="n">rfdependcmd</span><span class="p">,</span> <span class="n">rfdependcmdcnt</span><span class="o">++</span><span class="p">,</span>
					 <span class="n">MAX_RFDEPENDCMD_CNT</span><span class="p">,</span> <span class="n">CMDID_RF_WRITEREG</span><span class="p">,</span>
					 <span class="n">RF_CHNLBW</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">_rtl92s_phy_set_sw_chnl_cmdarray</span><span class="p">(</span><span class="n">rfdependcmd</span><span class="p">,</span> <span class="n">rfdependcmdcnt</span><span class="o">++</span><span class="p">,</span>
			<span class="n">MAX_RFDEPENDCMD_CNT</span><span class="p">,</span> <span class="n">CMDID_END</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">stage</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">currentcmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">precommoncmd</span><span class="p">[</span><span class="o">*</span><span class="n">step</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">currentcmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rfdependcmd</span><span class="p">[</span><span class="o">*</span><span class="n">step</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">currentcmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">postcommoncmd</span><span class="p">[</span><span class="o">*</span><span class="n">step</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currentcmd</span><span class="o">-&gt;</span><span class="n">cmdid</span> <span class="o">==</span> <span class="n">CMDID_END</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">stage</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="n">stage</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
				<span class="p">(</span><span class="o">*</span><span class="n">step</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">currentcmd</span><span class="o">-&gt;</span><span class="n">cmdid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CMDID_SET_TXPOWEROWER_LEVEL</span>:
			<span class="n">rtl92s_phy_set_txpower</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMDID_WRITEPORT_ULONG</span>:
			<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">currentcmd</span><span class="o">-&gt;</span><span class="n">para1</span><span class="p">,</span>
					<span class="n">currentcmd</span><span class="o">-&gt;</span><span class="n">para2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMDID_WRITEPORT_USHORT</span>:
			<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">currentcmd</span><span class="o">-&gt;</span><span class="n">para1</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">currentcmd</span><span class="o">-&gt;</span><span class="n">para2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMDID_WRITEPORT_UCHAR</span>:
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">currentcmd</span><span class="o">-&gt;</span><span class="n">para1</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">currentcmd</span><span class="o">-&gt;</span><span class="n">para2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMDID_RF_WRITEREG</span>:
			<span class="k">for</span> <span class="p">(</span><span class="n">rfpath</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rfpath</span> <span class="o">&lt;</span> <span class="n">num_total_rfpath</span><span class="p">;</span> <span class="n">rfpath</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rfreg_chnlval</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]</span> <span class="o">=</span>
					 <span class="p">((</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rfreg_chnlval</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]</span> <span class="o">&amp;</span>
					 <span class="mh">0xfffffc00</span><span class="p">)</span> <span class="o">|</span> <span class="n">currentcmd</span><span class="o">-&gt;</span><span class="n">para2</span><span class="p">);</span>
				<span class="n">rtl_set_rfreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="k">enum</span> <span class="n">radio_path</span><span class="p">)</span><span class="n">rfpath</span><span class="p">,</span>
					      <span class="n">currentcmd</span><span class="o">-&gt;</span><span class="n">para1</span><span class="p">,</span>
					      <span class="n">RFREG_OFFSET_MASK</span><span class="p">,</span>
					      <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rfreg_chnlval</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
				 <span class="s">&quot;switch case not processed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>

	<span class="p">(</span><span class="o">*</span><span class="n">delay</span><span class="p">)</span> <span class="o">=</span> <span class="n">currentcmd</span><span class="o">-&gt;</span><span class="n">msdelay</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">step</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">rtl92s_phy_sw_chnl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">delay</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SCAN</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;switch to channel%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">sw_chnl_inprogress</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">set_bwmode_inprogress</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_hal_stop</span><span class="p">(</span><span class="n">rtlhal</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">sw_chnl_inprogress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">sw_chnl_stage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">sw_chnl_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">sw_chnl_inprogress</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">_rtl92s_phy_sw_chnl_step_by_step</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
				 <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_channel</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">sw_chnl_stage</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">sw_chnl_step</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">sw_chnl_inprogress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>

	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">sw_chnl_inprogress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SCAN</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;&lt;==</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92se_phy_set_rf_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">u1btmp</span><span class="p">;</span>

	<span class="n">u1btmp</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">LDOV12D_CTRL</span><span class="p">);</span>
	<span class="n">u1btmp</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">LDOV12D_CTRL</span><span class="p">,</span> <span class="n">u1btmp</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SPS1_CTRL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TXPAUSE</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x57FC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x77FC</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">PHY_CCA</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x37FC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x77FC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x57FC</span><span class="p">);</span>

	<span class="cm">/* we should chnge GPIO to input mode</span>
<span class="cm">	 * this will drop away current about 25mA*/</span>
	<span class="n">rtl8192se_gpiobit3_cfg_inputmode</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">rtl92s_phy_set_rf_power_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">rf_pwrstate</span> <span class="n">rfpwr_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">pcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">bool</span> <span class="n">bresult</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">queue_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfpwr_state</span> <span class="o">==</span> <span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfpwr_state</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rfpwr_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ERFON</span>:<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfpwr_state</span> <span class="o">==</span> <span class="n">ERFOFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">RT_IN_PS_LEVEL</span><span class="p">(</span><span class="n">ppsc</span><span class="p">,</span> <span class="n">RT_RF_OFF_LEVL_HALT_NIC</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">bool</span> <span class="n">rtstatus</span><span class="p">;</span>
				<span class="n">u32</span> <span class="n">InitializeCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">do</span> <span class="p">{</span>
					<span class="n">InitializeCount</span><span class="o">++</span><span class="p">;</span>
					<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
						 <span class="s">&quot;IPS Set eRf nic enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">rtstatus</span> <span class="o">=</span> <span class="n">rtl_ps_enable_nic</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">rtstatus</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">InitializeCount</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">));</span>

				<span class="n">RT_CLEAR_PS_LEVEL</span><span class="p">(</span><span class="n">ppsc</span><span class="p">,</span>
						  <span class="n">RT_RF_OFF_LEVL_HALT_NIC</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
					 <span class="s">&quot;awake, sleeped:%d ms state_inap:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span>
							  <span class="n">ppsc</span><span class="o">-&gt;</span>
							  <span class="n">last_sleep_jiffies</span><span class="p">),</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">state_inap</span><span class="p">);</span>
				<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">last_awake_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
				<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x37FC</span><span class="p">);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TXPAUSE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">PHY_CCA</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">==</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">led_control</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
							 <span class="n">LED_CTL_LINK</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">led_control</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
							 <span class="n">LED_CTL_NO_LINK</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">ERFOFF</span>:<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">&amp;</span> <span class="n">RT_RF_OFF_LEVL_HALT_NIC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
					 <span class="s">&quot;IPS Set eRf nic disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rtl_ps_disable_nic</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
				<span class="n">RT_SET_PS_LEVEL</span><span class="p">(</span><span class="n">ppsc</span><span class="p">,</span> <span class="n">RT_RF_OFF_LEVL_HALT_NIC</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfoff_reason</span> <span class="o">==</span> <span class="n">RF_CHANGE_BY_IPS</span><span class="p">)</span>
					<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">led_control</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
							 <span class="n">LED_CTL_NO_LINK</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">led_control</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
							 <span class="n">LED_CTL_POWER_OFF</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">ERFSLEEP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfpwr_state</span> <span class="o">==</span> <span class="n">ERFOFF</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">queue_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			     <span class="n">queue_id</span> <span class="o">&lt;</span> <span class="n">RTL_PCI_MAX_TX_QUEUE_COUNT</span><span class="p">;)</span> <span class="p">{</span>
				<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">queue_id</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
					<span class="n">queue_id</span> <span class="o">==</span> <span class="n">BEACON_QUEUE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">queue_id</span><span class="o">++</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span>
						 <span class="s">&quot;eRf Off/Sleep: %d times TcbBusyQueue[%d] = %d before doze!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">queue_id</span><span class="p">,</span>
						 <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>

					<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_DOZE_WAITING_TIMES_9x</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span>
						 <span class="s">&quot;ERFOFF: %d times TcbBusyQueue[%d] = %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">MAX_DOZE_WAITING_TIMES_9x</span><span class="p">,</span>
						 <span class="n">queue_id</span><span class="p">,</span>
						 <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;Set ERFSLEEP awaked:%d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span>
						  <span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">last_awake_jiffies</span><span class="p">));</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;sleep awaked:%d ms state_inap:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span>
						  <span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">last_awake_jiffies</span><span class="p">),</span>
				 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">state_inap</span><span class="p">);</span>
			<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">last_sleep_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">_rtl92se_phy_set_rf_sleep</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;switch case not processed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bresult</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bresult</span><span class="p">)</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfpwr_state</span> <span class="o">=</span> <span class="n">rfpwr_state</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bresult</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_rtl92s_phy_config_rfpa_bias_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
						 <span class="k">enum</span> <span class="n">radio_path</span> <span class="n">rfpath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">bool</span> <span class="n">rtstatus</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmpval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If inferiority IC, we have to increase the PA bias current */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">ic_class</span> <span class="o">!=</span> <span class="n">IC_INFERIORITY_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmpval</span> <span class="o">=</span> <span class="n">rtl92s_phy_query_rf_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">,</span> <span class="n">RF_IPA</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="n">rtl92s_phy_set_rf_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">,</span> <span class="n">RF_IPA</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">tmpval</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rtstatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92s_store_pwrindex_diffrate_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bitmask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">==</span> <span class="n">RTXAGC_RATE18_06</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">==</span> <span class="n">RTXAGC_RATE54_24</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">==</span> <span class="n">RTXAGC_CCK_MCS32</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">==</span> <span class="n">RTXAGC_MCS03_MCS00</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">==</span> <span class="n">RTXAGC_MCS07_MCS04</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">==</span> <span class="n">RTXAGC_MCS11_MCS08</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">==</span> <span class="n">RTXAGC_MCS15_MCS12</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">mcs_txpwrlevel_origoffset</span><span class="p">[</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">pwrgroup_cnt</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">pwrgroup_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92s_phy_init_register_definition</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>

	<span class="cm">/*RF Interface Sowrtware Control */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rfintfs</span> <span class="o">=</span> <span class="n">RFPGA0_XAB_RFINTERFACESW</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rfintfs</span> <span class="o">=</span> <span class="n">RFPGA0_XAB_RFINTERFACESW</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rfintfs</span> <span class="o">=</span> <span class="n">RFPGA0_XCD_RFINTERFACESW</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rfintfs</span> <span class="o">=</span> <span class="n">RFPGA0_XCD_RFINTERFACESW</span><span class="p">;</span>

	<span class="cm">/* RF Interface Readback Value */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rfintfi</span> <span class="o">=</span> <span class="n">RFPGA0_XAB_RFINTERFACERB</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rfintfi</span> <span class="o">=</span> <span class="n">RFPGA0_XAB_RFINTERFACERB</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rfintfi</span> <span class="o">=</span> <span class="n">RFPGA0_XCD_RFINTERFACERB</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rfintfi</span> <span class="o">=</span> <span class="n">RFPGA0_XCD_RFINTERFACERB</span><span class="p">;</span>

	<span class="cm">/* RF Interface Output (and Enable) */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rfintfo</span> <span class="o">=</span> <span class="n">RFPGA0_XA_RFINTERFACEOE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rfintfo</span> <span class="o">=</span> <span class="n">RFPGA0_XB_RFINTERFACEOE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rfintfo</span> <span class="o">=</span> <span class="n">RFPGA0_XC_RFINTERFACEOE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rfintfo</span> <span class="o">=</span> <span class="n">RFPGA0_XD_RFINTERFACEOE</span><span class="p">;</span>

	<span class="cm">/* RF Interface (Output and)  Enable */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rfintfe</span> <span class="o">=</span> <span class="n">RFPGA0_XA_RFINTERFACEOE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rfintfe</span> <span class="o">=</span> <span class="n">RFPGA0_XB_RFINTERFACEOE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rfintfe</span> <span class="o">=</span> <span class="n">RFPGA0_XC_RFINTERFACEOE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rfintfe</span> <span class="o">=</span> <span class="n">RFPGA0_XD_RFINTERFACEOE</span><span class="p">;</span>

	<span class="cm">/* Addr of LSSI. Wirte RF register by driver */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rf3wire_offset</span> <span class="o">=</span>
						 <span class="n">RFPGA0_XA_LSSIPARAMETER</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rf3wire_offset</span> <span class="o">=</span>
						 <span class="n">RFPGA0_XB_LSSIPARAMETER</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rf3wire_offset</span> <span class="o">=</span>
						 <span class="n">RFPGA0_XC_LSSIPARAMETER</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rf3wire_offset</span> <span class="o">=</span>
						 <span class="n">RFPGA0_XD_LSSIPARAMETER</span><span class="p">;</span>

	<span class="cm">/* RF parameter */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rflssi_select</span> <span class="o">=</span> <span class="n">RFPGA0_XAB_RFPARAMETER</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rflssi_select</span> <span class="o">=</span> <span class="n">RFPGA0_XAB_RFPARAMETER</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rflssi_select</span> <span class="o">=</span> <span class="n">RFPGA0_XCD_RFPARAMETER</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rflssi_select</span> <span class="o">=</span> <span class="n">RFPGA0_XCD_RFPARAMETER</span><span class="p">;</span>

	<span class="cm">/* Tx AGC Gain Stage (same for all path. Should we remove this?) */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rftxgain_stage</span> <span class="o">=</span> <span class="n">RFPGA0_TXGAINSTAGE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rftxgain_stage</span> <span class="o">=</span> <span class="n">RFPGA0_TXGAINSTAGE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rftxgain_stage</span> <span class="o">=</span> <span class="n">RFPGA0_TXGAINSTAGE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rftxgain_stage</span> <span class="o">=</span> <span class="n">RFPGA0_TXGAINSTAGE</span><span class="p">;</span>

	<span class="cm">/* Tranceiver A~D HSSI Parameter-1 */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rfhssi_para1</span> <span class="o">=</span> <span class="n">RFPGA0_XA_HSSIPARAMETER1</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rfhssi_para1</span> <span class="o">=</span> <span class="n">RFPGA0_XB_HSSIPARAMETER1</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rfhssi_para1</span> <span class="o">=</span> <span class="n">RFPGA0_XC_HSSIPARAMETER1</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rfhssi_para1</span> <span class="o">=</span> <span class="n">RFPGA0_XD_HSSIPARAMETER1</span><span class="p">;</span>

	<span class="cm">/* Tranceiver A~D HSSI Parameter-2 */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rfhssi_para2</span> <span class="o">=</span> <span class="n">RFPGA0_XA_HSSIPARAMETER2</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rfhssi_para2</span> <span class="o">=</span> <span class="n">RFPGA0_XB_HSSIPARAMETER2</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rfhssi_para2</span> <span class="o">=</span> <span class="n">RFPGA0_XC_HSSIPARAMETER2</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rfhssi_para2</span> <span class="o">=</span> <span class="n">RFPGA0_XD_HSSIPARAMETER2</span><span class="p">;</span>

	<span class="cm">/* RF switch Control */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rfswitch_control</span> <span class="o">=</span>
						 <span class="n">RFPGA0_XAB_SWITCHCONTROL</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rfswitch_control</span> <span class="o">=</span>
						 <span class="n">RFPGA0_XAB_SWITCHCONTROL</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rfswitch_control</span> <span class="o">=</span>
						 <span class="n">RFPGA0_XCD_SWITCHCONTROL</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rfswitch_control</span> <span class="o">=</span>
						 <span class="n">RFPGA0_XCD_SWITCHCONTROL</span><span class="p">;</span>

	<span class="cm">/* AGC control 1  */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rfagc_control1</span> <span class="o">=</span> <span class="n">ROFDM0_XAAGCCORE1</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rfagc_control1</span> <span class="o">=</span> <span class="n">ROFDM0_XBAGCCORE1</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rfagc_control1</span> <span class="o">=</span> <span class="n">ROFDM0_XCAGCCORE1</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rfagc_control1</span> <span class="o">=</span> <span class="n">ROFDM0_XDAGCCORE1</span><span class="p">;</span>

	<span class="cm">/* AGC control 2  */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rfagc_control2</span> <span class="o">=</span> <span class="n">ROFDM0_XAAGCCORE2</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rfagc_control2</span> <span class="o">=</span> <span class="n">ROFDM0_XBAGCCORE2</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rfagc_control2</span> <span class="o">=</span> <span class="n">ROFDM0_XCAGCCORE2</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rfagc_control2</span> <span class="o">=</span> <span class="n">ROFDM0_XDAGCCORE2</span><span class="p">;</span>

	<span class="cm">/* RX AFE control 1  */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rfrxiq_imbalance</span> <span class="o">=</span>
						 <span class="n">ROFDM0_XARXIQIMBALANCE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rfrxiq_imbalance</span> <span class="o">=</span>
						 <span class="n">ROFDM0_XBRXIQIMBALANCE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rfrxiq_imbalance</span> <span class="o">=</span>
						 <span class="n">ROFDM0_XCRXIQIMBALANCE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rfrxiq_imbalance</span> <span class="o">=</span>
						 <span class="n">ROFDM0_XDRXIQIMBALANCE</span><span class="p">;</span>

	<span class="cm">/* RX AFE control 1   */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rfrx_afe</span> <span class="o">=</span> <span class="n">ROFDM0_XARXAFE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rfrx_afe</span> <span class="o">=</span> <span class="n">ROFDM0_XBRXAFE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rfrx_afe</span> <span class="o">=</span> <span class="n">ROFDM0_XCRXAFE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rfrx_afe</span> <span class="o">=</span> <span class="n">ROFDM0_XDRXAFE</span><span class="p">;</span>

	<span class="cm">/* Tx AFE control 1  */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rftxiq_imbalance</span> <span class="o">=</span>
						 <span class="n">ROFDM0_XATXIQIMBALANCE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rftxiq_imbalance</span> <span class="o">=</span>
						 <span class="n">ROFDM0_XBTXIQIMBALANCE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rftxiq_imbalance</span> <span class="o">=</span>
						 <span class="n">ROFDM0_XCTXIQIMBALANCE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rftxiq_imbalance</span> <span class="o">=</span>
						 <span class="n">ROFDM0_XDTXIQIMBALANCE</span><span class="p">;</span>

	<span class="cm">/* Tx AFE control 2  */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rftx_afe</span> <span class="o">=</span> <span class="n">ROFDM0_XATXAFE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rftx_afe</span> <span class="o">=</span> <span class="n">ROFDM0_XBTXAFE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rftx_afe</span> <span class="o">=</span> <span class="n">ROFDM0_XCTXAFE</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rftx_afe</span> <span class="o">=</span> <span class="n">ROFDM0_XDTXAFE</span><span class="p">;</span>

	<span class="cm">/* Tranceiver LSSI Readback */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rflssi_readback</span> <span class="o">=</span>
			 <span class="n">RFPGA0_XA_LSSIREADBACK</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rflssi_readback</span> <span class="o">=</span>
			 <span class="n">RFPGA0_XB_LSSIREADBACK</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_C</span><span class="p">].</span><span class="n">rflssi_readback</span> <span class="o">=</span>
			 <span class="n">RFPGA0_XC_LSSIREADBACK</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_D</span><span class="p">].</span><span class="n">rflssi_readback</span> <span class="o">=</span>
			 <span class="n">RFPGA0_XD_LSSIREADBACK</span><span class="p">;</span>

	<span class="cm">/* Tranceiver LSSI Readback PI mode  */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">].</span><span class="n">rflssi_readbackpi</span> <span class="o">=</span>
			 <span class="n">TRANSCEIVERA_HSPI_READBACK</span><span class="p">;</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">phyreg_def</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">].</span><span class="n">rflssi_readbackpi</span> <span class="o">=</span>
			 <span class="n">TRANSCEIVERB_HSPI_READBACK</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">bool</span> <span class="nf">_rtl92s_phy_config_bb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">configtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">phy_reg_table</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">agc_table</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_reg_len</span><span class="p">,</span> <span class="n">agc_len</span><span class="p">;</span>

	<span class="n">agc_len</span> <span class="o">=</span> <span class="n">AGCTAB_ARRAYLENGTH</span><span class="p">;</span>
	<span class="n">agc_table</span> <span class="o">=</span> <span class="n">rtl8192seagctab_array</span><span class="p">;</span>
	<span class="cm">/* Default RF_type: 2T2R */</span>
	<span class="n">phy_reg_len</span> <span class="o">=</span> <span class="n">PHY_REG_2T2RARRAYLENGTH</span><span class="p">;</span>
	<span class="n">phy_reg_table</span> <span class="o">=</span> <span class="n">rtl8192sephy_reg_2t2rarray</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">configtype</span> <span class="o">==</span> <span class="n">BASEBAND_CONFIG_PHY_REG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phy_reg_len</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_reg_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_reg_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfd</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_reg_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfc</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_reg_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfb</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_reg_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfa</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_reg_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf9</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* Add delay for ECS T20 &amp; LG malow platform, */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

			<span class="n">rtl92s_phy_set_bb_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">phy_reg_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">MASKDWORD</span><span class="p">,</span>
					<span class="n">phy_reg_table</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">configtype</span> <span class="o">==</span> <span class="n">BASEBAND_CONFIG_AGC_TAB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">agc_len</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl92s_phy_set_bb_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">agc_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">MASKDWORD</span><span class="p">,</span>
					<span class="n">agc_table</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>

			<span class="cm">/* Add delay for ECS T20 &amp; LG malow platform */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_rtl92s_phy_set_bb_to_diff_rf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="n">configtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">phy_regarray2xtxr_table</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_regarray2xtxr_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T1R</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_regarray2xtxr_table</span> <span class="o">=</span> <span class="n">rtl8192sephy_changeto_1t1rarray</span><span class="p">;</span>
		<span class="n">phy_regarray2xtxr_len</span> <span class="o">=</span> <span class="n">PHY_CHANGETO_1T1RARRAYLENGTH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T2R</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_regarray2xtxr_table</span> <span class="o">=</span> <span class="n">rtl8192sephy_changeto_1t2rarray</span><span class="p">;</span>
		<span class="n">phy_regarray2xtxr_len</span> <span class="o">=</span> <span class="n">PHY_CHANGETO_1T2RARRAYLENGTH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">configtype</span> <span class="o">==</span> <span class="n">BASEBAND_CONFIG_PHY_REG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phy_regarray2xtxr_len</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_regarray2xtxr_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_regarray2xtxr_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfd</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_regarray2xtxr_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfc</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_regarray2xtxr_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfb</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_regarray2xtxr_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfa</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_regarray2xtxr_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf9</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

			<span class="n">rtl92s_phy_set_bb_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">phy_regarray2xtxr_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">phy_regarray2xtxr_table</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
				<span class="n">phy_regarray2xtxr_table</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_rtl92s_phy_config_bb_with_pg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="n">configtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">phy_table_pg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_pg_len</span><span class="p">;</span>

	<span class="n">phy_pg_len</span> <span class="o">=</span> <span class="n">PHY_REG_ARRAY_PGLENGTH</span><span class="p">;</span>
	<span class="n">phy_table_pg</span> <span class="o">=</span> <span class="n">rtl8192sephy_reg_array_pg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">configtype</span> <span class="o">==</span> <span class="n">BASEBAND_CONFIG_PHY_REG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phy_pg_len</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_table_pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_table_pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfd</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_table_pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfc</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_table_pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfb</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_table_pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfa</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_table_pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf9</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

			<span class="n">_rtl92s_store_pwrindex_diffrate_offset</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					<span class="n">phy_table_pg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">phy_table_pg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
					<span class="n">phy_table_pg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
			<span class="n">rtl92s_phy_set_bb_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">phy_table_pg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">phy_table_pg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
					<span class="n">phy_table_pg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_rtl92s_phy_bb_config_parafile</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span> <span class="o">=</span> <span class="n">rtl_efuse</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">bool</span> <span class="n">rtstatus</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* 1. Read PHY_REG.TXT BB INIT!! */</span>
	<span class="cm">/* We will separate as 1T1R/1T2R/1T2R_GREEN/2T2R */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T2R</span> <span class="o">||</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_2T2R</span> <span class="o">||</span>
	    <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T1R</span> <span class="o">||</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_2T2R_GREEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtstatus</span> <span class="o">=</span> <span class="n">_rtl92s_phy_config_bb</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BASEBAND_CONFIG_PHY_REG</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">!=</span> <span class="n">RF_2T2R</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">!=</span> <span class="n">RF_2T2R_GREEN</span><span class="p">)</span>
			<span class="cm">/* so we should reconfig BB reg with the right</span>
<span class="cm">			 * PHY parameters. */</span>
			<span class="n">rtstatus</span> <span class="o">=</span> <span class="n">_rtl92s_phy_set_bb_to_diff_rf</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">BASEBAND_CONFIG_PHY_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtstatus</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtstatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;Write BB Reg Fail!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">phy_BB8190_Config_ParaFile_Fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 2. If EEPROM or EFUSE autoload OK, We must config by</span>
<span class="cm">	 *    PHY_REG_PG.txt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">autoload_failflag</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">pwrgroup_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rtstatus</span> <span class="o">=</span> <span class="n">_rtl92s_phy_config_bb_with_pg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						 <span class="n">BASEBAND_CONFIG_PHY_REG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtstatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;_rtl92s_phy_bb_config_parafile(): BB_PG Reg Fail!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">phy_BB8190_Config_ParaFile_Fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 3. BB AGC table Initialization */</span>
	<span class="n">rtstatus</span> <span class="o">=</span> <span class="n">_rtl92s_phy_config_bb</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BASEBAND_CONFIG_AGC_TAB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtstatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s(): AGC Table Fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">phy_BB8190_Config_ParaFile_Fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if the CCK HighPower is turned ON. */</span>
	<span class="cm">/* This is used to calculate PWDB. */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">cck_high_power</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)(</span><span class="n">rtl92s_phy_query_bb_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
			<span class="n">RFPGA0_XA_HSSIPARAMETER2</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">));</span>

<span class="nl">phy_BB8190_Config_ParaFile_Fail:</span>
	<span class="k">return</span> <span class="n">rtstatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">rtl92s_phy_config_rf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">radio_path</span> <span class="n">rfpath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rtstatus</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">radio_a_table</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">radio_b_table</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">radio_a_tblen</span><span class="p">,</span> <span class="n">radio_b_tblen</span><span class="p">;</span>

	<span class="n">radio_a_tblen</span> <span class="o">=</span> <span class="n">RADIOA_1T_ARRAYLENGTH</span><span class="p">;</span>
	<span class="n">radio_a_table</span> <span class="o">=</span> <span class="n">rtl8192seradioa_1t_array</span><span class="p">;</span>

	<span class="cm">/* Using Green mode array table for RF_2T2R_GREEN */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_2T2R_GREEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radio_b_table</span> <span class="o">=</span> <span class="n">rtl8192seradiob_gm_array</span><span class="p">;</span>
		<span class="n">radio_b_tblen</span> <span class="o">=</span> <span class="n">RADIOB_GM_ARRAYLENGTH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">radio_b_table</span> <span class="o">=</span> <span class="n">rtl8192seradiob_array</span><span class="p">;</span>
		<span class="n">radio_b_tblen</span> <span class="o">=</span> <span class="n">RADIOB_ARRAYLENGTH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;Radio No %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">);</span>
	<span class="n">rtstatus</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rfpath</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RF90_PATH_A</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">radio_a_tblen</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radio_a_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">)</span>
				<span class="cm">/* Delay specific ms. Only RF configuration</span>
<span class="cm">				 * requires delay. */</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radio_a_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfd</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radio_a_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfc</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radio_a_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfb</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radio_a_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfa</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radio_a_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf9</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rtl92s_phy_set_rf_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">,</span>
						      <span class="n">radio_a_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						      <span class="n">MASK20BITS</span><span class="p">,</span>
						      <span class="n">radio_a_table</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>

			<span class="cm">/* Add delay for ECS T20 &amp; LG malow platform */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* PA Bias current for inferiority IC */</span>
		<span class="n">_rtl92s_phy_config_rfpa_bias_current</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RF90_PATH_B</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">radio_b_tblen</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radio_b_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">)</span>
				<span class="cm">/* Delay specific ms. Only RF configuration</span>
<span class="cm">				 * requires delay.*/</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radio_b_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfd</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radio_b_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfc</span><span class="p">)</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radio_b_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfb</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radio_b_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfa</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radio_b_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf9</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rtl92s_phy_set_rf_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">,</span>
						      <span class="n">radio_b_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						      <span class="n">MASK20BITS</span><span class="p">,</span>
						      <span class="n">radio_b_table</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>

			<span class="cm">/* Add delay for ECS T20 &amp; LG malow platform */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RF90_PATH_C</span>:
		<span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RF90_PATH_D</span>:
		<span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rtstatus</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">bool</span> <span class="nf">rtl92s_phy_mac_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">arraylength</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ptraArray</span><span class="p">;</span>

	<span class="n">arraylength</span> <span class="o">=</span> <span class="n">MAC_2T_ARRAYLENGTH</span><span class="p">;</span>
	<span class="n">ptraArray</span> <span class="o">=</span> <span class="n">rtl8192semac_2t_array</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">arraylength</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">ptraArray</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ptraArray</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">bool</span> <span class="nf">rtl92s_phy_bb_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">rtstatus</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pathmap</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rf_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">;</span>

	<span class="n">_rtl92s_phy_init_register_definition</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Config BB and AGC */</span>
	<span class="n">rtstatus</span> <span class="o">=</span> <span class="n">_rtl92s_phy_bb_config_parafile</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>


	<span class="cm">/* Check BB/RF confiuration setting. */</span>
	<span class="cm">/* We only need to configure RF which is turned on. */</span>
	<span class="n">path1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">rtl92s_phy_query_bb_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_TXINFO</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">));</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">path2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">rtl92s_phy_query_bb_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_TRXPATHENABLE</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">));</span>
	<span class="n">pathmap</span> <span class="o">=</span> <span class="n">path1</span> <span class="o">|</span> <span class="n">path2</span><span class="p">;</span>

	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_pathmap</span> <span class="o">=</span> <span class="n">pathmap</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pathmap</span> <span class="o">&gt;&gt;</span> <span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">rf_num</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T1R</span> <span class="o">&amp;&amp;</span> <span class="n">rf_num</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T2R</span> <span class="o">&amp;&amp;</span> <span class="n">rf_num</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_2T2R</span> <span class="o">&amp;&amp;</span> <span class="n">rf_num</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_2T2R_GREEN</span> <span class="o">&amp;&amp;</span> <span class="n">rf_num</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;RF_Type(%x) does not match RF_Num(%x)!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span><span class="p">,</span> <span class="n">rf_num</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;path1 0x%x, path2 0x%x, pathmap 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">,</span> <span class="n">pathmap</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rtstatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">rtl92s_phy_rf_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>

	<span class="cm">/* Initialize general global value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T1R</span><span class="p">)</span>
		<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">num_total_rfpath</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">num_total_rfpath</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Config BB and RF */</span>
	<span class="k">return</span> <span class="n">rtl92s_phy_rf6052_config</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92s_phy_get_hw_reg_originalvalue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>

	<span class="cm">/* read rx initial gain */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">default_initialgain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
			<span class="n">ROFDM0_XAAGCCORE1</span><span class="p">,</span> <span class="n">MASKBYTE0</span><span class="p">);</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">default_initialgain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
			<span class="n">ROFDM0_XBAGCCORE1</span><span class="p">,</span> <span class="n">MASKBYTE0</span><span class="p">);</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">default_initialgain</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
			<span class="n">ROFDM0_XCAGCCORE1</span><span class="p">,</span> <span class="n">MASKBYTE0</span><span class="p">);</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">default_initialgain</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
			<span class="n">ROFDM0_XDAGCCORE1</span><span class="p">,</span> <span class="n">MASKBYTE0</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;Default initial gain (c50=0x%x, c58=0x%x, c60=0x%x, c68=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">default_initialgain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		 <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">default_initialgain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		 <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">default_initialgain</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		 <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">default_initialgain</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="cm">/* read framesync */</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">framesync</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_RXDETECTOR3</span><span class="p">,</span> <span class="n">MASKBYTE0</span><span class="p">);</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">framesync_c34</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_RXDETECTOR2</span><span class="p">,</span>
					      <span class="n">MASKDWORD</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;Default framesync (0x%x) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ROFDM0_RXDETECTOR3</span><span class="p">,</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">framesync</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92s_phy_get_txpower_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="o">*</span><span class="n">cckpowerlevel</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ofdmpowerLevel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span> <span class="o">=</span> <span class="n">rtl_efuse</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* 1. CCK */</span>
	<span class="cm">/* RF-A */</span>
	<span class="n">cckpowerlevel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwrlevel_cck</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index</span><span class="p">];</span>
	<span class="cm">/* RF-B */</span>
	<span class="n">cckpowerlevel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwrlevel_cck</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">index</span><span class="p">];</span>

	<span class="cm">/* 2. OFDM for 1T or 2T */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T2R</span> <span class="o">||</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T1R</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Read HT 40 OFDM TX power */</span>
		<span class="n">ofdmpowerLevel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwrlevel_ht40_1s</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index</span><span class="p">];</span>
		<span class="n">ofdmpowerLevel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwrlevel_ht40_1s</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">index</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_2T2R</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Read HT 40 OFDM TX power */</span>
		<span class="n">ofdmpowerLevel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwrlevel_ht40_2s</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index</span><span class="p">];</span>
		<span class="n">ofdmpowerLevel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwrlevel_ht40_2s</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">index</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92s_phy_ccxpower_indexcheck</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cckpowerlevel</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ofdmpowerlevel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>

	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">cur_cck_txpwridx</span> <span class="o">=</span> <span class="n">cckpowerlevel</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">cur_ofdm24g_txpwridx</span> <span class="o">=</span> <span class="n">ofdmpowerlevel</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92s_phy_set_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span>	<span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span> <span class="o">=</span> <span class="n">rtl_efuse</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="cm">/* [0]:RF-A, [1]:RF-B */</span>
	<span class="n">u8</span> <span class="n">cckpowerlevel</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ofdmpowerLevel</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwr_fromeprom</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Mainly we use RF-A Tx Power to write the Tx Power registers,</span>
<span class="cm">	 * but the RF-B Tx Power must be calculated by the antenna diff.</span>
<span class="cm">	 * So we have to rewrite Antenna gain offset register here.</span>
<span class="cm">	 * Please refer to BB register 0x80c</span>
<span class="cm">	 * 1. For CCK.</span>
<span class="cm">	 * 2. For OFDM 1T or 2T */</span>
	<span class="n">_rtl92s_phy_get_txpower_index</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cckpowerlevel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">ofdmpowerLevel</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;Channel-%d, cckPowerLevel (A / B) = 0x%x / 0x%x, ofdmPowerLevel (A / B) = 0x%x / 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">channel</span><span class="p">,</span> <span class="n">cckpowerlevel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cckpowerlevel</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		 <span class="n">ofdmpowerLevel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ofdmpowerLevel</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">_rtl92s_phy_ccxpower_indexcheck</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cckpowerlevel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">ofdmpowerLevel</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">rtl92s_phy_rf6052_set_ccktxpower</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cckpowerlevel</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">rtl92s_phy_rf6052_set_ofdmtxpower</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ofdmpowerLevel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">channel</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">pollingcnt</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmpvalue</span><span class="p">;</span>

	<span class="cm">/* Make sure that CMD IO has be accepted by FW. */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">tmpvalue</span> <span class="o">=</span> <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmpvalue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">pollingcnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pollingcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span> <span class="s">&quot;Set FW Cmd fail!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92s_phy_set_fwcmd_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">input</span><span class="p">,</span> <span class="n">current_aid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_hal_stop</span><span class="p">(</span><span class="n">rtlhal</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We re-map RA related CMD IO to combinational ones */</span>
	<span class="cm">/* if FW version is v.52 or later. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_fwcmd_io</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FW_CMD_RA_REFRESH_N</span>:
		<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_fwcmd_io</span> <span class="o">=</span> <span class="n">FW_CMD_RA_REFRESH_N_COMB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_RA_REFRESH_BG</span>:
		<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_fwcmd_io</span> <span class="o">=</span> <span class="n">FW_CMD_RA_REFRESH_BG_COMB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_fwcmd_io</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FW_CMD_RA_RESET</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;FW_CMD_RA_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="n">FW_RA_RESET</span><span class="p">);</span>
		<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_RA_ACTIVE</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;FW_CMD_RA_ACTIVE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="n">FW_RA_ACTIVE</span><span class="p">);</span>
		<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_RA_REFRESH_N</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;FW_CMD_RA_REFRESH_N</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">input</span> <span class="o">=</span> <span class="n">FW_RA_REFRESH</span><span class="p">;</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
		<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="n">FW_RA_ENABLE_RSSI_MASK</span><span class="p">);</span>
		<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_RA_REFRESH_BG</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
			 <span class="s">&quot;FW_CMD_RA_REFRESH_BG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="n">FW_RA_REFRESH</span><span class="p">);</span>
		<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="n">FW_RA_DISABLE_RSSI_MASK</span><span class="p">);</span>
		<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_RA_REFRESH_N_COMB</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
			 <span class="s">&quot;FW_CMD_RA_REFRESH_N_COMB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">input</span> <span class="o">=</span> <span class="n">FW_RA_IOT_N_COMB</span><span class="p">;</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
		<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_RA_REFRESH_BG_COMB</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
			 <span class="s">&quot;FW_CMD_RA_REFRESH_BG_COMB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">input</span> <span class="o">=</span> <span class="n">FW_RA_IOT_BG_COMB</span><span class="p">;</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
		<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_IQK_ENABLE</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;FW_CMD_IQK_ENABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="n">FW_IQK_ENABLE</span><span class="p">);</span>
		<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_PAUSE_DM_BY_SCAN</span>:
		<span class="cm">/* Lower initial gain */</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XAAGCCORE1</span><span class="p">,</span> <span class="n">MASKBYTE0</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XBAGCCORE1</span><span class="p">,</span> <span class="n">MASKBYTE0</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
		<span class="cm">/* CCA threshold */</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_CCA</span><span class="p">,</span> <span class="n">MASKBYTE2</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_RESUME_DM_BY_SCAN</span>:
		<span class="cm">/* CCA threshold */</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_CCA</span><span class="p">,</span> <span class="n">MASKBYTE2</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">);</span>
		<span class="n">rtl92s_phy_set_txpower</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_channel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_HIGH_PWR_DISABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_flag</span> <span class="o">&amp;</span> <span class="n">HAL_DM_HIPWR_DISABLE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Lower initial gain */</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XAAGCCORE1</span><span class="p">,</span> <span class="n">MASKBYTE0</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XBAGCCORE1</span><span class="p">,</span> <span class="n">MASKBYTE0</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
		<span class="cm">/* CCA threshold */</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_CCA</span><span class="p">,</span> <span class="n">MASKBYTE2</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_HIGH_PWR_ENABLE</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_flag</span> <span class="o">&amp;</span> <span class="n">HAL_DM_HIPWR_DISABLE</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txpower_enable</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* CCA threshold */</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_CCA</span><span class="p">,</span> <span class="n">MASKBYTE2</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_LPS_ENTER</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;FW_CMD_LPS_ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">current_aid</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">assoc_id</span><span class="p">;</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="p">(</span><span class="n">FW_LPS_ENTER</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">current_aid</span> <span class="o">|</span> <span class="mh">0xc000</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
		<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="cm">/* FW set TXOP disable here, so disable EDCA</span>
<span class="cm">		 * turbo mode until driver leave LPS */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_LPS_LEAVE</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;FW_CMD_LPS_LEAVE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="n">FW_LPS_LEAVE</span><span class="p">);</span>
		<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_ADD_A2_ENTRY</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;FW_CMD_ADD_A2_ENTRY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="n">FW_ADD_A2_ENTRY</span><span class="p">);</span>
		<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_CMD_CTRL_DM_BY_DRIVER</span>:
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;FW_CMD_CTRL_DM_BY_DRIVER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="n">FW_CTRL_DM_BY_DRIVER</span><span class="p">);</span>
		<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtl92s_phy_chk_fwcmd_iodone</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Clear FW CMD operation flag. */</span>
	<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">set_fwcmd_inprogress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">rtl92s_phy_set_fw_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fwcmd_iotype</span> <span class="n">fw_cmdio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span> <span class="o">=</span> <span class="n">rtl_efuse</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u32</span>	<span class="n">fw_param</span> <span class="o">=</span> <span class="n">FW_CMD_IO_PARA_QUERY</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">);</span>
	<span class="n">u16</span>	<span class="n">fw_cmdmap</span> <span class="o">=</span> <span class="n">FW_CMD_IO_QUERY</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">bPostProcessing</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;Set FW Cmd(%#x), set_fwcmd_inprogress(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">fw_cmdio</span><span class="p">,</span> <span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">set_fwcmd_inprogress</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* We re-map to combined FW CMD ones if firmware version */</span>
		<span class="cm">/* is v.53 or later. */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fw_cmdio</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FW_CMD_RA_REFRESH_N</span>:
			<span class="n">fw_cmdio</span> <span class="o">=</span> <span class="n">FW_CMD_RA_REFRESH_N_COMB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_CMD_RA_REFRESH_BG</span>:
			<span class="n">fw_cmdio</span> <span class="o">=</span> <span class="n">FW_CMD_RA_REFRESH_BG_COMB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If firmware version is v.62 or later,</span>
<span class="cm">		 * use FW_CMD_IO_SET for FW_CMD_CTRL_DM_BY_DRIVER */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hal_get_firmwareversion</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x3E</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fw_cmdio</span> <span class="o">==</span> <span class="n">FW_CMD_CTRL_DM_BY_DRIVER</span><span class="p">)</span>
				<span class="n">fw_cmdio</span> <span class="o">=</span> <span class="n">FW_CMD_CTRL_DM_BY_DRIVER_NEW</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="cm">/* We shall revise all FW Cmd IO into Reg0x364</span>
<span class="cm">		 * DM map table in the future. */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fw_cmdio</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FW_CMD_RA_INIT</span>:
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;RA init!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fw_cmdmap</span> <span class="o">|=</span> <span class="n">FW_RA_INIT_CTL</span><span class="p">;</span>
			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>
			<span class="cm">/* Clear control flag to sync with FW. */</span>
			<span class="n">FW_CMD_IO_CLR</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FW_RA_INIT_CTL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_CMD_DIG_DISABLE</span>:
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Set DIG disable!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fw_cmdmap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FW_DIG_ENABLE_CTL</span><span class="p">;</span>
			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_CMD_DIG_ENABLE</span>:
		<span class="k">case</span> <span class="n">FW_CMD_DIG_RESUME</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_flag</span> <span class="o">&amp;</span> <span class="n">HAL_DM_DIG_DISABLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;Set DIG enable or resume!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">fw_cmdmap</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FW_DIG_ENABLE_CTL</span> <span class="o">|</span> <span class="n">FW_SS_CTL</span><span class="p">);</span>
				<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_CMD_DIG_HALT</span>:
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Set DIG halt!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fw_cmdmap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FW_DIG_ENABLE_CTL</span> <span class="o">|</span> <span class="n">FW_SS_CTL</span><span class="p">);</span>
			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_CMD_TXPWR_TRACK_THERMAL</span>: <span class="p">{</span>
			<span class="n">u8</span>	<span class="n">thermalval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fw_cmdmap</span> <span class="o">|=</span> <span class="n">FW_PWR_TRK_CTL</span><span class="p">;</span>

			<span class="cm">/* Clear FW parameter in terms of thermal parts. */</span>
			<span class="n">fw_param</span> <span class="o">&amp;=</span> <span class="n">FW_PWR_TRK_PARAM_CLR</span><span class="p">;</span>

			<span class="n">thermalval</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span><span class="p">;</span>
			<span class="n">fw_param</span> <span class="o">|=</span> <span class="p">((</span><span class="n">thermalval</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				     <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">thermalmeter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Set TxPwr tracking!! FwCmdMap(%#x), FwParam(%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">fw_cmdmap</span><span class="p">,</span> <span class="n">fw_param</span><span class="p">);</span>

			<span class="n">FW_CMD_PARA_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_param</span><span class="p">);</span>
			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>

			<span class="cm">/* Clear control flag to sync with FW. */</span>
			<span class="n">FW_CMD_IO_CLR</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FW_PWR_TRK_CTL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* The following FW CMDs are only compatible to</span>
<span class="cm">		 * v.53 or later. */</span>
		<span class="k">case</span> <span class="n">FW_CMD_RA_REFRESH_N_COMB</span>:
			<span class="n">fw_cmdmap</span> <span class="o">|=</span> <span class="n">FW_RA_N_CTL</span><span class="p">;</span>

			<span class="cm">/* Clear RA BG mode control. */</span>
			<span class="n">fw_cmdmap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FW_RA_BG_CTL</span> <span class="o">|</span> <span class="n">FW_RA_INIT_CTL</span><span class="p">);</span>

			<span class="cm">/* Clear FW parameter in terms of RA parts. */</span>
			<span class="n">fw_param</span> <span class="o">&amp;=</span> <span class="n">FW_RA_PARAM_CLR</span><span class="p">;</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;[FW CMD] [New Version] Set RA/IOT Comb in n mode!! FwCmdMap(%#x), FwParam(%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">fw_cmdmap</span><span class="p">,</span> <span class="n">fw_param</span><span class="p">);</span>

			<span class="n">FW_CMD_PARA_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_param</span><span class="p">);</span>
			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>

			<span class="cm">/* Clear control flag to sync with FW. */</span>
			<span class="n">FW_CMD_IO_CLR</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FW_RA_N_CTL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_CMD_RA_REFRESH_BG_COMB</span>:
			<span class="n">fw_cmdmap</span> <span class="o">|=</span> <span class="n">FW_RA_BG_CTL</span><span class="p">;</span>

			<span class="cm">/* Clear RA n-mode control. */</span>
			<span class="n">fw_cmdmap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FW_RA_N_CTL</span> <span class="o">|</span> <span class="n">FW_RA_INIT_CTL</span><span class="p">);</span>
			<span class="cm">/* Clear FW parameter in terms of RA parts. */</span>
			<span class="n">fw_param</span> <span class="o">&amp;=</span> <span class="n">FW_RA_PARAM_CLR</span><span class="p">;</span>

			<span class="n">FW_CMD_PARA_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_param</span><span class="p">);</span>
			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>

			<span class="cm">/* Clear control flag to sync with FW. */</span>
			<span class="n">FW_CMD_IO_CLR</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FW_RA_BG_CTL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_CMD_IQK_ENABLE</span>:
			<span class="n">fw_cmdmap</span> <span class="o">|=</span> <span class="n">FW_IQK_CTL</span><span class="p">;</span>
			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>
			<span class="cm">/* Clear control flag to sync with FW. */</span>
			<span class="n">FW_CMD_IO_CLR</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FW_IQK_CTL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* The following FW CMD is compatible to v.62 or later.  */</span>
		<span class="k">case</span> <span class="n">FW_CMD_CTRL_DM_BY_DRIVER_NEW</span>:
			<span class="n">fw_cmdmap</span> <span class="o">|=</span> <span class="n">FW_DRIVER_CTRL_DM_CTL</span><span class="p">;</span>
			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*  The followed FW Cmds needs post-processing later. */</span>
		<span class="k">case</span> <span class="n">FW_CMD_RESUME_DM_BY_SCAN</span>:
			<span class="n">fw_cmdmap</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FW_DIG_ENABLE_CTL</span> <span class="o">|</span>
				      <span class="n">FW_HIGH_PWR_ENABLE_CTL</span> <span class="o">|</span>
				      <span class="n">FW_SS_CTL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_flag</span> <span class="o">&amp;</span> <span class="n">HAL_DM_DIG_DISABLE</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">digtable</span><span class="o">-&gt;</span><span class="n">dig_enable_flag</span><span class="p">)</span>
				<span class="n">fw_cmdmap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FW_DIG_ENABLE_CTL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_flag</span> <span class="o">&amp;</span> <span class="n">HAL_DM_HIPWR_DISABLE</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txpower_enable</span><span class="p">)</span>
				<span class="n">fw_cmdmap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FW_HIGH_PWR_ENABLE_CTL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span> <span class="o">==</span>
			    <span class="n">DIG_EXT_PORT_STAGE_0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span> <span class="o">==</span>
			    <span class="n">DIG_EXT_PORT_STAGE_1</span><span class="p">))</span>
				<span class="n">fw_cmdmap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FW_DIG_ENABLE_CTL</span><span class="p">;</span>

			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>
			<span class="n">bPostProcessing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_CMD_PAUSE_DM_BY_SCAN</span>:
			<span class="n">fw_cmdmap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FW_DIG_ENABLE_CTL</span> <span class="o">|</span>
				       <span class="n">FW_HIGH_PWR_ENABLE_CTL</span> <span class="o">|</span>
				       <span class="n">FW_SS_CTL</span><span class="p">);</span>
			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>
			<span class="n">bPostProcessing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_CMD_HIGH_PWR_DISABLE</span>:
			<span class="n">fw_cmdmap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FW_HIGH_PWR_ENABLE_CTL</span><span class="p">;</span>
			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>
			<span class="n">bPostProcessing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_CMD_HIGH_PWR_ENABLE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_flag</span> <span class="o">&amp;</span> <span class="n">HAL_DM_HIPWR_DISABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txpower_enable</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fw_cmdmap</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FW_HIGH_PWR_ENABLE_CTL</span> <span class="o">|</span>
					      <span class="n">FW_SS_CTL</span><span class="p">);</span>
				<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>
				<span class="n">bPostProcessing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_CMD_DIG_MODE_FA</span>:
			<span class="n">fw_cmdmap</span> <span class="o">|=</span> <span class="n">FW_FA_CTL</span><span class="p">;</span>
			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_CMD_DIG_MODE_SS</span>:
			<span class="n">fw_cmdmap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FW_FA_CTL</span><span class="p">;</span>
			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FW_CMD_PAPE_CONTROL</span>:
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_CMD</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;[FW CMD] Set PAPE Control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fw_cmdmap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FW_PAPE_CTL_BY_SW_HW</span><span class="p">;</span>

			<span class="n">FW_CMD_IO_SET</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">fw_cmdmap</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* Pass to original FW CMD processing callback</span>
<span class="cm">			 * routine. */</span>
			<span class="n">bPostProcessing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* We shall post processing these FW CMD if</span>
<span class="cm">	 * variable bPostProcessing is set. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bPostProcessing</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">set_fwcmd_inprogress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">set_fwcmd_inprogress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* Update current FW Cmd for callback use. */</span>
		<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_fwcmd_io</span> <span class="o">=</span> <span class="n">fw_cmdio</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_rtl92s_phy_set_fwcmd_io</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>	<span class="kt">void</span> <span class="nf">_rtl92s_phy_check_ephy_switchready</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u32</span>	<span class="n">delay</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">regu1</span><span class="p">;</span>

	<span class="n">regu1</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x554</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">regu1</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regu1</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x554</span><span class="p">);</span>
		<span class="n">delay</span><span class="o">--</span><span class="p">;</span>
		<span class="cm">/* We delay only 50us to prevent</span>
<span class="cm">		 * being scheduled out. */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92s_phy_switch_ephy_parameter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="cm">/* The way to be capable to switch clock request</span>
<span class="cm">	 * when the PG setting does not support clock request.</span>
<span class="cm">	 * This is the backdoor solution to switch clock</span>
<span class="cm">	 * request before ASPM or D3. */</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x540</span><span class="p">,</span> <span class="mh">0x73c11</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x548</span><span class="p">,</span> <span class="mh">0x2407c</span><span class="p">);</span>

	<span class="cm">/* Switch EPHY parameter!!!! */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x550</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x554</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">_rtl92s_phy_check_ephy_switchready</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x550</span><span class="p">,</span> <span class="mh">0xa0eb</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x554</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">);</span>
	<span class="n">_rtl92s_phy_check_ephy_switchready</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x550</span><span class="p">,</span> <span class="mh">0xff80</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x554</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
	<span class="n">_rtl92s_phy_check_ephy_switchready</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Delay L1 enter time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">support_aspm</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">support_backdoor</span><span class="p">)</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x560</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x560</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92s_phy_set_beacon_hwreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">BeaconInterval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="mh">0xF1000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">BeaconInterval</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
