<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › rtlwifi › rtl8192se › hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009-2012  Realtek Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * wlanfae &lt;wlanfae@realtek.com&gt;</span>
<span class="cm"> * Realtek Corporation, No. 2, Innovation Road II, Hsinchu Science Park,</span>
<span class="cm"> * Hsinchu 300, Taiwan.</span>
<span class="cm"> *</span>
<span class="cm"> * Larry Finger &lt;Larry.Finger@lwfinger.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#include &quot;../wifi.h&quot;</span>
<span class="cp">#include &quot;../efuse.h&quot;</span>
<span class="cp">#include &quot;../base.h&quot;</span>
<span class="cp">#include &quot;../regd.h&quot;</span>
<span class="cp">#include &quot;../cam.h&quot;</span>
<span class="cp">#include &quot;../ps.h&quot;</span>
<span class="cp">#include &quot;../pci.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>
<span class="cp">#include &quot;def.h&quot;</span>
<span class="cp">#include &quot;phy.h&quot;</span>
<span class="cp">#include &quot;dm.h&quot;</span>
<span class="cp">#include &quot;fw.h&quot;</span>
<span class="cp">#include &quot;led.h&quot;</span>
<span class="cp">#include &quot;hw.h&quot;</span>

<span class="kt">void</span> <span class="nf">rtl92se_get_hw_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">variable</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HW_VAR_RCR</span>: <span class="p">{</span>
			<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="o">=</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">receive_config</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_RF_STATE</span>: <span class="p">{</span>
			<span class="o">*</span><span class="p">((</span><span class="k">enum</span> <span class="n">rf_pwrstate</span> <span class="o">*</span><span class="p">)(</span><span class="n">val</span><span class="p">))</span> <span class="o">=</span> <span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfpwr_state</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_FW_PSMODE_STATUS</span>: <span class="p">{</span>
			<span class="o">*</span><span class="p">((</span><span class="n">bool</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="o">=</span> <span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">fw_current_inpsmode</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_CORRECT_TSF</span>: <span class="p">{</span>
			<span class="n">u64</span> <span class="n">tsf</span><span class="p">;</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">ptsf_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tsf</span><span class="p">;</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">ptsf_high</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tsf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="o">*</span><span class="n">ptsf_high</span> <span class="o">=</span> <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="p">(</span><span class="n">TSFR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
			<span class="o">*</span><span class="n">ptsf_low</span> <span class="o">=</span> <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TSFR</span><span class="p">);</span>

			<span class="o">*</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="o">=</span> <span class="n">tsf</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_MRC</span>: <span class="p">{</span>
			<span class="o">*</span><span class="p">((</span><span class="n">bool</span> <span class="o">*</span><span class="p">)(</span><span class="n">val</span><span class="p">))</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_mrc_switch</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;switch case not processed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_set_hw_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">variable</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span> <span class="o">=</span> <span class="n">rtl_efuse</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HW_VAR_ETHER_ADDR</span>:<span class="p">{</span>
			<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">IDR0</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">val</span><span class="p">))[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">IDR4</span><span class="p">,</span> <span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">val</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_BASIC_RATE</span>:<span class="p">{</span>
			<span class="n">u16</span> <span class="n">rate_cfg</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">u8</span> <span class="n">rate_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">VERSION_8192S_ACUT</span><span class="p">)</span>
				<span class="n">rate_cfg</span> <span class="o">=</span> <span class="n">rate_cfg</span> <span class="o">&amp;</span> <span class="mh">0x150</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rate_cfg</span> <span class="o">=</span> <span class="n">rate_cfg</span> <span class="o">&amp;</span> <span class="mh">0x15f</span><span class="p">;</span>

			<span class="n">rate_cfg</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>

			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RRSR</span><span class="p">,</span> <span class="n">rate_cfg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RRSR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">rate_cfg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">rate_cfg</span> <span class="o">&gt;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rate_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate_cfg</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">rate_index</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">INIRTSMCS_SEL</span><span class="p">,</span> <span class="n">rate_index</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_BSSID</span>:<span class="p">{</span>
			<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">BSSIDR</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">val</span><span class="p">))[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">BSSIDR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
				       <span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">val</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_SIFS</span>:<span class="p">{</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SIFS_OFDM</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SIFS_OFDM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_SLOT_TIME</span>:<span class="p">{</span>
			<span class="n">u8</span> <span class="n">e_aci</span><span class="p">;</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MLME</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;HW_VAR_SLOT_TIME %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SLOT_TIME</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">e_aci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">e_aci</span> <span class="o">&lt;</span> <span class="n">AC_MAX</span><span class="p">;</span> <span class="n">e_aci</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">HW_VAR_AC_PARAM</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">e_aci</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_ACK_PREAMBLE</span>:<span class="p">{</span>
			<span class="n">u8</span> <span class="n">reg_tmp</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">short_preamble</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">reg_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">cur_40_prime_sc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">short_preamble</span><span class="p">)</span>
				<span class="n">reg_tmp</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RRSR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">reg_tmp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_AMPDU_MIN_SPACE</span>:<span class="p">{</span>
			<span class="n">u8</span> <span class="n">min_spacing_to_set</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">sec_min_space</span><span class="p">;</span>

			<span class="n">min_spacing_to_set</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">min_spacing_to_set</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">pairwise_enc_algorithm</span> <span class="o">==</span>
				    <span class="n">NO_ENCRYPTION</span><span class="p">)</span>
					<span class="n">sec_min_space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">sec_min_space</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">min_spacing_to_set</span> <span class="o">&lt;</span> <span class="n">sec_min_space</span><span class="p">)</span>
					<span class="n">min_spacing_to_set</span> <span class="o">=</span> <span class="n">sec_min_space</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">min_spacing_to_set</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">min_spacing_to_set</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

				<span class="n">mac</span><span class="o">-&gt;</span><span class="n">min_space_cfg</span> <span class="o">=</span>
						<span class="p">((</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">min_space_cfg</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">|</span>
						<span class="n">min_spacing_to_set</span><span class="p">);</span>

				<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">min_spacing_to_set</span><span class="p">;</span>

				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MLME</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;Set HW_VAR_AMPDU_MIN_SPACE: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">mac</span><span class="o">-&gt;</span><span class="n">min_space_cfg</span><span class="p">);</span>

				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AMPDU_MIN_SPACE</span><span class="p">,</span>
					       <span class="n">mac</span><span class="o">-&gt;</span><span class="n">min_space_cfg</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_SHORTGI_DENSITY</span>:<span class="p">{</span>
			<span class="n">u8</span> <span class="n">density_to_set</span><span class="p">;</span>

			<span class="n">density_to_set</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">min_space_cfg</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">minspace_cfg</span><span class="p">;</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">min_space_cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">density_to_set</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MLME</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Set HW_VAR_SHORTGI_DENSITY: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">mac</span><span class="o">-&gt;</span><span class="n">min_space_cfg</span><span class="p">);</span>

			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AMPDU_MIN_SPACE</span><span class="p">,</span>
				       <span class="n">mac</span><span class="o">-&gt;</span><span class="n">min_space_cfg</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_AMPDU_FACTOR</span>:<span class="p">{</span>
			<span class="n">u8</span> <span class="n">factor_toset</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">regtoset</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">factorlevel</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
				<span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>
				<span class="mi">13</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>
				<span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
			<span class="n">u8</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">factor_toset</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">factor_toset</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">factor_toset</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">factor_toset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">factor_toset</span> <span class="o">&gt;</span> <span class="mh">0xf</span><span class="p">)</span>
					<span class="n">factor_toset</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">factorlevel</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">factor_toset</span><span class="p">)</span>
						<span class="n">factorlevel</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span>
								 <span class="n">factor_toset</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">regtoset</span> <span class="o">=</span> <span class="p">((</span><span class="n">factorlevel</span><span class="p">[</span><span class="n">index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">])</span> <span class="o">|</span>
						    <span class="p">(</span><span class="n">factorlevel</span><span class="p">[</span><span class="n">index</span> <span class="o">*</span>
						    <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span>
						       <span class="n">AGGLEN_LMT_L</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span>
						       <span class="n">regtoset</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">regtoset</span> <span class="o">=</span> <span class="p">((</span><span class="n">factorlevel</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span> <span class="o">|</span>
					    <span class="p">(</span><span class="n">factorlevel</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
				<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AGGLEN_LMT_H</span><span class="p">,</span> <span class="n">regtoset</span><span class="p">);</span>

				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_MLME</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;Set HW_VAR_AMPDU_FACTOR: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">factor_toset</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_AC_PARAM</span>:<span class="p">{</span>
			<span class="n">u8</span> <span class="n">e_aci</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">rtl92s_dm_init_edca_turbo</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">acm_method</span> <span class="o">!=</span> <span class="n">eAcmWay2_SW</span><span class="p">)</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						 <span class="n">HW_VAR_ACM_CTRL</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">e_aci</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_ACM_CTRL</span>:<span class="p">{</span>
			<span class="n">u8</span> <span class="n">e_aci</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">union</span> <span class="n">aci_aifsn</span> <span class="o">*</span><span class="n">p_aci_aifsn</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">aci_aifsn</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">(</span>
							<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">aifs</span><span class="p">));</span>
			<span class="n">u8</span> <span class="n">acm</span> <span class="o">=</span> <span class="n">p_aci_aifsn</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">acm</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">acm_ctrl</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AcmHwCtrl</span><span class="p">);</span>

			<span class="n">acm_ctrl</span> <span class="o">=</span> <span class="n">acm_ctrl</span> <span class="o">|</span> <span class="p">((</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">acm_method</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span>
				   <span class="mh">0x0</span> <span class="o">:</span> <span class="mh">0x1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">acm</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">e_aci</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">AC0_BE</span>:
					<span class="n">acm_ctrl</span> <span class="o">|=</span> <span class="n">AcmHw_BeqEn</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">AC2_VI</span>:
					<span class="n">acm_ctrl</span> <span class="o">|=</span> <span class="n">AcmHw_ViqEn</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">AC3_VO</span>:
					<span class="n">acm_ctrl</span> <span class="o">|=</span> <span class="n">AcmHw_VoqEn</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span>
						 <span class="s">&quot;HW_VAR_ACM_CTRL acm set failed: eACI is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">acm</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">e_aci</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">AC0_BE</span>:
					<span class="n">acm_ctrl</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">AcmHw_BeqEn</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">AC2_VI</span>:
					<span class="n">acm_ctrl</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">AcmHw_ViqEn</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">AC3_VO</span>:
					<span class="n">acm_ctrl</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">AcmHw_BeqEn</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
						 <span class="s">&quot;switch case not processed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_QOS</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
				 <span class="s">&quot;HW_VAR_ACM_CTRL Write 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acm_ctrl</span><span class="p">);</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AcmHwCtrl</span><span class="p">,</span> <span class="n">acm_ctrl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_RCR</span>:<span class="p">{</span>
			<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span><span class="p">))[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">receive_config</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_RETRY_LIMIT</span>:<span class="p">{</span>
			<span class="n">u8</span> <span class="n">retry_limit</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span>

			<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RETRY_LIMIT</span><span class="p">,</span>
				       <span class="n">retry_limit</span> <span class="o">&lt;&lt;</span> <span class="n">RETRY_LIMIT_SHORT_SHIFT</span> <span class="o">|</span>
				       <span class="n">retry_limit</span> <span class="o">&lt;&lt;</span> <span class="n">RETRY_LIMIT_LONG_SHIFT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_DUAL_TSF_RST</span>: <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_EFUSE_BYTES</span>: <span class="p">{</span>
			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">efuse_usedbytes</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_EFUSE_USAGE</span>: <span class="p">{</span>
			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">efuse_usedpercentage</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_IO_CMD</span>: <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_WPA_CONFIG</span>: <span class="p">{</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SECR</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_SET_RPWM</span>:<span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_H2C_FW_PWRMODE</span>:<span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_FW_PSMODE_STATUS</span>: <span class="p">{</span>
			<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">fw_current_inpsmode</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">bool</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_H2C_FW_JOINBSSRPT</span>:<span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_AID</span>:<span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_CORRECT_TSF</span>:<span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">HW_VAR_MRC</span>: <span class="p">{</span>
			<span class="n">bool</span> <span class="n">bmrc_toset</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">bool</span> <span class="o">*</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
			<span class="n">u8</span> <span class="n">u1bdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bmrc_toset</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_TRXPATHENABLE</span><span class="p">,</span>
					      <span class="n">MASKBYTE0</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">);</span>
				<span class="n">u1bdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">ROFDM1_TRXPATHENABLE</span><span class="p">,</span>
						<span class="n">MASKBYTE0</span><span class="p">);</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM1_TRXPATHENABLE</span><span class="p">,</span>
					      <span class="n">MASKBYTE0</span><span class="p">,</span>
					      <span class="p">((</span><span class="n">u1bdata</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">));</span>
				<span class="n">u1bdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">ROFDM0_TRXPATHENABLE</span><span class="p">,</span>
						<span class="n">MASKBYTE1</span><span class="p">);</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_TRXPATHENABLE</span><span class="p">,</span>
					      <span class="n">MASKBYTE1</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">u1bdata</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">));</span>

				<span class="cm">/* Update current settings. */</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_mrc_switch</span> <span class="o">=</span> <span class="n">bmrc_toset</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_TRXPATHENABLE</span><span class="p">,</span>
					      <span class="n">MASKBYTE0</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
				<span class="n">u1bdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						 <span class="n">ROFDM1_TRXPATHENABLE</span><span class="p">,</span>
						 <span class="n">MASKBYTE0</span><span class="p">);</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM1_TRXPATHENABLE</span><span class="p">,</span>
					      <span class="n">MASKBYTE0</span><span class="p">,</span>
					      <span class="p">((</span><span class="n">u1bdata</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">));</span>
				<span class="n">u1bdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">ROFDM0_TRXPATHENABLE</span><span class="p">,</span>
						<span class="n">MASKBYTE1</span><span class="p">);</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_TRXPATHENABLE</span><span class="p">,</span>
					      <span class="n">MASKBYTE1</span><span class="p">,</span> <span class="p">(</span><span class="n">u1bdata</span> <span class="o">&amp;</span> <span class="mh">0xfb</span><span class="p">));</span>

				<span class="cm">/* Update current settings. */</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_mrc_switch</span> <span class="o">=</span> <span class="n">bmrc_toset</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;switch case not processed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_enable_hw_security_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">sec_reg_value</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;PairwiseEncAlgorithm = %d GroupEncAlgorithm = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">pairwise_enc_algorithm</span><span class="p">,</span>
		 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">group_enc_algorithm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mod_params</span><span class="o">-&gt;</span><span class="n">sw_crypto</span> <span class="o">||</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">use_sw_sec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
			 <span class="s">&quot;not open hw encryption</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sec_reg_value</span> <span class="o">=</span> <span class="n">SCR_TXENCENABLE</span> <span class="o">|</span> <span class="n">SCR_RXENCENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">use_defaultkey</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec_reg_value</span> <span class="o">|=</span> <span class="n">SCR_TXUSEDK</span><span class="p">;</span>
		<span class="n">sec_reg_value</span> <span class="o">|=</span> <span class="n">SCR_RXUSEDK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;The SECR-value %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">sec_reg_value</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_WPA_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec_reg_value</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">_rtl92ce_halset_sysclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">waitcount</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bresult</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmpvalue</span><span class="p">;</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Wait the MAC synchronized. */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>

	<span class="cm">/* Check if it is set ready. */</span>
	<span class="n">tmpvalue</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bresult</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmpvalue</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">waitcount</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">tmpvalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">waitcount</span><span class="o">--</span><span class="p">;</span>

			<span class="n">tmpvalue</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmpvalue</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;wait for BIT(6) return value %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmpvalue</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">waitcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">waitcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bresult</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bresult</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bresult</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192se_gpiobit3_cfg_inputmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">u1tmp</span><span class="p">;</span>

	<span class="cm">/* The following config GPIO function */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">MAC_PINMUX_CFG</span><span class="p">,</span> <span class="p">(</span><span class="n">GPIOMUX_EN</span> <span class="o">|</span> <span class="n">GPIOSEL_GPIO</span><span class="p">));</span>
	<span class="n">u1tmp</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">GPIO_IO_SEL</span><span class="p">);</span>

	<span class="cm">/* config GPIO3 to input */</span>
	<span class="n">u1tmp</span> <span class="o">&amp;=</span> <span class="n">HAL_8192S_HW_GPIO_OFF_MASK</span><span class="p">;</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">GPIO_IO_SEL</span><span class="p">,</span> <span class="n">u1tmp</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">_rtl92se_rf_onoff_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">u1tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">ERFON</span><span class="p">;</span>

	<span class="cm">/* The following config GPIO function */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">MAC_PINMUX_CFG</span><span class="p">,</span> <span class="p">(</span><span class="n">GPIOMUX_EN</span> <span class="o">|</span> <span class="n">GPIOSEL_GPIO</span><span class="p">));</span>
	<span class="n">u1tmp</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">GPIO_IO_SEL</span><span class="p">);</span>

	<span class="cm">/* config GPIO3 to input */</span>
	<span class="n">u1tmp</span> <span class="o">&amp;=</span> <span class="n">HAL_8192S_HW_GPIO_OFF_MASK</span><span class="p">;</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">GPIO_IO_SEL</span><span class="p">,</span> <span class="n">u1tmp</span><span class="p">);</span>

	<span class="cm">/* On some of the platform, driver cannot read correct</span>
<span class="cm">	 * value without delay between Write_GPIO_SEL and Read_GPIO_IN */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* check GPIO3 */</span>
	<span class="n">u1tmp</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">GPIO_IN_SE</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">u1tmp</span> <span class="o">&amp;</span> <span class="n">HAL_8192S_HW_GPIO_OFF_BIT</span><span class="p">)</span> <span class="o">?</span> <span class="n">ERFON</span> <span class="o">:</span> <span class="n">ERFOFF</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92se_macconfig_before_fwdownload</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmpu1b</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmpu2b</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pollingcnt</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">first_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset PCIE Digital */</span>
		<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tmpu1b</span> <span class="o">&amp;=</span> <span class="mh">0xFE</span><span class="p">;</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmpu1b</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Switch to SW IO control */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="p">(</span><span class="n">SYS_CLKR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmpu1b</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>

		<span class="cm">/* Set failed, return to prevent hang. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_rtl92ce_halset_sysclk</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tmpu1b</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_PLL_CTRL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">LDOA15_CTRL</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* Clear FW RPWM for FW control LPS.*/</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RPWM</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* Reset MAC-IO and CPU and Core Digital BIT(10)/11/15 */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tmpu1b</span> <span class="o">&amp;=</span> <span class="mh">0x73</span><span class="p">;</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmpu1b</span><span class="p">);</span>
	<span class="cm">/* wait for BIT 10/11/15 to pull high automatically!! */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Data sheet not define 0x562!!! Copy from WMAC!!!!! */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x562</span><span class="p">);</span>
	<span class="n">tmpu1b</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x562</span><span class="p">,</span> <span class="n">tmpu1b</span><span class="p">);</span>
	<span class="n">tmpu1b</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x562</span><span class="p">,</span> <span class="n">tmpu1b</span><span class="p">);</span>

	<span class="cm">/* Enable AFE clock source */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_XTAL_CTRL</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_XTAL_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">));</span>
	<span class="cm">/* Delay 1.5ms */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_XTAL_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_XTAL_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">&amp;</span> <span class="mh">0xfb</span><span class="p">));</span>

	<span class="cm">/* Enable AFE Macro Block&#39;s Bandgap */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_MISC</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_MISC</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable AFE Mbias */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_MISC</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_MISC</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">));</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable LDOA15 block	*/</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">LDOA15_CTRL</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">LDOA15_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>

	<span class="cm">/* Set Digital Vdd to Retention isolation Path. */</span>
	<span class="n">tmpu2b</span> <span class="o">=</span> <span class="n">rtl_read_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_ISO_CTRL</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_ISO_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu2b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)));</span>

	<span class="cm">/* For warm reboot NIC disappera bug. */</span>
	<span class="n">tmpu2b</span> <span class="o">=</span> <span class="n">rtl_read_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu2b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">13</span><span class="p">)));</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_ISO_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">);</span>

	<span class="cm">/* Enable AFE PLL Macro Block */</span>
	<span class="cm">/* We need to delay 100u before enabling PLL. */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_PLL_CTRL</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_PLL_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>

	<span class="cm">/* for divider reset  */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_PLL_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_PLL_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Enable MAC 80MHZ clock  */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_PLL_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_PLL_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Release isolation AFE PLL &amp; MD */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_ISO_CTRL</span><span class="p">,</span> <span class="mh">0xA6</span><span class="p">);</span>

	<span class="cm">/* Enable MAC clock */</span>
	<span class="n">tmpu2b</span> <span class="o">=</span> <span class="n">rtl_read_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu2b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)));</span>

	<span class="cm">/* Enable Core digital and enable IOREG R/W */</span>
	<span class="n">tmpu2b</span> <span class="o">=</span> <span class="n">rtl_read_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu2b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)));</span>

	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmpu1b</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)));</span>

	<span class="cm">/* enable REG_EN */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu2b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)));</span>

	<span class="cm">/* Switch the control path. */</span>
	<span class="n">tmpu2b</span> <span class="o">=</span> <span class="n">rtl_read_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu2b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">))));</span>

	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="p">(</span><span class="n">SYS_CLKR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_rtl92ce_halset_sysclk</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tmpu1b</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* Set failed, return to prevent hang. */</span>

	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x07FC</span><span class="p">);</span>

	<span class="cm">/* MH We must enable the section of code to prevent load IMEM fail. */</span>
	<span class="cm">/* Load MAC register from WMAc temporarily We simulate macreg. */</span>
	<span class="cm">/* txt HW will provide MAC txt later  */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x11a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x11b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">INIMCS_SEL</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">);</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x236</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x503</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">support_aspm</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">support_backdoor</span><span class="p">)</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x560</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x560</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">DBG_PORT</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">);</span>

	<span class="cm">/* Set RX Desc Address */</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RDQDA</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">RX_MPDU_QUEUE</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RCDA</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">RX_CMD_QUEUE</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>

	<span class="cm">/* Set TX Desc Address */</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TBKDA</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">BK_QUEUE</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TBEDA</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">BE_QUEUE</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TVIDA</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">VI_QUEUE</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TVODA</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">VO_QUEUE</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TBDA</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">BEACON_QUEUE</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TCDA</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">TXCMD_QUEUE</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TMDA</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">MGNT_QUEUE</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">THPDA</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">HIGH_QUEUE</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">HDA</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">HCCA_QUEUE</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x37FC</span><span class="p">);</span>

	<span class="cm">/* To make sure that TxDMA can ready to download FW. */</span>
	<span class="cm">/* We should reset TxDMA if IMEM RPT was not ready. */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmpu1b</span> <span class="o">&amp;</span> <span class="n">TXDMA_INIT_VALUE</span><span class="p">)</span> <span class="o">==</span> <span class="n">TXDMA_INIT_VALUE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pollingcnt</span><span class="o">--</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pollingcnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;Polling TXDMA_INIT_VALUE timeout!! Current TCR(%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">tmpu1b</span><span class="p">);</span>
		<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">);</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="n">tmpu1b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">TXDMA_EN</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* Reset TxDMA */</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">TXDMA_EN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* After MACIO reset,we must refresh LED state. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfoff_reason</span> <span class="o">==</span> <span class="n">RF_CHANGE_BY_IPS</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfoff_reason</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">pcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">rtl_led</span> <span class="o">*</span><span class="n">pLed0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ledctl</span><span class="p">.</span><span class="n">sw_led0</span><span class="p">);</span>
		<span class="k">enum</span> <span class="n">rf_pwrstate</span> <span class="n">rfpwr_state_toset</span><span class="p">;</span>
		<span class="n">rfpwr_state_toset</span> <span class="o">=</span> <span class="n">_rtl92se_rf_onoff_detect</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rfpwr_state_toset</span> <span class="o">==</span> <span class="n">ERFON</span><span class="p">)</span>
			<span class="n">rtl92se_sw_led_on</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pLed0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92se_macconfig_after_fwdownload</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span> <span class="o">=</span> <span class="n">rtl_efuse</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmpu2b</span><span class="p">;</span>

	<span class="cm">/* 1. System Configure Register (Offset: 0x0000 - 0x003F) */</span>

	<span class="cm">/* 2. Command Control Register (Offset: 0x0040 - 0x004F) */</span>
	<span class="cm">/* Turn on 0x40 Command register */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="p">(</span><span class="n">BBRSTN</span> <span class="o">|</span> <span class="n">BB_GLB_RSTN</span> <span class="o">|</span>
			<span class="n">SCHEDULE_EN</span> <span class="o">|</span> <span class="n">MACRXEN</span> <span class="o">|</span> <span class="n">MACTXEN</span> <span class="o">|</span> <span class="n">DDMA_EN</span> <span class="o">|</span> <span class="n">FW2HW_EN</span> <span class="o">|</span>
			<span class="n">RXDMA_EN</span> <span class="o">|</span> <span class="n">TXDMA_EN</span> <span class="o">|</span> <span class="n">HCI_RXDMA_EN</span> <span class="o">|</span> <span class="n">HCI_TXDMA_EN</span><span class="p">));</span>

	<span class="cm">/* Set TCR TX DMA pre 2 FULL enable bit	*/</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TCR</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">TXDMAPRE2FULL</span><span class="p">);</span>

	<span class="cm">/* Set RCR	*/</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">receive_config</span><span class="p">);</span>

	<span class="cm">/* 3. MACID Setting Register (Offset: 0x0050 - 0x007F) */</span>

	<span class="cm">/* 4. Timing Control Register  (Offset: 0x0080 - 0x009F) */</span>
	<span class="cm">/* Set CCK/OFDM SIFS */</span>
	<span class="cm">/* CCK SIFS shall always be 10us. */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SIFS_CCK</span><span class="p">,</span> <span class="mh">0x0a0a</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SIFS_OFDM</span><span class="p">,</span> <span class="mh">0x1010</span><span class="p">);</span>

	<span class="cm">/* Set AckTimeout */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">ACK_TIMEOUT</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>

	<span class="cm">/* Beacon related */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">BCN_INTERVAL</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">ATIMWND</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* 5. FIFO Control Register (Offset: 0x00A0 - 0x015F) */</span>
	<span class="cm">/* 5.1 Initialize Number of Reserved Pages in Firmware Queue */</span>
	<span class="cm">/* Firmware allocate now, associate with FW internal setting.!!! */</span>

	<span class="cm">/* 5.2 Setting TX/RX page size 0/1/2/3/4=64/128/256/512/1024 */</span>
	<span class="cm">/* 5.3 Set driver info, we only accept PHY status now. */</span>
	<span class="cm">/* 5.4 Set RXDMA arbitration to control RXDMA/MAC/FW R/W for RXFIFO  */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RXDMA</span><span class="p">,</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RXDMA</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">));</span>

	<span class="cm">/* 6. Adaptive Control Register  (Offset: 0x0160 - 0x01CF) */</span>
	<span class="cm">/* Set RRSR to all legacy rate and HT rate</span>
<span class="cm">	 * CCK rate is supported by default.</span>
<span class="cm">	 * CCK rate will be filtered out only when associated</span>
<span class="cm">	 * AP does not support it.</span>
<span class="cm">	 * Only enable ACK rate to OFDM 24M</span>
<span class="cm">	 * Disable RRSR for CCK rate in A-Cut	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">VERSION_8192S_ACUT</span><span class="p">)</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RRSR</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">VERSION_8192S_BCUT</span><span class="p">)</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RRSR</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RRSR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RRSR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* A-Cut IC do not support CCK rate. We forbid ARFR to */</span>
	<span class="cm">/* fallback to CCK rate */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*Disable RRSR for CCK rate in A-Cut */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">VERSION_8192S_ACUT</span><span class="p">)</span>
			<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">ARFR0</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x1f0ff0f0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Different rate use different AMPDU size */</span>
	<span class="cm">/* MCS32/ MCS15_SG use max AMPDU size 15*2=30K */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AGGLEN_LMT_H</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="cm">/* MCS0/1/2/3 use max AMPDU size 4*2=8K */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AGGLEN_LMT_L</span><span class="p">,</span> <span class="mh">0x7442</span><span class="p">);</span>
	<span class="cm">/* MCS4/5 use max AMPDU size 8*2=16K 6/7 use 10*2=20K */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AGGLEN_LMT_L</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xddd7</span><span class="p">);</span>
	<span class="cm">/* MCS8/9 use max AMPDU size 8*2=16K 10/11 use 10*2=20K */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AGGLEN_LMT_L</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xd772</span><span class="p">);</span>
	<span class="cm">/* MCS12/13/14/15 use max AMPDU size 15*2=30K */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AGGLEN_LMT_L</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0xfffd</span><span class="p">);</span>

	<span class="cm">/* Set Data / Response auto rate fallack retry count */</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">DARFRC</span><span class="p">,</span> <span class="mh">0x04010000</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">DARFRC</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x09070605</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RARFRC</span><span class="p">,</span> <span class="mh">0x04010000</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RARFRC</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x09070605</span><span class="p">);</span>

	<span class="cm">/* 7. EDCA Setting Register (Offset: 0x01D0 - 0x01FF) */</span>
	<span class="cm">/* Set all rate to support SG */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SG_RATE</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="cm">/* 8. WMAC, BA, and CCX related Register (Offset: 0x0200 - 0x023F) */</span>
	<span class="cm">/* Set NAV protection length */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">NAV_PROT_LEN</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">);</span>
	<span class="cm">/* CF-END Threshold */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CFEND_TH</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="cm">/* Set AMPDU minimum space */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AMPDU_MIN_SPACE</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="cm">/* Set TXOP stall control for several queue/HI/BCN/MGT/ */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TXOP_STALL_CTRL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* 9. Security Control Register (Offset: 0x0240 - 0x025F) */</span>
	<span class="cm">/* 10. Power Save Control Register (Offset: 0x0260 - 0x02DF) */</span>
	<span class="cm">/* 11. General Purpose Register (Offset: 0x02E0 - 0x02FF) */</span>
	<span class="cm">/* 12. Host Interrupt Status Register (Offset: 0x0300 - 0x030F) */</span>
	<span class="cm">/* 13. Test Mode and Debug Control Register (Offset: 0x0310 - 0x034F) */</span>

	<span class="cm">/* 14. Set driver info, we only accept PHY status now. */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RXDRVINFO_SZ</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* 15. For EEPROM R/W Workaround */</span>
	<span class="cm">/* 16. For EFUSE to share REG_SYS_FUNC_EN with EEPROM!!! */</span>
	<span class="n">tmpu2b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span><span class="p">,</span> <span class="n">tmpu2b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">13</span><span class="p">));</span>
	<span class="n">tmpu2b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_ISO_CTRL</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_ISO_CTRL</span><span class="p">,</span> <span class="n">tmpu2b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)));</span>

	<span class="cm">/* 17. For EFUSE */</span>
	<span class="cm">/* We may R/W EFUSE in EEPROM mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">epromtype</span> <span class="o">==</span> <span class="n">EEPROM_BOOT_EFUSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span>	<span class="n">tempval</span><span class="p">;</span>

		<span class="n">tempval</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_ISO_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tempval</span> <span class="o">&amp;=</span> <span class="mh">0xFE</span><span class="p">;</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_ISO_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tempval</span><span class="p">);</span>

		<span class="cm">/* Change Program timing */</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_EFUSE_CTRL</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;EFUSE CONFIG OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92se_hw_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">u8</span> <span class="n">reg_bw_opmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_rrsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">regtmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg_bw_opmode</span> <span class="o">=</span> <span class="n">BW_OPMODE_20MHZ</span><span class="p">;</span>
	<span class="n">reg_rrsr</span> <span class="o">=</span> <span class="n">RATE_ALL_CCK</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_AG</span><span class="p">;</span>

	<span class="n">regtmp</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">INIRTSMCS_SEL</span><span class="p">);</span>
	<span class="n">reg_rrsr</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg_rrsr</span> <span class="o">&amp;</span> <span class="mh">0x000fffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">regtmp</span><span class="p">;</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">INIRTSMCS_SEL</span><span class="p">,</span> <span class="n">reg_rrsr</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">BW_OPMODE</span><span class="p">,</span> <span class="n">reg_bw_opmode</span><span class="p">);</span>

	<span class="cm">/* Set Retry Limit here */</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_RETRY_LIMIT</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">shortretry_limit</span><span class="p">));</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">MLT</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">);</span>

	<span class="cm">/* For Min Spacing configuration. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RF_1T2R</span>:
	<span class="k">case</span> <span class="n">RF_1T1R</span>:
		<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">minspace_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX_MSS_DENSITY_1T</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RF_2T2R</span>:
	<span class="k">case</span> <span class="n">RF_2T2R_GREEN</span>:
		<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">minspace_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX_MSS_DENSITY_2T</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AMPDU_MIN_SPACE</span><span class="p">,</span> <span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">minspace_cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtl92se_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span> <span class="o">=</span> <span class="n">rtl_efuse</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">tmp_byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">rtstatus</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp_u1b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wdcapra_add</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">EDCAPARA_BE</span><span class="p">,</span> <span class="n">EDCAPARA_BK</span><span class="p">,</span>
		<span class="n">EDCAPARA_VI</span><span class="p">,</span> <span class="n">EDCAPARA_VO</span><span class="p">};</span>
	<span class="n">u8</span> <span class="n">secr_value</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">being_init_adapter</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">intf_ops</span><span class="o">-&gt;</span><span class="n">disable_aspm</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* 1. MAC Initialize */</span>
	<span class="cm">/* Before FW download, we have to set some MAC register */</span>
	<span class="n">_rtl92se_macconfig_before_fwdownload</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">version_8192s</span><span class="p">)((</span><span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span>
			<span class="n">PMC_FSM</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>

	<span class="n">rtl8192se_gpiobit3_cfg_inputmode</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* 2. download firmware */</span>
	<span class="n">rtstatus</span> <span class="o">=</span> <span class="n">rtl92s_download_fw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtstatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span>
			 <span class="s">&quot;Failed to download FW. Init HW without FW now... &quot;</span>
			 <span class="s">&quot;Please copy FW into /lib/firmware/rtlwifi</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* After FW download, we have to reset MAC register */</span>
	<span class="n">_rtl92se_macconfig_after_fwdownload</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*Retrieve default FW Cmd IO map. */</span>
	<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">fwcmd_iomap</span> <span class="o">=</span>	<span class="n">rtl_read_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">LBUS_MON_ADDR</span><span class="p">);</span>
	<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">fwcmd_ioparam</span> <span class="o">=</span> <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">LBUS_ADDR_MASK</span><span class="p">);</span>

	<span class="cm">/* 3. Initialize MAC/PHY Config by MACPHY_reg.txt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtl92s_phy_mac_config</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span> <span class="s">&quot;MAC Config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rtstatus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure BB/RF write OK. We should prevent enter IPS. radio off. */</span>
	<span class="cm">/* We must set flag avoid BB/RF config period later!! */</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x37FC</span><span class="p">);</span>

	<span class="cm">/* 4. Initialize BB After MAC Config PHY_reg.txt, AGC_Tab.txt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtl92s_phy_bb_config</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span> <span class="s">&quot;BB Config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rtstatus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 5. Initiailze RF RAIO_A.txt RF RAIO_B.txt */</span>
	<span class="cm">/* Before initalizing RF. We can not use FW to do RF-R/W. */</span>

	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_mode</span> <span class="o">=</span> <span class="n">RF_OP_BY_SW_3WIRE</span><span class="p">;</span>

	<span class="cm">/* RF Power Save */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* H/W or S/W RF OFF before sleep. */</span>
<span class="c">	if (rtlpriv-&gt;psc.rfoff_reason &gt; RF_CHANGE_BY_PS) {</span>
<span class="c">		u32 rfoffreason = rtlpriv-&gt;psc.rfoff_reason;</span>

<span class="c">		rtlpriv-&gt;psc.rfoff_reason = RF_CHANGE_BY_INIT;</span>
<span class="c">		rtlpriv-&gt;psc.rfpwr_state = ERFON;</span>
<span class="c">		/* FIXME: check spinlocks if this block is uncommented */</span>
<span class="c">		rtl_ps_set_rf_state(hw, ERFOFF, rfoffreason);</span>
<span class="c">	} else {</span>
<span class="c">		/* gpio radio on/off is out of adapter start */</span>
<span class="c">		if (rtlpriv-&gt;psc.hwradiooff == false) {</span>
<span class="c">			rtlpriv-&gt;psc.rfpwr_state = ERFON;</span>
<span class="c">			rtlpriv-&gt;psc.rfoff_reason = 0;</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Before RF-R/W we must execute the IO from Scott&#39;s suggestion. */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_XTAL_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">VERSION_8192S_ACUT</span><span class="p">)</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SPS1_CTRL</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">RF_CTRL</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtl92s_phy_rf_config</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;RF Config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rtstatus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* After read predefined TXT, we must set BB/MAC/RF</span>
<span class="cm">	 * register as our requirement */</span>

	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rfreg_chnlval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtl92s_phy_query_rf_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
							   <span class="p">(</span><span class="k">enum</span> <span class="n">radio_path</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
							   <span class="n">RF_CHNLBW</span><span class="p">,</span>
							   <span class="n">RFREG_OFFSET_MASK</span><span class="p">);</span>
	<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rfreg_chnlval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtl92s_phy_query_rf_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
							   <span class="p">(</span><span class="k">enum</span> <span class="n">radio_path</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span>
							   <span class="n">RF_CHNLBW</span><span class="p">,</span>
							   <span class="n">RFREG_OFFSET_MASK</span><span class="p">);</span>

	<span class="cm">/*---- Set CCK and OFDM Block &quot;ON&quot;----*/</span>
	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_RFMOD</span><span class="p">,</span> <span class="n">BCCKEN</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFPGA0_RFMOD</span><span class="p">,</span> <span class="n">BOFDMEN</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/*3 Set Hardware(Do nothing now) */</span>
	<span class="n">_rtl92se_hw_configure</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Read EEPROM TX power index and PHY_REG_PG.txt to capture correct */</span>
	<span class="cm">/* TX power index for different rate set. */</span>
	<span class="cm">/* Get original hw reg values */</span>
	<span class="n">rtl92s_phy_get_hw_reg_originalvalue</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="cm">/* Write correct tx power index */</span>
	<span class="n">rtl92s_phy_set_txpower</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_channel</span><span class="p">);</span>

	<span class="cm">/* We must set MAC address after firmware download. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">MACIDR0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* EEPROM R/W workaround */</span>
	<span class="n">tmp_u1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">MAC_PINMUX_CFG</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">MAC_PINMUX_CFG</span><span class="p">,</span> <span class="n">tmp_u1b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)));</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hal_get_firmwareversion</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x49</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_byte</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FW_RSVD_PG_CRTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
		<span class="n">tmp_byte</span> <span class="o">=</span> <span class="n">tmp_byte</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FW_RSVD_PG_CRTL</span><span class="p">,</span> <span class="n">tmp_byte</span><span class="p">);</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TXDESC_MSK</span><span class="p">,</span> <span class="mh">0xFFFFCFFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We enable high power and RA related mechanism after NIC</span>
<span class="cm">	 * initialized. */</span>
	<span class="n">rtl92s_phy_set_fw_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">FW_CMD_RA_INIT</span><span class="p">);</span>

	<span class="cm">/* Add to prevent ASPM bug. */</span>
	<span class="cm">/* Always enable hst and NIC clock request. */</span>
	<span class="n">rtl92s_phy_switch_ephy_parameter</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Security related</span>
<span class="cm">	 * 1. Clear all H/W keys.</span>
<span class="cm">	 * 2. Enable H/W encryption/decryption. */</span>
	<span class="n">rtl_cam_reset_all_entry</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">secr_value</span> <span class="o">|=</span> <span class="n">SCR_TXENCENABLE</span><span class="p">;</span>
	<span class="n">secr_value</span> <span class="o">|=</span> <span class="n">SCR_RXENCENABLE</span><span class="p">;</span>
	<span class="n">secr_value</span> <span class="o">|=</span> <span class="n">SCR_NOSKMC</span><span class="p">;</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SECR</span><span class="p">,</span> <span class="n">secr_value</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">wdcapra_add</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0x5e4322</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T2R</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">mrc2set</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* Turn on B-Path */</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_MRC</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mrc2set</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">led_control</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">LED_CTL_POWER_ON</span><span class="p">);</span>
	<span class="n">rtl92s_dm_init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">being_init_adapter</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl_io</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_set_check_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">check_bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">reg_rcr</span> <span class="o">=</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">receive_config</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">rfpwr_state</span> <span class="o">!=</span> <span class="n">ERFON</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_bssid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_rcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RCR_CBSSID</span><span class="p">);</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_RCR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg_rcr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_bssid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_rcr</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">RCR_CBSSID</span><span class="p">);</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_RCR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg_rcr</span><span class="p">));</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_rtl92se_set_media_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">bt_msr</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">MSR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">bt_msr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSR_LINK_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span>:
		<span class="n">bt_msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MSR_LINK_NONE</span> <span class="o">&lt;&lt;</span> <span class="n">MSR_LINK_SHIFT</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;Set Network type to NO LINK!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">bt_msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MSR_LINK_ADHOC</span> <span class="o">&lt;&lt;</span> <span class="n">MSR_LINK_SHIFT</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;Set Network type to Ad Hoc!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">bt_msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MSR_LINK_MANAGED</span> <span class="o">&lt;&lt;</span> <span class="n">MSR_LINK_SHIFT</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;Set Network type to STA!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">bt_msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MSR_LINK_MASTER</span> <span class="o">&lt;&lt;</span> <span class="n">MSR_LINK_SHIFT</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;Set Network type to AP!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;Network type %d not supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="p">(</span><span class="n">MSR</span><span class="p">),</span> <span class="n">bt_msr</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TCR</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)));</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* HW_VAR_MEDIA_STATUS &amp; HW_VAR_CECHK_BSSID */</span>
<span class="kt">int</span> <span class="nf">rtl92se_set_network_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_rtl92se_set_media_status</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">link_state</span> <span class="o">==</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
			<span class="n">rtl92se_set_check_bssid</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtl92se_set_check_bssid</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* don&#39;t set REG_EDCA_BE_PARAM here because mac80211 will send pkt when scan */</span>
<span class="kt">void</span> <span class="nf">rtl92se_set_qos</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl92s_dm_init_edca_turbo</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">aci</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AC1_BK</span>:
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">EDCAPARA_BK</span><span class="p">,</span> <span class="mh">0xa44f</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AC0_BE</span>:
		<span class="cm">/* rtl_write_dword(rtlpriv, EDCAPARA_BE, u4b_ac_param); */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AC2_VI</span>:
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">EDCAPARA_VI</span><span class="p">,</span> <span class="mh">0x5e4322</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AC3_VO</span>:
		<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">EDCAPARA_VO</span><span class="p">,</span> <span class="mh">0x2f3222</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">RT_ASSERT</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="s">&quot;invalid aci: %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aci</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_enable_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">INTA_MASK</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="cm">/* Support Bit 32-37(Assign as Bit 0-5) interrupt setting now */</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">INTA_MASK</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_disable_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span><span class="p">;</span>

	<span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="cm">/* if firmware not available, no interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span> <span class="o">||</span> <span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">max_fw_size</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">INTA_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">INTA_MASK</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">u8</span> <span class="nf">_rtl92s_set_sysclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">waitcnt</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Wait the MAC synchronized. */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>

	<span class="cm">/* Check if it is set ready. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">waitcnt</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">waitcnt</span><span class="o">--</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;wait for BIT(6) return value %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">waitcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">waitcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92s_phy_set_rfhalt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">u1btmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">driver_going2unload</span><span class="p">)</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x560</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* Power save for BB/RF */</span>
	<span class="n">u1btmp</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">LDOV12D_CTRL</span><span class="p">);</span>
	<span class="n">u1btmp</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">LDOV12D_CTRL</span><span class="p">,</span> <span class="n">u1btmp</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SPS1_CTRL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TXPAUSE</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x57FC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x77FC</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">PHY_CCA</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x37FC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x77FC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x57FC</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">driver_going2unload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u1btmp</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="p">(</span><span class="n">REG_SYS_FUNC_EN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">u1btmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">u1btmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">u1btmp</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="p">(</span><span class="n">SYS_CLKR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Add description. After switch control path. register</span>
<span class="cm">	 * after page1 will be invisible. We can not do any IO</span>
<span class="cm">	 * for register&gt;0x40. After resume&amp;MACIO reset, we need</span>
<span class="cm">	 * to remember previous reg content. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u1btmp</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u1btmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_rtl92s_set_sysclk</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">u1btmp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Switch ctrl path fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Power save for MAC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfoff_reason</span> <span class="o">==</span> <span class="n">RF_CHANGE_BY_IPS</span>  <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">driver_going2unload</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable LED function */</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">);</span>
	<span class="cm">/* SW/HW radio off or halt adapter!! For example S3/S4 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* LED function disable. Power range is about 8mA now. */</span>
		<span class="cm">/* if write 0xF1 disconnet_pci power</span>
<span class="cm">		 *	 ifconfig wlan0 down power are both high 35:70 */</span>
		<span class="cm">/* if write oxF9 disconnet_pci power</span>
<span class="cm">		 * ifconfig wlan0 down power are both low  12:45*/</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_PLL_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span>  <span class="n">AFE_PLL_CTRL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">LDOA15_CTRL</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_XTAL_CTRL</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">);</span>
	<span class="n">RT_SET_PS_LEVEL</span><span class="p">(</span><span class="n">ppsc</span><span class="p">,</span> <span class="n">RT_RF_OFF_LEVL_HALT_NIC</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92se_gen_refreshledstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">pcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_led</span> <span class="o">*</span><span class="n">pLed0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ledctl</span><span class="p">.</span><span class="n">sw_led0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">up_first_time</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">rfoff_reason</span> <span class="o">==</span> <span class="n">RF_CHANGE_BY_IPS</span><span class="p">)</span>
		<span class="n">rtl92se_sw_led_on</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pLed0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rtl92se_sw_led_off</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pLed0</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92se_power_domain_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">tmpu2b</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmpu1b</span><span class="p">;</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">pwrdomain_protect</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="p">(</span><span class="n">SYS_CLKR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmpu1b</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_rtl92s_set_sysclk</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tmpu1b</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">pwrdomain_protect</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_PLL_CTRL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">LDOA15_CTRL</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">);</span>

	<span class="cm">/* Reset MAC-IO and CPU and Core Digital BIT10/11/15 */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* If IPS we need to turn LED on. So we not</span>
<span class="cm">	 * not disable BIT 3/7 of reg3. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">rfoff_reason</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RF_CHANGE_BY_IPS</span> <span class="o">|</span> <span class="n">RF_CHANGE_BY_HW</span><span class="p">))</span>
		<span class="n">tmpu1b</span> <span class="o">&amp;=</span> <span class="mh">0xFB</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmpu1b</span> <span class="o">&amp;=</span> <span class="mh">0x73</span><span class="p">;</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmpu1b</span><span class="p">);</span>
	<span class="cm">/* wait for BIT 10/11/15 to pull high automatically!! */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Data sheet not define 0x562!!! Copy from WMAC!!!!! */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x562</span><span class="p">);</span>
	<span class="n">tmpu1b</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x562</span><span class="p">,</span> <span class="n">tmpu1b</span><span class="p">);</span>
	<span class="n">tmpu1b</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x562</span><span class="p">,</span> <span class="n">tmpu1b</span><span class="p">);</span>

	<span class="cm">/* Enable AFE clock source */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_XTAL_CTRL</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_XTAL_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">));</span>
	<span class="cm">/* Delay 1.5ms */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1500</span><span class="p">);</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_XTAL_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_XTAL_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">&amp;</span> <span class="mh">0xfb</span><span class="p">));</span>

	<span class="cm">/* Enable AFE Macro Block&#39;s Bandgap */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_MISC</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_MISC</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable AFE Mbias */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_MISC</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_MISC</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">));</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable LDOA15 block */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">LDOA15_CTRL</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">LDOA15_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>

	<span class="cm">/* Set Digital Vdd to Retention isolation Path. */</span>
	<span class="n">tmpu2b</span> <span class="o">=</span> <span class="n">rtl_read_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_ISO_CTRL</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_ISO_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu2b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)));</span>


	<span class="cm">/* For warm reboot NIC disappera bug. */</span>
	<span class="n">tmpu2b</span> <span class="o">=</span> <span class="n">rtl_read_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu2b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">13</span><span class="p">)));</span>

	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_ISO_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">);</span>

	<span class="cm">/* Enable AFE PLL Macro Block */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_PLL_CTRL</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_PLL_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>
	<span class="cm">/* Enable MAC 80MHZ clock */</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_PLL_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">AFE_PLL_CTRL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Release isolation AFE PLL &amp; MD */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_ISO_CTRL</span><span class="p">,</span> <span class="mh">0xA6</span><span class="p">);</span>

	<span class="cm">/* Enable MAC clock */</span>
	<span class="n">tmpu2b</span> <span class="o">=</span> <span class="n">rtl_read_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu2b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)));</span>

	<span class="cm">/* Enable Core digital and enable IOREG R/W */</span>
	<span class="n">tmpu2b</span> <span class="o">=</span> <span class="n">rtl_read_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu2b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)));</span>
	<span class="cm">/* enable REG_EN */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_SYS_FUNC_EN</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu2b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)));</span>

	<span class="cm">/* Switch the control path. */</span>
	<span class="n">tmpu2b</span> <span class="o">=</span> <span class="n">rtl_read_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span><span class="p">);</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SYS_CLKR</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu2b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">))));</span>

	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="p">(</span><span class="n">SYS_CLKR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">tmpu1b</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmpu1b</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_rtl92s_set_sysclk</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tmpu1b</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">pwrdomain_protect</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="mh">0x37FC</span><span class="p">);</span>

	<span class="cm">/* After MACIO reset,we must refresh LED state. */</span>
	<span class="n">_rtl92se_gen_refreshledstate</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">pwrdomain_protect</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_card_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">opmode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wait</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">intf_ops</span><span class="o">-&gt;</span><span class="n">enable_aspm</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">driver_is_goingto_unload</span> <span class="o">||</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfoff_reason</span> <span class="o">&gt;</span> <span class="n">RF_CHANGE_BY_PS</span><span class="p">)</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">led_control</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">LED_CTL_POWER_OFF</span><span class="p">);</span>

	<span class="cm">/* we should chnge GPIO to input mode</span>
<span class="cm">	 * this will drop away current about 25mA*/</span>
	<span class="n">rtl8192se_gpiobit3_cfg_inputmode</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* this is very important for ips power save */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">wait</span><span class="o">--</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">pwrdomain_protect</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">pwrdomain_protect</span><span class="p">)</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">=</span> <span class="n">MAC80211_NOLINK</span><span class="p">;</span>
	<span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">;</span>
	<span class="n">_rtl92se_set_media_status</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">opmode</span><span class="p">);</span>

	<span class="n">_rtl92s_phy_set_rfhalt</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_interrupt_recognized</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">p_inta</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="o">*</span><span class="n">p_intb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="o">*</span><span class="n">p_inta</span> <span class="o">=</span> <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">ISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">ISR</span><span class="p">,</span> <span class="o">*</span><span class="n">p_inta</span><span class="p">);</span>

	<span class="o">*</span><span class="n">p_intb</span> <span class="o">=</span> <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">ISR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">ISR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">*</span><span class="n">p_intb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_set_beacon_related_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u16</span> <span class="n">bcntime_cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bcn_cw</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">bcn_ifs</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">atim_window</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* ATIM Window (in unit of TU). */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">ATIMWND</span><span class="p">,</span> <span class="n">atim_window</span><span class="p">);</span>

	<span class="cm">/* Beacon interval (in unit of TU). */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">BCN_INTERVAL</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">);</span>

	<span class="cm">/* DrvErlyInt (in unit of TU). (Time to send</span>
<span class="cm">	 * interrupt to notify driver to change</span>
<span class="cm">	 * beacon content) */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">BCN_DRV_EARLY_INT</span><span class="p">,</span> <span class="mi">10</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* BcnDMATIM(in unit of us). Indicates the</span>
<span class="cm">	 * time before TBTT to perform beacon queue DMA  */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">BCN_DMATIME</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>

	<span class="cm">/* Force beacon frame transmission even</span>
<span class="cm">	 * after receiving beacon frame from</span>
<span class="cm">	 * other ad hoc STA */</span>
	<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">BCN_ERR_THRESH</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Beacon Time Configuration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="n">bcntime_cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bcn_cw</span> <span class="o">&lt;&lt;</span> <span class="n">BCN_TCFG_CW_SHIFT</span><span class="p">);</span>

	<span class="cm">/* TODO: bcn_ifs may required to be changed on ASIC */</span>
	<span class="n">bcntime_cfg</span> <span class="o">|=</span> <span class="n">bcn_ifs</span> <span class="o">&lt;&lt;</span> <span class="n">BCN_TCFG_IFS</span><span class="p">;</span>

	<span class="cm">/*for beacon changed */</span>
	<span class="n">rtl92s_phy_set_beacon_hwreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_set_beacon_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u16</span> <span class="n">bcn_interval</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">;</span>

	<span class="cm">/* Beacon interval (in unit of TU). */</span>
	<span class="n">rtl_write_word</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">BCN_INTERVAL</span><span class="p">,</span> <span class="n">bcn_interval</span><span class="p">);</span>
	<span class="cm">/* 2008.10.24 added by tynli for beacon changed. */</span>
	<span class="n">rtl92s_phy_set_beacon_hwreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">bcn_interval</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_update_interrupt_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">add_msr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rm_msr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INTR</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;add_msr:%x, rm_msr:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">add_msr</span><span class="p">,</span> <span class="n">rm_msr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">add_msr</span><span class="p">)</span>
		<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">add_msr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rm_msr</span><span class="p">)</span>
		<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">rm_msr</span><span class="p">);</span>

	<span class="n">rtl92se_disable_interrupt</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl92se_enable_interrupt</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl8192se_get_IC_Inferiority</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span> <span class="o">=</span> <span class="n">rtl_efuse</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">efuse_id</span><span class="p">;</span>

	<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">ic_class</span> <span class="o">=</span> <span class="n">IC_INFERIORITY_A</span><span class="p">;</span>

	<span class="cm">/* Only retrieving while using EFUSE. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">epromtype</span> <span class="o">==</span> <span class="n">EEPROM_BOOT_EFUSE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">autoload_failflag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">efuse_id</span> <span class="o">=</span> <span class="n">efuse_read_1byte</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">EFUSE_IC_ID_OFFSET</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">efuse_id</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">)</span>
			<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">ic_class</span> <span class="o">=</span> <span class="n">IC_INFERIORITY_B</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl92se_read_adapter_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span> <span class="o">=</span> <span class="n">rtl_efuse</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">usvalue</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">eeprom_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tempval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hwinfo</span><span class="p">[</span><span class="n">HWSET_MAX_SIZE_92S</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">rf_path</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">epromtype</span> <span class="o">==</span> <span class="n">EEPROM_93C46</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;RTL819X Not boot from eeprom, check it !!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">epromtype</span> <span class="o">==</span> <span class="n">EEPROM_BOOT_EFUSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl_efuse_shadow_map_update</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hwinfo</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span>
			<span class="o">&amp;</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">efuse_map</span><span class="p">[</span><span class="n">EFUSE_INIT_MAP</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">HWSET_MAX_SIZE_92S</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RT_PRINT_DATA</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;MAP&quot;</span><span class="p">,</span>
		      <span class="n">hwinfo</span><span class="p">,</span> <span class="n">HWSET_MAX_SIZE_92S</span><span class="p">);</span>

	<span class="n">eeprom_id</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_id</span> <span class="o">!=</span> <span class="n">RTL8190_EEPROM_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span>
			 <span class="s">&quot;EEPROM ID(%#x) is invalid!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_id</span><span class="p">);</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">autoload_failflag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;Autoload OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">autoload_failflag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">autoload_failflag</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">_rtl8192se_get_IC_Inferiority</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Read IC Version &amp;&amp; Channel Plan */</span>
	<span class="cm">/* VID, DID	 SE	0xA-D */</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_vid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_VID</span><span class="p">];</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_did</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_DID</span><span class="p">];</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_svid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_SVID</span><span class="p">];</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_smid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_SMID</span><span class="p">];</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_version</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_VERSION</span><span class="p">];</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;EEPROMId = 0x%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_id</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;EEPROM VID = 0x%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_vid</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;EEPROM DID = 0x%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_did</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;EEPROM SVID = 0x%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_svid</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;EEPROM SMID = 0x%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_smid</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usvalue</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_MAC_ADDR</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">=</span> <span class="n">usvalue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">MACIDR0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="cm">/* Get Tx Power Level by Channel */</span>
	<span class="cm">/* Read Tx power of Channel 1 ~ 14 from EEPROM. */</span>
	<span class="cm">/* 92S suupport RF A &amp; B */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rf_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rf_path</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">rf_path</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Read CCK RF A &amp; B Tx power  */</span>
			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_chnlarea_txpwr_cck</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_TXPOWERBASE</span> <span class="o">+</span> <span class="n">rf_path</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>

			<span class="cm">/* Read OFDM RF A &amp; B Tx power for 1T */</span>
			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_chnlarea_txpwr_ht40_1s</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_TXPOWERBASE</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">rf_path</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>

			<span class="cm">/* Read OFDM RF A &amp; B Tx power for 2T */</span>
			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_chnlarea_txpwr_ht40_2sdiif</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
				 <span class="o">=</span> <span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_TXPOWERBASE</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span>
				   <span class="n">rf_path</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rf_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rf_path</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">rf_path</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_EEPROM</span><span class="p">,</span>
				<span class="s">&quot;RF(%d) EEPROM CCK Area(%d) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rf_path</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_chnlarea_txpwr_cck</span>
				<span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rf_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rf_path</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">rf_path</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_EEPROM</span><span class="p">,</span>
				<span class="s">&quot;RF(%d) EEPROM HT40 1S Area(%d) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rf_path</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_chnlarea_txpwr_ht40_1s</span>
				<span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rf_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rf_path</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">rf_path</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_EEPROM</span><span class="p">,</span>
				<span class="s">&quot;RF(%d) EEPROM HT40 2S Diff Area(%d) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rf_path</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_chnlarea_txpwr_ht40_2sdiif</span>
				<span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rf_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rf_path</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">rf_path</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Assign dedicated channel tx power */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>	<span class="p">{</span>
			<span class="cm">/* channel 1~3 use the same Tx Power Level. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Channel 4-8 */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* Channel 9-14 */</span>
			<span class="k">else</span>
				<span class="n">index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="cm">/* Record A &amp; B CCK /OFDM - 1T/2T Channel area</span>
<span class="cm">			 * tx power */</span>
			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwrlevel_cck</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span>
				<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_chnlarea_txpwr_cck</span>
							<span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">index</span><span class="p">];</span>
			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwrlevel_ht40_1s</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span>
				<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_chnlarea_txpwr_ht40_1s</span>
							<span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">index</span><span class="p">];</span>
			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwrlevel_ht40_2s</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span>
				<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_chnlarea_txpwr_ht40_2sdiif</span>
							<span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">index</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_TxPower</span><span class="p">,</span>
				<span class="s">&quot;RF(%d)-Ch(%d) [CCK / HT40_1S / HT40_2S] = [0x%x / 0x%x / 0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rf_path</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwrlevel_cck</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
				<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwrlevel_ht40_1s</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
				<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwrlevel_ht40_2s</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rf_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rf_path</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">rf_path</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Read Power diff limit. */</span>
			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_pwrgroup</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_TXPWRGROUP</span> <span class="o">+</span> <span class="n">rf_path</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rf_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rf_path</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">rf_path</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fill Pwr group */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Chanel 1-3 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Channel 4-8 */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* Channel 9-13 */</span>
			<span class="k">else</span>
				<span class="n">index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">pwrgroup_ht20</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_pwrgroup</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="mh">0xf</span><span class="p">);</span>
			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">pwrgroup_ht40</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_pwrgroup</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_TxPower</span><span class="p">,</span>
				<span class="s">&quot;RF-%d pwrgroup_ht20[%d] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rf_path</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">pwrgroup_ht20</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_TxPower</span><span class="p">,</span>
				<span class="s">&quot;RF-%d pwrgroup_ht40[%d] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rf_path</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">pwrgroup_ht40</span><span class="p">[</span><span class="n">rf_path</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Read tx power difference between HT OFDM 20/40 MHZ */</span>
		<span class="cm">/* channel 1-3 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Channel 4-8 */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Channel 9-14 */</span>
		<span class="k">else</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">tempval</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_TX_PWR_HT20_DIFF</span> <span class="o">+</span>
			   <span class="n">index</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwr_ht20diff</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tempval</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwr_ht20diff</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
						 <span class="p">((</span><span class="n">tempval</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>

		<span class="cm">/* Read OFDM&lt;-&gt;HT tx power diff */</span>
		<span class="cm">/* Channel 1-3 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Channel 4-8 */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
		<span class="cm">/* Channel 9-14 */</span>
		<span class="k">else</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">tempval</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_TX_PWR_OFDM_DIFF</span> <span class="o">+</span> <span class="n">index</span><span class="p">])</span>
				  <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwr_legacyhtdiff</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				 <span class="p">(</span><span class="n">tempval</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwr_legacyhtdiff</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				 <span class="p">((</span><span class="n">tempval</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>

		<span class="n">tempval</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">TX_PWR_SAFETY_CHK</span><span class="p">]);</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwr_safetyflag</span> <span class="o">=</span> <span class="p">(</span><span class="n">tempval</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_regulatory</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BIT(0)~2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_version</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_regulatory</span> <span class="o">=</span>
				 <span class="p">(</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_REGULATORY</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
		<span class="k">else</span> <span class="cm">/* BIT(0) */</span>
			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_regulatory</span> <span class="o">=</span>
				 <span class="p">(</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_REGULATORY</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_TxPower</span><span class="p">,</span>
		<span class="s">&quot;eeprom_regulatory = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_regulatory</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_TxPower</span><span class="p">,</span>
			<span class="s">&quot;RF-A Ht20 to HT40 Diff[%d] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwr_ht20diff</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_TxPower</span><span class="p">,</span>
			<span class="s">&quot;RF-A Legacy to Ht40 Diff[%d] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwr_legacyhtdiff</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_TxPower</span><span class="p">,</span>
			<span class="s">&quot;RF-B Ht20 to HT40 Diff[%d] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwr_ht20diff</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_TxPower</span><span class="p">,</span>
			<span class="s">&quot;RF-B Legacy to HT40 Diff[%d] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwr_legacyhtdiff</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_TxPower</span><span class="p">,</span>
		<span class="s">&quot;TxPwrSafetyFlag = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwr_safetyflag</span><span class="p">);</span>

	<span class="cm">/* Read RF-indication and Tx Power gain</span>
<span class="cm">	 * index diff of legacy to HT OFDM rate. */</span>
	<span class="n">tempval</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_RFIND_POWERDIFF</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_txpowerdiff</span> <span class="o">=</span> <span class="n">tempval</span><span class="p">;</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">legacy_httxpowerdiff</span> <span class="o">=</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwr_legacyhtdiff</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_TxPower</span><span class="p">,</span>
		<span class="s">&quot;TxPowerDiff = %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_txpowerdiff</span><span class="p">);</span>

	<span class="cm">/* Get TSSI value for each path. */</span>
	<span class="n">usvalue</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_TSSI_A</span><span class="p">];</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_tssi</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">usvalue</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">usvalue</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_TSSI_B</span><span class="p">];</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_tssi</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">usvalue</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_TxPower</span><span class="p">,</span> <span class="s">&quot;TSSI_A = 0x%x, TSSI_B = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_tssi</span><span class="p">[</span><span class="n">RF90_PATH_A</span><span class="p">],</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_tssi</span><span class="p">[</span><span class="n">RF90_PATH_B</span><span class="p">]);</span>

	<span class="cm">/* Read antenna tx power offset of B/C/D to A  from EEPROM */</span>
	<span class="cm">/* and read ThermalMeter from EEPROM */</span>
	<span class="n">tempval</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_THERMALMETER</span><span class="p">];</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span> <span class="o">=</span> <span class="n">tempval</span><span class="p">;</span>
	<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_TxPower</span><span class="p">,</span>
		<span class="s">&quot;thermalmeter = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">);</span>

	<span class="cm">/* ThermalMeter, BIT(0)~3 for RFIC1, BIT(4)~7 for RFIC2 */</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">thermalmeter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">tssi_13dbm</span> <span class="o">=</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* Read CrystalCap from EEPROM */</span>
	<span class="n">tempval</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_CRYSTALCAP</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_crystalcap</span> <span class="o">=</span> <span class="n">tempval</span><span class="p">;</span>
	<span class="cm">/* CrystalCap, BIT(12)~15 */</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">crystalcap</span> <span class="o">=</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_crystalcap</span><span class="p">;</span>

	<span class="cm">/* Read IC Version &amp;&amp; Channel Plan */</span>
	<span class="cm">/* Version ID, Channel plan */</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_channelplan</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_CHANNELPLAN</span><span class="p">];</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">txpwr_fromeprom</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">RTPRINT</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">FINIT</span><span class="p">,</span> <span class="n">INIT_TxPower</span><span class="p">,</span>
		<span class="s">&quot;EEPROM ChannelPlan = 0x%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_channelplan</span><span class="p">);</span>

	<span class="cm">/* Read Customer ID or Board Type!!! */</span>
	<span class="n">tempval</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_BOARDTYPE</span><span class="p">];</span>
	<span class="cm">/* Change RF type definition */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tempval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">=</span> <span class="n">RF_2T2R</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tempval</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">=</span> <span class="n">RF_1T2R</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tempval</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">=</span> <span class="n">RF_1T2R</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tempval</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">=</span> <span class="n">RF_1T1R</span><span class="p">;</span>

	<span class="cm">/* 1T2R but 1SS (1x1 receive combining) */</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">b1x1_recvcombine</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T2R</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tempval</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tempval</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">b1x1_recvcombine</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;RF_TYPE=1T2R but only 1SS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">b1ss_support</span> <span class="o">=</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">b1x1_recvcombine</span><span class="p">;</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_oemid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hwinfo</span><span class="p">[</span><span class="n">EEPROM_CUSTOMID</span><span class="p">];</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;EEPROM Customer ID: 0x%2x&quot;</span><span class="p">,</span>
		 <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_oemid</span><span class="p">);</span>

	<span class="cm">/* set channel paln to world wide 13 */</span>
	<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">channel_plan</span> <span class="o">=</span> <span class="n">COUNTRY_CODE_WORLD_WIDE_13</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_read_eeprom_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span> <span class="o">=</span> <span class="n">rtl_efuse</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">tmp_u1b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tmp_u1b</span> <span class="o">=</span> <span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">EPROM_CMD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp_u1b</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;Boot from EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">epromtype</span> <span class="o">=</span> <span class="n">EEPROM_93C46</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;Boot from EFUSE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">epromtype</span> <span class="o">=</span> <span class="n">EEPROM_BOOT_EFUSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp_u1b</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;Autoload OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">autoload_failflag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">_rtl92se_read_adapter_info</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span> <span class="s">&quot;Autoload ERR!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">autoload_failflag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92se_update_hal_rate_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">ratr_value</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ratr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nmode</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ht_enable</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mimo_ps</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_OFF</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">shortgi_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp_ratr_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">curtxbw_40mhz</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">bw_40</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">curshortgi_40mhz</span> <span class="o">=</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">)</span> <span class="o">?</span>
				<span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">curshortgi_20mhz</span> <span class="o">=</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_20</span><span class="p">)</span> <span class="o">?</span>
				<span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">wireless_mode</span> <span class="n">wirelessmode</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_5G</span><span class="p">)</span>
		<span class="n">ratr_value</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ratr_value</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ratr_value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span> <span class="o">|</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wirelessmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WIRELESS_MODE_B</span>:
		<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x0000000D</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIRELESS_MODE_G</span>:
		<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x00000FF5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIRELESS_MODE_N_24G</span>:
	<span class="k">case</span> <span class="n">WIRELESS_MODE_N_5G</span>:
		<span class="n">nmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mimo_ps</span> <span class="o">==</span> <span class="n">IEEE80211_SMPS_STATIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x0007F005</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">ratr_mask</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">get_rf_type</span><span class="p">(</span><span class="n">rtlphy</span><span class="p">)</span> <span class="o">==</span> <span class="n">RF_1T2R</span> <span class="o">||</span>
			    <span class="n">get_rf_type</span><span class="p">(</span><span class="n">rtlphy</span><span class="p">)</span> <span class="o">==</span> <span class="n">RF_1T1R</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">curtxbw_40mhz</span><span class="p">)</span>
					<span class="n">ratr_mask</span> <span class="o">=</span> <span class="mh">0x000ff015</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ratr_mask</span> <span class="o">=</span> <span class="mh">0x000ff005</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">curtxbw_40mhz</span><span class="p">)</span>
					<span class="n">ratr_mask</span> <span class="o">=</span> <span class="mh">0x0f0ff015</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ratr_mask</span> <span class="o">=</span> <span class="mh">0x0f0ff005</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="n">ratr_mask</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T2R</span><span class="p">)</span>
			<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x000ff0ff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x0f0ff0ff</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">VERSION_8192S_BCUT</span><span class="p">)</span>
		<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x0FFFFFFF</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">VERSION_8192S_ACUT</span><span class="p">)</span>
		<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x0FFFFFF0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nmode</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">curtxbw_40mhz</span> <span class="o">&amp;&amp;</span>
			 <span class="n">curshortgi_40mhz</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">curtxbw_40mhz</span> <span class="o">&amp;&amp;</span>
						 <span class="n">curshortgi_20mhz</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">ratr_value</span> <span class="o">|=</span> <span class="mh">0x10000000</span><span class="p">;</span>
		<span class="n">tmp_ratr_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">ratr_value</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">shortgi_rate</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">shortgi_rate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">shortgi_rate</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shortgi_rate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tmp_ratr_value</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">shortgi_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">shortgi_rate</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">shortgi_rate</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">shortgi_rate</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">shortgi_rate</span><span class="p">);</span>

		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SG_RATE</span><span class="p">,</span> <span class="n">shortgi_rate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">ARFR0</span> <span class="o">+</span> <span class="n">ratr_index</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ratr_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ratr_value</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">)</span>
		<span class="n">rtl92s_phy_set_fw_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">FW_CMD_RA_REFRESH_N</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rtl92s_phy_set_fw_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">FW_CMD_RA_REFRESH_BG</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RATR</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rtl_read_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">ARFR0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92se_update_hal_rate_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">rssi_level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_sta_info</span> <span class="o">*</span><span class="n">sta_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ratr_bitmap</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ratr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">curtxbw_40mhz</span> <span class="o">=</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SUP_WIDTH_20_40</span><span class="p">)</span>
				<span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">curshortgi_40mhz</span> <span class="o">=</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">)</span> <span class="o">?</span>
				<span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">curshortgi_20mhz</span> <span class="o">=</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_20</span><span class="p">)</span> <span class="o">?</span>
				<span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">wireless_mode</span> <span class="n">wirelessmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">shortgi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ratr_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">shortgi_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bmulticast</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">macid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mimo_ps</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_OFF</span><span class="p">;</span>

	<span class="n">sta_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl_sta_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">wirelessmode</span> <span class="o">=</span> <span class="n">sta_entry</span><span class="o">-&gt;</span><span class="n">wireless_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="n">curtxbw_40mhz</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">bw_40</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="n">macid</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_5G</span><span class="p">)</span>
		<span class="n">ratr_bitmap</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ratr_bitmap</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ratr_bitmap</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span> <span class="o">|</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wirelessmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WIRELESS_MODE_B</span>:
		<span class="n">band</span> <span class="o">|=</span> <span class="n">WIRELESS_11B</span><span class="p">;</span>
		<span class="n">ratr_index</span> <span class="o">=</span> <span class="n">RATR_INX_WIRELESS_B</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ratr_bitmap</span> <span class="o">&amp;</span> <span class="mh">0x0000000c</span><span class="p">)</span>
			<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x0000000d</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x0000000f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIRELESS_MODE_G</span>:
		<span class="n">band</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WIRELESS_11G</span> <span class="o">|</span> <span class="n">WIRELESS_11B</span><span class="p">);</span>
		<span class="n">ratr_index</span> <span class="o">=</span> <span class="n">RATR_INX_WIRELESS_GB</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rssi_level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x00000f00</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi_level</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x00000ff0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x00000ff5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIRELESS_MODE_A</span>:
		<span class="n">band</span> <span class="o">|=</span> <span class="n">WIRELESS_11A</span><span class="p">;</span>
		<span class="n">ratr_index</span> <span class="o">=</span> <span class="n">RATR_INX_WIRELESS_A</span><span class="p">;</span>
		<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x00000ff0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIRELESS_MODE_N_24G</span>:
	<span class="k">case</span> <span class="n">WIRELESS_MODE_N_5G</span>:
		<span class="n">band</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WIRELESS_11N</span> <span class="o">|</span> <span class="n">WIRELESS_11G</span> <span class="o">|</span> <span class="n">WIRELESS_11B</span><span class="p">);</span>
		<span class="n">ratr_index</span> <span class="o">=</span> <span class="n">RATR_INX_WIRELESS_NGB</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mimo_ps</span> <span class="o">==</span> <span class="n">IEEE80211_SMPS_STATIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rssi_level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x00070000</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi_level</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x0007f000</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x0007f005</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T2R</span> <span class="o">||</span>
				<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T1R</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rssi_level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x000f0000</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi_level</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x000fc000</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi_level</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x000ff000</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">curtxbw_40mhz</span><span class="p">)</span>
						<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x000ff015</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x000ff005</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rssi_level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x0f8f0000</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi_level</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x0f8fc000</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi_level</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x0f8ff000</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">curtxbw_40mhz</span><span class="p">)</span>
						<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x0f8ff015</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x0f8ff005</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">curtxbw_40mhz</span> <span class="o">&amp;&amp;</span> <span class="n">curshortgi_40mhz</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">curtxbw_40mhz</span> <span class="o">&amp;&amp;</span> <span class="n">curshortgi_20mhz</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">macid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">shortgi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">macid</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">shortgi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">band</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WIRELESS_11N</span> <span class="o">|</span> <span class="n">WIRELESS_11G</span> <span class="o">|</span> <span class="n">WIRELESS_11B</span><span class="p">);</span>
		<span class="n">ratr_index</span> <span class="o">=</span> <span class="n">RATR_INX_WIRELESS_NGB</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T2R</span><span class="p">)</span>
			<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x000ff0ff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x0f8ff0ff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">VERSION_8192S_BCUT</span><span class="p">)</span>
		<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x0FFFFFFF</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">VERSION_8192S_ACUT</span><span class="p">)</span>
		<span class="n">ratr_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0x0FFFFFF0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shortgi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ratr_bitmap</span> <span class="o">|=</span> <span class="mh">0x10000000</span><span class="p">;</span>
		<span class="cm">/* Get MAX MCS available. */</span>
		<span class="n">ratr_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">ratr_bitmap</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">shortgi_rate</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">shortgi_rate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">shortgi_rate</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shortgi_rate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ratr_value</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">shortgi_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">shortgi_rate</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">shortgi_rate</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">shortgi_rate</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">shortgi_rate</span><span class="p">);</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">SG_RATE</span><span class="p">,</span> <span class="n">shortgi_rate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bmulticast</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span> <span class="o">|</span> <span class="p">(</span><span class="n">macid</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="p">(</span><span class="n">band</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RATR</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;mask = %x, bitmap = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">mask</span><span class="p">,</span> <span class="n">ratr_bitmap</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x2c4</span><span class="p">,</span> <span class="n">ratr_bitmap</span><span class="p">);</span>
	<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">WFM5</span><span class="p">,</span> <span class="p">(</span><span class="n">FW_RA_UPDATE_MASK</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">macid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sta_entry</span><span class="o">-&gt;</span><span class="n">ratr_index</span> <span class="o">=</span> <span class="n">ratr_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_update_hal_rate_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rssi_level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">useramask</span><span class="p">)</span>
		<span class="n">rtl92se_update_hal_rate_mask</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">rssi_level</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rtl92se_update_hal_rate_table</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_update_channel_access_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u16</span> <span class="n">sifs_timer</span><span class="p">;</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_SLOT_TIME</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">slot_time</span><span class="p">);</span>
	<span class="n">sifs_timer</span> <span class="o">=</span> <span class="mh">0x0e0e</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_SIFS</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sifs_timer</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* this ifunction is for RFKILL, it&#39;s different with windows,</span>
<span class="cm"> * because UI will disable wireless when GPIO Radio Off.</span>
<span class="cm"> * And here we not check or Disable/Enable ASPM like windows*/</span>
<span class="n">bool</span> <span class="nf">rtl92se_gpio_radio_on_off_checking</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">valid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">enum</span> <span class="n">rf_pwrstate</span> <span class="n">rfpwr_toset</span> <span class="cm">/*, cur_rfstate */</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">actuallyset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">turnonbypowerdomain</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* just 8191se can check gpio before firstup, 92c/92d have fixed it */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">up_first_time</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">being_init_adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">swrf_processing</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfchange_inprogress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfchange_inprogress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* cur_rfstate = ppsc-&gt;rfpwr_state;*/</span>

	<span class="cm">/* because after _rtl92s_phy_set_rfhalt, all power</span>
<span class="cm">	 * closed, so we must open some power for GPIO check,</span>
<span class="cm">	 * or we will always check GPIO RFOFF here,</span>
<span class="cm">	 * And we should close power after GPIO check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RT_IN_PS_LEVEL</span><span class="p">(</span><span class="n">ppsc</span><span class="p">,</span> <span class="n">RT_RF_OFF_LEVL_HALT_NIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_rtl92se_power_domain_init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">turnonbypowerdomain</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rfpwr_toset</span> <span class="o">=</span> <span class="n">_rtl92se_rf_onoff_detect</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">hwradiooff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rfpwr_toset</span> <span class="o">==</span> <span class="n">ERFON</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
			 <span class="s">&quot;RFKILL-HW Radio ON, RF ON</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">rfpwr_toset</span> <span class="o">=</span> <span class="n">ERFON</span><span class="p">;</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">hwradiooff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">actuallyset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">hwradiooff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rfpwr_toset</span> <span class="o">==</span> <span class="n">ERFOFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_RF</span><span class="p">,</span>
			 <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;RFKILL-HW Radio OFF, RF OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">rfpwr_toset</span> <span class="o">=</span> <span class="n">ERFOFF</span><span class="p">;</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">hwradiooff</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">actuallyset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">actuallyset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfchange_inprogress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>

	<span class="cm">/* this not include ifconfig wlan0 down case */</span>
	<span class="cm">/* } else if (rfpwr_toset == ERFOFF || cur_rfstate == ERFOFF) { */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* because power_domain_init may be happen when</span>
<span class="cm">		 * _rtl92s_phy_set_rfhalt, this will open some powers</span>
<span class="cm">		 * and cause current increasing about 40 mA for ips,</span>
<span class="cm">		 * rfoff and ifconfig down, so we set</span>
<span class="cm">		 * _rtl92s_phy_set_rfhalt again here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">&amp;</span> <span class="n">RT_RF_OFF_LEVL_HALT_NIC</span> <span class="o">&amp;&amp;</span>
			<span class="n">turnonbypowerdomain</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_rtl92s_phy_set_rfhalt</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">RT_SET_PS_LEVEL</span><span class="p">(</span><span class="n">ppsc</span><span class="p">,</span> <span class="n">RT_RF_OFF_LEVL_HALT_NIC</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfchange_inprogress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">hwradiooff</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* Is_wepkey just used for WEP used as group &amp; pairwise key</span>
<span class="cm"> * if pairwise is AES ang group is WEP Is_wepkey == false.*/</span>
<span class="kt">void</span> <span class="nf">rtl92se_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">p_macaddr</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">is_group</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enc_algo</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_wepkey</span><span class="p">,</span> <span class="n">bool</span> <span class="n">clear_all</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span> <span class="o">=</span> <span class="n">rtl_efuse</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">macaddr</span> <span class="o">=</span> <span class="n">p_macaddr</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">entry_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_pairwise</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">static</span> <span class="n">u8</span> <span class="n">cam_const_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">cam_const_broad</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear_all</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">cam_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">clear_number</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;clear_all</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">clear_number</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl_cam_mark_invalid</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cam_offset</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">rtl_cam_empty_entry</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cam_offset</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_buf</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">MAX_KEY_LEN</span><span class="p">);</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_len</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">enc_algo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WEP40_ENCRYPTION</span>:
			<span class="n">enc_algo</span> <span class="o">=</span> <span class="n">CAM_WEP40</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WEP104_ENCRYPTION</span>:
			<span class="n">enc_algo</span> <span class="o">=</span> <span class="n">CAM_WEP104</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TKIP_ENCRYPTION</span>:
			<span class="n">enc_algo</span> <span class="o">=</span> <span class="n">CAM_TKIP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AESCCMP_ENCRYPTION</span>:
			<span class="n">enc_algo</span> <span class="o">=</span> <span class="n">CAM_AES</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
				 <span class="s">&quot;switch case not processed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">enc_algo</span> <span class="o">=</span> <span class="n">CAM_TKIP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_wepkey</span> <span class="o">||</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">use_defaultkey</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">macaddr</span> <span class="o">=</span> <span class="n">cam_const_addr</span><span class="p">[</span><span class="n">key_index</span><span class="p">];</span>
			<span class="n">entry_id</span> <span class="o">=</span> <span class="n">key_index</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_group</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">macaddr</span> <span class="o">=</span> <span class="n">cam_const_broad</span><span class="p">;</span>
				<span class="n">entry_id</span> <span class="o">=</span> <span class="n">key_index</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">entry_id</span> <span class="o">=</span> <span class="n">rtl_cam_get_free_entry</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
								 <span class="n">p_macaddr</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">entry_id</span> <span class="o">&gt;=</span>  <span class="n">TOTAL_CAM_ENTRY</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span>
							 <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
							 <span class="s">&quot;Can not find free hw security cam entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">return</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">entry_id</span> <span class="o">=</span> <span class="n">CAM_PAIRWISE_KEY_POSITION</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">key_index</span> <span class="o">=</span> <span class="n">PAIRWISE_KEYIDX</span><span class="p">;</span>
				<span class="n">is_pairwise</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_len</span><span class="p">[</span><span class="n">key_index</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;delete one entry, entry_id is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">entry_id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
				<span class="n">rtl_cam_del_entry</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">p_macaddr</span><span class="p">);</span>
			<span class="n">rtl_cam_delete_one_entry</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">p_macaddr</span><span class="p">,</span> <span class="n">entry_id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;The insert KEY length is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_len</span><span class="p">[</span><span class="n">PAIRWISE_KEYIDX</span><span class="p">]);</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;The insert KEY is %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;add one entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_pairwise</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RT_PRINT_DATA</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					      <span class="s">&quot;Pairwise Key content&quot;</span><span class="p">,</span>
					      <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">pairwise_key</span><span class="p">,</span>
					      <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span>
					      <span class="n">key_len</span><span class="p">[</span><span class="n">PAIRWISE_KEYIDX</span><span class="p">]);</span>

				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
					 <span class="s">&quot;set Pairwise key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="n">rtl_cam_add_one_entry</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">macaddr</span><span class="p">,</span> <span class="n">key_index</span><span class="p">,</span>
					<span class="n">entry_id</span><span class="p">,</span> <span class="n">enc_algo</span><span class="p">,</span>
					<span class="n">CAM_CONFIG_NO_USEDK</span><span class="p">,</span>
					<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_buf</span><span class="p">[</span><span class="n">key_index</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEC</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
					 <span class="s">&quot;set group key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rtl_cam_add_one_entry</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
						<span class="n">PAIRWISE_KEYIDX</span><span class="p">,</span>
						<span class="n">CAM_PAIRWISE_KEY_POSITION</span><span class="p">,</span>
						<span class="n">enc_algo</span><span class="p">,</span> <span class="n">CAM_CONFIG_NO_USEDK</span><span class="p">,</span>
						<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_buf</span><span class="p">[</span><span class="n">entry_id</span><span class="p">]);</span>
				<span class="p">}</span>

				<span class="n">rtl_cam_add_one_entry</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">macaddr</span><span class="p">,</span> <span class="n">key_index</span><span class="p">,</span>
					      <span class="n">entry_id</span><span class="p">,</span> <span class="n">enc_algo</span><span class="p">,</span>
					      <span class="n">CAM_CONFIG_NO_USEDK</span><span class="p">,</span>
					      <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">key_buf</span><span class="p">[</span><span class="n">entry_id</span><span class="p">]);</span>
			<span class="p">}</span>

		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">up_first_time</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92se_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff00ff</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
