<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › rtlwifi › pci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009-2012  Realtek Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * wlanfae &lt;wlanfae@realtek.com&gt;</span>
<span class="cm"> * Realtek Corporation, No. 2, Innovation Road II, Hsinchu Science Park,</span>
<span class="cm"> * Hsinchu 300, Taiwan.</span>
<span class="cm"> *</span>
<span class="cm"> * Larry Finger &lt;Larry.Finger@lwfinger.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#include &quot;wifi.h&quot;</span>
<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;pci.h&quot;</span>
<span class="cp">#include &quot;base.h&quot;</span>
<span class="cp">#include &quot;ps.h&quot;</span>
<span class="cp">#include &quot;efuse.h&quot;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/kmemleak.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">pcibridge_vendors</span><span class="p">[</span><span class="n">PCI_BRIDGE_VENDOR_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
	<span class="n">PCI_VENDOR_ID_ATI</span><span class="p">,</span>
	<span class="n">PCI_VENDOR_ID_AMD</span><span class="p">,</span>
	<span class="n">PCI_VENDOR_ID_SI</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ac_to_hwq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">VO_QUEUE</span><span class="p">,</span>
	<span class="n">VI_QUEUE</span><span class="p">,</span>
	<span class="n">BE_QUEUE</span><span class="p">,</span>
	<span class="n">BK_QUEUE</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">_rtl_mac_to_hwqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">__le16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">rtl_get_fc</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">queue_index</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">fc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">BEACON_QUEUE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">MGNT_QUEUE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">hw_type</span> <span class="o">==</span> <span class="n">HARDWARE_TYPE_RTL8192SE</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_nullfunc</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">HIGH_QUEUE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ac_to_hwq</span><span class="p">[</span><span class="n">queue_index</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* Update PCI dependent default settings*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_pci_update_default_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">pcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">pcibridge_vendor</span> <span class="o">=</span> <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_vendor</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">init_aspm</span><span class="p">;</span>

	<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">support_aspm</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*Update PCI ASPM setting */</span>
	<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">const_amdpci_aspm</span> <span class="o">=</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">const_amdpci_aspm</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">const_pci_aspm</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/*No ASPM */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/*ASPM dynamically enabled/disable. */</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">|=</span> <span class="n">RT_RF_LPS_LEVEL_ASPM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/*ASPM with Clock Req dynamically enabled/disable. */</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RT_RF_LPS_LEVEL_ASPM</span> <span class="o">|</span>
					 <span class="n">RT_RF_OFF_LEVL_CLK_REQ</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Always enable ASPM and Clock Req</span>
<span class="cm">		 * from initialization to halt.</span>
<span class="cm">		 * */</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RT_RF_LPS_LEVEL_ASPM</span><span class="p">);</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RT_RF_PS_LEVEL_ALWAYS_ASPM</span> <span class="o">|</span>
					 <span class="n">RT_RF_OFF_LEVL_CLK_REQ</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Always enable ASPM without Clock Req</span>
<span class="cm">		 * from initialization to halt.</span>
<span class="cm">		 * */</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RT_RF_LPS_LEVEL_ASPM</span> <span class="o">|</span>
					  <span class="n">RT_RF_OFF_LEVL_CLK_REQ</span><span class="p">);</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">|=</span> <span class="n">RT_RF_PS_LEVEL_ALWAYS_ASPM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">|=</span> <span class="n">RT_RF_OFF_LEVL_HALT_NIC</span><span class="p">;</span>

	<span class="cm">/*Update Radio OFF setting */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">const_hwsw_rfoff_d3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">&amp;</span> <span class="n">RT_RF_LPS_LEVEL_ASPM</span><span class="p">)</span>
			<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">|=</span> <span class="n">RT_RF_OFF_LEVL_ASPM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">&amp;</span> <span class="n">RT_RF_LPS_LEVEL_ASPM</span><span class="p">)</span>
			<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">|=</span> <span class="n">RT_RF_OFF_LEVL_ASPM</span><span class="p">;</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">|=</span> <span class="n">RT_RF_OFF_LEVL_HALT_NIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">|=</span> <span class="n">RT_RF_OFF_LEVL_PCI_D3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*Set HW definition to determine if it supports ASPM. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">const_support_pciaspm</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:<span class="p">{</span>
			<span class="cm">/*Not support ASPM. */</span>
			<span class="n">bool</span> <span class="n">support_aspm</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">support_aspm</span> <span class="o">=</span> <span class="n">support_aspm</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="mi">1</span>:<span class="p">{</span>
			<span class="cm">/*Support ASPM. */</span>
			<span class="n">bool</span> <span class="n">support_aspm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">bool</span> <span class="n">support_backdoor</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">support_aspm</span> <span class="o">=</span> <span class="n">support_aspm</span><span class="p">;</span>

			<span class="cm">/*if (priv-&gt;oem_id == RT_CID_TOSHIBA &amp;&amp;</span>
<span class="cm">			   !priv-&gt;ndis_adapter.amd_l1_patch)</span>
<span class="cm">			   support_backdoor = false; */</span>

			<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">support_backdoor</span> <span class="o">=</span> <span class="n">support_backdoor</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/*ASPM value set by chipset. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcibridge_vendor</span> <span class="o">==</span> <span class="n">PCI_BRIDGE_VENDOR_INTEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bool</span> <span class="n">support_aspm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">support_aspm</span> <span class="o">=</span> <span class="n">support_aspm</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;switch case not processed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* toshiba aspm issue, toshiba will set aspm selfly</span>
<span class="cm">	 * so we should not set aspm in driver */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_aspm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">hw_type</span> <span class="o">==</span> <span class="n">HARDWARE_TYPE_RTL8192SE</span> <span class="o">&amp;&amp;</span>
		<span class="n">init_aspm</span> <span class="o">==</span> <span class="mh">0x43</span><span class="p">)</span>
		<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">support_aspm</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_rtl_pci_platform_switch_device_pci_aspm</span><span class="p">(</span>
			<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">hw_type</span> <span class="o">!=</span> <span class="n">HARDWARE_TYPE_RTL8192SE</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*When we set 0x01 to enable clk request. Set 0x0 to disable clk req.*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_pci_switch_clk_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">hw_type</span> <span class="o">==</span> <span class="n">HARDWARE_TYPE_RTL8192SE</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*Disable RTL8192SE ASPM &amp; Disable Pci Bridge ASPM*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_pci_disable_aspm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">pcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">pcibridge_vendor</span> <span class="o">=</span> <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_vendor</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num4bytes</span> <span class="o">=</span> <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">num4bytes</span><span class="p">;</span>
	<span class="cm">/*Retrieve original configuration settings. */</span>
	<span class="n">u8</span> <span class="n">linkctrl_reg</span> <span class="o">=</span> <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">linkctrl_reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pcibridge_linkctrlreg</span> <span class="o">=</span> <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span>
				<span class="n">pcibridge_linkctrlreg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">aspmlevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp_u1b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">support_aspm</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcibridge_vendor</span> <span class="o">==</span> <span class="n">PCI_BRIDGE_VENDOR_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;PCI(Bridge) UNKNOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">&amp;</span> <span class="n">RT_RF_OFF_LEVL_CLK_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_CLEAR_PS_LEVEL</span><span class="p">(</span><span class="n">ppsc</span><span class="p">,</span> <span class="n">RT_RF_OFF_LEVL_CLK_REQ</span><span class="p">);</span>
		<span class="n">_rtl_pci_switch_clk_req</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*for promising device will in L0 state after an I/O. */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_u1b</span><span class="p">);</span>

	<span class="cm">/*Set corresponding value. */</span>
	<span class="n">aspmlevel</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">linkctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">aspmlevel</span><span class="p">;</span>
	<span class="n">pcibridge_linkctrlreg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

	<span class="n">_rtl_pci_platform_switch_device_pci_aspm</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">linkctrl_reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/*4 Disable Pci Bridge ASPM */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">num4bytes</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			      <span class="n">pcibridge_linkctrlreg</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *Enable RTL8192SE ASPM &amp; Enable Pci Bridge ASPM for</span>
<span class="cm"> *power saving We should follow the sequence to enable</span>
<span class="cm"> *RTL8192SE first then enable Pci Bridge ASPM</span>
<span class="cm"> *or the system will show bluescreen.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_pci_enable_aspm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">pcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">pcibridge_busnum</span> <span class="o">=</span> <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_busnum</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pcibridge_devnum</span> <span class="o">=</span> <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_devnum</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pcibridge_funcnum</span> <span class="o">=</span> <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_funcnum</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pcibridge_vendor</span> <span class="o">=</span> <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_vendor</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num4bytes</span> <span class="o">=</span> <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">num4bytes</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">aspmlevel</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">u_pcibridge_aspmsetting</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">u_device_aspmsetting</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">support_aspm</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcibridge_vendor</span> <span class="o">==</span> <span class="n">PCI_BRIDGE_VENDOR_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;PCI(Bridge) UNKNOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*4 Enable Pci Bridge ASPM */</span>

	<span class="n">u_pcibridge_aspmsetting</span> <span class="o">=</span>
	    <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_linkctrlreg</span> <span class="o">|</span>
	    <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">const_hostpci_aspm_setting</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcibridge_vendor</span> <span class="o">==</span> <span class="n">PCI_BRIDGE_VENDOR_INTEL</span><span class="p">)</span>
		<span class="n">u_pcibridge_aspmsetting</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">num4bytes</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			      <span class="n">u_pcibridge_aspmsetting</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;PlatformEnableASPM():PciBridge busnumber[%x], DevNumbe[%x], funcnumber[%x], Write reg[%x] = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pcibridge_busnum</span><span class="p">,</span> <span class="n">pcibridge_devnum</span><span class="p">,</span> <span class="n">pcibridge_funcnum</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_pciehdr_offset</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">),</span>
		 <span class="n">u_pcibridge_aspmsetting</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/*Get ASPM level (with/without Clock Req) */</span>
	<span class="n">aspmlevel</span> <span class="o">=</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">const_devicepci_aspm_setting</span><span class="p">;</span>
	<span class="n">u_device_aspmsetting</span> <span class="o">=</span> <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">linkctrl_reg</span><span class="p">;</span>

	<span class="cm">/*_rtl_pci_platform_switch_device_pci_aspm(dev,*/</span>
	<span class="cm">/*(priv-&gt;ndis_adapter.linkctrl_reg | ASPMLevel)); */</span>

	<span class="n">u_device_aspmsetting</span> <span class="o">|=</span> <span class="n">aspmlevel</span><span class="p">;</span>

	<span class="n">_rtl_pci_platform_switch_device_pci_aspm</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">u_device_aspmsetting</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">&amp;</span> <span class="n">RT_RF_OFF_LEVL_CLK_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_rtl_pci_switch_clk_req</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">&amp;</span>
					     <span class="n">RT_RF_OFF_LEVL_CLK_REQ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">RT_SET_PS_LEVEL</span><span class="p">(</span><span class="n">ppsc</span><span class="p">,</span> <span class="n">RT_RF_OFF_LEVL_CLK_REQ</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rtl_pci_get_amd_l1_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">bool</span> <span class="n">status</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">offset_e0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset_e4</span><span class="p">;</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset_e0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset_e0</span> <span class="o">==</span> <span class="mh">0xA0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset_e4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset_e4</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">23</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_pci_get_linkcontrol_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">pcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">pcipriv</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">capabilityoffset</span> <span class="o">=</span> <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_pciehdr_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">linkctrl_reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num4bbytes</span><span class="p">;</span>

	<span class="n">num4bbytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">capabilityoffset</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/*Read  Link Control Register */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">num4bbytes</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">linkctrl_reg</span><span class="p">);</span>

	<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_linkctrlreg</span> <span class="o">=</span> <span class="n">linkctrl_reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_pci_parse_configuration</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">pcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">linkctrl_reg</span><span class="p">;</span>

	<span class="cm">/*Link Control Register */</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linkctrl_reg</span><span class="p">);</span>
	<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">linkctrl_reg</span> <span class="o">=</span> <span class="n">linkctrl_reg</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;Link Control Register =%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">linkctrl_reg</span><span class="p">);</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x17</span><span class="p">;</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x70f</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_pci_init_aspm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">_rtl_pci_update_default_setting</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">reg_rfps_level</span> <span class="o">&amp;</span> <span class="n">RT_RF_PS_LEVEL_ALWAYS_ASPM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*Always enable ASPM &amp; Clock Req. */</span>
		<span class="n">rtl_pci_enable_aspm</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">RT_SET_PS_LEVEL</span><span class="p">(</span><span class="n">ppsc</span><span class="p">,</span> <span class="n">RT_RF_PS_LEVEL_ALWAYS_ASPM</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_pci_io_handler_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">write8_async</span> <span class="o">=</span> <span class="n">pci_write8_async</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">write16_async</span> <span class="o">=</span> <span class="n">pci_write16_async</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">write32_async</span> <span class="o">=</span> <span class="n">pci_write32_async</span><span class="p">;</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">read8_sync</span> <span class="o">=</span> <span class="n">pci_read8_sync</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">read16_sync</span> <span class="o">=</span> <span class="n">pci_read16_sync</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">read32_sync</span> <span class="o">=</span> <span class="n">pci_read32_sync</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_pci_io_handler_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_rtl_update_earlymode_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl_tcb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">additionlen</span> <span class="o">=</span> <span class="n">FCS_LEN</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">next_skb</span><span class="p">;</span>

	<span class="cm">/* here open is 4, wep/tkip is 8, aes is 12*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="p">)</span>
		<span class="n">additionlen</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">icv_len</span><span class="p">;</span>

	<span class="cm">/* The most skb num is 6 */</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">empkt_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">waitq_lock</span><span class="p">);</span>
	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">skb_waitq</span><span class="p">[</span><span class="n">tid</span><span class="p">],</span> <span class="n">next_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">next_info</span><span class="p">;</span>

		<span class="n">next_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">next_skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">empkt_len</span><span class="p">[</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">empkt_num</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">next_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">additionlen</span><span class="p">;</span>
			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">empkt_num</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">skb_waitq</span><span class="p">[</span><span class="n">tid</span><span class="p">],</span>
				      <span class="n">next_skb</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">empkt_num</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">waitq_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* just for early mode now */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_pci_tx_chk_waitq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">earlymode_enable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* we juse use em for BE/BK/VI/VO */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tid</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">tid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tid</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">hw_queue</span> <span class="o">=</span> <span class="n">ac_to_hwq</span><span class="p">[</span><span class="n">rtl_tid_to_ac</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tid</span><span class="p">)];</span>
		<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">hw_queue</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">act_scanning</span> <span class="o">&amp;&amp;</span>
		       <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">rfpwr_state</span> <span class="o">==</span> <span class="n">ERFON</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rtl_tcb_desc</span> <span class="n">tcb_desc</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcb_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl_tcb_desc</span><span class="p">));</span>

			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">waitq_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">skb_waitq</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">-</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">skb_waitq</span><span class="p">[</span><span class="n">tid</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">waitq_lock</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">waitq_lock</span><span class="p">);</span>

			<span class="cm">/* Some macaddr can&#39;t do early mode. like</span>
<span class="cm">			 * multicast/broadcast/no_qos data */</span>
			<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span>
				<span class="n">_rtl_update_earlymode_info</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">tcb_desc</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">intf_ops</span><span class="o">-&gt;</span><span class="n">adapter_tx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcb_desc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_pci_tx_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtl_tx_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">tid</span><span class="p">;</span>

		<span class="n">u8</span> <span class="n">own</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
							  <span class="n">HW_DESC_OWN</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 *beacon packet will only use the first</span>
<span class="cm">		 *descriptor defautly,and the own may not</span>
<span class="cm">		 *be cleared by the hardware</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">own</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span>
					     <span class="n">get_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
						      <span class="n">HW_DESC_TXBUFF_ADDR</span><span class="p">),</span>
				 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

		<span class="cm">/* remove early mode header */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">earlymode_enable</span><span class="p">)</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">EM_HDR_LEN</span><span class="p">);</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="p">(</span><span class="n">COMP_INTR</span> <span class="o">|</span> <span class="n">COMP_SEND</span><span class="p">),</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;new ring-&gt;idx:%d, free: skb_queue_len:%d, free: seq:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span>
			 <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">),</span>
			 <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">22</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prio</span> <span class="o">==</span> <span class="n">TXCMD_QUEUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">tx_status_ok</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="cm">/* for sw LPS, just after NULL skb send out, we can</span>
<span class="cm">		 * sure AP kown we are sleeped, our we should not let</span>
<span class="cm">		 * rf to sleep*/</span>
		<span class="n">fc</span> <span class="o">=</span> <span class="n">rtl_get_fc</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_nullfunc</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_pm</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">offchan_delay</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">state_inap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">state_inap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* update tid tx pkt num */</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">rtl_get_tid</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">tidtx_inperiod</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">ieee80211_tx_info_clear_status</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>
		<span class="cm">/*info-&gt;status.rates[0].count = 1; */</span>

		<span class="n">ieee80211_tx_status_irqsafe</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">-</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
				<span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;more desc left, wake skb_queue@%d, ring-&gt;idx = %d, skb_queue_len = 0x%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">prio</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span>
				 <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>

			<span class="n">ieee80211_wake_queue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					<span class="n">skb_get_queue_mapping</span>
					<span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="p">}</span>
<span class="nl">tx_status_ok:</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">num_rx_inperiod</span> <span class="o">+</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">num_tx_inperiod</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">num_rx_inperiod</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">lps_leave_work</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_receive_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="n">rx_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">rtl_get_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">__le16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">rtl_get_fc</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">unicast</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">uskb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>


	<span class="n">memcpy</span><span class="p">(</span><span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rx_status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_status</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
		<span class="p">;</span><span class="cm">/*TODO*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
		<span class="p">;</span><span class="cm">/*TODO*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">unicast</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxbytesunicast</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtl_is_special_data</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">led_control</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">LED_CTL_RX</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unicast</span><span class="p">)</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">num_rx_inperiod</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for sw lps */</span>
	<span class="n">rtl_swlps_beacon</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rtl_recognize_peer</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_2_4G</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">||</span> <span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">fc</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">rtl_action_proc</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">uskb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uskb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* exit if allocation failed */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">uskb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rx_status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_status</span><span class="p">));</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">uskb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pdata</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">ieee80211_rx_irqsafe</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">uskb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_pci_rx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">rx_queue_idx</span> <span class="o">=</span> <span class="n">RTL_PCI_RX_MPDU_QUEUE</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="n">rx_status</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">own</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp_one</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bufferaddress</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rtl_stats</span> <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="o">-</span><span class="mi">98</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>

	<span class="cm">/*RX NORMAL PKT */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*rx descriptor */</span>
		<span class="k">struct</span> <span class="n">rtl_rx_desc</span> <span class="o">*</span><span class="n">pdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">desc</span><span class="p">[</span>
				<span class="n">index</span><span class="p">];</span>
		<span class="cm">/*rx pkt */</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">rx_buf</span><span class="p">[</span>
				<span class="n">index</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">own</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pdesc</span><span class="p">,</span>
						       <span class="nb">false</span><span class="p">,</span> <span class="n">HW_DESC_OWN</span><span class="p">);</span>

		<span class="cm">/*wait data to be filled by hardware */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">own</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">query_rx_desc</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">rx_status</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pdesc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">crc</span> <span class="o">||</span> <span class="n">stats</span><span class="p">.</span><span class="n">hwerror</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="n">new_skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">new_skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="p">(</span><span class="n">COMP_INTR</span> <span class="o">|</span> <span class="n">COMP_RECV</span><span class="p">),</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;can&#39;t alloc skb for rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="o">*</span><span class="p">((</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">),</span>
				 <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">,</span>
				 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pdesc</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
			<span class="n">HW_DESC_RXPKT_LEN</span><span class="p">));</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_drvinfo_size</span> <span class="o">+</span> <span class="n">stats</span><span class="p">.</span><span class="n">rx_bufshift</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * NOTICE This can not be use for mac80211,</span>
<span class="cm">		 * this is done in mac80211 code,</span>
<span class="cm">		 * if you done here sec DHCP will fail</span>
<span class="cm">		 * skb_trim(skb, skb-&gt;len - 4);</span>
<span class="cm">		 */</span>

		<span class="n">_rtl_receive_one</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">num_rx_inperiod</span> <span class="o">+</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">num_tx_inperiod</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">num_rx_inperiod</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">lps_leave_work</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>

		<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">rx_buf</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="o">*</span><span class="p">((</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span> <span class="o">=</span>
			    <span class="n">pci_map_single</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
					   <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">,</span>
					   <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

<span class="nl">done:</span>
		<span class="n">bufferaddress</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
		<span class="n">tmp_one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pdesc</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
					    <span class="n">HW_DESC_RXBUFF_ADDR</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bufferaddress</span><span class="p">);</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pdesc</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
					    <span class="n">HW_DESC_RXPKT_LEN</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxringcount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pdesc</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
						    <span class="n">HW_DESC_RXERO</span><span class="p">,</span>
						    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp_one</span><span class="p">);</span>

		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pdesc</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">HW_DESC_RXOWN</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp_one</span><span class="p">);</span>

		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">_rtl_pci_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*read ISR: 4/8bytes */</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">interrupt_recognized</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intb</span><span class="p">);</span>

	<span class="cm">/*Shared IRQ or HW disappared */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inta</span> <span class="o">||</span> <span class="n">inta</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*&lt;1&gt; beacon related */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_TBDOK</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INTR</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;beacon ok interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_TBDER</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INTR</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;beacon err interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_BDOK</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INTR</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;beacon interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_BcnInt</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INTR</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;prepare beacon for interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">irq_prepare_bcn_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*&lt;3&gt; Tx related */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_TXFOVW</span><span class="p">]))</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span> <span class="s">&quot;IMR_TXFOVW!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_MGNTDOK</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INTR</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;Manage ok interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">_rtl_pci_tx_isr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MGNT_QUEUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_HIGHDOK</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INTR</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;HIGH_QUEUE ok interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">_rtl_pci_tx_isr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HIGH_QUEUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_BKDOK</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">num_tx_inperiod</span><span class="o">++</span><span class="p">;</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INTR</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;BK Tx OK interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">_rtl_pci_tx_isr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BK_QUEUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_BEDOK</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">num_tx_inperiod</span><span class="o">++</span><span class="p">;</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INTR</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;BE TX OK interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">_rtl_pci_tx_isr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BE_QUEUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_VIDOK</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">num_tx_inperiod</span><span class="o">++</span><span class="p">;</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INTR</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;VI TX OK interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">_rtl_pci_tx_isr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">VI_QUEUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_VODOK</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">num_tx_inperiod</span><span class="o">++</span><span class="p">;</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INTR</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;Vo TX OK interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">_rtl_pci_tx_isr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">VO_QUEUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">hw_type</span> <span class="o">==</span> <span class="n">HARDWARE_TYPE_RTL8192SE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_COMDOK</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">num_tx_inperiod</span><span class="o">++</span><span class="p">;</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INTR</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
				 <span class="s">&quot;CMD TX OK interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">_rtl_pci_tx_isr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TXCMD_QUEUE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*&lt;2&gt; Rx related */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_ROK</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INTR</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;Rx ok interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">_rtl_pci_rx_interrupt</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_RDU</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span>
			 <span class="s">&quot;rx descriptor unavailable!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">_rtl_pci_rx_interrupt</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">[</span><span class="n">RTL_IMR_RXFOVW</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span> <span class="s">&quot;rx overflow !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">_rtl_pci_rx_interrupt</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">earlymode_enable</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">irq_tasklet</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_pci_irq_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_rtl_pci_tx_chk_waitq</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_pci_prepare_bcn_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pskb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_tx_desc</span> <span class="o">*</span><span class="n">pdesc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_tcb_desc</span> <span class="n">tcb_desc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">temp_one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcb_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl_tcb_desc</span><span class="p">));</span>
	<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">BEACON_QUEUE</span><span class="p">];</span>
	<span class="n">pskb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtl_tx_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_desc</span><span class="p">(</span>
				 <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">HW_DESC_TXBUFF_ADDR</span><span class="p">),</span>
				 <span class="n">pskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">pskb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*NB: the beacon data buffer must be 32-bit aligned. */</span>
	<span class="n">pskb</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pskb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="n">rtl_get_hdr</span><span class="p">(</span><span class="n">pskb</span><span class="p">);</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">pskb</span><span class="p">);</span>
	<span class="n">pdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fill_tx_desc</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pdesc</span><span class="p">,</span>
		<span class="n">info</span><span class="p">,</span> <span class="n">pskb</span><span class="p">,</span> <span class="n">BEACON_QUEUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcb_desc</span><span class="p">);</span>

	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">pskb</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pdesc</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">HW_DESC_OWN</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp_one</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_lps_leave_work_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_works</span> <span class="o">*</span><span class="n">rtlworks</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl_works</span><span class="p">,</span> <span class="n">lps_leave_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">rtlworks</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">rtl_lps_leave</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_pci_init_trx_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RTL_PCI_MAX_TX_QUEUE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">RT_TXDESC_NUM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *we just alloc 2 desc for beacon queue,</span>
<span class="cm">	 *because we just need first desc in hw beacon.</span>
<span class="cm">	 */</span>
	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">[</span><span class="n">BEACON_QUEUE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *BE queue need more descriptor for performance</span>
<span class="cm">	 *consideration or, No more tx desc will happen,</span>
<span class="cm">	 *and may cause mac80211 mem leakage.</span>
<span class="cm">	 */</span>
	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">[</span><span class="n">BE_QUEUE</span><span class="p">]</span> <span class="o">=</span> <span class="n">RT_TXDESC_NUM_BE_QUEUE</span><span class="p">;</span>

	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span> <span class="o">=</span> <span class="mi">9100</span><span class="p">;</span>	<span class="cm">/*2048/1024; */</span>
	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxringcount</span> <span class="o">=</span> <span class="n">RTL_PCI_MAX_RX_COUNT</span><span class="p">;</span>	<span class="cm">/*64; */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_pci_init_struct</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">up_first_time</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">being_init_adapter</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/*Tx/Rx related var */</span>
	<span class="n">_rtl_pci_init_trx_var</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*IBSS*/</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/*AMPDU*/</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">min_space_cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">max_mss_density</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*set sane AMPDU defaults */</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">current_ampdu_density</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">current_ampdu_factor</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/*QOS*/</span>
	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">acm_method</span> <span class="o">=</span> <span class="n">eAcmWay2_SW</span><span class="p">;</span>

	<span class="cm">/*task */</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">irq_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">_rtl_pci_irq_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">irq_prepare_bcn_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">_rtl_pci_prepare_bcn_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">lps_leave_work</span><span class="p">,</span> <span class="n">rtl_lps_leave_work_callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_rtl_pci_init_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_tx_desc</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nextdescaddress</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ring</span><span class="p">)</span> <span class="o">*</span> <span class="n">entries</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span> <span class="o">||</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ring</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;Cannot allocate TX ring (prio = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prio</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ring</span><span class="p">)</span> <span class="o">*</span> <span class="n">entries</span><span class="p">);</span>
	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">].</span><span class="n">desc</span> <span class="o">=</span> <span class="n">ring</span><span class="p">;</span>
	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">].</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">].</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">].</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;queue:%d, ring_addr:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">prio</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nextdescaddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dma</span> <span class="o">+</span>
					      <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">entries</span><span class="p">)</span> <span class="o">*</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ring</span><span class="p">);</span>

		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
					    <span class="nb">true</span><span class="p">,</span> <span class="n">HW_DESC_TX_NEXTDESC_ADDR</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nextdescaddress</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_rtl_pci_init_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_rx_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rx_queue_idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp_one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *rx_queue_idx 0:RX_MPDU_QUEUE</span>
<span class="cm">	 *rx_queue_idx 1:RX_CMD_QUEUE</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rx_queue_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rx_queue_idx</span> <span class="o">&lt;</span> <span class="n">RTL_PCI_MAX_RX_QUEUE</span><span class="p">;</span>
	     <span class="n">rx_queue_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">desc</span> <span class="o">=</span>
		    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span>
						<span class="n">desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">desc</span> <span class="o">||</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">desc</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
				 <span class="s">&quot;Cannot allocate RX ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">desc</span><span class="p">)</span> <span class="o">*</span>
		       <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">);</span>

		<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* If amsdu_8k is disabled, set buffersize to 4096. This</span>
<span class="cm">		 * change will reduce memory fragmentation.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span> <span class="o">&gt;</span> <span class="mi">4096</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">disable_amsdu_8k</span><span class="p">)</span>
			<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span>
			    <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">bufferaddress</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">kmemleak_not_leak</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="cm">/*skb-&gt;dev = dev; */</span>

			<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">rx_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 *just set skb-&gt;cb to mapping addr</span>
<span class="cm">			 *for pci_unmap_single use</span>
<span class="cm">			 */</span>
			<span class="o">*</span><span class="p">((</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span> <span class="o">=</span>
			    <span class="n">pci_map_single</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
					   <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">,</span>
					   <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

			<span class="n">bufferaddress</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
						    <span class="n">HW_DESC_RXBUFF_ADDR</span><span class="p">,</span>
						    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bufferaddress</span><span class="p">);</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
						    <span class="n">HW_DESC_RXPKT_LEN</span><span class="p">,</span>
						    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span>
						    <span class="n">rxbuffersize</span><span class="p">);</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
						    <span class="n">HW_DESC_RXOWN</span><span class="p">,</span>
						    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp_one</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
					    <span class="n">HW_DESC_RXERO</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp_one</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_pci_free_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtl_tx_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span>
					     <span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
						   <span class="n">HW_DESC_TXBUFF_ADDR</span><span class="p">),</span>
				 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span>
				    <span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_rtl_pci_free_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rx_queue_idx</span><span class="p">;</span>

	<span class="cm">/*rx_queue_idx 0:RX_MPDU_QUEUE */</span>
	<span class="cm">/*rx_queue_idx 1:RX_CMD_QUEUE */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rx_queue_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rx_queue_idx</span> <span class="o">&lt;</span> <span class="n">RTL_PCI_MAX_RX_QUEUE</span><span class="p">;</span>
	     <span class="n">rx_queue_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span>
			    <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">rx_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="o">*</span><span class="p">((</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">),</span>
					 <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">,</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span>
					   <span class="n">desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">,</span>
				    <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
				    <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>
			<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_rtl_pci_init_trx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_rtl_pci_init_rx_ring</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RTL_PCI_MAX_TX_QUEUE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_rtl_pci_init_tx_ring</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				 <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_rings</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_rings:</span>
	<span class="n">_rtl_pci_free_rx_ring</span><span class="p">(</span><span class="n">rtlpci</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RTL_PCI_MAX_TX_QUEUE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">)</span>
			<span class="n">_rtl_pci_free_tx_ring</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_rtl_pci_deinit_trx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*free rx rings */</span>
	<span class="n">_rtl_pci_free_rx_ring</span><span class="p">(</span><span class="n">rtlpci</span><span class="p">);</span>

	<span class="cm">/*free tx rings */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RTL_PCI_MAX_TX_QUEUE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">_rtl_pci_free_tx_ring</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtl_pci_reset_trx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rx_queue_idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp_one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*rx_queue_idx 0:RX_MPDU_QUEUE */</span>
	<span class="cm">/*rx_queue_idx 1:RX_CMD_QUEUE */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rx_queue_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rx_queue_idx</span> <span class="o">&lt;</span> <span class="n">RTL_PCI_MAX_RX_QUEUE</span><span class="p">;</span>
	     <span class="n">rx_queue_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *force the rx_ring[RX_MPDU_QUEUE/</span>
<span class="cm">		 *RX_CMD_QUEUE].idx to the first one</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rtl_rx_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span>
							    <span class="nb">false</span><span class="p">,</span>
							    <span class="n">HW_DESC_RXOWN</span><span class="p">,</span>
							    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp_one</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *after reset, release previous pending packet,</span>
<span class="cm">	 *and force the  tx idx to the first one</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RTL_PCI_MAX_TX_QUEUE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">rtl_tx_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span>
				    <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span>
				    <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span>
							 <span class="n">get_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span>
							 <span class="n">entry</span><span class="p">,</span>
							 <span class="nb">true</span><span class="p">,</span>
							 <span class="n">HW_DESC_TXBUFF_ADDR</span><span class="p">),</span>
						 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rtl_pci_tx_chk_waitq_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_sta_info</span> <span class="o">*</span><span class="n">sta_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">rtl_get_tid</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">sta_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl_sta_info</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">earlymode_enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_entry</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">agg_state</span> <span class="o">!=</span> <span class="n">RTL_AGG_OPERATIONAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_rtl_mac_to_hwqueue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">VO_QUEUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* maybe every tid should be checked */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">link_info</span><span class="p">.</span><span class="n">higher_busytxtraffic</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">waitq_lock</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">skb_waitq</span><span class="p">[</span><span class="n">tid</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">waitq_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_pci_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rtl_tcb_desc</span> <span class="o">*</span><span class="n">ptcb_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_sta_info</span> <span class="o">*</span><span class="n">sta_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_tx_desc</span> <span class="o">*</span><span class="n">pdesc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hw_queue</span> <span class="o">=</span> <span class="n">_rtl_mac_to_hwqueue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">rtl_get_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">__le16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">rtl_get_fc</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pda_addr</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="cm">/*ssn */</span>
	<span class="n">u8</span> <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seq_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">own</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">temp_one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_auth</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_SEND</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;MAC80211_LINKING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtl_ips_nic_on</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">sw_ps_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ieee80211_is_nullfunc</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">ieee80211_has_pm</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_PM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtl_action_proc</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">pda_addr</span><span class="p">))</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytesmulticast</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">pda_addr</span><span class="p">))</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytesbroadcast</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytesunicast</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">hw_queue</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_queue</span> <span class="o">!=</span> <span class="n">BEACON_QUEUE</span><span class="p">)</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="o">%</span>
				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">own</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pdesc</span><span class="p">,</span>
			<span class="nb">true</span><span class="p">,</span> <span class="n">HW_DESC_OWN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">own</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw_queue</span> <span class="o">!=</span> <span class="n">BEACON_QUEUE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span>
			 <span class="s">&quot;No more TX desc@%d, ring-&gt;idx = %d, idx = %d, skb_queue_len = 0x%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">hw_queue</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
			 <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">rtl_get_tid</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sta_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl_sta_info</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
			<span class="n">seq_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
				      <span class="n">IEEE80211_SCTL_SEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">seq_number</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
				<span class="n">sta_entry</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">seq_number</span> <span class="o">=</span> <span class="n">seq_number</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">led_control</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">LED_CTL_TX</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fill_tx_desc</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pdesc</span><span class="p">,</span>
			<span class="n">info</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hw_queue</span><span class="p">,</span> <span class="n">ptcb_desc</span><span class="p">);</span>

	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_desc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pdesc</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
				    <span class="n">HW_DESC_OWN</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp_one</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">-</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hw_queue</span> <span class="o">!=</span> <span class="n">BEACON_QUEUE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;less desc left, stop skb_queue@%d, ring-&gt;idx = %d, idx = %d, skb_queue_len = 0x%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">hw_queue</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
			 <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>

		<span class="n">ieee80211_stop_queue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tx_polling</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hw_queue</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_pci_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">drop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">pcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queue_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">queue_id</span> <span class="o">=</span> <span class="n">RTL_PCI_MAX_TX_QUEUE_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">queue_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">queue_len</span><span class="p">;</span>
		<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">queue_id</span><span class="p">];</span>
		<span class="n">queue_len</span> <span class="o">=</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">queue_id</span> <span class="o">==</span> <span class="n">BEACON_QUEUE</span> <span class="o">||</span>
			<span class="n">queue_id</span> <span class="o">==</span> <span class="n">TXCMD_QUEUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">queue_id</span><span class="o">--</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* we just wait 1s for all queues */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">psc</span><span class="p">.</span><span class="n">rfpwr_state</span> <span class="o">==</span> <span class="n">ERFOFF</span> <span class="o">||</span>
			<span class="n">is_hal_stop</span><span class="p">(</span><span class="n">rtlhal</span><span class="p">)</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_pci_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="n">_rtl_pci_deinit_trx_ring</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">irq_tasklet</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">lps_leave_work</span><span class="p">);</span>

	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">rtl_wq</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">rtl_wq</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_pci_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">_rtl_pci_init_struct</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">_rtl_pci_init_trx_ring</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;tx ring initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_pci_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rtl_pci_reset_trx_ring</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">driver_is_goingto_unload</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
			 <span class="s">&quot;Failed to config hardware!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_interrupt</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;enable_interrupt OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rtl_init_rx_config</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*should be after adapter start and interrupt enable. */</span>
	<span class="n">set_hal_start</span><span class="p">(</span><span class="n">rtlhal</span><span class="p">);</span>

	<span class="n">RT_CLEAR_PS_LEVEL</span><span class="p">(</span><span class="n">ppsc</span><span class="p">,</span> <span class="n">RT_RF_OFF_LEVL_HALT_NIC</span><span class="p">);</span>

	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">up_first_time</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span> <span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_pci_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">RFInProgressTimeOut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *should be before disable interrupt&amp;adapter</span>
<span class="cm">	 *and will do it immediately.</span>
<span class="cm">	 */</span>
	<span class="n">set_hal_stop</span><span class="p">(</span><span class="n">rtlhal</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable_interrupt</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">works</span><span class="p">.</span><span class="n">lps_leave_work</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfchange_inprogress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RFInProgressTimeOut</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">RFInProgressTimeOut</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfchange_inprogress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">driver_is_goingto_unload</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_disable</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="cm">/* some things are not needed if firmware not available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">max_fw_size</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">led_control</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">LED_CTL_POWER_OFF</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfchange_inprogress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">.</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rtl_pci_enable_aspm</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_rtl_pci_find_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">pcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge_pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">venderid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">deviceid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">revisionid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">irqline</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_vendor</span> <span class="o">=</span> <span class="n">PCI_BRIDGE_VENDOR_UNKNOWN</span><span class="p">;</span>
	<span class="n">venderid</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">deviceid</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">revisionid</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irqline</span><span class="p">);</span>

	<span class="cm">/* PCI ID 0x10ec:0x8192 occurs for both RTL8192E, which uses</span>
<span class="cm">	 * r8192e_pci, and RTL8192SE, which uses this driver. If the</span>
<span class="cm">	 * revision ID is RTL_PCI_REVISION_ID_8192PCIE (0x01), then</span>
<span class="cm">	 * the correct driver is r8192e_pci, thus this routine should</span>
<span class="cm">	 * return false.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_8192SE_DID</span> <span class="o">&amp;&amp;</span>
	    <span class="n">revisionid</span> <span class="o">==</span> <span class="n">RTL_PCI_REVISION_ID_8192PCIE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_8192_DID</span> <span class="o">||</span>
	    <span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_0044_DID</span> <span class="o">||</span>
	    <span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_0047_DID</span> <span class="o">||</span>
	    <span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_8192SE_DID</span> <span class="o">||</span>
	    <span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_8174_DID</span> <span class="o">||</span>
	    <span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_8173_DID</span> <span class="o">||</span>
	    <span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_8172_DID</span> <span class="o">||</span>
	    <span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_8171_DID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">revisionid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RTL_PCI_REVISION_ID_8192PCIE</span>:
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;8192 PCI-E is found - vid/did=%x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">venderid</span><span class="p">,</span> <span class="n">deviceid</span><span class="p">);</span>
			<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">hw_type</span> <span class="o">=</span> <span class="n">HARDWARE_TYPE_RTL8192E</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RTL_PCI_REVISION_ID_8192SE</span>:
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
				 <span class="s">&quot;8192SE is found - vid/did=%x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">venderid</span><span class="p">,</span> <span class="n">deviceid</span><span class="p">);</span>
			<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">hw_type</span> <span class="o">=</span> <span class="n">HARDWARE_TYPE_RTL8192SE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span>
				 <span class="s">&quot;Err: Unknown device - vid/did=%x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">venderid</span><span class="p">,</span> <span class="n">deviceid</span><span class="p">);</span>
			<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">hw_type</span> <span class="o">=</span> <span class="n">HARDWARE_TYPE_RTL8192SE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_8192CET_DID</span> <span class="o">||</span>
		   <span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_8192CE_DID</span> <span class="o">||</span>
		   <span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_8191CE_DID</span> <span class="o">||</span>
		   <span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_8188CE_DID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">hw_type</span> <span class="o">=</span> <span class="n">HARDWARE_TYPE_RTL8192CE</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
			 <span class="s">&quot;8192C PCI-E is found - vid/did=%x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">venderid</span><span class="p">,</span> <span class="n">deviceid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_8192DE_DID</span> <span class="o">||</span>
		   <span class="n">deviceid</span> <span class="o">==</span> <span class="n">RTL_PCI_8192DE_DID2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">hw_type</span> <span class="o">=</span> <span class="n">HARDWARE_TYPE_RTL8192DE</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
			 <span class="s">&quot;8192D PCI-E is found - vid/did=%x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">venderid</span><span class="p">,</span> <span class="n">deviceid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_WARNING</span><span class="p">,</span>
			 <span class="s">&quot;Err: Unknown device - vid/did=%x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">venderid</span><span class="p">,</span> <span class="n">deviceid</span><span class="p">);</span>

		<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">hw_type</span> <span class="o">=</span> <span class="n">RTL_DEFAULT_HARDWARE_TYPE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">hw_type</span> <span class="o">==</span> <span class="n">HARDWARE_TYPE_RTL8192DE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">revisionid</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">revisionid</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">revisionid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;Find 92DE MAC0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">interfaceindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">revisionid</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;Find 92DE MAC1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">interfaceindex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Unknown device - VendorID/DeviceID=%x/%x, Revision=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">venderid</span><span class="p">,</span> <span class="n">deviceid</span><span class="p">,</span> <span class="n">revisionid</span><span class="p">);</span>
			<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">interfaceindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*find bus info */</span>
	<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">busnumber</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">devnumber</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">funcnumber</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bridge_pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*find bridge info if available */</span>
		<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_vendorid</span> <span class="o">=</span> <span class="n">bridge_pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">PCI_BRIDGE_VENDOR_MAX</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bridge_pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">pcibridge_vendors</span><span class="p">[</span><span class="n">tmp</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_vendor</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
					 <span class="s">&quot;Pci Bridge Vendor is found index: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">tmp</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_vendor</span> <span class="o">!=</span>
		<span class="n">PCI_BRIDGE_VENDOR_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_busnum</span> <span class="o">=</span>
		    <span class="n">bridge_pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_devnum</span> <span class="o">=</span>
		    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">bridge_pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_funcnum</span> <span class="o">=</span>
		    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">bridge_pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_pciehdr_offset</span> <span class="o">=</span>
		    <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">bridge_pdev</span><span class="p">);</span>
		<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">num4bytes</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_pciehdr_offset</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">rtl_pci_get_linkcontrol_field</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_vendor</span> <span class="o">==</span>
		    <span class="n">PCI_BRIDGE_VENDOR_AMD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">amd_l1_patch</span> <span class="o">=</span>
			    <span class="n">rtl_pci_get_amd_l1_patch</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
		 <span class="s">&quot;pcidev busnumber:devnumber:funcnumber:vendor:link_ctl %d:%d:%d:%x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">busnumber</span><span class="p">,</span>
		 <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">devnumber</span><span class="p">,</span>
		 <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">funcnumber</span><span class="p">,</span>
		 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">linkctrl_reg</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
		 <span class="s">&quot;pci_bridge busnumber:devnumber:funcnumber:vendor:pcie_cap:link_ctl_reg:amd %d:%d:%d:%x:%x:%x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_busnum</span><span class="p">,</span>
		 <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_devnum</span><span class="p">,</span>
		 <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_funcnum</span><span class="p">,</span>
		 <span class="n">pcibridge_vendors</span><span class="p">[</span><span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_vendor</span><span class="p">],</span>
		 <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_pciehdr_offset</span><span class="p">,</span>
		 <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">pcibridge_linkctrlreg</span><span class="p">,</span>
		 <span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">ndis_adapter</span><span class="p">.</span><span class="n">amd_l1_patch</span><span class="p">);</span>

	<span class="n">rtl_pci_parse_configuration</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rtl_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">pcipriv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pmem_start</span><span class="p">,</span> <span class="n">pmem_len</span><span class="p">,</span> <span class="n">pmem_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_ASSERT</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="s">&quot;%s : Cannot enable new PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">RT_ASSERT</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span>
				  <span class="s">&quot;Unable to obtain 32bit DMA for consistent allocations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl_pci_priv</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl_priv</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rtl_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_ASSERT</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span>
			  <span class="s">&quot;%s : ieee80211 alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">pcipriv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">pcipriv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">firmware_loading_complete</span><span class="p">);</span>

	<span class="cm">/* init cfg &amp; intf_ops */</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">INTF_PCI</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl_hal_cfg</span> <span class="o">*</span><span class="p">)(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">intf_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtl_pci_ops</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *init dbgp flags before all</span>
<span class="cm">	 *other functions, because we will</span>
<span class="cm">	 *use it in other funtions like</span>
<span class="cm">	 *RT_TRACE/RT_PRINT/RTL_PRINT_DATA</span>
<span class="cm">	 *you can not use these macro</span>
<span class="cm">	 *before this</span>
<span class="cm">	 */</span>
	<span class="n">rtl_dbgp_flag_init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* MEM map */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_ASSERT</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="s">&quot;Can&#39;t obtain PCI resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pmem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bar_id</span><span class="p">);</span>
	<span class="n">pmem_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bar_id</span><span class="p">);</span>
	<span class="n">pmem_flags</span> <span class="o">=</span> <span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bar_id</span><span class="p">);</span>

	<span class="cm">/*shared mem start */</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pci_mem_start</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bar_id</span><span class="p">,</span> <span class="n">pmem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pci_mem_start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_ASSERT</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="s">&quot;Can&#39;t map PCI mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
		 <span class="s">&quot;mem mapped space: start: 0x%08lx len:%08lx flags:%08lx, after map:0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pmem_start</span><span class="p">,</span> <span class="n">pmem_len</span><span class="p">,</span> <span class="n">pmem_flags</span><span class="p">,</span>
		 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pci_mem_start</span><span class="p">);</span>

	<span class="cm">/* Disable Clk Request */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* leave D3 mode */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>

	<span class="cm">/* find adapter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_rtl_pci_find_adapter</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Init IO handler */</span>
	<span class="n">_rtl_pci_io_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*like read eeprom and so on */</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_eeprom_info</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*aspm */</span>
	<span class="n">rtl_pci_init_aspm</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Init mac80211 sw */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rtl_init_core</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;Can&#39;t allocate sw for mac80211</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Init PCI sw */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rtl_pci_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span> <span class="s">&quot;Failed to init PCI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init_sw_vars</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span> <span class="s">&quot;Can&#39;t init_sw_vars</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init_sw_leds</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtl_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_ERR</span><span class="p">,</span> <span class="n">DBG_EMERG</span><span class="p">,</span>
			 <span class="s">&quot;failed to create sysfs device attributes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">pcipriv</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_rtl_pci_interrupt</span><span class="p">,</span>
			  <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_INIT</span><span class="p">,</span> <span class="n">DBG_DMESG</span><span class="p">,</span>
			 <span class="s">&quot;%s: failed to register IRQ handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">wiphy_name</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">irq_alloc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail3:</span>
	<span class="n">rtl_deinit_core</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">_rtl_pci_io_handler_release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pci_mem_start</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pci_mem_start</span><span class="p">);</span>

<span class="nl">fail2:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">firmware_loading_complete</span><span class="p">);</span>

<span class="nl">fail1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="p">)</span>
		<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl_pci_probe</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtl_pci_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci_priv</span> <span class="o">*</span><span class="n">pcipriv</span> <span class="o">=</span> <span class="n">rtl_pcipriv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_pci</span> <span class="o">*</span><span class="n">rtlpci</span> <span class="o">=</span> <span class="n">rtl_pcidev</span><span class="p">(</span><span class="n">pcipriv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">rtlmac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">);</span>

	<span class="cm">/* just in case driver is removed before firmware callback */</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">firmware_loading_complete</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">RTL_STATUS_INTERFACE_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtl_attribute_group</span><span class="p">);</span>

	<span class="cm">/*ieee80211_unregister_hw will call ops_stop */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlmac</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtlmac</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtl_deinit_deferred_work</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">intf_ops</span><span class="o">-&gt;</span><span class="n">adapter_stop</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable_interrupt</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*deinit rfkill */</span>
	<span class="n">rtl_deinit_rfkill</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtl_pci_deinit</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl_deinit_core</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">_rtl_pci_io_handler_release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">deinit_sw_vars</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">irq_alloc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="n">rtlpci</span><span class="o">-&gt;</span><span class="n">irq_alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pci_mem_start</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pci_mem_start</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">rtl_pci_disable_aspm</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl_pci_disconnect</span><span class="p">);</span>

<span class="cm">/***************************************</span>
<span class="cm">kernel pci power state define:</span>
<span class="cm">PCI_D0         ((pci_power_t __force) 0)</span>
<span class="cm">PCI_D1         ((pci_power_t __force) 1)</span>
<span class="cm">PCI_D2         ((pci_power_t __force) 2)</span>
<span class="cm">PCI_D3hot      ((pci_power_t __force) 3)</span>
<span class="cm">PCI_D3cold     ((pci_power_t __force) 4)</span>
<span class="cm">PCI_UNKNOWN    ((pci_power_t __force) 5)</span>

<span class="cm">This function is called when system</span>
<span class="cm">goes into suspend state mac80211 will</span>
<span class="cm">call rtl_mac_stop() from the mac80211</span>
<span class="cm">suspend function first, So there is</span>
<span class="cm">no need to call hw_disable here.</span>
<span class="cm">****************************************/</span>
<span class="kt">int</span> <span class="nf">rtl_pci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_suspend</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl_deinit_rfkill</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl_pci_suspend</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rtl_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_resume</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl_init_rfkill</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtl_pci_resume</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">rtl_intf_ops</span> <span class="n">rtl_pci_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read_efuse_byte</span> <span class="o">=</span> <span class="n">read_efuse_byte</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adapter_start</span> <span class="o">=</span> <span class="n">rtl_pci_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adapter_stop</span> <span class="o">=</span> <span class="n">rtl_pci_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adapter_tx</span> <span class="o">=</span> <span class="n">rtl_pci_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">rtl_pci_flush</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_trx_ring</span> <span class="o">=</span> <span class="n">rtl_pci_reset_trx_ring</span><span class="p">,</span>
	<span class="p">.</span><span class="n">waitq_insert</span> <span class="o">=</span> <span class="n">rtl_pci_tx_chk_waitq_insert</span><span class="p">,</span>

	<span class="p">.</span><span class="n">disable_aspm</span> <span class="o">=</span> <span class="n">rtl_pci_disable_aspm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_aspm</span> <span class="o">=</span> <span class="n">rtl_pci_enable_aspm</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
