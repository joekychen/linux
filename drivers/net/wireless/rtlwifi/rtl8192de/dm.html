<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › rtlwifi › rtl8192de › dm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>dm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009-2012  Realtek Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * wlanfae &lt;wlanfae@realtek.com&gt;</span>
<span class="cm"> * Realtek Corporation, No. 2, Innovation Road II, Hsinchu Science Park,</span>
<span class="cm"> * Hsinchu 300, Taiwan.</span>
<span class="cm"> *</span>
<span class="cm"> * Larry Finger &lt;Larry.Finger@lwfinger.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#include &quot;../wifi.h&quot;</span>
<span class="cp">#include &quot;../base.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>
<span class="cp">#include &quot;def.h&quot;</span>
<span class="cp">#include &quot;phy.h&quot;</span>
<span class="cp">#include &quot;dm.h&quot;</span>
<span class="cp">#include &quot;fw.h&quot;</span>

<span class="cp">#define UNDEC_SM_PWDB	entry_min_undecoratedsmoothed_pwdb</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ofdmswing_table</span><span class="p">[</span><span class="n">OFDM_TABLE_SIZE_92D</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x7f8001fe</span><span class="p">,</span>		<span class="cm">/* 0, +6.0dB */</span>
	<span class="mh">0x788001e2</span><span class="p">,</span>		<span class="cm">/* 1, +5.5dB */</span>
	<span class="mh">0x71c001c7</span><span class="p">,</span>		<span class="cm">/* 2, +5.0dB */</span>
	<span class="mh">0x6b8001ae</span><span class="p">,</span>		<span class="cm">/* 3, +4.5dB */</span>
	<span class="mh">0x65400195</span><span class="p">,</span>		<span class="cm">/* 4, +4.0dB */</span>
	<span class="mh">0x5fc0017f</span><span class="p">,</span>		<span class="cm">/* 5, +3.5dB */</span>
	<span class="mh">0x5a400169</span><span class="p">,</span>		<span class="cm">/* 6, +3.0dB */</span>
	<span class="mh">0x55400155</span><span class="p">,</span>		<span class="cm">/* 7, +2.5dB */</span>
	<span class="mh">0x50800142</span><span class="p">,</span>		<span class="cm">/* 8, +2.0dB */</span>
	<span class="mh">0x4c000130</span><span class="p">,</span>		<span class="cm">/* 9, +1.5dB */</span>
	<span class="mh">0x47c0011f</span><span class="p">,</span>		<span class="cm">/* 10, +1.0dB */</span>
	<span class="mh">0x43c0010f</span><span class="p">,</span>		<span class="cm">/* 11, +0.5dB */</span>
	<span class="mh">0x40000100</span><span class="p">,</span>		<span class="cm">/* 12, +0dB */</span>
	<span class="mh">0x3c8000f2</span><span class="p">,</span>		<span class="cm">/* 13, -0.5dB */</span>
	<span class="mh">0x390000e4</span><span class="p">,</span>		<span class="cm">/* 14, -1.0dB */</span>
	<span class="mh">0x35c000d7</span><span class="p">,</span>		<span class="cm">/* 15, -1.5dB */</span>
	<span class="mh">0x32c000cb</span><span class="p">,</span>		<span class="cm">/* 16, -2.0dB */</span>
	<span class="mh">0x300000c0</span><span class="p">,</span>		<span class="cm">/* 17, -2.5dB */</span>
	<span class="mh">0x2d4000b5</span><span class="p">,</span>		<span class="cm">/* 18, -3.0dB */</span>
	<span class="mh">0x2ac000ab</span><span class="p">,</span>		<span class="cm">/* 19, -3.5dB */</span>
	<span class="mh">0x288000a2</span><span class="p">,</span>		<span class="cm">/* 20, -4.0dB */</span>
	<span class="mh">0x26000098</span><span class="p">,</span>		<span class="cm">/* 21, -4.5dB */</span>
	<span class="mh">0x24000090</span><span class="p">,</span>		<span class="cm">/* 22, -5.0dB */</span>
	<span class="mh">0x22000088</span><span class="p">,</span>		<span class="cm">/* 23, -5.5dB */</span>
	<span class="mh">0x20000080</span><span class="p">,</span>		<span class="cm">/* 24, -6.0dB */</span>
	<span class="mh">0x1e400079</span><span class="p">,</span>		<span class="cm">/* 25, -6.5dB */</span>
	<span class="mh">0x1c800072</span><span class="p">,</span>		<span class="cm">/* 26, -7.0dB */</span>
	<span class="mh">0x1b00006c</span><span class="p">,</span>		<span class="cm">/* 27. -7.5dB */</span>
	<span class="mh">0x19800066</span><span class="p">,</span>		<span class="cm">/* 28, -8.0dB */</span>
	<span class="mh">0x18000060</span><span class="p">,</span>		<span class="cm">/* 29, -8.5dB */</span>
	<span class="mh">0x16c0005b</span><span class="p">,</span>		<span class="cm">/* 30, -9.0dB */</span>
	<span class="mh">0x15800056</span><span class="p">,</span>		<span class="cm">/* 31, -9.5dB */</span>
	<span class="mh">0x14400051</span><span class="p">,</span>		<span class="cm">/* 32, -10.0dB */</span>
	<span class="mh">0x1300004c</span><span class="p">,</span>		<span class="cm">/* 33, -10.5dB */</span>
	<span class="mh">0x12000048</span><span class="p">,</span>		<span class="cm">/* 34, -11.0dB */</span>
	<span class="mh">0x11000044</span><span class="p">,</span>		<span class="cm">/* 35, -11.5dB */</span>
	<span class="mh">0x10000040</span><span class="p">,</span>		<span class="cm">/* 36, -12.0dB */</span>
	<span class="mh">0x0f00003c</span><span class="p">,</span>		<span class="cm">/* 37, -12.5dB */</span>
	<span class="mh">0x0e400039</span><span class="p">,</span>		<span class="cm">/* 38, -13.0dB */</span>
	<span class="mh">0x0d800036</span><span class="p">,</span>		<span class="cm">/* 39, -13.5dB */</span>
	<span class="mh">0x0cc00033</span><span class="p">,</span>		<span class="cm">/* 40, -14.0dB */</span>
	<span class="mh">0x0c000030</span><span class="p">,</span>		<span class="cm">/* 41, -14.5dB */</span>
	<span class="mh">0x0b40002d</span><span class="p">,</span>		<span class="cm">/* 42, -15.0dB */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cckswing_table_ch1ch13</span><span class="p">[</span><span class="n">CCK_TABLE_SIZE</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">},</span>    <span class="cm">/* 0, +0dB */</span>
	<span class="p">{</span><span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">},</span>    <span class="cm">/* 1, -0.5dB */</span>
	<span class="p">{</span><span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>    <span class="cm">/* 2, -1.0dB */</span>
	<span class="p">{</span><span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>    <span class="cm">/* 3, -1.5dB */</span>
	<span class="p">{</span><span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>    <span class="cm">/* 4, -2.0dB */</span>
	<span class="p">{</span><span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>    <span class="cm">/* 5, -2.5dB */</span>
	<span class="p">{</span><span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>    <span class="cm">/* 6, -3.0dB */</span>
	<span class="p">{</span><span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>    <span class="cm">/* 7, -3.5dB */</span>
	<span class="p">{</span><span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>    <span class="cm">/* 8, -4.0dB */</span>
	<span class="p">{</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>    <span class="cm">/* 9, -4.5dB */</span>
	<span class="p">{</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>    <span class="cm">/* 10, -5.0dB */</span>
	<span class="p">{</span><span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>    <span class="cm">/* 11, -5.5dB */</span>
	<span class="p">{</span><span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>    <span class="cm">/* 12, -6.0dB */</span>
	<span class="p">{</span><span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>    <span class="cm">/* 13, -6.5dB */</span>
	<span class="p">{</span><span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>    <span class="cm">/* 14, -7.0dB */</span>
	<span class="p">{</span><span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>    <span class="cm">/* 15, -7.5dB */</span>
	<span class="p">{</span><span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 16, -8.0dB */</span>
	<span class="p">{</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>    <span class="cm">/* 17, -8.5dB */</span>
	<span class="p">{</span><span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 18, -9.0dB */</span>
	<span class="p">{</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 19, -9.5dB */</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 20, -10.0dB */</span>
	<span class="p">{</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 21, -10.5dB */</span>
	<span class="p">{</span><span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 22, -11.0dB */</span>
	<span class="p">{</span><span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 23, -11.5dB */</span>
	<span class="p">{</span><span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 24, -12.0dB */</span>
	<span class="p">{</span><span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 25, -12.5dB */</span>
	<span class="p">{</span><span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 26, -13.0dB */</span>
	<span class="p">{</span><span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 27, -13.5dB */</span>
	<span class="p">{</span><span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 28, -14.0dB */</span>
	<span class="p">{</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 29, -14.5dB */</span>
	<span class="p">{</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 30, -15.0dB */</span>
	<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>    <span class="cm">/* 31, -15.5dB */</span>
	<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">}</span>     <span class="cm">/* 32, -16.0dB */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cckswing_table_ch14</span><span class="p">[</span><span class="n">CCK_TABLE_SIZE</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 0, +0dB */</span>
	<span class="p">{</span><span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 1, -0.5dB */</span>
	<span class="p">{</span><span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 2, -1.0dB */</span>
	<span class="p">{</span><span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 3, -1.5dB */</span>
	<span class="p">{</span><span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 4, -2.0dB */</span>
	<span class="p">{</span><span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 5, -2.5dB */</span>
	<span class="p">{</span><span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 6, -3.0dB */</span>
	<span class="p">{</span><span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 7, -3.5dB */</span>
	<span class="p">{</span><span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 8, -4.0dB */</span>
	<span class="p">{</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 9, -4.5dB */</span>
	<span class="p">{</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 10, -5.0dB */</span>
	<span class="p">{</span><span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 11, -5.5dB */</span>
	<span class="p">{</span><span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 12, -6.0dB */</span>
	<span class="p">{</span><span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 13, -6.5dB */</span>
	<span class="p">{</span><span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 14, -7.0dB */</span>
	<span class="p">{</span><span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 15, -7.5dB */</span>
	<span class="p">{</span><span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 16, -8.0dB */</span>
	<span class="p">{</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 17, -8.5dB */</span>
	<span class="p">{</span><span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 18, -9.0dB */</span>
	<span class="p">{</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 19, -9.5dB */</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 20, -10.0dB */</span>
	<span class="p">{</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 21, -10.5dB */</span>
	<span class="p">{</span><span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 22, -11.0dB */</span>
	<span class="p">{</span><span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 23, -11.5dB */</span>
	<span class="p">{</span><span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 24, -12.0dB */</span>
	<span class="p">{</span><span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 25, -12.5dB */</span>
	<span class="p">{</span><span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 26, -13.0dB */</span>
	<span class="p">{</span><span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 27, -13.5dB */</span>
	<span class="p">{</span><span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 28, -14.0dB */</span>
	<span class="p">{</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 29, -14.5dB */</span>
	<span class="p">{</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 30, -15.0dB */</span>
	<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>    <span class="cm">/* 31, -15.5dB */</span>
	<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>     <span class="cm">/* 32, -16.0dB */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_dm_diginit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">de_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>

	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">dig_enable_flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">dig_ext_port_stage</span> <span class="o">=</span> <span class="n">DIG_EXT_PORT_STAGE_MAX</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">pre_igvalue</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">=</span> <span class="n">DIG_STA_DISCONNECT</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">presta_connectstate</span> <span class="o">=</span> <span class="n">DIG_STA_DISCONNECT</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">curmultista_connectstate</span> <span class="o">=</span> <span class="n">DIG_MULTISTA_DISCONNECT</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">rssi_lowthresh</span> <span class="o">=</span> <span class="n">DM_DIG_THRESH_LOW</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">rssi_highthresh</span> <span class="o">=</span> <span class="n">DM_DIG_THRESH_HIGH</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">fa_lowthresh</span> <span class="o">=</span> <span class="n">DM_FALSEALARM_THRESH_LOW</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">fa_highthresh</span> <span class="o">=</span> <span class="n">DM_FALSEALARM_THRESH_HIGH</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_max</span> <span class="o">=</span> <span class="n">DM_DIG_FA_UPPER</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_min</span> <span class="o">=</span> <span class="n">DM_DIG_FA_LOWER</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span> <span class="o">=</span> <span class="n">DM_DIG_BACKOFF_DEFAULT</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val_range_max</span> <span class="o">=</span> <span class="n">DM_DIG_BACKOFF_MAX</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val_range_min</span> <span class="o">=</span> <span class="n">DM_DIG_BACKOFF_MIN</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">pre_cck_pd_state</span> <span class="o">=</span> <span class="n">CCK_PD_STAGE_LOWRSSI</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">=</span> <span class="n">CCK_PD_STAGE_MAX</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">large_fa_hit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">recover_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">forbidden_igi</span> <span class="o">=</span> <span class="n">DM_DIG_FA_LOWER</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_dm_false_alarm_counter_statistics</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">false_alarm_statistics</span> <span class="o">*</span><span class="n">falsealm_cnt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">falsealm_cnt</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* hold ofdm counter */</span>
	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_LSTF</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">31</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* hold page C counter */</span>
	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM1_LSTF</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">31</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/*hold page D counter */</span>

	<span class="n">ret_value</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_FRAMESYNC</span><span class="p">,</span> <span class="n">BMASKDWORD</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_fast_fsync_fail</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret_value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_sb_search_fail</span> <span class="o">=</span> <span class="p">((</span><span class="n">ret_value</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ret_value</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM_PHYCOUNTER1</span><span class="p">,</span> <span class="n">BMASKDWORD</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_parity_fail</span> <span class="o">=</span> <span class="p">((</span><span class="n">ret_value</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ret_value</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM_PHYCOUNTER2</span><span class="p">,</span> <span class="n">BMASKDWORD</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_rate_illegal</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret_value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_crc8_fail</span> <span class="o">=</span> <span class="p">((</span><span class="n">ret_value</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ret_value</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM_PHYCOUNTER3</span><span class="p">,</span> <span class="n">BMASKDWORD</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_mcs_fail</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret_value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_ofdm_fail</span> <span class="o">=</span> <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_parity_fail</span> <span class="o">+</span>
				      <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_rate_illegal</span> <span class="o">+</span>
				      <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_crc8_fail</span> <span class="o">+</span>
				      <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_mcs_fail</span> <span class="o">+</span>
				      <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_fast_fsync_fail</span> <span class="o">+</span>
				      <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_sb_search_fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">current_bandtype</span> <span class="o">!=</span> <span class="n">BAND_ON_5G</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* hold cck counter */</span>
		<span class="n">rtl92d_acquire_cckandrw_pagea_ctl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">);</span>
		<span class="n">ret_value</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_FACOUNTERLOWER</span><span class="p">,</span> <span class="n">BMASKBYTE0</span><span class="p">);</span>
		<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_cck_fail</span> <span class="o">=</span> <span class="n">ret_value</span><span class="p">;</span>
		<span class="n">ret_value</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_FACOUNTERUPPER</span><span class="p">,</span> <span class="n">BMASKBYTE3</span><span class="p">);</span>
		<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_cck_fail</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ret_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">rtl92d_release_cckandrw_pagea_ctl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_cck_fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset false alarm counter registers */</span>
	<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_all</span> <span class="o">=</span> <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_fast_fsync_fail</span> <span class="o">+</span>
				<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_sb_search_fail</span> <span class="o">+</span>
				<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_parity_fail</span> <span class="o">+</span>
				<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_rate_illegal</span> <span class="o">+</span>
				<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_crc8_fail</span> <span class="o">+</span>
				<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_mcs_fail</span> <span class="o">+</span>
				<span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_cck_fail</span><span class="p">;</span>

	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM1_LSTF</span><span class="p">,</span> <span class="mh">0x08000000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* update ofdm counter */</span>
	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM1_LSTF</span><span class="p">,</span> <span class="mh">0x08000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* update page C counter */</span>
	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_LSTF</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">31</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* update page D counter */</span>
	<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM1_LSTF</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">31</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">current_bandtype</span> <span class="o">!=</span> <span class="n">BAND_ON_5G</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* reset cck counter */</span>
		<span class="n">rtl92d_acquire_cckandrw_pagea_ctl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">);</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_FALSEALARMREPORT</span><span class="p">,</span> <span class="mh">0x0000c000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* enable cck counter */</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_FALSEALARMREPORT</span><span class="p">,</span> <span class="mh">0x0000c000</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">rtl92d_release_cckandrw_pagea_ctl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;Cnt_Fast_Fsync_fail = %x, Cnt_SB_Search_fail = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_fast_fsync_fail</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_sb_search_fail</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;Cnt_Parity_Fail = %x, Cnt_Rate_Illegal = %x, Cnt_Crc8_fail = %x, Cnt_Mcs_fail = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_parity_fail</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_rate_illegal</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_crc8_fail</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_mcs_fail</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;Cnt_Ofdm_fail = %x, Cnt_Cck_fail = %x, Cnt_all = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_ofdm_fail</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_cck_fail</span><span class="p">,</span>
		 <span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_all</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_dm_find_minimum_rssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">de_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">);</span>

	<span class="cm">/* Determine the minimum RSSI  */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&lt;</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">UNDEC_SM_PWDB</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">min_undecorated_pwdb_for_dm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_BB_POWERSAVING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;Not connected to any</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&gt;=</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
		    <span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">min_undecorated_pwdb_for_dm</span> <span class="o">=</span>
			    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">UNDEC_SM_PWDB</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_BB_POWERSAVING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;AP Client PWDB = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">UNDEC_SM_PWDB</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">min_undecorated_pwdb_for_dm</span> <span class="o">=</span>
			    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_BB_POWERSAVING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;STA Default Port PWDB = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">min_undecorated_pwdb_for_dm</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">min_undecorated_pwdb_for_dm</span> <span class="o">=</span>
		    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">UNDEC_SM_PWDB</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_BB_POWERSAVING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;AP Ext Port or disconnect PWDB = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">min_undecorated_pwdb_for_dm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;MinUndecoratedPWDBForDM =%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">min_undecorated_pwdb_for_dm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_dm_cck_packet_detection_thresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">de_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">==</span> <span class="n">DIG_STA_CONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">pre_cck_pd_state</span> <span class="o">==</span> <span class="n">CCK_PD_STAGE_LOWRSSI</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">min_undecorated_pwdb_for_dm</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">)</span>
				<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">=</span>
							 <span class="n">CCK_PD_STAGE_LOWRSSI</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">=</span>
							 <span class="n">CCK_PD_STAGE_HIGHRSSI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">min_undecorated_pwdb_for_dm</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">)</span>
				<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">=</span>
							 <span class="n">CCK_PD_STAGE_LOWRSSI</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">=</span>
							 <span class="n">CCK_PD_STAGE_HIGHRSSI</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">=</span> <span class="n">CCK_PD_STAGE_LOWRSSI</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">pre_cck_pd_state</span> <span class="o">!=</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">==</span> <span class="n">CCK_PD_STAGE_LOWRSSI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl92d_acquire_cckandrw_pagea_ctl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">);</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_CCA</span><span class="p">,</span> <span class="n">BMASKBYTE2</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">);</span>
			<span class="n">rtl92d_release_cckandrw_pagea_ctl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtl92d_acquire_cckandrw_pagea_ctl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">);</span>
			<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_CCA</span><span class="p">,</span> <span class="n">BMASKBYTE2</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">);</span>
			<span class="n">rtl92d_release_cckandrw_pagea_ctl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">pre_cck_pd_state</span> <span class="o">=</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;CurSTAConnectState=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">==</span> <span class="n">DIG_STA_CONNECT</span> <span class="o">?</span>
		 <span class="s">&quot;DIG_STA_CONNECT &quot;</span> <span class="o">:</span> <span class="s">&quot;DIG_STA_DISCONNECT&quot;</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;CCKPDStage=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_cck_pd_state</span> <span class="o">==</span> <span class="n">CCK_PD_STAGE_LOWRSSI</span> <span class="o">?</span>
		 <span class="s">&quot;Low RSSI &quot;</span> <span class="o">:</span> <span class="s">&quot;High RSSI &quot;</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;is92d single phy =%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">IS_92D_SINGLEPHY</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">version</span><span class="p">));</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92d_dm_write_dig</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">de_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;cur_igvalue = 0x%x, pre_igvalue = 0x%x, backoff_val = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">,</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">pre_igvalue</span><span class="p">,</span>
		 <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">backoff_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">dig_enable_flag</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;DIG is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">pre_igvalue</span> <span class="o">=</span> <span class="mh">0x17</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">pre_igvalue</span> <span class="o">!=</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XAAGCCORE1</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span>
			      <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">);</span>
		<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XBAGCCORE1</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span>
			      <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">);</span>
		<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">pre_igvalue</span> <span class="o">=</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_early_mode_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">de_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">link_state</span> <span class="o">&gt;=</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PEER_CISCO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;IOT_PEER = CISCO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">last_min_undecorated_pwdb_for_dm</span> <span class="o">&gt;=</span> <span class="mi">50</span>
		    <span class="o">&amp;&amp;</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">min_undecorated_pwdb_for_dm</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_EARLY_MODE_CONTROL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Early Mode Off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">last_min_undecorated_pwdb_for_dm</span> <span class="o">&lt;=</span> <span class="mi">55</span> <span class="o">&amp;&amp;</span>
			   <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">min_undecorated_pwdb_for_dm</span> <span class="o">&gt;</span> <span class="mi">55</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_EARLY_MODE_CONTROL</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;Early Mode On</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rtl_read_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_EARLY_MODE_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_EARLY_MODE_CONTROL</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;Early Mode On</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_dm_dig</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dig_t</span> <span class="o">*</span><span class="n">de_digtable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm_digtable</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value_igi</span> <span class="o">=</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">false_alarm_statistics</span> <span class="o">*</span><span class="n">falsealm_cnt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">falsealm_cnt</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;==&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">earlymode_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl92d_early_mode_enabled</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">);</span>
		<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">last_min_undecorated_pwdb_for_dm</span> <span class="o">=</span>
				 <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">min_undecorated_pwdb_for_dm</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_initialgain_enable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* because we will send data pkt when scanning</span>
<span class="cm">	 * this will cause some ap like gear-3700 wep TP</span>
<span class="cm">	 * lower if we retrun here, this is the diff of</span>
<span class="cm">	 * mac80211 driver vs ieee80211 driver */</span>
	<span class="cm">/* if (rtlpriv-&gt;mac80211.act_scanning)</span>
<span class="cm">	 *      return; */</span>

	<span class="cm">/* Not STA mode return tmp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">opmode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Decide the current status and if modify initial gain or not */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">link_state</span> <span class="o">&gt;=</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span>
		<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">=</span> <span class="n">DIG_STA_CONNECT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cursta_connectctate</span> <span class="o">=</span> <span class="n">DIG_STA_DISCONNECT</span><span class="p">;</span>

	<span class="cm">/* adjust initial gain according to false alarm counter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_all</span> <span class="o">&lt;</span> <span class="n">DM_DIG_FA_TH0</span><span class="p">)</span>
		<span class="n">value_igi</span><span class="o">--</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_all</span> <span class="o">&lt;</span> <span class="n">DM_DIG_FA_TH1</span><span class="p">)</span>
		<span class="n">value_igi</span> <span class="o">+=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_all</span> <span class="o">&lt;</span> <span class="n">DM_DIG_FA_TH2</span><span class="p">)</span>
		<span class="n">value_igi</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_all</span> <span class="o">&gt;=</span> <span class="n">DM_DIG_FA_TH2</span><span class="p">)</span>
		<span class="n">value_igi</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;dm_DIG() Before: large_fa_hit=%d, forbidden_igi=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">large_fa_hit</span><span class="p">,</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">forbidden_igi</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;dm_DIG() Before: Recover_cnt=%d, rx_gain_range_min=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">recover_cnt</span><span class="p">,</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_min</span><span class="p">);</span>

	<span class="cm">/* deal with abnorally large false alarm */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">falsealm_cnt</span><span class="o">-&gt;</span><span class="n">cnt_all</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;dm_DIG(): Abnormally false alarm case</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">large_fa_hit</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">forbidden_igi</span> <span class="o">&lt;</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">forbidden_igi</span> <span class="o">=</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span><span class="p">;</span>
			<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">large_fa_hit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">large_fa_hit</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">forbidden_igi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DM_DIG_MAX</span><span class="p">)</span>
				<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_min</span> <span class="o">=</span> <span class="n">DM_DIG_MAX</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_min</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">forbidden_igi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">recover_cnt</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">;</span>	<span class="cm">/* 3600=2hr */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Recovery mechanism for IGI lower bound */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">recover_cnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">recover_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">large_fa_hit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">forbidden_igi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span>
				    <span class="n">DM_DIG_FA_LOWER</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">forbidden_igi</span> <span class="o">=</span>
							 <span class="n">DM_DIG_FA_LOWER</span><span class="p">;</span>
					<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_min</span> <span class="o">=</span>
							 <span class="n">DM_DIG_FA_LOWER</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">forbidden_igi</span><span class="o">--</span><span class="p">;</span>
					<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_min</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">forbidden_igi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">large_fa_hit</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">large_fa_hit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;dm_DIG() After: large_fa_hit=%d, forbidden_igi=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">large_fa_hit</span><span class="p">,</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">forbidden_igi</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;dm_DIG() After: recover_cnt=%d, rx_gain_range_min=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">recover_cnt</span><span class="p">,</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_min</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value_igi</span> <span class="o">&gt;</span> <span class="n">DM_DIG_MAX</span><span class="p">)</span>
		<span class="n">value_igi</span> <span class="o">=</span> <span class="n">DM_DIG_MAX</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value_igi</span> <span class="o">&lt;</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_min</span><span class="p">)</span>
		<span class="n">value_igi</span> <span class="o">=</span> <span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">rx_gain_range_min</span><span class="p">;</span>
	<span class="n">de_digtable</span><span class="o">-&gt;</span><span class="n">cur_igvalue</span> <span class="o">=</span> <span class="n">value_igi</span><span class="p">;</span>
	<span class="n">rtl92d_dm_write_dig</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">rtlhal</span><span class="p">.</span><span class="n">current_bandtype</span> <span class="o">!=</span> <span class="n">BAND_ON_5G</span><span class="p">)</span>
		<span class="n">rtl92d_dm_cck_packet_detection_thresh</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_DIG</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;==</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_dm_init_dynamic_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txpower_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">last_dtp_lvl</span> <span class="o">=</span> <span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span> <span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_dm_dynamic_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="kt">long</span> <span class="n">undecorated_smoothed_pwdb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txpower_enable</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_flag</span> <span class="o">&amp;</span> <span class="n">HAL_DM_HIPWR_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span> <span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&lt;</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">UNDEC_SM_PWDB</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_TRACE</span><span class="p">,</span>
			 <span class="s">&quot;Not connected to any</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span> <span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">last_dtp_lvl</span> <span class="o">=</span> <span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&gt;=</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">undecorated_smoothed_pwdb</span> <span class="o">=</span>
			    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">UNDEC_SM_PWDB</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;IBSS Client PWDB = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">undecorated_smoothed_pwdb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">undecorated_smoothed_pwdb</span> <span class="o">=</span>
			    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;STA Default Port PWDB = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">undecorated_smoothed_pwdb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">undecorated_smoothed_pwdb</span> <span class="o">=</span>
		    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">UNDEC_SM_PWDB</span><span class="p">;</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;AP Ext Port PWDB = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">undecorated_smoothed_pwdb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_5G</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&gt;=</span> <span class="mh">0x33</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span>
						 <span class="n">TXHIGHPWRLEVEL_LEVEL2</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_HIPWR</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;5G:TxHighPwrLevel_Level2 (TxPwr=0x0)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&lt;</span> <span class="mh">0x33</span><span class="p">)</span>
			   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&gt;=</span> <span class="mh">0x2b</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span>
						 <span class="n">TXHIGHPWRLEVEL_LEVEL1</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_HIPWR</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;5G:TxHighPwrLevel_Level1 (TxPwr=0x10)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&lt;</span> <span class="mh">0x2b</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span>
						 <span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_HIPWR</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;5G:TxHighPwrLevel_Normal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&gt;=</span>
		    <span class="n">TX_POWER_NEAR_FIELD_THRESH_LVL2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span>
						 <span class="n">TXHIGHPWRLEVEL_LEVEL2</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;TXHIGHPWRLEVEL_LEVEL1 (TxPwr=0x0)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
		    <span class="k">if</span> <span class="p">((</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&lt;</span>
			 <span class="p">(</span><span class="n">TX_POWER_NEAR_FIELD_THRESH_LVL2</span> <span class="o">-</span> <span class="mi">3</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&gt;=</span>
			    <span class="n">TX_POWER_NEAR_FIELD_THRESH_LVL1</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span>
						 <span class="n">TXHIGHPWRLEVEL_LEVEL1</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;TXHIGHPWRLEVEL_LEVEL1 (TxPwr=0x10)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&lt;</span>
			   <span class="p">(</span><span class="n">TX_POWER_NEAR_FIELD_THRESH_LVL1</span> <span class="o">-</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">=</span>
						 <span class="n">TXHIGHPWRLEVEL_NORMAL</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;TXHIGHPWRLEVEL_NORMAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span> <span class="o">!=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">last_dtp_lvl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;PHY_SetTxPowerLevel8192S() Channel = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_channel</span><span class="p">);</span>
		<span class="n">rtl92d_phy_set_txpower_level</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_channel</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">last_dtp_lvl</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dynamic_txhighpower_lvl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_dm_pwdb_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* AP &amp; ADHOC &amp; MESH will return tmp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">mac80211</span><span class="p">.</span><span class="n">opmode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Indicate Rx signal strength to FW. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">useramask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span><span class="p">;</span>

		<span class="n">temp</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="cm">/* fw v12 cmdid 5:use max macid ,for nic ,</span>
<span class="cm">		 * default macid is 0 ,max macid is 1 */</span>
		<span class="n">rtl92d_fill_h2c_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">H2C_RSSI_REPORT</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0x4fe</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">undecorated_smoothed_pwdb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92d_dm_init_edca_turbo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_any_nonbepkts</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_cur_rdlstate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_dm_check_edca_turbo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">rtl_mac</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">static</span> <span class="n">u64</span> <span class="n">last_txok_cnt</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u64</span> <span class="n">last_rxok_cnt</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cur_txok_cnt</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cur_rxok_cnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">edca_be_ul</span> <span class="o">=</span> <span class="mh">0x5ea42b</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">edca_be_dl</span> <span class="o">=</span> <span class="mh">0x5ea42b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">!=</span> <span class="n">MAC80211_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable BEQ TxOP limit configuration in wireless G-mode. */</span>
	<span class="cm">/* To check whether we shall force turn on TXOP configuration. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">disable_framebursting</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">pairwise_enc_algorithm</span> <span class="o">==</span> <span class="n">WEP40_ENCRYPTION</span> <span class="o">||</span>
	    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">pairwise_enc_algorithm</span> <span class="o">==</span> <span class="n">WEP104_ENCRYPTION</span> <span class="o">||</span>
	    <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">.</span><span class="n">pairwise_enc_algorithm</span> <span class="o">==</span> <span class="n">TKIP_ENCRYPTION</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Force TxOP limit to 0x005e for UL. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">edca_be_ul</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">))</span>
			<span class="n">edca_be_ul</span> <span class="o">|=</span> <span class="mh">0x005e0000</span><span class="p">;</span>
		<span class="cm">/* Force TxOP limit to 0x005e for DL. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">edca_be_dl</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">))</span>
			<span class="n">edca_be_dl</span> <span class="o">|=</span> <span class="mh">0x005e0000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_any_nonbepkts</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">disable_framebursting</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cur_txok_cnt</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytesunicast</span> <span class="o">-</span> <span class="n">last_txok_cnt</span><span class="p">;</span>
		<span class="n">cur_rxok_cnt</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxbytesunicast</span> <span class="o">-</span> <span class="n">last_rxok_cnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_rxok_cnt</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">cur_txok_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_cur_rdlstate</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_EDCA_BE_PARAM</span><span class="p">,</span>
						<span class="n">edca_be_dl</span><span class="p">);</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_cur_rdlstate</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_cur_rdlstate</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtl_write_dword</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">REG_EDCA_BE_PARAM</span><span class="p">,</span>
						<span class="n">edca_be_ul</span><span class="p">);</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_cur_rdlstate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">AC0_BE</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HW_VAR_AC_PARAM</span><span class="p">,</span>
						      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">));</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">current_turbo_edca</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">is_any_nonbepkts</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">last_txok_cnt</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytesunicast</span><span class="p">;</span>
	<span class="n">last_rxok_cnt</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxbytesunicast</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_dm_rxgain_tracking_thermalmeter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">index_mapping</span><span class="p">[</span><span class="n">RX_INDEX_MAPPING_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span>
		<span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span>
		<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u4tmp</span><span class="p">;</span>

	<span class="n">u4tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">index_mapping</span><span class="p">[(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">efuse</span><span class="p">.</span><span class="n">eeprom_thermalmeter</span> <span class="o">-</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_rxgain</span><span class="p">)])</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;===&gt; Rx Gain %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">u4tmp</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">RF90_PATH_A</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">num_total_rfpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rtl_set_rfreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="n">BRFREGOFFSETMASK</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">reg_rf3c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0xF000</span><span class="p">)))</span> <span class="o">|</span> <span class="n">u4tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_bandtype_2_4G</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">temp_cckg</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">cck_index_old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">temp_cck</span><span class="p">;</span>

	<span class="cm">/* Query CCK default setting From 0xa24 */</span>
	<span class="n">rtl92d_acquire_cckandrw_pagea_ctl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">);</span>
	<span class="n">temp_cck</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCCK0_TXFILTER2</span><span class="p">,</span>
				 <span class="n">BMASKDWORD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BMASKCCK</span><span class="p">;</span>
	<span class="n">rtl92d_release_cckandrw_pagea_ctl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CCK_TABLE_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_inch14</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp_cck</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cckswing_table_ch14</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">cck_index_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;Initial reg0x%x = 0x%lx, cck_index=0x%x, ch 14 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">RCCK0_TXFILTER2</span><span class="p">,</span> <span class="n">temp_cck</span><span class="p">,</span>
					 <span class="o">*</span><span class="n">cck_index_old</span><span class="p">,</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_inch14</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">temp_cck</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">cckswing_table_ch1ch13</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">cck_index_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;Initial reg0x%x = 0x%lx, cck_index = 0x%x, ch14 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">RCCK0_TXFILTER2</span><span class="p">,</span> <span class="n">temp_cck</span><span class="p">,</span>
					 <span class="o">*</span><span class="n">cck_index_old</span><span class="p">,</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_inch14</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">temp_cckg</span> <span class="o">=</span> <span class="n">temp_cck</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_bandtype_5G</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ofdm_index</span><span class="p">,</span>
			       <span class="n">bool</span> <span class="o">*</span><span class="n">internal_pa</span><span class="p">,</span> <span class="n">u8</span> <span class="n">thermalvalue</span><span class="p">,</span> <span class="n">u8</span> <span class="n">delta</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">rf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">index_mapping</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">INDEX_MAPPING_NUM</span><span class="p">],</span>
			       <span class="n">u8</span> <span class="n">index_mapping_pa</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="n">INDEX_MAPPING_NUM</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">macphymode</span> <span class="o">==</span> <span class="n">DUALMAC_DUALPHY</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">interfaceindex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* MAC 1 5G */</span>
			<span class="o">*</span><span class="n">internal_pa</span> <span class="o">=</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">internal_pa_5g</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">internal_pa</span> <span class="o">=</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">internal_pa_5g</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">internal_pa</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">interfaceindex</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">rf</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_channel</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span>
				<span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_channel</span> <span class="o">&lt;=</span> <span class="mi">165</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">interfaceindex</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">rf</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span>
			<span class="n">offset</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">internal_pa</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="n">INDEX_MAPPING_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">index_mapping_pa</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span>
						    <span class="p">[</span><span class="n">INDEX_MAPPING_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">index</span> <span class="o">=</span>
				     <span class="n">index_mapping_pa</span><span class="p">[</span><span class="n">offset</span><span class="p">][</span><span class="n">delta</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="n">INDEX_MAPPING_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">index</span> <span class="o">=</span>
				   <span class="n">index_mapping</span><span class="p">[</span><span class="n">offset</span><span class="p">][</span><span class="n">INDEX_MAPPING_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">index_mapping</span><span class="p">[</span><span class="n">offset</span><span class="p">][</span><span class="n">delta</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">internal_pa</span> <span class="o">&amp;&amp;</span> <span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="mh">0x12</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span>
						<span class="p">((</span><span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">delta</span> <span class="o">%</span> <span class="mi">2</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">index</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_dm_txpower_tracking_callback_thermalmeter</span><span class="p">(</span>
			<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_hal</span> <span class="o">*</span><span class="n">rtlhal</span> <span class="o">=</span> <span class="n">rtl_hal</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtl_phy</span> <span class="o">*</span><span class="n">rtlphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_efuse</span> <span class="o">*</span><span class="n">rtlefuse</span> <span class="o">=</span> <span class="n">rtl_efuse</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">thermalvalue</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">delta_lck</span><span class="p">,</span> <span class="n">delta_iqk</span><span class="p">,</span> <span class="n">delta_rxgain</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">offset</span><span class="p">,</span> <span class="n">thermalvalue_avg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">thermalvalue_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">internal_pa</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ele_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ele_d</span><span class="p">,</span> <span class="n">temp_cck</span><span class="p">,</span> <span class="n">val_x</span><span class="p">,</span> <span class="n">value32</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val_y</span><span class="p">,</span> <span class="n">ele_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ofdm_index</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">cck_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ofdm_index_old</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">cck_index_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is2t</span> <span class="o">=</span> <span class="n">IS_92D_SINGLEPHY</span><span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ofdm_min_index</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">ofdm_min_index_internal_pa</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">indexforchannel</span> <span class="o">=</span>
	    <span class="n">rtl92d_get_rightchnlplace_for_iqk</span><span class="p">(</span><span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">current_channel</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">index_mapping</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">INDEX_MAPPING_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* 5G, path A/MAC 0, decrease power  */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>	<span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">},</span>
		<span class="cm">/* 5G, path A/MAC 0, increase power  */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>	<span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">},</span>
		<span class="cm">/* 5G, path B/MAC 1, decrease power */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>	<span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">},</span>
		<span class="cm">/* 5G, path B/MAC 1, increase power */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>	<span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">},</span>
		<span class="cm">/* 2.4G, for decreas power */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>	<span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">index_mapping_internal_pa</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="n">INDEX_MAPPING_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* 5G, path A/MAC 0, ch36-64, decrease power  */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>	<span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span>
		<span class="cm">/* 5G, path A/MAC 0, ch36-64, increase power  */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>	<span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">},</span>
		<span class="cm">/* 5G, path A/MAC 0, ch100-165, decrease power  */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">},</span>
		<span class="cm">/* 5G, path A/MAC 0, ch100-165, increase power  */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>	<span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">},</span>
		<span class="cm">/* 5G, path B/MAC 1, ch36-64, decrease power */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>	<span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span>
		<span class="cm">/* 5G, path B/MAC 1, ch36-64, increase power */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>	<span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">},</span>
		<span class="cm">/* 5G, path B/MAC 1, ch100-165, decrease power */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">},</span>
		<span class="cm">/* 5G, path B/MAC 1, ch100-165, increase power */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>	<span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_trackinginit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">thermalvalue</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">rtl_get_rfreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RF90_PATH_A</span><span class="p">,</span> <span class="n">RF_T_METER</span><span class="p">,</span> <span class="mh">0xf800</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;Readback Thermal Meter = 0x%x pre thermal meter 0x%x eeprom_thermalmeter 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">thermalvalue</span><span class="p">,</span>
		 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">);</span>
	<span class="n">rtl92d_phy_ap_calibrate</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">-</span>
				     <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is2t</span><span class="p">)</span>
		<span class="n">rf</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thermalvalue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ele_d</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XATxIQIMBALANCE</span><span class="p">,</span>
				      <span class="n">BMASKDWORD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BMASKOFDM_D</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OFDM_TABLE_SIZE_92D</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ele_d</span> <span class="o">==</span> <span class="p">(</span><span class="n">ofdmswing_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BMASKOFDM_D</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ofdm_index_old</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">;</span>

				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;Initial pathA ele_d reg0x%x = 0x%lx, ofdm_index=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ROFDM0_XATxIQIMBALANCE</span><span class="p">,</span>
					 <span class="n">ele_d</span><span class="p">,</span> <span class="n">ofdm_index_old</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is2t</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ele_d</span> <span class="o">=</span> <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XBTxIQIMBALANCE</span><span class="p">,</span>
					      <span class="n">BMASKDWORD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BMASKOFDM_D</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OFDM_TABLE_SIZE_92D</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ele_d</span> <span class="o">==</span>
				    <span class="p">(</span><span class="n">ofdmswing_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BMASKOFDM_D</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ofdm_index_old</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">;</span>
					<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span>
						 <span class="n">DBG_LOUD</span><span class="p">,</span>
						 <span class="s">&quot;Initial pathB ele_d reg 0x%x = 0x%lx, ofdm_index = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">ROFDM0_XBTxIQIMBALANCE</span><span class="p">,</span> <span class="n">ele_d</span><span class="p">,</span>
						 <span class="n">ofdm_index_old</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_2_4G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl92d_bandtype_2_4G</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_cck</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cck_index_old</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">temp_cck</span> <span class="o">=</span> <span class="mh">0x090e1317</span><span class="p">;</span>
			<span class="n">cck_index_old</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span> <span class="o">=</span>
				 <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_lck</span> <span class="o">=</span> <span class="n">thermalvalue</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_iqk</span> <span class="o">=</span> <span class="n">thermalvalue</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_rxgain</span> <span class="o">=</span>
					 <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ofdm_index_old</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_index</span> <span class="o">=</span> <span class="n">cck_index_old</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">reloadtxpowerindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ofdm_index_old</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_index</span> <span class="o">=</span> <span class="n">cck_index_old</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;reload ofdm index for band switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_avg</span>
			    <span class="p">[</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_avg_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">thermalvalue</span><span class="p">;</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_avg_index</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_avg_index</span> <span class="o">==</span> <span class="n">AVG_THERMAL_NUM</span><span class="p">)</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_avg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AVG_THERMAL_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_avg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">thermalvalue_avg</span> <span class="o">+=</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_avg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">thermalvalue_avg_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thermalvalue_avg_count</span><span class="p">)</span>
			<span class="n">thermalvalue</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">thermalvalue_avg</span> <span class="o">/</span>
					<span class="n">thermalvalue_avg_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">reloadtxpowerindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="o">?</span>
			    <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">-</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="o">:</span>
			    <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span> <span class="o">-</span> <span class="n">thermalvalue</span><span class="p">);</span>
			<span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">reloadtxpowerindex</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">done_txpower</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">done_txpower</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span><span class="p">)</span> <span class="o">?</span>
			    <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">-</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span><span class="p">)</span> <span class="o">:</span>
			    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span> <span class="o">-</span> <span class="n">thermalvalue</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="o">?</span>
			    <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">-</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="o">:</span>
			    <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span> <span class="o">-</span> <span class="n">thermalvalue</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">delta_lck</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_lck</span><span class="p">)</span> <span class="o">?</span>
		    <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">-</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_lck</span><span class="p">)</span> <span class="o">:</span>
		    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_lck</span> <span class="o">-</span> <span class="n">thermalvalue</span><span class="p">);</span>
		<span class="n">delta_iqk</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_iqk</span><span class="p">)</span> <span class="o">?</span>
		    <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">-</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_iqk</span><span class="p">)</span> <span class="o">:</span>
		    <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_iqk</span> <span class="o">-</span> <span class="n">thermalvalue</span><span class="p">);</span>
		<span class="n">delta_rxgain</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_rxgain</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="n">thermalvalue</span> <span class="o">-</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_rxgain</span><span class="p">)</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_rxgain</span> <span class="o">-</span> <span class="n">thermalvalue</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;Readback Thermal Meter = 0x%x pre thermal meter 0x%x eeprom_thermalmeter 0x%x delta 0x%x delta_lck 0x%x delta_iqk 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">thermalvalue</span><span class="p">,</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span><span class="p">,</span>
			 <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">delta_lck</span><span class="p">,</span>
			 <span class="n">delta_iqk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">delta_lck</span> <span class="o">&gt;</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">delta_lck</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">delta_lck</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_lck</span> <span class="o">=</span> <span class="n">thermalvalue</span><span class="p">;</span>
			<span class="n">rtl92d_phy_lc_calibrate</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_track_control</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">done_txpower</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="o">?</span>
			    <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">-</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="o">:</span>
			    <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span> <span class="o">-</span> <span class="n">thermalvalue</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_2_4G</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="n">INDEX_MAPPING_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">index</span> <span class="o">=</span> <span class="n">index_mapping</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span>
						<span class="p">[</span><span class="n">INDEX_MAPPING_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">index</span> <span class="o">=</span> <span class="n">index_mapping</span><span class="p">[</span><span class="n">offset</span><span class="p">][</span><span class="n">delta</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">thermalvalue</span> <span class="o">&gt;</span> <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
						<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">delta</span><span class="p">;</span>
					<span class="n">cck_index</span> <span class="o">-=</span> <span class="n">delta</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
						<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">;</span>
					<span class="n">cck_index</span> <span class="o">+=</span> <span class="n">index</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_5G</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtl92d_bandtype_5G</span><span class="p">(</span><span class="n">rtlhal</span><span class="p">,</span> <span class="n">ofdm_index</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">internal_pa</span><span class="p">,</span> <span class="n">thermalvalue</span><span class="p">,</span>
						   <span class="n">delta</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">rtlefuse</span><span class="p">,</span> <span class="n">rtlpriv</span><span class="p">,</span>
						   <span class="n">rtlphy</span><span class="p">,</span> <span class="n">index_mapping</span><span class="p">,</span>
						   <span class="n">index_mapping_internal_pa</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is2t</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;temp OFDM_A_index=0x%x, OFDM_B_index = 0x%x,cck_index=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_index</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;temp OFDM_A_index=0x%x,cck_index = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">ofdm_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_index</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">OFDM_TABLE_SIZE_92D</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">OFDM_TABLE_SIZE_92D</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ofdm_min_index</span><span class="p">)</span>
					<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ofdm_min_index</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_2_4G</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cck_index</span> <span class="o">&gt;</span> <span class="n">CCK_TABLE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cck_index</span> <span class="o">=</span> <span class="n">CCK_TABLE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">internal_pa</span> <span class="o">||</span>
					   <span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span>
					   <span class="n">BAND_ON_2_4G</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span>
					    <span class="n">ofdm_min_index_internal_pa</span><span class="p">)</span>
						<span class="n">ofdm_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
						     <span class="n">ofdm_min_index_internal_pa</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cck_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cck_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is2t</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;new OFDM_A_index=0x%x, OFDM_B_index = 0x%x, cck_index=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ofdm_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ofdm_index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					 <span class="n">cck_index</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;new OFDM_A_index=0x%x,cck_index = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ofdm_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cck_index</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ele_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">ofdmswing_table</span><span class="p">[(</span><span class="n">u8</span><span class="p">)</span> <span class="n">ofdm_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&amp;</span>
						 <span class="mh">0xFFC00000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">;</span>
			<span class="n">val_x</span> <span class="o">=</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">iqk_matrix_regsetting</span>
						<span class="p">[</span><span class="n">indexforchannel</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">val_y</span> <span class="o">=</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">iqk_matrix_regsetting</span>
						<span class="p">[</span><span class="n">indexforchannel</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val_x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">val_x</span> <span class="o">&amp;</span> <span class="mh">0x00000200</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">val_x</span> <span class="o">=</span> <span class="n">val_x</span> <span class="o">|</span> <span class="mh">0xFFFFFC00</span><span class="p">;</span>
				<span class="n">ele_a</span> <span class="o">=</span>
				    <span class="p">((</span><span class="n">val_x</span> <span class="o">*</span> <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000003FF</span><span class="p">;</span>

				<span class="cm">/* new element C = element D x Y */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">val_y</span> <span class="o">&amp;</span> <span class="mh">0x00000200</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">val_y</span> <span class="o">=</span> <span class="n">val_y</span> <span class="o">|</span> <span class="mh">0xFFFFFC00</span><span class="p">;</span>
				<span class="n">ele_c</span> <span class="o">=</span> <span class="p">((</span><span class="n">val_y</span> <span class="o">*</span> <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000003FF</span><span class="p">;</span>

				<span class="cm">/* wirte new elements A, C, D to regC80 and</span>
<span class="cm">				 * regC94, element B is always 0 */</span>
				<span class="n">value32</span> <span class="o">=</span> <span class="p">(</span><span class="n">ele_d</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">ele_c</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
					  <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ele_a</span><span class="p">;</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XATxIQIMBALANCE</span><span class="p">,</span>
					      <span class="n">BMASKDWORD</span><span class="p">,</span> <span class="n">value32</span><span class="p">);</span>

				<span class="n">value32</span> <span class="o">=</span> <span class="p">(</span><span class="n">ele_c</span> <span class="o">&amp;</span> <span class="mh">0x000003C0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XCTxAFE</span><span class="p">,</span> <span class="n">BMASKH4BITS</span><span class="p">,</span>
					      <span class="n">value32</span><span class="p">);</span>

				<span class="n">value32</span> <span class="o">=</span> <span class="p">((</span><span class="n">val_x</span> <span class="o">*</span> <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_ECCATHRESHOLD</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span>
					      <span class="n">value32</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XATxIQIMBALANCE</span><span class="p">,</span>
					      <span class="n">BMASKDWORD</span><span class="p">,</span>
					      <span class="n">ofdmswing_table</span>
					      <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">ofdm_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]);</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XCTxAFE</span><span class="p">,</span> <span class="n">BMASKH4BITS</span><span class="p">,</span>
					      <span class="mh">0x00</span><span class="p">);</span>
				<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_ECCATHRESHOLD</span><span class="p">,</span>
					      <span class="n">BIT</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;TxPwrTracking for interface %d path A: X = 0x%lx, Y = 0x%lx ele_A = 0x%lx ele_C = 0x%lx ele_D = 0x%lx 0xe94 = 0x%lx 0xe9c = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">interfaceindex</span><span class="p">,</span>
				 <span class="n">val_x</span><span class="p">,</span> <span class="n">val_y</span><span class="p">,</span> <span class="n">ele_a</span><span class="p">,</span> <span class="n">ele_c</span><span class="p">,</span> <span class="n">ele_d</span><span class="p">,</span>
				 <span class="n">val_x</span><span class="p">,</span> <span class="n">val_y</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_2_4G</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Adjust CCK according to IQK result */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">cck_inch14</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa22</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch1ch13</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa23</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch1ch13</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa24</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch1ch13</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa25</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch1ch13</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">3</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa26</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch1ch13</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">4</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa27</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch1ch13</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">5</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa28</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch1ch13</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">6</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa29</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch1ch13</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">7</span><span class="p">]);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa22</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch14</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa23</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch14</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa24</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch14</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa25</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch14</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">3</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa26</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch14</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">4</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa27</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch14</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">5</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa28</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch14</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">6</span><span class="p">]);</span>
					<span class="n">rtl_write_byte</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="mh">0xa29</span><span class="p">,</span>
						       <span class="n">cckswing_table_ch14</span>
						       <span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_index</span><span class="p">][</span><span class="mi">7</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is2t</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ele_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">ofdmswing_table</span><span class="p">[(</span><span class="n">u8</span><span class="p">)</span> <span class="n">ofdm_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&amp;</span>
						<span class="mh">0xFFC00000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">;</span>
				<span class="n">val_x</span> <span class="o">=</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">iqk_matrix_regsetting</span>
						<span class="p">[</span><span class="n">indexforchannel</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
				<span class="n">val_y</span> <span class="o">=</span> <span class="n">rtlphy</span><span class="o">-&gt;</span><span class="n">iqk_matrix_regsetting</span>
						<span class="p">[</span><span class="n">indexforchannel</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val_x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">val_x</span> <span class="o">&amp;</span> <span class="mh">0x00000200</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="cm">/* consider minus */</span>
						<span class="n">val_x</span> <span class="o">=</span> <span class="n">val_x</span> <span class="o">|</span> <span class="mh">0xFFFFFC00</span><span class="p">;</span>
					<span class="n">ele_a</span> <span class="o">=</span> <span class="p">((</span><span class="n">val_x</span> <span class="o">*</span> <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="mh">0x000003FF</span><span class="p">;</span>
					<span class="cm">/* new element C = element D x Y */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">val_y</span> <span class="o">&amp;</span> <span class="mh">0x00000200</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">val_y</span> <span class="o">=</span>
						    <span class="n">val_y</span> <span class="o">|</span> <span class="mh">0xFFFFFC00</span><span class="p">;</span>
					<span class="n">ele_c</span> <span class="o">=</span>
					    <span class="p">((</span><span class="n">val_y</span> <span class="o">*</span>
					      <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00003FF</span><span class="p">;</span>
					<span class="cm">/* write new elements A, C, D to regC88</span>
<span class="cm">					 * and regC9C, element B is always 0</span>
<span class="cm">					 */</span>
					<span class="n">value32</span> <span class="o">=</span> <span class="p">(</span><span class="n">ele_d</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span>
						  <span class="p">((</span><span class="n">ele_c</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
						  <span class="n">ele_a</span><span class="p">;</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						      <span class="n">ROFDM0_XBTxIQIMBALANCE</span><span class="p">,</span>
						      <span class="n">BMASKDWORD</span><span class="p">,</span> <span class="n">value32</span><span class="p">);</span>
					<span class="n">value32</span> <span class="o">=</span> <span class="p">(</span><span class="n">ele_c</span> <span class="o">&amp;</span> <span class="mh">0x000003C0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XDTxAFE</span><span class="p">,</span>
						      <span class="n">BMASKH4BITS</span><span class="p">,</span> <span class="n">value32</span><span class="p">);</span>
					<span class="n">value32</span> <span class="o">=</span> <span class="p">((</span><span class="n">val_x</span> <span class="o">*</span> <span class="n">ele_d</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_ECCATHRESHOLD</span><span class="p">,</span>
						      <span class="n">BIT</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span> <span class="n">value32</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						      <span class="n">ROFDM0_XBTxIQIMBALANCE</span><span class="p">,</span>
						      <span class="n">BMASKDWORD</span><span class="p">,</span>
						      <span class="n">ofdmswing_table</span>
						      <span class="p">[(</span><span class="n">u8</span><span class="p">)</span> <span class="n">ofdm_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]);</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_XDTxAFE</span><span class="p">,</span>
						      <span class="n">BMASKH4BITS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
					<span class="n">rtl_set_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROFDM0_ECCATHRESHOLD</span><span class="p">,</span>
						      <span class="n">BIT</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
					 <span class="s">&quot;TxPwrTracking path B: X = 0x%lx, Y = 0x%lx ele_A = 0x%lx ele_C = 0x%lx ele_D = 0x%lx 0xeb4 = 0x%lx 0xebc = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">val_x</span><span class="p">,</span> <span class="n">val_y</span><span class="p">,</span> <span class="n">ele_a</span><span class="p">,</span> <span class="n">ele_c</span><span class="p">,</span>
					 <span class="n">ele_d</span><span class="p">,</span> <span class="n">val_x</span><span class="p">,</span> <span class="n">val_y</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
				 <span class="s">&quot;TxPwrTracking 0xc80 = 0x%x, 0xc94 = 0x%x RF 0x24 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xc80</span><span class="p">,</span> <span class="n">BMASKDWORD</span><span class="p">),</span>
				 <span class="n">rtl_get_bbreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xc94</span><span class="p">,</span> <span class="n">BMASKDWORD</span><span class="p">),</span>
				 <span class="n">rtl_get_rfreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RF90_PATH_A</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
					       <span class="n">BRFREGOFFSETMASK</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">delta_iqk</span> <span class="o">&gt;</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">delta_iqk</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">delta_iqk</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtl92d_phy_reset_iqk_result</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_iqk</span> <span class="o">=</span> <span class="n">thermalvalue</span><span class="p">;</span>
			<span class="n">rtl92d_phy_iq_calibrate</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta_rxgain</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rtlhal</span><span class="o">-&gt;</span><span class="n">current_bandtype</span> <span class="o">==</span> <span class="n">BAND_ON_5G</span>
		    <span class="o">&amp;&amp;</span> <span class="n">thermalvalue</span> <span class="o">&lt;=</span> <span class="n">rtlefuse</span><span class="o">-&gt;</span><span class="n">eeprom_thermalmeter</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue_rxgain</span> <span class="o">=</span> <span class="n">thermalvalue</span><span class="p">;</span>
			<span class="n">rtl92d_dm_rxgain_tracking_thermalmeter</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_track_control</span><span class="p">)</span>
			<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">thermalvalue</span> <span class="o">=</span> <span class="n">thermalvalue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="s">&quot;&lt;===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl92d_dm_initialize_txpower_tracking</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_tracking</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_trackinginit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_track_control</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
		 <span class="s">&quot;pMgntInfo-&gt;txpower_tracking = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_tracking</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92d_dm_check_txpower_tracking_thermal_meter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">tm_trigger</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">txpower_tracking</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tm_trigger</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl_set_rfreg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RF90_PATH_A</span><span class="p">,</span> <span class="n">RF_T_METER</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">BIT</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;Trigger 92S Thermal Meter!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tm_trigger</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">rtlpriv</span><span class="p">,</span> <span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="n">DBG_LOUD</span><span class="p">,</span>
			 <span class="s">&quot;Schedule TxPowerTracking direct call!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtl92d_dm_txpower_tracking_callback_thermalmeter</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">tm_trigger</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92d_dm_init_rate_adaptive_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rate_adaptive</span> <span class="o">*</span><span class="n">ra</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">ra</span><span class="p">);</span>

	<span class="n">ra</span><span class="o">-&gt;</span><span class="n">ratr_state</span> <span class="o">=</span> <span class="n">DM_RATR_STA_INIT</span><span class="p">;</span>
	<span class="n">ra</span><span class="o">-&gt;</span><span class="n">pre_ratr_state</span> <span class="o">=</span> <span class="n">DM_RATR_STA_INIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_type</span> <span class="o">==</span> <span class="n">DM_TYPE_BYDRIVER</span><span class="p">)</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">useramask</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">useramask</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92d_dm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_priv</span> <span class="o">*</span><span class="n">rtlpriv</span> <span class="o">=</span> <span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">rtlpriv</span><span class="o">-&gt;</span><span class="n">dm</span><span class="p">.</span><span class="n">dm_type</span> <span class="o">=</span> <span class="n">DM_TYPE_BYDRIVER</span><span class="p">;</span>
	<span class="n">rtl92d_dm_diginit</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl92d_dm_init_dynamic_txpower</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl92d_dm_init_edca_turbo</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl92d_dm_init_rate_adaptive_mask</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">rtl92d_dm_initialize_txpower_tracking</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl92d_dm_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_ps_ctl</span> <span class="o">*</span><span class="n">ppsc</span> <span class="o">=</span> <span class="n">rtl_psc</span><span class="p">(</span><span class="n">rtl_priv</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>
	<span class="n">bool</span> <span class="n">fw_current_inpsmode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fwps_awake</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* 1. RF is OFF. (No need to do DM.)</span>
<span class="cm">	 * 2. Fw is under power saving mode for FwLPS.</span>
<span class="cm">	 *    (Prevent from SW/FW I/O racing.)</span>
<span class="cm">	 * 3. IPS workitem is scheduled. (Prevent from IPS sequence</span>
<span class="cm">	 *    to be swapped with DM.</span>
<span class="cm">	 * 4. RFChangeInProgress is TRUE.</span>
<span class="cm">	 *    (Prevent from broken by IPS/HW/SW Rf off.) */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfpwr_state</span> <span class="o">==</span> <span class="n">ERFON</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="o">!</span><span class="n">fw_current_inpsmode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">fwps_awake</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ppsc</span><span class="o">-&gt;</span><span class="n">rfchange_inprogress</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtl92d_dm_pwdb_monitor</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtl92d_dm_false_alarm_counter_statistics</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtl92d_dm_find_minimum_rssi</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">rtl92d_dm_dig</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="cm">/* rtl92d_dm_dynamic_bb_powersaving(hw); */</span>
		<span class="n">rtl92d_dm_dynamic_txpower</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="cm">/* rtl92d_dm_check_txpower_tracking_thermal_meter(hw); */</span>
		<span class="cm">/* rtl92d_dm_refresh_rate_adaptive_mask(hw); */</span>
		<span class="cm">/* rtl92d_dm_interrupt_migration(hw); */</span>
		<span class="n">rtl92d_dm_check_edca_turbo</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
