<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › orinoco › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* main.c - (formerly known as dldwd_cs.c, orinoco_cs.c and orinoco.c)</span>
<span class="cm"> *</span>
<span class="cm"> * A driver for Hermes or Prism 2 chipset based PCMCIA wireless</span>
<span class="cm"> * adaptors, with Lucent/Agere, Intersil or Symbol firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * Current maintainers (as of 29 September 2003) are:</span>
<span class="cm"> *	Pavel Roskin &lt;proski AT gnu.org&gt;</span>
<span class="cm"> * and	David Gibson &lt;hermes AT gibson.dropbear.id.au&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright David Gibson, IBM Corporation 2001-2003.</span>
<span class="cm"> * Copyright (C) 2000 David Gibson, Linuxcare Australia.</span>
<span class="cm"> *	With some help from :</span>
<span class="cm"> * Copyright (C) 2001 Jean Tourrilhes, HP Labs</span>
<span class="cm"> * Copyright (C) 2001 Benjamin Herrenschmidt</span>
<span class="cm"> *</span>
<span class="cm"> * Based on dummy_cs.c 1.27 2000/06/12 21:27:25</span>
<span class="cm"> *</span>
<span class="cm"> * Portions based on wvlan_cs.c 1.0.6, Copyright Andreas Neuhaus &lt;andy</span>
<span class="cm"> * AT fasta.fh-dortmund.de&gt;</span>
<span class="cm"> *      http://www.stud.fh-dortmund.de/~andy/wvlan/</span>
<span class="cm"> *</span>
<span class="cm"> * The contents of this file are subject to the Mozilla Public License</span>
<span class="cm"> * Version 1.1 (the &quot;License&quot;); you may not use this file except in</span>
<span class="cm"> * compliance with the License. You may obtain a copy of the License</span>
<span class="cm"> * at http://www.mozilla.org/MPL/</span>
<span class="cm"> *</span>
<span class="cm"> * Software distributed under the License is distributed on an &quot;AS IS&quot;</span>
<span class="cm"> * basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</span>
<span class="cm"> * the License for the specific language governing rights and</span>
<span class="cm"> * limitations under the License.</span>
<span class="cm"> *</span>
<span class="cm"> * The initial developer of the original code is David A. Hinds</span>
<span class="cm"> * &lt;dahinds AT users.sourceforge.net&gt;.  Portions created by David</span>
<span class="cm"> * A. Hinds are Copyright (C) 1999 David A. Hinds.  All Rights</span>
<span class="cm"> * Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, the contents of this file may be used under the</span>
<span class="cm"> * terms of the GNU General Public License version 2 (the &quot;GPL&quot;), in</span>
<span class="cm"> * which case the provisions of the GPL are applicable instead of the</span>
<span class="cm"> * above.  If you wish to allow the use of your version of this file</span>
<span class="cm"> * only under the terms of the GPL and not to allow others to use your</span>
<span class="cm"> * version of this file under the MPL, indicate your decision by</span>
<span class="cm"> * deleting the provisions above and replace them with the notice and</span>
<span class="cm"> * other provisions required by the GPL.  If you do not delete the</span>
<span class="cm"> * provisions above, a recipient may use your version of this file</span>
<span class="cm"> * under either the MPL or the GPL.  */</span>

<span class="cm">/*</span>
<span class="cm"> * TODO</span>
<span class="cm"> *	o Handle de-encapsulation within network layer, provide 802.11</span>
<span class="cm"> *	  headers (patch from Thomas &#39;Dent&#39; Mirlacher)</span>
<span class="cm"> *	o Fix possible races in SPY handling.</span>
<span class="cm"> *	o Disconnect wireless extensions from fundamental configuration.</span>
<span class="cm"> *	o (maybe) Software WEP support (patch from Stano Meduna).</span>
<span class="cm"> *	o (maybe) Use multiple Tx buffers - driver handling queue</span>
<span class="cm"> *	  rather than firmware.</span>
<span class="cm"> */</span>

<span class="cm">/* Locking and synchronization:</span>
<span class="cm"> *</span>
<span class="cm"> * The basic principle is that everything is serialized through a</span>
<span class="cm"> * single spinlock, priv-&gt;lock.  The lock is used in user, bh and irq</span>
<span class="cm"> * context, so when taken outside hardirq context it should always be</span>
<span class="cm"> * taken with interrupts disabled.  The lock protects both the</span>
<span class="cm"> * hardware and the struct orinoco_private.</span>
<span class="cm"> *</span>
<span class="cm"> * Another flag, priv-&gt;hw_unavailable indicates that the hardware is</span>
<span class="cm"> * unavailable for an extended period of time (e.g. suspended, or in</span>
<span class="cm"> * the middle of a hard reset).  This flag is protected by the</span>
<span class="cm"> * spinlock.  All code which touches the hardware should check the</span>
<span class="cm"> * flag after taking the lock, and if it is set, give up on whatever</span>
<span class="cm"> * they are doing and drop the lock again.  The orinoco_lock()</span>
<span class="cm"> * function handles this (it unlocks and returns -EBUSY if</span>
<span class="cm"> * hw_unavailable is non-zero).</span>
<span class="cm"> */</span>

<span class="cp">#define DRIVER_NAME &quot;orinoco&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/suspend.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &lt;net/iw_handler.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>

<span class="cp">#include &quot;hermes_rid.h&quot;</span>
<span class="cp">#include &quot;hermes_dld.h&quot;</span>
<span class="cp">#include &quot;hw.h&quot;</span>
<span class="cp">#include &quot;scan.h&quot;</span>
<span class="cp">#include &quot;mic.h&quot;</span>
<span class="cp">#include &quot;fw.h&quot;</span>
<span class="cp">#include &quot;wext.h&quot;</span>
<span class="cp">#include &quot;cfg.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>

<span class="cp">#include &quot;orinoco.h&quot;</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Module information                                               */</span>
<span class="cm">/********************************************************************/</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Pavel Roskin &lt;proski@gnu.org&gt; &amp; &quot;</span>
	      <span class="s">&quot;David Gibson &lt;hermes@gibson.dropbear.id.au&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for Lucent Orinoco, Prism II based &quot;</span>
		   <span class="s">&quot;and similar wireless cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual MPL/GPL&quot;</span><span class="p">);</span>

<span class="cm">/* Level of debugging. Used in the macros in orinoco.h */</span>
<span class="cp">#ifdef ORINOCO_DEBUG</span>
<span class="kt">int</span> <span class="n">orinoco_debug</span> <span class="o">=</span> <span class="n">ORINOCO_DEBUG</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_debug</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">orinoco_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">orinoco_debug</span><span class="p">,</span> <span class="s">&quot;Debug level&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">suppress_linkstatus</span><span class="p">;</span> <span class="cm">/* = 0 */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">suppress_linkstatus</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">suppress_linkstatus</span><span class="p">,</span> <span class="s">&quot;Don&#39;t log link status changes&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ignore_disconnect</span><span class="p">;</span> <span class="cm">/* = 0 */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ignore_disconnect</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ignore_disconnect</span><span class="p">,</span>
		 <span class="s">&quot;Don&#39;t report lost link to the network layer&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">force_monitor</span><span class="p">;</span> <span class="cm">/* = 0 */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force_monitor</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force_monitor</span><span class="p">,</span> <span class="s">&quot;Allow monitor mode for all firmware versions&quot;</span><span class="p">);</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Internal constants                                               */</span>
<span class="cm">/********************************************************************/</span>

<span class="cm">/* 802.2 LLC/SNAP header used for Ethernet encapsulation over 802.11 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">encaps_hdr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
<span class="cp">#define ENCAPS_OVERHEAD		(sizeof(encaps_hdr) + 2)</span>

<span class="cp">#define ORINOCO_MIN_MTU		256</span>
<span class="cp">#define ORINOCO_MAX_MTU		(IEEE80211_MAX_DATA_LEN - ENCAPS_OVERHEAD)</span>

<span class="cp">#define MAX_IRQLOOPS_PER_IRQ	10</span>
<span class="cp">#define MAX_IRQLOOPS_PER_JIFFY	(20000 / HZ)	</span><span class="cm">/* Based on a guestimate of</span>
<span class="cm">						 * how many events the</span>
<span class="cm">						 * device could</span>
<span class="cm">						 * legitimately generate */</span><span class="cp"></span>

<span class="cp">#define DUMMY_FID		0xFFFF</span>

<span class="cm">/*#define MAX_MULTICAST(priv)	(priv-&gt;firmware_type == FIRMWARE_TYPE_AGERE ? \</span>
<span class="cm">  HERMES_MAX_MULTICAST : 0)*/</span>
<span class="cp">#define MAX_MULTICAST(priv)	(HERMES_MAX_MULTICAST)</span>

<span class="cp">#define ORINOCO_INTEN		(HERMES_EV_RX | HERMES_EV_ALLOC \</span>
<span class="cp">				 | HERMES_EV_TX | HERMES_EV_TXEXC \</span>
<span class="cp">				 | HERMES_EV_WTERR | HERMES_EV_INFO \</span>
<span class="cp">				 | HERMES_EV_INFDROP)</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Data types                                                       */</span>
<span class="cm">/********************************************************************/</span>

<span class="cm">/* Beginning of the Tx descriptor, used in TxExc handling */</span>
<span class="k">struct</span> <span class="n">hermes_txexc_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes_tx_descriptor</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">frame_ctl</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">duration_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr1</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Rx frame header except compatibility 802.3 header */</span>
<span class="k">struct</span> <span class="n">hermes_rx_descriptor</span> <span class="p">{</span>
	<span class="cm">/* Control */</span>
	<span class="n">__le16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">time</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">silence</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">signal</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rxflow</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">reserved</span><span class="p">;</span>

	<span class="cm">/* 802.11 header */</span>
	<span class="n">__le16</span> <span class="n">frame_ctl</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">duration_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr1</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">addr2</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">addr3</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">seq_ctl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr4</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="cm">/* Data length */</span>
	<span class="n">__le16</span> <span class="n">data_len</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">orinoco_rx_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes_rx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">orinoco_scan_data</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Function prototypes                                              */</span>
<span class="cm">/********************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__orinoco_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__orinoco_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__orinoco_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__orinoco_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Internal helper functions                                        */</span>
<span class="cm">/********************************************************************/</span>

<span class="kt">void</span> <span class="nf">set_port_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">createibss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prefer_port3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">createibss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibss_port</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">createibss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MONITOR</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">createibss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid priv-&gt;iw_mode in set_port_type()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Device methods                                                   */</span>
<span class="cm">/********************************************************************/</span>

<span class="kt">int</span> <span class="nf">orinoco_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__orinoco_up</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_open</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">orinoco_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We mustn&#39;t use orinoco_lock() here, because we need to be</span>
<span class="cm">	   able to close the interface even if hw_unavailable is set</span>
<span class="cm">	   (e.g. as we&#39;re released after a PC Card removal) */</span>
	<span class="n">orinoco_lock_irq</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__orinoco_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">orinoco_unlock_irq</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_stop</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">orinoco_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_get_stats</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">orinoco_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: orinoco_set_multicast_list() &quot;</span>
		       <span class="s">&quot;called when hw_unavailable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__orinoco_set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_set_multicast_list</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">orinoco_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">ORINOCO_MIN_MTU</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">ORINOCO_MAX_MTU</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* MTU + encapsulation + header length */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">+</span> <span class="n">ENCAPS_OVERHEAD</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span><span class="p">))</span> <span class="o">&gt;</span>
	     <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nicbuf_size</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_change_mtu</span><span class="p">);</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Tx path                                                          */</span>
<span class="cm">/********************************************************************/</span>

<span class="cm">/* Add encapsulation and MIC to the existing SKB.</span>
<span class="cm"> * The main xmit routine will then send the whole lot to the card.</span>
<span class="cm"> * Need 8 bytes headroom</span>
<span class="cm"> * Need 8 bytes tailroom</span>
<span class="cm"> *</span>
<span class="cm"> *                          With encapsulated ethernet II frame</span>
<span class="cm"> *                          --------</span>
<span class="cm"> *                          803.3 header (14 bytes)</span>
<span class="cm"> *                           dst[6]</span>
<span class="cm"> * --------                  src[6]</span>
<span class="cm"> * 803.3 header (14 bytes)   len[2]</span>
<span class="cm"> *  dst[6]                  803.2 header (8 bytes)</span>
<span class="cm"> *  src[6]                   encaps[6]</span>
<span class="cm"> *  len[2] &lt;- leave alone -&gt; len[2]</span>
<span class="cm"> * --------                 -------- &lt;-- 0</span>
<span class="cm"> * Payload                  Payload</span>
<span class="cm"> * ...                      ...</span>
<span class="cm"> *</span>
<span class="cm"> * --------                 --------</span>
<span class="cm"> *                          MIC (8 bytes)</span>
<span class="cm"> *                          --------</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 on success, -ENOMEM on error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">orinoco_process_xmit_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="o">*</span><span class="n">tx_control</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="o">*</span><span class="n">mic_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_tkip_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_mic</span><span class="p">;</span>

	<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_tkip_key</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span><span class="p">].</span><span class="n">key</span><span class="p">;</span>

	<span class="n">do_mic</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span> <span class="o">==</span> <span class="n">ORINOCO_ALG_TKIP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_mic</span><span class="p">)</span>
		<span class="o">*</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span> <span class="o">&lt;&lt;</span> <span class="n">HERMES_MIC_KEY_ID_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">HERMES_TXCTRL_MIC</span><span class="p">;</span>

	<span class="n">eh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Encapsulate Ethernet-II frames */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Ethernet-II frame */</span>
		<span class="k">struct</span> <span class="n">header_struct</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ethhdr</span> <span class="n">eth</span><span class="p">;</span>	<span class="cm">/* 802.3 header */</span>
			<span class="n">u8</span> <span class="n">encap</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>		<span class="cm">/* 802.2 header */</span>
		<span class="p">}</span> <span class="n">__packed</span> <span class="n">hdr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">encaps_hdr</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ENCAPS_OVERHEAD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;%s: Not enough headroom for 802.2 headers %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Fill in new header */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">.</span><span class="n">eth</span><span class="p">,</span> <span class="n">eh</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">encap</span><span class="p">,</span> <span class="n">encaps_hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">encaps_hdr</span><span class="p">));</span>

		<span class="cm">/* Make room for the new header, and copy it in */</span>
		<span class="n">eh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ENCAPS_OVERHEAD</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate Michael MIC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_mic</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">mic</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mic_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="cm">/* Have to write to an even address, so copy the spare</span>
<span class="cm">		 * byte across */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">mic</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">mic</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">orinoco_mic</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_tfm_mic</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">tx_mic</span><span class="p">,</span>
			    <span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="mi">0</span> <span class="cm">/* priority */</span><span class="p">,</span>
			    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">,</span>
			    <span class="n">len</span><span class="p">,</span> <span class="n">mic</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_process_xmit_skb</span><span class="p">);</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">orinoco_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txfid</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_control</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mic_buf</span><span class="p">[</span><span class="n">MICHAEL_MIC_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Tx on stopped device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Tx while transmitter busy!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: orinoco_xmit() called while hw_unavailable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Oops, the firmware hasn&#39;t established a connection,</span>
<span class="cm">		   silently drop the packet (this seems to be the</span>
<span class="cm">		   safest approach). */</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check packet length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_HLEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">tx_control</span> <span class="o">=</span> <span class="n">HERMES_TXCTRL_TX_OK</span> <span class="o">|</span> <span class="n">HERMES_TXCTRL_TX_EX</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_process_xmit_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_control</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">mic_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_alt_txcntl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* WPA enabled firmwares have tx_cntl at the end of</span>
<span class="cm">		 * the 802.11 header.  So write zeroed descriptor and</span>
<span class="cm">		 * 802.11 header at the same time</span>
<span class="cm">		 */</span>
		<span class="kt">char</span> <span class="n">desc</span><span class="p">[</span><span class="n">HERMES_802_3_OFFSET</span><span class="p">];</span>
		<span class="n">__le16</span> <span class="o">*</span><span class="n">txcntl</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">[</span><span class="n">HERMES_TXCNTL2_OFFSET</span><span class="p">];</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">desc</span><span class="p">));</span>

		<span class="o">*</span><span class="n">txcntl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tx_control</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bap_pwrite</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span>
					  <span class="n">txfid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d writing Tx &quot;</span>
				       <span class="s">&quot;descriptor to BAP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">busy</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hermes_tx_descriptor</span> <span class="n">desc</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">desc</span><span class="p">));</span>

		<span class="n">desc</span><span class="p">.</span><span class="n">tx_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tx_control</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bap_pwrite</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span>
					  <span class="n">txfid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d writing Tx &quot;</span>
				       <span class="s">&quot;descriptor to BAP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">busy</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Clear the 802.11 header and data length fields - some</span>
<span class="cm">		 * firmwares (e.g. Lucent/Agere 8.xx) appear to get confused</span>
<span class="cm">		 * if this isn&#39;t done. */</span>
		<span class="n">hermes_clear_words</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HERMES_DATA0</span><span class="p">,</span>
				   <span class="n">HERMES_802_3_OFFSET</span> <span class="o">-</span> <span class="n">HERMES_802_11_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bap_pwrite</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				  <span class="n">txfid</span><span class="p">,</span> <span class="n">HERMES_802_3_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d writing packet to BAP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">busy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_control</span> <span class="o">&amp;</span> <span class="n">HERMES_TXCTRL_MIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">HERMES_802_3_OFFSET</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">MICHAEL_MIC_LEN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">offset</span><span class="o">--</span><span class="p">;</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bap_pwrite</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mic_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">len</span><span class="p">,</span>
					  <span class="n">txfid</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d writing MIC to BAP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">busy</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Finally, we actually initiate the send */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cmd_wait</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HERMES_CMD_TX</span> <span class="o">|</span> <span class="n">HERMES_CMD_RECL</span><span class="p">,</span>
				<span class="n">txfid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d transmitting packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">busy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">HERMES_802_3_OFFSET</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">ok</span><span class="p">;</span>

 <span class="nl">drop:</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>

 <span class="nl">ok:</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

 <span class="nl">busy:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__orinoco_ev_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">fid</span> <span class="o">=</span> <span class="n">hermes_read_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ALLOCFID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fid</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fid</span> <span class="o">!=</span> <span class="n">DUMMY_FID</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Allocate event on unexpected fid (%04X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hermes_write_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ALLOCFID</span><span class="p">,</span> <span class="n">DUMMY_FID</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__orinoco_ev_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hermes_write_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TXCOMPLFID</span><span class="p">,</span> <span class="n">DUMMY_FID</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__orinoco_ev_txexc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fid</span> <span class="o">=</span> <span class="n">hermes_read_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TXCOMPLFID</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes_txexc_data</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fid</span> <span class="o">==</span> <span class="n">DUMMY_FID</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* Nothing&#39;s really happened */</span>

	<span class="cm">/* Read part of the frame header - we need status and addr1 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bap_pread</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IRQ_BAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hermes_txexc_data</span><span class="p">),</span>
				 <span class="n">fid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hermes_write_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TXCOMPLFID</span><span class="p">,</span> <span class="n">DUMMY_FID</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unable to read descriptor on Tx error &quot;</span>
		       <span class="s">&quot;(FID=%04X error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Tx error, err %d (FID=%04X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	      <span class="n">err</span><span class="p">,</span> <span class="n">fid</span><span class="p">);</span>

	<span class="cm">/* We produce a TXDROP event only for retry or lifetime</span>
<span class="cm">	 * exceeded, because that&#39;s the only status that really mean</span>
<span class="cm">	 * that this particular node went away.</span>
<span class="cm">	 * Other errors means that *we* screwed up. - Jean II */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">desc</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HERMES_TXSTAT_RETRYERR</span> <span class="o">|</span> <span class="n">HERMES_TXSTAT_AGEDERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">iwreq_data</span>	<span class="n">wrqu</span><span class="p">;</span>

		<span class="cm">/* Copy 802.11 dest address.</span>
<span class="cm">		 * We use the 802.11 header because the frame may</span>
<span class="cm">		 * not be 802.3 or may be mangled...</span>
<span class="cm">		 * In Ad-Hoc mode, it will be the node address.</span>
<span class="cm">		 * In managed mode, it will be most likely the AP addr</span>
<span class="cm">		 * User space will figure out how to convert it to</span>
<span class="cm">		 * whatever it needs (IP address or else).</span>
<span class="cm">		 * - Jean II */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>

		<span class="cm">/* Send event to user space */</span>
		<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVTXDROP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">orinoco_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Tx timeout! &quot;</span>
	       <span class="s">&quot;ALLOCFID=%04x, TXCOMPLFID=%04x, EVSTAT=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hermes_read_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ALLOCFID</span><span class="p">),</span>
	       <span class="n">hermes_read_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TXCOMPLFID</span><span class="p">),</span> <span class="n">hermes_read_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">EVSTAT</span><span class="p">));</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_tx_timeout</span><span class="p">);</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Rx path (data frames)                                            */</span>
<span class="cm">/********************************************************************/</span>

<span class="cm">/* Does the frame have a SNAP header indicating it should be</span>
<span class="cm"> * de-encapsulated to Ethernet-II? */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_ethersnap</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">_hdr</span><span class="p">;</span>

	<span class="cm">/* We de-encapsulate all packets which, a) have SNAP headers</span>
<span class="cm">	 * (i.e. SSAP=DSAP=0xaa and CTRL=0x3 in the 802.2 LLC header</span>
<span class="cm">	 * and where b) the OUI of the SNAP header is 00:00:00 or</span>
<span class="cm">	 * 00:00:f8 - we need both because different APs appear to use</span>
<span class="cm">	 * different OUIs for some reason */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encaps_hdr</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">hdr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf8</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">orinoco_spy_gather</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">noise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_quality</span> <span class="n">wstats</span><span class="p">;</span>
	<span class="n">wstats</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span> <span class="o">-</span> <span class="mh">0x95</span><span class="p">;</span>
	<span class="n">wstats</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span> <span class="o">-</span> <span class="mh">0x95</span><span class="p">;</span>
	<span class="n">wstats</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">noise</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">level</span> <span class="o">-</span> <span class="n">noise</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wstats</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_ALL_UPDATED</span> <span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
	<span class="cm">/* Update spy records */</span>
	<span class="n">wireless_spy_update</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wstats</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">orinoco_stat_gather</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">hermes_rx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Using spy support with lots of Rx packets, like in an</span>
<span class="cm">	 * infrastructure (AP), will really slow down everything, because</span>
<span class="cm">	 * the MAC address must be compared to each entry of the spy list.</span>
<span class="cm">	 * If the user really asks for it (set some address in the</span>
<span class="cm">	 * spy list), we do it, but he will pay the price.</span>
<span class="cm">	 * Note that to get here, you need both WIRELESS_SPY</span>
<span class="cm">	 * compiled in AND some addresses in the list !!!</span>
<span class="cm">	 */</span>
	<span class="cm">/* Note : gcc will optimise the whole section away if</span>
<span class="cm">	 * WIRELESS_SPY is not defined... - Jean II */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SPY_NUMBER</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">orinoco_spy_gather</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span>
				   <span class="n">desc</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">silence</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * orinoco_rx_monitor - handle received monitor frames.</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> *	dev		network device</span>
<span class="cm"> *	rxfid		received FID</span>
<span class="cm"> *	desc		rx descriptor of the frame</span>
<span class="cm"> *</span>
<span class="cm"> * Call context: interrupt</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">orinoco_rx_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rxfid</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">hermes_rx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>	<span class="cm">/* return full header by default */</span>
	<span class="n">u32</span> <span class="n">datalen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>

	<span class="cm">/* Determine the size of the header and the data */</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FTYPE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_FTYPE_DATA</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">))</span>
			<span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">datalen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_FTYPE_MGMT</span>:
		<span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">datalen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_FTYPE_CTL</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_STYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IEEE80211_STYPE_PSPOLL</span>:
		<span class="k">case</span> <span class="n">IEEE80211_STYPE_RTS</span>:
		<span class="k">case</span> <span class="n">IEEE80211_STYPE_CFEND</span>:
		<span class="k">case</span> <span class="n">IEEE80211_STYPE_CFENDACK</span>:
			<span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEEE80211_STYPE_CTS</span>:
		<span class="k">case</span> <span class="n">IEEE80211_STYPE_ACK</span>:
			<span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Unknown frame type */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* sanity check the length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">&gt;</span> <span class="n">IEEE80211_MAX_DATA_LEN</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: oversized monitor frame, &quot;</span>
		       <span class="s">&quot;data length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">update_stats</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">hdrlen</span> <span class="o">+</span> <span class="n">datalen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Cannot allocate skb for monitor frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">update_stats</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy the 802.11 header to the skb */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">),</span> <span class="n">hdrlen</span><span class="p">);</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* If any, copy the data from the card to the skb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bap_pread</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IRQ_BAP</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">datalen</span><span class="p">),</span>
					 <span class="n">ALIGN</span><span class="p">(</span><span class="n">datalen</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">rxfid</span><span class="p">,</span>
					 <span class="n">HERMES_802_2_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: error %d reading monitor frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">drop:</span>
	<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
 <span class="nl">update_stats:</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__orinoco_ev_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">wstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rxfid</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes_rx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">orinoco_rx_data</span> <span class="o">*</span><span class="n">rx_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;%s: Can&#39;t allocate space for RX descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">update_stats</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rxfid</span> <span class="o">=</span> <span class="n">hermes_read_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RXFID</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bap_pread</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IRQ_BAP</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">),</span>
				 <span class="n">rxfid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: error %d reading Rx descriptor. &quot;</span>
		       <span class="s">&quot;Frame dropped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">update_stats</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HERMES_RXSTAT_BADCRC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Bad CRC on Rx. Frame dropped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">update_stats</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handle frames in monitor mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">orinoco_rx_monitor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rxfid</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HERMES_RXSTAT_UNDECRYPTABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Undecryptable frame on Rx. Frame dropped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">code</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">update_stats</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>

	<span class="cm">/* Sanity checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* No for even an 802.2 LLC header */</span>
		<span class="cm">/* At least on Symbol firmware with PCF we get quite a</span>
<span class="cm">		   lot of these legitimately - Poll frames with no</span>
<span class="cm">		   data. */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">IEEE80211_MAX_DATA_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Oversized frame received (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">update_stats</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Payload size does not include Michael MIC. Increase payload</span>
<span class="cm">	 * size to read it together with the data. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HERMES_RXSTAT_MIC</span><span class="p">)</span>
		<span class="n">length</span> <span class="o">+=</span> <span class="n">MICHAEL_MIC_LEN</span><span class="p">;</span>

	<span class="cm">/* We need space for the packet data itself, plus an ethernet</span>
<span class="cm">	   header, plus 2 bytes so we can align the IP header on a</span>
<span class="cm">	   32bit boundary, plus 1 byte so we can read in odd length</span>
<span class="cm">	   packets from the card, which has an IO granularity of 16</span>
<span class="cm">	   bits */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Can&#39;t allocate skb for Rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">update_stats</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We&#39;ll prepend the header, so reserve space for it.  The worst</span>
<span class="cm">	   case is no decapsulation, when 802.3 header is prepended and</span>
<span class="cm">	   nothing is removed.  2 is for aligning the IP header.  */</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bap_pread</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IRQ_BAP</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">),</span>
				 <span class="n">ALIGN</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">rxfid</span><span class="p">,</span>
				 <span class="n">HERMES_802_2_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: error %d reading frame. &quot;</span>
		       <span class="s">&quot;Frame dropped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add desc and skb to rx queue */</span>
	<span class="n">rx_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rx_data</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">rx_data</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">rx_data</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">drop:</span>
	<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">update_stats:</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__orinoco_ev_rx</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">orinoco_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">hermes_rx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">,</span> <span class="n">fc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>

	<span class="cm">/* Calculate and check MIC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HERMES_RXSTAT_MIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">orinoco_tkip_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">key_id</span> <span class="o">=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HERMES_RXSTAT_MIC_KEY_ID</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			      <span class="n">HERMES_MIC_KEY_ID_SHIFT</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">mic</span><span class="p">[</span><span class="n">MICHAEL_MIC_LEN</span><span class="p">];</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">rxmic</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr3</span> <span class="o">:</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">;</span>

		<span class="cm">/* Extract Michael MIC from payload */</span>
		<span class="n">rxmic</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">MICHAEL_MIC_LEN</span><span class="p">;</span>

		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">MICHAEL_MIC_LEN</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">MICHAEL_MIC_LEN</span><span class="p">;</span>

		<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_tkip_key</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">key_id</span><span class="p">].</span><span class="n">key</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Received encrypted frame from &quot;</span>
			       <span class="s">&quot;%pM using key %i, but key is not installed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">key_id</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">orinoco_mic</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tfm_mic</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">rx_mic</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="cm">/* priority or QoS? */</span>
			    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mic</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mic</span><span class="p">,</span> <span class="n">rxmic</span><span class="p">,</span>
			   <span class="n">MICHAEL_MIC_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">iw_michaelmicfailure</span> <span class="n">wxmic</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: &quot;</span>
			       <span class="s">&quot;Invalid Michael MIC in data frame from %pM, &quot;</span>
			       <span class="s">&quot;using key %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">key_id</span><span class="p">);</span>

			<span class="cm">/* TODO: update stats */</span>

			<span class="cm">/* Notify userspace */</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wxmic</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wxmic</span><span class="p">));</span>
			<span class="n">wxmic</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">key_id</span> <span class="o">&amp;</span> <span class="n">IW_MICFAILURE_KEY_ID</span><span class="p">;</span>
			<span class="n">wxmic</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">IW_MICFAILURE_GROUP</span> <span class="o">:</span> <span class="n">IW_MICFAILURE_PAIRWISE</span><span class="p">;</span>
			<span class="n">wxmic</span><span class="p">.</span><span class="n">src_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">wxmic</span><span class="p">.</span><span class="n">src_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">orinoco_hw_get_tkip_iv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">key_id</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">wxmic</span><span class="p">.</span><span class="n">tsc</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
			<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wxmic</span><span class="p">);</span>
			<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVMICHAELMICFAILURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span>
					    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">wxmic</span><span class="p">);</span>

			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Handle decapsulation</span>
<span class="cm">	 * In most cases, the firmware tell us about SNAP frames.</span>
<span class="cm">	 * For some reason, the SNAP frames sent by LinkSys APs</span>
<span class="cm">	 * are not properly recognised by most firmwares.</span>
<span class="cm">	 * So, check ourselves */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="n">ENCAPS_OVERHEAD</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HERMES_RXSTAT_MSGTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">HERMES_RXSTAT_1042</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HERMES_RXSTAT_MSGTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">HERMES_RXSTAT_TUNNEL</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">is_ethersnap</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* These indicate a SNAP within 802.2 LLC within</span>
<span class="cm">		   802.11 frame which we&#39;ll need to de-encapsulate to</span>
<span class="cm">		   the original EthernetII frame. */</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
						<span class="n">ETH_HLEN</span> <span class="o">-</span> <span class="n">ENCAPS_OVERHEAD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* 802.3 frame - prepend 802.3 header as is */</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">)</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>

	<span class="cm">/* Process the wireless stats if needed */</span>
	<span class="n">orinoco_stat_gather</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="cm">/* Pass the packet to the networking stack */</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>

 <span class="nl">drop:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">orinoco_rx_isr_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">orinoco_rx_data</span> <span class="o">*</span><span class="n">rx_data</span><span class="p">,</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes_rx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* orinoco_rx requires the driver lock, and we also need to</span>
<span class="cm">	 * protect priv-&gt;rx_list, so just hold the lock over the</span>
<span class="cm">	 * lot.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If orinoco_lock fails, we&#39;ve unplugged the card. In this</span>
<span class="cm">	 * case just abort. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* extract desc and skb from queue */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">rx_data</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">rx_data</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">rx_data</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rx_data</span><span class="p">);</span>

		<span class="n">orinoco_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Rx path (info frames)                                            */</span>
<span class="cm">/********************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_linkstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">suppress_linkstatus</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HERMES_LINKSTATUS_NOT_CONNECTED</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Not Connected&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HERMES_LINKSTATUS_CONNECTED</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Connected&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HERMES_LINKSTATUS_DISCONNECTED</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Disconnected&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HERMES_LINKSTATUS_AP_CHANGE</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;AP Changed&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HERMES_LINKSTATUS_AP_OUT_OF_RANGE</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;AP Out of Range&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HERMES_LINKSTATUS_AP_IN_RANGE</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;AP In Range&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HERMES_LINKSTATUS_ASSOC_FAILED</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Association Failed&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: New link status: %s (%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Search scan results for requested BSSID, join it if found */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">orinoco_join_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">orinoco_private</span><span class="p">,</span> <span class="n">join_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">join_req</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
		<span class="n">__le16</span> <span class="n">channel</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__packed</span> <span class="n">req</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">atom_len</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">prism2_scan_apinfo</span><span class="p">,</span> <span class="n">atim</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">prism2_scan_apinfo</span> <span class="o">*</span><span class="n">atom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Allocate buffer for scan results */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_SCAN_LEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_lock</span><span class="p">;</span>

	<span class="cm">/* Sanity checks in case user changed something in the meantime */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid_fixed</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_essid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Read scan results from the firmware */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				<span class="n">HERMES_RID_SCANRESULTSTABLE</span><span class="p">,</span>
				<span class="n">MAX_SCAN_LEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Cannot read scan results</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">HERMES_RECLEN_TO_BYTES</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Go through the scan results looking for the channel of the AP</span>
<span class="cm">	 * we were requested to join */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">atom_len</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">atom_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atom</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">prism2_scan_apinfo</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atom</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Requested AP not found in scan results</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">atom</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>	<span class="cm">/* both are little-endian */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">HERMES_WRITE_RECORD</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CNFJOINREQUEST</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error issuing join request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

 <span class="nl">fail_lock:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Send new BSSID to userspace */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">orinoco_send_bssid_wevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CURRENTBSSID</span><span class="p">,</span>
				<span class="n">ETH_ALEN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>

	<span class="cm">/* Send event to user space */</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">orinoco_send_assocreqie_wevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">88</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wpa</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CURRENT_ASSOC_REQ_INFO</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ie</span> <span class="o">=</span> <span class="n">orinoco_get_wpa_ie</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rem</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ie</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">rem</span><span class="p">)</span>
			<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">rem</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
			<span class="cm">/* Send event to user space */</span>
			<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVASSOCREQIE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="n">ie</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">orinoco_send_assocrespie_wevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">88</span><span class="p">];</span> <span class="cm">/* TODO: verify max size or IW_GENERIC_IE_MAX */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wpa</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				<span class="n">HERMES_RID_CURRENT_ASSOC_RESP_INFO</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ie</span> <span class="o">=</span> <span class="n">orinoco_get_wpa_ie</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rem</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ie</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">rem</span><span class="p">)</span>
			<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">rem</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
			<span class="cm">/* Send event to user space */</span>
			<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVASSOCRESPIE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="n">ie</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">orinoco_send_wevents</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">orinoco_private</span><span class="p">,</span> <span class="n">wevent_work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">orinoco_send_assocreqie_wevent</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">orinoco_send_assocrespie_wevent</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">orinoco_send_bssid_wevent</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qbuf_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_scan_data</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">sd</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sd</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to alloc memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">process_scan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qabort_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_scan_data</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">sd</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sd</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to alloc memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* Abort */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">process_scan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">orinoco_process_scan_results</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">orinoco_private</span><span class="p">,</span> <span class="n">process_scan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">orinoco_scan_data</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">HERMES_INQ_CHANNELINFO</span><span class="p">)</span>
				<span class="n">orinoco_add_extscan_result</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">orinoco_add_hostscan_results</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Either abort or complete the scan */</span>
			<span class="n">orinoco_scan_done</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__orinoco_ev_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">infofid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">type</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__packed</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* This is an answer to an INQUIRE command that we did earlier,</span>
<span class="cm">	 * or an information &quot;event&quot; generated by the card</span>
<span class="cm">	 * The controller return to us a pseudo frame containing</span>
<span class="cm">	 * the information in question - Jean II */</span>
	<span class="n">infofid</span> <span class="o">=</span> <span class="n">hermes_read_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">INFOFID</span><span class="p">);</span>

	<span class="cm">/* Read the info frame header - don&#39;t try too hard */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bap_pread</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IRQ_BAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">),</span>
				 <span class="n">infofid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: error %d reading info frame. &quot;</span>
		       <span class="s">&quot;Frame dropped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">HERMES_RECLEN_TO_BYTES</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">len</span><span class="p">));</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HERMES_INQ_TALLIES</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hermes_tallies_frame</span> <span class="n">tallies</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">wstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tallies</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Tallies frame too long (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tallies</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bap_pread</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IRQ_BAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tallies</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					 <span class="n">infofid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Increment our various counters */</span>
		<span class="cm">/* wstats-&gt;discard.nwid - no wrong BSSID stuff */</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">code</span> <span class="o">+=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tallies</span><span class="p">.</span><span class="n">RxWEPUndecryptable</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tallies</span><span class="p">))</span>
			<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">code</span> <span class="o">+=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tallies</span><span class="p">.</span><span class="n">RxDiscards_WEPICVError</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tallies</span><span class="p">.</span><span class="n">RxDiscards_WEPExcluded</span><span class="p">);</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span> <span class="o">+=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tallies</span><span class="p">.</span><span class="n">TxDiscardsWrongSA</span><span class="p">);</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">fragment</span> <span class="o">+=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tallies</span><span class="p">.</span><span class="n">RxMsgInBadMsgFragments</span><span class="p">);</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">retries</span> <span class="o">+=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tallies</span><span class="p">.</span><span class="n">TxRetryLimitExceeded</span><span class="p">);</span>
		<span class="cm">/* wstats-&gt;miss.beacon - no match */</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HERMES_INQ_LINKSTATUS</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hermes_linkstatus</span> <span class="n">linkstatus</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">newstatus</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">connected</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">linkstatus</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unexpected size for linkstatus frame (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bap_pread</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IRQ_BAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linkstatus</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					 <span class="n">infofid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">newstatus</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">linkstatus</span><span class="p">.</span><span class="n">linkstatus</span><span class="p">);</span>

		<span class="cm">/* Symbol firmware uses &quot;out of range&quot; to signal that</span>
<span class="cm">		 * the hostscan frame can be requested.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newstatus</span> <span class="o">==</span> <span class="n">HERMES_LINKSTATUS_AP_OUT_OF_RANGE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span> <span class="o">==</span> <span class="n">FIRMWARE_TYPE_SYMBOL</span> <span class="o">&amp;&amp;</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_hostscan</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hermes_inquire</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HERMES_INQ_HOSTSCAN_SYMBOL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">connected</span> <span class="o">=</span> <span class="p">(</span><span class="n">newstatus</span> <span class="o">==</span> <span class="n">HERMES_LINKSTATUS_CONNECTED</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">newstatus</span> <span class="o">==</span> <span class="n">HERMES_LINKSTATUS_AP_CHANGE</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">newstatus</span> <span class="o">==</span> <span class="n">HERMES_LINKSTATUS_AP_IN_RANGE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignore_disconnect</span><span class="p">)</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">newstatus</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_linkstatus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_linkstatus</span> <span class="o">=</span> <span class="n">newstatus</span><span class="p">;</span>
			<span class="n">print_linkstatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">newstatus</span><span class="p">);</span>
			<span class="cm">/* The info frame contains only one word which is the</span>
<span class="cm">			 * status (see hermes.h). The status is pretty boring</span>
<span class="cm">			 * in itself, that&#39;s why we export the new BSSID...</span>
<span class="cm">			 * Jean II */</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wevent_work</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HERMES_INQ_SCAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid_fixed</span> <span class="o">&amp;&amp;</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span> <span class="o">==</span> <span class="n">FIRMWARE_TYPE_INTERSIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">join_work</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">HERMES_INQ_HOSTSCAN</span>:
	<span class="k">case</span> <span class="n">HERMES_INQ_HOSTSCAN_SYMBOL</span>: <span class="p">{</span>
		<span class="cm">/* Result of a scanning. Contains information about</span>
<span class="cm">		 * cells in the vicinity - Jean II */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

		<span class="cm">/* Sanity check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Scan results too large (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">qabort_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Allocate buffer for results */</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No memory, so can&#39;t printk()... */</span>
			<span class="n">qabort_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Read scan data */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bap_pread</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IRQ_BAP</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					 <span class="n">infofid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">qabort_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifdef ORINOCO_DEBUG</span>
		<span class="p">{</span>
			<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Scan result [%02X&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;:%02X&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* ORINOCO_DEBUG */</span><span class="cp"></span>

		<span class="n">qbuf_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HERMES_INQ_CHANNELINFO</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">agere_ext_scan_info</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Got chaninfo without scan, &quot;</span>
			       <span class="s">&quot;len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* An empty result indicates that the scan is complete */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qbuf_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Sanity check */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">agere_ext_scan_info</span><span class="p">,</span>
					   <span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Drop this result now so we don&#39;t have to</span>
<span class="cm">			 * keep checking later */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;%s: Ext scan results too short (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bss</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Read scan data */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bap_pread</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IRQ_BAP</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bss</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					 <span class="n">infofid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">qbuf_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">HERMES_INQ_SEC_STAT_AGERE</span>:
		<span class="cm">/* Security status (Agere specific) */</span>
		<span class="cm">/* Ignore this frame for now */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span> <span class="o">==</span> <span class="n">FIRMWARE_TYPE_AGERE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Unknown information frame received: &quot;</span>
		       <span class="s">&quot;type 0x%04x, length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="cm">/* We don&#39;t actually do anything about it */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__orinoco_ev_info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__orinoco_ev_infdrop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Information frame lost.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Internal hardware control routines                               */</span>
<span class="cm">/********************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__orinoco_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* just to make sure */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__orinoco_commit</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d configuring card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fire things up again */</span>
	<span class="n">hermes_set_irqmask</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ORINOCO_INTEN</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_enable_port</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d enabling MAC port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__orinoco_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_unavailable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">broken_disableport</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_disable_port</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Some firmwares (e.g. Intersil 1.3.x) seem</span>
<span class="cm">				 * to have problems disabling the port, oh</span>
<span class="cm">				 * well, too bad. */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Error %d disabling MAC port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">broken_disableport</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">hermes_set_irqmask</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hermes_write_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">orinoco_scan_done</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* firmware will have to reassociate */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_linkstatus</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_reinit_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_fw_download</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_download</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_fw_download</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_hw_allocate_fid</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__orinoco_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">promisc</span><span class="p">,</span> <span class="n">mc_count</span><span class="p">;</span>

	<span class="cm">/* The Hermes doesn&#39;t seem to have an allmulti mode, so we go</span>
<span class="cm">	 * into promiscuous mode and let the upper levels deal. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_MULTICAST</span><span class="p">(</span><span class="n">priv</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">promisc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">promisc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mc_count</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__orinoco_hw_set_multicast_list</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">mc_count</span><span class="p">,</span> <span class="n">promisc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This must be called from user context, without locks held - use</span>
<span class="cm"> * schedule_work() */</span>
<span class="kt">void</span> <span class="nf">orinoco_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">orinoco_private</span><span class="p">,</span> <span class="n">reset_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* When the hardware becomes available again, whatever</span>
<span class="cm">		 * detects that is responsible for re-initializing</span>
<span class="cm">		 * it. So no need for anything further */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Shut off interrupts.  Depending on what state the hardware</span>
<span class="cm">	 * is in, this might not work, but we&#39;ll try anyway */</span>
	<span class="n">hermes_set_irqmask</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hermes_write_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_unavailable</span><span class="o">++</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_linkstatus</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="cm">/* firmware will have to reassociate */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Scanning support: Notify scan cancellation */</span>
	<span class="n">orinoco_scan_done</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hard_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hard_reset</span><span class="p">)(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: orinoco_reset: Error %d &quot;</span>
			       <span class="s">&quot;performing hard reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">disable</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_reinit_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: orinoco_reset: Error %d re-initializing firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This has to be called from user context */</span>
	<span class="n">orinoco_lock_irq</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_unavailable</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* priv-&gt;open or priv-&gt;hw_unavailable might have changed while</span>
<span class="cm">	 * we dropped the lock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_unavailable</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__orinoco_up</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: orinoco_reset: Error %d reenabling card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">orinoco_unlock_irq</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
 <span class="nl">disable:</span>
	<span class="n">hermes_set_irqmask</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Device has been disabled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__orinoco_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If we&#39;ve called commit, we are reconfiguring or bringing the</span>
<span class="cm">	 * interface up. Maintaining countermeasures across this would</span>
<span class="cm">	 * be confusing, so note that we&#39;ve disabled them. The port will</span>
<span class="cm">	 * be enabled later in orinoco_commit or __orinoco_up. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tkip_cm_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_hw_program_rids</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* FIXME: what about netif_tx_lock */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">__orinoco_set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Ensures configuration changes are applied. May result in a reset.</span>
<span class="cm"> * The caller should hold priv-&gt;lock</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">orinoco_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">broken_disableport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_disable_port</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unable to disable port &quot;</span>
		       <span class="s">&quot;while reconfiguring card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">broken_disableport</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__orinoco_commit</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unable to reconfigure card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_enable_port</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unable to enable port while reconfiguring card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Resetting instead...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Interrupt handler                                                */</span>
<span class="cm">/********************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__orinoco_ev_tick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: TICK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__orinoco_ev_wterr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This seems to happen a fair bit under load, but ignoring it</span>
<span class="cm">	   seems to work fine...*/</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: MAC controller error (WTERR). Ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">orinoco_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">MAX_IRQLOOPS_PER_IRQ</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">evstat</span><span class="p">,</span> <span class="n">events</span><span class="p">;</span>
	<span class="cm">/* These are used to detect a runaway interrupt situation.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If we get more than MAX_IRQLOOPS_PER_JIFFY iterations in a jiffy,</span>
<span class="cm">	 * we panic and shut down the hardware</span>
<span class="cm">	 */</span>
	<span class="cm">/* jiffies value the last time we were called */</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">last_irq_jiffy</span><span class="p">;</span> <span class="cm">/* = 0 */</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">loops_this_jiffy</span><span class="p">;</span> <span class="cm">/* = 0 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If hw is unavailable - we don&#39;t know if the irq was</span>
<span class="cm">		 * for us or not */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">evstat</span> <span class="o">=</span> <span class="n">hermes_read_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">EVSTAT</span><span class="p">);</span>
	<span class="n">events</span> <span class="o">=</span> <span class="n">evstat</span> <span class="o">&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">inten</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">!=</span> <span class="n">last_irq_jiffy</span><span class="p">)</span>
		<span class="n">loops_this_jiffy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">last_irq_jiffy</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">loops_this_jiffy</span> <span class="o">&gt;</span> <span class="n">MAX_IRQLOOPS_PER_JIFFY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: IRQ handler is looping too &quot;</span>
			       <span class="s">&quot;much! Resetting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="cm">/* Disable interrupts for now */</span>
			<span class="n">hermes_set_irqmask</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check the card hasn&#39;t been removed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hermes_present</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;orinoco_interrupt(): card removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">HERMES_EV_TICK</span><span class="p">)</span>
			<span class="n">__orinoco_ev_tick</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">HERMES_EV_WTERR</span><span class="p">)</span>
			<span class="n">__orinoco_ev_wterr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">HERMES_EV_INFDROP</span><span class="p">)</span>
			<span class="n">__orinoco_ev_infdrop</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">HERMES_EV_INFO</span><span class="p">)</span>
			<span class="n">__orinoco_ev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">HERMES_EV_RX</span><span class="p">)</span>
			<span class="n">__orinoco_ev_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">HERMES_EV_TXEXC</span><span class="p">)</span>
			<span class="n">__orinoco_ev_txexc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">HERMES_EV_TX</span><span class="p">)</span>
			<span class="n">__orinoco_ev_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">HERMES_EV_ALLOC</span><span class="p">)</span>
			<span class="n">__orinoco_ev_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

		<span class="n">hermes_write_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">evstat</span><span class="p">);</span>

		<span class="n">evstat</span> <span class="o">=</span> <span class="n">hermes_read_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">EVSTAT</span><span class="p">);</span>
		<span class="n">events</span> <span class="o">=</span> <span class="n">evstat</span> <span class="o">&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">inten</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_interrupt</span><span class="p">);</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Power management                                                 */</span>
<span class="cm">/********************************************************************/</span>
<span class="cp">#if defined(CONFIG_PM_SLEEP) &amp;&amp; !defined(CONFIG_HERMES_CACHE_FW_ON_INIT)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_pm_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">notifier</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pm_event</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">notifier</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">orinoco_private</span><span class="p">,</span>
						    <span class="n">pm_notifier</span><span class="p">);</span>

	<span class="cm">/* All we need to do is cache the firmware before suspend, and</span>
<span class="cm">	 * release it when we come out.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Only need to do this if we&#39;re downloading firmware. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_fw_download</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pm_event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_HIBERNATION_PREPARE</span>:
	<span class="k">case</span> <span class="n">PM_SUSPEND_PREPARE</span>:
		<span class="n">orinoco_cache_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PM_POST_RESTORE</span>:
		<span class="cm">/* Restore from hibernation failed. We need to clean</span>
<span class="cm">		 * up in exactly the same way, so fall through. */</span>
	<span class="k">case</span> <span class="n">PM_POST_HIBERNATION</span>:
	<span class="k">case</span> <span class="n">PM_POST_SUSPEND</span>:
		<span class="n">orinoco_uncache_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PM_RESTORE_PREPARE</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">orinoco_register_pm_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_notifier</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">orinoco_pm_notifier</span><span class="p">;</span>
	<span class="n">register_pm_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_notifier</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">orinoco_unregister_pm_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_pm_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_notifier</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !PM_SLEEP || HERMES_CACHE_FW_ON_INIT */</span><span class="cp"></span>
<span class="cp">#define orinoco_register_pm_notifier(priv) do { } while (0)</span>
<span class="cp">#define orinoco_unregister_pm_notifier(priv) do { } while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Initialization                                                   */</span>
<span class="cm">/********************************************************************/</span>

<span class="kt">int</span> <span class="nf">orinoco_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">priv_to_wiphy</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* No need to lock, the hw_unavailable flag is already set in</span>
<span class="cm">	 * alloc_orinocodev() */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nicbuf_size</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_FRAME_LEN</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">;</span>

	<span class="cm">/* Initialize the firmware */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize firmware (err = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">determine_fw_capabilities</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Incompatible firmware, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_fw_download</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_HERMES_CACHE_FW_ON_INIT</span>
		<span class="n">orinoco_cache_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_download</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_fw_download</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Check firmware version again */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">determine_fw_capabilities</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Incompatible firmware, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_port3</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ad-hoc demo mode supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_ibss</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IEEE standard IBSS ad-hoc mode supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wep</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;WEP supported, %s-bit key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_big_wep</span> <span class="o">?</span> <span class="s">&quot;104&quot;</span> <span class="o">:</span> <span class="s">&quot;40&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wpa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;WPA-PSK supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_mic_init</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to setup MIC crypto algorithm. &quot;</span>
				<span class="s">&quot;Disabling WPA support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_hw_read_card_settings</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_hw_allocate_fid</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate NIC buffer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up the default configuration */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>
	<span class="cm">/* By default use IEEE/IBSS ad-hoc mode if we have it */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prefer_port3</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_port3</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_ibss</span><span class="p">);</span>
	<span class="n">set_port_type</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* use firmware default */</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">promiscuous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span> <span class="o">=</span> <span class="n">ORINOCO_ALG_NONE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tkip_cm_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">key_mgmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_wiphy_register</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make the hardware available, as long as it hasn&#39;t been</span>
<span class="cm">	 * removed elsewhere (e.g. by PCMCIA hot unplug) */</span>
	<span class="n">orinoco_lock_irq</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_unavailable</span><span class="o">--</span><span class="p">;</span>
	<span class="n">orinoco_unlock_irq</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_init</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">orinoco_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">orinoco_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">orinoco_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">orinoco_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">orinoco_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">orinoco_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">orinoco_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">orinoco_get_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Allocate private data.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver has a number of structures associated with it</span>
<span class="cm"> *  netdev - Net device structure for each network interface</span>
<span class="cm"> *  wiphy - structure associated with wireless phy</span>
<span class="cm"> *  wireless_dev (wdev) - structure for each wireless interface</span>
<span class="cm"> *  hw - structure for hermes chip info</span>
<span class="cm"> *  card - card specific structure for use by the card driver</span>
<span class="cm"> *         (airport, orinoco_cs)</span>
<span class="cm"> *  priv - orinoco private data</span>
<span class="cm"> *  device - generic linux device structure</span>
<span class="cm"> *</span>
<span class="cm"> *  +---------+    +---------+</span>
<span class="cm"> *  |  wiphy  |    | netdev  |</span>
<span class="cm"> *  | +-------+    | +-------+</span>
<span class="cm"> *  | | priv  |    | | wdev  |</span>
<span class="cm"> *  | | +-----+    +-+-------+</span>
<span class="cm"> *  | | | hw  |</span>
<span class="cm"> *  | +-+-----+</span>
<span class="cm"> *  | | card  |</span>
<span class="cm"> *  +-+-------+</span>
<span class="cm"> *</span>
<span class="cm"> * priv has a link to netdev and device</span>
<span class="cm"> * wdev has a link to wiphy</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">orinoco_private</span>
<span class="o">*</span><span class="nf">alloc_orinocodev</span><span class="p">(</span><span class="kt">int</span> <span class="n">sizeof_card</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">hard_reset</span><span class="p">)(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="p">),</span>
		  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">stop_fw</span><span class="p">)(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="cm">/* allocate wiphy</span>
<span class="cm">	 * NOTE: We only support a single virtual interface</span>
<span class="cm">	 *       but this may change when monitor mode is added</span>
<span class="cm">	 */</span>
	<span class="n">wiphy</span> <span class="o">=</span> <span class="n">wiphy_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">orinoco_cfg_ops</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span><span class="p">)</span> <span class="o">+</span> <span class="n">sizeof_card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wiphy</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sizeof_card</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span>
				      <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">orinoco_wiphy_init</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

<span class="cp">#ifdef WIRELESS_SPY</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">.</span><span class="n">spy_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Set up default callbacks */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hard_reset</span> <span class="o">=</span> <span class="n">hard_reset</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_fw</span> <span class="o">=</span> <span class="n">stop_fw</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_unavailable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* orinoco_init() must clear this</span>
<span class="cm">				   * before anything else touches the</span>
<span class="cm">				   * hardware */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">,</span> <span class="n">orinoco_reset</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">join_work</span><span class="p">,</span> <span class="n">orinoco_join_ap</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wevent_work</span><span class="p">,</span> <span class="n">orinoco_send_wevents</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">,</span> <span class="n">orinoco_rx_isr_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">priv</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_list</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">process_scan</span><span class="p">,</span> <span class="n">orinoco_process_scan_results</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_linkstatus</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_HERMES_CACHE_FW_ON_INIT) || defined(CONFIG_PM_SLEEP)</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cached_pri_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cached_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Register PM notifiers */</span>
	<span class="n">orinoco_register_pm_notifier</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">priv</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">alloc_orinocodev</span><span class="p">);</span>

<span class="cm">/* We can only support a single interface. We provide a separate</span>
<span class="cm"> * function to set it up to distinguish between hardware</span>
<span class="cm"> * initialisation and interface setup.</span>
<span class="cm"> *</span>
<span class="cm"> * The base_addr and irq parameters are passed on to netdev for use</span>
<span class="cm"> * with SIOCGIFMAP.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">orinoco_if_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base_addr</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">priv_to_wiphy</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wireless_dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Initialise wireless_dev */</span>
	<span class="n">wdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wiphy</span><span class="p">;</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>

	<span class="cm">/* Setup / override net_device fields */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span> <span class="o">=</span> <span class="n">wdev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span> <span class="cm">/* 1 second timeout */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">orinoco_handler_def</span><span class="p">;</span>
<span class="cp">#ifdef WIRELESS_SPY</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* Default to standard ops if not set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">orinoco_netdev_ops</span><span class="p">;</span>

	<span class="cm">/* we use the default eth_mac_addr for setting the MAC addr */</span>

	<span class="cm">/* Reserve space in skb for the SNAP header */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">needed_headroom</span> <span class="o">=</span> <span class="n">ENCAPS_OVERHEAD</span><span class="p">;</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">base_addr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Report what we&#39;ve done */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Registerred interface %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_if_add</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">orinoco_if_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_if_del</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">free_orinocodev</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">priv_to_wiphy</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">orinoco_rx_data</span> <span class="o">*</span><span class="n">rx_data</span><span class="p">,</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">orinoco_scan_data</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="o">*</span><span class="n">sdtemp</span><span class="p">;</span>

	<span class="n">wiphy_unregister</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="cm">/* If the tasklet is scheduled when we call tasklet_kill it</span>
<span class="cm">	 * will run one final time. However the tasklet will only</span>
<span class="cm">	 * drain priv-&gt;rx_list if the hw is still available. */</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">);</span>

	<span class="cm">/* Explicitly drain priv-&gt;rx_list */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">rx_data</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rx_data</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rx_data</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rx_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">process_scan</span><span class="p">);</span>
	<span class="cm">/* Explicitly drain priv-&gt;scan_list */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">sdtemp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">orinoco_unregister_pm_notifier</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">orinoco_uncache_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">);</span>
	<span class="n">orinoco_mic_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">wiphy_free</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">free_orinocodev</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">orinoco_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_reinit_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d re-initializing firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_unavailable</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_unavailable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__orinoco_up</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d restarting card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_up</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">orinoco_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__orinoco_down</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Error %d downing interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_unavailable</span><span class="o">++</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">orinoco_down</span><span class="p">);</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Module initialization                                            */</span>
<span class="cm">/********************************************************************/</span>

<span class="cm">/* Can&#39;t be declared &quot;const&quot; or the whole __initdata section will</span>
<span class="cm"> * become const */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot; &quot;</span> <span class="n">DRIVER_VERSION</span>
	<span class="s">&quot; (David Gibson &lt;hermes@gibson.dropbear.id.au&gt;, &quot;</span>
	<span class="s">&quot;Pavel Roskin &lt;proski@gnu.org&gt;, et al)&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_orinoco</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_orinoco</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_orinoco</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_orinoco</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
