<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › orinoco › hermes.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>hermes.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* hermes.h</span>
<span class="cm"> *</span>
<span class="cm"> * Driver core for the &quot;Hermes&quot; wireless MAC controller, as used in</span>
<span class="cm"> * the Lucent Orinoco and Cabletron RoamAbout cards. It should also</span>
<span class="cm"> * work on the hfa3841 and hfa3842 MAC controller chips used in the</span>
<span class="cm"> * Prism I &amp; II chipsets.</span>
<span class="cm"> *</span>
<span class="cm"> * This is not a complete driver, just low-level access routines for</span>
<span class="cm"> * the MAC controller itself.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the prism2 driver from Absolute Value Systems&#39; linux-wlan</span>
<span class="cm"> * project, the Linux wvlan_cs driver, Lucent&#39;s HCF-Light</span>
<span class="cm"> * (wvlan_hcf.c) library, and the NetBSD wireless driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000, David Gibson, Linuxcare Australia.</span>
<span class="cm"> * (C) Copyright David Gibson, IBM Corp. 2001-2003.</span>
<span class="cm"> *</span>
<span class="cm"> * Portions taken from hfa384x.h.</span>
<span class="cm"> * Copyright (C) 1999 AbsoluteValue Systems, Inc. All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This file distributed under the GPL, version 2.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _HERMES_H</span>
<span class="cp">#define _HERMES_H</span>

<span class="cm">/* Notes on locking:</span>
<span class="cm"> *</span>
<span class="cm"> * As a module of low level hardware access routines, there is no</span>
<span class="cm"> * locking. Users of this module should ensure that they serialize</span>
<span class="cm"> * access to the hermes structure, and to the hardware</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Limits and constants</span>
<span class="cm"> */</span>
<span class="cp">#define		HERMES_ALLOC_LEN_MIN		(4)</span>
<span class="cp">#define		HERMES_ALLOC_LEN_MAX		(2400)</span>
<span class="cp">#define		HERMES_LTV_LEN_MAX		(34)</span>
<span class="cp">#define		HERMES_BAP_DATALEN_MAX		(4096)</span>
<span class="cp">#define		HERMES_BAP_OFFSET_MAX		(4096)</span>
<span class="cp">#define		HERMES_PORTID_MAX		(7)</span>
<span class="cp">#define		HERMES_NUMPORTS_MAX		(HERMES_PORTID_MAX + 1)</span>
<span class="cp">#define		HERMES_PDR_LEN_MAX		(260)	</span><span class="cm">/* in bytes, from EK */</span><span class="cp"></span>
<span class="cp">#define		HERMES_PDA_RECS_MAX		(200)	</span><span class="cm">/* a guess */</span><span class="cp"></span>
<span class="cp">#define		HERMES_PDA_LEN_MAX		(1024)	</span><span class="cm">/* in bytes, from EK */</span><span class="cp"></span>
<span class="cp">#define		HERMES_SCANRESULT_MAX		(35)</span>
<span class="cp">#define		HERMES_CHINFORESULT_MAX		(8)</span>
<span class="cp">#define		HERMES_MAX_MULTICAST		(16)</span>
<span class="cp">#define		HERMES_MAGIC			(0x7d1f)</span>

<span class="cm">/*</span>
<span class="cm"> * Hermes register offsets</span>
<span class="cm"> */</span>
<span class="cp">#define		HERMES_CMD			(0x00)</span>
<span class="cp">#define		HERMES_PARAM0			(0x02)</span>
<span class="cp">#define		HERMES_PARAM1			(0x04)</span>
<span class="cp">#define		HERMES_PARAM2			(0x06)</span>
<span class="cp">#define		HERMES_STATUS			(0x08)</span>
<span class="cp">#define		HERMES_RESP0			(0x0A)</span>
<span class="cp">#define		HERMES_RESP1			(0x0C)</span>
<span class="cp">#define		HERMES_RESP2			(0x0E)</span>
<span class="cp">#define		HERMES_INFOFID			(0x10)</span>
<span class="cp">#define		HERMES_RXFID			(0x20)</span>
<span class="cp">#define		HERMES_ALLOCFID			(0x22)</span>
<span class="cp">#define		HERMES_TXCOMPLFID		(0x24)</span>
<span class="cp">#define		HERMES_SELECT0			(0x18)</span>
<span class="cp">#define		HERMES_OFFSET0			(0x1C)</span>
<span class="cp">#define		HERMES_DATA0			(0x36)</span>
<span class="cp">#define		HERMES_SELECT1			(0x1A)</span>
<span class="cp">#define		HERMES_OFFSET1			(0x1E)</span>
<span class="cp">#define		HERMES_DATA1			(0x38)</span>
<span class="cp">#define		HERMES_EVSTAT			(0x30)</span>
<span class="cp">#define		HERMES_INTEN			(0x32)</span>
<span class="cp">#define		HERMES_EVACK			(0x34)</span>
<span class="cp">#define		HERMES_CONTROL			(0x14)</span>
<span class="cp">#define		HERMES_SWSUPPORT0		(0x28)</span>
<span class="cp">#define		HERMES_SWSUPPORT1		(0x2A)</span>
<span class="cp">#define		HERMES_SWSUPPORT2		(0x2C)</span>
<span class="cp">#define		HERMES_AUXPAGE			(0x3A)</span>
<span class="cp">#define		HERMES_AUXOFFSET		(0x3C)</span>
<span class="cp">#define		HERMES_AUXDATA			(0x3E)</span>

<span class="cm">/*</span>
<span class="cm"> * CMD register bitmasks</span>
<span class="cm"> */</span>
<span class="cp">#define		HERMES_CMD_BUSY			(0x8000)</span>
<span class="cp">#define		HERMES_CMD_AINFO		(0x7f00)</span>
<span class="cp">#define		HERMES_CMD_MACPORT		(0x0700)</span>
<span class="cp">#define		HERMES_CMD_RECL			(0x0100)</span>
<span class="cp">#define		HERMES_CMD_WRITE		(0x0100)</span>
<span class="cp">#define		HERMES_CMD_PROGMODE		(0x0300)</span>
<span class="cp">#define		HERMES_CMD_CMDCODE		(0x003f)</span>

<span class="cm">/*</span>
<span class="cm"> * STATUS register bitmasks</span>
<span class="cm"> */</span>
<span class="cp">#define		HERMES_STATUS_RESULT		(0x7f00)</span>
<span class="cp">#define		HERMES_STATUS_CMDCODE		(0x003f)</span>

<span class="cm">/*</span>
<span class="cm"> * OFFSET register bitmasks</span>
<span class="cm"> */</span>
<span class="cp">#define		HERMES_OFFSET_BUSY		(0x8000)</span>
<span class="cp">#define		HERMES_OFFSET_ERR		(0x4000)</span>
<span class="cp">#define		HERMES_OFFSET_DATAOFF		(0x0ffe)</span>

<span class="cm">/*</span>
<span class="cm"> * Event register bitmasks (INTEN, EVSTAT, EVACK)</span>
<span class="cm"> */</span>
<span class="cp">#define		HERMES_EV_TICK			(0x8000)</span>
<span class="cp">#define		HERMES_EV_WTERR			(0x4000)</span>
<span class="cp">#define		HERMES_EV_INFDROP		(0x2000)</span>
<span class="cp">#define		HERMES_EV_INFO			(0x0080)</span>
<span class="cp">#define		HERMES_EV_DTIM			(0x0020)</span>
<span class="cp">#define		HERMES_EV_CMD			(0x0010)</span>
<span class="cp">#define		HERMES_EV_ALLOC			(0x0008)</span>
<span class="cp">#define		HERMES_EV_TXEXC			(0x0004)</span>
<span class="cp">#define		HERMES_EV_TX			(0x0002)</span>
<span class="cp">#define		HERMES_EV_RX			(0x0001)</span>

<span class="cm">/*</span>
<span class="cm"> * Command codes</span>
<span class="cm"> */</span>
<span class="cm">/*--- Controller Commands ----------------------------*/</span>
<span class="cp">#define		HERMES_CMD_INIT			(0x0000)</span>
<span class="cp">#define		HERMES_CMD_ENABLE		(0x0001)</span>
<span class="cp">#define		HERMES_CMD_DISABLE		(0x0002)</span>
<span class="cp">#define		HERMES_CMD_DIAG			(0x0003)</span>

<span class="cm">/*--- Buffer Mgmt Commands ---------------------------*/</span>
<span class="cp">#define		HERMES_CMD_ALLOC		(0x000A)</span>
<span class="cp">#define		HERMES_CMD_TX			(0x000B)</span>

<span class="cm">/*--- Regulate Commands ------------------------------*/</span>
<span class="cp">#define		HERMES_CMD_NOTIFY		(0x0010)</span>
<span class="cp">#define		HERMES_CMD_INQUIRE		(0x0011)</span>

<span class="cm">/*--- Configure Commands -----------------------------*/</span>
<span class="cp">#define		HERMES_CMD_ACCESS		(0x0021)</span>
<span class="cp">#define		HERMES_CMD_DOWNLD		(0x0022)</span>

<span class="cm">/*--- Serial I/O Commands ----------------------------*/</span>
<span class="cp">#define		HERMES_CMD_READMIF		(0x0030)</span>
<span class="cp">#define		HERMES_CMD_WRITEMIF		(0x0031)</span>

<span class="cm">/*--- Debugging Commands -----------------------------*/</span>
<span class="cp">#define		HERMES_CMD_TEST			(0x0038)</span>


<span class="cm">/* Test command arguments */</span>
<span class="cp">#define		HERMES_TEST_SET_CHANNEL		0x0800</span>
<span class="cp">#define		HERMES_TEST_MONITOR		0x0b00</span>
<span class="cp">#define		HERMES_TEST_STOP		0x0f00</span>

<span class="cm">/* Authentication algorithms */</span>
<span class="cp">#define		HERMES_AUTH_OPEN		1</span>
<span class="cp">#define		HERMES_AUTH_SHARED_KEY		2</span>

<span class="cm">/* WEP settings */</span>
<span class="cp">#define		HERMES_WEP_PRIVACY_INVOKED	0x0001</span>
<span class="cp">#define		HERMES_WEP_EXCL_UNENCRYPTED	0x0002</span>
<span class="cp">#define		HERMES_WEP_HOST_ENCRYPT		0x0010</span>
<span class="cp">#define		HERMES_WEP_HOST_DECRYPT		0x0080</span>

<span class="cm">/* Symbol hostscan options */</span>
<span class="cp">#define		HERMES_HOSTSCAN_SYMBOL_5SEC	0x0001</span>
<span class="cp">#define		HERMES_HOSTSCAN_SYMBOL_ONCE	0x0002</span>
<span class="cp">#define		HERMES_HOSTSCAN_SYMBOL_PASSIVE	0x0040</span>
<span class="cp">#define		HERMES_HOSTSCAN_SYMBOL_BCAST	0x0080</span>

<span class="cm">/*</span>
<span class="cm"> * Frame structures and constants</span>
<span class="cm"> */</span>

<span class="cp">#define HERMES_DESCRIPTOR_OFFSET	0</span>
<span class="cp">#define HERMES_802_11_OFFSET		(14)</span>
<span class="cp">#define HERMES_802_3_OFFSET		(14 + 32)</span>
<span class="cp">#define HERMES_802_2_OFFSET		(14 + 32 + 14)</span>
<span class="cp">#define HERMES_TXCNTL2_OFFSET		(HERMES_802_3_OFFSET - 2)</span>

<span class="cp">#define HERMES_RXSTAT_ERR		(0x0003)</span>
<span class="cp">#define	HERMES_RXSTAT_BADCRC		(0x0001)</span>
<span class="cp">#define	HERMES_RXSTAT_UNDECRYPTABLE	(0x0002)</span>
<span class="cp">#define	HERMES_RXSTAT_MIC		(0x0010)	</span><span class="cm">/* Frame contains MIC */</span><span class="cp"></span>
<span class="cp">#define	HERMES_RXSTAT_MACPORT		(0x0700)</span>
<span class="cp">#define HERMES_RXSTAT_PCF		(0x1000)	</span><span class="cm">/* Frame was received in CF period */</span><span class="cp"></span>
<span class="cp">#define	HERMES_RXSTAT_MIC_KEY_ID	(0x1800)	</span><span class="cm">/* MIC key used */</span><span class="cp"></span>
<span class="cp">#define	HERMES_RXSTAT_MSGTYPE		(0xE000)</span>
<span class="cp">#define	HERMES_RXSTAT_1042		(0x2000)	</span><span class="cm">/* RFC-1042 frame */</span><span class="cp"></span>
<span class="cp">#define	HERMES_RXSTAT_TUNNEL		(0x4000)	</span><span class="cm">/* bridge-tunnel encoded frame */</span><span class="cp"></span>
<span class="cp">#define	HERMES_RXSTAT_WMP		(0x6000)	</span><span class="cm">/* Wavelan-II Management Protocol frame */</span><span class="cp"></span>

<span class="cm">/* Shift amount for key ID in RXSTAT and TXCTRL */</span>
<span class="cp">#define	HERMES_MIC_KEY_ID_SHIFT		11</span>

<span class="k">struct</span> <span class="n">hermes_tx_descriptor</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">reserved1</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">reserved2</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">sw_support</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">retry_count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_rate</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">tx_control</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define HERMES_TXSTAT_RETRYERR		(0x0001)</span>
<span class="cp">#define HERMES_TXSTAT_AGEDERR		(0x0002)</span>
<span class="cp">#define HERMES_TXSTAT_DISCON		(0x0004)</span>
<span class="cp">#define HERMES_TXSTAT_FORMERR		(0x0008)</span>

<span class="cp">#define HERMES_TXCTRL_TX_OK		(0x0002)	</span><span class="cm">/* ?? interrupt on Tx complete */</span><span class="cp"></span>
<span class="cp">#define HERMES_TXCTRL_TX_EX		(0x0004)	</span><span class="cm">/* ?? interrupt on Tx exception */</span><span class="cp"></span>
<span class="cp">#define HERMES_TXCTRL_802_11		(0x0008)	</span><span class="cm">/* We supply 802.11 header */</span><span class="cp"></span>
<span class="cp">#define HERMES_TXCTRL_MIC		(0x0010)	</span><span class="cm">/* 802.3 + TKIP */</span><span class="cp"></span>
<span class="cp">#define HERMES_TXCTRL_MIC_KEY_ID	(0x1800)	</span><span class="cm">/* MIC Key ID mask */</span><span class="cp"></span>
<span class="cp">#define HERMES_TXCTRL_ALT_RTRY		(0x0020)</span>

<span class="cm">/* Inquiry constants and data types */</span>

<span class="cp">#define HERMES_INQ_TALLIES		(0xF100)</span>
<span class="cp">#define HERMES_INQ_SCAN			(0xF101)</span>
<span class="cp">#define HERMES_INQ_CHANNELINFO		(0xF102)</span>
<span class="cp">#define HERMES_INQ_HOSTSCAN		(0xF103)</span>
<span class="cp">#define HERMES_INQ_HOSTSCAN_SYMBOL	(0xF104)</span>
<span class="cp">#define HERMES_INQ_LINKSTATUS		(0xF200)</span>
<span class="cp">#define HERMES_INQ_SEC_STAT_AGERE	(0xF202)</span>

<span class="k">struct</span> <span class="n">hermes_tallies_frame</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">TxUnicastFrames</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">TxMulticastFrames</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">TxFragments</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">TxUnicastOctets</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">TxMulticastOctets</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">TxDeferredTransmissions</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">TxSingleRetryFrames</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">TxMultipleRetryFrames</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">TxRetryLimitExceeded</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">TxDiscards</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">RxUnicastFrames</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">RxMulticastFrames</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">RxFragments</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">RxUnicastOctets</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">RxMulticastOctets</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">RxFCSErrors</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">RxDiscards_NoBuffer</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">TxDiscardsWrongSA</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">RxWEPUndecryptable</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">RxMsgInMsgFragments</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">RxMsgInBadMsgFragments</span><span class="p">;</span>
	<span class="cm">/* Those last are probably not available in very old firmwares */</span>
	<span class="n">__le16</span> <span class="n">RxDiscards_WEPICVError</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">RxDiscards_WEPExcluded</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Grabbed from wlan-ng - Thanks Mark... - Jean II</span>
<span class="cm"> * This is the result of a scan inquiry command */</span>
<span class="cm">/* Structure describing info about an Access Point */</span>
<span class="k">struct</span> <span class="n">prism2_scan_apinfo</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">channel</span><span class="p">;</span>		<span class="cm">/* Channel where the AP sits */</span>
	<span class="n">__le16</span> <span class="n">noise</span><span class="p">;</span>		<span class="cm">/* Noise level */</span>
	<span class="n">__le16</span> <span class="n">level</span><span class="p">;</span>		<span class="cm">/* Signal level */</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>	<span class="cm">/* MAC address of the Access Point */</span>
	<span class="n">__le16</span> <span class="n">beacon_interv</span><span class="p">;</span>	<span class="cm">/* Beacon interval */</span>
	<span class="n">__le16</span> <span class="n">capabilities</span><span class="p">;</span>	<span class="cm">/* Capabilities */</span>
	<span class="n">__le16</span> <span class="n">essid_len</span><span class="p">;</span>	<span class="cm">/* ESSID length */</span>
	<span class="n">u8</span> <span class="n">essid</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>		<span class="cm">/* ESSID of the network */</span>
	<span class="n">u8</span> <span class="n">rates</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>		<span class="cm">/* Bit rate supported */</span>
	<span class="n">__le16</span> <span class="n">proberesp_rate</span><span class="p">;</span>	<span class="cm">/* Data rate of the response frame */</span>
	<span class="n">__le16</span> <span class="n">atim</span><span class="p">;</span>		<span class="cm">/* ATIM window time, Kus (hostscan only) */</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Same stuff for the Lucent/Agere card.</span>
<span class="cm"> * Thanks to h1kari &lt;h1kari AT dachb0den.com&gt; - Jean II */</span>
<span class="k">struct</span> <span class="n">agere_scan_apinfo</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">channel</span><span class="p">;</span>		<span class="cm">/* Channel where the AP sits */</span>
	<span class="n">__le16</span> <span class="n">noise</span><span class="p">;</span>		<span class="cm">/* Noise level */</span>
	<span class="n">__le16</span> <span class="n">level</span><span class="p">;</span>		<span class="cm">/* Signal level */</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>	<span class="cm">/* MAC address of the Access Point */</span>
	<span class="n">__le16</span> <span class="n">beacon_interv</span><span class="p">;</span>	<span class="cm">/* Beacon interval */</span>
	<span class="n">__le16</span> <span class="n">capabilities</span><span class="p">;</span>	<span class="cm">/* Capabilities */</span>
	<span class="cm">/* bits: 0-ess, 1-ibss, 4-privacy [wep] */</span>
	<span class="n">__le16</span> <span class="n">essid_len</span><span class="p">;</span>	<span class="cm">/* ESSID length */</span>
	<span class="n">u8</span> <span class="n">essid</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>		<span class="cm">/* ESSID of the network */</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Moustafa: Scan structure for Symbol cards */</span>
<span class="k">struct</span> <span class="n">symbol_scan_apinfo</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">channel</span><span class="p">;</span>		<span class="cm">/* Channel where the AP sits */</span>
	<span class="n">u8</span> <span class="n">unknown1</span><span class="p">;</span>		<span class="cm">/* 8 in 2.9x and 3.9x f/w, 0 otherwise */</span>
	<span class="n">__le16</span> <span class="n">noise</span><span class="p">;</span>		<span class="cm">/* Noise level */</span>
	<span class="n">__le16</span> <span class="n">level</span><span class="p">;</span>		<span class="cm">/* Signal level */</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>	<span class="cm">/* MAC address of the Access Point */</span>
	<span class="n">__le16</span> <span class="n">beacon_interv</span><span class="p">;</span>	<span class="cm">/* Beacon interval */</span>
	<span class="n">__le16</span> <span class="n">capabilities</span><span class="p">;</span>	<span class="cm">/* Capabilities */</span>
	<span class="cm">/* bits: 0-ess, 1-ibss, 4-privacy [wep] */</span>
	<span class="n">__le16</span> <span class="n">essid_len</span><span class="p">;</span>	<span class="cm">/* ESSID length */</span>
	<span class="n">u8</span> <span class="n">essid</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>		<span class="cm">/* ESSID of the network */</span>
	<span class="n">__le16</span> <span class="n">rates</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>	<span class="cm">/* Bit rate supported */</span>
	<span class="n">__le16</span> <span class="n">basic_rates</span><span class="p">;</span>	<span class="cm">/* Basic rates bitmask */</span>
	<span class="n">u8</span> <span class="n">unknown2</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>		<span class="cm">/* Always FF:FF:FF:FF:00:00 */</span>
	<span class="n">u8</span> <span class="n">unknown3</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>		<span class="cm">/* Always 0, appeared in f/w 3.91-68 */</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">union</span> <span class="n">hermes_scan_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">agere_scan_apinfo</span>	<span class="n">a</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prism2_scan_apinfo</span>	<span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">symbol_scan_apinfo</span>	<span class="n">s</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Extended scan struct for HERMES_INQ_CHANNELINFO.</span>
<span class="cm"> * wl_lkm calls this an ACS scan (Automatic Channel Select).</span>
<span class="cm"> * Keep out of union hermes_scan_info because it is much bigger than</span>
<span class="cm"> * the older scan structures. */</span>
<span class="k">struct</span> <span class="n">agere_ext_scan_info</span> <span class="p">{</span>
	<span class="n">__le16</span>	<span class="n">reserved0</span><span class="p">;</span>

	<span class="n">u8</span>	<span class="n">noise</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">level</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">rx_flow</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">rate</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">reserved1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">__le16</span>	<span class="n">frame_control</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">dur_id</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">addr1</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">addr2</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__le16</span>	<span class="n">sequence</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">addr4</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="n">__le16</span>	<span class="n">data_length</span><span class="p">;</span>

	<span class="cm">/* Next 3 fields do not get filled in. */</span>
	<span class="n">u8</span>	<span class="n">daddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">saddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__le16</span>	<span class="n">len_type</span><span class="p">;</span>

	<span class="n">__le64</span>	<span class="n">timestamp</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">beacon_interval</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">capabilities</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define HERMES_LINKSTATUS_NOT_CONNECTED   (0x0000)</span>
<span class="cp">#define HERMES_LINKSTATUS_CONNECTED       (0x0001)</span>
<span class="cp">#define HERMES_LINKSTATUS_DISCONNECTED    (0x0002)</span>
<span class="cp">#define HERMES_LINKSTATUS_AP_CHANGE       (0x0003)</span>
<span class="cp">#define HERMES_LINKSTATUS_AP_OUT_OF_RANGE (0x0004)</span>
<span class="cp">#define HERMES_LINKSTATUS_AP_IN_RANGE     (0x0005)</span>
<span class="cp">#define HERMES_LINKSTATUS_ASSOC_FAILED    (0x0006)</span>

<span class="k">struct</span> <span class="n">hermes_linkstatus</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">linkstatus</span><span class="p">;</span>         <span class="cm">/* Link status */</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">hermes_response</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">,</span> <span class="n">resp0</span><span class="p">,</span> <span class="n">resp1</span><span class="p">,</span> <span class="n">resp2</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* &quot;ID&quot; structure - used for ESSID and station nickname */</span>
<span class="k">struct</span> <span class="n">hermes_idstring</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">val</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">hermes_multicast</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">[</span><span class="n">HERMES_MAX_MULTICAST</span><span class="p">][</span><span class="n">ETH_ALEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Timeouts */</span>
<span class="cp">#define HERMES_BAP_BUSY_TIMEOUT (10000) </span><span class="cm">/* In iterations of ~1us */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">hermes</span><span class="p">;</span>

<span class="cm">/* Functions to access hardware */</span>
<span class="k">struct</span> <span class="n">hermes_ops</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd_wait</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">parm0</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hermes_response</span> <span class="o">*</span><span class="n">resp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init_cmd_wait</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">parm0</span><span class="p">,</span> <span class="n">u16</span> <span class="n">parm1</span><span class="p">,</span> <span class="n">u16</span> <span class="n">parm2</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">hermes_response</span> <span class="o">*</span><span class="n">resp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">allocate</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">fid</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read_ltv</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bap</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">buflen</span><span class="p">,</span>
			<span class="n">u16</span> <span class="o">*</span><span class="n">length</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">write_ltv</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bap</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">length</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bap_pread</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bap</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bap_pwrite</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bap</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read_pda</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">pda</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">pda_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pda_len</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">program_init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">entry_point</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">program_end</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">program</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">lock_irqsave</span><span class="p">)(</span><span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">unlock_irqrestore</span><span class="p">)(</span><span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">lock_irq</span><span class="p">)(</span><span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">unlock_irq</span><span class="p">)(</span><span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/* Basic control structure */</span>
<span class="k">struct</span> <span class="n">hermes</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg_spacing</span><span class="p">;</span>
<span class="cp">#define HERMES_16BIT_REGSPACING	0</span>
<span class="cp">#define HERMES_32BIT_REGSPACING	1</span>
	<span class="n">u16</span> <span class="n">inten</span><span class="p">;</span> <span class="cm">/* Which interrupts should be enabled? */</span>
	<span class="n">bool</span> <span class="n">eeprom_pda</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hermes_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Register access convenience macros */</span>
<span class="cp">#define hermes_read_reg(hw, off) \</span>
<span class="cp">	(ioread16((hw)-&gt;iobase + ((off) &lt;&lt; (hw)-&gt;reg_spacing)))</span>
<span class="cp">#define hermes_write_reg(hw, off, val) \</span>
<span class="cp">	(iowrite16((val), (hw)-&gt;iobase + ((off) &lt;&lt; (hw)-&gt;reg_spacing)))</span>
<span class="cp">#define hermes_read_regn(hw, name) hermes_read_reg((hw), HERMES_##name)</span>
<span class="cp">#define hermes_write_regn(hw, name, val) \</span>
<span class="cp">	hermes_write_reg((hw), HERMES_##name, (val))</span>

<span class="cm">/* Function prototypes */</span>
<span class="kt">void</span> <span class="n">hermes_struct_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">reg_spacing</span><span class="p">);</span>

<span class="cm">/* Inline functions */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hermes_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hermes_read_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SWSUPPORT0</span><span class="p">)</span> <span class="o">==</span> <span class="n">HERMES_MAGIC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hermes_set_irqmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">events</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">inten</span> <span class="o">=</span> <span class="n">events</span><span class="p">;</span>
	<span class="n">hermes_write_regn</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">INTEN</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hermes_enable_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cmd_wait</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HERMES_CMD_ENABLE</span> <span class="o">|</span> <span class="p">(</span><span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
				 <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hermes_disable_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cmd_wait</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HERMES_CMD_DISABLE</span> <span class="o">|</span> <span class="p">(</span><span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
				 <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Initiate an INQUIRE command (tallies or scan).  The result will come as an</span>
<span class="cm"> * information frame in __orinoco_ev_info() */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hermes_inquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cmd_wait</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HERMES_CMD_INQUIRE</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define HERMES_BYTES_TO_RECLEN(n) ((((n) + 1) / 2) + 1)</span>
<span class="cp">#define HERMES_RECLEN_TO_BYTES(n) (((n) - 1) * 2)</span>

<span class="cm">/* Note that for the next two, the count is in 16-bit words, not bytes */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hermes_read_words</span><span class="p">(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">off</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&lt;&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg_spacing</span><span class="p">;</span>
	<span class="n">ioread16_rep</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hermes_write_bytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">off</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&lt;&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg_spacing</span><span class="p">;</span>
	<span class="n">iowrite16_rep</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hermes_clear_words</span><span class="p">(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&lt;&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg_spacing</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define HERMES_READ_RECORD(hw, bap, rid, buf) \</span>
<span class="cp">	(hw-&gt;ops-&gt;read_ltv((hw), (bap), (rid), sizeof(*buf), NULL, (buf)))</span>
<span class="cp">#define HERMES_WRITE_RECORD(hw, bap, rid, buf) \</span>
<span class="cp">	(hw-&gt;ops-&gt;write_ltv((hw), (bap), (rid), \</span>
<span class="cp">			    HERMES_BYTES_TO_RECLEN(sizeof(*buf)), (buf)))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hermes_read_wordrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bap</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="o">*</span><span class="n">word</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">rec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">HERMES_READ_RECORD</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">bap</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">);</span>
	<span class="o">*</span><span class="n">word</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hermes_write_wordrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bap</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span>
				       <span class="n">u16</span> <span class="n">word</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">rec</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">HERMES_WRITE_RECORD</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">bap</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif  </span><span class="cm">/* _HERMES_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
