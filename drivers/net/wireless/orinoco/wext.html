<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › orinoco › wext.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>wext.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Wireless extensions support.</span>
<span class="cm"> *</span>
<span class="cm"> * See copyright notice in main.c</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &lt;net/iw_handler.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211-wext.h&gt;</span>

<span class="cp">#include &quot;hermes.h&quot;</span>
<span class="cp">#include &quot;hermes_rid.h&quot;</span>
<span class="cp">#include &quot;orinoco.h&quot;</span>

<span class="cp">#include &quot;hw.h&quot;</span>
<span class="cp">#include &quot;mic.h&quot;</span>
<span class="cp">#include &quot;scan.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>

<span class="cp">#include &quot;wext.h&quot;</span>

<span class="cp">#define MAX_RID_LEN 1024</span>

<span class="cm">/* Helper routine to record keys</span>
<span class="cm"> * It is called under orinoco_lock so it may not sleep */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">orinoco_alg</span> <span class="n">alg</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key_len</span><span class="p">,</span>
			   <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kzfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key</span><span class="p">);</span>
	<span class="n">kzfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">seq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">key_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nomem</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">seq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">seq</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_key</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">seq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">key_len</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">seq_len</span> <span class="o">=</span> <span class="n">seq_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seq_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">seq</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">alg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ORINOCO_ALG_TKIP</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ORINOCO_ALG_WEP</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">cipher</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="n">SMALL_KEY_SIZE</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">WLAN_CIPHER_SUITE_WEP104</span> <span class="o">:</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ORINOCO_ALG_NONE</span>:
	<span class="nl">default:</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">cipher</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_key:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">nomem:</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">seq_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">cipher</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="nf">orinoco_get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">wstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: get_wireless_stats() called while device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* FIXME: Can we do better than this? */</span>
	<span class="p">}</span>

	<span class="cm">/* If busy, return the old stats.  Returning NULL may cause</span>
<span class="cm">	 * the interface to disappear from /proc/net/wireless */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">wstats</span><span class="p">;</span>

	<span class="cm">/* We can&#39;t really wait for the tallies inquiry command to</span>
<span class="cm">	 * complete, so we just use the previous results and trigger</span>
<span class="cm">	 * a new tallies inquiry command for next time - Jean II */</span>
	<span class="cm">/* FIXME: Really we should wait for the inquiry to come back -</span>
<span class="cm">	 * as it is the stats we give don&#39;t make a whole lot of sense.</span>
<span class="cm">	 * Unfortunately, it&#39;s not clear how to do that within the</span>
<span class="cm">	 * wireless extensions framework: I think we&#39;re in user</span>
<span class="cm">	 * context, but a lock seems to be held by the time we get in</span>
<span class="cm">	 * here so we&#39;re not safe to sleep here. */</span>
	<span class="n">hermes_inquire</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HERMES_INQ_TALLIES</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">));</span>
		<span class="cm">/* If a spy address is defined, we report stats of the</span>
<span class="cm">		 * first spy address - Jean II */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SPY_NUMBER</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">qual</span><span class="p">;</span>
			<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">level</span><span class="p">;</span>
			<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">noise</span><span class="p">;</span>
			<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">updated</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__le16</span> <span class="n">qual</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">unused</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">__packed</span> <span class="n">cq</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">HERMES_READ_RECORD</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					 <span class="n">HERMES_RID_COMMSQUALITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cq</span><span class="p">.</span><span class="n">qual</span><span class="p">);</span>
			<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cq</span><span class="p">.</span><span class="n">signal</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x95</span><span class="p">;</span>
			<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cq</span><span class="p">.</span><span class="n">noise</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x95</span><span class="p">;</span>
			<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span>
				<span class="n">IW_QUAL_ALL_UPDATED</span> <span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wstats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Wireless extensions                                              */</span>
<span class="cm">/********************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_setwap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">ap_addr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">off_addr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">any_addr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Enable automatic roaming - no sanity checks are needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">off_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">any_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid_fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="cm">/* &quot;off&quot; means keep existing connection */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__orinoco_hw_set_wap</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span> <span class="o">==</span> <span class="n">FIRMWARE_TYPE_AGERE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Lucent/Agere firmware doesn&#39;t &quot;</span>
		       <span class="s">&quot;support manual roaming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Manual roaming supported only in &quot;</span>
		       <span class="s">&quot;managed mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Intersil firmware hangs without Desired ESSID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span> <span class="o">==</span> <span class="n">FIRMWARE_TYPE_INTERSIL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_essid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Desired ESSID must be set for &quot;</span>
		       <span class="s">&quot;manual roaming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Finally, enable manual roaming */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid_fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_getwap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">ap_addr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">ap_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_hw_get_current_bssid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ap_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">);</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_setiwencode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">erq</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">keybuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">setindex</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">orinoco_alg</span> <span class="n">encode_alg</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="k">restricted</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_restrict</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We actually have a key to set - check its length */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">LARGE_KEY_SIZE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">SMALL_KEY_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_big_wep</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Clear any TKIP key we have */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wpa</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span> <span class="o">==</span> <span class="n">ORINOCO_ALG_TKIP</span><span class="p">))</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">orinoco_clear_tkip_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">setindex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ORINOCO_MAX_KEYS</span><span class="p">))</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span><span class="p">;</span>

		<span class="cm">/* Switch on WEP if off */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encode_alg</span> <span class="o">!=</span> <span class="n">ORINOCO_ALG_WEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">setindex</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
			<span class="n">encode_alg</span> <span class="o">=</span> <span class="n">ORINOCO_ALG_WEP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Important note : if the user do &quot;iwconfig eth0 enc off&quot;,</span>
<span class="cm">		 * we will arrive there with an index of -1. This is valid</span>
<span class="cm">		 * but need to be taken care off... Jean II */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ORINOCO_MAX_KEYS</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Set the index : Check that the key is valid */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">setindex</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span>
		<span class="n">encode_alg</span> <span class="o">=</span> <span class="n">ORINOCO_ALG_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">)</span>
		<span class="k">restricted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">)</span>
		<span class="k">restricted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">&amp;&amp;</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_set_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ORINOCO_ALG_WEP</span><span class="p">,</span> <span class="n">keybuf</span><span class="p">,</span>
				      <span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span> <span class="o">=</span> <span class="n">setindex</span><span class="p">;</span>

	<span class="cm">/* Try fast key change if connected and only keys are changed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span> <span class="o">==</span> <span class="n">encode_alg</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_restrict</span> <span class="o">==</span> <span class="k">restricted</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__orinoco_hw_setup_wepkeys</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="cm">/* No need to commit if successful */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span> <span class="o">=</span> <span class="n">encode_alg</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_restrict</span> <span class="o">=</span> <span class="k">restricted</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_getiwencode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">erq</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">keybuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ORINOCO_MAX_KEYS</span><span class="p">))</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span><span class="p">;</span>

	<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span><span class="p">)</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
	<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_restrict</span><span class="p">)</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">;</span>

	<span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key_len</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">keybuf</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key</span><span class="p">,</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_setessid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">erq</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">essidbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Note : ESSID is ignored in Ad-Hoc demo mode, but we can set it</span>
<span class="cm">	 * anyway... - Jean II */</span>

	<span class="cm">/* Hum... Should not use Wireless Extension constant (may change),</span>
<span class="cm">	 * should use our own... - Jean II */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* NULL the string (for NULL termination &amp; ESSID = ANY) - Jean II */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_essid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_essid</span><span class="p">));</span>

	<span class="cm">/* If not ANY, get the new ESSID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_essid</span><span class="p">,</span> <span class="n">essidbuf</span><span class="p">,</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_getessid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">erq</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">essidbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">active</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_hw_get_essid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">active</span><span class="p">,</span> <span class="n">essidbuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">essidbuf</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_essid</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_essid</span><span class="p">);</span>
		<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_setfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">frq</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>

	<span class="cm">/* In infrastructure mode the AP sets the channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">frq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">frq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Setting by channel number */</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">frq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Setting by frequency */</span>
		<span class="kt">int</span> <span class="n">denom</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Calculate denominator to rescale to MHz */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="n">frq</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">denom</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>

		<span class="n">chan</span> <span class="o">=</span> <span class="n">ieee80211_freq_to_dsss_chan</span><span class="p">(</span><span class="n">frq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="n">denom</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;</span> <span class="n">NUM_CHANNELS</span><span class="p">)</span> <span class="o">||</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">chan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fast channel change - no commit if successful */</span>
		<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cmd_wait</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HERMES_CMD_TEST</span> <span class="o">|</span>
					    <span class="n">HERMES_TEST_SET_CHANNEL</span><span class="p">,</span>
					<span class="n">chan</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_getfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">frq</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Locking done in there */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">orinoco_hw_get_freq</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">frq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="n">frq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_getsens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">srq</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_sensitivity</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				  <span class="n">HERMES_RID_CNFSYSTEMSCALE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">srq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">srq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* auto */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_setsens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">srq</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">srq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_sensitivity</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_density</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_setrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">rrq</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ratemode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bitrate</span><span class="p">;</span> <span class="cm">/* 100s of kilobits */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* As the user space doesn&#39;t know our highest rate, it uses -1</span>
<span class="cm">	 * to ask us to set the highest rate.  Test it using &quot;iwconfig</span>
<span class="cm">	 * ethX rate auto&quot; - Jean II */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">bitrate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">%</span> <span class="mi">100000</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">bitrate</span> <span class="o">=</span> <span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ratemode</span> <span class="o">=</span> <span class="n">orinoco_get_bitratemode</span><span class="p">(</span><span class="n">bitrate</span><span class="p">,</span> <span class="o">!</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">fixed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ratemode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bitratemode</span> <span class="o">=</span> <span class="n">ratemode</span><span class="p">;</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_getrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">rrq</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">automatic</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">orinoco_get_ratemode_cfg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bitratemode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitrate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">automatic</span><span class="p">);</span>

	<span class="cm">/* If the interface is running we try to find more about the</span>
<span class="cm">	   current mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">act_bitrate</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">lerr</span><span class="p">;</span>

		<span class="cm">/* Ignore errors if we can&#39;t get the actual bitrate */</span>
		<span class="n">lerr</span> <span class="o">=</span> <span class="n">orinoco_hw_get_act_bitrate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act_bitrate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lerr</span><span class="p">)</span>
			<span class="n">bitrate</span> <span class="o">=</span> <span class="n">act_bitrate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">bitrate</span><span class="p">;</span>
	<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="o">!</span><span class="n">automatic</span><span class="p">;</span>
	<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_setpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">prq</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">prq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IW_POWER_UNICAST_R</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_mcast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IW_POWER_ALL_R</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_mcast</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IW_POWER_ON</span>:
			<span class="cm">/* No flags : but we may have a value - Jean II */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_timeout</span> <span class="o">=</span> <span class="n">prq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_PERIOD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_period</span> <span class="o">=</span> <span class="n">prq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* It&#39;s valid to not have a value if we are just toggling</span>
<span class="cm">		 * the flags... Jean II */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_getpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">prq</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">enable</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">mcast</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				  <span class="n">HERMES_RID_CNFPMENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				  <span class="n">HERMES_RID_CNFMAXSLEEPDURATION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">period</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				  <span class="n">HERMES_RID_CNFPMHOLDOVERDURATION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				  <span class="n">HERMES_RID_CNFMULTICASTRECEIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcast</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">enable</span><span class="p">;</span>
	<span class="cm">/* Note : by default, display the period */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">prq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">;</span>
		<span class="n">prq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">prq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_POWER_PERIOD</span><span class="p">;</span>
		<span class="n">prq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">period</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcast</span><span class="p">)</span>
		<span class="n">prq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_POWER_ALL_R</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">prq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_POWER_UNICAST_R</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_set_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
				       <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">encoding</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">alg</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">,</span> <span class="n">set_key</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Determine and validate the key index */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">idx</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span>
		<span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wpa</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">alg</span> <span class="o">!=</span> <span class="n">IW_ENCODE_ALG_TKIP</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Clear any TKIP TX key we had */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">orinoco_clear_tkip_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_SET_TX_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">set_key</span> <span class="o">=</span> <span class="p">((</span><span class="n">alg</span> <span class="o">==</span> <span class="n">IW_ENCODE_ALG_TKIP</span><span class="p">)</span> <span class="o">||</span>
			   <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set the requested key first */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">alg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IW_ENCODE_ALG_NONE</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span> <span class="o">=</span> <span class="n">ORINOCO_ALG_NONE</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_set_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ORINOCO_ALG_NONE</span><span class="p">,</span>
					      <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IW_ENCODE_ALG_WEP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span> <span class="o">=</span> <span class="n">ORINOCO_ALG_WEP</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_set_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ORINOCO_ALG_WEP</span><span class="p">,</span>
					      <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IW_ENCODE_ALG_TKIP</span>:
		<span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">tkip_iv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wpa</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_tkip_key</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span> <span class="o">=</span> <span class="n">ORINOCO_ALG_TKIP</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_RX_SEQ_VALID</span><span class="p">)</span>
				<span class="n">tkip_iv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">rx_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_set_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ORINOCO_ALG_TKIP</span><span class="p">,</span>
					      <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">tkip_iv</span><span class="p">,</span>
					      <span class="n">ORINOCO_SEQ_LEN</span><span class="p">);</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">__orinoco_hw_set_tkip_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
				 <span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_SET_TX_KEY</span><span class="p">,</span>
				 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">key</span><span class="p">,</span>
				 <span class="n">tkip_iv</span><span class="p">,</span> <span class="n">ORINOCO_SEQ_LEN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting TKIP key&quot;</span>
				       <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_get_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
				       <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">encoding</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">max_key_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">max_key_len</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_key_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">idx</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span><span class="p">;</span>

	<span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ORINOCO_ALG_NONE</span>:
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_NONE</span><span class="p">;</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ORINOCO_ALG_WEP</span>:
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_WEP</span><span class="p">;</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">key_len</span><span class="p">,</span> <span class="n">max_key_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">key</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_ENABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ORINOCO_ALG_TKIP</span>:
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_TKIP</span><span class="p">;</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">key_len</span><span class="p">,</span> <span class="n">max_key_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">key</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_ENABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_set_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_RX_UNENCRYPTED_EAPOL</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_PRIVACY_INVOKED</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:
		<span class="cm">/*</span>
<span class="cm">		 * orinoco does not use these parameters</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_MFP</span>:
		<span class="cm">/* Management Frame Protection not supported.</span>
<span class="cm">		 * Only fail if set to required.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="n">IW_AUTH_MFP_REQUIRED</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
		<span class="cm">/* wl_lkm implies value 2 == PSK for Hermes I</span>
<span class="cm">		 * which ties in with WEXT</span>
<span class="cm">		 * no other hints tho :(</span>
<span class="cm">		 */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">key_mgmt</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_TKIP_COUNTERMEASURES</span>:
		<span class="cm">/* When countermeasures are enabled, shut down the</span>
<span class="cm">		 * card; when disabled, re-enable the card. This must</span>
<span class="cm">		 * take effect immediately.</span>
<span class="cm">		 *</span>
<span class="cm">		 * TODO: Make sure that the EAPOL message is getting</span>
<span class="cm">		 *       out before card disabled</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tkip_cm_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">hermes_disable_port</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tkip_cm_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">hermes_enable_port</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_SHARED_KEY</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_restrict</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_OPEN_SYSTEM</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_restrict</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wpa</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_enabled</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="cm">/* else silently accept disable of WPA */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_get_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">key_mgmt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_TKIP_COUNTERMEASURES</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tkip_cm_active</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_restrict</span><span class="p">)</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">IW_AUTH_ALG_SHARED_KEY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">IW_AUTH_ALG_OPEN_SYSTEM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_enabled</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_set_genie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* cut off at IEEE80211_MAX_DATA_LEN */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">IEEE80211_MAX_DATA_LEN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">extra</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Looks like wl_lkm wants to check the auth alg, and</span>
<span class="cm">		 * somehow pass it to the firmware.</span>
<span class="cm">		 * Instead it just calls the key mgmt rid</span>
<span class="cm">		 *   - we do this in set auth.</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_get_genie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_set_mlme</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_mlme</span> <span class="o">*</span><span class="n">mlme</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_mlme</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MLME_DEAUTH</span>:
		<span class="cm">/* silently ignore */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_MLME_DISASSOC</span>:

		<span class="n">ret</span> <span class="o">=</span> <span class="n">orinoco_hw_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mlme</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span>
					      <span class="n">mlme</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="p">(</span><span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Forcing reset!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="cm">/* Firmware reset */</span>
		<span class="n">orinoco_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Force scheduling reset!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_setibssport</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibss_port</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Actually update the mode we are using */</span>
	<span class="n">set_port_type</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_getibssport</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibss_port</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_setport3</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* Try to do IEEE ad-hoc mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_ibss</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prefer_port3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* Try to do Lucent proprietary ad-hoc mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_port3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prefer_port3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Actually update the mode we are using */</span>
		<span class="n">set_port_type</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_getport3</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">prefer_port3</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_setpreamble</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_preamble</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* 802.11b has recently defined some short preamble.</span>
<span class="cm">	 * Basically, the Phy header has been reduced in size.</span>
<span class="cm">	 * This increase performance, especially at high rates</span>
<span class="cm">	 * (the preamble is transmitted at 1Mb/s), unfortunately</span>
<span class="cm">	 * this give compatibility troubles... - Jean II */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_getpreamble</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_preamble</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ioctl interface to hermes_read_ltv()</span>
<span class="cm"> * To use with iwpriv, pass the RID as the token argument, e.g.</span>
<span class="cm"> * iwpriv get_rid [0xfc00]</span>
<span class="cm"> * At least Wireless Tools 25 is required to use iwpriv.</span>
<span class="cm"> * For Wireless Tools 25 and 26 append &quot;dummy&quot; are the end. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_getrid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rid</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* It&#39;s a &quot;get&quot; function, but we don&#39;t want users to access the</span>
<span class="cm">	 * WEP key and other raw firmware data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rid</span> <span class="o">&lt;</span> <span class="mh">0xfc00</span> <span class="o">||</span> <span class="n">rid</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">MAX_RID_LEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span>
				<span class="n">extra</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">HERMES_RECLEN_TO_BYTES</span><span class="p">(</span><span class="n">length</span><span class="p">),</span>
			     <span class="n">MAX_RID_LEN</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Commit handler, called after set operations */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">orinoco_ioctl_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">orinoco_commit</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="n">orinoco_privtab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;force_reset&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;card_reset&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;set_port3&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="s">&quot;get_port3&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;set_preamble&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="s">&quot;get_preamble&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x6</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;set_ibssport&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="s">&quot;get_ibssport&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_BYTE</span> <span class="o">|</span> <span class="n">MAX_RID_LEN</span><span class="p">,</span>
	  <span class="s">&quot;get_rid&quot;</span> <span class="p">},</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Structures to export the Wireless Handlers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span>	<span class="n">orinoco_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWCOMMIT</span><span class="p">,</span>	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_commit</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWNAME</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">cfg80211_wext_giwname</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWFREQ</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_setfreq</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWFREQ</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_getfreq</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWMODE</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">cfg80211_wext_siwmode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWMODE</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">cfg80211_wext_giwmode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWSENS</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_setsens</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWSENS</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_getsens</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRANGE</span><span class="p">,</span>	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">cfg80211_wext_giwrange</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWSPY</span><span class="p">,</span>		<span class="n">iw_handler_set_spy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWSPY</span><span class="p">,</span>		<span class="n">iw_handler_get_spy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWTHRSPY</span><span class="p">,</span>	<span class="n">iw_handler_set_thrspy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWTHRSPY</span><span class="p">,</span>	<span class="n">iw_handler_get_thrspy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWAP</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_setwap</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWAP</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_getwap</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWSCAN</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">cfg80211_wext_siwscan</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWSCAN</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">cfg80211_wext_giwscan</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWESSID</span><span class="p">,</span>	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_setessid</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWESSID</span><span class="p">,</span>	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_getessid</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWRATE</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_setrate</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRATE</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_getrate</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWRTS</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">cfg80211_wext_siwrts</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRTS</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">cfg80211_wext_giwrts</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWFRAG</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">cfg80211_wext_siwfrag</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWFRAG</span><span class="p">,</span>		<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">cfg80211_wext_giwfrag</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRETRY</span><span class="p">,</span>	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">cfg80211_wext_giwretry</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWENCODE</span><span class="p">,</span>	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_setiwencode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWENCODE</span><span class="p">,</span>	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_getiwencode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWPOWER</span><span class="p">,</span>	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_setpower</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWPOWER</span><span class="p">,</span>	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_getpower</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWGENIE</span><span class="p">,</span>	<span class="n">orinoco_ioctl_set_genie</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWGENIE</span><span class="p">,</span>	<span class="n">orinoco_ioctl_get_genie</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWMLME</span><span class="p">,</span>		<span class="n">orinoco_ioctl_set_mlme</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWAUTH</span><span class="p">,</span>		<span class="n">orinoco_ioctl_set_auth</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWAUTH</span><span class="p">,</span>		<span class="n">orinoco_ioctl_get_auth</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWENCODEEXT</span><span class="p">,</span>	<span class="n">orinoco_ioctl_set_encodeext</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWENCODEEXT</span><span class="p">,</span>	<span class="n">orinoco_ioctl_get_encodeext</span><span class="p">),</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm">  Added typecasting since we no longer use iwreq_data -- Moustafa</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span>	<span class="n">orinoco_private_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_reset</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_reset</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_setport3</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_getport3</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_setpreamble</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_getpreamble</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_setibssport</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_getibssport</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span><span class="n">orinoco_ioctl_getrid</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="n">orinoco_handler_def</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_standard</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">orinoco_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">orinoco_private_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private_args</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">orinoco_privtab</span><span class="p">),</span>
	<span class="p">.</span><span class="n">standard</span> <span class="o">=</span> <span class="n">orinoco_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">orinoco_private_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_args</span> <span class="o">=</span> <span class="n">orinoco_privtab</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wireless_stats</span> <span class="o">=</span> <span class="n">orinoco_get_wireless_stats</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
