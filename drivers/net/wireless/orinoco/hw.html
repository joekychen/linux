<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › orinoco › hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Encapsulate basic setting changes and retrieval on Hermes hardware</span>
<span class="cm"> *</span>
<span class="cm"> * See copyright notice in main.c</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>
<span class="cp">#include &quot;hermes.h&quot;</span>
<span class="cp">#include &quot;hermes_rid.h&quot;</span>
<span class="cp">#include &quot;orinoco.h&quot;</span>

<span class="cp">#include &quot;hw.h&quot;</span>

<span class="cp">#define SYMBOL_MAX_VER_LEN	(14)</span>

<span class="cm">/* Symbol firmware has a bug allocating buffers larger than this */</span>
<span class="cp">#define TX_NICBUF_SIZE_BUG	1585</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* Data tables                                                      */</span>
<span class="cm">/********************************************************************/</span>

<span class="cm">/* This tables gives the actual meanings of the bitrate IDs returned</span>
<span class="cm"> * by the firmware. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">bitrate</span><span class="p">;</span> <span class="cm">/* in 100s of kilobits */</span>
	<span class="kt">int</span> <span class="n">automatic</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">agere_txratectrl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">intersil_txratectrl</span><span class="p">;</span>
<span class="p">}</span> <span class="n">bitrate_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">110</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">},</span> <span class="cm">/* Entry 0 is the default */</span>
	<span class="p">{</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">20</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">2</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">20</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">55</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">55</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">7</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">110</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">8</span><span class="p">},</span>
<span class="p">};</span>
<span class="cp">#define BITRATE_TABLE_SIZE ARRAY_SIZE(bitrate_table)</span>

<span class="cm">/* Firmware version encoding */</span>
<span class="k">struct</span> <span class="n">comp_id</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">,</span> <span class="n">variant</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">enum</span> <span class="n">fwtype</span> <span class="nf">determine_firmware_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">comp_id</span> <span class="o">*</span><span class="n">nic_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic_id</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mh">0x8000</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FIRMWARE_TYPE_AGERE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nic_id</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x8000</span> <span class="o">&amp;&amp;</span> <span class="n">nic_id</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FIRMWARE_TYPE_SYMBOL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">FIRMWARE_TYPE_INTERSIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set priv-&gt;firmware type, determine firmware properties</span>
<span class="cm"> * This function can be called before we have registerred with netdev,</span>
<span class="cm"> * so all errors go out with dev_* rather than printk</span>
<span class="cm"> *</span>
<span class="cm"> * If non-NULL stores a firmware description in fw_name.</span>
<span class="cm"> * If non-NULL stores a HW version in hw_ver</span>
<span class="cm"> *</span>
<span class="cm"> * These are output via generic cfg80211 ethtool support.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">determine_fw_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">fw_name_len</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="o">*</span><span class="n">hw_ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">comp_id</span> <span class="n">nic_id</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">firmver</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="n">SYMBOL_MAX_VER_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">2</span><span class="p">)));</span>

	<span class="cm">/* Get the hardware version */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">HERMES_READ_RECORD</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_NICID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot read hardware identity: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic_id</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic_id</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic_id</span><span class="p">.</span><span class="n">major</span><span class="p">);</span>
	<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic_id</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Hardware identity %04x:%04x:%04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">nic_id</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nic_id</span><span class="p">.</span><span class="n">variant</span><span class="p">,</span> <span class="n">nic_id</span><span class="p">.</span><span class="n">major</span><span class="p">,</span> <span class="n">nic_id</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_ver</span><span class="p">)</span>
		<span class="o">*</span><span class="n">hw_ver</span> <span class="o">=</span> <span class="p">(((</span><span class="n">nic_id</span><span class="p">.</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">nic_id</span><span class="p">.</span><span class="n">variant</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">nic_id</span><span class="p">.</span><span class="n">major</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">nic_id</span><span class="p">.</span><span class="n">minor</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span> <span class="o">=</span> <span class="n">determine_firmware_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic_id</span><span class="p">);</span>

	<span class="cm">/* Get the firmware version */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">HERMES_READ_RECORD</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_STAID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot read station identity: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_id</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_id</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_id</span><span class="p">.</span><span class="n">major</span><span class="p">);</span>
	<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_id</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Station identity  %04x:%04x:%04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">sta_id</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">.</span><span class="n">variant</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">.</span><span class="n">major</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sta_id</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x15</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Primary firmware is active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x14b</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tertiary firmware is active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1f</span>:	<span class="cm">/* Intersil, Agere, Symbol Spectrum24 */</span>
	<span class="k">case</span> <span class="mh">0x21</span>:	<span class="cm">/* Symbol Spectrum24 Trilogy */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown station ID, please report</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Default capabilities */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_sensitivity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_mwo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_preamble</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_port3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_ibss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_big_wep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_alt_txcntl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_ext_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_fw_download</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Determine capabilities from the firmware version */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_AGERE</span>:
		<span class="cm">/* Lucent Wavelan IEEE, Lucent Orinoco, Cabletron RoamAbout,</span>
<span class="cm">		   ELSA, Melco, HP, IBM, Dell 1150, Compaq 110/210 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw_name</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">fw_name</span><span class="p">,</span> <span class="n">fw_name_len</span><span class="p">,</span> <span class="s">&quot;Lucent/Agere %d.%02d&quot;</span><span class="p">,</span>
				 <span class="n">sta_id</span><span class="p">.</span><span class="n">major</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>

		<span class="n">firmver</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sta_id</span><span class="p">.</span><span class="n">major</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">sta_id</span><span class="p">.</span><span class="n">minor</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_ibss</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x60006</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wep</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x40020</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_big_wep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* FIXME: this is wrong - how do we tell</span>
<span class="cm">					  Gold cards from the others? */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_mwo</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x60000</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_pm</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x40020</span><span class="p">);</span> <span class="cm">/* Don&#39;t work in 7.52 ? */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibss_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_hostscan</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x8000a</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_fw_download</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">broken_monitor</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x80000</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_alt_txcntl</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x90000</span><span class="p">);</span> <span class="cm">/* All 9.x ? */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_ext_scan</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x90000</span><span class="p">);</span> <span class="cm">/* All 9.x ? */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wpa</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x9002a</span><span class="p">);</span>
		<span class="cm">/* Tested with Agere firmware :</span>
<span class="cm">		 *	1.16 ; 4.08 ; 4.52 ; 6.04 ; 6.16 ; 7.28 =&gt; Jean II</span>
<span class="cm">		 * Tested CableTron firmware : 4.32 =&gt; Anton */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_SYMBOL</span>:
		<span class="cm">/* Symbol , 3Com AirConnect, Intel, Ericsson WLAN */</span>
		<span class="cm">/* Intel MAC : 00:02:B3:* */</span>
		<span class="cm">/* 3Com MAC : 00:50:DA:* */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
		<span class="cm">/* Get the Symbol firmware version */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					<span class="n">HERMES_RID_SECONDARYVERSION_SYMBOL</span><span class="p">,</span>
					<span class="n">SYMBOL_MAX_VER_LEN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error %d reading Symbol firmware info. &quot;</span>
				 <span class="s">&quot;Wildly guessing capabilities...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">firmver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The firmware revision is a string, the format is</span>
<span class="cm">			 * something like : &quot;V2.20-01&quot;.</span>
<span class="cm">			 * Quick and dirty parsing... - Jean II</span>
<span class="cm">			 */</span>
			<span class="n">firmver</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">((</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">((</span><span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">((</span><span class="n">tmp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>

			<span class="n">tmp</span><span class="p">[</span><span class="n">SYMBOL_MAX_VER_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fw_name</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">fw_name</span><span class="p">,</span> <span class="n">fw_name_len</span><span class="p">,</span> <span class="s">&quot;Symbol %s&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_ibss</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x20000</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wep</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x15012</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_big_wep</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x20000</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_pm</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x20000</span> <span class="o">&amp;&amp;</span> <span class="n">firmver</span> <span class="o">&lt;</span> <span class="mh">0x22000</span><span class="p">)</span> <span class="o">||</span>
			       <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x29000</span> <span class="o">&amp;&amp;</span> <span class="n">firmver</span> <span class="o">&lt;</span> <span class="mh">0x30000</span><span class="p">)</span> <span class="o">||</span>
			       <span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x31000</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_preamble</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x20000</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibss_port</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="cm">/* Symbol firmware is found on various cards, but</span>
<span class="cm">		 * there has been no attempt to check firmware</span>
<span class="cm">		 * download on non-spectrum_cs based cards.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Given that the Agere firmware download works</span>
<span class="cm">		 * differently, we should avoid doing a firmware</span>
<span class="cm">		 * download with the Symbol algorithm on non-spectrum</span>
<span class="cm">		 * cards.</span>
<span class="cm">		 *</span>
<span class="cm">		 * For now we can identify a spectrum_cs based card</span>
<span class="cm">		 * because it has a firmware reset function.</span>
<span class="cm">		 */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_fw_download</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stop_fw</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">broken_disableport</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">==</span> <span class="mh">0x25013</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x30000</span> <span class="o">&amp;&amp;</span> <span class="n">firmver</span> <span class="o">&lt;=</span> <span class="mh">0x31000</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_hostscan</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x31001</span><span class="p">)</span> <span class="o">||</span>
				     <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x29057</span> <span class="o">&amp;&amp;</span> <span class="n">firmver</span> <span class="o">&lt;</span> <span class="mh">0x30000</span><span class="p">);</span>
		<span class="cm">/* Tested with Intel firmware : 0x20015 =&gt; Jean II */</span>
		<span class="cm">/* Tested with 3Com firmware : 0x15012 &amp; 0x22001 =&gt; Jean II */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_INTERSIL</span>:
		<span class="cm">/* D-Link, Linksys, Adtron, ZoomAir, and many others...</span>
<span class="cm">		 * Samsung, Compaq 100/200 and Proxim are slightly</span>
<span class="cm">		 * different and less well tested */</span>
		<span class="cm">/* D-Link MAC : 00:40:05:* */</span>
		<span class="cm">/* Addtron MAC : 00:90:D1:* */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw_name</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">fw_name</span><span class="p">,</span> <span class="n">fw_name_len</span><span class="p">,</span> <span class="s">&quot;Intersil %d.%d.%d&quot;</span><span class="p">,</span>
				 <span class="n">sta_id</span><span class="p">.</span><span class="n">major</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">.</span><span class="n">minor</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>

		<span class="n">firmver</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sta_id</span><span class="p">.</span><span class="n">major</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sta_id</span><span class="p">.</span><span class="n">minor</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">sta_id</span><span class="p">.</span><span class="n">variant</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_ibss</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x000700</span><span class="p">);</span> <span class="cm">/* FIXME */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_big_wep</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wep</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x000800</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_pm</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x000700</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_hostscan</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x010301</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">firmver</span> <span class="o">&gt;=</span> <span class="mh">0x000800</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibss_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Intersil firmware earlier than v0.8.x&quot;</span>
				   <span class="s">&quot; - several features not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ibss_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_name</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Firmware determined as %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_HERMES_PRISM</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span> <span class="o">==</span> <span class="n">FIRMWARE_TYPE_INTERSIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Support for Prism chipset is not enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read settings from EEPROM into our private structure.</span>
<span class="cm"> * MAC address gets dropped into callers buffer</span>
<span class="cm"> * Can be called before netdev registration.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">orinoco_hw_read_card_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dev_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes_idstring</span> <span class="n">nickbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reclen</span><span class="p">;</span>

	<span class="cm">/* Get the MAC address */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CNFOWNMACADDR</span><span class="p">,</span>
				<span class="n">ETH_ALEN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read MAC address!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAC address %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">);</span>

	<span class="cm">/* Get the station name */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CNFOWNNAME</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">nickbuf</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">reclen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nickbuf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to read station name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nickbuf</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">IW_ESSID_MAX_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nickbuf</span><span class="p">.</span><span class="n">len</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">IW_ESSID_MAX_SIZE</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">reclen</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nickbuf</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Station name </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">);</span>

	<span class="cm">/* Get allowed channels */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CHANNELLIST</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read channel list!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get initial AP density */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CNFSYSTEMSCALE</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_density</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_density</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_density</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_sensitivity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get initial RTS threshold */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CNFRTSTHRESHOLD</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_thresh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read RTS threshold!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get initial fragmentation settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_mwo</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					  <span class="n">HERMES_RID_CNFMWOROBUST_AGERE</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mwo_robust</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					  <span class="n">HERMES_RID_CNFFRAGMENTATIONTHRESHOLD</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_thresh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read fragmentation settings!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Power management setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_mcast</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					  <span class="n">HERMES_RID_CNFMAXSLEEPDURATION</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_period</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read power management &quot;</span>
				<span class="s">&quot;period!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					  <span class="n">HERMES_RID_CNFPMHOLDOVERDURATION</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read power management &quot;</span>
				<span class="s">&quot;timeout!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Preamble setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_preamble</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					  <span class="n">HERMES_RID_CNFPREAMBLE_SYMBOL</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read preamble setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Retry settings */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_SHORTRETRYLIMIT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read short retry limit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_LONGRETRYLIMIT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read long retry limit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_MAXTRANSMITLIFETIME</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">retry_lifetime</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read max retry lifetime</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Can be called before netdev registration */</span>
<span class="kt">int</span> <span class="nf">orinoco_hw_allocate_fid</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nicbuf_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nicbuf_size</span> <span class="o">&gt;</span> <span class="n">TX_NICBUF_SIZE_BUG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Try workaround for old Symbol firmware bug */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nicbuf_size</span> <span class="o">=</span> <span class="n">TX_NICBUF_SIZE_BUG</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nicbuf_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">);</span>

		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Firmware ALLOC bug detected &quot;</span>
			 <span class="s">&quot;(old Symbol firmware?). Work around %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">err</span> <span class="o">?</span> <span class="s">&quot;failed!&quot;</span> <span class="o">:</span> <span class="s">&quot;ok.&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">orinoco_get_bitratemode</span><span class="p">(</span><span class="kt">int</span> <span class="n">bitrate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">automatic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ratemode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bitrate</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bitrate</span> <span class="o">!=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bitrate</span> <span class="o">!=</span> <span class="mi">55</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bitrate</span> <span class="o">!=</span> <span class="mi">110</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ratemode</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BITRATE_TABLE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bitrate_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">==</span> <span class="n">bitrate</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">bitrate_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">automatic</span> <span class="o">==</span> <span class="n">automatic</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ratemode</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ratemode</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">orinoco_get_ratemode_cfg</span><span class="p">(</span><span class="kt">int</span> <span class="n">ratemode</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitrate</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">automatic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">ratemode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ratemode</span> <span class="o">&gt;=</span> <span class="n">BITRATE_TABLE_SIZE</span><span class="p">));</span>

	<span class="o">*</span><span class="n">bitrate</span> <span class="o">=</span> <span class="n">bitrate_table</span><span class="p">[</span><span class="n">ratemode</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="o">*</span><span class="n">automatic</span> <span class="o">=</span> <span class="n">bitrate_table</span><span class="p">[</span><span class="n">ratemode</span><span class="p">].</span><span class="n">automatic</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">orinoco_hw_program_rids</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes_idstring</span> <span class="n">idbuf</span><span class="p">;</span>

	<span class="cm">/* Set the MAC address */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CNFOWNMACADDR</span><span class="p">,</span>
				 <span class="n">HERMES_BYTES_TO_RECLEN</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">),</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting MAC address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up the link mode */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CNFPORTTYPE</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting port type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Set the channel/frequency */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFOWNCHANNEL</span><span class="p">,</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_ibss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">createibss</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_essid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">createibss</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: This firmware requires an &quot;</span>
			       <span class="s">&quot;ESSID in IBSS-Ad-Hoc mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="cm">/* With wvlan_cs, in this case, we would crash.</span>
<span class="cm">			 * hopefully, this driver will behave better...</span>
<span class="cm">			 * Jean II */</span>
			<span class="n">createibss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">createibss</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">createibss</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFCREATEIBSS</span><span class="p">,</span>
					   <span class="n">createibss</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting CREATEIBSS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set the desired BSSID */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__orinoco_hw_set_wap</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting AP address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the desired ESSID */</span>
	<span class="n">idbuf</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_essid</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idbuf</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_essid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idbuf</span><span class="p">.</span><span class="n">val</span><span class="p">));</span>
	<span class="cm">/* WinXP wants partner to configure OWNSSID even in IBSS mode. (jimc) */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CNFOWNSSID</span><span class="p">,</span>
			<span class="n">HERMES_BYTES_TO_RECLEN</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_essid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">idbuf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting OWNSSID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CNFDESIREDSSID</span><span class="p">,</span>
			<span class="n">HERMES_BYTES_TO_RECLEN</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_essid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">idbuf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting DESIREDSSID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the station name */</span>
	<span class="n">idbuf</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idbuf</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idbuf</span><span class="p">.</span><span class="n">val</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CNFOWNNAME</span><span class="p">,</span>
				 <span class="n">HERMES_BYTES_TO_RECLEN</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
				 <span class="o">&amp;</span><span class="n">idbuf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting nickname</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set AP density */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_sensitivity</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFSYSTEMSCALE</span><span class="p">,</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_density</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Error %d setting SYSTEMSCALE. &quot;</span>
			       <span class="s">&quot;Disabling sensitivity control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_sensitivity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set RTS threshold */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CNFRTSTHRESHOLD</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_thresh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting RTS threshold</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set fragmentation threshold or MWO robustness */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_mwo</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFMWOROBUST_AGERE</span><span class="p">,</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mwo_robust</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFFRAGMENTATIONTHRESHOLD</span><span class="p">,</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_thresh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting fragmentation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set bitrate */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__orinoco_hw_set_bitrate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting bitrate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set power management */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_pm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFPMENABLED</span><span class="p">,</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_on</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting up PM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFMULTICASTRECEIVE</span><span class="p">,</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_mcast</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting up PM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFMAXSLEEPDURATION</span><span class="p">,</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_period</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting up PM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFPMHOLDOVERDURATION</span><span class="p">,</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting up PM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set preamble - only for Symbol so far... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_preamble</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFPREAMBLE_SYMBOL</span><span class="p">,</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting preamble</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set up encryption */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wep</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wpa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__orinoco_hw_setup_enc</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d activating encryption</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable monitor mode */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_IEEE80211</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cmd_wait</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HERMES_CMD_TEST</span> <span class="o">|</span>
					    <span class="n">HERMES_TEST_MONITOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Disable monitor mode */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cmd_wait</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HERMES_CMD_TEST</span> <span class="o">|</span>
					    <span class="n">HERMES_TEST_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Reset promiscuity / multicast*/</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">promiscuous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Record mode change */</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get tsc from the firmware */</span>
<span class="kt">int</span> <span class="nf">orinoco_hw_get_tkip_iv</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tsc_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">ORINOCO_SEQ_LEN</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">key</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">key</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CURRENT_TKIP_IV</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">tsc_arr</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsc_arr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsc_arr</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tsc_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__orinoco_hw_set_bitrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ratemode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bitratemode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ratemode</span> <span class="o">&gt;=</span> <span class="n">BITRATE_TABLE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: BUG: Invalid bitrate mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ratemode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_AGERE</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				<span class="n">HERMES_RID_CNFTXRATECONTROL</span><span class="p">,</span>
				<span class="n">bitrate_table</span><span class="p">[</span><span class="n">ratemode</span><span class="p">].</span><span class="n">agere_txratectrl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_INTERSIL</span>:
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_SYMBOL</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				<span class="n">HERMES_RID_CNFTXRATECONTROL</span><span class="p">,</span>
				<span class="n">bitrate_table</span><span class="p">[</span><span class="n">ratemode</span><span class="p">].</span><span class="n">intersil_txratectrl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">orinoco_hw_get_act_bitrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bitrate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				  <span class="n">HERMES_RID_CURRENTTXRATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_AGERE</span>: <span class="cm">/* Lucent style rate */</span>
		<span class="cm">/* Note : in Lucent firmware, the return value of</span>
<span class="cm">		 * HERMES_RID_CURRENTTXRATE is the bitrate in Mb/s,</span>
<span class="cm">		 * and therefore is totally different from the</span>
<span class="cm">		 * encoding of HERMES_RID_CNFTXRATECONTROL.</span>
<span class="cm">		 * Don&#39;t forget that 6Mb/s is really 5.5Mb/s */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
			<span class="o">*</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">5500000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">bitrate</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_INTERSIL</span>: <span class="cm">/* Intersil style rate */</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_SYMBOL</span>: <span class="cm">/* Symbol style rate */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BITRATE_TABLE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bitrate_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">intersil_txratectrl</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">bitrate</span> <span class="o">=</span> <span class="n">bitrate_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">BITRATE_TABLE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Unable to determine current bitrate (0x%04hx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set fixed AP address */</span>
<span class="kt">int</span> <span class="nf">__orinoco_hw_set_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">roaming_flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_AGERE</span>:
		<span class="cm">/* not supported */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_INTERSIL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid_fixed</span><span class="p">)</span>
			<span class="n">roaming_flag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">roaming_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFROAMINGMODE</span><span class="p">,</span>
					   <span class="n">roaming_flag</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_SYMBOL</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">HERMES_WRITE_RECORD</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					  <span class="n">HERMES_RID_CNFMANDATORYBSSID_SYMBOL</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_bssid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Change the WEP keys and/or the current keys.  Can be called</span>
<span class="cm"> * either from __orinoco_hw_setup_enc() or directly from</span>
<span class="cm"> * orinoco_ioctl_setiwencode().  In the later case the association</span>
<span class="cm"> * with the AP is not broken (if the firmware can handle it),</span>
<span class="cm"> * which is needed for 802.1x implementations. */</span>
<span class="kt">int</span> <span class="nf">__orinoco_hw_setup_wepkeys</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_AGERE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">orinoco_key</span> <span class="n">keys</span><span class="p">[</span><span class="n">ORINOCO_MAX_KEYS</span><span class="p">];</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keys</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ORINOCO_MAX_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_len</span><span class="p">,</span>
				      <span class="n">ORINOCO_MAX_KEY_SIZE</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">SMALL_KEY_SIZE</span><span class="p">)</span>
				<span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LARGE_KEY_SIZE</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMALL_KEY_SIZE</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">HERMES_WRITE_RECORD</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					  <span class="n">HERMES_RID_CNFWEPKEYS_AGERE</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">keys</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFTXKEY_AGERE</span><span class="p">,</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_INTERSIL</span>:
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_SYMBOL</span>:
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">keylen</span><span class="p">;</span>

			<span class="cm">/* Force uniform key length to work around</span>
<span class="cm">			 * firmware bugs */</span>
			<span class="n">keylen</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span><span class="p">].</span><span class="n">key_len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">keylen</span> <span class="o">&gt;</span> <span class="n">LARGE_KEY_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: BUG: Key %d has oversize length %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">keylen</span> <span class="o">&gt;</span> <span class="n">SMALL_KEY_SIZE</span><span class="p">)</span>
				<span class="n">keylen</span> <span class="o">=</span> <span class="n">LARGE_KEY_SIZE</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">keylen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">keylen</span> <span class="o">=</span> <span class="n">SMALL_KEY_SIZE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">keylen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Write all 4 keys */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ORINOCO_MAX_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="n">LARGE_KEY_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

				<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span><span class="p">,</span>
				       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_len</span><span class="p">);</span>

				<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
						<span class="n">HERMES_RID_CNFDEFAULTKEY0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
						<span class="n">HERMES_BYTES_TO_RECLEN</span><span class="p">(</span><span class="n">keylen</span><span class="p">),</span>
						<span class="n">key</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Write the index of the key used in transmission */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
						<span class="n">HERMES_RID_CNFWEPDEFAULTKEYID</span><span class="p">,</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_key</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__orinoco_hw_setup_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">master_wep_flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">auth_flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enc_flag</span><span class="p">;</span>

	<span class="cm">/* Setup WEP keys */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span> <span class="o">==</span> <span class="n">ORINOCO_ALG_WEP</span><span class="p">)</span>
		<span class="n">__orinoco_hw_setup_wepkeys</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_restrict</span><span class="p">)</span>
		<span class="n">auth_flag</span> <span class="o">=</span> <span class="n">HERMES_AUTH_SHARED_KEY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">auth_flag</span> <span class="o">=</span> <span class="n">HERMES_AUTH_OPEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_enabled</span><span class="p">)</span>
		<span class="n">enc_flag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span> <span class="o">==</span> <span class="n">ORINOCO_ALG_WEP</span><span class="p">)</span>
		<span class="n">enc_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">enc_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_AGERE</span>: <span class="cm">/* Agere style WEP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span> <span class="o">==</span> <span class="n">ORINOCO_ALG_WEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Enable the shared-key authentication. */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					<span class="n">HERMES_RID_CNFAUTHENTICATION_AGERE</span><span class="p">,</span>
					<span class="n">auth_flag</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFWEPENABLED_AGERE</span><span class="p">,</span>
					   <span class="n">enc_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wpa</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Set WPA key management */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				  <span class="n">HERMES_RID_CNFSETWPAAUTHMGMTSUITE_AGERE</span><span class="p">,</span>
				  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">key_mgmt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_INTERSIL</span>: <span class="cm">/* Intersil style WEP */</span>
	<span class="k">case</span> <span class="n">FIRMWARE_TYPE_SYMBOL</span>: <span class="cm">/* Symbol style WEP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encode_alg</span> <span class="o">==</span> <span class="n">ORINOCO_ALG_WEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_restrict</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span> <span class="o">==</span> <span class="n">FIRMWARE_TYPE_SYMBOL</span><span class="p">))</span>
				<span class="n">master_wep_flag</span> <span class="o">=</span> <span class="n">HERMES_WEP_PRIVACY_INVOKED</span> <span class="o">|</span>
						  <span class="n">HERMES_WEP_EXCL_UNENCRYPTED</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">master_wep_flag</span> <span class="o">=</span> <span class="n">HERMES_WEP_PRIVACY_INVOKED</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
						   <span class="n">HERMES_RID_CNFAUTHENTICATION</span><span class="p">,</span>
						   <span class="n">auth_flag</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">master_wep_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">)</span>
			<span class="n">master_wep_flag</span> <span class="o">|=</span> <span class="n">HERMES_WEP_HOST_DECRYPT</span><span class="p">;</span>

		<span class="cm">/* Master WEP setting : on/off */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFWEPFLAGS_INTERSIL</span><span class="p">,</span>
					   <span class="n">master_wep_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* key must be 32 bytes, including the tx and rx MIC keys.</span>
<span class="cm"> * rsc must be NULL or up to 8 bytes</span>
<span class="cm"> * tsc must be NULL or up to 8 bytes</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__orinoco_hw_set_tkip_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key_idx</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">set_tx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rsc</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">rsc_len</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="o">*</span><span class="n">tsc</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tsc_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">rsc</span><span class="p">[</span><span class="n">ORINOCO_SEQ_LEN</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="n">TKIP_KEYLEN</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">tx_mic</span><span class="p">[</span><span class="n">MIC_KEYLEN</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">rx_mic</span><span class="p">[</span><span class="n">MIC_KEYLEN</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">tsc</span><span class="p">[</span><span class="n">ORINOCO_SEQ_LEN</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">__packed</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">xmitting</span><span class="p">;</span>

	<span class="n">key_idx</span> <span class="o">&amp;=</span> <span class="mh">0x3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_tx</span><span class="p">)</span>
		<span class="n">key_idx</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">key_idx</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">tx_mic</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">rx_mic</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsc_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">rsc</span><span class="p">))</span>
		<span class="n">rsc_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">rsc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tsc_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">tsc</span><span class="p">))</span>
		<span class="n">tsc_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">tsc</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">rsc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">rsc</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">tsc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">tsc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">rsc</span><span class="p">,</span> <span class="n">rsc</span><span class="p">,</span> <span class="n">rsc_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tsc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">tsc</span><span class="p">,</span> <span class="n">tsc</span><span class="p">,</span> <span class="n">tsc_len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">buf</span><span class="p">.</span><span class="n">tsc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="cm">/* Wait up to 100ms for tx queue to empty */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_TXQUEUEEMPTY</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">xmitting</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="o">!</span><span class="n">xmitting</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">HERMES_WRITE_RECORD</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				  <span class="n">HERMES_RID_CNFADDDEFAULTTKIPKEY_AGERE</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">orinoco_clear_tkip_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				   <span class="n">HERMES_RID_CNFREMDEFAULTTKIPKEY_AGERE</span><span class="p">,</span>
				   <span class="n">key_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Error %d clearing TKIP key %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__orinoco_hw_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">mc_count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">promisc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">promisc</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">promiscuous</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					   <span class="n">HERMES_RID_CNFPROMISCUOUSMODE</span><span class="p">,</span>
					   <span class="n">promisc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting PROMISCUOUSMODE to 1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">promiscuous</span> <span class="o">=</span> <span class="n">promisc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If we&#39;re not in promiscuous mode, then we need to set the</span>
<span class="cm">	 * group address if either we want to multicast, or if we were</span>
<span class="cm">	 * multicasting and want to stop */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">promisc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mc_count</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hermes_multicast</span> <span class="n">mclist</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">mc_count</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mclist</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				   <span class="n">HERMES_RID_CNFGROUPADDRESSES</span><span class="p">,</span>
				   <span class="n">HERMES_BYTES_TO_RECLEN</span><span class="p">(</span><span class="n">mc_count</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">),</span>
				   <span class="o">&amp;</span><span class="n">mclist</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d setting multicast list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc_count</span> <span class="o">=</span> <span class="n">mc_count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return : &lt; 0 -&gt; error code ; &gt;= 0 -&gt; length */</span>
<span class="kt">int</span> <span class="nf">orinoco_hw_get_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">active</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">IW_ESSID_MAX_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes_idstring</span> <span class="n">essidbuf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">essidbuf</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desired_essid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We read the desired SSID from the hardware rather</span>
<span class="cm">		   than from priv-&gt;desired_essid, just in case the</span>
<span class="cm">		   firmware is allowed to change it on us. I&#39;m not</span>
<span class="cm">		   sure about this */</span>
		<span class="cm">/* My guess is that the OWNSSID should always be whatever</span>
<span class="cm">		 * we set to the card, whereas CURRENT_SSID is the one that</span>
<span class="cm">		 * may change... - Jean II */</span>
		<span class="n">u16</span> <span class="n">rid</span><span class="p">;</span>

		<span class="o">*</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">rid</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="n">HERMES_RID_CNFOWNSSID</span> <span class="o">:</span>
			<span class="n">HERMES_RID_CNFDESIREDSSID</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">essidbuf</span><span class="p">),</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">essidbuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_unlock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CURRENTSSID</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">essidbuf</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">essidbuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">essidbuf</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

 <span class="nl">fail_unlock:</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">orinoco_hw_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_read_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CURRENTCHANNEL</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Intersil firmware 1.3.5 returns 0 when the interface is down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="n">NUM_CHANNELS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Channel out of range (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">ieee80211_dsss_chan_to_freq</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">freq</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">orinoco_hw_get_bitratelist</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">numrates</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">rates</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes_idstring</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">list</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_SUPPORTEDDATARATES</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">list</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">num</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="o">*</span><span class="n">numrates</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span> <span class="cm">/* convert to bps */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">orinoco_hw_trigger_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">cfg80211_ssid</span> <span class="o">*</span><span class="n">ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orinoco_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Scanning with port 0 disabled would fail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* In monitor mode, the scan results are always empty.</span>
<span class="cm">	 * Probe responses are passed to the driver as received</span>
<span class="cm">	 * frames and could be processed in software. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_hostscan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FIRMWARE_TYPE_SYMBOL</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
						<span class="n">HERMES_RID_CNFHOSTSCAN_SYMBOL</span><span class="p">,</span>
						<span class="n">HERMES_HOSTSCAN_SYMBOL_ONCE</span> <span class="o">|</span>
						<span class="n">HERMES_HOSTSCAN_SYMBOL_BCAST</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIRMWARE_TYPE_INTERSIL</span>: <span class="p">{</span>
			<span class="n">__le16</span> <span class="n">req</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

			<span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x3fff</span><span class="p">);</span>	<span class="cm">/* All channels */</span>
			<span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">);</span>	<span class="cm">/* rate 1 Mbps */</span>
			<span class="n">req</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* Any ESSID */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">HERMES_WRITE_RECORD</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
						  <span class="n">HERMES_RID_CNFHOSTSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">FIRMWARE_TYPE_AGERE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ssid</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">hermes_idstring</span> <span class="n">idbuf</span><span class="p">;</span>
				<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ssid</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>

				<span class="n">idbuf</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">idbuf</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">ssid</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

				<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
					       <span class="n">HERMES_RID_CNFSCANSSID_AGERE</span><span class="p">,</span>
					       <span class="n">HERMES_BYTES_TO_RECLEN</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="n">idbuf</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
						   <span class="n">HERMES_RID_CNFSCANSSID_AGERE</span><span class="p">,</span>
						   <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Any ESSID */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_ext_scan</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_write_wordrec</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
						<span class="n">HERMES_RID_CNFSCANCHANNELS2GHZ</span><span class="p">,</span>
						<span class="mh">0x7FFF</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

				<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_inquire</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						     <span class="n">HERMES_INQ_CHANNELINFO</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_inquire</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HERMES_INQ_SCAN</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hermes_inquire</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HERMES_INQ_SCAN</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">orinoco_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Disassociate from node with BSSID addr */</span>
<span class="kt">int</span> <span class="nf">orinoco_hw_disassociate</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reason_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
		<span class="n">__le16</span> <span class="n">reason_code</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__packed</span> <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* Currently only supported by WPA enabled Agere fw */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_wpa</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">reason_code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">reason_code</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">HERMES_WRITE_RECORD</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span>
				  <span class="n">HERMES_RID_CNFDISASSOCIATE</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">orinoco_hw_get_current_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">orinoco_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hermes</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_ltv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">USER_BAP</span><span class="p">,</span> <span class="n">HERMES_RID_CURRENTBSSID</span><span class="p">,</span>
				<span class="n">ETH_ALEN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
