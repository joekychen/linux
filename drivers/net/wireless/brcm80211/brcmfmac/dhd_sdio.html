<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › brcm80211 › brcmfmac › dhd_sdio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>dhd_sdio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY</span>
<span class="cm"> * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION</span>
<span class="cm"> * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/printk.h&gt;</span>
<span class="cp">#include &lt;linux/pci_ids.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdio.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdio_func.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/card.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/bcma/bcma.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;defs.h&gt;</span>
<span class="cp">#include &lt;brcmu_wifi.h&gt;</span>
<span class="cp">#include &lt;brcmu_utils.h&gt;</span>
<span class="cp">#include &lt;brcm_hw_ids.h&gt;</span>
<span class="cp">#include &lt;soc.h&gt;</span>
<span class="cp">#include &quot;sdio_host.h&quot;</span>
<span class="cp">#include &quot;sdio_chip.h&quot;</span>

<span class="cp">#define DCMD_RESP_TIMEOUT  2000	</span><span class="cm">/* In milli second */</span><span class="cp"></span>

<span class="cp">#ifdef DEBUG</span>

<span class="cp">#define BRCMF_TRAP_INFO_SIZE	80</span>

<span class="cp">#define CBUF_LEN	(128)</span>

<span class="k">struct</span> <span class="n">rte_log_le</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">buf</span><span class="p">;</span>		<span class="cm">/* Can&#39;t be pointer on (64-bit) hosts */</span>
	<span class="n">__le32</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">_buf_compat</span><span class="p">;</span>	<span class="cm">/* Redundant pointer for backward compat. */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rte_console</span> <span class="p">{</span>
	<span class="cm">/* Virtual UART</span>
<span class="cm">	 * When there is no UART (e.g. Quickturn),</span>
<span class="cm">	 * the host should write a complete</span>
<span class="cm">	 * input line directly into cbuf and then write</span>
<span class="cm">	 * the length into vcons_in.</span>
<span class="cm">	 * This may also be used when there is a real UART</span>
<span class="cm">	 * (at risk of conflicting with</span>
<span class="cm">	 * the real UART).  vcons_out is currently unused.</span>
<span class="cm">	 */</span>
	<span class="n">uint</span> <span class="n">vcons_in</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">vcons_out</span><span class="p">;</span>

	<span class="cm">/* Output (logging) buffer</span>
<span class="cm">	 * Console output is written to a ring buffer log_buf at index log_idx.</span>
<span class="cm">	 * The host may read the output when it sees log_idx advance.</span>
<span class="cm">	 * Output will be lost if the output wraps around faster than the host</span>
<span class="cm">	 * polls.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">rte_log_le</span> <span class="n">log_le</span><span class="p">;</span>

	<span class="cm">/* Console input line buffer</span>
<span class="cm">	 * Characters are read one at a time into cbuf</span>
<span class="cm">	 * until &lt;CR&gt; is received, then</span>
<span class="cm">	 * the buffer is processed as a command line.</span>
<span class="cm">	 * Also used for virtual UART.</span>
<span class="cm">	 */</span>
	<span class="n">uint</span> <span class="n">cbuf_idx</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cbuf</span><span class="p">[</span><span class="n">CBUF_LEN</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>
<span class="cp">#include &lt;chipcommon.h&gt;</span>

<span class="cp">#include &quot;dhd_bus.h&quot;</span>
<span class="cp">#include &quot;dhd_dbg.h&quot;</span>

<span class="cp">#define TXQLEN		2048	</span><span class="cm">/* bulk tx queue length */</span><span class="cp"></span>
<span class="cp">#define TXHI		(TXQLEN - 256)	</span><span class="cm">/* turn on flow control above TXHI */</span><span class="cp"></span>
<span class="cp">#define TXLOW		(TXHI - 256)	</span><span class="cm">/* turn off flow control below TXLOW */</span><span class="cp"></span>
<span class="cp">#define PRIOMASK	7</span>

<span class="cp">#define TXRETRIES	2	</span><span class="cm">/* # of retries for tx frames */</span><span class="cp"></span>

<span class="cp">#define BRCMF_RXBOUND	50	</span><span class="cm">/* Default for max rx frames in</span>
<span class="cm">				 one scheduling */</span><span class="cp"></span>

<span class="cp">#define BRCMF_TXBOUND	20	</span><span class="cm">/* Default for max tx frames in</span>
<span class="cm">				 one scheduling */</span><span class="cp"></span>

<span class="cp">#define BRCMF_TXMINMAX	1	</span><span class="cm">/* Max tx frames if rx still pending */</span><span class="cp"></span>

<span class="cp">#define MEMBLOCK	2048	</span><span class="cm">/* Block size used for downloading</span>
<span class="cm">				 of dongle image */</span><span class="cp"></span>
<span class="cp">#define MAX_DATA_BUF	(32 * 1024)	</span><span class="cm">/* Must be large enough to hold</span>
<span class="cm">				 biggest possible glom */</span><span class="cp"></span>

<span class="cp">#define BRCMF_FIRSTREAD	(1 &lt;&lt; 6)</span>


<span class="cm">/* SBSDIO_DEVICE_CTL */</span>

<span class="cm">/* 1: device will assert busy signal when receiving CMD53 */</span>
<span class="cp">#define SBSDIO_DEVCTL_SETBUSY		0x01</span>
<span class="cm">/* 1: assertion of sdio interrupt is synchronous to the sdio clock */</span>
<span class="cp">#define SBSDIO_DEVCTL_SPI_INTR_SYNC	0x02</span>
<span class="cm">/* 1: mask all interrupts to host except the chipActive (rev 8) */</span>
<span class="cp">#define SBSDIO_DEVCTL_CA_INT_ONLY	0x04</span>
<span class="cm">/* 1: isolate internal sdio signals, put external pads in tri-state; requires</span>
<span class="cm"> * sdio bus power cycle to clear (rev 9) */</span>
<span class="cp">#define SBSDIO_DEVCTL_PADS_ISO		0x08</span>
<span class="cm">/* Force SD-&gt;SB reset mapping (rev 11) */</span>
<span class="cp">#define SBSDIO_DEVCTL_SB_RST_CTL	0x30</span>
<span class="cm">/*   Determined by CoreControl bit */</span>
<span class="cp">#define SBSDIO_DEVCTL_RST_CORECTL	0x00</span>
<span class="cm">/*   Force backplane reset */</span>
<span class="cp">#define SBSDIO_DEVCTL_RST_BPRESET	0x10</span>
<span class="cm">/*   Force no backplane reset */</span>
<span class="cp">#define SBSDIO_DEVCTL_RST_NOBPRESET	0x20</span>

<span class="cm">/* direct(mapped) cis space */</span>

<span class="cm">/* MAPPED common CIS address */</span>
<span class="cp">#define SBSDIO_CIS_BASE_COMMON		0x1000</span>
<span class="cm">/* maximum bytes in one CIS */</span>
<span class="cp">#define SBSDIO_CIS_SIZE_LIMIT		0x200</span>
<span class="cm">/* cis offset addr is &lt; 17 bits */</span>
<span class="cp">#define SBSDIO_CIS_OFT_ADDR_MASK	0x1FFFF</span>

<span class="cm">/* manfid tuple length, include tuple, link bytes */</span>
<span class="cp">#define SBSDIO_CIS_MANFID_TUPLE_LEN	6</span>

<span class="cm">/* intstatus */</span>
<span class="cp">#define I_SMB_SW0	(1 &lt;&lt; 0)	</span><span class="cm">/* To SB Mail S/W interrupt 0 */</span><span class="cp"></span>
<span class="cp">#define I_SMB_SW1	(1 &lt;&lt; 1)	</span><span class="cm">/* To SB Mail S/W interrupt 1 */</span><span class="cp"></span>
<span class="cp">#define I_SMB_SW2	(1 &lt;&lt; 2)	</span><span class="cm">/* To SB Mail S/W interrupt 2 */</span><span class="cp"></span>
<span class="cp">#define I_SMB_SW3	(1 &lt;&lt; 3)	</span><span class="cm">/* To SB Mail S/W interrupt 3 */</span><span class="cp"></span>
<span class="cp">#define I_SMB_SW_MASK	0x0000000f	</span><span class="cm">/* To SB Mail S/W interrupts mask */</span><span class="cp"></span>
<span class="cp">#define I_SMB_SW_SHIFT	0	</span><span class="cm">/* To SB Mail S/W interrupts shift */</span><span class="cp"></span>
<span class="cp">#define I_HMB_SW0	(1 &lt;&lt; 4)	</span><span class="cm">/* To Host Mail S/W interrupt 0 */</span><span class="cp"></span>
<span class="cp">#define I_HMB_SW1	(1 &lt;&lt; 5)	</span><span class="cm">/* To Host Mail S/W interrupt 1 */</span><span class="cp"></span>
<span class="cp">#define I_HMB_SW2	(1 &lt;&lt; 6)	</span><span class="cm">/* To Host Mail S/W interrupt 2 */</span><span class="cp"></span>
<span class="cp">#define I_HMB_SW3	(1 &lt;&lt; 7)	</span><span class="cm">/* To Host Mail S/W interrupt 3 */</span><span class="cp"></span>
<span class="cp">#define I_HMB_SW_MASK	0x000000f0	</span><span class="cm">/* To Host Mail S/W interrupts mask */</span><span class="cp"></span>
<span class="cp">#define I_HMB_SW_SHIFT	4	</span><span class="cm">/* To Host Mail S/W interrupts shift */</span><span class="cp"></span>
<span class="cp">#define I_WR_OOSYNC	(1 &lt;&lt; 8)	</span><span class="cm">/* Write Frame Out Of Sync */</span><span class="cp"></span>
<span class="cp">#define I_RD_OOSYNC	(1 &lt;&lt; 9)	</span><span class="cm">/* Read Frame Out Of Sync */</span><span class="cp"></span>
<span class="cp">#define	I_PC		(1 &lt;&lt; 10)	</span><span class="cm">/* descriptor error */</span><span class="cp"></span>
<span class="cp">#define	I_PD		(1 &lt;&lt; 11)	</span><span class="cm">/* data error */</span><span class="cp"></span>
<span class="cp">#define	I_DE		(1 &lt;&lt; 12)	</span><span class="cm">/* Descriptor protocol Error */</span><span class="cp"></span>
<span class="cp">#define	I_RU		(1 &lt;&lt; 13)	</span><span class="cm">/* Receive descriptor Underflow */</span><span class="cp"></span>
<span class="cp">#define	I_RO		(1 &lt;&lt; 14)	</span><span class="cm">/* Receive fifo Overflow */</span><span class="cp"></span>
<span class="cp">#define	I_XU		(1 &lt;&lt; 15)	</span><span class="cm">/* Transmit fifo Underflow */</span><span class="cp"></span>
<span class="cp">#define	I_RI		(1 &lt;&lt; 16)	</span><span class="cm">/* Receive Interrupt */</span><span class="cp"></span>
<span class="cp">#define I_BUSPWR	(1 &lt;&lt; 17)	</span><span class="cm">/* SDIO Bus Power Change (rev 9) */</span><span class="cp"></span>
<span class="cp">#define I_XMTDATA_AVAIL (1 &lt;&lt; 23)	</span><span class="cm">/* bits in fifo */</span><span class="cp"></span>
<span class="cp">#define	I_XI		(1 &lt;&lt; 24)	</span><span class="cm">/* Transmit Interrupt */</span><span class="cp"></span>
<span class="cp">#define I_RF_TERM	(1 &lt;&lt; 25)	</span><span class="cm">/* Read Frame Terminate */</span><span class="cp"></span>
<span class="cp">#define I_WF_TERM	(1 &lt;&lt; 26)	</span><span class="cm">/* Write Frame Terminate */</span><span class="cp"></span>
<span class="cp">#define I_PCMCIA_XU	(1 &lt;&lt; 27)	</span><span class="cm">/* PCMCIA Transmit FIFO Underflow */</span><span class="cp"></span>
<span class="cp">#define I_SBINT		(1 &lt;&lt; 28)	</span><span class="cm">/* sbintstatus Interrupt */</span><span class="cp"></span>
<span class="cp">#define I_CHIPACTIVE	(1 &lt;&lt; 29)	</span><span class="cm">/* chip from doze to active state */</span><span class="cp"></span>
<span class="cp">#define I_SRESET	(1 &lt;&lt; 30)	</span><span class="cm">/* CCCR RES interrupt */</span><span class="cp"></span>
<span class="cp">#define I_IOE2		(1U &lt;&lt; 31)	</span><span class="cm">/* CCCR IOE2 Bit Changed */</span><span class="cp"></span>
<span class="cp">#define	I_ERRORS	(I_PC | I_PD | I_DE | I_RU | I_RO | I_XU)</span>
<span class="cp">#define I_DMA		(I_RI | I_XI | I_ERRORS)</span>

<span class="cm">/* corecontrol */</span>
<span class="cp">#define CC_CISRDY		(1 &lt;&lt; 0)	</span><span class="cm">/* CIS Ready */</span><span class="cp"></span>
<span class="cp">#define CC_BPRESEN		(1 &lt;&lt; 1)	</span><span class="cm">/* CCCR RES signal */</span><span class="cp"></span>
<span class="cp">#define CC_F2RDY		(1 &lt;&lt; 2)	</span><span class="cm">/* set CCCR IOR2 bit */</span><span class="cp"></span>
<span class="cp">#define CC_CLRPADSISO		(1 &lt;&lt; 3)	</span><span class="cm">/* clear SDIO pads isolation */</span><span class="cp"></span>
<span class="cp">#define CC_XMTDATAAVAIL_MODE	(1 &lt;&lt; 4)</span>
<span class="cp">#define CC_XMTDATAAVAIL_CTRL	(1 &lt;&lt; 5)</span>

<span class="cm">/* SDA_FRAMECTRL */</span>
<span class="cp">#define SFC_RF_TERM	(1 &lt;&lt; 0)	</span><span class="cm">/* Read Frame Terminate */</span><span class="cp"></span>
<span class="cp">#define SFC_WF_TERM	(1 &lt;&lt; 1)	</span><span class="cm">/* Write Frame Terminate */</span><span class="cp"></span>
<span class="cp">#define SFC_CRC4WOOS	(1 &lt;&lt; 2)	</span><span class="cm">/* CRC error for write out of sync */</span><span class="cp"></span>
<span class="cp">#define SFC_ABORTALL	(1 &lt;&lt; 3)	</span><span class="cm">/* Abort all in-progress frames */</span><span class="cp"></span>

<span class="cm">/* HW frame tag */</span>
<span class="cp">#define SDPCM_FRAMETAG_LEN	4	</span><span class="cm">/* 2 bytes len, 2 bytes check val */</span><span class="cp"></span>

<span class="cm">/* Total length of frame header for dongle protocol */</span>
<span class="cp">#define SDPCM_HDRLEN	(SDPCM_FRAMETAG_LEN + SDPCM_SWHEADER_LEN)</span>
<span class="cp">#define SDPCM_RESERVE	(SDPCM_HDRLEN + BRCMF_SDALIGN)</span>

<span class="cm">/*</span>
<span class="cm"> * Software allocation of To SB Mailbox resources</span>
<span class="cm"> */</span>

<span class="cm">/* tosbmailbox bits corresponding to intstatus bits */</span>
<span class="cp">#define SMB_NAK		(1 &lt;&lt; 0)	</span><span class="cm">/* Frame NAK */</span><span class="cp"></span>
<span class="cp">#define SMB_INT_ACK	(1 &lt;&lt; 1)	</span><span class="cm">/* Host Interrupt ACK */</span><span class="cp"></span>
<span class="cp">#define SMB_USE_OOB	(1 &lt;&lt; 2)	</span><span class="cm">/* Use OOB Wakeup */</span><span class="cp"></span>
<span class="cp">#define SMB_DEV_INT	(1 &lt;&lt; 3)	</span><span class="cm">/* Miscellaneous Interrupt */</span><span class="cp"></span>

<span class="cm">/* tosbmailboxdata */</span>
<span class="cp">#define SMB_DATA_VERSION_SHIFT	16	</span><span class="cm">/* host protocol version */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Software allocation of To Host Mailbox resources</span>
<span class="cm"> */</span>

<span class="cm">/* intstatus bits */</span>
<span class="cp">#define I_HMB_FC_STATE	I_HMB_SW0	</span><span class="cm">/* Flow Control State */</span><span class="cp"></span>
<span class="cp">#define I_HMB_FC_CHANGE	I_HMB_SW1	</span><span class="cm">/* Flow Control State Changed */</span><span class="cp"></span>
<span class="cp">#define I_HMB_FRAME_IND	I_HMB_SW2	</span><span class="cm">/* Frame Indication */</span><span class="cp"></span>
<span class="cp">#define I_HMB_HOST_INT	I_HMB_SW3	</span><span class="cm">/* Miscellaneous Interrupt */</span><span class="cp"></span>

<span class="cm">/* tohostmailboxdata */</span>
<span class="cp">#define HMB_DATA_NAKHANDLED	1	</span><span class="cm">/* retransmit NAK&#39;d frame */</span><span class="cp"></span>
<span class="cp">#define HMB_DATA_DEVREADY	2	</span><span class="cm">/* talk to host after enable */</span><span class="cp"></span>
<span class="cp">#define HMB_DATA_FC		4	</span><span class="cm">/* per prio flowcontrol update flag */</span><span class="cp"></span>
<span class="cp">#define HMB_DATA_FWREADY	8	</span><span class="cm">/* fw ready for protocol activity */</span><span class="cp"></span>

<span class="cp">#define HMB_DATA_FCDATA_MASK	0xff000000</span>
<span class="cp">#define HMB_DATA_FCDATA_SHIFT	24</span>

<span class="cp">#define HMB_DATA_VERSION_MASK	0x00ff0000</span>
<span class="cp">#define HMB_DATA_VERSION_SHIFT	16</span>

<span class="cm">/*</span>
<span class="cm"> * Software-defined protocol header</span>
<span class="cm"> */</span>

<span class="cm">/* Current protocol version */</span>
<span class="cp">#define SDPCM_PROT_VERSION	4</span>

<span class="cm">/* SW frame header */</span>
<span class="cp">#define SDPCM_PACKET_SEQUENCE(p)	(((u8 *)p)[0] &amp; 0xff)</span>

<span class="cp">#define SDPCM_CHANNEL_MASK		0x00000f00</span>
<span class="cp">#define SDPCM_CHANNEL_SHIFT		8</span>
<span class="cp">#define SDPCM_PACKET_CHANNEL(p)		(((u8 *)p)[1] &amp; 0x0f)</span>

<span class="cp">#define SDPCM_NEXTLEN_OFFSET		2</span>

<span class="cm">/* Data Offset from SOF (HW Tag, SW Tag, Pad) */</span>
<span class="cp">#define SDPCM_DOFFSET_OFFSET		3	</span><span class="cm">/* Data Offset */</span><span class="cp"></span>
<span class="cp">#define SDPCM_DOFFSET_VALUE(p)		(((u8 *)p)[SDPCM_DOFFSET_OFFSET] &amp; 0xff)</span>
<span class="cp">#define SDPCM_DOFFSET_MASK		0xff000000</span>
<span class="cp">#define SDPCM_DOFFSET_SHIFT		24</span>
<span class="cp">#define SDPCM_FCMASK_OFFSET		4	</span><span class="cm">/* Flow control */</span><span class="cp"></span>
<span class="cp">#define SDPCM_FCMASK_VALUE(p)		(((u8 *)p)[SDPCM_FCMASK_OFFSET] &amp; 0xff)</span>
<span class="cp">#define SDPCM_WINDOW_OFFSET		5	</span><span class="cm">/* Credit based fc */</span><span class="cp"></span>
<span class="cp">#define SDPCM_WINDOW_VALUE(p)		(((u8 *)p)[SDPCM_WINDOW_OFFSET] &amp; 0xff)</span>

<span class="cp">#define SDPCM_SWHEADER_LEN	8	</span><span class="cm">/* SW header is 64 bits */</span><span class="cp"></span>

<span class="cm">/* logical channel numbers */</span>
<span class="cp">#define SDPCM_CONTROL_CHANNEL	0	</span><span class="cm">/* Control channel Id */</span><span class="cp"></span>
<span class="cp">#define SDPCM_EVENT_CHANNEL	1	</span><span class="cm">/* Asyc Event Indication Channel Id */</span><span class="cp"></span>
<span class="cp">#define SDPCM_DATA_CHANNEL	2	</span><span class="cm">/* Data Xmit/Recv Channel Id */</span><span class="cp"></span>
<span class="cp">#define SDPCM_GLOM_CHANNEL	3	</span><span class="cm">/* For coalesced packets */</span><span class="cp"></span>
<span class="cp">#define SDPCM_TEST_CHANNEL	15	</span><span class="cm">/* Reserved for test/debug packets */</span><span class="cp"></span>

<span class="cp">#define SDPCM_SEQUENCE_WRAP	256	</span><span class="cm">/* wrap-around val for 8bit frame seq */</span><span class="cp"></span>

<span class="cp">#define SDPCM_GLOMDESC(p)	(((u8 *)p)[1] &amp; 0x80)</span>

<span class="cm">/*</span>
<span class="cm"> * Shared structure between dongle and the host.</span>
<span class="cm"> * The structure contains pointers to trap or assert information.</span>
<span class="cm"> */</span>
<span class="cp">#define SDPCM_SHARED_VERSION       0x0002</span>
<span class="cp">#define SDPCM_SHARED_VERSION_MASK  0x00FF</span>
<span class="cp">#define SDPCM_SHARED_ASSERT_BUILT  0x0100</span>
<span class="cp">#define SDPCM_SHARED_ASSERT        0x0200</span>
<span class="cp">#define SDPCM_SHARED_TRAP          0x0400</span>

<span class="cm">/* Space for header read, limit for data packets */</span>
<span class="cp">#define MAX_HDR_READ	(1 &lt;&lt; 6)</span>
<span class="cp">#define MAX_RX_DATASZ	2048</span>

<span class="cm">/* Maximum milliseconds to wait for F2 to come up */</span>
<span class="cp">#define BRCMF_WAIT_F2RDY	3000</span>

<span class="cm">/* Bump up limit on waiting for HT to account for first startup;</span>
<span class="cm"> * if the image is doing a CRC calculation before programming the PMU</span>
<span class="cm"> * for HT availability, it could take a couple hundred ms more, so</span>
<span class="cm"> * max out at a 1 second (1000000us).</span>
<span class="cm"> */</span>
<span class="cp">#undef PMU_MAX_TRANSITION_DLY</span>
<span class="cp">#define PMU_MAX_TRANSITION_DLY 1000000</span>

<span class="cm">/* Value for ChipClockCSR during initial setup */</span>
<span class="cp">#define BRCMF_INIT_CLKCTL1	(SBSDIO_FORCE_HW_CLKREQ_OFF |	\</span>
<span class="cp">					SBSDIO_ALP_AVAIL_REQ)</span>

<span class="cm">/* Flags for SDH calls */</span>
<span class="cp">#define F2SYNC	(SDIO_REQ_4BYTE | SDIO_REQ_FIXED)</span>

<span class="cp">#define BRCMF_SDIO_FW_NAME	&quot;brcm/brcmfmac-sdio.bin&quot;</span>
<span class="cp">#define BRCMF_SDIO_NV_NAME	&quot;brcm/brcmfmac-sdio.txt&quot;</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">BRCMF_SDIO_FW_NAME</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">BRCMF_SDIO_NV_NAME</span><span class="p">);</span>

<span class="cp">#define BRCMF_IDLE_IMMEDIATE	(-1)	</span><span class="cm">/* Enter idle immediately */</span><span class="cp"></span>
<span class="cp">#define BRCMF_IDLE_ACTIVE	0	</span><span class="cm">/* Do not request any SD clock change</span>
<span class="cm">					 * when idle</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#define BRCMF_IDLE_INTERVAL	1</span>

<span class="cm">/*</span>
<span class="cm"> * Conversion of 802.1D priority to precedence level</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">uint</span> <span class="nf">prio2prec</span><span class="p">(</span><span class="n">u32</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">prio</span> <span class="o">==</span> <span class="n">PRIO_8021D_NONE</span> <span class="o">||</span> <span class="n">prio</span> <span class="o">==</span> <span class="n">PRIO_8021D_BE</span><span class="p">)</span> <span class="o">?</span>
	       <span class="p">(</span><span class="n">prio</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">:</span> <span class="n">prio</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* core registers */</span>
<span class="k">struct</span> <span class="n">sdpcmd_regs</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">corecontrol</span><span class="p">;</span>		<span class="cm">/* 0x00, rev8 */</span>
	<span class="n">u32</span> <span class="n">corestatus</span><span class="p">;</span>			<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">biststatus</span><span class="p">;</span>			<span class="cm">/* rev8 */</span>

	<span class="cm">/* PCMCIA access */</span>
	<span class="n">u16</span> <span class="n">pcmciamesportaladdr</span><span class="p">;</span>	<span class="cm">/* 0x010, rev8 */</span>
	<span class="n">u16</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">pcmciamesportalmask</span><span class="p">;</span>	<span class="cm">/* rev8 */</span>
	<span class="n">u16</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">pcmciawrframebc</span><span class="p">;</span>		<span class="cm">/* rev8 */</span>
	<span class="n">u16</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">pcmciaunderflowtimer</span><span class="p">;</span>	<span class="cm">/* rev8 */</span>
	<span class="n">u16</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* interrupt */</span>
	<span class="n">u32</span> <span class="n">intstatus</span><span class="p">;</span>			<span class="cm">/* 0x020, rev8 */</span>
	<span class="n">u32</span> <span class="n">hostintmask</span><span class="p">;</span>		<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">intmask</span><span class="p">;</span>			<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">sbintstatus</span><span class="p">;</span>		<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">sbintmask</span><span class="p">;</span>			<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">funcintmask</span><span class="p">;</span>		<span class="cm">/* rev4 */</span>
	<span class="n">u32</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">tosbmailbox</span><span class="p">;</span>		<span class="cm">/* 0x040, rev8 */</span>
	<span class="n">u32</span> <span class="n">tohostmailbox</span><span class="p">;</span>		<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">tosbmailboxdata</span><span class="p">;</span>		<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">tohostmailboxdata</span><span class="p">;</span>		<span class="cm">/* rev8 */</span>

	<span class="cm">/* synchronized access to registers in SDIO clock domain */</span>
	<span class="n">u32</span> <span class="n">sdioaccess</span><span class="p">;</span>			<span class="cm">/* 0x050, rev8 */</span>
	<span class="n">u32</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* PCMCIA frame control */</span>
	<span class="n">u8</span> <span class="n">pcmciaframectrl</span><span class="p">;</span>		<span class="cm">/* 0x060, rev8 */</span>
	<span class="n">u8</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">pcmciawatermark</span><span class="p">;</span>		<span class="cm">/* rev8 */</span>
	<span class="n">u8</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">155</span><span class="p">];</span>

	<span class="cm">/* interrupt batching control */</span>
	<span class="n">u32</span> <span class="n">intrcvlazy</span><span class="p">;</span>			<span class="cm">/* 0x100, rev8 */</span>
	<span class="n">u32</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* counters */</span>
	<span class="n">u32</span> <span class="n">cmd52rd</span><span class="p">;</span>			<span class="cm">/* 0x110, rev8 */</span>
	<span class="n">u32</span> <span class="n">cmd52wr</span><span class="p">;</span>			<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">cmd53rd</span><span class="p">;</span>			<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">cmd53wr</span><span class="p">;</span>			<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">abort</span><span class="p">;</span>			<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">datacrcerror</span><span class="p">;</span>		<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">rdoutofsync</span><span class="p">;</span>		<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">wroutofsync</span><span class="p">;</span>		<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">writebusy</span><span class="p">;</span>			<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">readwait</span><span class="p">;</span>			<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">readterm</span><span class="p">;</span>			<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">writeterm</span><span class="p">;</span>			<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">clockctlstatus</span><span class="p">;</span>		<span class="cm">/* rev8 */</span>
	<span class="n">u32</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="n">u32</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>			<span class="cm">/* DMA engines */</span>

	<span class="cm">/* SDIO/PCMCIA CIS region */</span>
	<span class="kt">char</span> <span class="n">cis</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>			<span class="cm">/* 0x400-0x5ff, rev6 */</span>

	<span class="cm">/* PCMCIA function control registers */</span>
	<span class="kt">char</span> <span class="n">pcmciafcr</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>		<span class="cm">/* 0x600-6ff, rev6 */</span>
	<span class="n">u16</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">55</span><span class="p">];</span>

	<span class="cm">/* PCMCIA backplane access */</span>
	<span class="n">u16</span> <span class="n">backplanecsr</span><span class="p">;</span>		<span class="cm">/* 0x76E, rev6 */</span>
	<span class="n">u16</span> <span class="n">backplaneaddr0</span><span class="p">;</span>		<span class="cm">/* rev6 */</span>
	<span class="n">u16</span> <span class="n">backplaneaddr1</span><span class="p">;</span>		<span class="cm">/* rev6 */</span>
	<span class="n">u16</span> <span class="n">backplaneaddr2</span><span class="p">;</span>		<span class="cm">/* rev6 */</span>
	<span class="n">u16</span> <span class="n">backplaneaddr3</span><span class="p">;</span>		<span class="cm">/* rev6 */</span>
	<span class="n">u16</span> <span class="n">backplanedata0</span><span class="p">;</span>		<span class="cm">/* rev6 */</span>
	<span class="n">u16</span> <span class="n">backplanedata1</span><span class="p">;</span>		<span class="cm">/* rev6 */</span>
	<span class="n">u16</span> <span class="n">backplanedata2</span><span class="p">;</span>		<span class="cm">/* rev6 */</span>
	<span class="n">u16</span> <span class="n">backplanedata3</span><span class="p">;</span>		<span class="cm">/* rev6 */</span>
	<span class="n">u16</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>

	<span class="cm">/* sprom &quot;size&quot; &amp; &quot;blank&quot; info */</span>
	<span class="n">u16</span> <span class="n">spromstatus</span><span class="p">;</span>		<span class="cm">/* 0x7BE, rev2 */</span>
	<span class="n">u32</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">464</span><span class="p">];</span>

	<span class="n">u16</span> <span class="n">PAD</span><span class="p">[</span><span class="mh">0x80</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cm">/* Device console log buffer state */</span>
<span class="k">struct</span> <span class="n">brcmf_console</span> <span class="p">{</span>
	<span class="n">uint</span> <span class="n">count</span><span class="p">;</span>		<span class="cm">/* Poll interval msec counter */</span>
	<span class="n">uint</span> <span class="n">log_addr</span><span class="p">;</span>		<span class="cm">/* Log struct address (fixed) */</span>
	<span class="k">struct</span> <span class="n">rte_log_le</span> <span class="n">log_le</span><span class="p">;</span>	<span class="cm">/* Log struct (host copy) */</span>
	<span class="n">uint</span> <span class="n">bufsize</span><span class="p">;</span>		<span class="cm">/* Size of log buffer */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>		<span class="cm">/* Log buffer (host copy) */</span>
	<span class="n">uint</span> <span class="n">last</span><span class="p">;</span>		<span class="cm">/* Last buffer read index */</span>
<span class="p">};</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">sdpcm_shared</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">trap_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">assert_exp_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">assert_file_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">assert_line</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">console_addr</span><span class="p">;</span>	<span class="cm">/* Address of struct rte_console */</span>
	<span class="n">u32</span> <span class="n">msgtrace_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tag</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sdpcm_shared_le</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">trap_addr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">assert_exp_addr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">assert_file_addr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">assert_line</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">console_addr</span><span class="p">;</span>	<span class="cm">/* Address of struct rte_console */</span>
	<span class="n">__le32</span> <span class="n">msgtrace_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tag</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">};</span>


<span class="cm">/* misc chip info needed by some of the routines */</span>
<span class="cm">/* Private data for SDIO bus interaction */</span>
<span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio_dev</span> <span class="o">*</span><span class="n">sdiodev</span><span class="p">;</span>	<span class="cm">/* sdio device handler */</span>
	<span class="k">struct</span> <span class="n">chip_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">;</span>	<span class="cm">/* Chip info struct */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vars</span><span class="p">;</span>		<span class="cm">/* Variables (from CIS and/or other) */</span>
	<span class="n">uint</span> <span class="n">varsz</span><span class="p">;</span>		<span class="cm">/* Size of variables buffer */</span>

	<span class="n">u32</span> <span class="n">ramsize</span><span class="p">;</span>		<span class="cm">/* Size of RAM in SOCRAM (bytes) */</span>

	<span class="n">u32</span> <span class="n">hostintmask</span><span class="p">;</span>	<span class="cm">/* Copy of Host Interrupt Mask */</span>
	<span class="n">u32</span> <span class="n">intstatus</span><span class="p">;</span>	<span class="cm">/* Intstatus bits (events) pending */</span>
	<span class="n">bool</span> <span class="n">dpc_sched</span><span class="p">;</span>		<span class="cm">/* Indicates DPC schedule (intrpt rcvd) */</span>
	<span class="n">bool</span> <span class="n">fcstate</span><span class="p">;</span>		<span class="cm">/* State of dongle flow-control */</span>

	<span class="n">uint</span> <span class="n">blocksize</span><span class="p">;</span>		<span class="cm">/* Block size of SDIO transfers */</span>
	<span class="n">uint</span> <span class="n">roundup</span><span class="p">;</span>		<span class="cm">/* Max roundup limit */</span>

	<span class="k">struct</span> <span class="n">pktq</span> <span class="n">txq</span><span class="p">;</span>	<span class="cm">/* Queue length used for flow-control */</span>
	<span class="n">u8</span> <span class="n">flowcontrol</span><span class="p">;</span>	<span class="cm">/* per prio flow control bitmask */</span>
	<span class="n">u8</span> <span class="n">tx_seq</span><span class="p">;</span>		<span class="cm">/* Transmit sequence number (next) */</span>
	<span class="n">u8</span> <span class="n">tx_max</span><span class="p">;</span>		<span class="cm">/* Maximum transmit sequence allowed */</span>

	<span class="n">u8</span> <span class="n">hdrbuf</span><span class="p">[</span><span class="n">MAX_HDR_READ</span> <span class="o">+</span> <span class="n">BRCMF_SDALIGN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rxhdr</span><span class="p">;</span>		<span class="cm">/* Header of current rx frame (in hdrbuf) */</span>
	<span class="n">u16</span> <span class="n">nextlen</span><span class="p">;</span>		<span class="cm">/* Next Read Len from last header */</span>
	<span class="n">u8</span> <span class="n">rx_seq</span><span class="p">;</span>		<span class="cm">/* Receive sequence number (expected) */</span>
	<span class="n">bool</span> <span class="n">rxskip</span><span class="p">;</span>		<span class="cm">/* Skip receive (awaiting NAK ACK) */</span>

	<span class="n">uint</span> <span class="n">rxbound</span><span class="p">;</span>		<span class="cm">/* Rx frames to read before resched */</span>
	<span class="n">uint</span> <span class="n">txbound</span><span class="p">;</span>		<span class="cm">/* Tx frames to send before resched */</span>
	<span class="n">uint</span> <span class="n">txminmax</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">glomd</span><span class="p">;</span>	<span class="cm">/* Packet containing glomming descriptor */</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">glom</span><span class="p">;</span> <span class="cm">/* Packet list for glommed superframe */</span>
	<span class="n">uint</span> <span class="n">glomerr</span><span class="p">;</span>		<span class="cm">/* Glom packet read errors */</span>

	<span class="n">u8</span> <span class="o">*</span><span class="n">rxbuf</span><span class="p">;</span>		<span class="cm">/* Buffer for receiving control packets */</span>
	<span class="n">uint</span> <span class="n">rxblen</span><span class="p">;</span>		<span class="cm">/* Allocated length of rxbuf */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rxctl</span><span class="p">;</span>		<span class="cm">/* Aligned pointer into rxbuf */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">databuf</span><span class="p">;</span>		<span class="cm">/* Buffer for receiving big glom packet */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dataptr</span><span class="p">;</span>		<span class="cm">/* Aligned pointer into databuf */</span>
	<span class="n">uint</span> <span class="n">rxlen</span><span class="p">;</span>		<span class="cm">/* Length of valid data in buffer */</span>

	<span class="n">u8</span> <span class="n">sdpcm_ver</span><span class="p">;</span>	<span class="cm">/* Bus protocol reported by dongle */</span>

	<span class="n">bool</span> <span class="n">intr</span><span class="p">;</span>		<span class="cm">/* Use interrupts */</span>
	<span class="n">bool</span> <span class="n">poll</span><span class="p">;</span>		<span class="cm">/* Use polling */</span>
	<span class="n">bool</span> <span class="n">ipend</span><span class="p">;</span>		<span class="cm">/* Device interrupt is pending */</span>
	<span class="n">uint</span> <span class="n">intrcount</span><span class="p">;</span>		<span class="cm">/* Count of device interrupt callbacks */</span>
	<span class="n">uint</span> <span class="n">lastintrs</span><span class="p">;</span>		<span class="cm">/* Count as of last watchdog timer */</span>
	<span class="n">uint</span> <span class="n">spurious</span><span class="p">;</span>		<span class="cm">/* Count of spurious interrupts */</span>
	<span class="n">uint</span> <span class="n">pollrate</span><span class="p">;</span>		<span class="cm">/* Ticks between device polls */</span>
	<span class="n">uint</span> <span class="n">polltick</span><span class="p">;</span>		<span class="cm">/* Tick counter */</span>
	<span class="n">uint</span> <span class="n">pollcnt</span><span class="p">;</span>		<span class="cm">/* Count of active polls */</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">uint</span> <span class="n">console_interval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_console</span> <span class="n">console</span><span class="p">;</span>	<span class="cm">/* Console output polling support */</span>
	<span class="n">uint</span> <span class="n">console_addr</span><span class="p">;</span>	<span class="cm">/* Console address from shared struct */</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

	<span class="n">uint</span> <span class="n">regfails</span><span class="p">;</span>		<span class="cm">/* Count of R_REG failures */</span>

	<span class="n">uint</span> <span class="n">clkstate</span><span class="p">;</span>		<span class="cm">/* State of sd and backplane clock(s) */</span>
	<span class="n">bool</span> <span class="n">activity</span><span class="p">;</span>		<span class="cm">/* Activity flag for clock down */</span>
	<span class="n">s32</span> <span class="n">idletime</span><span class="p">;</span>		<span class="cm">/* Control for activity timeout */</span>
	<span class="n">s32</span> <span class="n">idlecount</span><span class="p">;</span>	<span class="cm">/* Activity timeout counter */</span>
	<span class="n">s32</span> <span class="n">idleclock</span><span class="p">;</span>	<span class="cm">/* How to set bus driver when idle */</span>
	<span class="n">s32</span> <span class="n">sd_rxchain</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">use_rxchain</span><span class="p">;</span>	<span class="cm">/* If brcmf should use PKT chains */</span>
	<span class="n">bool</span> <span class="n">sleeping</span><span class="p">;</span>		<span class="cm">/* Is SDIO bus sleeping? */</span>
	<span class="n">bool</span> <span class="n">rxflow_mode</span><span class="p">;</span>	<span class="cm">/* Rx flow control mode */</span>
	<span class="n">bool</span> <span class="n">rxflow</span><span class="p">;</span>		<span class="cm">/* Is rx flow control on */</span>
	<span class="n">bool</span> <span class="n">alp_only</span><span class="p">;</span>		<span class="cm">/* Don&#39;t use HT clock (ALP only) */</span>
<span class="cm">/* Field to decide if rx of control frames happen in rxbuf or lb-pool */</span>
	<span class="n">bool</span> <span class="n">usebufpool</span><span class="p">;</span>

	<span class="cm">/* Some additional counters */</span>
	<span class="n">uint</span> <span class="n">tx_sderrs</span><span class="p">;</span>		<span class="cm">/* Count of tx attempts with sd errors */</span>
	<span class="n">uint</span> <span class="n">fcqueued</span><span class="p">;</span>		<span class="cm">/* Tx packets that got queued */</span>
	<span class="n">uint</span> <span class="n">rxrtx</span><span class="p">;</span>		<span class="cm">/* Count of rtx requests (NAK to dongle) */</span>
	<span class="n">uint</span> <span class="n">rx_toolong</span><span class="p">;</span>	<span class="cm">/* Receive frames too long to receive */</span>
	<span class="n">uint</span> <span class="n">rxc_errors</span><span class="p">;</span>	<span class="cm">/* SDIO errors when reading control frames */</span>
	<span class="n">uint</span> <span class="n">rx_hdrfail</span><span class="p">;</span>	<span class="cm">/* SDIO errors on header reads */</span>
	<span class="n">uint</span> <span class="n">rx_badhdr</span><span class="p">;</span>		<span class="cm">/* Bad received headers (roosync?) */</span>
	<span class="n">uint</span> <span class="n">rx_badseq</span><span class="p">;</span>		<span class="cm">/* Mismatched rx sequence number */</span>
	<span class="n">uint</span> <span class="n">fc_rcvd</span><span class="p">;</span>		<span class="cm">/* Number of flow-control events received */</span>
	<span class="n">uint</span> <span class="n">fc_xoff</span><span class="p">;</span>		<span class="cm">/* Number which turned on flow-control */</span>
	<span class="n">uint</span> <span class="n">fc_xon</span><span class="p">;</span>		<span class="cm">/* Number which turned off flow-control */</span>
	<span class="n">uint</span> <span class="n">rxglomfail</span><span class="p">;</span>	<span class="cm">/* Failed deglom attempts */</span>
	<span class="n">uint</span> <span class="n">rxglomframes</span><span class="p">;</span>	<span class="cm">/* Number of glom frames (superframes) */</span>
	<span class="n">uint</span> <span class="n">rxglompkts</span><span class="p">;</span>	<span class="cm">/* Number of packets from glom frames */</span>
	<span class="n">uint</span> <span class="n">f2rxhdrs</span><span class="p">;</span>		<span class="cm">/* Number of header reads */</span>
	<span class="n">uint</span> <span class="n">f2rxdata</span><span class="p">;</span>		<span class="cm">/* Number of frame data reads */</span>
	<span class="n">uint</span> <span class="n">f2txdata</span><span class="p">;</span>		<span class="cm">/* Number of f2 frame writes */</span>
	<span class="n">uint</span> <span class="n">f1regdata</span><span class="p">;</span>		<span class="cm">/* Number of f1 register accesses */</span>
	<span class="n">uint</span> <span class="n">tickcnt</span><span class="p">;</span>		<span class="cm">/* Number of watchdog been schedule */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_ctlerrs</span><span class="p">;</span>	<span class="cm">/* Err of sending ctrl frames */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_ctlpkts</span><span class="p">;</span>	<span class="cm">/* Ctrl frames sent to dongle */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_ctlerrs</span><span class="p">;</span>	<span class="cm">/* Err of processing rx ctrl frames */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_ctlpkts</span><span class="p">;</span>	<span class="cm">/* Ctrl frames processed from dongle */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_readahead_cnt</span><span class="p">;</span>	<span class="cm">/* Number of packets where header</span>
<span class="cm">					 * read-ahead was used. */</span>

	<span class="n">u8</span> <span class="o">*</span><span class="n">ctrl_frame_buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl_frame_len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ctrl_frame_stat</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">txqlock</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">ctrl_wait</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">dcmd_resp_wait</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">watchdog_wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">watchdog_tsk</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">wd_timer_valid</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">save_ms</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">dpc_tsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">dpc_wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dpc_tsklst</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">dpc_tl_lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">semaphore</span> <span class="n">sdsem</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">firmware</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fw_ptr</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">txoff</span><span class="p">;</span>		<span class="cm">/* Transmit flow-controlled */</span>
<span class="p">};</span>

<span class="cm">/* clkstate */</span>
<span class="cp">#define CLK_NONE	0</span>
<span class="cp">#define CLK_SDONLY	1</span>
<span class="cp">#define CLK_PENDING	2	</span><span class="cm">/* Not used yet */</span><span class="cp"></span>
<span class="cp">#define CLK_AVAIL	3</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qcount</span><span class="p">[</span><span class="n">NUMPRIO</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tx_packets</span><span class="p">[</span><span class="n">NUMPRIO</span><span class="p">];</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="cp">#define SDIO_DRIVE_STRENGTH	6	</span><span class="cm">/* in milliamps */</span><span class="cp"></span>

<span class="cp">#define RETRYCHAN(chan) ((chan) == SDPCM_EVENT_CHANNEL)</span>

<span class="cm">/* Retry count for register access failures */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">uint</span> <span class="n">retry_limit</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="cm">/* Limit on rounding up frames */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">uint</span> <span class="n">max_roundup</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>

<span class="cp">#define ALIGNMENT  4</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_align</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">datalign</span><span class="p">;</span>
	<span class="n">datalign</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">datalign</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">datalign</span><span class="p">,</span> <span class="p">(</span><span class="n">align</span><span class="p">))</span> <span class="o">-</span> <span class="n">datalign</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datalign</span><span class="p">)</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">datalign</span><span class="p">);</span>
	<span class="n">__skb_trim</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* To check if there&#39;s window offered */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">data_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_max</span> <span class="o">-</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	       <span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_max</span> <span class="o">-</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reads a register in the SDIO hardware block. This block occupies a series of</span>
<span class="cm"> * adresses on the 32 bit backplane bus.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">r_sdreg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">regvar</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">brcmf_sdio_chip_getinfidx</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">,</span> <span class="n">BCMA_CORE_SDIO_DEV</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">regvar</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrl</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
				   <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">c_inf</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">w_sdreg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u32</span> <span class="n">regval</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">brcmf_sdio_chip_getinfidx</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">,</span> <span class="n">BCMA_CORE_SDIO_DEV</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">brcmf_sdio_regwl</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
			 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">c_inf</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">,</span>
			 <span class="n">regval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PKT_AVAILABLE()		(intstatus &amp; I_HMB_FRAME_IND)</span>

<span class="cp">#define HOSTINTMASK		(I_HMB_SW_MASK | I_CHIPACTIVE)</span>

<span class="cm">/* Packet free applicable unconditionally for sdio and sdspi.</span>
<span class="cm"> * Conditional if bufpool was present for gspi bus.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_sdbrcm_pktfree2</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">usebufpool</span><span class="p">)</span>
		<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Turn backplane clock on or off */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_htclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pendok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">clkctl</span><span class="p">,</span> <span class="n">clkreq</span><span class="p">,</span> <span class="n">devctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">clkctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Request HT Avail */</span>
		<span class="n">clkreq</span> <span class="o">=</span>
		    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">alp_only</span> <span class="o">?</span> <span class="n">SBSDIO_ALP_AVAIL_REQ</span> <span class="o">:</span> <span class="n">SBSDIO_HT_AVAIL_REQ</span><span class="p">;</span>

		<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span>
				 <span class="n">clkreq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;HT Avail request error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check current status */</span>
		<span class="n">clkctl</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
					  <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;HT Avail read error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Go to pending and await interrupt if appropriate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SBSDIO_CLKAV</span><span class="p">(</span><span class="n">clkctl</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">alp_only</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pendok</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Allow only clock-available interrupt */</span>
			<span class="n">devctl</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
						  <span class="n">SBSDIO_DEVICE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Devctl error setting CA: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">err</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">devctl</span> <span class="o">|=</span> <span class="n">SBSDIO_DEVCTL_CA_INT_ONLY</span><span class="p">;</span>
			<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_DEVICE_CTL</span><span class="p">,</span>
					 <span class="n">devctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;CLKCTL: set PENDING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">=</span> <span class="n">CLK_PENDING</span><span class="p">;</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">==</span> <span class="n">CLK_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Cancel CA-only interrupt filter */</span>
			<span class="n">devctl</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
						  <span class="n">SBSDIO_DEVICE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
			<span class="n">devctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SBSDIO_DEVCTL_CA_INT_ONLY</span><span class="p">;</span>
			<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_DEVICE_CTL</span><span class="p">,</span>
					 <span class="n">devctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Otherwise, wait here (polling) for HT Avail */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
			  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">PMU_MAX_TRANSITION_DLY</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">SBSDIO_CLKAV</span><span class="p">(</span><span class="n">clkctl</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">alp_only</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">clkctl</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
						  <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;HT Avail request error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SBSDIO_CLKAV</span><span class="p">(</span><span class="n">clkctl</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">alp_only</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;HT Avail timeout (%d): clkctl 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">PMU_MAX_TRANSITION_DLY</span><span class="p">,</span> <span class="n">clkctl</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Mark clock available */</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">=</span> <span class="n">CLK_AVAIL</span><span class="p">;</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;CLKCTL: turned ON</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#if defined(DEBUG)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">alp_only</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SBSDIO_ALPONLY</span><span class="p">(</span><span class="n">clkctl</span><span class="p">))</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;HT Clock should be on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* defined (DEBUG) */</span><span class="cp"></span>

		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clkreq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">==</span> <span class="n">CLK_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Cancel CA-only interrupt filter */</span>
			<span class="n">devctl</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
						  <span class="n">SBSDIO_DEVICE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
			<span class="n">devctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SBSDIO_DEVCTL_CA_INT_ONLY</span><span class="p">;</span>
			<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_DEVICE_CTL</span><span class="p">,</span>
					 <span class="n">devctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">=</span> <span class="n">CLK_SDONLY</span><span class="p">;</span>
		<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span>
				 <span class="n">clkreq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;CLKCTL: turned OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Failed access turning clock off: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Change idle/active SD state */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_sdclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">=</span> <span class="n">CLK_SDONLY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">=</span> <span class="n">CLK_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Transition SD and backplane clock readiness */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">uint</span> <span class="n">target</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pendok</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">uint</span> <span class="n">oldstate</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Early exit if we&#39;re already there */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">==</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">CLK_AVAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_sdbrcm_wd_timer</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">BRCMF_WD_POLL_MS</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLK_AVAIL</span>:
		<span class="cm">/* Make sure SD clock is available */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">==</span> <span class="n">CLK_NONE</span><span class="p">)</span>
			<span class="n">brcmf_sdbrcm_sdclk</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="cm">/* Now request HT Avail on the backplane */</span>
		<span class="n">brcmf_sdbrcm_htclk</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">pendok</span><span class="p">);</span>
		<span class="n">brcmf_sdbrcm_wd_timer</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">BRCMF_WD_POLL_MS</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CLK_SDONLY</span>:
		<span class="cm">/* Remove HT request, or bring up SD clock */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">==</span> <span class="n">CLK_NONE</span><span class="p">)</span>
			<span class="n">brcmf_sdbrcm_sdclk</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">==</span> <span class="n">CLK_AVAIL</span><span class="p">)</span>
			<span class="n">brcmf_sdbrcm_htclk</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;request for %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">brcmf_sdbrcm_wd_timer</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">BRCMF_WD_POLL_MS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CLK_NONE</span>:
		<span class="cm">/* Make sure to remove HT request */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">==</span> <span class="n">CLK_AVAIL</span><span class="p">)</span>
			<span class="n">brcmf_sdbrcm_htclk</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="cm">/* Now remove the SD clock */</span>
		<span class="n">brcmf_sdbrcm_sdclk</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">brcmf_sdbrcm_wd_timer</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;%d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oldstate</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_bussleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sleep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;request %s (currently %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">sleep</span> <span class="o">?</span> <span class="s">&quot;SLEEP&quot;</span> <span class="o">:</span> <span class="s">&quot;WAKE&quot;</span><span class="p">,</span>
		  <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sleeping</span> <span class="o">?</span> <span class="s">&quot;SLEEP&quot;</span> <span class="o">:</span> <span class="s">&quot;WAKE&quot;</span><span class="p">);</span>

	<span class="cm">/* Done if we&#39;re already in the requested state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sleep</span> <span class="o">==</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sleeping</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Going to sleep: set the alarm and turn off the lights... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sleep</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t sleep if something is pending */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_sched</span> <span class="o">||</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxskip</span> <span class="o">||</span> <span class="n">pktq_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="cm">/* Make sure the controller has the bus up */</span>
		<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_AVAIL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/* Tell device to start using OOB wakeup */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">w_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">SMB_USE_OOB</span><span class="p">,</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">tosbmailbox</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;CANNOT SIGNAL CHIP, WILL NOT WAKE UP!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Turn off our contribution to the HT clock request */</span>
		<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_SDONLY</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span>
				 <span class="n">SBSDIO_FORCE_HW_CLKREQ_OFF</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="cm">/* Isolate the bus */</span>
		<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_DEVICE_CTL</span><span class="p">,</span>
				 <span class="n">SBSDIO_DEVCTL_PADS_ISO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="cm">/* Change state */</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sleeping</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Waking up: bus power up is ok, set local state */</span>

		<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="cm">/* Make sure the controller has the bus up */</span>
		<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_AVAIL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/* Send misc interrupt to indicate OOB not needed */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">w_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">tosbmailboxdata</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">w_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">SMB_DEV_INT</span><span class="p">,</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">tosbmailbox</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;CANNOT SIGNAL CHIP TO CLEAR OOB!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Make sure we have SD bus access */</span>
		<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_SDONLY</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/* Change state */</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sleeping</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bus_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sleeping</span><span class="p">)</span>
		<span class="n">brcmf_sdbrcm_bussleep</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">brcmf_sdbrcm_hostmail</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">intstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hmb_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fcbits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Read mailbox data and ack that we did so */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">r_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hmb_data</span><span class="p">,</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">tohostmailboxdata</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">w_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">SMB_INT_ACK</span><span class="p">,</span>
			  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">tosbmailbox</span><span class="p">));</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f1regdata</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Dongle recomposed rx frames, accept them again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hmb_data</span> <span class="o">&amp;</span> <span class="n">HMB_DATA_NAKHANDLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;Dongle reports NAK handled, expect rtx of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_seq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxskip</span><span class="p">)</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;unexpected NAKHANDLED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxskip</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">intstatus</span> <span class="o">|=</span> <span class="n">I_HMB_FRAME_IND</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * DEVREADY does not occur with gSPI.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hmb_data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HMB_DATA_DEVREADY</span> <span class="o">|</span> <span class="n">HMB_DATA_FWREADY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdpcm_ver</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">hmb_data</span> <span class="o">&amp;</span> <span class="n">HMB_DATA_VERSION_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		    <span class="n">HMB_DATA_VERSION_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdpcm_ver</span> <span class="o">!=</span> <span class="n">SDPCM_PROT_VERSION</span><span class="p">)</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Version mismatch, dongle reports %d, &quot;</span>
				  <span class="s">&quot;expecting %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdpcm_ver</span><span class="p">,</span> <span class="n">SDPCM_PROT_VERSION</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;Dongle ready, protocol version %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdpcm_ver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Flow Control has been moved into the RX headers and this out of band</span>
<span class="cm">	 * method isn&#39;t used any more.</span>
<span class="cm">	 * remaining backward compatible with older dongles.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hmb_data</span> <span class="o">&amp;</span> <span class="n">HMB_DATA_FC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcbits</span> <span class="o">=</span> <span class="p">(</span><span class="n">hmb_data</span> <span class="o">&amp;</span> <span class="n">HMB_DATA_FCDATA_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
							<span class="n">HMB_DATA_FCDATA_SHIFT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fcbits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span><span class="p">)</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fc_xoff</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">fcbits</span><span class="p">)</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fc_xon</span><span class="o">++</span><span class="p">;</span>

		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fc_rcvd</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span> <span class="o">=</span> <span class="n">fcbits</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Shouldn&#39;t be any others */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hmb_data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">HMB_DATA_DEVREADY</span> <span class="o">|</span>
			 <span class="n">HMB_DATA_NAKHANDLED</span> <span class="o">|</span>
			 <span class="n">HMB_DATA_FC</span> <span class="o">|</span>
			 <span class="n">HMB_DATA_FWREADY</span> <span class="o">|</span>
			 <span class="n">HMB_DATA_FCDATA_MASK</span> <span class="o">|</span> <span class="n">HMB_DATA_VERSION_MASK</span><span class="p">))</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Unknown mailbox data content: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">hmb_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">intstatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">bool</span> <span class="n">abort</span><span class="p">,</span> <span class="n">bool</span> <span class="n">rtx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lastrbc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;%sterminate frame%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">abort</span> <span class="o">?</span> <span class="s">&quot;abort command, &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">rtx</span> <span class="o">?</span> <span class="s">&quot;, send NAK&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">abort</span><span class="p">)</span>
		<span class="n">brcmf_sdcard_abort</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SDIO_FUNC_2</span><span class="p">);</span>

	<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_FUNC1_FRAMECTRL</span><span class="p">,</span>
			 <span class="n">SFC_RF_TERM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f1regdata</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Wait until the packet has been flushed (device/FIFO stable) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">lastrbc</span> <span class="o">=</span> <span class="n">retries</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retries</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
				      <span class="n">SBSDIO_FUNC1_RFRAMEBCHI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="n">lo</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
				      <span class="n">SBSDIO_FUNC1_RFRAMEBCLO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f1regdata</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">hi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">hi</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">lastrbc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">lastrbc</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;count growing: last 0x%04x now 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">lastrbc</span><span class="p">,</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">lo</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">lastrbc</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">lo</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retries</span><span class="p">)</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;count never zeroed: last 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lastrbc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;flush took %d iterations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0xffff</span> <span class="o">-</span> <span class="n">retries</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxrtx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">w_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">SMB_NAK</span><span class="p">,</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">tosbmailbox</span><span class="p">));</span>

		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f1regdata</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxskip</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear partial in any case */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If we can&#39;t reach the device, signal failure */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* copy a buffer into a pkt buffer chain */</span>
<span class="k">static</span> <span class="n">uint</span> <span class="nf">brcmf_sdbrcm_glom_from_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">uint</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">n</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">dataptr</span><span class="p">;</span>

	<span class="cm">/* copy the data */</span>
	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">uint</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return total length of buffer chain */</span>
<span class="k">static</span> <span class="n">uint</span> <span class="nf">brcmf_sdbrcm_glom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">total</span><span class="p">;</span>

	<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_sdbrcm_free_glom</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">skb_queue_walk_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">,</span> <span class="n">cur</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_unlink</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">);</span>
		<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">brcmf_sdbrcm_rxglom</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rxseq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">totlen</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dptr</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">sublen</span><span class="p">,</span> <span class="n">check</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pfirst</span><span class="p">,</span> <span class="o">*</span><span class="n">pnext</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">errcode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">chan</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">doff</span><span class="p">,</span> <span class="n">sfdoff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">txmax</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ifidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">usechain</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">use_rxchain</span><span class="p">;</span>

	<span class="cm">/* If packets, issue read(s) and send up packet chain */</span>
	<span class="cm">/* Return sequence numbers consumed? */</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;start: glomd %p glom %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomd</span><span class="p">,</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">));</span>

	<span class="cm">/* If there&#39;s a descriptor, generate the packet chain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pfirst</span> <span class="o">=</span> <span class="n">pnext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">dptr</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dlen</span> <span class="o">||</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;bad glomd len(%d), ignore descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dlen</span><span class="p">);</span>
			<span class="n">dlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">=</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dlen</span><span class="p">;</span> <span class="n">num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Get (and move past) next length */</span>
			<span class="n">sublen</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">dptr</span><span class="p">);</span>
			<span class="n">dlen</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
			<span class="n">dptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sublen</span> <span class="o">&lt;</span> <span class="n">SDPCM_HDRLEN</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sublen</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SDPCM_HDRLEN</span><span class="p">))))</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;descriptor len %d bad: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">num</span><span class="p">,</span> <span class="n">sublen</span><span class="p">);</span>
				<span class="n">pnext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sublen</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;sublen %d not multiple of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">sublen</span><span class="p">,</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
				<span class="n">usechain</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">totlen</span> <span class="o">+=</span> <span class="n">sublen</span><span class="p">;</span>

			<span class="cm">/* For last frame, adjust read len so total</span>
<span class="cm">				 is a block multiple */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dlen</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sublen</span> <span class="o">+=</span>
				    <span class="p">(</span><span class="n">roundup</span><span class="p">(</span><span class="n">totlen</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">)</span> <span class="o">-</span> <span class="n">totlen</span><span class="p">);</span>
				<span class="n">totlen</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">totlen</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* Allocate/chain packet for next subframe */</span>
			<span class="n">pnext</span> <span class="o">=</span> <span class="n">brcmu_pkt_buf_get_skb</span><span class="p">(</span><span class="n">sublen</span> <span class="o">+</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pnext</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;bcm_pkt_buf_get_skb failed, num %d len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">num</span><span class="p">,</span> <span class="n">sublen</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">,</span> <span class="n">pnext</span><span class="p">);</span>

			<span class="cm">/* Adhere to start alignment requirements */</span>
			<span class="n">pkt_align</span><span class="p">(</span><span class="n">pnext</span><span class="p">,</span> <span class="n">sublen</span><span class="p">,</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* If all allocations succeeded, save packet chain</span>
<span class="cm">			 in bus structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pnext</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">GLOM</span><span class="p">,</span> <span class="s">&quot;allocated %d-byte packet chain for %d subframes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">totlen</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">BRCMF_GLOM_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">&amp;&amp;</span>
			    <span class="n">totlen</span> <span class="o">!=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">GLOM</span><span class="p">,</span> <span class="s">&quot;glomdesc mismatch: nextlen %d glomdesc %d rxseq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span><span class="p">,</span> <span class="n">totlen</span><span class="p">,</span> <span class="n">rxseq</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pfirst</span> <span class="o">=</span> <span class="n">pnext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">brcmf_sdbrcm_free_glom</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
			<span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Done with descriptor packet */</span>
		<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomd</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ok -- either we just generated a packet chain,</span>
<span class="cm">		 or had one from before */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BRCMF_GLOM_ON</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">GLOM</span><span class="p">,</span> <span class="s">&quot;try superframe read, packet chain:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">,</span> <span class="n">pnext</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">GLOM</span><span class="p">,</span> <span class="s">&quot;    %p: %p len 0x%04x (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">pnext</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pnext</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
					  <span class="n">pnext</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">pnext</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">pfirst</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">);</span>
		<span class="n">dlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">brcmf_sdbrcm_glom_len</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

		<span class="cm">/* Do an SDIO read for the superframe.  Configurable iovar to</span>
<span class="cm">		 * read directly into the chained packet, or allocate a large</span>
<span class="cm">		 * packet and and copy into the chain.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usechain</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">errcode</span> <span class="o">=</span> <span class="n">brcmf_sdcard_recv_chain</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
					<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">sbwad</span><span class="p">,</span>
					<span class="n">SDIO_FUNC_2</span><span class="p">,</span> <span class="n">F2SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dataptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">errcode</span> <span class="o">=</span> <span class="n">brcmf_sdcard_recv_buf</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
					<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">sbwad</span><span class="p">,</span>
					<span class="n">SDIO_FUNC_2</span><span class="p">,</span> <span class="n">F2SYNC</span><span class="p">,</span>
					<span class="n">bus</span><span class="o">-&gt;</span><span class="n">dataptr</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
			<span class="n">sublen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">brcmf_sdbrcm_glom_from_buf</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sublen</span> <span class="o">!=</span> <span class="n">dlen</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;FAILED TO COPY, dlen %d sublen %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">dlen</span><span class="p">,</span> <span class="n">sublen</span><span class="p">);</span>
				<span class="n">errcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pnext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;COULDN&#39;T ALLOC %d-BYTE GLOM, FORCE FAILURE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dlen</span><span class="p">);</span>
			<span class="n">errcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f2rxdata</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* On failure, kill the superframe, allow a couple retries */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errcode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;glom read of %d bytes failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dlen</span><span class="p">,</span> <span class="n">errcode</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">dstats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomerr</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomerr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxglomfail</span><span class="o">++</span><span class="p">;</span>
				<span class="n">brcmf_sdbrcm_free_glom</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="n">BRCMF_GLOM_ON</span><span class="p">(),</span>
				   <span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">48</span><span class="p">),</span>
				   <span class="s">&quot;SUPERFRAME:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Validate the superframe header */</span>
		<span class="n">dptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">sublen</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">dptr</span><span class="p">);</span>
		<span class="n">check</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">dptr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>

		<span class="n">chan</span> <span class="o">=</span> <span class="n">SDPCM_PACKET_CHANNEL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dptr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>
		<span class="n">seq</span> <span class="o">=</span> <span class="n">SDPCM_PACKET_SEQUENCE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dptr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">=</span> <span class="n">dptr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span> <span class="o">+</span> <span class="n">SDPCM_NEXTLEN_OFFSET</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_RX_DATASZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;nextlen too large (%d) seq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">doff</span> <span class="o">=</span> <span class="n">SDPCM_DOFFSET_VALUE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dptr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>
		<span class="n">txmax</span> <span class="o">=</span> <span class="n">SDPCM_WINDOW_VALUE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dptr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>

		<span class="n">errcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="o">~</span><span class="p">(</span><span class="n">sublen</span> <span class="o">^</span> <span class="n">check</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(superframe): HW hdr error: len/check 0x%04x/0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">sublen</span><span class="p">,</span> <span class="n">check</span><span class="p">);</span>
			<span class="n">errcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">roundup</span><span class="p">(</span><span class="n">sublen</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(superframe): len 0x%04x, rounded 0x%04x, expect 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">sublen</span><span class="p">,</span> <span class="n">roundup</span><span class="p">(</span><span class="n">sublen</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">),</span>
				  <span class="n">dlen</span><span class="p">);</span>
			<span class="n">errcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SDPCM_PACKET_CHANNEL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dptr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">])</span> <span class="o">!=</span>
			   <span class="n">SDPCM_GLOM_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(superframe): bad channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">SDPCM_PACKET_CHANNEL</span><span class="p">(</span>
					  <span class="o">&amp;</span><span class="n">dptr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]));</span>
			<span class="n">errcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SDPCM_GLOMDESC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dptr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(superframe): got 2nd descriptor?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">errcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">doff</span> <span class="o">&lt;</span> <span class="n">SDPCM_HDRLEN</span><span class="p">)</span> <span class="o">||</span>
			   <span class="p">(</span><span class="n">doff</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">SDPCM_HDRLEN</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(superframe): Bad data offset %d: HW %d pkt %d min %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">doff</span><span class="p">,</span> <span class="n">sublen</span><span class="p">,</span> <span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">SDPCM_HDRLEN</span><span class="p">);</span>
			<span class="n">errcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check sequence number of superframe SW header */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxseq</span> <span class="o">!=</span> <span class="n">seq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;(superframe) rx_seq %d, expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">seq</span><span class="p">,</span> <span class="n">rxseq</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_badseq</span><span class="o">++</span><span class="p">;</span>
			<span class="n">rxseq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check window for sanity */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">txmax</span> <span class="o">-</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;unlikely tx max %d with tx_seq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">txmax</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">);</span>
			<span class="n">txmax</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_max</span> <span class="o">=</span> <span class="n">txmax</span><span class="p">;</span>

		<span class="cm">/* Remove superframe header, remember offset */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">pfirst</span><span class="p">,</span> <span class="n">doff</span><span class="p">);</span>
		<span class="n">sfdoff</span> <span class="o">=</span> <span class="n">doff</span><span class="p">;</span>
		<span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Validate all the subframe headers */</span>
		<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">,</span> <span class="n">pnext</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* leave when invalid subframe is found */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errcode</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">dptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pnext</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">dlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">pnext</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">sublen</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">dptr</span><span class="p">);</span>
			<span class="n">check</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">dptr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">SDPCM_PACKET_CHANNEL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dptr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>
			<span class="n">doff</span> <span class="o">=</span> <span class="n">SDPCM_DOFFSET_VALUE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dptr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>
			<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="n">BRCMF_GLOM_ON</span><span class="p">(),</span>
					   <span class="n">dptr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;subframe:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="o">~</span><span class="p">(</span><span class="n">sublen</span> <span class="o">^</span> <span class="n">check</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(subframe %d): HW hdr error: len/check 0x%04x/0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">num</span><span class="p">,</span> <span class="n">sublen</span><span class="p">,</span> <span class="n">check</span><span class="p">);</span>
				<span class="n">errcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sublen</span> <span class="o">&gt;</span> <span class="n">dlen</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sublen</span> <span class="o">&lt;</span> <span class="n">SDPCM_HDRLEN</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(subframe %d): length mismatch: len 0x%04x, expect 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">num</span><span class="p">,</span> <span class="n">sublen</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
				<span class="n">errcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">chan</span> <span class="o">!=</span> <span class="n">SDPCM_DATA_CHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				   <span class="p">(</span><span class="n">chan</span> <span class="o">!=</span> <span class="n">SDPCM_EVENT_CHANNEL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(subframe %d): bad channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">num</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
				<span class="n">errcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">doff</span> <span class="o">&lt;</span> <span class="n">SDPCM_HDRLEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">doff</span> <span class="o">&gt;</span> <span class="n">sublen</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(subframe %d): Bad data offset %d: HW %d min %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">num</span><span class="p">,</span> <span class="n">doff</span><span class="p">,</span> <span class="n">sublen</span><span class="p">,</span> <span class="n">SDPCM_HDRLEN</span><span class="p">);</span>
				<span class="n">errcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* increase the subframe count */</span>
			<span class="n">num</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">errcode</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Terminate frame on error, request</span>
<span class="cm">				 a couple retries */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomerr</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Restore superframe header space */</span>
				<span class="n">skb_push</span><span class="p">(</span><span class="n">pfirst</span><span class="p">,</span> <span class="n">sfdoff</span><span class="p">);</span>
				<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomerr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxglomfail</span><span class="o">++</span><span class="p">;</span>
				<span class="n">brcmf_sdbrcm_free_glom</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Basic SD framing looks ok - process each packet (header) */</span>

		<span class="n">skb_queue_walk_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">,</span> <span class="n">pfirst</span><span class="p">,</span> <span class="n">pnext</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">sublen</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">dptr</span><span class="p">);</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">SDPCM_PACKET_CHANNEL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dptr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>
			<span class="n">seq</span> <span class="o">=</span> <span class="n">SDPCM_PACKET_SEQUENCE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dptr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>
			<span class="n">doff</span> <span class="o">=</span> <span class="n">SDPCM_DOFFSET_VALUE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dptr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>

			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">GLOM</span><span class="p">,</span> <span class="s">&quot;Get subframe %d, %p(%p/%d), sublen %d chan %d seq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">num</span><span class="p">,</span> <span class="n">pfirst</span><span class="p">,</span> <span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				  <span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">sublen</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>

			<span class="cm">/* precondition: chan == SDPCM_DATA_CHANNEL ||</span>
<span class="cm">					 chan == SDPCM_EVENT_CHANNEL */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rxseq</span> <span class="o">!=</span> <span class="n">seq</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">GLOM</span><span class="p">,</span> <span class="s">&quot;rx_seq %d, expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">seq</span><span class="p">,</span> <span class="n">rxseq</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_badseq</span><span class="o">++</span><span class="p">;</span>
				<span class="n">rxseq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rxseq</span><span class="o">++</span><span class="p">;</span>

			<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="n">BRCMF_BYTES_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">BRCMF_DATA_ON</span><span class="p">(),</span>
					   <span class="n">dptr</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="s">&quot;Rx Subframe Data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">__skb_trim</span><span class="p">(</span><span class="n">pfirst</span><span class="p">,</span> <span class="n">sublen</span><span class="p">);</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">pfirst</span><span class="p">,</span> <span class="n">doff</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_unlink</span><span class="p">(</span><span class="n">pfirst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">);</span>
				<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">pfirst</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">brcmf_proto_hdrpull</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">ifidx</span><span class="p">,</span> <span class="n">pfirst</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;rx protocol error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">dstats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">skb_unlink</span><span class="p">(</span><span class="n">pfirst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">);</span>
				<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">pfirst</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="n">BRCMF_GLOM_ON</span><span class="p">(),</span>
					   <span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					   <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
					   <span class="s">&quot;subframe %d to stack, %p (%p/%d) nxt/lnk %p/%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">.</span><span class="n">qlen</span><span class="p">,</span> <span class="n">pfirst</span><span class="p">,</span> <span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					   <span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span>
					   <span class="n">pfirst</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* sent any remaining packets up */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">.</span><span class="n">qlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>
			<span class="n">brcmf_rx_frame</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifidx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">);</span>
			<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxglomframes</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxglompkts</span> <span class="o">+=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">.</span><span class="n">qlen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_dcmd_resp_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">uint</span> <span class="o">*</span><span class="n">condition</span><span class="p">,</span>
					<span class="n">bool</span> <span class="o">*</span><span class="n">pending</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">DCMD_RESP_TIMEOUT</span><span class="p">);</span>

	<span class="cm">/* Wait until control frame is available */</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dcmd_resp_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">condition</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="p">))</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="o">*</span><span class="n">pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dcmd_resp_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">timeout</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_dcmd_resp_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dcmd_resp_wait</span><span class="p">))</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dcmd_resp_wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcmf_sdbrcm_read_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="n">uint</span> <span class="n">len</span><span class="p">,</span> <span class="n">uint</span> <span class="n">doff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">rdlen</span><span class="p">,</span> <span class="n">pad</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">sdret</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Set rxctl for frame (w/optional alignment) */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxctl</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxctl</span> <span class="o">+=</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">;</span>
	<span class="n">pad</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxctl</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pad</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxctl</span> <span class="o">+=</span> <span class="p">(</span><span class="n">BRCMF_SDALIGN</span> <span class="o">-</span> <span class="n">pad</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxctl</span> <span class="o">-=</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">;</span>

	<span class="cm">/* Copy the already-read portion over */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxctl</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">gotpkt</span><span class="p">;</span>

	<span class="cm">/* Raise rdlen to next SDIO block to avoid tail command */</span>
	<span class="n">rdlen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">roundup</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rdlen</span> <span class="o">&gt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pad</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">-</span> <span class="p">(</span><span class="n">rdlen</span> <span class="o">%</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pad</span> <span class="o">&lt;=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">roundup</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pad</span> <span class="o">&lt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="n">pad</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">maxctl</span><span class="p">))</span>
			<span class="n">rdlen</span> <span class="o">+=</span> <span class="n">pad</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdlen</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdlen</span> <span class="o">+=</span> <span class="n">BRCMF_SDALIGN</span> <span class="o">-</span> <span class="p">(</span><span class="n">rdlen</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Satisfy length-alignment requirements */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdlen</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ALIGNMENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">rdlen</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">rdlen</span><span class="p">,</span> <span class="n">ALIGNMENT</span><span class="p">);</span>

	<span class="cm">/* Drop if the read is too big or it exceeds our maximum */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rdlen</span> <span class="o">+</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">maxctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;%d-byte control read exceeds %d-byte buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">rdlen</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">maxctl</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">dstats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">-</span> <span class="n">doff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">maxctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;%d-byte ctl frame (%d-byte ctl data) exceeds %d-byte limit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">len</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">doff</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">maxctl</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">dstats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_toolong</span><span class="o">++</span><span class="p">;</span>
		<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read remainder of frame body into the rxctl buffer */</span>
	<span class="n">sdret</span> <span class="o">=</span> <span class="n">brcmf_sdcard_recv_buf</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">sbwad</span><span class="p">,</span>
				<span class="n">SDIO_FUNC_2</span><span class="p">,</span>
				<span class="n">F2SYNC</span><span class="p">,</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxctl</span> <span class="o">+</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">),</span> <span class="n">rdlen</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f2rxdata</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Control frame failures need retransmission */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;read %d control bytes failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">rdlen</span><span class="p">,</span> <span class="n">sdret</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">gotpkt:</span>

	<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="n">BRCMF_BYTES_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">BRCMF_CTL_ON</span><span class="p">(),</span>
			   <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxctl</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;RxCtrl:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Point to valid data and indicate its length */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxctl</span> <span class="o">+=</span> <span class="n">doff</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxlen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">doff</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="cm">/* Awake any waiters */</span>
	<span class="n">brcmf_sdbrcm_dcmd_resp_wake</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Pad read to blocksize for efficiency */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_pad</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">pad</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">rdlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">roundup</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">rdlen</span> <span class="o">&gt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pad</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">-</span> <span class="p">(</span><span class="o">*</span><span class="n">rdlen</span> <span class="o">%</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pad</span> <span class="o">&lt;=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">roundup</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pad</span> <span class="o">&lt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">&amp;&amp;</span>
		    <span class="o">*</span><span class="n">rdlen</span> <span class="o">+</span> <span class="o">*</span><span class="n">pad</span> <span class="o">+</span> <span class="n">BRCMF_FIRSTREAD</span> <span class="o">&lt;</span> <span class="n">MAX_RX_DATASZ</span><span class="p">)</span>
			<span class="o">*</span><span class="n">rdlen</span> <span class="o">+=</span> <span class="o">*</span><span class="n">pad</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">rdlen</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">rdlen</span> <span class="o">+=</span> <span class="n">BRCMF_SDALIGN</span> <span class="o">-</span> <span class="p">(</span><span class="o">*</span><span class="n">rdlen</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcmf_alloc_pkt_and_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rdlen</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">pkt</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">rxbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sdret</span><span class="p">;</span>		<span class="cm">/* Return code from calls */</span>

	<span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">brcmu_pkt_buf_get_skb</span><span class="p">(</span><span class="n">rdlen</span> <span class="o">+</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pkt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pkt_align</span><span class="p">(</span><span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="n">rdlen</span><span class="p">,</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
	<span class="o">*</span><span class="n">rxbuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="o">*</span><span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="cm">/* Read the entire frame */</span>
	<span class="n">sdret</span> <span class="o">=</span> <span class="n">brcmf_sdcard_recv_pkt</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">sbwad</span><span class="p">,</span>
				      <span class="n">SDIO_FUNC_2</span><span class="p">,</span> <span class="n">F2SYNC</span><span class="p">,</span> <span class="o">*</span><span class="n">pkt</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f2rxdata</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(nextlen): read %d bytes failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">rdlen</span><span class="p">,</span> <span class="n">sdret</span><span class="p">);</span>
		<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="o">*</span><span class="n">pkt</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">dstats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Force retry w/normal header read.</span>
<span class="cm">		 * Don&#39;t attempt NAK for</span>
<span class="cm">		 * gSPI</span>
<span class="cm">		 */</span>
		<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Checks the header */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcmf_check_rxbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rxbuf</span><span class="p">,</span>
		  <span class="n">u8</span> <span class="n">rxseq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">nextlen</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">check</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">len_consistent</span><span class="p">;</span>	<span class="cm">/* Result of comparing readahead len and</span>
<span class="cm">				   len from hw-hdr */</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">,</span> <span class="n">rxbuf</span><span class="p">,</span> <span class="n">SDPCM_HDRLEN</span><span class="p">);</span>

	<span class="cm">/* Extract hardware header fields */</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">);</span>
	<span class="n">check</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>

	<span class="cm">/* All zeros means readahead info was bad */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">|</span> <span class="n">check</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;(nextlen): read zeros in HW header???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Validate check bytes */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="o">~</span><span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">^</span> <span class="n">check</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(nextlen): HW hdr error: nextlen/len/check 0x%04x/0x%04x/0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">nextlen</span><span class="p">,</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="n">check</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_badhdr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Validate frame length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">SDPCM_HDRLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(nextlen): HW hdr length invalid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="o">*</span><span class="n">len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for consistency with readahead info */</span>
	<span class="n">len_consistent</span> <span class="o">=</span> <span class="p">(</span><span class="n">nextlen</span> <span class="o">!=</span> <span class="p">(</span><span class="n">roundup</span><span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len_consistent</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Mismatch, force retry w/normal</span>
<span class="cm">			header (may be &gt;4K) */</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(nextlen): mismatch, nextlen %d len %d rnd %d; expected rxseq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">nextlen</span><span class="p">,</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="n">roundup</span><span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
			  <span class="n">rxseq</span><span class="p">);</span>
		<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">brcmf_sdbrcm_pktfree2</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return true if there may be more frames to read */</span>
<span class="k">static</span> <span class="n">uint</span>
<span class="nf">brcmf_sdbrcm_readframes</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">uint</span> <span class="n">maxframes</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">finished</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">check</span><span class="p">;</span>	<span class="cm">/* Extracted hardware header fields */</span>
	<span class="n">u8</span> <span class="n">chan</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">doff</span><span class="p">;</span>	<span class="cm">/* Extracted software header fields */</span>
	<span class="n">u8</span> <span class="n">fcbits</span><span class="p">;</span>		<span class="cm">/* Extracted fcbits from software header */</span>

	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>		<span class="cm">/* Packet for event or data frames */</span>
	<span class="n">u16</span> <span class="n">pad</span><span class="p">;</span>		<span class="cm">/* Number of pad bytes to read */</span>
	<span class="n">u16</span> <span class="n">rdlen</span><span class="p">;</span>		<span class="cm">/* Total number of bytes to read */</span>
	<span class="n">u8</span> <span class="n">rxseq</span><span class="p">;</span>		<span class="cm">/* Next sequence number to expect */</span>
	<span class="n">uint</span> <span class="n">rxleft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Remaining number of frames allowed */</span>
	<span class="kt">int</span> <span class="n">sdret</span><span class="p">;</span>		<span class="cm">/* Return code from calls */</span>
	<span class="n">u8</span> <span class="n">txmax</span><span class="p">;</span>		<span class="cm">/* Maximum tx sequence offered */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rxbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ifidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">rxcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Total frames read */</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Not finished unless we encounter no more frames indication */</span>
	<span class="o">*</span><span class="n">finished</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rxseq</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_seq</span><span class="p">,</span> <span class="n">rxleft</span> <span class="o">=</span> <span class="n">maxframes</span><span class="p">;</span>
	     <span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxskip</span> <span class="o">&amp;&amp;</span> <span class="n">rxleft</span> <span class="o">&amp;&amp;</span>
	     <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">;</span>
	     <span class="n">rxseq</span><span class="o">++</span><span class="p">,</span> <span class="n">rxleft</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Handle glomming separately */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomd</span> <span class="o">||</span> <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">cnt</span><span class="p">;</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">GLOM</span><span class="p">,</span> <span class="s">&quot;calling rxglom: glomd %p, glom %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomd</span><span class="p">,</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">));</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_rxglom</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">rxseq</span><span class="p">);</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">GLOM</span><span class="p">,</span> <span class="s">&quot;rxglom returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="n">rxseq</span> <span class="o">+=</span> <span class="n">cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rxleft</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxleft</span> <span class="o">&gt;</span> <span class="n">cnt</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">rxleft</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Try doing single read if we can */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">nextlen</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span><span class="p">;</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">rdlen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nextlen</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">brcmf_pad</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdlen</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * After the frame is received we have to</span>
<span class="cm">			 * distinguish whether it is data</span>
<span class="cm">			 * or non-data frame.</span>
<span class="cm">			 */</span>
			<span class="n">brcmf_alloc_pkt_and_read</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">rdlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxbuf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Give up on data, request rtx of events */</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(nextlen): brcmf_alloc_pkt_and_read failed: len %d rdlen %d expected rxseq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">len</span><span class="p">,</span> <span class="n">rdlen</span><span class="p">,</span> <span class="n">rxseq</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_check_rxbuf</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">rxbuf</span><span class="p">,</span> <span class="n">rxseq</span><span class="p">,</span> <span class="n">nextlen</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Extract software header fields */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">SDPCM_PACKET_CHANNEL</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>
			<span class="n">seq</span> <span class="o">=</span> <span class="n">SDPCM_PACKET_SEQUENCE</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>
			<span class="n">doff</span> <span class="o">=</span> <span class="n">SDPCM_DOFFSET_VALUE</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>
			<span class="n">txmax</span> <span class="o">=</span> <span class="n">SDPCM_WINDOW_VALUE</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>

			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">=</span>
			    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span> <span class="o">+</span>
				       <span class="n">SDPCM_NEXTLEN_OFFSET</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_RX_DATASZ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;(nextlen): got frame w/nextlen too large (%d), seq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_readahead_cnt</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* Handle Flow Control */</span>
			<span class="n">fcbits</span> <span class="o">=</span> <span class="n">SDPCM_FCMASK_VALUE</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span> <span class="o">!=</span> <span class="n">fcbits</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span> <span class="o">&amp;</span> <span class="n">fcbits</span><span class="p">)</span>
					<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fc_xoff</span><span class="o">++</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">fcbits</span><span class="p">)</span>
					<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fc_xon</span><span class="o">++</span><span class="p">;</span>

				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fc_rcvd</span><span class="o">++</span><span class="p">;</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span> <span class="o">=</span> <span class="n">fcbits</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Check and update sequence number */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxseq</span> <span class="o">!=</span> <span class="n">seq</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;(nextlen): rx_seq %d, expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">seq</span><span class="p">,</span> <span class="n">rxseq</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_badseq</span><span class="o">++</span><span class="p">;</span>
				<span class="n">rxseq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Check window for sanity */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">txmax</span> <span class="o">-</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;got unlikely tx max %d with tx_seq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">txmax</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">);</span>
				<span class="n">txmax</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_max</span> <span class="o">=</span> <span class="n">txmax</span><span class="p">;</span>

			<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="n">BRCMF_BYTES_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">BRCMF_DATA_ON</span><span class="p">(),</span>
					   <span class="n">rxbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Rx Data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">BRCMF_BYTES_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
					     <span class="n">BRCMF_DATA_ON</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
					   <span class="n">BRCMF_HDRS_ON</span><span class="p">(),</span>
					   <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">,</span> <span class="n">SDPCM_HDRLEN</span><span class="p">,</span>
					   <span class="s">&quot;RxHdr:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="n">SDPCM_CONTROL_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(nextlen): readahead on control packet %d?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">seq</span><span class="p">);</span>
				<span class="cm">/* Force retry w/normal header read */</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
				<span class="n">brcmf_sdbrcm_pktfree2</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Validate data offset */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">doff</span> <span class="o">&lt;</span> <span class="n">SDPCM_HDRLEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">doff</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;(nextlen): bad data offset %d: HW len %d min %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">doff</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">SDPCM_HDRLEN</span><span class="p">);</span>
				<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
				<span class="n">brcmf_sdbrcm_pktfree2</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* All done with this one -- now deliver the packet */</span>
			<span class="k">goto</span> <span class="n">deliver</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Read frame header (hardware and software) */</span>
		<span class="n">sdret</span> <span class="o">=</span> <span class="n">brcmf_sdcard_recv_buf</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">sbwad</span><span class="p">,</span>
					      <span class="n">SDIO_FUNC_2</span><span class="p">,</span> <span class="n">F2SYNC</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">,</span>
					      <span class="n">BRCMF_FIRSTREAD</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f2rxhdrs</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;RXHEADER FAILED: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sdret</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_hdrfail</span><span class="o">++</span><span class="p">;</span>
			<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="n">BRCMF_BYTES_ON</span><span class="p">()</span> <span class="o">||</span> <span class="n">BRCMF_HDRS_ON</span><span class="p">(),</span>
				   <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">,</span> <span class="n">SDPCM_HDRLEN</span><span class="p">,</span> <span class="s">&quot;RxHdr:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


		<span class="cm">/* Extract hardware header fields */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">);</span>
		<span class="n">check</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>

		<span class="cm">/* All zeros means no more frames */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">len</span> <span class="o">|</span> <span class="n">check</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">finished</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Validate check bytes */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="o">~</span><span class="p">(</span><span class="n">len</span> <span class="o">^</span> <span class="n">check</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;HW hdr err: len/check 0x%04x/0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">len</span><span class="p">,</span> <span class="n">check</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_badhdr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Validate frame length */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">SDPCM_HDRLEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;HW hdr length invalid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Extract software header fields */</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">SDPCM_PACKET_CHANNEL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>
		<span class="n">seq</span> <span class="o">=</span> <span class="n">SDPCM_PACKET_SEQUENCE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>
		<span class="n">doff</span> <span class="o">=</span> <span class="n">SDPCM_DOFFSET_VALUE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>
		<span class="n">txmax</span> <span class="o">=</span> <span class="n">SDPCM_WINDOW_VALUE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>

		<span class="cm">/* Validate data offset */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">doff</span> <span class="o">&lt;</span> <span class="n">SDPCM_HDRLEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">doff</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Bad data offset %d: HW len %d, min %d seq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">doff</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">SDPCM_HDRLEN</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_badhdr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Save the readahead length if there is one */</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">=</span>
		    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span> <span class="o">+</span> <span class="n">SDPCM_NEXTLEN_OFFSET</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_RX_DATASZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;(nextlen): got frame w/nextlen too large (%d), seq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">nextlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Handle Flow Control */</span>
		<span class="n">fcbits</span> <span class="o">=</span> <span class="n">SDPCM_FCMASK_VALUE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span> <span class="o">!=</span> <span class="n">fcbits</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span> <span class="o">&amp;</span> <span class="n">fcbits</span><span class="p">)</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fc_xoff</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">fcbits</span><span class="p">)</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fc_xon</span><span class="o">++</span><span class="p">;</span>

			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fc_rcvd</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span> <span class="o">=</span> <span class="n">fcbits</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check and update sequence number */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxseq</span> <span class="o">!=</span> <span class="n">seq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;rx_seq %d, expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">rxseq</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_badseq</span><span class="o">++</span><span class="p">;</span>
			<span class="n">rxseq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check window for sanity */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">txmax</span> <span class="o">-</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;unlikely tx max %d with tx_seq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">txmax</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">);</span>
			<span class="n">txmax</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_max</span> <span class="o">=</span> <span class="n">txmax</span><span class="p">;</span>

		<span class="cm">/* Call a separate function for control frames */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="n">SDPCM_CONTROL_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_sdbrcm_read_control</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">doff</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* precondition: chan is either SDPCM_DATA_CHANNEL,</span>
<span class="cm">		   SDPCM_EVENT_CHANNEL, SDPCM_TEST_CHANNEL or</span>
<span class="cm">		   SDPCM_GLOM_CHANNEL */</span>

		<span class="cm">/* Length to read */</span>
		<span class="n">rdlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* May pad read to blocksize for efficiency */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">roundup</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">rdlen</span> <span class="o">&gt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pad</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">-</span> <span class="p">(</span><span class="n">rdlen</span> <span class="o">%</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pad</span> <span class="o">&lt;=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">roundup</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pad</span> <span class="o">&lt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">rdlen</span> <span class="o">+</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_RX_DATASZ</span><span class="p">))</span>
				<span class="n">rdlen</span> <span class="o">+=</span> <span class="n">pad</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdlen</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdlen</span> <span class="o">+=</span> <span class="n">BRCMF_SDALIGN</span> <span class="o">-</span> <span class="p">(</span><span class="n">rdlen</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Satisfy length-alignment requirements */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdlen</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ALIGNMENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">rdlen</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">rdlen</span><span class="p">,</span> <span class="n">ALIGNMENT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rdlen</span> <span class="o">+</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_RX_DATASZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Too long -- skip this frame */</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;too long: len %d rdlen %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">len</span><span class="p">,</span> <span class="n">rdlen</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">dstats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_toolong</span><span class="o">++</span><span class="p">;</span>
			<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pkt</span> <span class="o">=</span> <span class="n">brcmu_pkt_buf_get_skb</span><span class="p">(</span><span class="n">rdlen</span> <span class="o">+</span>
					    <span class="n">BRCMF_FIRSTREAD</span> <span class="o">+</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Give up on data, request rtx of events */</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;brcmu_pkt_buf_get_skb failed: rdlen %d chan %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">rdlen</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">dstats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">RETRYCHAN</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Leave room for what we already read, and align remainder */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">);</span>
		<span class="n">pkt_align</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">rdlen</span><span class="p">,</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>

		<span class="cm">/* Read the remaining frame data */</span>
		<span class="n">sdret</span> <span class="o">=</span> <span class="n">brcmf_sdcard_recv_pkt</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">sbwad</span><span class="p">,</span>
					      <span class="n">SDIO_FUNC_2</span><span class="p">,</span> <span class="n">F2SYNC</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f2rxdata</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;read %d %s bytes failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdlen</span><span class="p">,</span>
				  <span class="p">((</span><span class="n">chan</span> <span class="o">==</span> <span class="n">SDPCM_EVENT_CHANNEL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;event&quot;</span>
				   <span class="o">:</span> <span class="p">((</span><span class="n">chan</span> <span class="o">==</span> <span class="n">SDPCM_DATA_CHANNEL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;data&quot;</span>
				      <span class="o">:</span> <span class="s">&quot;test&quot;</span><span class="p">)),</span> <span class="n">sdret</span><span class="p">);</span>
			<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">dstats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">RETRYCHAN</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Copy the already-read portion */</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">,</span> <span class="n">BRCMF_FIRSTREAD</span><span class="p">);</span>

		<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="n">BRCMF_BYTES_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">BRCMF_DATA_ON</span><span class="p">(),</span>
				   <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Rx Data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">deliver:</span>
		<span class="cm">/* Save superframe descriptor and allocate packet frame */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="n">SDPCM_GLOM_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SDPCM_GLOMDESC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span><span class="p">[</span><span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">GLOM</span><span class="p">,</span> <span class="s">&quot;glom descriptor, %d bytes:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">len</span><span class="p">);</span>
				<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="n">BRCMF_GLOM_ON</span><span class="p">(),</span>
						   <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
						   <span class="s">&quot;Glom Data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">__skb_trim</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">skb_pull</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">SDPCM_HDRLEN</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomd</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;%s: glom superframe w/o &quot;</span>
					  <span class="s">&quot;descriptor!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">brcmf_sdbrcm_rxfail</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Fill in packet len and prio, deliver upward */</span>
		<span class="n">__skb_trim</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">doff</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">brcmf_proto_hdrpull</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifidx</span><span class="p">,</span>
			   <span class="n">pkt</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;rx protocol error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">dstats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Unlock during rx call */</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>
		<span class="n">brcmf_rx_packet</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifidx</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rxcount</span> <span class="o">=</span> <span class="n">maxframes</span> <span class="o">-</span> <span class="n">rxleft</span><span class="p">;</span>
	<span class="cm">/* Message if we hit the limit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxleft</span><span class="p">)</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="s">&quot;hit rx limit of %d frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">maxframes</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="s">&quot;processed %d frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxcount</span><span class="p">);</span>
	<span class="cm">/* Back off rxseq if awaiting rtx, update rx_seq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxskip</span><span class="p">)</span>
		<span class="n">rxseq</span><span class="o">--</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_seq</span> <span class="o">=</span> <span class="n">rxseq</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rxcount</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcmf_sdbrcm_wait_for_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">lockvar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>
	<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">,</span> <span class="o">!*</span><span class="n">lockvar</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcmf_sdbrcm_wait_event_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">))</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Writes a HW/SW header into the packet and sends it. */</span>
<span class="cm">/* Assumes: (a) header space already there, (b) caller holds lock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_txpkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span>
			      <span class="n">uint</span> <span class="n">chan</span><span class="p">,</span> <span class="n">bool</span> <span class="n">free_pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swheader</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Add alignment padding, allocate new packet if needed */</span>
	<span class="n">pad</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">frame</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pad</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;insufficient headroom %d for %d pad</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">skb_headroom</span><span class="p">(</span><span class="n">pkt</span><span class="p">),</span> <span class="n">pad</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">tx_realloc</span><span class="o">++</span><span class="p">;</span>
			<span class="n">new</span> <span class="o">=</span> <span class="n">brcmu_pkt_buf_get_skb</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t allocate new %d-byte packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pkt_align</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">free_pkt</span><span class="p">)</span>
				<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
			<span class="cm">/* free the pkt if canned one is not used */</span>
			<span class="n">free_pkt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">pkt</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
			<span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="cm">/* precondition: (frame % BRCMF_SDALIGN) == 0) */</span>
			<span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">skb_push</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
			<span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="cm">/* precondition: pad + SDPCM_HDRLEN &lt;= pkt-&gt;len */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">SDPCM_HDRLEN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* precondition: pad &lt; BRCMF_SDALIGN */</span>

	<span class="cm">/* Hardware tag: 2 byte len followed by 2 byte ~len check (all LE) */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">frame</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Software tag: channel, sequence number, data offset */</span>
	<span class="n">swheader</span> <span class="o">=</span>
	    <span class="p">((</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">SDPCM_CHANNEL_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDPCM_CHANNEL_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">|</span>
	    <span class="p">(((</span><span class="n">pad</span> <span class="o">+</span>
	       <span class="n">SDPCM_HDRLEN</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SDPCM_DOFFSET_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDPCM_DOFFSET_MASK</span><span class="p">);</span>

	<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">swheader</span><span class="p">,</span> <span class="n">frame</span> <span class="o">+</span> <span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">);</span>
	<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame</span> <span class="o">+</span> <span class="n">SDPCM_FRAMETAG_LEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">swheader</span><span class="p">));</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">tx_packets</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="n">BRCMF_BYTES_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
			   <span class="p">((</span><span class="n">BRCMF_CTL_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span> <span class="o">==</span> <span class="n">SDPCM_CONTROL_CHANNEL</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">BRCMF_DATA_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span> <span class="o">!=</span> <span class="n">SDPCM_CONTROL_CHANNEL</span><span class="p">)),</span>
			   <span class="n">frame</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Tx Frame:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">BRCMF_BYTES_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
			     <span class="p">((</span><span class="n">BRCMF_CTL_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
			       <span class="n">chan</span> <span class="o">==</span> <span class="n">SDPCM_CONTROL_CHANNEL</span><span class="p">)</span> <span class="o">||</span>
			      <span class="p">(</span><span class="n">BRCMF_DATA_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
			       <span class="n">chan</span> <span class="o">!=</span> <span class="n">SDPCM_CONTROL_CHANNEL</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
			   <span class="n">BRCMF_HDRS_ON</span><span class="p">(),</span>
			   <span class="n">frame</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="s">&quot;TxHdr:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Raise len to next SDIO block to eliminate tail command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">roundup</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">pad</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pad</span> <span class="o">&lt;=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">roundup</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pad</span> <span class="o">&lt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">))</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">pad</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">BRCMF_SDALIGN</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Some controllers have trouble with odd bytes -- round to even */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ALIGNMENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">ALIGNMENT</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_sdcard_send_pkt</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">sbwad</span><span class="p">,</span>
				    <span class="n">SDIO_FUNC_2</span><span class="p">,</span> <span class="n">F2SYNC</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f2txdata</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* On failure, abort the command and terminate the frame */</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;sdio error %d, abort command and terminate frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ret</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_sderrs</span><span class="o">++</span><span class="p">;</span>

		<span class="n">brcmf_sdcard_abort</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SDIO_FUNC_2</span><span class="p">);</span>
		<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_FUNC1_FRAMECTRL</span><span class="p">,</span>
				 <span class="n">SFC_WF_TERM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f1regdata</span><span class="o">++</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>
			<span class="n">hi</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
					      <span class="n">SBSDIO_FUNC1_WFRAMEBCHI</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">lo</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
					      <span class="n">SBSDIO_FUNC1_WFRAMEBCLO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f1regdata</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">hi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SDPCM_SEQUENCE_WRAP</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="cm">/* restore pkt buffer pointer before calling tx complete routine */</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">SDPCM_HDRLEN</span> <span class="o">+</span> <span class="n">pad</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>
	<span class="n">brcmf_txcomplete</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">free_pkt</span><span class="p">)</span>
		<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">brcmf_sdbrcm_sendfromq</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">uint</span> <span class="n">maxframes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prec_out</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">datalen</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_prec_map</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">tx_prec_map</span> <span class="o">=</span> <span class="o">~</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span><span class="p">;</span>

	<span class="cm">/* Send frames until the limit or some other event */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">maxframes</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">data_ok</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txqlock</span><span class="p">);</span>
		<span class="n">pkt</span> <span class="o">=</span> <span class="n">brcmu_pktq_mdeq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">tx_prec_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prec_out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txqlock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txqlock</span><span class="p">);</span>
		<span class="n">datalen</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">SDPCM_HDRLEN</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_txpkt</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">SDPCM_DATA_CHANNEL</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">dstats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">dstats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">datalen</span><span class="p">;</span>

		<span class="cm">/* In poll mode, need to check for other events */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">intr</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check device status, signal pending interrupt */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">r_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intstatus</span><span class="p">,</span>
					<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span>
						 <span class="n">intstatus</span><span class="p">));</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f2txdata</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span> <span class="o">&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">hostintmask</span><span class="p">)</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ipend</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Deflow-control stack if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">drvr_up</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BRCMF_BUS_DATA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">txoff</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pktq_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TXLOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">txoff</span> <span class="o">=</span> <span class="n">OFF</span><span class="p">;</span>
		<span class="n">brcmf_txflowcontrol</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_sdbrcm_bus_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">local_hostintmask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">saveclk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_bus</span> <span class="o">*</span><span class="n">bus_if</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio_dev</span> <span class="o">*</span><span class="n">sdiodev</span> <span class="o">=</span> <span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">bus_priv</span><span class="p">.</span><span class="n">sdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">watchdog_tsk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">watchdog_tsk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">watchdog_tsk</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">watchdog_tsk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsk</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsk</span> <span class="o">!=</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsk</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>

	<span class="n">bus_wake</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/* Enable clock for device interrupts */</span>
	<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_AVAIL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* Disable and clear interrupts at the chip level also */</span>
	<span class="n">w_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">hostintmask</span><span class="p">));</span>
	<span class="n">local_hostintmask</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">hostintmask</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">hostintmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Change our idea of bus state */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">;</span>

	<span class="cm">/* Force clocks on backplane to be sure F2 interrupt propagates */</span>
	<span class="n">saveclk</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
				   <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">saveclk</span> <span class="o">|</span> <span class="n">SBSDIO_FORCE_HT</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Failed to force clock for F2: err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="cm">/* Turn off the bus (F2), free any pending packets */</span>
	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INTR</span><span class="p">,</span> <span class="s">&quot;disable SDIO interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SDIO_CCCR_IOEx</span><span class="p">,</span> <span class="n">SDIO_FUNC_ENABLE_1</span><span class="p">,</span>
			 <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Clear any pending interrupts now that F2 is disabled */</span>
	<span class="n">w_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">local_hostintmask</span><span class="p">,</span>
		  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">intstatus</span><span class="p">));</span>

	<span class="cm">/* Turn off the backplane clock (only) */</span>
	<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_SDONLY</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* Clear the data packet queues */</span>
	<span class="n">brcmu_pktq_flush</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Clear any held glomming stuff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomd</span><span class="p">)</span>
		<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glomd</span><span class="p">);</span>
	<span class="n">brcmf_sdbrcm_free_glom</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/* Clear rx control and wake any waiters */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">brcmf_sdbrcm_dcmd_resp_wake</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/* Reset some F2 state stuff */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxskip</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BRCMFMAC_SDIO_OOB</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">brcmf_sdbrcm_clrintr</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">irq_en_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">irq_en</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ipend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">irq_en</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">irq_en_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">brcmf_sdbrcm_clrintr</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif		</span><span class="cm">/* CONFIG_BRCMFMAC_SDIO_OOB */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcmf_sdbrcm_dpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">intstatus</span><span class="p">,</span> <span class="n">newstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">rxlimit</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxbound</span><span class="p">;</span>	<span class="cm">/* Rx frames to read before resched */</span>
	<span class="n">uint</span> <span class="n">txlimit</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">txbound</span><span class="p">;</span>	<span class="cm">/* Tx frames to send before resched */</span>
	<span class="n">uint</span> <span class="n">framecnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Temporary counter of tx/rx frames */</span>
	<span class="n">bool</span> <span class="n">rxdone</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>	<span class="cm">/* Flag for no more read data */</span>
	<span class="n">bool</span> <span class="n">resched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* Flag indicating resched wanted */</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Start with leftover status bits */</span>
	<span class="n">intstatus</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">intstatus</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>

	<span class="cm">/* If waiting for HTAVAIL, check status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">==</span> <span class="n">CLK_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">clkctl</span><span class="p">,</span> <span class="n">devctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="cm">/* Check for inconsistent device control */</span>
		<span class="n">devctl</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
					  <span class="n">SBSDIO_DEVICE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;error reading DEVCTL: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

		<span class="cm">/* Read CSR, if clock on switch to AVAIL, else ignore */</span>
		<span class="n">clkctl</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
					  <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;error reading CSR: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">err</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;DPC: PENDING, devctl 0x%02x clkctl 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">devctl</span><span class="p">,</span> <span class="n">clkctl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SBSDIO_HTAV</span><span class="p">(</span><span class="n">clkctl</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">devctl</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
						  <span class="n">SBSDIO_DEVICE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;error reading DEVCTL: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">err</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">devctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SBSDIO_DEVCTL_CA_INT_ONLY</span><span class="p">;</span>
			<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_DEVICE_CTL</span><span class="p">,</span>
					 <span class="n">devctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;error writing DEVCTL: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">err</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">=</span> <span class="n">CLK_AVAIL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">clkwait</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bus_wake</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/* Make sure backplane clock is on */</span>
	<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_AVAIL</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">==</span> <span class="n">CLK_PENDING</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clkwait</span><span class="p">;</span>

	<span class="cm">/* Pending interrupt indicates new device status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ipend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ipend</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">r_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newstatus</span><span class="p">,</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">intstatus</span><span class="p">));</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f1regdata</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">newstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">newstatus</span> <span class="o">&amp;=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">hostintmask</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fcstate</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">newstatus</span> <span class="o">&amp;</span> <span class="n">I_HMB_FC_STATE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newstatus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">w_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">newstatus</span><span class="p">,</span>
					<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span>
						 <span class="n">intstatus</span><span class="p">));</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f1regdata</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Merge new bits with previous */</span>
	<span class="n">intstatus</span> <span class="o">|=</span> <span class="n">newstatus</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">intstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Handle flow-control change: read new state in case our ack</span>
<span class="cm">	 * crossed another change interrupt.  If change still set, assume</span>
<span class="cm">	 * FC ON for safety, let next loop through do the debounce.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span> <span class="o">&amp;</span> <span class="n">I_HMB_FC_CHANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intstatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I_HMB_FC_CHANGE</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">w_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">I_HMB_FC_CHANGE</span><span class="p">,</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">intstatus</span><span class="p">));</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">r_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newstatus</span><span class="p">,</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">intstatus</span><span class="p">));</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f1regdata</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fcstate</span> <span class="o">=</span>
		    <span class="o">!!</span><span class="p">(</span><span class="n">newstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">I_HMB_FC_STATE</span> <span class="o">|</span> <span class="n">I_HMB_FC_CHANGE</span><span class="p">));</span>
		<span class="n">intstatus</span> <span class="o">|=</span> <span class="p">(</span><span class="n">newstatus</span> <span class="o">&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">hostintmask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle host mailbox indication */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span> <span class="o">&amp;</span> <span class="n">I_HMB_HOST_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intstatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I_HMB_HOST_INT</span><span class="p">;</span>
		<span class="n">intstatus</span> <span class="o">|=</span> <span class="n">brcmf_sdbrcm_hostmail</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Generally don&#39;t ask for these, can get CRC errors... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span> <span class="o">&amp;</span> <span class="n">I_WR_OOSYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Dongle reports WR_OOSYNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">intstatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I_WR_OOSYNC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span> <span class="o">&amp;</span> <span class="n">I_RD_OOSYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Dongle reports RD_OOSYNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">intstatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I_RD_OOSYNC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span> <span class="o">&amp;</span> <span class="n">I_SBINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Dongle reports SBINT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">intstatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I_SBINT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Would be active due to wake-wlan in gSPI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span> <span class="o">&amp;</span> <span class="n">I_CHIPACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;Dongle reports CHIPACTIVE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">intstatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I_CHIPACTIVE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ignore frame indications if rxskip is set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxskip</span><span class="p">)</span>
		<span class="n">intstatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I_HMB_FRAME_IND</span><span class="p">;</span>

	<span class="cm">/* On frame indication, read available frames */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PKT_AVAILABLE</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">framecnt</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_readframes</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">rxlimit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxdone</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxdone</span> <span class="o">||</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxskip</span><span class="p">)</span>
			<span class="n">intstatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I_HMB_FRAME_IND</span><span class="p">;</span>
		<span class="n">rxlimit</span> <span class="o">-=</span> <span class="n">min</span><span class="p">(</span><span class="n">framecnt</span><span class="p">,</span> <span class="n">rxlimit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Keep still-pending events for next scheduling */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">intstatus</span> <span class="o">=</span> <span class="n">intstatus</span><span class="p">;</span>

<span class="nl">clkwait:</span>
	<span class="n">brcmf_sdbrcm_clrintr</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_ok</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_frame_stat</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">==</span> <span class="n">CLK_AVAIL</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_sdcard_send_buf</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">sbwad</span><span class="p">,</span>
			<span class="n">SDIO_FUNC_2</span><span class="p">,</span> <span class="n">F2SYNC</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_frame_buf</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_frame_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* On failure, abort the command and</span>
<span class="cm">				terminate the frame */</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;sdio error %d, abort command and terminate frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ret</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_sderrs</span><span class="o">++</span><span class="p">;</span>

			<span class="n">brcmf_sdcard_abort</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SDIO_FUNC_2</span><span class="p">);</span>

			<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_FUNC1_FRAMECTRL</span><span class="p">,</span>
					 <span class="n">SFC_WF_TERM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f1regdata</span><span class="o">++</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>
				<span class="n">hi</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
						      <span class="n">SBSDIO_FUNC1_WFRAMEBCHI</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
				<span class="n">lo</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
						      <span class="n">SBSDIO_FUNC1_WFRAMEBCLO</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f1regdata</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">hi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SDPCM_SEQUENCE_WRAP</span><span class="p">;</span>

		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;Return_dpc value is : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_frame_stat</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">brcmf_sdbrcm_wait_event_wakeup</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Send queued frames (limit 1 if rx may still be pending) */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">==</span> <span class="n">CLK_AVAIL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">fcstate</span> <span class="o">&amp;&amp;</span>
		 <span class="n">brcmu_pktq_mlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="o">~</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">txlimit</span>
		 <span class="o">&amp;&amp;</span> <span class="n">data_ok</span><span class="p">(</span><span class="n">bus</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">framecnt</span> <span class="o">=</span> <span class="n">rxdone</span> <span class="o">?</span> <span class="n">txlimit</span> <span class="o">:</span> <span class="n">min</span><span class="p">(</span><span class="n">txlimit</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">txminmax</span><span class="p">);</span>
		<span class="n">framecnt</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_sendfromq</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">framecnt</span><span class="p">);</span>
		<span class="n">txlimit</span> <span class="o">-=</span> <span class="n">framecnt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Resched if events or tx frames are pending,</span>
<span class="cm">		 else await next interrupt */</span>
	<span class="cm">/* On failed register access, all bets are off:</span>
<span class="cm">		 no resched or interrupts */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;failed backplane access over SDIO, halting operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">intstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">==</span> <span class="n">CLK_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;rescheduled due to CLK_PENDING awaiting I_CHIPACTIVE interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">resched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">intstatus</span> <span class="o">||</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ipend</span> <span class="o">||</span>
		<span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">fcstate</span> <span class="o">&amp;&amp;</span> <span class="n">brcmu_pktq_mlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="o">~</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">flowcontrol</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="n">data_ok</span><span class="p">(</span><span class="n">bus</span><span class="p">))</span> <span class="o">||</span> <span class="n">PKT_AVAILABLE</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">resched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_sched</span> <span class="o">=</span> <span class="n">resched</span><span class="p">;</span>

	<span class="cm">/* If we&#39;re done for now, turn off clock request. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">!=</span> <span class="n">CLK_PENDING</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">idletime</span> <span class="o">==</span> <span class="n">BRCMF_IDLE_IMMEDIATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_NONE</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">resched</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">brcmf_sdbrcm_adddpctsk</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">new_hd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>
		<span class="n">new_hd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">new_hd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_hd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="n">new_hd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsklst</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_dpc_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">cur_hd</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_hd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">allow_signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">);</span>
	<span class="cm">/* Run until signal received */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsklst</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_wait</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">cur_hd</span><span class="p">,</span> <span class="n">tmp_hd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsklst</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* after stopping the bus, exit thread */</span>
				<span class="n">brcmf_sdbrcm_bus_stop</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_sdbrcm_dpc</span><span class="p">(</span><span class="n">bus</span><span class="p">))</span>
				<span class="n">brcmf_sdbrcm_adddpctsk</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">cur_hd</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">cur_hd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_bus_txdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">datalen</span><span class="p">,</span> <span class="n">prec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_bus</span> <span class="o">*</span><span class="n">bus_if</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio_dev</span> <span class="o">*</span><span class="n">sdiodev</span> <span class="o">=</span> <span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">bus_priv</span><span class="p">.</span><span class="n">sdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">datalen</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Add space for the header */</span>
	<span class="n">skb_push</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">SDPCM_HDRLEN</span><span class="p">);</span>
	<span class="cm">/* precondition: IS_ALIGNED((unsigned long)(pkt-&gt;data), 2) */</span>

	<span class="n">prec</span> <span class="o">=</span> <span class="n">prio2prec</span><span class="p">((</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&amp;</span> <span class="n">PRIOMASK</span><span class="p">));</span>

	<span class="cm">/* Check for existing queue, current flow-control,</span>
<span class="cm">			 pending event, or pending clock */</span>
	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;deferring pktq len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pktq_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">));</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fcqueued</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Priority based enq */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txqlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcmf_c_prec_enq</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">prec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">SDPCM_HDRLEN</span><span class="p">);</span>
		<span class="n">brcmf_txcomplete</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;out of bus-&gt;txq !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txqlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pktq_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">TXHI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">txoff</span> <span class="o">=</span> <span class="n">ON</span><span class="p">;</span>
		<span class="n">brcmf_txflowcontrol</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pktq_plen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">qcount</span><span class="p">[</span><span class="n">prec</span><span class="p">])</span>
		<span class="n">qcount</span><span class="p">[</span><span class="n">prec</span><span class="p">]</span> <span class="o">=</span> <span class="n">pktq_plen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">prec</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Schedule DPC if needed to send queued packet(s) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_sched</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_sched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_sdbrcm_adddpctsk</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_wait</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcmf_sdbrcm_membytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">bool</span> <span class="n">write</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		 <span class="n">uint</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bcmerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sdaddr</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">dsize</span><span class="p">;</span>

	<span class="cm">/* Determine initial transfer parameters */</span>
	<span class="n">sdaddr</span> <span class="o">=</span> <span class="n">address</span> <span class="o">&amp;</span> <span class="n">SBSDIO_SB_OFT_ADDR_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sdaddr</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SBSDIO_SBWINDOW_MASK</span><span class="p">)</span>
		<span class="n">dsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">SBSDIO_SB_OFT_ADDR_LIMIT</span> <span class="o">-</span> <span class="n">sdaddr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dsize</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* Set the backplane window to include the start address */</span>
	<span class="n">bcmerror</span> <span class="o">=</span> <span class="n">brcmf_sdcard_set_sbaddr_window</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcmerror</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;window change failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">xfer_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do the transfer(s) */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;%s %d bytes at offset 0x%08x in window 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">write</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span> <span class="n">dsize</span><span class="p">,</span>
			  <span class="n">sdaddr</span><span class="p">,</span> <span class="n">address</span> <span class="o">&amp;</span> <span class="n">SBSDIO_SBWINDOW_MASK</span><span class="p">);</span>
		<span class="n">bcmerror</span> <span class="o">=</span> <span class="n">brcmf_sdcard_rwdata</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span>
					       <span class="n">sdaddr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcmerror</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;membytes transfer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Adjust for next transfer (if any) */</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">dsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="n">dsize</span><span class="p">;</span>
			<span class="n">address</span> <span class="o">+=</span> <span class="n">dsize</span><span class="p">;</span>
			<span class="n">bcmerror</span> <span class="o">=</span> <span class="n">brcmf_sdcard_set_sbaddr_window</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
								  <span class="n">address</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bcmerror</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;window change failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sdaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dsize</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">uint</span><span class="p">,</span> <span class="n">SBSDIO_SB_OFT_ADDR_LIMIT</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">xfer_done:</span>
	<span class="cm">/* Return the window to backplane enumeration space for core access */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_sdcard_set_sbaddr_window</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">sbwad</span><span class="p">))</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;FAILED to set window back to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">sbwad</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bcmerror</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define CONSOLE_LINE_MAX	192</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_readconsole</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_console</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">console</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">line</span><span class="p">[</span><span class="n">CONSOLE_LINE_MAX</span><span class="p">],</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">n</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t do anything until FWREADY updates console address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">console_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Read console log struct */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">console_addr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rte_console</span><span class="p">,</span> <span class="n">log_le</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_membytes</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">log_le</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">log_le</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>

	<span class="cm">/* Allocate console buffer (one time only) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">log_le</span><span class="p">.</span><span class="n">buf_size</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">log_le</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>

	<span class="cm">/* Protect against corrupt value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">;</span>

	<span class="cm">/* Skip reading the console buffer if the index pointer</span>
<span class="cm">	 has not moved */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Read the console buffer */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">log_le</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_membytes</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">CONSOLE_LINE_MAX</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* This would output a partial line.</span>
<span class="cm">				 * Instead, back up</span>
<span class="cm">				 * the buffer pointer and output this</span>
<span class="cm">				 * line next time around.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">)</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">-</span> <span class="n">n</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">break2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">];</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">line</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span>
				<span class="n">n</span><span class="o">--</span><span class="p">;</span>
			<span class="n">line</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;CONSOLE: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">break2:</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_tx_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_frame_stat</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_sdcard_send_buf</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">sbwad</span><span class="p">,</span>
				    <span class="n">SDIO_FUNC_2</span><span class="p">,</span> <span class="n">F2SYNC</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* On failure, abort the command and terminate the frame */</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;sdio error %d, abort command and terminate frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ret</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_sderrs</span><span class="o">++</span><span class="p">;</span>

		<span class="n">brcmf_sdcard_abort</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SDIO_FUNC_2</span><span class="p">);</span>

		<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_FUNC1_FRAMECTRL</span><span class="p">,</span>
				 <span class="n">SFC_WF_TERM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f1regdata</span><span class="o">++</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>
			<span class="n">hi</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
					      <span class="n">SBSDIO_FUNC1_WFRAMEBCHI</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">lo</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
					      <span class="n">SBSDIO_FUNC1_WFRAMEBCLO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">f1regdata</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hi</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">lo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SDPCM_SEQUENCE_WRAP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcmf_sdbrcm_bus_txctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">uint</span> <span class="n">msglen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swheader</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">doff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_bus</span> <span class="o">*</span><span class="n">bus_if</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio_dev</span> <span class="o">*</span><span class="n">sdiodev</span> <span class="o">=</span> <span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">bus_priv</span><span class="p">.</span><span class="n">sdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Back the pointer to make a room for bus header */</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">-</span> <span class="n">SDPCM_HDRLEN</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">msglen</span> <span class="o">+=</span> <span class="n">SDPCM_HDRLEN</span><span class="p">);</span>

	<span class="cm">/* Add alignment padding (optional for ctl frames) */</span>
	<span class="n">doff</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">frame</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">doff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame</span> <span class="o">-=</span> <span class="n">doff</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">doff</span><span class="p">;</span>
		<span class="n">msglen</span> <span class="o">+=</span> <span class="n">doff</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">doff</span> <span class="o">+</span> <span class="n">SDPCM_HDRLEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* precondition: doff &lt; BRCMF_SDALIGN */</span>
	<span class="n">doff</span> <span class="o">+=</span> <span class="n">SDPCM_HDRLEN</span><span class="p">;</span>

	<span class="cm">/* Round send length to next SDIO block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">roundup</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">pad</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pad</span> <span class="o">&lt;=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">roundup</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pad</span> <span class="o">&lt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">pad</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">BRCMF_SDALIGN</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Satisfy length-alignment requirements */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ALIGNMENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">ALIGNMENT</span><span class="p">);</span>

	<span class="cm">/* precondition: IS_ALIGNED((unsigned long)frame, 2) */</span>

	<span class="cm">/* Need to lock here to protect txseq and SDIO tx calls */</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>

	<span class="n">bus_wake</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/* Make sure backplane clock is on */</span>
	<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_AVAIL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* Hardware tag: 2 byte len followed by 2 byte ~len check (all LE) */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">msglen</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">frame</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="n">msglen</span><span class="p">);</span>

	<span class="cm">/* Software tag: channel, sequence number, data offset */</span>
	<span class="n">swheader</span> <span class="o">=</span>
	    <span class="p">((</span><span class="n">SDPCM_CONTROL_CHANNEL</span> <span class="o">&lt;&lt;</span> <span class="n">SDPCM_CHANNEL_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
	     <span class="n">SDPCM_CHANNEL_MASK</span><span class="p">)</span>
	    <span class="o">|</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">|</span> <span class="p">((</span><span class="n">doff</span> <span class="o">&lt;&lt;</span> <span class="n">SDPCM_DOFFSET_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="n">SDPCM_DOFFSET_MASK</span><span class="p">);</span>
	<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">swheader</span><span class="p">,</span> <span class="n">frame</span> <span class="o">+</span> <span class="n">SDPCM_FRAMETAG_LEN</span><span class="p">);</span>
	<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame</span> <span class="o">+</span> <span class="n">SDPCM_FRAMETAG_LEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">swheader</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data_ok</span><span class="p">(</span><span class="n">bus</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;No bus credit bus-&gt;tx_max %d, bus-&gt;tx_seq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_max</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_frame_stat</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* Send from dpc */</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_frame_buf</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_frame_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">brcmf_sdbrcm_wait_for_event</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_frame_stat</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_frame_stat</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;ctrl_frame_stat == false</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;ctrl_frame_stat == true</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="n">BRCMF_BYTES_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">BRCMF_CTL_ON</span><span class="p">(),</span>
				   <span class="n">frame</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Tx Frame:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">brcmf_dbg_hex_dump</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">BRCMF_BYTES_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">BRCMF_CTL_ON</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
				   <span class="n">BRCMF_HDRS_ON</span><span class="p">(),</span>
				   <span class="n">frame</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="s">&quot;TxHdr:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_tx_frame</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">retries</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">TXRETRIES</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">idletime</span> <span class="o">==</span> <span class="n">BRCMF_IDLE_IMMEDIATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_sched</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_NONE</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_ctlerrs</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_ctlpkts</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcmf_sdbrcm_bus_rxctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">uint</span> <span class="n">msglen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">rxlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">pending</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_bus</span> <span class="o">*</span><span class="n">bus_if</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio_dev</span> <span class="o">*</span><span class="n">sdiodev</span> <span class="o">=</span> <span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">bus_priv</span><span class="p">.</span><span class="n">sdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Wait until control frame is available */</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_dcmd_resp_wait</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pending</span><span class="p">);</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>
	<span class="n">rxlen</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxlen</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxctl</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">msglen</span><span class="p">,</span> <span class="n">rxlen</span><span class="p">));</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">CTL</span><span class="p">,</span> <span class="s">&quot;resumed on rxctl frame, got %d expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">rxlen</span><span class="p">,</span> <span class="n">msglen</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">timeleft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;resumed on timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">CTL</span><span class="p">,</span> <span class="s">&quot;cancelled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">CTL</span><span class="p">,</span> <span class="s">&quot;resumed for unknown reason?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxlen</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_ctlpkts</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rx_ctlerrs</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rxlen</span> <span class="o">?</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">rxlen</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_downloadvars</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bcmerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Basic sanity checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">drvr_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcmerror</span> <span class="o">=</span> <span class="o">-</span><span class="n">EISCONN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcmerror</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Free the old ones and replace with passed variables */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">vars</span><span class="p">);</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">vars</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">varsz</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">vars</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">vars</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcmerror</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy the passed variables, which should include the</span>
<span class="cm">		 terminating double-null */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">vars</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">varsz</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">bcmerror</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_write_vars</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bcmerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">varsize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">varaddr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">vbuffer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">varsizew</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">varsizew_le</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">nvram_ularray</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

	<span class="cm">/* Even if there are no vars are to be written, we still</span>
<span class="cm">		 need to set the ramsize. */</span>
	<span class="n">varsize</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">varsz</span> <span class="o">?</span> <span class="n">roundup</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">varsz</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">varaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ramsize</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">varsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">vars</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vbuffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">varsize</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vbuffer</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">vbuffer</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">vars</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">varsz</span><span class="p">);</span>

		<span class="cm">/* Write the vars list */</span>
		<span class="n">bcmerror</span> <span class="o">=</span>
		    <span class="n">brcmf_sdbrcm_membytes</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">varaddr</span><span class="p">,</span> <span class="n">vbuffer</span><span class="p">,</span> <span class="n">varsize</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="cm">/* Verify NVRAM bytes */</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;Compare NVRAM dl &amp; ul; varsize=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">varsize</span><span class="p">);</span>
		<span class="n">nvram_ularray</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">varsize</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nvram_ularray</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">vbuffer</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Upload image to verify downloaded contents. */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">nvram_ularray</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="n">varsize</span><span class="p">);</span>

		<span class="cm">/* Read the vars list to temp buffer for comparison */</span>
		<span class="n">bcmerror</span> <span class="o">=</span>
		    <span class="n">brcmf_sdbrcm_membytes</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">varaddr</span><span class="p">,</span> <span class="n">nvram_ularray</span><span class="p">,</span>
				     <span class="n">varsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcmerror</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;error %d on reading %d nvram bytes at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">bcmerror</span><span class="p">,</span> <span class="n">varsize</span><span class="p">,</span> <span class="n">varaddr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Compare the org NVRAM with the one read from RAM */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">vbuffer</span><span class="p">,</span> <span class="n">nvram_ularray</span><span class="p">,</span> <span class="n">varsize</span><span class="p">))</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Downloaded NVRAM image is corrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Download/Upload/Compare of NVRAM ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">nvram_ularray</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">vbuffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* adjust to the user specified RAM */</span>
	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;Physical memory size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ramsize</span><span class="p">);</span>
	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;Vars are at %d, orig varsize is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">varaddr</span><span class="p">,</span> <span class="n">varsize</span><span class="p">);</span>
	<span class="n">varsize</span> <span class="o">=</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ramsize</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">varaddr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine the length token:</span>
<span class="cm">	 * Varsize, converted to words, in lower 16-bits, checksum</span>
<span class="cm">	 * in upper 16-bits.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcmerror</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">varsizew</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">varsizew_le</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">varsizew</span> <span class="o">=</span> <span class="n">varsize</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">varsizew</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">varsizew</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">varsizew</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
		<span class="n">varsizew_le</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">varsizew</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;New varsize is %d, length token=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">varsize</span><span class="p">,</span> <span class="n">varsizew</span><span class="p">);</span>

	<span class="cm">/* Write the length token to the last word */</span>
	<span class="n">bcmerror</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_membytes</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ramsize</span> <span class="o">-</span> <span class="mi">4</span><span class="p">),</span>
					 <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">varsizew_le</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bcmerror</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_download_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bcmerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chip_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">;</span>

	<span class="cm">/* To enter download state, disable ARM and reset SOCRAM.</span>
<span class="cm">	 * To exit download state, simply reset ARM (default is RAM boot).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">alp_only</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">coredisable</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">BCMA_CORE_ARM_CM3</span><span class="p">);</span>

		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">resetcore</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">BCMA_CORE_INTERNAL_MEM</span><span class="p">);</span>

		<span class="cm">/* Clear the top bit of memory */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ramsize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">zeros</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">brcmf_sdbrcm_membytes</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ramsize</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">zeros</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">iscoreup</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">BCMA_CORE_INTERNAL_MEM</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;SOCRAM core is down after reset?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bcmerror</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bcmerror</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_write_vars</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcmerror</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;no vars written to RAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bcmerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">w_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span>
			  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">intstatus</span><span class="p">));</span>

		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">resetcore</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">BCMA_CORE_ARM_CM3</span><span class="p">);</span>

		<span class="cm">/* Allow HT Clock now that the ARM is running. */</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">alp_only</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BRCMF_BUS_LOAD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">bcmerror</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_get_image</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">fw_ptr</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">fw_ptr</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">fw_ptr</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fw_ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_download_code_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">memblock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">memptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">,</span> <span class="n">BRCMF_SDIO_FW_NAME</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Fail to request firmware %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fw_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memptr</span> <span class="o">=</span> <span class="n">memblock</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MEMBLOCK</span> <span class="o">+</span> <span class="n">BRCMF_SDALIGN</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memblock</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">memblock</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">)</span>
		<span class="n">memptr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">BRCMF_SDALIGN</span> <span class="o">-</span>
			   <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">memblock</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">));</span>

	<span class="cm">/* Download image */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">len</span> <span class="o">=</span>
		<span class="n">brcmf_sdbrcm_get_image</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">memptr</span><span class="p">,</span> <span class="n">MEMBLOCK</span><span class="p">,</span> <span class="n">bus</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_membytes</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">memptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;error %d on writing %d membytes at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ret</span><span class="p">,</span> <span class="n">MEMBLOCK</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">MEMBLOCK</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">memblock</span><span class="p">);</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fw_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ProcessVars:Takes a buffer of &quot;&lt;var&gt;=&lt;value&gt;\n&quot; lines read from a file</span>
<span class="cm"> * and ending in a NUL.</span>
<span class="cm"> * Removes carriage returns, empty lines, comment lines, and converts</span>
<span class="cm"> * newlines to NULs.</span>
<span class="cm"> * Shortens buffer as needed and pads with NULs.  End of buffer is marked</span>
<span class="cm"> * by two NULs.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">brcmf_process_nvram_vars</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">varbuf</span><span class="p">,</span> <span class="n">uint</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">findNewline</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">column</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">varbuf</span><span class="p">;</span>

	<span class="n">findNewline</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">varbuf</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">varbuf</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">findNewline</span> <span class="o">&amp;&amp;</span> <span class="n">varbuf</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">findNewline</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">varbuf</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">findNewline</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">varbuf</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">column</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">dp</span><span class="o">++</span> <span class="o">=</span> <span class="n">varbuf</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
		<span class="n">column</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">dp</span> <span class="o">-</span> <span class="n">varbuf</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dp</span> <span class="o">&lt;</span> <span class="n">varbuf</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buf_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_download_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">memblock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bufp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">,</span> <span class="n">BRCMF_SDIO_NV_NAME</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Fail to request nvram %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fw_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memblock</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MEMBLOCK</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memblock</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_get_image</span><span class="p">(</span><span class="n">memblock</span><span class="p">,</span> <span class="n">MEMBLOCK</span><span class="p">,</span> <span class="n">bus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">MEMBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bufp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">memblock</span><span class="p">;</span>
		<span class="n">bufp</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">brcmf_process_nvram_vars</span><span class="p">(</span><span class="n">bufp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">bufp</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bufp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_downloadvars</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">memblock</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;error downloading vars: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;error reading nvram file: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">memblock</span><span class="p">);</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">fw_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_brcmf_sdbrcm_download_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bcmerror</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Keep arm in reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_sdbrcm_download_state</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;error placing ARM core in reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* External image takes precedence if specified */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_sdbrcm_download_code_file</span><span class="p">(</span><span class="n">bus</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;dongle image file download failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* External nvram takes precedence if specified */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_sdbrcm_download_nvram</span><span class="p">(</span><span class="n">bus</span><span class="p">))</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;dongle nvram file download failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Take arm out of reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_sdbrcm_download_state</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;error getting out of ARM core reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bcmerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">bcmerror</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">brcmf_sdbrcm_download_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Download the firmware */</span>
	<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_AVAIL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_brcmf_sdbrcm_download_firmware</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_SDONLY</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_sdbrcm_bus_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_bus</span> <span class="o">*</span><span class="n">bus_if</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio_dev</span> <span class="o">*</span><span class="n">sdiodev</span> <span class="o">=</span> <span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">bus_priv</span><span class="p">.</span><span class="n">sdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ready</span><span class="p">,</span> <span class="n">enable</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">saveclk</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* try to download image and nvram to the dongle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">brcmf_sdbrcm_download_firmware</span><span class="p">(</span><span class="n">bus</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">drvr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Start the watchdog timer */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tickcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">brcmf_sdbrcm_wd_timer</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">BRCMF_WD_POLL_MS</span><span class="p">);</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>

	<span class="cm">/* Make sure backplane clock is on, needed to generate F2 interrupt */</span>
	<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_AVAIL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">!=</span> <span class="n">CLK_AVAIL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/* Force clocks on backplane to be sure F2 interrupt propagates */</span>
	<span class="n">saveclk</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
				   <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">saveclk</span> <span class="o">|</span> <span class="n">SBSDIO_FORCE_HT</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Failed to force clock for F2: err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable function 2 (frame transfers) */</span>
	<span class="n">w_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">SDPCM_PROT_VERSION</span> <span class="o">&lt;&lt;</span> <span class="n">SMB_DATA_VERSION_SHIFT</span><span class="p">,</span>
		  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">tosbmailboxdata</span><span class="p">));</span>
	<span class="n">enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">SDIO_FUNC_ENABLE_1</span> <span class="o">|</span> <span class="n">SDIO_FUNC_ENABLE_2</span><span class="p">);</span>

	<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SDIO_CCCR_IOEx</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">BRCMF_WAIT_F2RDY</span><span class="p">);</span>
	<span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">enable</span> <span class="o">!=</span> <span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ready</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
					 <span class="n">SDIO_CCCR_IORx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="n">BRCMF_WAIT_F2RDY</span> <span class="o">+</span> <span class="mi">50</span><span class="p">))</span>
			<span class="cm">/* prevent busy waiting if it takes too long */</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;enable 0x%02x, ready 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">ready</span><span class="p">);</span>

	<span class="cm">/* If F2 successfully enabled, set core and enable interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ready</span> <span class="o">==</span> <span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set up the interrupt mask and enable interrupts */</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">hostintmask</span> <span class="o">=</span> <span class="n">HOSTINTMASK</span><span class="p">;</span>
		<span class="n">w_sdreg32</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">hostintmask</span><span class="p">,</span>
			  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">hostintmask</span><span class="p">));</span>

		<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_WATERMARK</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Disable F2 again */</span>
		<span class="n">enable</span> <span class="o">=</span> <span class="n">SDIO_FUNC_ENABLE_1</span><span class="p">;</span>
		<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SDIO_CCCR_IOEx</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Restore previous clock setting */</span>
	<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span> <span class="n">saveclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_sdio_intr_register</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;intr register failed:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If we didn&#39;t come up, turn off backplane clock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BRCMF_BUS_DATA</span><span class="p">)</span>
		<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_NONE</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcmf_sdbrcm_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;bus is null pointer, exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;bus is down. we have nothing to do</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Count the interrupt call */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">intrcount</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ipend</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Shouldn&#39;t get this interrupt if we&#39;re sleeping? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sleeping</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;INTERRUPT WHILE SLEEPING??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable additional interrupts (is this needed now)? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">)</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;isr w/o interrupt configured!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_sched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_sdbrcm_adddpctsk</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcmf_sdbrcm_bus_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">struct</span> <span class="n">brcmf_bus</span> <span class="o">*</span><span class="n">bus_if</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TIMER</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Ignore the timer if simulating bus down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sleeping</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>

	<span class="cm">/* Poll period: check device if appropriate. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">++</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">polltick</span> <span class="o">&gt;=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">pollrate</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">intstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Reset poll tick */</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">polltick</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Check device if no interrupts */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">intr</span> <span class="o">||</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">intrcount</span> <span class="o">==</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">lastintrs</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_sched</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">devpend</span><span class="p">;</span>
				<span class="n">devpend</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
							   <span class="n">SDIO_CCCR_INTx</span><span class="p">,</span>
							   <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">intstatus</span> <span class="o">=</span>
				    <span class="n">devpend</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INTR_STATUS_FUNC1</span> <span class="o">|</span>
					       <span class="n">INTR_STATUS_FUNC2</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* If there is something, make like the ISR and</span>
<span class="cm">				 schedule the DPC */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">pollcnt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ipend</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_sched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsk</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">brcmf_sdbrcm_adddpctsk</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
					<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_wait</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Update interrupt tracking */</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">lastintrs</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">intrcount</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="cm">/* Poll for console output periodically */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BRCMF_BUS_DATA</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">console_interval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">console</span><span class="p">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">BRCMF_WD_POLL_MS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">console</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">console_interval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">console</span><span class="p">.</span><span class="n">count</span> <span class="o">-=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">console_interval</span><span class="p">;</span>
			<span class="cm">/* Make sure backplane clock is on */</span>
			<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_AVAIL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_sdbrcm_readconsole</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* stop on error */</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">console_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

	<span class="cm">/* On idle timeout clear activity flag and/or turn off clock */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">idletime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">==</span> <span class="n">CLK_AVAIL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">idlecount</span> <span class="o">&gt;=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">idletime</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">idlecount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">activity</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">brcmf_sdbrcm_wd_timer</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">BRCMF_WD_POLL_MS</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_NONE</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ipend</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcmf_sdbrcm_chipmatch</span><span class="p">(</span><span class="n">u16</span> <span class="n">chipid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chipid</span> <span class="o">==</span> <span class="n">BCM4329_CHIP_ID</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chipid</span> <span class="o">==</span> <span class="n">BCM4330_CHIP_ID</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_sdbrcm_release_malloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxctl</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">databuf</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">databuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcmf_sdbrcm_probe_malloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">maxctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxblen</span> <span class="o">=</span>
		    <span class="n">roundup</span><span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">maxctl</span> <span class="o">+</span> <span class="n">SDPCM_HDRLEN</span><span class="p">),</span>
			    <span class="n">ALIGNMENT</span><span class="p">)</span> <span class="o">+</span> <span class="n">BRCMF_SDALIGN</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxblen</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate buffer to receive glomed packet */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">databuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_DATA_BUF</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">databuf</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* release rxbuf which was already located as above */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxblen</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Align the buffer */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">databuf</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">dataptr</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">databuf</span> <span class="o">+</span> <span class="p">(</span><span class="n">BRCMF_SDALIGN</span> <span class="o">-</span>
			       <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">databuf</span> <span class="o">%</span> <span class="n">BRCMF_SDALIGN</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">dataptr</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">databuf</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">brcmf_sdbrcm_probe_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u32</span> <span class="n">regsva</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">clkctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">alp_only</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;F1 signature read @0x18000000=0x%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">brcmf_sdio_regrl</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SI_ENUM_BASE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Force PLL off until brcmf_sdio_chip_attach()</span>
<span class="cm">	 * programs PLL control regs</span>
<span class="cm">	 */</span>

	<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span>
			 <span class="n">BRCMF_INIT_CLKCTL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">clkctl</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span>
					  <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="p">((</span><span class="n">clkctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SBSDIO_AVBITS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BRCMF_INIT_CLKCTL1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;ChipClkCSR access: err %d wrote 0x%02x read 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">err</span><span class="p">,</span> <span class="n">BRCMF_INIT_CLKCTL1</span><span class="p">,</span> <span class="n">clkctl</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_sdio_chip_attach</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">,</span> <span class="n">regsva</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;brcmf_sdio_chip_attach failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcmf_sdbrcm_chipmatch</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;unsupported chip: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">brcmf_sdio_chip_drivestrengthinit</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">,</span>
					  <span class="n">SDIO_DRIVE_STRENGTH</span><span class="p">);</span>

	<span class="cm">/* Get info on the SOCRAM cores... */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ramsize</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">ramsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ramsize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;failed to find SOCRAM memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set core control so an SDIO reset does a backplane reset */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">brcmf_sdio_chip_getinfidx</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">,</span> <span class="n">BCMA_CORE_SDIO_DEV</span><span class="p">);</span>
	<span class="n">reg_addr</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">c_inf</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">base</span> <span class="o">+</span>
		   <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdpcmd_regs</span><span class="p">,</span> <span class="n">corecontrol</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">brcmf_sdio_regrl</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">brcmf_sdio_regwl</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">reg_val</span> <span class="o">|</span> <span class="n">CC_BPRESEN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">brcmu_pktq_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="p">(</span><span class="n">PRIOMASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">TXQLEN</span><span class="p">);</span>

	<span class="cm">/* Locate an appropriately-aligned portion of hdrbuf */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxhdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">roundup</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">hdrbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				    <span class="n">BRCMF_SDALIGN</span><span class="p">);</span>

	<span class="cm">/* Set the poll and/or interrupt flags */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">intr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">pollrate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcmf_sdbrcm_probe_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Disable F2 to clear any intermediate frame state on the dongle */</span>
	<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SDIO_CCCR_IOEx</span><span class="p">,</span>
			 <span class="n">SDIO_FUNC_ENABLE_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sleeping</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxflow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Done with backplane-dependent accesses, can drop clock... */</span>
	<span class="n">brcmf_sdio_regwb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">,</span> <span class="n">SBSDIO_FUNC1_CHIPCLKCSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* ...and initialize clock/power states */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">clkstate</span> <span class="o">=</span> <span class="n">CLK_SDONLY</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">idletime</span> <span class="o">=</span> <span class="n">BRCMF_IDLE_INTERVAL</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">idleclock</span> <span class="o">=</span> <span class="n">BRCMF_IDLE_ACTIVE</span><span class="p">;</span>

	<span class="cm">/* Query the F2 block size, set roundup accordingly */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cur_blksize</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">roundup</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max_roundup</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">);</span>

	<span class="cm">/* bus module does not support packet chaining */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">use_rxchain</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sd_rxchain</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcmf_sdbrcm_watchdog_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">allow_signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">);</span>
	<span class="cm">/* Run until signal received */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">watchdog_wait</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brcmf_sdbrcm_bus_watchdog</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
			<span class="cm">/* Count the tick for reference */</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tickcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcmf_sdbrcm_watchdog</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">watchdog_tsk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">watchdog_wait</span><span class="p">);</span>
		<span class="cm">/* Reschedule the watchdog */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">wd_timer_valid</span><span class="p">)</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">BRCMF_WD_POLL_MS</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_sdbrcm_release_dongle</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_AVAIL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">brcmf_sdbrcm_clkctl</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">CLK_NONE</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">brcmf_sdio_chip_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">vars</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">varsz</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">vars</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">vars</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Detach and free everything */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_sdbrcm_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* De-register interrupt handler */</span>
		<span class="n">brcmf_sdio_intr_unregister</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">drvr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_detach</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">brcmf_sdbrcm_release_dongle</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">brcmf_sdbrcm_release_malloc</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">brcmf_sdbrcm_probe</span><span class="p">(</span><span class="n">u32</span> <span class="n">regsva</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcmf_sdio_dev</span> <span class="o">*</span><span class="n">sdiodev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* We make an assumption about address window mappings:</span>
<span class="cm">	 * regsva == SI_ENUM_BASE*/</span>

	<span class="cm">/* Allocate private bus interface state */</span>
	<span class="n">bus</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span> <span class="o">=</span> <span class="n">sdiodev</span><span class="p">;</span>
	<span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">glom</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">txbound</span> <span class="o">=</span> <span class="n">BRCMF_TXBOUND</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rxbound</span> <span class="o">=</span> <span class="n">BRCMF_RXBOUND</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">txminmax</span> <span class="o">=</span> <span class="n">BRCMF_TXMINMAX</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">=</span> <span class="n">SDPCM_SEQUENCE_WRAP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">usebufpool</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* Use bufpool if allocated,</span>
<span class="cm">					 else use locally malloced rxbuf */</span>

	<span class="cm">/* attempt to attach to the dongle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">brcmf_sdbrcm_probe_attach</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">regsva</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;brcmf_sdbrcm_probe_attach failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">txqlock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ctrl_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dcmd_resp_wait</span><span class="p">);</span>

	<span class="cm">/* Set up the watchdog timer */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_watchdog</span><span class="p">;</span>

	<span class="cm">/* Initialize thread based operation and lock */</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdsem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Initialize watchdog thread */</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">watchdog_wait</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">watchdog_tsk</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">brcmf_sdbrcm_watchdog_thread</span><span class="p">,</span>
					<span class="n">bus</span><span class="p">,</span> <span class="s">&quot;brcmf_watchdog&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">watchdog_tsk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;brcmf_watchdog thread failed to start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">watchdog_tsk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Initialize DPC thread */</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_wait</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsklst</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tl_lock</span><span class="p">);</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsk</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">brcmf_sdbrcm_dpc_thread</span><span class="p">,</span>
				   <span class="n">bus</span><span class="p">,</span> <span class="s">&quot;brcmf_dpc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;brcmf_dpc thread failed to start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">dpc_tsk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Assign bus interface call back */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">brcmf_bus_stop</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_bus_stop</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">brcmf_bus_init</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_bus_init</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">brcmf_bus_txdata</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_bus_txdata</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">brcmf_bus_txctl</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_bus_txctl</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">brcmf_bus_rxctl</span> <span class="o">=</span> <span class="n">brcmf_sdbrcm_bus_rxctl</span><span class="p">;</span>
	<span class="cm">/* Attach to the brcmf/OS/network interface */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_attach</span><span class="p">(</span><span class="n">SDPCM_RESERVE</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;brcmf_attach failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">brcmf_sdbrcm_probe_malloc</span><span class="p">(</span><span class="n">bus</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;brcmf_sdbrcm_probe_malloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">brcmf_sdbrcm_probe_init</span><span class="p">(</span><span class="n">bus</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;brcmf_sdbrcm_probe_init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;completed!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* if firmware path present try to download and bring up bus */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_bus_start</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;dongle is not responding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bus</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">brcmf_sdbrcm_release</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcmf_sdbrcm_disconnect</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="p">)</span>
		<span class="n">brcmf_sdbrcm_release</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">brcmf_sdbrcm_wd_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_sdio</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">uint</span> <span class="n">wdtick</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Totally stop the timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdtick</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">wd_timer_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">wd_timer_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">save_ms</span> <span class="o">=</span> <span class="n">wdtick</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* don&#39;t start the wd until fw is loaded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sdiodev</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdtick</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">save_ms</span> <span class="o">!=</span> <span class="n">BRCMF_WD_POLL_MS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">wd_timer_valid</span><span class="p">)</span>
				<span class="cm">/* Stop timer and restart at new value */</span>
				<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

			<span class="cm">/* Create timer again when watchdog period is</span>
<span class="cm">			   dynamically changed or in the first instance</span>
<span class="cm">			 */</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
				<span class="n">jiffies</span> <span class="o">+</span> <span class="n">BRCMF_WD_POLL_MS</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Re arm the timer, at last watchdog period */</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">jiffies</span> <span class="o">+</span> <span class="n">BRCMF_WD_POLL_MS</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">wd_timer_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">save_ms</span> <span class="o">=</span> <span class="n">wdtick</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
