<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › brcm80211 › brcmfmac › dhd_cdc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>dhd_cdc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY</span>
<span class="cm"> * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION</span>
<span class="cm"> * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cm">/*******************************************************************************</span>
<span class="cm"> * Communicates with the dongle by using dcmd codes.</span>
<span class="cm"> * For certain dcmd codes, the dongle interprets string data from the host.</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;defs.h&gt;</span>

<span class="cp">#include &lt;brcmu_utils.h&gt;</span>
<span class="cp">#include &lt;brcmu_wifi.h&gt;</span>

<span class="cp">#include &quot;dhd.h&quot;</span>
<span class="cp">#include &quot;dhd_proto.h&quot;</span>
<span class="cp">#include &quot;dhd_bus.h&quot;</span>
<span class="cp">#include &quot;dhd_dbg.h&quot;</span>

<span class="k">struct</span> <span class="n">brcmf_proto_cdc_dcmd</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">cmd</span><span class="p">;</span>	<span class="cm">/* dongle command value */</span>
	<span class="n">__le32</span> <span class="n">len</span><span class="p">;</span>	<span class="cm">/* lower 16: output buflen;</span>
<span class="cm">			 * upper 16: input buflen (excludes header) */</span>
	<span class="n">__le32</span> <span class="n">flags</span><span class="p">;</span>	<span class="cm">/* flag defns given below */</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>	<span class="cm">/* status code returned from the device */</span>
<span class="p">};</span>

<span class="cm">/* Max valid buffer size that can be sent to the dongle */</span>
<span class="cp">#define CDC_MAX_MSG_SIZE	(ETH_FRAME_LEN+ETH_FCS_LEN)</span>

<span class="cm">/* CDC flag definitions */</span>
<span class="cp">#define CDC_DCMD_ERROR		0x01	</span><span class="cm">/* 1=cmd failed */</span><span class="cp"></span>
<span class="cp">#define CDC_DCMD_SET		0x02	</span><span class="cm">/* 0=get, 1=set cmd */</span><span class="cp"></span>
<span class="cp">#define CDC_DCMD_IF_MASK	0xF000		</span><span class="cm">/* I/F index */</span><span class="cp"></span>
<span class="cp">#define CDC_DCMD_IF_SHIFT	12</span>
<span class="cp">#define CDC_DCMD_ID_MASK	0xFFFF0000	</span><span class="cm">/* id an cmd pairing */</span><span class="cp"></span>
<span class="cp">#define CDC_DCMD_ID_SHIFT	16		</span><span class="cm">/* ID Mask shift bits */</span><span class="cp"></span>
<span class="cp">#define CDC_DCMD_ID(flags)	\</span>
<span class="cp">	(((flags) &amp; CDC_DCMD_ID_MASK) &gt;&gt; CDC_DCMD_ID_SHIFT)</span>

<span class="cm">/*</span>
<span class="cm"> * BDC header - Broadcom specific extension of CDC.</span>
<span class="cm"> * Used on data packets to convey priority across USB.</span>
<span class="cm"> */</span>
<span class="cp">#define	BDC_HEADER_LEN		4</span>
<span class="cp">#define BDC_PROTO_VER		2	</span><span class="cm">/* Protocol version */</span><span class="cp"></span>
<span class="cp">#define BDC_FLAG_VER_MASK	0xf0	</span><span class="cm">/* Protocol version mask */</span><span class="cp"></span>
<span class="cp">#define BDC_FLAG_VER_SHIFT	4	</span><span class="cm">/* Protocol version shift */</span><span class="cp"></span>
<span class="cp">#define BDC_FLAG_SUM_GOOD	0x04	</span><span class="cm">/* Good RX checksums */</span><span class="cp"></span>
<span class="cp">#define BDC_FLAG_SUM_NEEDED	0x08	</span><span class="cm">/* Dongle needs to do TX checksums */</span><span class="cp"></span>
<span class="cp">#define BDC_PRIORITY_MASK	0x7</span>
<span class="cp">#define BDC_FLAG2_IF_MASK	0x0f	</span><span class="cm">/* packet rx interface in APSTA */</span><span class="cp"></span>
<span class="cp">#define BDC_FLAG2_IF_SHIFT	0</span>

<span class="cp">#define BDC_GET_IF_IDX(hdr) \</span>
<span class="cp">	((int)((((hdr)-&gt;flags2) &amp; BDC_FLAG2_IF_MASK) &gt;&gt; BDC_FLAG2_IF_SHIFT))</span>
<span class="cp">#define BDC_SET_IF_IDX(hdr, idx) \</span>
<span class="cp">	((hdr)-&gt;flags2 = (((hdr)-&gt;flags2 &amp; ~BDC_FLAG2_IF_MASK) | \</span>
<span class="cp">	((idx) &lt;&lt; BDC_FLAG2_IF_SHIFT)))</span>

<span class="k">struct</span> <span class="n">brcmf_proto_bdc_header</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">priority</span><span class="p">;</span>	<span class="cm">/* 802.1d Priority, 4:7 flow control info for usb */</span>
	<span class="n">u8</span> <span class="n">flags2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data_offset</span><span class="p">;</span>
<span class="p">};</span>


<span class="cp">#define RETRIES 2 </span><span class="cm">/* # of retries to retrieve matching dcmd response */</span><span class="cp"></span>
<span class="cp">#define BUS_HEADER_LEN	(16+64)		</span><span class="cm">/* Must be atleast SDPCM_RESERVE</span>
<span class="cm">					 * (amount of header tha might be added)</span>
<span class="cm">					 * plus any space that might be needed</span>
<span class="cm">					 * for bus alignment padding.</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#define ROUND_UP_MARGIN	2048	</span><span class="cm">/* Biggest bus block size possible for</span>
<span class="cm">				 * round off at the end of buffer</span>
<span class="cm">				 * Currently is SDIO</span>
<span class="cm">				 */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">brcmf_proto</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">reqid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pending</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lastcmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bus_header</span><span class="p">[</span><span class="n">BUS_HEADER_LEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">brcmf_proto_cdc_dcmd</span> <span class="n">msg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BRCMF_DCMD_MAXLEN</span> <span class="o">+</span> <span class="n">ROUND_UP_MARGIN</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_proto_cdc_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_pub</span> <span class="o">*</span><span class="n">drvr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_proto</span> <span class="o">*</span><span class="n">prot</span> <span class="o">=</span> <span class="n">drvr</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prot</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_proto_cdc_dcmd</span><span class="p">);</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* NOTE : cdc-&gt;msg.len holds the desired length of the buffer to be</span>
<span class="cm">	 *        returned. Only up to CDC_MAX_MSG_SIZE of this buffer area</span>
<span class="cm">	 *        is actually sent to the dongle</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">CDC_MAX_MSG_SIZE</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">CDC_MAX_MSG_SIZE</span><span class="p">;</span>

	<span class="cm">/* Send request */</span>
	<span class="k">return</span> <span class="n">drvr</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">brcmf_bus_txctl</span><span class="p">(</span><span class="n">drvr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">prot</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span>
					     <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_proto_cdc_cmplt</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_pub</span> <span class="o">*</span><span class="n">drvr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_proto</span> <span class="o">*</span><span class="n">prot</span> <span class="o">=</span> <span class="n">drvr</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drvr</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">brcmf_bus_rxctl</span><span class="p">(</span><span class="n">drvr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">prot</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span>
				<span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_proto_cdc_dcmd</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">CDC_DCMD_ID</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prot</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span> <span class="o">!=</span> <span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">brcmf_proto_cdc_query_dcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_pub</span> <span class="o">*</span><span class="n">drvr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ifidx</span><span class="p">,</span> <span class="n">uint</span> <span class="n">cmd</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">uint</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_proto</span> <span class="o">*</span><span class="n">prot</span> <span class="o">=</span> <span class="n">drvr</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_proto_cdc_dcmd</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">prot</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">CTL</span><span class="p">,</span> <span class="s">&quot;cmd %d len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Respond &quot;bcmerror&quot; and &quot;bcmerrorstr&quot; with local cache */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">BRCMF_C_GET_VAR</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;bcmerrorstr&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;bcm_error&quot;</span><span class="p">,</span>
				<span class="n">BCME_STRLEN</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;bcmerror&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">=</span> <span class="n">drvr</span><span class="o">-&gt;</span><span class="n">dongle_error</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_proto_cdc_dcmd</span><span class="p">));</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">prot</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">&lt;&lt;</span> <span class="n">CDC_DCMD_ID_SHIFT</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CDC_DCMD_IF_MASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ifidx</span> <span class="o">&lt;&lt;</span> <span class="n">CDC_DCMD_IF_SHIFT</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">prot</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_proto_cdc_msg</span><span class="p">(</span><span class="n">drvr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;brcmf_proto_cdc_msg failed w/status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">retry:</span>
	<span class="cm">/* wait for interrupt and get first fragment */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_proto_cdc_cmplt</span><span class="p">(</span><span class="n">drvr</span><span class="p">,</span> <span class="n">prot</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CDC_DCMD_ID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CDC_DCMD_ID_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">prot</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">++</span><span class="n">retries</span> <span class="o">&lt;</span> <span class="n">RETRIES</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">prot</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;%s: unexpected request id %d (expected %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">brcmf_ifname</span><span class="p">(</span><span class="n">drvr</span><span class="p">,</span> <span class="n">ifidx</span><span class="p">),</span> <span class="n">id</span><span class="p">,</span> <span class="n">prot</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check info buffer */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* Copy info buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Check the ERROR flag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CDC_DCMD_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="cm">/* Cache error from dongle */</span>
		<span class="n">drvr</span><span class="o">-&gt;</span><span class="n">dongle_error</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcmf_proto_cdc_set_dcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_pub</span> <span class="o">*</span><span class="n">drvr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ifidx</span><span class="p">,</span> <span class="n">uint</span> <span class="n">cmd</span><span class="p">,</span>
				 <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">uint</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_proto</span> <span class="o">*</span><span class="n">prot</span> <span class="o">=</span> <span class="n">drvr</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_proto_cdc_dcmd</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">prot</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">CTL</span><span class="p">,</span> <span class="s">&quot;cmd %d len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_proto_cdc_dcmd</span><span class="p">));</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">prot</span><span class="o">-&gt;</span><span class="n">reqid</span> <span class="o">&lt;&lt;</span> <span class="n">CDC_DCMD_ID_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">CDC_DCMD_SET</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CDC_DCMD_IF_MASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ifidx</span> <span class="o">&lt;&lt;</span> <span class="n">CDC_DCMD_IF_SHIFT</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">prot</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_proto_cdc_msg</span><span class="p">(</span><span class="n">drvr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_proto_cdc_cmplt</span><span class="p">(</span><span class="n">drvr</span><span class="p">,</span> <span class="n">prot</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CDC_DCMD_ID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CDC_DCMD_ID_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">prot</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;%s: unexpected request id %d (expected %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">brcmf_ifname</span><span class="p">(</span><span class="n">drvr</span><span class="p">,</span> <span class="n">ifidx</span><span class="p">),</span> <span class="n">id</span><span class="p">,</span> <span class="n">prot</span><span class="o">-&gt;</span><span class="n">reqid</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check the ERROR flag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CDC_DCMD_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="cm">/* Cache error from dongle */</span>
		<span class="n">drvr</span><span class="o">-&gt;</span><span class="n">dongle_error</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">brcmf_proto_dcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_pub</span> <span class="o">*</span><span class="n">drvr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ifidx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcmf_dcmd</span> <span class="o">*</span><span class="n">dcmd</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_proto</span> <span class="o">*</span><span class="n">prot</span> <span class="o">=</span> <span class="n">drvr</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drvr</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BRCMF_BUS_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;bus is down. we have nothing to do.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drvr</span><span class="o">-&gt;</span><span class="n">proto_block</span><span class="p">);</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">BRCMF_DCMD_MAXLEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prot</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;CDC packet is pending!!!! cmd=0x%x (%lu) lastcmd=0x%x (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">prot</span><span class="o">-&gt;</span><span class="n">lastcmd</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">prot</span><span class="o">-&gt;</span><span class="n">lastcmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">BRCMF_C_SET_VAR</span> <span class="o">||</span>
		    <span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">BRCMF_C_GET_VAR</span><span class="p">)</span>
			<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;iovar cmd=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prot</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">prot</span><span class="o">-&gt;</span><span class="n">lastcmd</span> <span class="o">=</span> <span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_proto_cdc_set_dcmd</span><span class="p">(</span><span class="n">drvr</span><span class="p">,</span> <span class="n">ifidx</span><span class="p">,</span> <span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span>
						   <span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_proto_cdc_query_dcmd</span><span class="p">(</span><span class="n">drvr</span><span class="p">,</span> <span class="n">ifidx</span><span class="p">,</span> <span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span>
						     <span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">-</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_proto_cdc_dcmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">brcmf_proto_cdc_dcmd</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">prot</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">;</span>
		<span class="cm">/* len == needed when set/query fails from dongle */</span>
		<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">needed</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Intercept the wme_dp dongle cmd here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">BRCMF_C_SET_VAR</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;wme_dp&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">slen</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">slen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;wme_dp&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">slen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">slen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
		<span class="n">drvr</span><span class="o">-&gt;</span><span class="n">wme_dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">prot</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drvr</span><span class="o">-&gt;</span><span class="n">proto_block</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">pkt_sum_needed</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_set_sum_good</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">?</span> <span class="n">CHECKSUM_UNNECESSARY</span> <span class="o">:</span> <span class="n">CHECKSUM_NONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcmf_proto_hdrpush</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_pub</span> <span class="o">*</span><span class="n">drvr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ifidx</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pktbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_proto_bdc_header</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Push BDC header used to convey priority for buses that don&#39;t */</span>

	<span class="n">skb_push</span><span class="p">(</span><span class="n">pktbuf</span><span class="p">,</span> <span class="n">BDC_HEADER_LEN</span><span class="p">);</span>

	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_proto_bdc_header</span> <span class="o">*</span><span class="p">)(</span><span class="n">pktbuf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">h</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">BDC_PROTO_VER</span> <span class="o">&lt;&lt;</span> <span class="n">BDC_FLAG_VER_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_sum_needed</span><span class="p">(</span><span class="n">pktbuf</span><span class="p">))</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BDC_FLAG_SUM_NEEDED</span><span class="p">;</span>

	<span class="n">h</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="p">(</span><span class="n">pktbuf</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&amp;</span> <span class="n">BDC_PRIORITY_MASK</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">BDC_SET_IF_IDX</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">ifidx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcmf_proto_hdrpull</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ifidx</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pktbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_proto_bdc_header</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_bus</span> <span class="o">*</span><span class="n">bus_if</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_pub</span> <span class="o">*</span><span class="n">drvr</span> <span class="o">=</span> <span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">drvr</span><span class="p">;</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Pop BDC header used to convey priority for buses that don&#39;t */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pktbuf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">BDC_HEADER_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;rx data too short (%d &lt; %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pktbuf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">BDC_HEADER_LEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_proto_bdc_header</span> <span class="o">*</span><span class="p">)(</span><span class="n">pktbuf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ifidx</span> <span class="o">=</span> <span class="n">BDC_GET_IF_IDX</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ifidx</span> <span class="o">&gt;=</span> <span class="n">BRCMF_MAX_IFS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;rx data ifnum out of range (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ifidx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BDC_FLAG_VER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">BDC_FLAG_VER_SHIFT</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">BDC_PROTO_VER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;%s: non-BDC packet received, flags 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">brcmf_ifname</span><span class="p">(</span><span class="n">drvr</span><span class="p">,</span> <span class="o">*</span><span class="n">ifidx</span><span class="p">),</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BDC_FLAG_SUM_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="s">&quot;%s: BDC packet received with good rx-csum, flags 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">brcmf_ifname</span><span class="p">(</span><span class="n">drvr</span><span class="p">,</span> <span class="o">*</span><span class="n">ifidx</span><span class="p">),</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">pkt_set_sum_good</span><span class="p">(</span><span class="n">pktbuf</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pktbuf</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&amp;</span> <span class="n">BDC_PRIORITY_MASK</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">pktbuf</span><span class="p">,</span> <span class="n">BDC_HEADER_LEN</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">pktbuf</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcmf_proto_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_pub</span> <span class="o">*</span><span class="n">drvr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_proto</span> <span class="o">*</span><span class="n">cdc</span><span class="p">;</span>

	<span class="n">cdc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_proto</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* ensure that the msg buf directly follows the cdc msg struct */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">cdc</span><span class="o">-&gt;</span><span class="n">msg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cdc</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;struct brcmf_proto is not correctly defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drvr</span><span class="o">-&gt;</span><span class="n">prot</span> <span class="o">=</span> <span class="n">cdc</span><span class="p">;</span>
	<span class="n">drvr</span><span class="o">-&gt;</span><span class="n">hdrlen</span> <span class="o">+=</span> <span class="n">BDC_HEADER_LEN</span><span class="p">;</span>
	<span class="n">drvr</span><span class="o">-&gt;</span><span class="n">bus_if</span><span class="o">-&gt;</span><span class="n">maxctl</span> <span class="o">=</span> <span class="n">BRCMF_DCMD_MAXLEN</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_proto_cdc_dcmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">ROUND_UP_MARGIN</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cdc</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ~NOTE~ What if another thread is waiting on the semaphore?  Holding it? */</span>
<span class="kt">void</span> <span class="nf">brcmf_proto_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_pub</span> <span class="o">*</span><span class="n">drvr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">drvr</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">);</span>
	<span class="n">drvr</span><span class="o">-&gt;</span><span class="n">prot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcmf_proto_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_pub</span> <span class="o">*</span><span class="n">drvr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

	<span class="n">brcmf_dbg</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drvr</span><span class="o">-&gt;</span><span class="n">proto_block</span><span class="p">);</span>

	<span class="cm">/* Get the device MAC address */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;cur_etheraddr&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_proto_cdc_query_dcmd</span><span class="p">(</span><span class="n">drvr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BRCMF_C_GET_VAR</span><span class="p">,</span>
					  <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drvr</span><span class="o">-&gt;</span><span class="n">proto_block</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">drvr</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drvr</span><span class="o">-&gt;</span><span class="n">proto_block</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">brcmf_c_preinit_dcmds</span><span class="p">(</span><span class="n">drvr</span><span class="p">);</span>

	<span class="cm">/* Always assumes wl for now */</span>
	<span class="n">drvr</span><span class="o">-&gt;</span><span class="n">iswl</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcmf_proto_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_pub</span> <span class="o">*</span><span class="n">drvr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing to do for CDC */</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
