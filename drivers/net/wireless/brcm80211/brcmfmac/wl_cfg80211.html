<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › brcm80211 › brcmfmac › wl_cfg80211.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>wl_cfg80211.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY</span>
<span class="cm"> * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION</span>
<span class="cm"> * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cm">/* Toplevel file. Relies on dhd_linux.c to send commands to the dongle. */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>

<span class="cp">#include &lt;brcmu_utils.h&gt;</span>
<span class="cp">#include &lt;defs.h&gt;</span>
<span class="cp">#include &lt;brcmu_wifi.h&gt;</span>
<span class="cp">#include &quot;dhd.h&quot;</span>
<span class="cp">#include &quot;wl_cfg80211.h&quot;</span>

<span class="cp">#define BRCMF_ASSOC_PARAMS_FIXED_SIZE \</span>
<span class="cp">	(sizeof(struct brcmf_assoc_params_le) - sizeof(u16))</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ether_bcast</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">brcmf_dbg_level</span> <span class="o">=</span> <span class="n">WL_DBG_ERR</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_set_drvdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">brcmf_get_drvdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="nf">brcmf_priv_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_dev</span> <span class="o">*</span><span class="n">cfg_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_iface</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">brcmf_get_drvdata</span><span class="p">(</span><span class="n">cfg_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">cfg_priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">check_sys_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;device is not ready : status (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CHAN2G(_channel, _freq, _flags) {			\</span>
<span class="cp">	.band			= IEEE80211_BAND_2GHZ,		\</span>
<span class="cp">	.center_freq		= (_freq),			\</span>
<span class="cp">	.hw_value		= (_channel),			\</span>
<span class="cp">	.flags			= (_flags),			\</span>
<span class="cp">	.max_antenna_gain	= 0,				\</span>
<span class="cp">	.max_power		= 30,				\</span>
<span class="cp">}</span>

<span class="cp">#define CHAN5G(_channel, _flags) {				\</span>
<span class="cp">	.band			= IEEE80211_BAND_5GHZ,		\</span>
<span class="cp">	.center_freq		= 5000 + (5 * (_channel)),	\</span>
<span class="cp">	.hw_value		= (_channel),			\</span>
<span class="cp">	.flags			= (_flags),			\</span>
<span class="cp">	.max_antenna_gain	= 0,				\</span>
<span class="cp">	.max_power		= 30,				\</span>
<span class="cp">}</span>

<span class="cp">#define RATE_TO_BASE100KBPS(rate)   (((rate) * 10) / 2)</span>
<span class="cp">#define RATETAB_ENT(_rateid, _flags) \</span>
<span class="cp">	{                                                               \</span>
<span class="cp">		.bitrate        = RATE_TO_BASE100KBPS(_rateid),     \</span>
<span class="cp">		.hw_value       = (_rateid),                            \</span>
<span class="cp">		.flags          = (_flags),                             \</span>
<span class="cp">	}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">__wl_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">BRCM_RATE_1M</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">BRCM_RATE_2M</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">BRCM_RATE_5M5</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">BRCM_RATE_11M</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">BRCM_RATE_6M</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">BRCM_RATE_9M</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">BRCM_RATE_12M</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">BRCM_RATE_18M</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">BRCM_RATE_24M</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">BRCM_RATE_36M</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">BRCM_RATE_48M</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">BRCM_RATE_54M</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define wl_a_rates		(__wl_rates + 4)</span>
<span class="cp">#define wl_a_rates_size	8</span>
<span class="cp">#define wl_g_rates		(__wl_rates + 0)</span>
<span class="cp">#define wl_g_rates_size	12</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">__wl_2ghz_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2412</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2417</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2422</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2427</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2432</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2437</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2442</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2447</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2452</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2457</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">2462</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">2467</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">2472</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">2484</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">__wl_5ghz_a_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">44</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">46</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">56</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">104</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">108</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">112</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">116</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">124</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">136</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">149</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">153</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">157</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">161</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">165</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">184</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">188</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">196</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">208</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">212</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">216</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">__wl_5ghz_n_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">44</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">46</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">54</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">56</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">58</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">62</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">68</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">72</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">76</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">78</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">82</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">86</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">88</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">92</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">94</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">98</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">102</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">104</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">106</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">108</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">112</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">114</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">116</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">118</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">124</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">126</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">130</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">134</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">136</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">138</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">142</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">144</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">145</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">146</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">147</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">148</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">149</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">151</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">152</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">153</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">154</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">155</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">156</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">157</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">158</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">159</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">161</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">162</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">163</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">164</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">165</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">166</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">168</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">172</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">174</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">176</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">178</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">182</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">184</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">186</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">188</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">194</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">196</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">198</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">202</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">206</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">208</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">210</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">212</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">214</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">216</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">218</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">222</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CHAN5G</span><span class="p">(</span><span class="mi">228</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">__wl_band_2ghz</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">__wl_2ghz_channels</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">__wl_2ghz_channels</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">wl_g_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">wl_g_rates_size</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">__wl_band_5ghz_a</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">__wl_5ghz_a_channels</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">__wl_5ghz_a_channels</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">wl_a_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">wl_a_rates_size</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">__wl_band_5ghz_n</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">__wl_5ghz_n_channels</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">__wl_5ghz_n_channels</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">wl_a_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">wl_a_rates_size</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">__wl_cipher_suites</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">WLAN_CIPHER_SUITE_WEP40</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_CCMP</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_AES_CMAC</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* tag_ID/length/value_buffer tuple */</span>
<span class="k">struct</span> <span class="n">brcmf_tlv</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Quarter dBm units to mW</span>
<span class="cm"> * Table starts at QDBM_OFFSET, so the first entry is mW for qdBm=153</span>
<span class="cm"> * Table is offset so the last entry is largest mW value that fits in</span>
<span class="cm"> * a u16.</span>
<span class="cm"> */</span>

<span class="cp">#define QDBM_OFFSET 153		</span><span class="cm">/* Offset for first entry */</span><span class="cp"></span>
<span class="cp">#define QDBM_TABLE_LEN 40	</span><span class="cm">/* Table size */</span><span class="cp"></span>

<span class="cm">/* Smallest mW value that will round up to the first table entry, QDBM_OFFSET.</span>
<span class="cm"> * Value is ( mW(QDBM_OFFSET - 1) + mW(QDBM_OFFSET) ) / 2</span>
<span class="cm"> */</span>
<span class="cp">#define QDBM_TABLE_LOW_BOUND 6493	</span><span class="cm">/* Low bound */</span><span class="cp"></span>

<span class="cm">/* Largest mW value that will round down to the last table entry,</span>
<span class="cm"> * QDBM_OFFSET + QDBM_TABLE_LEN-1.</span>
<span class="cm"> * Value is ( mW(QDBM_OFFSET + QDBM_TABLE_LEN - 1) +</span>
<span class="cm"> * mW(QDBM_OFFSET + QDBM_TABLE_LEN) ) / 2.</span>
<span class="cm"> */</span>
<span class="cp">#define QDBM_TABLE_HIGH_BOUND 64938	</span><span class="cm">/* High bound */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">nqdBm_to_mW_map</span><span class="p">[</span><span class="n">QDBM_TABLE_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* qdBm:	+0	+1	+2	+3	+4	+5	+6	+7 */</span>
<span class="cm">/* 153: */</span> <span class="mi">6683</span><span class="p">,</span> <span class="mi">7079</span><span class="p">,</span> <span class="mi">7499</span><span class="p">,</span> <span class="mi">7943</span><span class="p">,</span> <span class="mi">8414</span><span class="p">,</span> <span class="mi">8913</span><span class="p">,</span> <span class="mi">9441</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span>
<span class="cm">/* 161: */</span> <span class="mi">10593</span><span class="p">,</span> <span class="mi">11220</span><span class="p">,</span> <span class="mi">11885</span><span class="p">,</span> <span class="mi">12589</span><span class="p">,</span> <span class="mi">13335</span><span class="p">,</span> <span class="mi">14125</span><span class="p">,</span> <span class="mi">14962</span><span class="p">,</span> <span class="mi">15849</span><span class="p">,</span>
<span class="cm">/* 169: */</span> <span class="mi">16788</span><span class="p">,</span> <span class="mi">17783</span><span class="p">,</span> <span class="mi">18836</span><span class="p">,</span> <span class="mi">19953</span><span class="p">,</span> <span class="mi">21135</span><span class="p">,</span> <span class="mi">22387</span><span class="p">,</span> <span class="mi">23714</span><span class="p">,</span> <span class="mi">25119</span><span class="p">,</span>
<span class="cm">/* 177: */</span> <span class="mi">26607</span><span class="p">,</span> <span class="mi">28184</span><span class="p">,</span> <span class="mi">29854</span><span class="p">,</span> <span class="mi">31623</span><span class="p">,</span> <span class="mi">33497</span><span class="p">,</span> <span class="mi">35481</span><span class="p">,</span> <span class="mi">37584</span><span class="p">,</span> <span class="mi">39811</span><span class="p">,</span>
<span class="cm">/* 185: */</span> <span class="mi">42170</span><span class="p">,</span> <span class="mi">44668</span><span class="p">,</span> <span class="mi">47315</span><span class="p">,</span> <span class="mi">50119</span><span class="p">,</span> <span class="mi">53088</span><span class="p">,</span> <span class="mi">56234</span><span class="p">,</span> <span class="mi">59566</span><span class="p">,</span> <span class="mi">63096</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">brcmf_qdbm_to_mw</span><span class="p">(</span><span class="n">u8</span> <span class="n">qdbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">qdbm</span> <span class="o">-</span> <span class="n">QDBM_OFFSET</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">QDBM_TABLE_LEN</span><span class="p">)</span>
		<span class="cm">/* clamp to max u16 mW value */</span>
		<span class="k">return</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="cm">/* scale the qdBm index up to the range of the table 0-40</span>
<span class="cm">	 * where an offset of 40 qdBm equals a factor of 10 mW.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">+=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="n">factor</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* return the mW value scaled down to the correct factor of 10,</span>
<span class="cm">	 * adding in factor/2 to get proper rounding.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">nqdBm_to_mW_map</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">brcmf_mw_to_qdbm</span><span class="p">(</span><span class="n">u16</span> <span class="n">mw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">qdbm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">mw_uint</span> <span class="o">=</span> <span class="n">mw</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">boundary</span><span class="p">;</span>

	<span class="cm">/* handle boundary case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mw_uint</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">QDBM_OFFSET</span><span class="p">;</span>

	<span class="cm">/* move mw into the range of the table */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mw_uint</span> <span class="o">&lt;</span> <span class="n">QDBM_TABLE_LOW_BOUND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mw_uint</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="mi">40</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">qdbm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qdbm</span> <span class="o">&lt;</span> <span class="n">QDBM_TABLE_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">qdbm</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">boundary</span> <span class="o">=</span> <span class="n">nqdBm_to_mW_map</span><span class="p">[</span><span class="n">qdbm</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">nqdBm_to_mW_map</span><span class="p">[</span><span class="n">qdbm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
						    <span class="n">nqdBm_to_mW_map</span><span class="p">[</span><span class="n">qdbm</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mw_uint</span> <span class="o">&lt;</span> <span class="n">boundary</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qdbm</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">qdbm</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* function for reading/writing a single u32 from/to the dongle */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">par_le</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">par</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par_le</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le32</span><span class="p">));</span>
	<span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">par_le</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">convert_key_from_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_wsec_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">brcmf_wsec_key_le</span> <span class="o">*</span><span class="n">key_le</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">key_le</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">key_le</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">key_le</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">);</span>
	<span class="n">key_le</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">key_le</span><span class="o">-&gt;</span><span class="n">rxiv</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">rxiv</span><span class="p">.</span><span class="n">hi</span><span class="p">);</span>
	<span class="n">key_le</span><span class="o">-&gt;</span><span class="n">rxiv</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">rxiv</span><span class="p">.</span><span class="n">lo</span><span class="p">);</span>
	<span class="n">key_le</span><span class="o">-&gt;</span><span class="n">iv_initialized</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">iv_initialized</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key_le</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key_le</span><span class="o">-&gt;</span><span class="n">ea</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">ea</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">ea</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_key_to_dongle</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">brcmf_wsec_key</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_wsec_key_le</span> <span class="n">key_le</span><span class="p">;</span>

	<span class="n">convert_key_from_CPU</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key_le</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key_le</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key_le</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_KEY error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_change_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">vif_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">infra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MONITOR</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_WDS</span>:
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;type (%d) : currently we do not support this type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WL_MODE_IBSS</span><span class="p">;</span>
		<span class="n">infra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WL_MODE_BSS</span><span class="p">;</span>
		<span class="n">infra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_INFRA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">infra</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_INFRA error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wdev</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;IF Type = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL_MODE_IBSS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Adhoc&quot;</span> <span class="o">:</span> <span class="s">&quot;Infra&quot;</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_dev_intvar_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">s32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">buf</span><span class="p">[</span><span class="n">BRCMF_DCMD_SMLEN</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">val_le</span><span class="p">;</span>

	<span class="n">val_le</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">brcmf_c_mkiovar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">val_le</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val_le</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_VAR</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_dev_intvar_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">retval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">s8</span> <span class="n">buf</span><span class="p">[</span><span class="n">BRCMF_DCMD_SMLEN</span><span class="p">];</span>
		<span class="n">__le32</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">var</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_null</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span>
	    <span class="n">brcmf_c_mkiovar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">data_null</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">),</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">var</span><span class="p">.</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_GET_VAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="o">*</span><span class="n">retval</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">var</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_set_mpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">ndev_to_cfg</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;mpc&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;fail to set mpc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;MPC : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl_iscan_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_scan_params_le</span> <span class="o">*</span><span class="n">params_le</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">brcmf_ssid</span> <span class="o">*</span><span class="n">ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">params_le</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ether_bcast</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">params_le</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">=</span> <span class="n">DOT11_BSSTYPE_ANY</span><span class="p">;</span>
	<span class="n">params_le</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">params_le</span><span class="o">-&gt;</span><span class="n">channel_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">params_le</span><span class="o">-&gt;</span><span class="n">nprobes</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">params_le</span><span class="o">-&gt;</span><span class="n">active_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">params_le</span><span class="o">-&gt;</span><span class="n">passive_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">params_le</span><span class="o">-&gt;</span><span class="n">home_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssid</span> <span class="o">&amp;&amp;</span> <span class="n">ssid</span><span class="o">-&gt;</span><span class="n">SSID_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params_le</span><span class="o">-&gt;</span><span class="n">ssid_le</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_ssid</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_dev_iovar_setbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span> <span class="n">iovar</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
		    <span class="n">s32</span> <span class="n">paramlen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bufptr</span><span class="p">,</span> <span class="n">s32</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">iolen</span><span class="p">;</span>

	<span class="n">iolen</span> <span class="o">=</span> <span class="n">brcmf_c_mkiovar</span><span class="p">(</span><span class="n">iovar</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">paramlen</span><span class="p">,</span> <span class="n">bufptr</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">iolen</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_VAR</span><span class="p">,</span> <span class="n">bufptr</span><span class="p">,</span> <span class="n">iolen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_dev_iovar_getbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span> <span class="n">iovar</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
		    <span class="n">s32</span> <span class="n">paramlen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bufptr</span><span class="p">,</span> <span class="n">s32</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">iolen</span><span class="p">;</span>

	<span class="n">iolen</span> <span class="o">=</span> <span class="n">brcmf_c_mkiovar</span><span class="p">(</span><span class="n">iovar</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">paramlen</span><span class="p">,</span> <span class="n">bufptr</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">iolen</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_GET_VAR</span><span class="p">,</span> <span class="n">bufptr</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_run_iscan</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">brcmf_ssid</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">params_size</span> <span class="o">=</span> <span class="n">BRCMF_SCAN_PARAMS_FIXED_SIZE</span> <span class="o">+</span>
			  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_iscan_params_le</span><span class="p">,</span> <span class="n">params_le</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_iscan_params_le</span> <span class="o">*</span><span class="n">params</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssid</span> <span class="o">&amp;&amp;</span> <span class="n">ssid</span><span class="o">-&gt;</span><span class="n">SSID_len</span><span class="p">)</span>
		<span class="n">params_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_ssid</span><span class="p">);</span>
	<span class="n">params</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">params_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">params</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">params_size</span> <span class="o">&gt;=</span> <span class="n">BRCMF_DCMD_SMLEN</span><span class="p">);</span>

	<span class="n">wl_iscan_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">params_le</span><span class="p">,</span> <span class="n">ssid</span><span class="p">);</span>

	<span class="n">params</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BRCMF_ISCAN_REQ_VERSION</span><span class="p">);</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">scan_duration</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_iovar_setbuf</span><span class="p">(</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;iscan&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">params_size</span><span class="p">,</span>
				     <span class="n">iscan</span><span class="o">-&gt;</span><span class="n">dcmd_buf</span><span class="p">,</span> <span class="n">BRCMF_DCMD_SMLEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
			<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;system busy : iscan canceled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_do_iscan</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span> <span class="o">=</span> <span class="n">cfg_to_iscan</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_ssid</span> <span class="n">ssid</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">passive_scan</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Broadcast scan by default */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">));</span>

	<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL_ISCAN_STATE_SCANING</span><span class="p">;</span>

	<span class="n">passive_scan</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">active_scan</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">),</span> <span class="n">BRCMF_C_SET_PASSIVE_SCAN</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">passive_scan</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">passive_scan</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">brcmf_set_mpc</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan_kickstart</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_run_iscan</span><span class="p">(</span><span class="n">iscan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">BRCMF_SCAN_ACTION_START</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcmf_set_mpc</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan_kickstart</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer_ms</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">__brcmf_cfg80211_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">cfg80211_ssid</span> <span class="o">*</span><span class="n">this_ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">ndev_to_cfg</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cfg80211_ssid</span> <span class="o">*</span><span class="n">ssids</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_scan_req</span> <span class="o">*</span><span class="n">sr</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_req_int</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">passive_scan</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">iscan_req</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">spec_scan</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">SSID_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Scanning already : status (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_SCAN_ABORTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Scanning being aborted : status (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Connecting : status (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iscan_req</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">spec_scan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* scan bss */</span>
		<span class="n">ssids</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan_on</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ssids</span> <span class="o">||</span> <span class="o">!</span><span class="n">ssids</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">))</span>
			<span class="n">iscan_req</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* scan in ibss */</span>
		<span class="cm">/* we don&#39;t do iscan in ibss */</span>
		<span class="n">ssids</span> <span class="o">=</span> <span class="n">this_ssid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WL_STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iscan_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_do_iscan</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">scan_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WL_SCAN</span><span class="p">(</span><span class="s">&quot;ssid </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, ssid_len (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ssids</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssids</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">ssid_le</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">ssid_le</span><span class="p">));</span>
		<span class="n">SSID_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">ssid_le</span><span class="p">.</span><span class="n">SSID</span><span class="p">),</span> <span class="n">ssids</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
		<span class="n">sr</span><span class="o">-&gt;</span><span class="n">ssid_le</span><span class="p">.</span><span class="n">SSID_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SSID_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">ssid_le</span><span class="p">.</span><span class="n">SSID</span><span class="p">,</span> <span class="n">ssids</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">SSID_len</span><span class="p">);</span>
			<span class="n">sr</span><span class="o">-&gt;</span><span class="n">ssid_le</span><span class="p">.</span><span class="n">SSID_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SSID_len</span><span class="p">);</span>
			<span class="n">spec_scan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">WL_SCAN</span><span class="p">(</span><span class="s">&quot;Broadcast scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">passive_scan</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">active_scan</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_PASSIVE_SCAN</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">passive_scan</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">passive_scan</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_PASSIVE_SCAN error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">scan_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">brcmf_set_mpc</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">ssid_le</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">ssid_le</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
				<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;system busy : scan for </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> &quot;</span>
					<span class="s">&quot;canceled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">ssid_le</span><span class="p">.</span><span class="n">SSID</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SCAN error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

			<span class="n">brcmf_set_mpc</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">scan_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">scan_out:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__brcmf_cfg80211_scan</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;scan error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_set_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rts_threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;rtsthresh&quot;</span><span class="p">,</span> <span class="n">rts_threshold</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_set_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">frag_threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;fragthresh&quot;</span><span class="p">,</span> <span class="n">frag_threshold</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_set_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">retry</span><span class="p">,</span> <span class="n">bool</span> <span class="n">l</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">?</span> <span class="n">BRCM_SET_LRL</span> <span class="o">:</span> <span class="n">BRCM_SET_SRL</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;cmd (%d) , error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_cfg80211_set_wiphy_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_RTS_THRESHOLD</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">!=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_set_rts</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_FRAG_THRESHOLD</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">frag_threshold</span> <span class="o">!=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">frag_threshold</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_set_frag</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_RETRY_LONG</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_long</span> <span class="o">!=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">retry_long</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_long</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">retry_long</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_set_retry</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_long</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_RETRY_SHORT</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_short</span> <span class="o">!=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">retry_short</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_short</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">retry_short</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_set_retry</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_short</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">brcmf_read_prof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">s32</span> <span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WL_PROF_SEC</span>:
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL_PROF_BSSID</span>:
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL_PROF_SSID</span>:
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;invalid item (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_update_prof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span>
		  <span class="k">const</span> <span class="k">struct</span> <span class="n">brcmf_event_msg</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">s32</span> <span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_ssid</span> <span class="o">*</span><span class="n">ssid</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WL_PROF_SSID</span>:
		<span class="n">ssid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_ssid</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">SSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">SSID</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">SSID</span><span class="p">,</span>
		       <span class="n">ssid</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">,</span> <span class="n">ssid</span><span class="o">-&gt;</span><span class="n">SSID_len</span><span class="p">);</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">SSID_len</span> <span class="o">=</span> <span class="n">ssid</span><span class="o">-&gt;</span><span class="n">SSID_len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL_PROF_BSSID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL_PROF_SEC</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL_PROF_BEACONINT</span>:
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL_PROF_DTIMPERIOD</span>:
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;unsupported item (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_init_prof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_profile</span> <span class="o">*</span><span class="n">prof</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">prof</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_ch_to_chanspec</span><span class="p">(</span><span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcmf_join_params</span> <span class="o">*</span><span class="n">join_params</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="o">*</span><span class="n">join_params_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">chanspec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;=</span> <span class="n">CH_MAX_2G_CHANNEL</span><span class="p">)</span>
			<span class="n">chanspec</span> <span class="o">|=</span> <span class="n">WL_CHANSPEC_BAND_2G</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">chanspec</span> <span class="o">|=</span> <span class="n">WL_CHANSPEC_BAND_5G</span><span class="p">;</span>

		<span class="n">chanspec</span> <span class="o">|=</span> <span class="n">WL_CHANSPEC_BW_20</span><span class="p">;</span>
		<span class="n">chanspec</span> <span class="o">|=</span> <span class="n">WL_CHANSPEC_CTL_SB_NONE</span><span class="p">;</span>

		<span class="o">*</span><span class="n">join_params_size</span> <span class="o">+=</span> <span class="n">BRCMF_ASSOC_PARAMS_FIXED_SIZE</span> <span class="o">+</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

		<span class="n">chanspec</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="n">WL_CHANSPEC_CHAN_MASK</span><span class="p">);</span>
		<span class="n">join_params</span><span class="o">-&gt;</span><span class="n">params_le</span><span class="p">.</span><span class="n">chanspec_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chanspec</span><span class="p">);</span>
		<span class="n">join_params</span><span class="o">-&gt;</span><span class="n">params_le</span><span class="p">.</span><span class="n">chanspec_num</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;join_params-&gt;params.chanspec_list[0]= %#X,&quot;</span>
			<span class="s">&quot;channel %d, chanspec %#X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chanspec</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_link_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndev</span> <span class="o">=</span> <span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
		<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;Call WLC_DISASSOC to stop excess roaming</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_DISASSOC</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_DISASSOC failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_join_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">cfg80211_ibss_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_join_params</span> <span class="n">join_params</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">join_params_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">wsec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">bcnprd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_ssid</span> <span class="n">ssid</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">)</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;SSID: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;SSID: NULL, Not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;BSSID: %02X %02X %02X %02X %02X %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;No BSSID specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;channel: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;no channel specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">channel_fixed</span><span class="p">)</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;fixed channel required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;no fixed channel required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">ie</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">)</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;ie len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;no ie specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">)</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;beacon interval: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;no beacon interval specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">)</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;basic rates: %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;no basic rates specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">)</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;privacy required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;no privacy required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Configure Privacy for starter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">)</span>
		<span class="n">wsec</span> <span class="o">|=</span> <span class="n">WEP_ENABLED</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;wsec&quot;</span><span class="p">,</span> <span class="n">wsec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;wsec failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure Beacon Interval for starter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">)</span>
		<span class="n">bcnprd</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bcnprd</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCM_SET_BCNPRD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcnprd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_BCNPRD failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure required join parameter */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">join_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_join_params</span><span class="p">));</span>

	<span class="cm">/* SSID */</span>
	<span class="n">ssid</span><span class="p">.</span><span class="n">SSID_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">SSID</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">.</span><span class="n">SSID_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">join_params</span><span class="p">.</span><span class="n">ssid_le</span><span class="p">.</span><span class="n">SSID</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">.</span><span class="n">SSID_len</span><span class="p">);</span>
	<span class="n">join_params</span><span class="p">.</span><span class="n">ssid_le</span><span class="p">.</span><span class="n">SSID_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">SSID_len</span><span class="p">);</span>
	<span class="n">join_params_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">join_params</span><span class="p">.</span><span class="n">ssid_le</span><span class="p">);</span>
	<span class="n">brcmf_update_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">WL_PROF_SSID</span><span class="p">);</span>

	<span class="cm">/* BSSID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">join_params</span><span class="p">.</span><span class="n">params_le</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">join_params_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">join_params</span><span class="p">.</span><span class="n">ssid_le</span><span class="p">)</span> <span class="o">+</span>
				   <span class="n">BRCMF_ASSOC_PARAMS_FIXED_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">join_params</span><span class="p">.</span><span class="n">params_le</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ether_bcast</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">brcmf_update_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">join_params</span><span class="p">.</span><span class="n">params_le</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">WL_PROF_BSSID</span><span class="p">);</span>

	<span class="cm">/* Channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">target_channel</span><span class="p">;</span>

		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span>
			<span class="n">ieee80211_frequency_to_channel</span><span class="p">(</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">channel_fixed</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* adding chanspec */</span>
			<span class="n">brcmf_ch_to_chanspec</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">join_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">join_params_size</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* set channel for starter */</span>
		<span class="n">target_channel</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCM_SET_CHANNEL</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">target_channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_CHANNEL failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">ibss_starter</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>


	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_SSID</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">join_params</span><span class="p">,</span> <span class="n">join_params_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_SSID failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_leave_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">brcmf_link_down</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_set_wpa_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="o">*</span><span class="n">sme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">ndev_to_cfg</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_security</span> <span class="o">*</span><span class="n">sec</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">wpa_versions</span> <span class="o">&amp;</span> <span class="n">NL80211_WPA_VERSION_1</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">WPA_AUTH_PSK</span> <span class="o">|</span> <span class="n">WPA_AUTH_UNSPECIFIED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">wpa_versions</span> <span class="o">&amp;</span> <span class="n">NL80211_WPA_VERSION_2</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">WPA2_AUTH_PSK</span> <span class="o">|</span> <span class="n">WPA2_AUTH_UNSPECIFIED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">WPA_AUTH_DISABLED</span><span class="p">;</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;setting wpa_auth to 0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;wpa_auth&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;set wpa_auth failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sec</span> <span class="o">=</span> <span class="n">brcmf_read_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">WL_PROF_SEC</span><span class="p">);</span>
	<span class="n">sec</span><span class="o">-&gt;</span><span class="n">wpa_versions</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">wpa_versions</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_set_auth_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="o">*</span><span class="n">sme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">ndev_to_cfg</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_security</span> <span class="o">*</span><span class="n">sec</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_AUTHTYPE_OPEN_SYSTEM</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;open system</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_AUTHTYPE_SHARED_KEY</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;shared key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_AUTHTYPE_AUTOMATIC</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;automatic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_AUTHTYPE_NETWORK_EAP</span>:
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;network eap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;invalid auth type (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;auth&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;set auth failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sec</span> <span class="o">=</span> <span class="n">brcmf_read_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">WL_PROF_SEC</span><span class="p">);</span>
	<span class="n">sec</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_set_set_cipher</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="o">*</span><span class="n">sme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">ndev_to_cfg</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_security</span> <span class="o">*</span><span class="n">sec</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">pval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">gval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">n_ciphers_pairwise</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">ciphers_pairwise</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
			<span class="n">pval</span> <span class="o">=</span> <span class="n">WEP_ENABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
			<span class="n">pval</span> <span class="o">=</span> <span class="n">TKIP_ENABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
			<span class="n">pval</span> <span class="o">=</span> <span class="n">AES_ENABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_AES_CMAC</span>:
			<span class="n">pval</span> <span class="o">=</span> <span class="n">AES_ENABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;invalid cipher pairwise (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">ciphers_pairwise</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
			<span class="n">gval</span> <span class="o">=</span> <span class="n">WEP_ENABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
			<span class="n">gval</span> <span class="o">=</span> <span class="n">TKIP_ENABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
			<span class="n">gval</span> <span class="o">=</span> <span class="n">AES_ENABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_AES_CMAC</span>:
			<span class="n">gval</span> <span class="o">=</span> <span class="n">AES_ENABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;invalid cipher group (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;pval (%d) gval (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span> <span class="n">gval</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;wsec&quot;</span><span class="p">,</span> <span class="n">pval</span> <span class="o">|</span> <span class="n">gval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sec</span> <span class="o">=</span> <span class="n">brcmf_read_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">WL_PROF_SEC</span><span class="p">);</span>
	<span class="n">sec</span><span class="o">-&gt;</span><span class="n">cipher_pairwise</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">ciphers_pairwise</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">sec</span><span class="o">-&gt;</span><span class="n">cipher_group</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_set_key_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="o">*</span><span class="n">sme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">ndev_to_cfg</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_security</span> <span class="o">*</span><span class="n">sec</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">n_akm_suites</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_get</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;wpa_auth&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;could not get wpa_auth (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WPA_AUTH_PSK</span> <span class="o">|</span> <span class="n">WPA_AUTH_UNSPECIFIED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">akm_suites</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">WLAN_AKM_SUITE_8021X</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">WPA_AUTH_UNSPECIFIED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">WLAN_AKM_SUITE_PSK</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">WPA_AUTH_PSK</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;invalid cipher group (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WPA2_AUTH_PSK</span> <span class="o">|</span> <span class="n">WPA2_AUTH_UNSPECIFIED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">akm_suites</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">WLAN_AKM_SUITE_8021X</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">WPA2_AUTH_UNSPECIFIED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">WLAN_AKM_SUITE_PSK</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">WPA2_AUTH_PSK</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;invalid cipher group (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;setting wpa_auth to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;wpa_auth&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;could not set wpa_auth (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sec</span> <span class="o">=</span> <span class="n">brcmf_read_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">WL_PROF_SEC</span><span class="p">);</span>
	<span class="n">sec</span><span class="o">-&gt;</span><span class="n">wpa_auth</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">akm_suites</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_set_wep_sharedkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="o">*</span><span class="n">sme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">ndev_to_cfg</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_security</span> <span class="o">*</span><span class="n">sec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_wsec_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;key len (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sec</span> <span class="o">=</span> <span class="n">brcmf_read_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">WL_PROF_SEC</span><span class="p">);</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;wpa_versions 0x%x cipher_pairwise 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">wpa_versions</span><span class="p">,</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">cipher_pairwise</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">wpa_versions</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NL80211_WPA_VERSION_1</span> <span class="o">|</span> <span class="n">NL80211_WPA_VERSION_2</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">cipher_pairwise</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">WLAN_CIPHER_SUITE_WEP40</span> <span class="o">|</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
		<span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
		<span class="n">key</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Too long key length (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">key</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">BRCMF_PRIMARY_KEY</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">cipher_pairwise</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
			<span class="n">key</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">CRYPTO_ALGO_WEP1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
			<span class="n">key</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">CRYPTO_ALGO_WEP128</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Invalid algorithm (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">ciphers_pairwise</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Set the new key/index */</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;key length (%d) key index (%d) algo (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">algo</span><span class="p">);</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;key </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">send_key_to_dongle</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">==</span> <span class="n">NL80211_AUTHTYPE_OPEN_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;set auth_type to shared key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* shared key */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;auth&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;set auth failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="o">*</span><span class="n">sme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_join_params</span> <span class="n">join_params</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">join_params_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_ssid</span> <span class="n">ssid</span><span class="p">;</span>

	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Invalid ssid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span>
			<span class="n">ieee80211_frequency_to_channel</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;channel (%d), center_req (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;ie (%p), ie_len (%zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_set_wpa_version</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">sme</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;wl_set_wpa_version failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_set_auth_type</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">sme</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;wl_set_auth_type failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_set_set_cipher</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">sme</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;wl_set_set_cipher failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_set_key_mgmt</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">sme</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;wl_set_key_mgmt failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_set_wep_sharedkey</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">sme</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;brcmf_set_wep_sharedkey failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">join_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">join_params</span><span class="p">));</span>
	<span class="n">join_params_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">join_params</span><span class="p">.</span><span class="n">ssid_le</span><span class="p">);</span>

	<span class="n">ssid</span><span class="p">.</span><span class="n">SSID_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">SSID</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">join_params</span><span class="p">.</span><span class="n">ssid_le</span><span class="p">.</span><span class="n">SSID</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">.</span><span class="n">SSID_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssid</span><span class="p">.</span><span class="n">SSID</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">.</span><span class="n">SSID_len</span><span class="p">);</span>
	<span class="n">join_params</span><span class="p">.</span><span class="n">ssid_le</span><span class="p">.</span><span class="n">SSID_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">SSID_len</span><span class="p">);</span>
	<span class="n">brcmf_update_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">WL_PROF_SSID</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">join_params</span><span class="p">.</span><span class="n">params_le</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ether_bcast</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">SSID_len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_MAX_SSID_LEN</span><span class="p">)</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;ssid </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, len (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ssid</span><span class="p">.</span><span class="n">SSID</span><span class="p">,</span> <span class="n">ssid</span><span class="p">.</span><span class="n">SSID_len</span><span class="p">);</span>

	<span class="n">brcmf_ch_to_chanspec</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">join_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">join_params_size</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_SSID</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">join_params</span><span class="p">,</span> <span class="n">join_params_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_SSID failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">reason_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_scb_val_le</span> <span class="n">scbval</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter. Reason code = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scbval</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">brcmf_read_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">WL_PROF_BSSID</span><span class="p">),</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">scbval</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">reason_code</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_DISASSOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scbval</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_scb_val_le</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_set_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">nl80211_tx_power_setting</span> <span class="n">type</span><span class="p">,</span> <span class="n">s32</span> <span class="n">mbm</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">txpwrmw</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">dbm</span> <span class="o">=</span> <span class="n">MBM_TO_DBM</span><span class="p">(</span><span class="n">mbm</span><span class="p">);</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_TX_POWER_AUTOMATIC</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_TX_POWER_LIMITED</span>:
	<span class="k">case</span> <span class="n">NL80211_TX_POWER_FIXED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dbm</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;TX_POWER_FIXED - dbm is negative</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Make sure radio is off or on as far as software is concerned */</span>
	<span class="n">disable</span> <span class="o">=</span> <span class="n">WL_RADIO_SW_DISABLE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_RADIO error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dbm</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="n">txpwrmw</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">txpwrmw</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">dbm</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;qtxpower&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="p">(</span><span class="n">brcmf_mw_to_qdbm</span><span class="p">(</span><span class="n">txpwrmw</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;qtxpower error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">tx_power</span> <span class="o">=</span> <span class="n">dbm</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_cfg80211_get_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">dbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">s32</span> <span class="n">txpwrdbm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_get</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;qtxpower&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txpwrdbm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">txpwrdbm</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WL_TXPWR_OVERRIDE</span><span class="p">);</span>
	<span class="o">*</span><span class="n">dbm</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">brcmf_qdbm_to_mw</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_config_default_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">unicast</span><span class="p">,</span> <span class="n">bool</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wsec</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;key index (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_GET_WSEC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wsec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_GET_WSEC error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wsec</span> <span class="o">&amp;</span> <span class="n">WEP_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Just select a new current key */</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">key_idx</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_KEY_PRIMARY</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_add_keyext</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
	      <span class="n">u8</span> <span class="n">key_idx</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_wsec_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_wsec_key_le</span> <span class="n">key_le</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">key</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">key_idx</span><span class="p">;</span>
	<span class="cm">/* Instead of bcast for ea address for default wep keys,</span>
<span class="cm">		 driver needs it to be Null */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">mac_addr</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
	<span class="cm">/* check for key index change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* key delete */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">send_key_to_dongle</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Invalid key length (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Setting the key index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">keybuf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">keybuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keybuf</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keybuf</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">keybuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keybuf</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* if IW_ENCODE_EXT_RX_SEQ_VALID set */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq_len</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* rx iv */</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">ivptr</span><span class="p">;</span>
			<span class="n">ivptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
			<span class="n">key</span><span class="p">.</span><span class="n">rxiv</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivptr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ivptr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">ivptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ivptr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">key</span><span class="p">.</span><span class="n">rxiv</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ivptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">key</span><span class="p">.</span><span class="n">iv_initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
			<span class="n">key</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">CRYPTO_ALGO_WEP1</span><span class="p">;</span>
			<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_WEP40</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
			<span class="n">key</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">CRYPTO_ALGO_WEP128</span><span class="p">;</span>
			<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_WEP104</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
			<span class="n">key</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">CRYPTO_ALGO_TKIP</span><span class="p">;</span>
			<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_TKIP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_AES_CMAC</span>:
			<span class="n">key</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">CRYPTO_ALGO_AES_CCM</span><span class="p">;</span>
			<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_AES_CMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
			<span class="n">key</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">CRYPTO_ALGO_AES_CCM</span><span class="p">;</span>
			<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_CCMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Invalid cipher (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">convert_key_from_CPU</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key_le</span><span class="p">);</span>

		<span class="n">brcmf_netdev_wait_pend8021x</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key_le</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="n">key_le</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_KEY error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_add_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">key_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_wsec_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">wsec</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">keybuf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;key index (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">brcmf_add_keyext</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>

	<span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">key_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Too long key length (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">key</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">BRCMF_PRIMARY_KEY</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
		<span class="n">key</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">CRYPTO_ALGO_WEP1</span><span class="p">;</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_WEP40</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="n">key</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">CRYPTO_ALGO_WEP128</span><span class="p">;</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_WEP104</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">keybuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keybuf</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keybuf</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">keybuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keybuf</span><span class="p">));</span>
		<span class="n">key</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">CRYPTO_ALGO_TKIP</span><span class="p">;</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_TKIP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_AES_CMAC</span>:
		<span class="n">key</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">CRYPTO_ALGO_AES_CCM</span><span class="p">;</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_AES_CMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">key</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">CRYPTO_ALGO_AES_CCM</span><span class="p">;</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_CCMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Invalid cipher (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">send_key_to_dongle</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span> <span class="cm">/* Set the new key/index */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">WEP_ENABLED</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_get</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;wsec&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wsec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;get wsec error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wsec</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WEP_ENABLED</span><span class="p">);</span>
	<span class="n">wsec</span> <span class="o">|=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;wsec&quot;</span><span class="p">,</span> <span class="n">wsec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;set wsec error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* assume shared key. otherwise 0 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_AUTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_AUTH error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_del_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_wsec_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">wsec</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>

	<span class="n">key</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">key_idx</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">BRCMF_PRIMARY_KEY</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">CRYPTO_ALGO_OFF</span><span class="p">;</span>

	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;key index (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">);</span>

	<span class="cm">/* Set the new key/index */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">send_key_to_dongle</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">DOT11_MAX_DEFAULT_KEYS</span><span class="p">)</span>
				<span class="cm">/* we ignore this key index in this case */</span>
				<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;invalid key index (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Ignore this error, may happen during DISASSOC */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_get</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;wsec&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wsec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;get wsec error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="cm">/* Ignore this error, may happen during DISASSOC */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wsec</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WEP_ENABLED</span><span class="p">);</span>
	<span class="n">wsec</span> <span class="o">|=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;wsec&quot;</span><span class="p">,</span> <span class="n">wsec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;set wsec error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="cm">/* Ignore this error, may happen during DISASSOC */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* assume open key. otherwise 1 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_AUTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_AUTH error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="cm">/* Ignore this error, may happen during DISASSOC */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_get_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span>
		    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key_params</span> <span class="o">*</span> <span class="n">params</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">key_params</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_security</span> <span class="o">*</span><span class="n">sec</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">wsec</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;key index (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_GET_WSEC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wsec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_GET_WSEC error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="cm">/* Ignore this error, may happen during DISASSOC */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wsec</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WEP_ENABLED</span>:
		<span class="n">sec</span> <span class="o">=</span> <span class="n">brcmf_read_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">WL_PROF_SEC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">cipher_pairwise</span> <span class="o">&amp;</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">params</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span><span class="p">;</span>
			<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_WEP40</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">cipher_pairwise</span> <span class="o">&amp;</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">params</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">;</span>
			<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_WEP104</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TKIP_ENABLED</span>:
		<span class="n">params</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">;</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_TKIP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AES_ENABLED</span>:
		<span class="n">params</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">WLAN_CIPHER_SUITE_AES_CMAC</span><span class="p">;</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;WLAN_CIPHER_SUITE_AES_CMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Invalid algo (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wsec</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">callback</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_config_default_mgmt_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;Not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_get_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">station_info</span> <span class="o">*</span><span class="n">sinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_scb_val_le</span> <span class="n">scb_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rssi</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span> <span class="o">=</span> <span class="n">brcmf_read_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">WL_PROF_BSSID</span><span class="p">);</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Wrong Mac address cfg_mac-%X:%X:%X:%X:%X:%X&quot;</span>
			<span class="s">&quot;wl_bssid-%X:%X:%X:%X:%X:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mac</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mac</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mac</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mac</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mac</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			<span class="n">bssid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bssid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bssid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bssid</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			<span class="n">bssid</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">bssid</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Report the current tx rate */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_GET_RATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Could not get rate (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_TX_BITRATE</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">legacy</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Rate %d Mbps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scb_val</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_GET_RSSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scb_val</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_scb_val_le</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Could not get rssi (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="n">rssi</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">scb_val</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_SIGNAL</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">rssi</span><span class="p">;</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;RSSI %d dBm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rssi</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_set_power_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			   <span class="n">bool</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">s32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">pm</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Powersave enable/disable request is coming from the</span>
<span class="cm">	 * cfg80211 even before the interface is up. In that</span>
<span class="cm">	 * scenario, driver will be storing the power save</span>
<span class="cm">	 * preference in cfg_priv struct to apply this to</span>
<span class="cm">	 * FW later while initializing the dongle</span>
<span class="cm">	 */</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pwr_save</span> <span class="o">=</span> <span class="n">enabled</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;Device is not ready,&quot;</span>
			<span class="s">&quot;storing the value in cfg_priv struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm</span> <span class="o">=</span> <span class="n">enabled</span> <span class="o">?</span> <span class="n">PM_FAST</span> <span class="o">:</span> <span class="n">PM_OFF</span><span class="p">;</span>
	<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;power save %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pm</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_PM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;net_device is not ready yet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_set_bitrate_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">cfg80211_bitrate_mask</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcm_rateset_le</span> <span class="n">rateset_le</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err_bg</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err_a</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">legacy</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* addr param is always NULL. ignore it */</span>
	<span class="cm">/* Get current rateset */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCM_GET_CURR_RATESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rateset_le</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="n">rateset_le</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;could not get current rateset (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">legacy</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">legacy</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">legacy</span><span class="p">)</span>
		<span class="n">legacy</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">legacy</span> <span class="o">&amp;</span>
			     <span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">wl_g_rates</span><span class="p">[</span><span class="n">legacy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rateset_le</span><span class="p">.</span><span class="n">count</span><span class="p">))</span>
		<span class="cm">/* Select rate by rateset index */</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">rateset_le</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* Specified rate in bps */</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">500000</span><span class="p">;</span>

	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;rate %d mbps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *</span>
<span class="cm">	 *      Set rate override,</span>
<span class="cm">	 *      Since the is a/b/g-blind, both a/bg_rate are enforced.</span>
<span class="cm">	 */</span>
	<span class="n">err_bg</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;bg_rate&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="n">err_a</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;a_rate&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_bg</span> <span class="o">&amp;&amp;</span> <span class="n">err_a</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;could not set fixed rate (%d) (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_bg</span><span class="p">,</span> <span class="n">err_a</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">err_bg</span> <span class="o">|</span> <span class="n">err_a</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_inform_single_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">brcmf_bss_info_le</span> <span class="o">*</span><span class="n">bi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">cfg_to_wiphy</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">notify_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">band</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">notify_capability</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">notify_interval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">notify_ie</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">notify_ielen</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">notify_signal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">WL_BSS_INFO_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Bss info is larger than buffer. Discarding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">ctl_ch</span> <span class="o">?</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">ctl_ch</span> <span class="o">:</span>
				<span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="n">CH_MAX_2G_CHANNEL</span><span class="p">)</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">];</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">ieee80211_channel_to_frequency</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
	<span class="n">notify_channel</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="n">notify_capability</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">);</span>
	<span class="n">notify_interval</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">beacon_period</span><span class="p">);</span>
	<span class="n">notify_ie</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">bi</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">ie_offset</span><span class="p">);</span>
	<span class="n">notify_ielen</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">ie_length</span><span class="p">);</span>
	<span class="n">notify_signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">RSSI</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;bssid: %2.2X:%2.2X:%2.2X:%2.2X:%2.2X:%2.2X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Channel: %d(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Capability: %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">notify_capability</span><span class="p">);</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Beacon interval: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">notify_interval</span><span class="p">);</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Signal: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">notify_signal</span><span class="p">);</span>

	<span class="n">bss</span> <span class="o">=</span> <span class="n">cfg80211_inform_bss</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">notify_channel</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">notify_capability</span><span class="p">,</span> <span class="n">notify_interval</span><span class="p">,</span> <span class="n">notify_ie</span><span class="p">,</span>
		<span class="n">notify_ielen</span><span class="p">,</span> <span class="n">notify_signal</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bss</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cfg80211_put_bss</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">brcmf_bss_info_le</span> <span class="o">*</span>
<span class="nf">next_bss_le</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_scan_results</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcmf_bss_info_le</span> <span class="o">*</span><span class="n">bss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">bss_info_le</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_bss_info_le</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bss</span> <span class="o">+</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_inform_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_scan_results</span> <span class="o">*</span><span class="n">bss_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_bss_info_le</span> <span class="o">*</span><span class="n">bi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* must be initialized */</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">bss_list</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bss_list</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">BRCMF_BSS_INFO_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Version %d != WL_BSS_INFO_VERSION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bss_list</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WL_SCAN</span><span class="p">(</span><span class="s">&quot;scanned AP count (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bss_list</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bss_list</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WL_AP_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">next_bss_le</span><span class="p">(</span><span class="n">bss_list</span><span class="p">,</span> <span class="n">bi</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_inform_single_bss</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">bi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">wl_inform_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">cfg_to_wiphy</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">notify_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_bss_info_le</span> <span class="o">*</span><span class="n">bi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">band</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">notify_capability</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">notify_interval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">notify_ie</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">notify_ielen</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">notify_signal</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">WL_BSS_INFO_MAX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">CleanUp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">WL_BSS_INFO_MAX</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_GET_BSS_INFO</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">WL_BSS_INFO_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_GET_BSS_INFO failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">CleanUp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_bss_info_le</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">ctl_ch</span> <span class="o">?</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">ctl_ch</span> <span class="o">:</span>
				<span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="n">CH_MAX_2G_CHANNEL</span><span class="p">)</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">];</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">ieee80211_channel_to_frequency</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
	<span class="n">notify_channel</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="n">notify_capability</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">);</span>
	<span class="n">notify_interval</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">beacon_period</span><span class="p">);</span>
	<span class="n">notify_ie</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">bi</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">ie_offset</span><span class="p">);</span>
	<span class="n">notify_ielen</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">ie_length</span><span class="p">);</span>
	<span class="n">notify_signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">RSSI</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;channel: %d(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;capability: %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">notify_capability</span><span class="p">);</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;beacon interval: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">notify_interval</span><span class="p">);</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;signal: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">notify_signal</span><span class="p">);</span>

	<span class="n">bss</span> <span class="o">=</span> <span class="n">cfg80211_inform_bss</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">notify_channel</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">notify_capability</span><span class="p">,</span> <span class="n">notify_interval</span><span class="p">,</span>
		<span class="n">notify_ie</span><span class="p">,</span> <span class="n">notify_ielen</span><span class="p">,</span> <span class="n">notify_signal</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">CleanUp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg80211_put_bss</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>

<span class="nl">CleanUp:</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcmf_is_ibssmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL_MODE_IBSS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Traverse a string of 1-byte tag/1-byte length/variable-length value</span>
<span class="cm"> * triples, returning a pointer to the substring whose first element</span>
<span class="cm"> * matches tag</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">brcmf_tlv</span> <span class="o">*</span><span class="nf">brcmf_parse_tlvs</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">uint</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_tlv</span> <span class="o">*</span><span class="n">elt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">totlen</span><span class="p">;</span>

	<span class="n">elt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_tlv</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">totlen</span> <span class="o">=</span> <span class="n">buflen</span><span class="p">;</span>

	<span class="cm">/* find tagged parameter */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">elt</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="cm">/* validate remaining totlen */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">elt</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">elt</span><span class="p">;</span>

		<span class="n">elt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_tlv</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">elt</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">totlen</span> <span class="o">-=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_update_bss_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_bss_info_le</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_ssid</span> <span class="o">*</span><span class="n">ssid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_tlv</span> <span class="o">*</span><span class="n">tim</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">beacon_interval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dtim_period</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ie_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_is_ibssmode</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ssid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_ssid</span> <span class="o">*</span><span class="p">)</span><span class="n">brcmf_read_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">WL_PROF_SSID</span><span class="p">);</span>

	<span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">extra_buf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">WL_EXTRA_BUF_MAX</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">),</span> <span class="n">BRCMF_C_GET_BSS_INFO</span><span class="p">,</span>
			<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">extra_buf</span><span class="p">,</span> <span class="n">WL_EXTRA_BUF_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Could not get bss info %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">update_bss_info_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_bss_info_le</span> <span class="o">*</span><span class="p">)(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">extra_buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_inform_single_bss</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">bi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">update_bss_info_out</span><span class="p">;</span>

	<span class="n">ie</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">bi</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">ie_offset</span><span class="p">);</span>
	<span class="n">ie_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">ie_length</span><span class="p">);</span>
	<span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">beacon_period</span><span class="p">);</span>

	<span class="n">tim</span> <span class="o">=</span> <span class="n">brcmf_parse_tlvs</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">WLAN_EID_TIM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tim</span><span class="p">)</span>
		<span class="n">dtim_period</span> <span class="o">=</span> <span class="n">tim</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		* active scan was done so we could not get dtim</span>
<span class="cm">		* information out of probe response.</span>
<span class="cm">		* so we speficially query dtim information to dongle.</span>
<span class="cm">		*/</span>
		<span class="n">u32</span> <span class="n">var</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_intvar_get</span><span class="p">(</span><span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">),</span>
					   <span class="s">&quot;dtim_assoc&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;wl dtim_assoc failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">update_bss_info_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dtim_period</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">var</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">brcmf_update_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">beacon_interval</span><span class="p">,</span> <span class="n">WL_PROF_BEACONINT</span><span class="p">);</span>
	<span class="n">brcmf_update_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtim_period</span><span class="p">,</span> <span class="n">WL_PROF_DTIMPERIOD</span><span class="p">);</span>

<span class="nl">update_bss_info_out:</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_term_iscan</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span> <span class="o">=</span> <span class="n">cfg_to_iscan</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_ssid</span> <span class="n">ssid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL_ISCAN_STATE_IDLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer_on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

		<span class="cm">/* Abort iscan running in FW */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">));</span>
		<span class="n">brcmf_run_iscan</span><span class="p">(</span><span class="n">iscan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">WL_SCAN_ACTION_ABORT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_notify_iscan_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span><span class="p">,</span>
					<span class="n">bool</span> <span class="n">aborted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">iscan_to_cfg</span><span class="p">(</span><span class="n">iscan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Scan complete while device not scanning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_SCAN</span><span class="p">(</span><span class="s">&quot;ISCAN Completed scan: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">aborted</span> <span class="o">?</span> <span class="s">&quot;Aborted&quot;</span> <span class="o">:</span> <span class="s">&quot;Done&quot;</span><span class="p">);</span>
		<span class="n">cfg80211_scan_done</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">,</span> <span class="n">aborted</span><span class="p">);</span>
		<span class="n">brcmf_set_mpc</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan_kickstart</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_wakeup_iscan</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WL_ISCAN_STATE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_SCAN</span><span class="p">(</span><span class="s">&quot;wake up iscan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_get_iscan_results</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">brcmf_scan_results</span> <span class="o">**</span><span class="n">bss_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_iscan_results</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_scan_results</span> <span class="o">*</span><span class="n">results</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_scan_results_le</span> <span class="o">*</span><span class="n">results_le</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_iscan_results</span> <span class="o">*</span><span class="n">list_buf</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">scan_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WL_ISCAN_BUF_MAX</span><span class="p">);</span>
	<span class="n">list_buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_iscan_results</span> <span class="o">*</span><span class="p">)</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">scan_buf</span><span class="p">;</span>
	<span class="n">results</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">list_buf</span><span class="o">-&gt;</span><span class="n">results</span><span class="p">;</span>
	<span class="n">results_le</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">list_buf</span><span class="o">-&gt;</span><span class="n">results_le</span><span class="p">;</span>
	<span class="n">results</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">BRCMF_ISCAN_RESULTS_FIXED_SIZE</span><span class="p">;</span>
	<span class="n">results</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">results</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">list</span><span class="p">));</span>
	<span class="n">list</span><span class="p">.</span><span class="n">results_le</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">WL_ISCAN_BUF_MAX</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_iovar_getbuf</span><span class="p">(</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;iscanresults&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span>
				     <span class="n">BRCMF_ISCAN_RESULTS_FIXED_SIZE</span><span class="p">,</span>
				     <span class="n">iscan</span><span class="o">-&gt;</span><span class="n">scan_buf</span><span class="p">,</span> <span class="n">WL_ISCAN_BUF_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">results</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">results_le</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">);</span>
	<span class="n">results</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">results_le</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
	<span class="n">results</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">results_le</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">WL_SCAN</span><span class="p">(</span><span class="s">&quot;results-&gt;count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">results_le</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">WL_SCAN</span><span class="p">(</span><span class="s">&quot;results-&gt;buflen = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">results_le</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">);</span>
	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">list_buf</span><span class="o">-&gt;</span><span class="n">status_le</span><span class="p">);</span>
	<span class="n">WL_SCAN</span><span class="p">(</span><span class="s">&quot;status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">status</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bss_list</span> <span class="o">=</span> <span class="n">results</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_iscan_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL_ISCAN_STATE_IDLE</span><span class="p">;</span>
	<span class="n">brcmf_inform_bss</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">brcmf_notify_iscan_complete</span><span class="p">(</span><span class="n">iscan</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_iscan_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reschedule the timer */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer_ms</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_iscan_inprogress</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">brcmf_inform_bss</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">brcmf_run_iscan</span><span class="p">(</span><span class="n">iscan</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BRCMF_SCAN_ACTION_CONTINUE</span><span class="p">);</span>
	<span class="cm">/* Reschedule the timer */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer_ms</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_iscan_aborted</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL_ISCAN_STATE_IDLE</span><span class="p">;</span>
	<span class="n">brcmf_notify_iscan_complete</span><span class="p">(</span><span class="n">iscan</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_cfg80211_iscan_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span><span class="p">,</span>
				     <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">iscan_to_cfg</span><span class="p">(</span><span class="n">iscan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_eloop</span> <span class="o">*</span><span class="n">el</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">el</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">BRCMF_SCAN_RESULTS_PARTIAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_get_iscan_results</span><span class="p">(</span><span class="n">iscan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">BRCMF_SCAN_RESULTS_ABORTED</span><span class="p">;</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Abort iscan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">el</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">[</span><span class="n">status</span><span class="p">](</span><span class="n">cfg_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_iscan_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iscan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">WL_SCAN</span><span class="p">(</span><span class="s">&quot;timer expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">brcmf_wakeup_iscan</span><span class="p">(</span><span class="n">iscan</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_invoke_iscan</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span> <span class="o">=</span> <span class="n">cfg_to_iscan</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL_ISCAN_STATE_IDLE</span><span class="p">;</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">brcmf_cfg80211_iscan_handler</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_init_iscan_eloop</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_eloop</span> <span class="o">*</span><span class="n">el</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">el</span><span class="p">));</span>
	<span class="n">el</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">[</span><span class="n">BRCMF_SCAN_RESULTS_SUCCESS</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcmf_iscan_done</span><span class="p">;</span>
	<span class="n">el</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">[</span><span class="n">BRCMF_SCAN_RESULTS_PARTIAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcmf_iscan_inprogress</span><span class="p">;</span>
	<span class="n">el</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">[</span><span class="n">BRCMF_SCAN_RESULTS_PENDING</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcmf_iscan_pending</span><span class="p">;</span>
	<span class="n">el</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">[</span><span class="n">BRCMF_SCAN_RESULTS_ABORTED</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcmf_iscan_aborted</span><span class="p">;</span>
	<span class="n">el</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">[</span><span class="n">BRCMF_SCAN_RESULTS_NO_MEM</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcmf_iscan_aborted</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_init_iscan</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_iscan_ctrl</span> <span class="o">*</span><span class="n">iscan</span> <span class="o">=</span> <span class="n">cfg_to_iscan</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
		<span class="n">brcmf_init_iscan_eloop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">el</span><span class="p">);</span>
		<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer_ms</span> <span class="o">=</span> <span class="n">WL_ISCAN_TIMER_INTERVAL_MS</span><span class="p">;</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">iscan</span><span class="p">;</span>
		<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">brcmf_iscan_timer</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_invoke_iscan</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">iscan</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="nf">brcmf_delay</span><span class="p">(</span><span class="n">u32</span> <span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_cfg80211_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for WL_STATUS_READY before any function call which</span>
<span class="cm">	 * could result is bus access. Don&#39;t block the resume for</span>
<span class="cm">	 * any driver error conditions</span>
<span class="cm">	 */</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="n">brcmf_invoke_iscan</span><span class="p">(</span><span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">));</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_cfg80211_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="o">*</span><span class="n">wow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for WL_STATUS_READY before any function call which</span>
<span class="cm">	 * could result is bus access. Don&#39;t block the suspend for</span>
<span class="cm">	 * any driver error conditions</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * While going to suspend if associated with AP disassociate</span>
<span class="cm">	 * from AP to save power while system is in suspended state</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;Disassociating from AP&quot;</span>
			<span class="s">&quot; while entering suspend state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">brcmf_link_down</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Make sure WPA_Supplicant receives all the event</span>
<span class="cm">		 * generated due to DISASSOC call to the fw to keep</span>
<span class="cm">		 * the state fw and WPA_Supplicant state consistent</span>
<span class="cm">		 */</span>
		<span class="n">brcmf_delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">WL_STATUS_SCAN_ABORTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="n">brcmf_term_iscan</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Indidate scan abort to cfg80211 layer */</span>
		<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;Terminating scan in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cfg80211_scan_done</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_SCAN_ABORTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Turn off watchdog timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;Enable MPC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">brcmf_set_mpc</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__used</span> <span class="n">s32</span>
<span class="nf">brcmf_dev_bufvar_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">s32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">ndev_to_cfg</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">buflen</span><span class="p">;</span>

	<span class="n">buflen</span> <span class="o">=</span> <span class="n">brcmf_c_mkiovar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">dcmd_buf</span><span class="p">,</span>
			       <span class="n">WL_DCMD_LEN_MAX</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">buflen</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_VAR</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">dcmd_buf</span><span class="p">,</span>
			       <span class="n">buflen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_dev_bufvar_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		  <span class="n">s32</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">ndev_to_cfg</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">brcmf_c_mkiovar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">dcmd_buf</span><span class="p">,</span>
			    <span class="n">WL_DCMD_LEN_MAX</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_GET_VAR</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">dcmd_buf</span><span class="p">,</span>
			      <span class="n">WL_DCMD_LEN_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">dcmd_buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__used</span> <span class="n">s32</span>
<span class="nf">brcmf_update_pmklist</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">brcmf_cfg80211_pmk_list</span> <span class="o">*</span><span class="n">pmk_list</span><span class="p">,</span> <span class="n">s32</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pmkid_len</span><span class="p">;</span>

	<span class="n">pmkid_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pmk_list</span><span class="o">-&gt;</span><span class="n">pmkids</span><span class="p">.</span><span class="n">npmkid</span><span class="p">);</span>

	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;No of elements %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pmkid_len</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pmkid_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;PMKID[%d]: %pM =</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pmk_list</span><span class="o">-&gt;</span><span class="n">pmkids</span><span class="p">.</span><span class="n">pmkid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BSSID</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">WLAN_PMKID_LEN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pmk_list</span><span class="o">-&gt;</span><span class="n">pmkids</span><span class="p">.</span><span class="n">pmkid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PMKID</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">brcmf_dev_bufvar_set</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;pmkid_info&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pmk_list</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmk_list</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_set_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">cfg80211_pmksa</span> <span class="o">*</span><span class="n">pmksa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmkid_list</span> <span class="o">*</span><span class="n">pmkids</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="o">-&gt;</span><span class="n">pmkids</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pmkid_len</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">pmkid_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">npmkid</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pmkid_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BSSID</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">WL_NUM_PMKIDS_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BSSID</span><span class="p">,</span> <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PMKID</span><span class="p">,</span> <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">,</span> <span class="n">WLAN_PMKID_LEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">pmkid_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pmkid_len</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">npmkid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pmkid_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;set_pmksa,IW_PMKSA_ADD - PMKID: %pM =</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">[</span><span class="n">pmkid_len</span><span class="p">].</span><span class="n">BSSID</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WLAN_PMKID_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">[</span><span class="n">pmkid_len</span><span class="p">].</span><span class="n">PMKID</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_update_pmklist</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_del_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">cfg80211_pmksa</span> <span class="o">*</span><span class="n">pmksa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmkid_list</span> <span class="n">pmkid</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pmkid_len</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmkid</span><span class="p">.</span><span class="n">pmkid</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">BSSID</span><span class="p">,</span> <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmkid</span><span class="p">.</span><span class="n">pmkid</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PMKID</span><span class="p">,</span> <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">,</span> <span class="n">WLAN_PMKID_LEN</span><span class="p">);</span>

	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;del_pmksa,IW_PMKSA_REMOVE - PMKID: %pM =</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">pmkid</span><span class="p">.</span><span class="n">pmkid</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">BSSID</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WLAN_PMKID_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pmkid</span><span class="p">.</span><span class="n">pmkid</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PMKID</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">pmkid_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="o">-&gt;</span><span class="n">pmkids</span><span class="p">.</span><span class="n">npmkid</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pmkid_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span>
		    <span class="p">(</span><span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="o">-&gt;</span><span class="n">pmkids</span><span class="p">.</span><span class="n">pmkid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BSSID</span><span class="p">,</span>
		     <span class="n">ETH_ALEN</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pmkid_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">pmkid_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="o">-&gt;</span><span class="n">pmkids</span><span class="p">.</span><span class="n">pmkid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmkid</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pmkid_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="o">-&gt;</span><span class="n">pmkids</span><span class="p">.</span><span class="n">pmkid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BSSID</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="o">-&gt;</span><span class="n">pmkids</span><span class="p">.</span><span class="n">pmkid</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">BSSID</span><span class="p">,</span>
			       <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="o">-&gt;</span><span class="n">pmkids</span><span class="p">.</span><span class="n">pmkid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PMKID</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="o">-&gt;</span><span class="n">pmkids</span><span class="p">.</span><span class="n">pmkid</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">PMKID</span><span class="p">,</span>
			       <span class="n">WLAN_PMKID_LEN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="o">-&gt;</span><span class="n">pmkids</span><span class="p">.</span><span class="n">npmkid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pmkid_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_update_pmklist</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_cfg80211_flush_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wiphy_to_cfg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sys_up</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_update_pmklist</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cfg80211_ops</span> <span class="n">wl_cfg80211_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">change_virtual_intf</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_change_iface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wiphy_params</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_set_wiphy_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">join_ibss</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_join_ibss</span><span class="p">,</span>
	<span class="p">.</span><span class="n">leave_ibss</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_leave_ibss</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_station</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_get_station</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tx_power</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_set_tx_power</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tx_power</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_get_tx_power</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_key</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_add_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_key</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_del_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_get_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_default_key</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_config_default_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_default_mgmt_key</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_config_default_mgmt_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_power_mgmt</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_set_power_mgmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bitrate_mask</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_set_bitrate_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pmksa</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_set_pmksa</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_pmksa</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_del_pmksa</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_pmksa</span> <span class="o">=</span> <span class="n">brcmf_cfg80211_flush_pmksa</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_mode_to_nl80211_iftype</span><span class="p">(</span><span class="n">s32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WL_MODE_BSS</span>:
		<span class="k">return</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL_MODE_IBSS</span>:
		<span class="k">return</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="nf">brcmf_alloc_wdev</span><span class="p">(</span><span class="n">s32</span> <span class="n">sizeof_iface</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wdev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span> <span class="o">=</span>
	    <span class="n">wiphy_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl_cfg80211_ops</span><span class="p">,</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span><span class="p">)</span> <span class="o">+</span> <span class="n">sizeof_iface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Could not allocate wiphy device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">wiphy_new_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_wiphy_dev</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ssids</span> <span class="o">=</span> <span class="n">WL_NUM_SCAN_MAX</span><span class="p">;</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_num_pmkids</span> <span class="o">=</span> <span class="n">WL_NUM_PMKIDS_MAX</span><span class="p">;</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span>
	    <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">);</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__wl_band_2ghz</span><span class="p">;</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__wl_band_5ghz_a</span><span class="p">;</span>	<span class="cm">/* Set</span>
<span class="cm">						* it as 11a by default.</span>
<span class="cm">						* This will be updated with</span>
<span class="cm">						* 11n phy tables in</span>
<span class="cm">						* &quot;ifconfig up&quot;</span>
<span class="cm">						* if phy has 11n capability</span>
<span class="cm">						*/</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">signal_type</span> <span class="o">=</span> <span class="n">CFG80211_SIGNAL_TYPE_MBM</span><span class="p">;</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">cipher_suites</span> <span class="o">=</span> <span class="n">__wl_cipher_suites</span><span class="p">;</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_cipher_suites</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">__wl_cipher_suites</span><span class="p">);</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIPHY_FLAG_PS_ON_BY_DEFAULT</span><span class="p">;</span>	<span class="cm">/* enable power</span>
<span class="cm">								 * save mode</span>
<span class="cm">								 * by default</span>
<span class="cm">								 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">wiphy_register</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Could not register wiphy device (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">wiphy_register_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">wdev</span><span class="p">;</span>

<span class="nl">wiphy_register_out:</span>
	<span class="n">wiphy_free</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>

<span class="nl">wiphy_new_out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_free_wdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;wdev is invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wiphy_unregister</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">wiphy_free</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">wdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcmf_is_linkup</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">brcmf_event_msg</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">event</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">BRCMF_E_SET_SSID</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">==</span> <span class="n">BRCMF_E_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Processing set ssid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcmf_is_linkdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">brcmf_event_msg</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">event</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">BRCMF_E_LINK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BRCMF_EVENT_MSG_LINK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Processing link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcmf_is_nonetwork</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">brcmf_event_msg</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">event</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">BRCMF_E_LINK</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">==</span> <span class="n">BRCMF_E_STATUS_NO_NETWORKS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Processing Link %s &amp; no network found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BRCMF_EVENT_MSG_LINK</span> <span class="o">?</span>
				<span class="s">&quot;up&quot;</span> <span class="o">:</span> <span class="s">&quot;down&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">BRCMF_E_SET_SSID</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">BRCMF_E_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Processing connecting &amp; no network found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_clear_assoc_ies</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_connect_info</span> <span class="o">*</span><span class="n">conn_info</span> <span class="o">=</span> <span class="n">cfg_to_conn</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">req_ie</span><span class="p">);</span>
	<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">req_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">req_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">resp_ie</span><span class="p">);</span>
	<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">resp_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_get_assoc_ies</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_assoc_ielen_le</span> <span class="o">*</span><span class="n">assoc_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_connect_info</span> <span class="o">*</span><span class="n">conn_info</span> <span class="o">=</span> <span class="n">cfg_to_conn</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">req_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">resp_len</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">brcmf_clear_assoc_ies</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_bufvar_get</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;assoc_info&quot;</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">extra_buf</span><span class="p">,</span>
				<span class="n">WL_ASSOC_INFO_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;could not get assoc info (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">assoc_info</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_assoc_ielen_le</span> <span class="o">*</span><span class="p">)</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">extra_buf</span><span class="p">;</span>
	<span class="n">req_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">assoc_info</span><span class="o">-&gt;</span><span class="n">req_len</span><span class="p">);</span>
	<span class="n">resp_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">assoc_info</span><span class="o">-&gt;</span><span class="n">resp_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_bufvar_get</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;assoc_req_ies&quot;</span><span class="p">,</span>
					   <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">extra_buf</span><span class="p">,</span>
					   <span class="n">WL_ASSOC_INFO_MAX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;could not get assoc req (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">req_ie_len</span> <span class="o">=</span> <span class="n">req_len</span><span class="p">;</span>
		<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">req_ie</span> <span class="o">=</span>
		    <span class="n">kmemdup</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">extra_buf</span><span class="p">,</span> <span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">req_ie_len</span><span class="p">,</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">req_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">req_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resp_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dev_bufvar_get</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;assoc_resp_ies&quot;</span><span class="p">,</span>
					   <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">extra_buf</span><span class="p">,</span>
					   <span class="n">WL_ASSOC_INFO_MAX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;could not get assoc resp (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span> <span class="o">=</span> <span class="n">resp_len</span><span class="p">;</span>
		<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">resp_ie</span> <span class="o">=</span>
		    <span class="n">kmemdup</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">extra_buf</span><span class="p">,</span> <span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span><span class="p">,</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">resp_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;req len (%d) resp len (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">req_ie_len</span><span class="p">,</span> <span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_bss_roaming_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">brcmf_event_msg</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_connect_info</span> <span class="o">*</span><span class="n">conn_info</span> <span class="o">=</span> <span class="n">cfg_to_conn</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">cfg_to_wiphy</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_channel_info_le</span> <span class="n">channel_le</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">notify_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">band</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">target_channel</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">brcmf_get_assoc_ies</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">brcmf_update_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">WL_PROF_BSSID</span><span class="p">);</span>
	<span class="n">brcmf_update_bss_info</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

	<span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_GET_CHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel_le</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">channel_le</span><span class="p">));</span>

	<span class="n">target_channel</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">channel_le</span><span class="p">.</span><span class="n">target_channel</span><span class="p">);</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Roamed to channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target_channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_channel</span> <span class="o">&lt;=</span> <span class="n">CH_MAX_2G_CHANNEL</span><span class="p">)</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">];</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">ieee80211_channel_to_frequency</span><span class="p">(</span><span class="n">target_channel</span><span class="p">,</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
	<span class="n">notify_channel</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="n">cfg80211_roamed</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">notify_channel</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">brcmf_read_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">WL_PROF_BSSID</span><span class="p">),</span>
			<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">req_ie</span><span class="p">,</span> <span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">req_ie_len</span><span class="p">,</span>
			<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">resp_ie</span><span class="p">,</span> <span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Report roaming result</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_bss_connect_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcmf_event_msg</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span>
		       <span class="n">bool</span> <span class="n">completed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_connect_info</span> <span class="o">*</span><span class="n">conn_info</span> <span class="o">=</span> <span class="n">cfg_to_conn</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">completed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmf_get_assoc_ies</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
			<span class="n">brcmf_update_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
					  <span class="n">WL_PROF_BSSID</span><span class="p">);</span>
			<span class="n">brcmf_update_bss_info</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cfg80211_connect_result</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">brcmf_read_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span>
							      <span class="n">WL_PROF_BSSID</span><span class="p">),</span>
					<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">req_ie</span><span class="p">,</span>
					<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">req_ie_len</span><span class="p">,</span>
					<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">resp_ie</span><span class="p">,</span>
					<span class="n">conn_info</span><span class="o">-&gt;</span><span class="n">resp_ie_len</span><span class="p">,</span>
					<span class="n">completed</span> <span class="o">?</span> <span class="n">WLAN_STATUS_SUCCESS</span> <span class="o">:</span>
						    <span class="n">WLAN_STATUS_AUTH_TIMEOUT</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">completed</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Report connect result - connection %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">completed</span> <span class="o">?</span> <span class="s">&quot;succeeded&quot;</span> <span class="o">:</span> <span class="s">&quot;failed&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_notify_connect_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">brcmf_event_msg</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_is_linkup</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Linkup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_is_ibssmode</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brcmf_update_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
				<span class="n">WL_PROF_BSSID</span><span class="p">);</span>
			<span class="n">wl_inform_ibss</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">cfg80211_ibss_joined</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">brcmf_bss_connect_done</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">brcmf_is_linkdown</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;Linkdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_is_ibssmode</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTED</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
				<span class="n">brcmf_link_down</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">brcmf_bss_connect_done</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTED</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cfg80211_disconnected</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="n">brcmf_link_down</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">brcmf_init_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">brcmf_is_nonetwork</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brcmf_is_ibssmode</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">))</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">brcmf_bss_connect_done</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_notify_roaming_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">brcmf_event_msg</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">event</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">BRCMF_E_ROAM</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">==</span> <span class="n">BRCMF_E_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
			<span class="n">brcmf_bss_roaming_done</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">brcmf_bss_connect_done</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_notify_mic_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">brcmf_event_msg</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">nl80211_key_type</span> <span class="n">key_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BRCMF_EVENT_MSG_GROUP</span><span class="p">)</span>
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">NL80211_KEYTYPE_GROUP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">NL80211_KEYTYPE_PAIRWISE</span><span class="p">;</span>

	<span class="n">cfg80211_michael_mic_failure</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">key_type</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
				     <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_notify_scan_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">brcmf_event_msg</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_channel_info_le</span> <span class="n">channel_inform_le</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_scan_results_le</span> <span class="o">*</span><span class="n">bss_list_le</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="n">WL_SCAN_BUF_MAX</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">scan_abort</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scan_channel</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan_on</span> <span class="o">&amp;&amp;</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan_kickstart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">brcmf_wakeup_iscan</span><span class="p">(</span><span class="n">cfg_to_iscan</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Scan complete while device not scanning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">scan_abort</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">scan_done_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_GET_CHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel_inform_le</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="n">channel_inform_le</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;scan busy (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">scan_abort</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">scan_done_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scan_channel</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">channel_inform_le</span><span class="p">.</span><span class="n">scan_channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scan_channel</span><span class="p">)</span>
		<span class="n">WL_CONN</span><span class="p">(</span><span class="s">&quot;channel_inform.scan_channel (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scan_channel</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">bss_list</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_results</span><span class="p">;</span>
	<span class="n">bss_list_le</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_scan_results_le</span> <span class="o">*</span><span class="p">)</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_results</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">bss_list_le</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SCAN_RESULTS</span><span class="p">,</span>
			      <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_results</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;%s Scan_results error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">scan_abort</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">scan_done_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_results</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bss_list_le</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_results</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bss_list_le</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_results</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bss_list_le</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_inform_bss</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scan_abort</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">scan_done_out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">scan_done_out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_SCAN</span><span class="p">(</span><span class="s">&quot;calling cfg80211_scan_done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cfg80211_scan_done</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">,</span> <span class="n">scan_abort</span><span class="p">);</span>
		<span class="n">brcmf_set_mpc</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_init_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">frag_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_short</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_long</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">tx_power</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_init_eloop_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_event_loop</span> <span class="o">*</span><span class="n">el</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">el</span><span class="p">));</span>
	<span class="n">el</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">[</span><span class="n">BRCMF_E_SCAN_COMPLETE</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcmf_notify_scan_status</span><span class="p">;</span>
	<span class="n">el</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">[</span><span class="n">BRCMF_E_LINK</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcmf_notify_connect_status</span><span class="p">;</span>
	<span class="n">el</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">[</span><span class="n">BRCMF_E_ROAM</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcmf_notify_roaming_status</span><span class="p">;</span>
	<span class="n">el</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">[</span><span class="n">BRCMF_E_MIC_ERROR</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcmf_notify_mic_status</span><span class="p">;</span>
	<span class="n">el</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">[</span><span class="n">BRCMF_E_SET_SSID</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcmf_notify_connect_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_deinit_priv_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_results</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_results</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">bss_info</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">bss_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_req_int</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_req_int</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">dcmd_buf</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">dcmd_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">extra_buf</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">extra_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_init_priv_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_results</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">WL_SCAN_BUF_MAX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_results</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_priv_mem_out</span><span class="p">;</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_priv_mem_out</span><span class="p">;</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_priv_mem_out</span><span class="p">;</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">bss_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">WL_BSS_INFO_MAX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">bss_info</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_priv_mem_out</span><span class="p">;</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_req_int</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_req_int</span><span class="p">),</span>
					 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_req_int</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_priv_mem_out</span><span class="p">;</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">dcmd_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">WL_DCMD_LEN_MAX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">dcmd_buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_priv_mem_out</span><span class="p">;</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">extra_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">WL_EXTRA_BUF_MAX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">extra_buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_priv_mem_out</span><span class="p">;</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_priv_mem_out</span><span class="p">;</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pmk_list</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_priv_mem_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">init_priv_mem_out:</span>
	<span class="n">brcmf_deinit_priv_mem</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* retrieve first queued event from head</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">brcmf_cfg80211_event_q</span> <span class="o">*</span><span class="nf">brcmf_deq_event</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_event_q</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">evt_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">evt_q_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">evt_q_list</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">brcmf_cfg80211_event_q</span><span class="p">,</span> <span class="n">evt_q_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">evt_q_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">evt_q_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">*	push event to tail of the queue</span>
<span class="cm">*</span>
<span class="cm">*	remark: this function may not sleep as it is called in atomic context.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_enq_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">brcmf_event_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_event_q</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_event_q</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">etype</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">emsg</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_event_msg</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">evt_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">evt_q_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">evt_q_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">evt_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_put_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_event_q</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_cfg80211_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span><span class="p">,</span>
				     <span class="n">event_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_event_q</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">brcmf_deq_event</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;event queue empty...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;event type (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">etype</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">el</span><span class="p">.</span><span class="n">handler</span><span class="p">[</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">etype</span><span class="p">])</span>
			<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">el</span><span class="p">.</span><span class="n">handler</span><span class="p">[</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">etype</span><span class="p">](</span><span class="n">cfg_priv</span><span class="p">,</span>
						       <span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">),</span>
						       <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">emsg</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">edata</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;Unknown Event (%d): ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">etype</span><span class="p">);</span>
		<span class="n">brcmf_put_event</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">brcmf_deq_event</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">)));</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_init_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">evt_q_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">evt_q_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_flush_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_event_q</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">evt_q_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">evt_q_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">evt_q_list</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">brcmf_cfg80211_event_q</span><span class="p">,</span> <span class="n">evt_q_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">evt_q_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">evt_q_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">wl_init_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pwr_save</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>	<span class="cm">/* iscan on &amp; off switch.</span>
<span class="cm">				 we enable iscan per default */</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">roam_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>	<span class="cm">/* roam on &amp; off switch.</span>
<span class="cm">				 we enable roam per default */</span>

	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">iscan_kickstart</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">active_scan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>	<span class="cm">/* we do active scan for</span>
<span class="cm">				 specific scan per default */</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">dongle_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* dongle is not up yet */</span>
	<span class="n">brcmf_init_eq</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_init_priv_mem</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">,</span> <span class="n">brcmf_cfg80211_event_handler</span><span class="p">);</span>
	<span class="n">brcmf_init_eloop_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">el</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">usr_sync</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_init_iscan</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">brcmf_init_conf</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">brcmf_init_prof</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">);</span>
	<span class="n">brcmf_link_down</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl_deinit_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">dongle_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* dongle down */</span>
	<span class="n">brcmf_flush_eq</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">brcmf_link_down</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">brcmf_term_iscan</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">brcmf_deinit_priv_mem</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">brcmf_cfg80211_dev</span> <span class="o">*</span><span class="nf">brcmf_cfg80211_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">busdev</span><span class="p">,</span>
						 <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_iface</span> <span class="o">*</span><span class="n">ci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_dev</span> <span class="o">*</span><span class="n">cfg_dev</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;ndev is invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cfg_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">wdev</span> <span class="o">=</span> <span class="n">brcmf_alloc_wdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_iface</span><span class="p">),</span> <span class="n">busdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">wdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cfg_dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">=</span> <span class="n">brcmf_mode_to_nl80211_iftype</span><span class="p">(</span><span class="n">WL_MODE_BSS</span><span class="p">);</span>
	<span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">wdev_to_cfg</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">wdev</span><span class="p">;</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pub</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_iface</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span> <span class="o">=</span> <span class="n">wdev</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">wiphy_dev</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">));</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">wl_init_priv</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Failed to init iwm_priv (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cfg80211_attach_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">brcmf_set_drvdata</span><span class="p">(</span><span class="n">cfg_dev</span><span class="p">,</span> <span class="n">ci</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cfg_dev</span><span class="p">;</span>

<span class="nl">cfg80211_attach_out:</span>
	<span class="n">brcmf_free_wdev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cfg_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcmf_cfg80211_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_dev</span> <span class="o">*</span><span class="n">cfg_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">;</span>

	<span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">brcmf_priv_get</span><span class="p">(</span><span class="n">cfg_dev</span><span class="p">);</span>

	<span class="n">wl_deinit_priv</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">brcmf_free_wdev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">brcmf_set_drvdata</span><span class="p">(</span><span class="n">cfg_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cfg_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">brcmf_cfg80211_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		  <span class="k">const</span> <span class="k">struct</span> <span class="n">brcmf_event_msg</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">event_type</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">ndev_to_cfg</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcmf_enq_event</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_dongle_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">s32</span> <span class="n">iftype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">infra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">iftype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MONITOR</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_WDS</span>:
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;type (%d) : currently we do not support this mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">iftype</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">infra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">infra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;invalid type (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iftype</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_INFRA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">infra</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_INFRA error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_dongle_eventmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Room for &quot;event_msgs&quot; + &#39;\0&#39; + bitvec */</span>
	<span class="n">s8</span> <span class="n">iovbuf</span><span class="p">[</span><span class="n">BRCMF_EVENTING_MASK_LEN</span> <span class="o">+</span> <span class="mi">12</span><span class="p">];</span>
	<span class="n">s8</span> <span class="n">eventmask</span><span class="p">[</span><span class="n">BRCMF_EVENTING_MASK_LEN</span><span class="p">];</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Setup event_msgs */</span>
	<span class="n">brcmf_c_mkiovar</span><span class="p">(</span><span class="s">&quot;event_msgs&quot;</span><span class="p">,</span> <span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_EVENTING_MASK_LEN</span><span class="p">,</span>
			<span class="n">iovbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iovbuf</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_GET_VAR</span><span class="p">,</span> <span class="n">iovbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iovbuf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Get event_msgs error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dongle_eventmsg_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">iovbuf</span><span class="p">,</span> <span class="n">BRCMF_EVENTING_MASK_LEN</span><span class="p">);</span>

	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_SET_SSID</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_ROAM</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_PRUNE</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_AUTH</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_REASSOC</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_REASSOC_IND</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_DEAUTH_IND</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_DISASSOC_IND</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_DISASSOC</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_JOIN</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_ASSOC_IND</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_PSK_SUP</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_LINK</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_NDIS_LINK</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_MIC_ERROR</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_PMKID_CACHE</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_TXFAIL</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_JOIN_START</span><span class="p">);</span>
	<span class="n">setbit</span><span class="p">(</span><span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_E_SCAN_COMPLETE</span><span class="p">);</span>

	<span class="n">brcmf_c_mkiovar</span><span class="p">(</span><span class="s">&quot;event_msgs&quot;</span><span class="p">,</span> <span class="n">eventmask</span><span class="p">,</span> <span class="n">BRCMF_EVENTING_MASK_LEN</span><span class="p">,</span>
			<span class="n">iovbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iovbuf</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_VAR</span><span class="p">,</span> <span class="n">iovbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iovbuf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Set event_msgs error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dongle_eventmsg_out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">dongle_eventmsg_out:</span>
	<span class="n">WL_TRACE</span><span class="p">(</span><span class="s">&quot;Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_dongle_roam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">roamvar</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bcn_timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">iovbuf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">roamtrigger</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">__le32</span> <span class="n">roam_delta</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">__le32</span> <span class="n">bcn_to_le</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">roamvar_le</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup timeout if Beacons are lost and roam is</span>
<span class="cm">	 * off to report link down</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">roamvar</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcn_to_le</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bcn_timeout</span><span class="p">);</span>
		<span class="n">brcmf_c_mkiovar</span><span class="p">(</span><span class="s">&quot;bcn_timeout&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bcn_to_le</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">bcn_to_le</span><span class="p">),</span> <span class="n">iovbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iovbuf</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_VAR</span><span class="p">,</span>
				   <span class="n">iovbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iovbuf</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;bcn_timeout error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">dongle_rom_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable/Disable built-in roaming to allow supplicant</span>
<span class="cm">	 * to take care of roaming</span>
<span class="cm">	 */</span>
	<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;Internal Roaming = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">roamvar</span> <span class="o">?</span> <span class="s">&quot;Off&quot;</span> <span class="o">:</span> <span class="s">&quot;On&quot;</span><span class="p">);</span>
	<span class="n">roamvar_le</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">roamvar</span><span class="p">);</span>
	<span class="n">brcmf_c_mkiovar</span><span class="p">(</span><span class="s">&quot;roam_off&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">roamvar_le</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">roamvar_le</span><span class="p">),</span> <span class="n">iovbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iovbuf</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_VAR</span><span class="p">,</span> <span class="n">iovbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iovbuf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;roam_off error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dongle_rom_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">roamtrigger</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">WL_ROAM_TRIGGER_LEVEL</span><span class="p">);</span>
	<span class="n">roamtrigger</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BRCM_BAND_ALL</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_ROAM_TRIGGER</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">roamtrigger</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">roamtrigger</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_ROAM_TRIGGER error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dongle_rom_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">roam_delta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">WL_ROAM_DELTA</span><span class="p">);</span>
	<span class="n">roam_delta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BRCM_BAND_ALL</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_ROAM_DELTA</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">roam_delta</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">roam_delta</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;WLC_SET_ROAM_DELTA error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dongle_rom_out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">dongle_rom_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span>
<span class="nf">brcmf_dongle_scantime</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">s32</span> <span class="n">scan_assoc_time</span><span class="p">,</span>
		      <span class="n">s32</span> <span class="n">scan_unassoc_time</span><span class="p">,</span> <span class="n">s32</span> <span class="n">scan_passive_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">scan_assoc_tm_le</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scan_assoc_time</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">scan_unassoc_tm_le</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scan_unassoc_time</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">scan_passive_tm_le</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scan_passive_time</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_SCAN_CHANNEL_TIME</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">scan_assoc_tm_le</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_assoc_tm_le</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
			<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;Scan assoc time is not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Scan assoc time error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dongle_scantime_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_SCAN_UNASSOC_TIME</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">scan_unassoc_tm_le</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_unassoc_tm_le</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
			<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;Scan unassoc time is not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Scan unassoc time error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dongle_scantime_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_SCAN_PASSIVE_TIME</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">scan_passive_tm_le</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_passive_tm_le</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
			<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;Scan passive time is not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;Scan passive time error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dongle_scantime_out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">dongle_scantime_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">wl_update_wiphybands</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">phy_list</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">phy</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd</span><span class="p">(</span><span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">),</span> <span class="n">BRCM_GET_PHYLIST</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">phy_list</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">phy_list</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phy_list</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;%c phy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span> <span class="o">||</span> <span class="n">phy</span> <span class="o">==</span> <span class="sc">&#39;a&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy</span> <span class="o">=</span> <span class="n">cfg_to_wiphy</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
		<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__wl_band_5ghz_n</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_dongle_probecap</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wl_update_wiphybands</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">brcmf_config_dongle</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">power_mode</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">dongle_up</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">wdev</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span><span class="p">;</span>

	<span class="n">brcmf_dongle_scantime</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">WL_SCAN_CHANNEL_TIME</span><span class="p">,</span>
			<span class="n">WL_SCAN_UNASSOC_TIME</span><span class="p">,</span> <span class="n">WL_SCAN_PASSIVE_TIME</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dongle_eventmsg</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">default_conf_out</span><span class="p">;</span>

	<span class="n">power_mode</span> <span class="o">=</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">pwr_save</span> <span class="o">?</span> <span class="n">PM_FAST</span> <span class="o">:</span> <span class="n">PM_OFF</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_exec_dcmd_u32</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">BRCMF_C_SET_PM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">power_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">default_conf_out</span><span class="p">;</span>
	<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;power save set to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">power_mode</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dongle_roam</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">roam_on</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">),</span>
				<span class="n">WL_BEACON_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">default_conf_out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dongle_mode</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">default_conf_out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_dongle_probecap</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">default_conf_out</span><span class="p">;</span>

	<span class="cm">/* -EINPROGRESS: Call commit handler */</span>

<span class="nl">default_conf_out:</span>

	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">dongle_up</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcmf_debugfs_add_netdev_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="o">+</span><span class="n">IFNAMSIZ</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">fd</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;netdev:%s&quot;</span><span class="p">,</span> <span class="n">cfg_to_ndev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">debugfsdir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
					<span class="n">cfg_to_wiphy</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">debugfsdir</span><span class="p">);</span>

	<span class="n">fd</span> <span class="o">=</span> <span class="n">debugfs_create_u16</span><span class="p">(</span><span class="s">&quot;beacon_int&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">debugfsdir</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fd</span> <span class="o">=</span> <span class="n">debugfs_create_u8</span><span class="p">(</span><span class="s">&quot;dtim_period&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">debugfsdir</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcmf_debugfs_remove_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">debugfsdir</span><span class="p">);</span>
	<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">debugfsdir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">__brcmf_cfg80211_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">WL_STATUS_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">brcmf_debugfs_add_netdev_params</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">brcmf_config_dongle</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">brcmf_invoke_iscan</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">__brcmf_cfg80211_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * While going down, if associated with AP disassociate</span>
<span class="cm">	 * from AP to save power</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">WL_STATUS_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WL_INFO</span><span class="p">(</span><span class="s">&quot;Disassociating from AP&quot;</span><span class="p">);</span>
		<span class="n">brcmf_link_down</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

		<span class="cm">/* Make sure WPA_Supplicant receives all the event</span>
<span class="cm">		   generated due to DISASSOC call to the fw to keep</span>
<span class="cm">		   the state fw and WPA_Supplicant state consistent</span>
<span class="cm">		 */</span>
		<span class="n">brcmf_delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">WL_STATUS_SCAN_ABORTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">brcmf_term_iscan</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg80211_scan_done</span><span class="p">(</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="cm">/* May need to perform this to cover rmmod */</span>
		<span class="cm">/* wl_set_mpc(cfg_to_ndev(wl), 1); */</span>
		<span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL_STATUS_SCAN_ABORTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">brcmf_debugfs_remove_netdev</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">s32</span> <span class="nf">brcmf_cfg80211_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_dev</span> <span class="o">*</span><span class="n">cfg_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">brcmf_priv_get</span><span class="p">(</span><span class="n">cfg_dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">usr_sync</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__brcmf_cfg80211_up</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">usr_sync</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">s32</span> <span class="nf">brcmf_cfg80211_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_dev</span> <span class="o">*</span><span class="n">cfg_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cfg_priv</span> <span class="o">=</span> <span class="n">brcmf_priv_get</span><span class="p">(</span><span class="n">cfg_dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">usr_sync</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__brcmf_cfg80211_down</span><span class="p">(</span><span class="n">cfg_priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">usr_sync</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__used</span> <span class="n">s32</span> <span class="nf">brcmf_add_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcmf_cfg80211_priv</span> <span class="o">*</span><span class="n">cfg_priv</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">t</span><span class="p">,</span> <span class="n">u8</span> <span class="n">l</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcmf_cfg80211_ie</span> <span class="o">*</span><span class="n">ie</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cfg_priv</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">WL_TLV_INFO_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WL_ERR</span><span class="p">(</span><span class="s">&quot;ei crosses buffer boundary</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ie</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">ie</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="n">v</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">ie</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
