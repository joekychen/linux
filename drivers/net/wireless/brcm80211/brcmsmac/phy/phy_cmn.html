<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › brcm80211 › brcmsmac › phy › phy_cmn.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../../index.html"></a><h1>phy_cmn.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY</span>
<span class="cm"> * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION</span>
<span class="cm"> * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;brcm_hw_ids.h&gt;</span>
<span class="cp">#include &lt;chipcommon.h&gt;</span>
<span class="cp">#include &lt;aiutils.h&gt;</span>
<span class="cp">#include &lt;d11.h&gt;</span>
<span class="cp">#include &lt;phy_shim.h&gt;</span>
<span class="cp">#include &quot;phy_hal.h&quot;</span>
<span class="cp">#include &quot;phy_int.h&quot;</span>
<span class="cp">#include &quot;phy_radio.h&quot;</span>
<span class="cp">#include &quot;phy_lcn.h&quot;</span>
<span class="cp">#include &quot;phyreg_n.h&quot;</span>

<span class="cp">#define VALID_N_RADIO(radioid) ((radioid == BCM2055_ID) || \</span>
<span class="cp">				 (radioid == BCM2056_ID) || \</span>
<span class="cp">				 (radioid == BCM2057_ID))</span>

<span class="cp">#define VALID_LCN_RADIO(radioid)	(radioid == BCM2064_ID)</span>

<span class="cp">#define VALID_RADIO(pi, radioid)        ( \</span>
<span class="cp">		(ISNPHY(pi) ? VALID_N_RADIO(radioid) : false) || \</span>
<span class="cp">		(ISLCNPHY(pi) ? VALID_LCN_RADIO(radioid) : false))</span>

<span class="cm">/* basic mux operation - can be optimized on several architectures */</span>
<span class="cp">#define MUX(pred, true, false) ((pred) ? (true) : (false))</span>

<span class="cm">/* modulo inc/dec - assumes x E [0, bound - 1] */</span>
<span class="cp">#define MODINC(x, bound) MUX((x) == (bound) - 1, 0, (x) + 1)</span>

<span class="cm">/* modulo inc/dec, bound = 2^k */</span>
<span class="cp">#define MODDEC_POW2(x, bound) (((x) - 1) &amp; ((bound) - 1))</span>
<span class="cp">#define MODINC_POW2(x, bound) (((x) + 1) &amp; ((bound) - 1))</span>

<span class="k">struct</span> <span class="n">chan_info_basic</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">freq</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">chan_info_basic</span> <span class="n">chan_info_all</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2412</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2417</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2422</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2427</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2432</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2437</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2442</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2447</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2452</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2457</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">11</span><span class="p">,</span> <span class="mi">2462</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">2467</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">13</span><span class="p">,</span> <span class="mi">2472</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">2484</span><span class="p">},</span>

	<span class="p">{</span><span class="mi">34</span><span class="p">,</span> <span class="mi">5170</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">38</span><span class="p">,</span> <span class="mi">5190</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">42</span><span class="p">,</span> <span class="mi">5210</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">46</span><span class="p">,</span> <span class="mi">5230</span><span class="p">},</span>

	<span class="p">{</span><span class="mi">36</span><span class="p">,</span> <span class="mi">5180</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">40</span><span class="p">,</span> <span class="mi">5200</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">44</span><span class="p">,</span> <span class="mi">5220</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">48</span><span class="p">,</span> <span class="mi">5240</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">52</span><span class="p">,</span> <span class="mi">5260</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">56</span><span class="p">,</span> <span class="mi">5280</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">60</span><span class="p">,</span> <span class="mi">5300</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">64</span><span class="p">,</span> <span class="mi">5320</span><span class="p">},</span>

	<span class="p">{</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5500</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">104</span><span class="p">,</span> <span class="mi">5520</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">108</span><span class="p">,</span> <span class="mi">5540</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">112</span><span class="p">,</span> <span class="mi">5560</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">116</span><span class="p">,</span> <span class="mi">5580</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">120</span><span class="p">,</span> <span class="mi">5600</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">124</span><span class="p">,</span> <span class="mi">5620</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">128</span><span class="p">,</span> <span class="mi">5640</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">132</span><span class="p">,</span> <span class="mi">5660</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">136</span><span class="p">,</span> <span class="mi">5680</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">140</span><span class="p">,</span> <span class="mi">5700</span><span class="p">},</span>

	<span class="p">{</span><span class="mi">149</span><span class="p">,</span> <span class="mi">5745</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">153</span><span class="p">,</span> <span class="mi">5765</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">157</span><span class="p">,</span> <span class="mi">5785</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">161</span><span class="p">,</span> <span class="mi">5805</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">165</span><span class="p">,</span> <span class="mi">5825</span><span class="p">},</span>

	<span class="p">{</span><span class="mi">184</span><span class="p">,</span> <span class="mi">4920</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">188</span><span class="p">,</span> <span class="mi">4940</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">192</span><span class="p">,</span> <span class="mi">4960</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">196</span><span class="p">,</span> <span class="mi">4980</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">200</span><span class="p">,</span> <span class="mi">5000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">204</span><span class="p">,</span> <span class="mi">5020</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">208</span><span class="p">,</span> <span class="mi">5040</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">212</span><span class="p">,</span> <span class="mi">5060</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">216</span><span class="p">,</span> <span class="mi">5080</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ofdm_rate_lookup</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

	<span class="n">BRCM_RATE_48M</span><span class="p">,</span>
	<span class="n">BRCM_RATE_24M</span><span class="p">,</span>
	<span class="n">BRCM_RATE_12M</span><span class="p">,</span>
	<span class="n">BRCM_RATE_6M</span><span class="p">,</span>
	<span class="n">BRCM_RATE_54M</span><span class="p">,</span>
	<span class="n">BRCM_RATE_36M</span><span class="p">,</span>
	<span class="n">BRCM_RATE_18M</span><span class="p">,</span>
	<span class="n">BRCM_RATE_9M</span>
<span class="p">};</span>

<span class="cp">#define PHY_WREG_LIMIT  24</span>

<span class="kt">void</span> <span class="nf">wlc_phyreg_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="n">wlapi_bmac_ucode_wake_override_phyreg_set</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phyreg_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="n">wlapi_bmac_ucode_wake_override_phyreg_clear</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_radioreg_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="n">wlapi_bmac_mctrl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">MCTL_LOCK_RADIO</span><span class="p">,</span> <span class="n">MCTL_LOCK_RADIO</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_radioreg_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyversion</span><span class="p">));</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wlapi_bmac_mctrl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">MCTL_LOCK_RADIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">read_radio_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">==</span> <span class="n">RADIO_IDCODE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PHY_TYPE_N</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CONF_HAS</span><span class="p">(</span><span class="n">PHYTYPE</span><span class="p">,</span> <span class="n">PHY_TYPE_N</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NREV_GE</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">addr</span> <span class="o">|=</span> <span class="n">RADIO_2057_READ_OFF</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">addr</span> <span class="o">|=</span> <span class="n">RADIO_2055_READ_OFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PHY_TYPE_LCN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CONF_HAS</span><span class="p">(</span><span class="n">PHYTYPE</span><span class="p">,</span> <span class="n">PHY_TYPE_LCN</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">|=</span> <span class="n">RADIO_2064_READ_OFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">D11REV_GE</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">D11REV_IS</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>
	     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_type</span> <span class="o">!=</span> <span class="n">PHY_TYPE_SSN</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">radioregaddr</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">bcma_read16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">radioregdata</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phy4waddr</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">bcma_read16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phy4wdatalo</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_radio_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">D11REV_GE</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">D11REV_IS</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>
	     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_type</span> <span class="o">!=</span> <span class="n">PHY_TYPE_SSN</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">radioregaddr</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">bcma_write16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">radioregdata</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phy4waddr</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">bcma_write16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phy4wdatalo</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg</span> <span class="o">&gt;=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">));</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">read_radio_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">D11REV_GE</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">;</span>

		<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">radioregaddr</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b0</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bcma_read16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">radioregdata</span><span class="p">));</span>
		<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">radioregaddr</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bcma_read16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">radioregdata</span><span class="p">));</span>
		<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">radioregaddr</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bcma_read16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">radioregdata</span><span class="p">));</span>

		<span class="n">id</span> <span class="o">=</span> <span class="p">((</span><span class="n">b0</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">b2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">b1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">b0</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>
								      <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phy4waddr</span><span class="p">),</span> <span class="n">RADIO_IDCODE</span><span class="p">);</span>
		<span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bcma_read16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phy4wdatalo</span><span class="p">));</span>
		<span class="n">id</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bcma_read16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
					<span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phy4wdatahi</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">and_radio_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">read_radio_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">write_radio_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&amp;</span> <span class="n">val</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">or_radio_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">read_radio_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">write_radio_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">rval</span> <span class="o">|</span> <span class="n">val</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">xor_radio_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">read_radio_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">write_radio_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">rval</span> <span class="o">^</span> <span class="n">mask</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mod_radio_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">read_radio_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">write_radio_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_phy_channel_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">uint</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phychannel</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">read_phy_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregaddr</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bcma_read16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregdata</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_phy_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_BCM47XX</span>
	<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregaddr</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregdata</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mh">0x72</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyversion</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregaddr</span><span class="p">),</span> <span class="n">addr</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg</span> <span class="o">&gt;=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyversion</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">and_phy_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregaddr</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">bcma_mask16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregdata</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">or_phy_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregaddr</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">bcma_set16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregdata</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mod_phy_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregaddr</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">bcma_maskset16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregdata</span><span class="p">),</span> <span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wlc_set_phy_uninitted</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_vos</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nrssi_table_delta</span> <span class="o">=</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rc_cal</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mintxbias</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwridx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_spuravoid</span> <span class="o">=</span> <span class="n">SPURAVOID_DISABLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">NREV_GE</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="n">NREV_LT</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_spuravoid</span> <span class="o">=</span> <span class="n">SPURAVOID_AUTO</span><span class="p">;</span>

		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_papd_skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_papd_epsilon_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf588</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_papd_epsilon_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf588</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_txpwr_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_txpwr_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_txpwrindex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">index_internal</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_txpwrindex</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">index_internal</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_pabias</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_spuravoid</span> <span class="o">=</span> <span class="n">SPURAVOID_AUTO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">radiopwr</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STATIC_NUM_RF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">STATIC_NUM_BB</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">stats_11b_txpower</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">shared_phy</span> <span class="o">*</span><span class="nf">wlc_phy_shared_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">shared_phy_params</span> <span class="o">*</span><span class="n">shp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">shared_phy</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>

	<span class="n">sh</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shared_phy</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">sih</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">corerev</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">;</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">did</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">did</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">chiprev</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">chippkg</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">chippkg</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">sromrev</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">sromrev</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">boardtype</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">boardtype</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">boardrev</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">boardrev</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">boardflags</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">boardflags</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">boardflags2</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">boardflags2</span><span class="p">;</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">fast_timer</span> <span class="o">=</span> <span class="n">PHY_SW_TIMER_FAST</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">slow_timer</span> <span class="o">=</span> <span class="n">PHY_SW_TIMER_SLOW</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">glacial_timer</span> <span class="o">=</span> <span class="n">PHY_SW_TIMER_GLACIAL</span><span class="p">;</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">rssi_mode</span> <span class="o">=</span> <span class="n">RSSI_ANT_MERGE_MAX</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sh</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wlc_phy_timercb_phycal</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PHY_PERICAL_MPHASE_PENDING</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wlc_phy_cal_perical_mphase_reset</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SCAN_RM_IN_PROGRESS</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">||</span> <span class="n">PLT_INPROG_PHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">delay</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">wlc_phy_cal_perical_mphase_restart</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">wlc_phy_cal_perical_nphy_run</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">PHY_PERICAL_AUTO</span><span class="p">);</span>
		<span class="n">wlapi_add_timer</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_timer</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">wlc_phy_get_radio_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ver</span><span class="p">;</span>

	<span class="n">ver</span> <span class="o">=</span> <span class="n">read_radio_id</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ver</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span>
<span class="nf">wlc_phy_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">shared_phy</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">d11core</span><span class="p">,</span>
	       <span class="kt">int</span> <span class="n">bandtype</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">phyversion</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">D11REV_IS</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">sflags</span> <span class="o">=</span> <span class="n">SISF_2G_PHY</span> <span class="o">|</span> <span class="n">SISF_5G_PHY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sflags</span> <span class="o">=</span> <span class="n">bcma_aread32</span><span class="p">(</span><span class="n">d11core</span><span class="p">,</span> <span class="n">BCMA_IOST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SISF_5G_PHY</span> <span class="o">|</span> <span class="n">SISF_DB_PHY</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pi</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_head</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sflags</span> <span class="o">&amp;</span> <span class="n">SISF_DB_PHY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlapi_bmac_corereset</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">coreflags</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi_ro</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wiphy</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span> <span class="o">=</span> <span class="n">d11core</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">=</span> <span class="n">sh</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_init_por</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_wreg_limit</span> <span class="o">=</span> <span class="n">PHY_WREG_LIMIT</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_percent</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">do_initcal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_tempdelta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sflags</span> <span class="o">&amp;</span> <span class="n">SISF_2G_PHY</span><span class="p">))</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">coreflags</span> <span class="o">=</span> <span class="n">SICF_GMODE</span><span class="p">;</span>

	<span class="n">wlapi_bmac_corereset</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">coreflags</span><span class="p">);</span>
	<span class="n">phyversion</span> <span class="o">=</span> <span class="n">bcma_read16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyversion</span><span class="p">));</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">PHY_TYPE</span><span class="p">(</span><span class="n">phyversion</span><span class="p">);</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span> <span class="o">=</span> <span class="n">phyversion</span> <span class="o">&amp;</span> <span class="n">PV_PV_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">PHY_TYPE_LCNXN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">PHY_TYPE_N</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span> <span class="o">+=</span> <span class="n">LCNXN_BASEREV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_corenum</span> <span class="o">=</span> <span class="n">PHY_CORE_NUM_2</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">ana_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">phyversion</span> <span class="o">&amp;</span> <span class="n">PV_AV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PV_AV_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_type</span> <span class="o">!=</span> <span class="n">PHY_TYPE_N</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_type</span> <span class="o">!=</span> <span class="n">PHY_TYPE_LCN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlc_phy_anacore</span><span class="p">((</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="p">)</span> <span class="n">pi</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>

	<span class="n">idcode</span> <span class="o">=</span> <span class="n">wlc_phy_get_radio_ver</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">radioid</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">idcode</span> <span class="o">&amp;</span> <span class="n">IDCODE_ID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IDCODE_ID_SHIFT</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">radiorev</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">idcode</span> <span class="o">&amp;</span> <span class="n">IDCODE_REV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IDCODE_REV_SHIFT</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">radiover</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">idcode</span> <span class="o">&amp;</span> <span class="n">IDCODE_VER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IDCODE_VER_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">VALID_RADIO</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">radioid</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">wlc_phy_switch_radio</span><span class="p">((</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="p">)</span> <span class="n">pi</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

	<span class="n">wlc_set_phy_uninitted</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">bw</span> <span class="o">=</span> <span class="n">WL_CHANSPEC_BW_20</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">radio_chanspec</span> <span class="o">=</span> <span class="p">(</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span><span class="p">)</span> <span class="o">?</span>
			     <span class="n">ch20mhz_chspec</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">ch20mhz_chspec</span><span class="p">(</span><span class="mi">36</span><span class="p">);</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxiq_samps</span> <span class="o">=</span> <span class="n">PHY_NOISE_SAMPLE_LOG_NUM_NPHY</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxiq_antsel</span> <span class="o">=</span> <span class="n">ANT_RX_DIV_DEF</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">watchdog_override</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">cal_type_override</span> <span class="o">=</span> <span class="n">PHY_PERICAL_AUTO</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_saved_noisevars</span><span class="p">.</span><span class="n">bufcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">min_txpower</span> <span class="o">=</span> <span class="n">PHY_TXPWR_MIN_NPHY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">min_txpower</span> <span class="o">=</span> <span class="n">PHY_TXPWR_MIN</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phyrxchain</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rx2tx_biasentry</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_txcore_disable_temp</span> <span class="o">=</span> <span class="n">PHY_CHAIN_TX_DISABLE_TEMP</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_txcore_enable_temp</span> <span class="o">=</span>
		<span class="n">PHY_CHAIN_TX_DISABLE_TEMP</span> <span class="o">-</span> <span class="n">PHY_HYSTERESIS_DELTATEMP</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_tempsense_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_txcore_heatedup</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_lastcal_temp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">50</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_polling</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">||</span> <span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_polling</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TXP_NUM_RATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCMS_TXPWR_MAX</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_env_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCMS_TXPWR_MAX</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCMS_TXPWR_MAX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">radiopwr_override</span> <span class="o">=</span> <span class="n">RADIOPWR_OVERRIDE_DEF</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">user_txpwr_at_rfport</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_timer</span> <span class="o">=</span> <span class="n">wlapi_init_timer</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span>
						    <span class="n">wlc_phy_timercb_phycal</span><span class="p">,</span>
						    <span class="n">pi</span><span class="p">,</span> <span class="s">&quot;phycal&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_timer</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_phy_attach_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_phy_attach_lcnphy</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_head</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_head</span> <span class="o">=</span> <span class="n">pi</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi_ro</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span><span class="p">));</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi_ro</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pih</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_timer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wlapi_free_timer</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_timer</span><span class="p">);</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_timer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_head</span> <span class="o">==</span> <span class="n">pi</span><span class="p">)</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_head</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_head</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">pi</span><span class="p">)</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_head</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pi_fptr</span><span class="p">.</span><span class="n">detach</span><span class="p">)</span>
			<span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pi_fptr</span><span class="p">.</span><span class="n">detach</span><span class="p">)(</span><span class="n">pi</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">bool</span>
<span class="nf">wlc_phy_get_phyversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">phytype</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">phyrev</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="o">*</span><span class="n">radioid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">radiover</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="o">*</span><span class="n">phytype</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_type</span><span class="p">;</span>
	<span class="o">*</span><span class="n">phyrev</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span><span class="p">;</span>
	<span class="o">*</span><span class="n">radioid</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">radioid</span><span class="p">;</span>
	<span class="o">*</span><span class="n">radiover</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">radiorev</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">wlc_phy_get_encore</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">abgphy_encore</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">wlc_phy_get_coreflags</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">coreflags</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_anacore</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NREV_GE</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">);</span>
				<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
				<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">);</span>
				<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NREV_GE</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x07ff</span><span class="p">);</span>
				<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x0fd</span><span class="p">);</span>
				<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x07ff</span><span class="p">);</span>
				<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x0fd</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">and_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x43b</span><span class="p">,</span>
				    <span class="o">~</span><span class="p">((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">or_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x43c</span><span class="p">,</span>
				   <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
			<span class="n">or_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x43b</span><span class="p">,</span>
				   <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">wlc_phy_clk_bwbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">phy_bw_clkbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">||</span> <span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">bw</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WL_CHANSPEC_BW_10</span>:
			<span class="n">phy_bw_clkbits</span> <span class="o">=</span> <span class="n">SICF_BW10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WL_CHANSPEC_BW_20</span>:
			<span class="n">phy_bw_clkbits</span> <span class="o">=</span> <span class="n">SICF_BW20</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WL_CHANSPEC_BW_40</span>:
			<span class="n">phy_bw_clkbits</span> <span class="o">=</span> <span class="n">SICF_BW40</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">phy_bw_clkbits</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_por_inform</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_init_por</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_edcrs_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">bool</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">edcrs_threshold_lock</span> <span class="o">=</span> <span class="n">lock</span><span class="p">;</span>

	<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x22c</span><span class="p">,</span> <span class="mh">0x46b</span><span class="p">);</span>
	<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x22d</span><span class="p">,</span> <span class="mh">0x46b</span><span class="p">);</span>
	<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x22e</span><span class="p">,</span> <span class="mh">0x3c0</span><span class="p">);</span>
	<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x22f</span><span class="p">,</span> <span class="mh">0x3c0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_initcal_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">bool</span> <span class="n">initcal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">do_initcal</span> <span class="o">=</span> <span class="n">initcal</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_hw_clk_state_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">bool</span> <span class="n">newstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span> <span class="o">||</span> <span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">newstate</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_hw_state_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">bool</span> <span class="n">newstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span> <span class="o">||</span> <span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="n">newstate</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">phy_init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">init_in_progress</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">init_in_progress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">radio_chanspec</span> <span class="o">=</span> <span class="n">chanspec</span><span class="p">;</span>

	<span class="n">mc</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">MCTL_EN_MAC</span><span class="p">,</span> <span class="s">&quot;HW error MAC running on init&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">measure_hold</span> <span class="o">&amp;</span> <span class="n">PHY_HOLD_FOR_SCAN</span><span class="p">))</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">measure_hold</span> <span class="o">|=</span> <span class="n">PHY_HOLD_FOR_NOT_ASSOC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcma_aread32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">BCMA_IOST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SISF_FCLKA</span><span class="p">),</span>
		 <span class="s">&quot;HW error SISF_FCLKA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">phy_init</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pi_fptr</span><span class="p">.</span><span class="n">init</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_init</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wlc_phy_anacore</span><span class="p">(</span><span class="n">pih</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHSPEC_BW</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">radio_chanspec</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">bw</span><span class="p">)</span>
		<span class="n">wlapi_bmac_bw_set</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span>
				  <span class="n">CHSPEC_BW</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">radio_chanspec</span><span class="p">));</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_gain_boost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">wlc_phy_switch_radio</span><span class="p">((</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="p">)</span> <span class="n">pi</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>

	<span class="p">(</span><span class="o">*</span><span class="n">phy_init</span><span class="p">)(</span><span class="n">pi</span><span class="p">);</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_init_por</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">D11REV_IS</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">||</span> <span class="n">D11REV_IS</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
		<span class="n">wlc_phy_do_dummy_tx</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)))</span>
		<span class="n">wlc_phy_txpower_update_shm</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

	<span class="n">wlc_phy_ant_rxdiv_set</span><span class="p">((</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="p">)</span> <span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">rx_antdiv</span><span class="p">);</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">init_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_cal_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cal_init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">))</span> <span class="o">&amp;</span>
		  <span class="n">MCTL_EN_MAC</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;HW error: MAC enabled during phy cal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cal_init</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pi_fptr</span><span class="p">.</span><span class="n">calinit</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cal_init</span><span class="p">)</span>
			<span class="p">(</span><span class="o">*</span><span class="n">cal_init</span><span class="p">)(</span><span class="n">pi</span><span class="p">);</span>

		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wlc_phy_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_timer</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wlapi_del_timer</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_timer</span><span class="p">))</span>
		<span class="n">callbacks</span><span class="o">++</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_iqcal_chanspec_2G</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_iqcal_chanspec_5G</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">callbacks</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">wlc_phy_table_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">uint</span> <span class="n">tbl_id</span><span class="p">,</span> <span class="n">uint</span> <span class="n">tbl_offset</span><span class="p">,</span>
		   <span class="n">u16</span> <span class="n">tblAddr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tblDataHi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tblDataLo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblAddr</span><span class="p">,</span> <span class="p">(</span><span class="n">tbl_id</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">tbl_offset</span><span class="p">);</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_data_hi</span> <span class="o">=</span> <span class="n">tblDataHi</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_data_lo</span> <span class="o">=</span> <span class="n">tblDataLo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">BCM43224_CHIP_ID</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_addr</span> <span class="o">=</span> <span class="n">tblAddr</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_save_id</span> <span class="o">=</span> <span class="n">tbl_id</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_save_offset</span> <span class="o">=</span> <span class="n">tbl_offset</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_table_data_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">uint</span> <span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">BCM43224_CHIP_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_save_id</span> <span class="o">==</span> <span class="n">NPHY_TBL_ID_ANTSWCTRLLUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">read_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_data_lo</span><span class="p">);</span>

		<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_addr</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_save_id</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_save_offset</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_save_offset</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_data_hi</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_data_lo</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tbl_data_lo</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">wlc_phy_write_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phytbl_info</span> <span class="o">*</span><span class="n">ptbl_info</span><span class="p">,</span>
		    <span class="n">u16</span> <span class="n">tblAddr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tblDataHi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tblDataLo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">tbl_id</span> <span class="o">=</span> <span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_id</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">tbl_offset</span> <span class="o">=</span> <span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_offset</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">tbl_width</span> <span class="o">=</span> <span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_width</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ptbl_8b</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_ptr</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ptbl_16b</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_ptr</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ptbl_32b</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_ptr</span><span class="p">;</span>

	<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblAddr</span><span class="p">,</span> <span class="p">(</span><span class="n">tbl_id</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">tbl_offset</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_len</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">BCM43224_CHIP_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tbl_id</span> <span class="o">==</span> <span class="n">NPHY_TBL_ID_ANTSWCTRLLUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">read_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblDataLo</span><span class="p">);</span>

			<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblAddr</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">tbl_id</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tbl_offset</span> <span class="o">+</span> <span class="n">idx</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tbl_width</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblDataHi</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ptbl_32b</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
			<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblDataLo</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">ptbl_32b</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tbl_width</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblDataLo</span><span class="p">,</span> <span class="n">ptbl_16b</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblDataLo</span><span class="p">,</span> <span class="n">ptbl_8b</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">wlc_phy_read_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phytbl_info</span> <span class="o">*</span><span class="n">ptbl_info</span><span class="p">,</span>
		   <span class="n">u16</span> <span class="n">tblAddr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tblDataHi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tblDataLo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">tbl_id</span> <span class="o">=</span> <span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_id</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">tbl_offset</span> <span class="o">=</span> <span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_offset</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">tbl_width</span> <span class="o">=</span> <span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_width</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptbl_8b</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_ptr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">ptbl_16b</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ptbl_32b</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_ptr</span><span class="p">;</span>

	<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblAddr</span><span class="p">,</span> <span class="p">(</span><span class="n">tbl_id</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">tbl_offset</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ptbl_info</span><span class="o">-&gt;</span><span class="n">tbl_len</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">BCM43224_CHIP_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">read_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblDataLo</span><span class="p">);</span>

			<span class="n">write_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblAddr</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">tbl_id</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tbl_offset</span> <span class="o">+</span> <span class="n">idx</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tbl_width</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ptbl_32b</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblDataLo</span><span class="p">);</span>
			<span class="n">ptbl_32b</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">read_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblDataHi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tbl_width</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ptbl_16b</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblDataLo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ptbl_8b</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">read_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">tblDataLo</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">uint</span>
<span class="nf">wlc_phy_init_radio_regs_allbands</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">radio_20xx_regs</span> <span class="o">*</span><span class="n">radioregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radioregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">do_init</span><span class="p">)</span>
			<span class="n">write_radio_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">radioregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">radioregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">init</span><span class="p">);</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">radioregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">uint</span>
<span class="nf">wlc_phy_init_radio_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">radio_regs</span> <span class="o">*</span><span class="n">radioregs</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">core_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHSPEC_IS5G</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">radio_chanspec</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radioregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">do_init_a</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">write_radio_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span>
						<span class="n">radioregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						<span class="n">address</span> <span class="o">|</span> <span class="n">core_offset</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">radioregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">init_a</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
					<span class="n">BRCMS_PHY_WAR_PR51571</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">radioregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">do_init_g</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">write_radio_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span>
						<span class="n">radioregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						<span class="n">address</span> <span class="o">|</span> <span class="n">core_offset</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">radioregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">init_g</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
					<span class="n">BRCMS_PHY_WAR_PR51571</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">radioregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_do_dummy_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ofdm</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pa_on</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define DUMMY_PKT_LEN   20</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ofdmpkt</span><span class="p">[</span><span class="n">DUMMY_PKT_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">cckpkt</span><span class="p">[</span><span class="n">DUMMY_PKT_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">dummypkt</span><span class="p">;</span>

	<span class="n">dummypkt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ofdm</span> <span class="o">?</span> <span class="n">ofdmpkt</span> <span class="o">:</span> <span class="n">cckpkt</span><span class="p">);</span>
	<span class="n">wlapi_bmac_write_template_ram</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DUMMY_PKT_LEN</span><span class="p">,</span>
				      <span class="n">dummypkt</span><span class="p">);</span>

	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">xmtsel</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">D11REV_GE</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
		<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">wepctl</span><span class="p">),</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">wepctl</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">txe_phyctl</span><span class="p">),</span>
		     <span class="p">(</span><span class="n">ofdm</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHY_TXC_ANT_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">||</span> <span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">txe_phyctl1</span><span class="p">),</span> <span class="mh">0x1A02</span><span class="p">);</span>

	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">txe_wm_0</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">txe_wm_1</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">xmttplatetxptr</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">xmttxcnt</span><span class="p">),</span> <span class="n">DUMMY_PKT_LEN</span><span class="p">);</span>

	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">xmtsel</span><span class="p">),</span>
		     <span class="p">((</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">txe_ctl</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pa_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
			<span class="n">wlc_phy_pa_override_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">||</span> <span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">txe_aux</span><span class="p">),</span> <span class="mh">0xD0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">txe_aux</span><span class="p">),</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)));</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">txe_aux</span><span class="p">));</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">ofdm</span> <span class="o">?</span> <span class="mi">30</span> <span class="o">:</span> <span class="mi">250</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span>
	       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bcma_read16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">txe_status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">((</span><span class="n">bcma_read16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">txe_status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">((</span><span class="n">bcma_read16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">ifsstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pa_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
			<span class="n">wlc_phy_pa_override_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_hold_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span>
		<span class="n">mboolset</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">measure_hold</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mboolclr</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">measure_hold</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_mute_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mute</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mute</span><span class="p">)</span>
		<span class="n">mboolset</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">measure_hold</span><span class="p">,</span> <span class="n">PHY_HOLD_FOR_MUTE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mboolclr</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">measure_hold</span><span class="p">,</span> <span class="n">PHY_HOLD_FOR_MUTE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mute</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PHY_MUTE_FOR_PREISM</span><span class="p">))</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_perical_last</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">-</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">glacial_timer</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_clear_tssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_B_TSSI_0</span><span class="p">,</span> <span class="n">NULL_TSSI_W</span><span class="p">);</span>
		<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_B_TSSI_1</span><span class="p">,</span> <span class="n">NULL_TSSI_W</span><span class="p">);</span>
		<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_G_TSSI_0</span><span class="p">,</span> <span class="n">NULL_TSSI_W</span><span class="p">);</span>
		<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_G_TSSI_1</span><span class="p">,</span> <span class="n">NULL_TSSI_W</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">wlc_phy_cal_txpower_recalc_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_switch_radio</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wlc_phy_switch_radio_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">and_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x44c</span><span class="p">,</span>
				    <span class="o">~</span><span class="p">((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				      <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span>
				      <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)));</span>
			<span class="n">and_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x4b0</span><span class="p">,</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)));</span>
			<span class="n">and_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x4f9</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">and_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x44d</span><span class="p">,</span>
				    <span class="o">~</span><span class="p">((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
				      <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span>
				      <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)));</span>
			<span class="n">or_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x44c</span><span class="p">,</span>
				   <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>

			<span class="n">and_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x4b7</span><span class="p">,</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x7f</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
			<span class="n">and_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x4b1</span><span class="p">,</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)));</span>
			<span class="n">or_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x4b0</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>
			<span class="n">and_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x4fa</span><span class="p">,</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)));</span>
			<span class="n">or_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x4f9</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">wlc_phy_bw_state_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">bw</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_bw_state_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">bw</span> <span class="o">=</span> <span class="n">bw</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_chanspec_radio_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">newch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">radio_chanspec</span> <span class="o">=</span> <span class="n">newch</span><span class="p">;</span>

<span class="p">}</span>

<span class="n">u16</span> <span class="nf">wlc_phy_chanspec_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">radio_chanspec</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_chanspec_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">m_cur_channel</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">chanspec_set</span><span class="p">)(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">m_cur_channel</span> <span class="o">=</span> <span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHSPEC_IS5G</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span>
		<span class="n">m_cur_channel</span> <span class="o">|=</span> <span class="n">D11_CURCHANNEL_5G</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHSPEC_IS40</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span>
		<span class="n">m_cur_channel</span> <span class="o">|=</span> <span class="n">D11_CURCHANNEL_40</span><span class="p">;</span>
	<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_CURCHANNEL</span><span class="p">,</span> <span class="n">m_cur_channel</span><span class="p">);</span>

	<span class="n">chanspec_set</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pi_fptr</span><span class="p">.</span><span class="n">chanset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanspec_set</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">chanspec_set</span><span class="p">)(</span><span class="n">pi</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wlc_phy_chanspec_freq2bandrange_lpssn</span><span class="p">(</span><span class="n">uint</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">range</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">2500</span><span class="p">)</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">WL_CHAN_FREQ_RANGE_2G</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;=</span> <span class="mi">5320</span><span class="p">)</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">WL_CHAN_FREQ_RANGE_5GL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;=</span> <span class="mi">5700</span><span class="p">)</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">WL_CHAN_FREQ_RANGE_5GM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">WL_CHAN_FREQ_RANGE_5GH</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">range</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wlc_phy_chanspec_bandrange_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">range</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">uint</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">wlc_phy_channel2freq</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">wlc_phy_get_chan_freq_range_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">wlc_phy_chanspec_freq2bandrange_lpssn</span><span class="p">(</span><span class="n">freq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">range</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_chanspec_ch14_widefilter_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span>
					  <span class="n">bool</span> <span class="n">wide_filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">channel_14_wide_filter</span> <span class="o">=</span> <span class="n">wide_filter</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wlc_phy_channel2freq</span><span class="p">(</span><span class="n">uint</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chan_info_all</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan_info_all</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chan</span> <span class="o">==</span> <span class="n">channel</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">chan_info_all</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">wlc_phy_chanspec_band_validch</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">uint</span> <span class="n">band</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="o">*</span><span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_chanvec</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chan_info_all</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">chan_info_all</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chan</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">a_band_high_disable</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">FIRST_REF5_CHANNUM</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="n">LAST_REF5_CHANNUM</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">band</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span> <span class="o">&amp;&amp;</span> <span class="n">channel</span> <span class="o">&lt;=</span> <span class="n">CH_MAX_2G_CHANNEL</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span> <span class="o">&amp;&amp;</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="n">CH_MAX_2G_CHANNEL</span><span class="p">))</span>
			<span class="n">setbit</span><span class="p">(</span><span class="n">channels</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">wlc_phy_chanspec_band_firstch</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">uint</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">chspec</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chan_info_all</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">chan_info_all</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chan</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">bw</span> <span class="o">==</span> <span class="n">WL_CHANSPEC_BW_40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uint</span> <span class="n">j</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chan_info_all</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">chan_info_all</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">chan</span> <span class="o">==</span>
				    <span class="n">channel</span> <span class="o">+</span> <span class="n">CH_10MHZ_APART</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chan_info_all</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">channel</span> <span class="o">=</span> <span class="n">upper_20_sb</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
			<span class="n">chspec</span> <span class="o">=</span>  <span class="n">channel</span> <span class="o">|</span> <span class="n">WL_CHANSPEC_BW_40</span> <span class="o">|</span>
				  <span class="n">WL_CHANSPEC_CTL_SB_LOWER</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span><span class="p">)</span>
				<span class="n">chspec</span> <span class="o">|=</span> <span class="n">WL_CHANSPEC_BAND_2G</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">chspec</span> <span class="o">|=</span> <span class="n">WL_CHANSPEC_BAND_5G</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">chspec</span> <span class="o">=</span> <span class="n">ch20mhz_chspec</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">a_band_high_disable</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">FIRST_REF5_CHANNUM</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="n">LAST_REF5_CHANNUM</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">band</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span> <span class="o">&amp;&amp;</span> <span class="n">channel</span> <span class="o">&lt;=</span> <span class="n">CH_MAX_2G_CHANNEL</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span> <span class="o">&amp;&amp;</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="n">CH_MAX_2G_CHANNEL</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">chspec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">INVCHANSPEC</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wlc_phy_txpower_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">uint</span> <span class="o">*</span><span class="n">qdbm</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">override</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="o">*</span><span class="n">qdbm</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">override</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">override</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwroverride</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_txpower_target_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">txpwr_limits</span> <span class="o">*</span><span class="n">txpwr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">mac_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">TXP_FIRST_CCK</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">cck</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BRCMS_NUM_RATES_CCK</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">TXP_FIRST_OFDM</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">TXP_FIRST_OFDM_20_CDD</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_cdd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">TXP_FIRST_OFDM_40_SISO</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_siso</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">TXP_FIRST_OFDM_40_CDD</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_cdd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">TXP_FIRST_MCS_20_SISO</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_siso</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">TXP_FIRST_MCS_20_CDD</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_cdd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">TXP_FIRST_MCS_20_STBC</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_stbc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">TXP_FIRST_MCS_20_SDM</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_mimo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BRCMS_NUM_RATES_MCS_2_STREAM</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">TXP_FIRST_MCS_40_SISO</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_siso</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">TXP_FIRST_MCS_40_CDD</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_cdd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">TXP_FIRST_MCS_40_STBC</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_stbc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">TXP_FIRST_MCS_40_SDM</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_mimo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BRCMS_NUM_RATES_MCS_2_STREAM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">MCTL_EN_MAC</span><span class="p">)</span>
		<span class="n">mac_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_enabled</span><span class="p">)</span>
		<span class="n">wlapi_suspend_mac_and_wait</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>

	<span class="n">wlc_phy_txpower_recalc_target</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="n">wlc_phy_cal_txpower_recalc_sw</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_enabled</span><span class="p">)</span>
		<span class="n">wlapi_enable_mac</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wlc_phy_txpower_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">uint</span> <span class="n">qdbm</span><span class="p">,</span> <span class="n">bool</span> <span class="n">override</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdbm</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TXP_NUM_RATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">qdbm</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwroverride</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SCAN_INPROG_PHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bool</span> <span class="n">suspend</span><span class="p">;</span>

			<span class="n">suspend</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
						     <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">))</span> <span class="o">&amp;</span>
					 <span class="n">MCTL_EN_MAC</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">suspend</span><span class="p">)</span>
				<span class="n">wlapi_suspend_mac_and_wait</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>

			<span class="n">wlc_phy_txpower_recalc_target</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
			<span class="n">wlc_phy_cal_txpower_recalc_sw</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">suspend</span><span class="p">)</span>
				<span class="n">wlapi_enable_mac</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">wlc_phy_txpower_sromlimit</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">uint</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">min_pwr</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">*</span><span class="n">max_pwr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txp_rate_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>

	<span class="o">*</span><span class="n">min_pwr</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">min_txpower</span> <span class="o">*</span> <span class="n">BRCMS_TXPWR_DB_FACTOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txp_rate_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">txp_rate_idx</span> <span class="o">=</span> <span class="n">TXP_FIRST_CCK</span><span class="p">;</span>
		<span class="n">wlc_phy_txpower_sromlimit_get_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">max_pwr</span><span class="p">,</span>
						   <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">txp_rate_idx</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="n">CH_MAX_2G_CHANNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txp_rate_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">txp_rate_idx</span> <span class="o">=</span> <span class="n">TXP_FIRST_CCK</span><span class="p">;</span>
		<span class="o">*</span><span class="n">max_pwr</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_srom_max_rate_2g</span><span class="p">[</span><span class="n">txp_rate_idx</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="o">*</span><span class="n">max_pwr</span> <span class="o">=</span> <span class="n">BRCMS_TXPWR_MAX</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txp_rate_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">txp_rate_idx</span> <span class="o">=</span> <span class="n">TXP_FIRST_OFDM</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chan_info_all</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">chan_info_all</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chan</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">hwtxpwr</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">max_pwr</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">hwtxpwr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">FIRST_MID_5G_CHAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">LAST_MID_5G_CHAN</span><span class="p">))</span>
				<span class="o">*</span><span class="n">max_pwr</span> <span class="o">=</span>
				    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_srom_max_rate_5g_mid</span><span class="p">[</span><span class="n">txp_rate_idx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">FIRST_HIGH_5G_CHAN</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">LAST_HIGH_5G_CHAN</span><span class="p">))</span>
				<span class="o">*</span><span class="n">max_pwr</span> <span class="o">=</span>
				    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_srom_max_rate_5g_hi</span><span class="p">[</span><span class="n">txp_rate_idx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">FIRST_LOW_5G_CHAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">LAST_LOW_5G_CHAN</span><span class="p">))</span>
				<span class="o">*</span><span class="n">max_pwr</span> <span class="o">=</span>
				    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_srom_max_rate_5g_low</span><span class="p">[</span><span class="n">txp_rate_idx</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">wlc_phy_txpower_sromlimit_max_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">uint</span> <span class="n">chan</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="o">*</span><span class="n">max_txpwr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">min_txpwr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_pwr_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_pwr_min</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_num_rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">maxtxpwr</span><span class="p">,</span> <span class="n">mintxpwr</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">pactrl</span><span class="p">;</span>

	<span class="n">pactrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">max_num_rate</span> <span class="o">=</span> <span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">?</span> <span class="n">TXP_NUM_RATES</span> <span class="o">:</span>
		       <span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">TXP_LAST_SISO_MCS_20</span> <span class="o">+</span>
				       <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">TXP_LAST_OFDM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rate</span> <span class="o">&lt;</span> <span class="n">max_num_rate</span><span class="p">;</span> <span class="n">rate</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">wlc_phy_txpower_sromlimit</span><span class="p">(</span><span class="n">ppi</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mintxpwr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maxtxpwr</span><span class="p">,</span>
					  <span class="n">rate</span><span class="p">);</span>

		<span class="n">maxtxpwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxtxpwr</span> <span class="o">&gt;</span> <span class="n">pactrl</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">maxtxpwr</span> <span class="o">-</span> <span class="n">pactrl</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">maxtxpwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxtxpwr</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">maxtxpwr</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">tx_pwr_max</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">tx_pwr_max</span><span class="p">,</span> <span class="n">maxtxpwr</span><span class="p">);</span>
		<span class="n">tx_pwr_min</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">tx_pwr_min</span><span class="p">,</span> <span class="n">maxtxpwr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">max_txpwr</span> <span class="o">=</span> <span class="n">tx_pwr_max</span><span class="p">;</span>
	<span class="o">*</span><span class="n">min_txpwr</span> <span class="o">=</span> <span class="n">tx_pwr_min</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">wlc_phy_txpower_boardlimit_band</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">uint</span> <span class="n">bandunit</span><span class="p">,</span>
				<span class="n">s32</span> <span class="o">*</span><span class="n">max_pwr</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">min_pwr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">step_pwr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">wlc_phy_txpower_get_target_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_min</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">wlc_phy_txpower_get_target_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_max</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s8</span> <span class="nf">wlc_phy_env_measure_vbat</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">wlc_lcnphy_vbatsense</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s8</span> <span class="nf">wlc_phy_env_measure_temperature</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">wlc_lcnphy_tempsense_degree</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wlc_phy_upd_env_txpwr_rate_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">temp</span><span class="p">,</span> <span class="n">vbat</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TXP_NUM_RATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_env_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCMS_TXPWR_MAX</span><span class="p">;</span>

	<span class="n">vbat</span> <span class="o">=</span> <span class="n">wlc_phy_env_measure_vbat</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">wlc_phy_env_measure_temperature</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">s8</span>
<span class="nf">wlc_user_txpwr_antport_to_rfport</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">uint</span> <span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">band</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">user_txpwr_at_rfport</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_txpower_recalc_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">maxtxpwr</span><span class="p">,</span> <span class="n">mintxpwr</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">pactrl</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">target_chan</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_pwr_target</span><span class="p">[</span><span class="n">TXP_NUM_RATES</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">tx_pwr_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_pwr_min</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_pwr_max_rate_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_num_rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">start_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">chspec</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">band</span> <span class="o">=</span> <span class="n">CHSPEC2BAND</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">radio_chanspec</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">txpwr_recalc_fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">chspec</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">radio_chanspec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHSPEC_CTL_SB</span><span class="p">(</span><span class="n">chspec</span><span class="p">)</span> <span class="o">==</span> <span class="n">WL_CHANSPEC_CTL_SB_NONE</span><span class="p">)</span>
		<span class="n">target_chan</span> <span class="o">=</span> <span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">chspec</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHSPEC_CTL_SB</span><span class="p">(</span><span class="n">chspec</span><span class="p">)</span> <span class="o">==</span> <span class="n">WL_CHANSPEC_CTL_SB_UPPER</span><span class="p">)</span>
		<span class="n">target_chan</span> <span class="o">=</span> <span class="n">upper_20_sb</span><span class="p">(</span><span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">chspec</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">target_chan</span> <span class="o">=</span> <span class="n">lower_20_sb</span><span class="p">(</span><span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">chspec</span><span class="p">));</span>

	<span class="n">pactrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">offset_mcs</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHSPEC_IS40</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">radio_chanspec</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">offset_mcs</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mcs40_po</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">TXP_FIRST_SISO_MCS_20</span><span class="p">;</span>
			     <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">TXP_LAST_SISO_MCS_20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_srom_max_rate_2g</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_srom_max_2g</span> <span class="o">-</span>
					<span class="p">((</span><span class="n">offset_mcs</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">offset_mcs</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">offset_mcs</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mcs20_po</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">TXP_FIRST_SISO_MCS_20</span><span class="p">;</span>
			     <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">TXP_LAST_SISO_MCS_20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_srom_max_rate_2g</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_srom_max_2g</span> <span class="o">-</span>
					<span class="p">((</span><span class="n">offset_mcs</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">offset_mcs</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">max_num_rate</span> <span class="o">=</span> <span class="p">((</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="o">?</span> <span class="p">(</span><span class="n">TXP_NUM_RATES</span><span class="p">)</span> <span class="o">:</span>
			<span class="p">((</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="o">?</span>
			 <span class="p">(</span><span class="n">TXP_LAST_SISO_MCS_20</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">TXP_LAST_OFDM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)));</span>

	<span class="n">wlc_phy_upd_env_txpwr_rate_limits</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rate</span> <span class="o">=</span> <span class="n">start_rate</span><span class="p">;</span> <span class="n">rate</span> <span class="o">&lt;</span> <span class="n">max_num_rate</span><span class="p">;</span> <span class="n">rate</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">tx_pwr_target</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">rate</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">user_txpwr_at_rfport</span><span class="p">)</span>
			<span class="n">tx_pwr_target</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">+=</span>
				<span class="n">wlc_user_txpwr_antport_to_rfport</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span>
								 <span class="n">target_chan</span><span class="p">,</span>
								 <span class="n">band</span><span class="p">,</span>
								 <span class="n">rate</span><span class="p">);</span>

		<span class="n">wlc_phy_txpower_sromlimit</span><span class="p">((</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="p">)</span> <span class="n">pi</span><span class="p">,</span>
					  <span class="n">target_chan</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">mintxpwr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maxtxpwr</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

		<span class="n">maxtxpwr</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">maxtxpwr</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">rate</span><span class="p">]);</span>

		<span class="n">maxtxpwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxtxpwr</span> <span class="o">&gt;</span> <span class="n">pactrl</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">maxtxpwr</span> <span class="o">-</span> <span class="n">pactrl</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">maxtxpwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxtxpwr</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">maxtxpwr</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">maxtxpwr</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">maxtxpwr</span><span class="p">,</span> <span class="n">tx_pwr_target</span><span class="p">[</span><span class="n">rate</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_percent</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">maxtxpwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxtxpwr</span> <span class="o">*</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_percent</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>

		<span class="n">tx_pwr_target</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">maxtxpwr</span><span class="p">,</span> <span class="n">mintxpwr</span><span class="p">);</span>

		<span class="n">tx_pwr_target</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">min</span><span class="p">(</span><span class="n">tx_pwr_target</span><span class="p">[</span><span class="n">rate</span><span class="p">],</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_env_limit</span><span class="p">[</span><span class="n">rate</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tx_pwr_target</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tx_pwr_max</span><span class="p">)</span>
			<span class="n">tx_pwr_max_rate_ind</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

		<span class="n">tx_pwr_max</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">tx_pwr_max</span><span class="p">,</span> <span class="n">tx_pwr_target</span><span class="p">[</span><span class="n">rate</span><span class="p">]);</span>
		<span class="n">tx_pwr_min</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">tx_pwr_min</span><span class="p">,</span> <span class="n">tx_pwr_target</span><span class="p">[</span><span class="n">rate</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_offset</span><span class="p">));</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_max</span> <span class="o">=</span> <span class="n">tx_pwr_max</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_min</span> <span class="o">=</span> <span class="n">tx_pwr_min</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_max_rate_ind</span> <span class="o">=</span> <span class="n">tx_pwr_max_rate_ind</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rate</span> <span class="o">&lt;</span> <span class="n">max_num_rate</span><span class="p">;</span> <span class="n">rate</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_target</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx_pwr_target</span><span class="p">[</span><span class="n">rate</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">hwpwrctrl</span> <span class="o">||</span> <span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_offset</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_max</span> <span class="o">-</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_target</span><span class="p">[</span><span class="n">rate</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_offset</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_target</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">-</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_min</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txpwr_recalc_fn</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pi_fptr</span><span class="p">.</span><span class="n">txpwrrecalc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txpwr_recalc_fn</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">txpwr_recalc_fn</span><span class="p">)(</span><span class="n">pi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">wlc_phy_txpower_reg_limit_calc</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">txpwr_limits</span> <span class="o">*</span><span class="n">txpwr</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp_txpwr_limit</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">txpwr_ptr1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">txpwr_ptr2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_start_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rate1</span><span class="p">,</span> <span class="n">rate2</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rate1</span> <span class="o">=</span> <span class="n">WL_TX_POWER_CCK_FIRST</span><span class="p">,</span> <span class="n">rate2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">rate2</span> <span class="o">&lt;</span> <span class="n">WL_TX_POWER_CCK_NUM</span><span class="p">;</span> <span class="n">rate1</span><span class="o">++</span><span class="p">,</span> <span class="n">rate2</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">rate1</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">cck</span><span class="p">[</span><span class="n">rate2</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rate1</span> <span class="o">=</span> <span class="n">WL_TX_POWER_OFDM_FIRST</span><span class="p">,</span> <span class="n">rate2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">rate2</span> <span class="o">&lt;</span> <span class="n">WL_TX_POWER_OFDM_NUM</span><span class="p">;</span> <span class="n">rate1</span><span class="o">++</span><span class="p">,</span> <span class="n">rate2</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">rate1</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm</span><span class="p">[</span><span class="n">rate2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:

				<span class="n">txpwr_ptr1</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_siso</span><span class="p">;</span>
				<span class="n">txpwr_ptr2</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm</span><span class="p">;</span>
				<span class="n">rate_start_index</span> <span class="o">=</span> <span class="n">WL_TX_POWER_OFDM_FIRST</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:

				<span class="n">txpwr_ptr1</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_cdd</span><span class="p">;</span>
				<span class="n">txpwr_ptr2</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_cdd</span><span class="p">;</span>
				<span class="n">rate_start_index</span> <span class="o">=</span> <span class="n">WL_TX_POWER_OFDM20_CDD_FIRST</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:

				<span class="n">txpwr_ptr1</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_siso</span><span class="p">;</span>
				<span class="n">txpwr_ptr2</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_siso</span><span class="p">;</span>
				<span class="n">rate_start_index</span> <span class="o">=</span>
					<span class="n">WL_TX_POWER_OFDM40_SISO_FIRST</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:

				<span class="n">txpwr_ptr1</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_cdd</span><span class="p">;</span>
				<span class="n">txpwr_ptr2</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_cdd</span><span class="p">;</span>
				<span class="n">rate_start_index</span> <span class="o">=</span> <span class="n">WL_TX_POWER_OFDM40_CDD_FIRST</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">rate2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rate2</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">;</span>
			     <span class="n">rate2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp_txpwr_limit</span><span class="p">[</span><span class="n">rate2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">tmp_txpwr_limit</span><span class="p">[</span><span class="n">BRCMS_NUM_RATES_OFDM</span> <span class="o">+</span> <span class="n">rate2</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">txpwr_ptr1</span><span class="p">[</span><span class="n">rate2</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="n">wlc_phy_mcs_to_ofdm_powers_nphy</span><span class="p">(</span>
				<span class="n">tmp_txpwr_limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">BRCMS_NUM_RATES_OFDM</span> <span class="o">-</span>
				<span class="mi">1</span><span class="p">,</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">rate1</span> <span class="o">=</span> <span class="n">rate_start_index</span><span class="p">,</span> <span class="n">rate2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			     <span class="n">rate2</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">;</span> <span class="n">rate1</span><span class="o">++</span><span class="p">,</span> <span class="n">rate2</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">rate1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">min</span><span class="p">(</span><span class="n">txpwr_ptr2</span><span class="p">[</span><span class="n">rate2</span><span class="p">],</span>
					    <span class="n">tmp_txpwr_limit</span><span class="p">[</span><span class="n">rate2</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:

				<span class="n">txpwr_ptr1</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm</span><span class="p">;</span>
				<span class="n">txpwr_ptr2</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_siso</span><span class="p">;</span>
				<span class="n">rate_start_index</span> <span class="o">=</span> <span class="n">WL_TX_POWER_MCS20_SISO_FIRST</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:

				<span class="n">txpwr_ptr1</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_cdd</span><span class="p">;</span>
				<span class="n">txpwr_ptr2</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_cdd</span><span class="p">;</span>
				<span class="n">rate_start_index</span> <span class="o">=</span> <span class="n">WL_TX_POWER_MCS20_CDD_FIRST</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:

				<span class="n">txpwr_ptr1</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_siso</span><span class="p">;</span>
				<span class="n">txpwr_ptr2</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_siso</span><span class="p">;</span>
				<span class="n">rate_start_index</span> <span class="o">=</span> <span class="n">WL_TX_POWER_MCS40_SISO_FIRST</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:

				<span class="n">txpwr_ptr1</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_cdd</span><span class="p">;</span>
				<span class="n">txpwr_ptr2</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_cdd</span><span class="p">;</span>
				<span class="n">rate_start_index</span> <span class="o">=</span> <span class="n">WL_TX_POWER_MCS40_CDD_FIRST</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">rate2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rate2</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">;</span>
			     <span class="n">rate2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp_txpwr_limit</span><span class="p">[</span><span class="n">rate2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">tmp_txpwr_limit</span><span class="p">[</span><span class="n">BRCMS_NUM_RATES_OFDM</span> <span class="o">+</span> <span class="n">rate2</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">txpwr_ptr1</span><span class="p">[</span><span class="n">rate2</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="n">wlc_phy_ofdm_to_mcs_powers_nphy</span><span class="p">(</span>
				<span class="n">tmp_txpwr_limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">BRCMS_NUM_RATES_OFDM</span> <span class="o">-</span>
				<span class="mi">1</span><span class="p">,</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">rate1</span> <span class="o">=</span> <span class="n">rate_start_index</span><span class="p">,</span> <span class="n">rate2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			     <span class="n">rate2</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span>
			     <span class="n">rate1</span><span class="o">++</span><span class="p">,</span> <span class="n">rate2</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">rate1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">min</span><span class="p">(</span><span class="n">txpwr_ptr2</span><span class="p">[</span><span class="n">rate2</span><span class="p">],</span>
					    <span class="n">tmp_txpwr_limit</span><span class="p">[</span><span class="n">rate2</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:

				<span class="n">rate_start_index</span> <span class="o">=</span> <span class="n">WL_TX_POWER_MCS20_STBC_FIRST</span><span class="p">;</span>
				<span class="n">txpwr_ptr1</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_stbc</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:

				<span class="n">rate_start_index</span> <span class="o">=</span> <span class="n">WL_TX_POWER_MCS40_STBC_FIRST</span><span class="p">;</span>
				<span class="n">txpwr_ptr1</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_stbc</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">rate1</span> <span class="o">=</span> <span class="n">rate_start_index</span><span class="p">,</span> <span class="n">rate2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			     <span class="n">rate2</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span>
			     <span class="n">rate1</span><span class="o">++</span><span class="p">,</span> <span class="n">rate2</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">rate1</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr_ptr1</span><span class="p">[</span><span class="n">rate2</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:

				<span class="n">rate_start_index</span> <span class="o">=</span> <span class="n">WL_TX_POWER_MCS20_SDM_FIRST</span><span class="p">;</span>
				<span class="n">txpwr_ptr1</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_mimo</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:

				<span class="n">rate_start_index</span> <span class="o">=</span> <span class="n">WL_TX_POWER_MCS40_SDM_FIRST</span><span class="p">;</span>
				<span class="n">txpwr_ptr1</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_mimo</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">rate1</span> <span class="o">=</span> <span class="n">rate_start_index</span><span class="p">,</span> <span class="n">rate2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			     <span class="n">rate2</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_2_STREAM</span><span class="p">;</span>
			     <span class="n">rate1</span><span class="o">++</span><span class="p">,</span> <span class="n">rate2</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">rate1</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr_ptr1</span><span class="p">[</span><span class="n">rate2</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">WL_TX_POWER_MCS_32</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs32</span><span class="p">;</span>

		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">WL_TX_POWER_MCS40_CDD_FIRST</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">min</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">WL_TX_POWER_MCS40_CDD_FIRST</span><span class="p">],</span>
			    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">WL_TX_POWER_MCS_32</span><span class="p">]);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">WL_TX_POWER_MCS_32</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">WL_TX_POWER_MCS40_CDD_FIRST</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_txpwr_percent_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">txpwr_percent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_percent</span> <span class="o">=</span> <span class="n">txpwr_percent</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_machwcap_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">machwcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">machwcap</span> <span class="o">=</span> <span class="n">machwcap</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_runbist_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">bool</span> <span class="n">start_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rxc</span><span class="p">;</span>
	<span class="n">rxc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_end</span> <span class="o">==</span> <span class="n">ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">NREV_IS</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">NREV_IS</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregaddr</span><span class="p">),</span>
				      <span class="mh">0xa0</span><span class="p">);</span>
			<span class="n">bcma_set16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregdata</span><span class="p">),</span>
				   <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NREV_IS</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">NREV_IS</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bcma_wflush16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregaddr</span><span class="p">),</span>
				      <span class="mh">0xa0</span><span class="p">);</span>
			<span class="n">bcma_write16</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phyregdata</span><span class="p">),</span> <span class="n">rxc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">wlc_phy_por_inform</span><span class="p">(</span><span class="n">ppi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">wlc_phy_txpower_limit_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">txpwr_limits</span> <span class="o">*</span><span class="n">txpwr</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="n">wlc_phy_txpower_reg_limit_calc</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">txpwr</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">TXP_FIRST_OFDM_20_CDD</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_siso</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_siso</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwr_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wlapi_suspend_mac_and_wait</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>

	<span class="n">wlc_phy_txpower_recalc_target</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="n">wlc_phy_cal_txpower_recalc_sw</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="n">wlapi_enable_mac</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_ofdm_rateset_war</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">bool</span> <span class="n">war</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">ofdm_rateset_war</span> <span class="o">=</span> <span class="n">war</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_bf_preempt_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">bool</span> <span class="n">bf_preempt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">bf_preempt_4306</span> <span class="o">=</span> <span class="n">bf_preempt</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_txpower_update_shm</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">hwpwrctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>

		<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_TXPWR_MAX</span><span class="p">,</span> <span class="mi">63</span><span class="p">);</span>
		<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_TXPWR_N</span><span class="p">,</span>
				     <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NUM_TSSI_FRAMES</span><span class="p">);</span>

		<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_TXPWR_TARGET</span><span class="p">,</span>
				     <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_min</span> <span class="o">&lt;&lt;</span> <span class="n">NUM_TSSI_FRAMES</span><span class="p">);</span>

		<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_TXPWR_CUR</span><span class="p">,</span>
				     <span class="n">pi</span><span class="o">-&gt;</span><span class="n">hwpwr_txcur</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">TXP_FIRST_OFDM</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">TXP_LAST_OFDM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="n">ucode_ofdm_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
				<span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x6c</span>
			<span class="p">};</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">wlapi_bmac_rate_shm_offset</span><span class="p">(</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span>
				<span class="n">ucode_ofdm_rates</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="n">TXP_FIRST_OFDM</span><span class="p">]);</span>
			<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span>
					     <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span>
					     <span class="o">-</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">wlapi_bmac_mhf</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">MHF2</span><span class="p">,</span> <span class="n">MHF2_HWPWRCTL</span><span class="p">,</span>
			       <span class="n">MHF2_HWPWRCTL</span><span class="p">,</span> <span class="n">BRCM_BAND_ALL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">TXP_FIRST_OFDM</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">TXP_LAST_OFDM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">roundup</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_offset</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_OFDM_OFFSET</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">u16</span><span class="p">)</span>
				     <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_offset</span><span class="p">[</span><span class="n">TXP_FIRST_OFDM</span><span class="p">]</span>
				       <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">wlc_phy_txpower_hw_ctrl_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_txpwrctrl</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">hwpwrctrl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_txpower_hw_ctrl_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">bool</span> <span class="n">hwpwrctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">suspend</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">hwpwrctrl_capable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">hwpwrctrl</span> <span class="o">=</span> <span class="n">hwpwrctrl</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_txpwrctrl</span> <span class="o">=</span> <span class="n">hwpwrctrl</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txpwrctrl</span> <span class="o">=</span> <span class="n">hwpwrctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">suspend</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
					     <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">))</span> <span class="o">&amp;</span>
				 <span class="n">MCTL_EN_MAC</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">suspend</span><span class="p">)</span>
			<span class="n">wlapi_suspend_mac_and_wait</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>

		<span class="n">wlc_phy_txpwrctrl_enable_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_txpwrctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_txpwrctrl</span> <span class="o">==</span> <span class="n">PHY_TPC_HW_OFF</span><span class="p">)</span>
			<span class="n">wlc_phy_txpwr_fixpower_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mod_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x1e7</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x7f</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
				    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">saved_txpwr_idx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">suspend</span><span class="p">)</span>
			<span class="n">wlapi_enable_mac</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_txpower_ipa_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NREV_GE</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">ipa2g_on</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">srom_fem2g</span><span class="p">.</span><span class="n">extpagain</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">ipa5g_on</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">srom_fem5g</span><span class="p">.</span><span class="n">extpagain</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">ipa2g_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">ipa5g_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">wlc_phy_txpower_est_power_nphy</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s16</span> <span class="n">tx0_status</span><span class="p">,</span> <span class="n">tx1_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">estPower1</span><span class="p">,</span> <span class="n">estPower2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pwr0</span><span class="p">,</span> <span class="n">pwr1</span><span class="p">,</span> <span class="n">adj_pwr0</span><span class="p">,</span> <span class="n">adj_pwr1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">est_pwr</span><span class="p">;</span>

	<span class="n">estPower1</span> <span class="o">=</span> <span class="n">read_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x118</span><span class="p">);</span>
	<span class="n">estPower2</span> <span class="o">=</span> <span class="n">read_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x119</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">estPower1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">pwr0</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">estPower1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pwr0</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">estPower2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">pwr1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">estPower2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pwr1</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">tx0_status</span> <span class="o">=</span> <span class="n">read_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x1ed</span><span class="p">);</span>
	<span class="n">tx1_status</span> <span class="o">=</span> <span class="n">read_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x1ee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tx0_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span>
		<span class="n">adj_pwr0</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tx0_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adj_pwr0</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tx1_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span>
		<span class="n">adj_pwr1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">tx1_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adj_pwr1</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">est_pwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">pwr0</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pwr1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">adj_pwr0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">adj_pwr1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">est_pwr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">wlc_phy_txpower_get_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_power</span> <span class="o">*</span><span class="n">power</span><span class="p">,</span>
			    <span class="n">uint</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">rate</span><span class="p">,</span> <span class="n">num_rates</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">min_pwr</span><span class="p">,</span> <span class="n">max_pwr</span><span class="p">;</span>

<span class="cp">#if WL_TX_POWER_RATES != TXP_NUM_RATES</span>
<span class="cp">#error &quot;struct tx_power out of sync with this fn&quot;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">power</span><span class="o">-&gt;</span><span class="n">rf_cores</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">power</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WL_TX_POWER_F_MIMO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_txpwrctrl</span> <span class="o">==</span> <span class="n">PHY_TPC_HW_ON</span><span class="p">)</span>
			<span class="n">power</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
				<span class="p">(</span><span class="n">WL_TX_POWER_F_ENABLED</span> <span class="o">|</span> <span class="n">WL_TX_POWER_F_HW</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">power</span><span class="o">-&gt;</span><span class="n">rf_cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">power</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WL_TX_POWER_F_SISO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">radiopwr_override</span> <span class="o">==</span> <span class="n">RADIOPWR_OVERRIDE_DEF</span><span class="p">)</span>
			<span class="n">power</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WL_TX_POWER_F_ENABLED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">hwpwrctrl</span><span class="p">)</span>
			<span class="n">power</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WL_TX_POWER_F_HW</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">num_rates</span> <span class="o">=</span> <span class="p">((</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="o">?</span> <span class="p">(</span><span class="n">TXP_NUM_RATES</span><span class="p">)</span> <span class="o">:</span>
		     <span class="p">((</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="o">?</span>
		      <span class="p">(</span><span class="n">TXP_LAST_OFDM_20_CDD</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">TXP_LAST_OFDM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rate</span> <span class="o">&lt;</span> <span class="n">num_rates</span><span class="p">;</span> <span class="n">rate</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">power</span><span class="o">-&gt;</span><span class="n">user_limit</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_user_target</span><span class="p">[</span><span class="n">rate</span><span class="p">];</span>
		<span class="n">wlc_phy_txpower_sromlimit</span><span class="p">(</span><span class="n">ppi</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min_pwr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_pwr</span><span class="p">,</span>
					  <span class="n">rate</span><span class="p">);</span>
		<span class="n">power</span><span class="o">-&gt;</span><span class="n">board_limit</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">max_pwr</span><span class="p">;</span>
		<span class="n">power</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_target</span><span class="p">[</span><span class="n">rate</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">est_pout</span><span class="p">;</span>

		<span class="n">wlapi_suspend_mac_and_wait</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>
		<span class="n">wlc_phyreg_enter</span><span class="p">((</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="p">)</span> <span class="n">pi</span><span class="p">);</span>
		<span class="n">est_pout</span> <span class="o">=</span> <span class="n">wlc_phy_txpower_est_power_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
		<span class="n">wlc_phyreg_exit</span><span class="p">((</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="p">)</span> <span class="n">pi</span><span class="p">);</span>
		<span class="n">wlapi_enable_mac</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>

		<span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">est_pout</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">est_pout</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout_act</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">est_pout</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout_act</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">est_pout</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout_act</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout_act</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout_act</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout_act</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout_cck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">power</span><span class="o">-&gt;</span><span class="n">tx_power_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_max</span><span class="p">;</span>
		<span class="n">power</span><span class="o">-&gt;</span><span class="n">tx_power_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_max</span><span class="p">;</span>

		<span class="n">power</span><span class="o">-&gt;</span><span class="n">tx_power_max_rate_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_max_rate_ind</span><span class="p">;</span>
		<span class="n">power</span><span class="o">-&gt;</span><span class="n">tx_power_max_rate_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_max_rate_ind</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">hwpwrctrl</span> <span class="o">&amp;&amp;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">wlc_phyreg_enter</span><span class="p">(</span><span class="n">ppi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">power</span><span class="o">-&gt;</span><span class="n">tx_power_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_max</span><span class="p">;</span>
			<span class="n">power</span><span class="o">-&gt;</span><span class="n">tx_power_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_max</span><span class="p">;</span>

			<span class="n">power</span><span class="o">-&gt;</span><span class="n">tx_power_max_rate_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_max_rate_ind</span><span class="p">;</span>
			<span class="n">power</span><span class="o">-&gt;</span><span class="n">tx_power_max_rate_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_max_rate_ind</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">wlc_phy_tpc_isenabled_lcnphy</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
				<span class="n">power</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">WL_TX_POWER_F_HW</span> <span class="o">|</span>
					 <span class="n">WL_TX_POWER_F_ENABLED</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">power</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="p">(</span><span class="n">WL_TX_POWER_F_HW</span> <span class="o">|</span>
					  <span class="n">WL_TX_POWER_F_ENABLED</span><span class="p">);</span>

			<span class="n">wlc_lcnphy_get_tssi</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="p">(</span><span class="n">s8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					    <span class="p">(</span><span class="n">s8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">power</span><span class="o">-&gt;</span><span class="n">est_Pout_cck</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">wlc_phyreg_exit</span><span class="p">(</span><span class="n">ppi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_antsel_type_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">antsel_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">antsel_type</span> <span class="o">=</span> <span class="n">antsel_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">wlc_phy_test_ison</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">phytest_on</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_ant_rxdiv_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">suspend</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">rx_antdiv</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">D11REV_IS</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">16</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">ANT_RX_DIV_FORCE_1</span><span class="p">)</span>
			<span class="n">wlapi_bmac_mhf</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">MHF1</span><span class="p">,</span> <span class="n">MHF1_ANTDIV</span><span class="p">,</span>
				       <span class="n">MHF1_ANTDIV</span><span class="p">,</span> <span class="n">BRCM_BAND_ALL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">wlapi_bmac_mhf</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">MHF1</span><span class="p">,</span> <span class="n">MHF1_ANTDIV</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">BRCM_BAND_ALL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">suspend</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">))</span> <span class="o">&amp;</span>
			 <span class="n">MCTL_EN_MAC</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">suspend</span><span class="p">)</span>
		<span class="n">wlapi_suspend_mac_and_wait</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">ANT_RX_DIV_FORCE_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mod_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x410</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">mod_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x410</span><span class="p">,</span>
				    <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
				    <span class="p">((</span><span class="n">ANT_RX_DIV_START_1</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mod_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x410</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="mh">0x00</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">mod_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x410</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">suspend</span><span class="p">)</span>
		<span class="n">wlapi_enable_mac</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">wlc_phy_noise_calc_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">cmplx_pwr</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">pwr_ant</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">cmplx_pwr_dbm</span><span class="p">[</span><span class="n">PHY_CORE_MAX</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmplx_pwr_dbm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmplx_pwr_dbm</span><span class="p">));</span>
	<span class="n">wlc_phy_compute_dB</span><span class="p">(</span><span class="n">cmplx_pwr</span><span class="p">,</span> <span class="n">cmplx_pwr_dbm</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_corenum</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_corenum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NREV_GE</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">cmplx_pwr_dbm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">PHY_NOISE_OFFSETFACT_4322</span><span class="p">;</span>
		<span class="k">else</span>

			<span class="n">cmplx_pwr_dbm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="mi">70</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_corenum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_win</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmplx_pwr_dbm</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">pwr_ant</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmplx_pwr_dbm</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span> <span class="o">=</span>
		<span class="n">MODINC_POW2</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span><span class="p">,</span> <span class="n">PHY_NOISE_WINDOW_SZ</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wlc_phy_noise_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">s8</span> <span class="n">noise_dbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_state</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_state</span> <span class="o">&amp;</span> <span class="n">PHY_NOISE_STATE_MON</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_chan_watchdog</span> <span class="o">==</span> <span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_noise_window</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_noise_index</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">noise_dbm</span><span class="p">;</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_noise_index</span> <span class="o">=</span>
				<span class="n">MODINC</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_noise_index</span><span class="p">,</span> <span class="n">MA_WINDOW_SZ</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_NOISE_STATE_MON</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_state</span> <span class="o">&amp;</span> <span class="n">PHY_NOISE_STATE_EXTERNAL</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_NOISE_STATE_EXTERNAL</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">s8</span> <span class="nf">wlc_phy_noise_read_shmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmplx_pwr</span><span class="p">[</span><span class="n">PHY_CORE_MAX</span><span class="p">];</span>
	<span class="n">s8</span> <span class="n">noise_dbm_ant</span><span class="p">[</span><span class="n">PHY_CORE_MAX</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmplx_pwr_tot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">noise_dbm</span> <span class="o">=</span> <span class="n">PHY_NOISE_FIXED_VAL_NPHY</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">idx</span><span class="p">,</span> <span class="n">core</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmplx_pwr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmplx_pwr</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">noise_dbm_ant</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">noise_dbm_ant</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">core</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_corenum</span><span class="p">;</span> <span class="n">idx</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">,</span>
	     <span class="n">core</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lo</span> <span class="o">=</span> <span class="n">wlapi_bmac_read_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_PWRIND_MAP</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="n">wlapi_bmac_read_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span>
					 <span class="n">M_PWRIND_MAP</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">cmplx_pwr</span><span class="p">[</span><span class="n">core</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">lo</span><span class="p">;</span>
		<span class="n">cmplx_pwr_tot</span> <span class="o">+=</span> <span class="n">cmplx_pwr</span><span class="p">[</span><span class="n">core</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmplx_pwr</span><span class="p">[</span><span class="n">core</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">noise_dbm_ant</span><span class="p">[</span><span class="n">core</span><span class="p">]</span> <span class="o">=</span> <span class="n">PHY_NOISE_FIXED_VAL_NPHY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmplx_pwr</span><span class="p">[</span><span class="n">core</span><span class="p">]</span> <span class="o">&gt;&gt;=</span> <span class="n">PHY_NOISE_SAMPLE_LOG_NUM_UCODE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmplx_pwr_tot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wlc_phy_noise_calc_phy</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">cmplx_pwr</span><span class="p">,</span> <span class="n">noise_dbm_ant</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">core</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">core</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_corenum</span><span class="p">;</span> <span class="n">core</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_win</span><span class="p">[</span><span class="n">core</span><span class="p">][</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">noise_dbm_ant</span><span class="p">[</span><span class="n">core</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">noise_dbm_ant</span><span class="p">[</span><span class="n">core</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">noise_dbm</span><span class="p">)</span>
			<span class="n">noise_dbm</span> <span class="o">=</span> <span class="n">noise_dbm_ant</span><span class="p">[</span><span class="n">core</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span> <span class="o">=</span>
		<span class="n">MODINC_POW2</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span><span class="p">,</span> <span class="n">PHY_NOISE_WINDOW_SZ</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">noise_dbm</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_noise_sample_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">jssi_aux</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">noise_dbm</span> <span class="o">=</span> <span class="n">PHY_NOISE_FIXED_VAL_NPHY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">cmplx_pwr</span><span class="p">,</span> <span class="n">cmplx_pwr0</span><span class="p">,</span> <span class="n">cmplx_pwr1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
		<span class="n">s32</span> <span class="n">pwr_offset_dB</span><span class="p">,</span> <span class="n">gain_dB</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">status_0</span><span class="p">,</span> <span class="n">status_1</span><span class="p">;</span>

		<span class="n">jssi_aux</span> <span class="o">=</span> <span class="n">wlapi_bmac_read_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_JSSI_AUX</span><span class="p">);</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">jssi_aux</span> <span class="o">&amp;</span> <span class="n">D11_CURCHANNEL_MAX</span><span class="p">;</span>

		<span class="n">lo</span> <span class="o">=</span> <span class="n">wlapi_bmac_read_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_PWRIND_MAP0</span><span class="p">);</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="n">wlapi_bmac_read_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_PWRIND_MAP1</span><span class="p">);</span>
		<span class="n">cmplx_pwr0</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">lo</span><span class="p">;</span>

		<span class="n">lo</span> <span class="o">=</span> <span class="n">wlapi_bmac_read_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_PWRIND_MAP2</span><span class="p">);</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="n">wlapi_bmac_read_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_PWRIND_MAP3</span><span class="p">);</span>
		<span class="n">cmplx_pwr1</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">lo</span><span class="p">;</span>
		<span class="n">cmplx_pwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmplx_pwr0</span> <span class="o">+</span> <span class="n">cmplx_pwr1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>

		<span class="n">status_0</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
		<span class="n">status_1</span> <span class="o">=</span> <span class="n">wlapi_bmac_read_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_JSSI_0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmplx_pwr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cmplx_pwr</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">status_1</span> <span class="o">&amp;</span> <span class="mh">0xc000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">wlc_phy_compute_dB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmplx_pwr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">noise_dbm</span><span class="p">,</span>
					   <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_corenum</span><span class="p">);</span>
			<span class="n">pwr_offset_dB</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x434</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pwr_offset_dB</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">)</span>
				<span class="n">pwr_offset_dB</span> <span class="o">-=</span> <span class="mi">256</span><span class="p">;</span>

			<span class="n">noise_dbm</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="p">(</span><span class="n">pwr_offset_dB</span> <span class="o">-</span> <span class="mi">30</span><span class="p">);</span>

			<span class="n">gain_dB</span> <span class="o">=</span> <span class="p">(</span><span class="n">status_0</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">);</span>
			<span class="n">noise_dbm</span> <span class="o">-=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="p">(</span><span class="n">gain_dB</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">noise_dbm</span> <span class="o">=</span> <span class="n">PHY_NOISE_FIXED_VAL_LCNPHY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">jssi_aux</span> <span class="o">=</span> <span class="n">wlapi_bmac_read_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_JSSI_AUX</span><span class="p">);</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">jssi_aux</span> <span class="o">&amp;</span> <span class="n">D11_CURCHANNEL_MAX</span><span class="p">;</span>

		<span class="n">noise_dbm</span> <span class="o">=</span> <span class="n">wlc_phy_noise_read_shmem</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wlc_phy_noise_cb</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">noise_dbm</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">wlc_phy_noise_sample_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reason</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">noise_dbm</span> <span class="o">=</span> <span class="n">PHY_NOISE_FIXED_VAL_NPHY</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sampling_in_progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_state</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">wait_for_intr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PHY_NOISE_SAMPLE_MON</span>:
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_chan_watchdog</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_state</span> <span class="o">|=</span> <span class="n">PHY_NOISE_STATE_MON</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PHY_NOISE_SAMPLE_EXTERNAL</span>:
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_state</span> <span class="o">|=</span> <span class="n">PHY_NOISE_STATE_EXTERNAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sampling_in_progress</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_now</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_fixed_noise</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_win</span><span class="p">[</span><span class="n">WL_ANT_IDX_1</span><span class="p">][</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">PHY_NOISE_FIXED_VAL_NPHY</span><span class="p">;</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_win</span><span class="p">[</span><span class="n">WL_ANT_IDX_2</span><span class="p">][</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">PHY_NOISE_FIXED_VAL_NPHY</span><span class="p">;</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span> <span class="o">=</span> <span class="n">MODINC_POW2</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span><span class="p">,</span>
							   <span class="n">PHY_NOISE_WINDOW_SZ</span><span class="p">);</span>
			<span class="n">noise_dbm</span> <span class="o">=</span> <span class="n">PHY_NOISE_FIXED_VAL_NPHY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">noise_dbm</span> <span class="o">=</span> <span class="n">PHY_NOISE_FIXED_VAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wait_for_intr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_polling</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">PHY_NOISE_SAMPLE_EXTERNAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_JSSI_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_PWRIND_MAP0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_PWRIND_MAP1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_PWRIND_MAP2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_PWRIND_MAP3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">bcma_set32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccommand</span><span class="p">),</span>
				   <span class="n">MCMD_BG_NOISE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wlapi_suspend_mac_and_wait</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>
			<span class="n">wlc_lcnphy_deaf_mode</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">noise_dbm</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">wlc_lcnphy_rx_signal_power</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
			<span class="n">wlc_lcnphy_deaf_mode</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">wlapi_enable_mac</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>
			<span class="n">wait_for_intr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_polling</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">PHY_NOISE_SAMPLE_EXTERNAL</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_PWRIND_MAP0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_PWRIND_MAP1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_PWRIND_MAP2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">wlapi_bmac_write_shm</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">,</span> <span class="n">M_PWRIND_MAP3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">bcma_set32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccommand</span><span class="p">),</span>
				   <span class="n">MCMD_BG_NOISE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">phy_iq_est</span> <span class="n">est</span><span class="p">[</span><span class="n">PHY_CORE_MAX</span><span class="p">];</span>
			<span class="n">u32</span> <span class="n">cmplx_pwr</span><span class="p">[</span><span class="n">PHY_CORE_MAX</span><span class="p">];</span>
			<span class="n">s8</span> <span class="n">noise_dbm_ant</span><span class="p">[</span><span class="n">PHY_CORE_MAX</span><span class="p">];</span>
			<span class="n">u16</span> <span class="n">log_num_samps</span><span class="p">,</span> <span class="n">num_samps</span><span class="p">,</span> <span class="n">classif_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">wait_time</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">wait_crs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">est</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">est</span><span class="p">));</span>
			<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmplx_pwr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmplx_pwr</span><span class="p">));</span>
			<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">noise_dbm_ant</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">noise_dbm_ant</span><span class="p">));</span>

			<span class="n">log_num_samps</span> <span class="o">=</span> <span class="n">PHY_NOISE_SAMPLE_LOG_NUM_NPHY</span><span class="p">;</span>
			<span class="n">num_samps</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log_num_samps</span><span class="p">;</span>

			<span class="n">wlapi_suspend_mac_and_wait</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>
			<span class="n">classif_state</span> <span class="o">=</span> <span class="n">wlc_phy_classifier_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">wlc_phy_classifier_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">wlc_phy_rx_iq_est_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">est</span><span class="p">,</span> <span class="n">num_samps</span><span class="p">,</span> <span class="n">wait_time</span><span class="p">,</span>
					       <span class="n">wait_crs</span><span class="p">);</span>
			<span class="n">wlc_phy_classifier_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">classif_state</span><span class="p">);</span>
			<span class="n">wlapi_enable_mac</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_corenum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">cmplx_pwr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">est</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">i_pwr</span> <span class="o">+</span> <span class="n">est</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q_pwr</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					       <span class="n">log_num_samps</span><span class="p">;</span>

			<span class="n">wlc_phy_noise_calc_phy</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">cmplx_pwr</span><span class="p">,</span> <span class="n">noise_dbm_ant</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_corenum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_win</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">noise_dbm_ant</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">noise_dbm_ant</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">noise_dbm</span><span class="p">)</span>
					<span class="n">noise_dbm</span> <span class="o">=</span> <span class="n">noise_dbm_ant</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span> <span class="o">=</span> <span class="n">MODINC_POW2</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span><span class="p">,</span>
							   <span class="n">PHY_NOISE_WINDOW_SZ</span><span class="p">);</span>

			<span class="n">wait_for_intr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">done:</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_intr</span><span class="p">)</span>
		<span class="n">wlc_phy_noise_cb</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">noise_dbm</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_noise_sample_request_external</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">wlc_phy_chanspec_get</span><span class="p">(</span><span class="n">pih</span><span class="p">));</span>

	<span class="n">wlc_phy_noise_sample_request</span><span class="p">(</span><span class="n">pih</span><span class="p">,</span> <span class="n">PHY_NOISE_SAMPLE_EXTERNAL</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s8</span> <span class="n">lcnphy_gain_index_offset_for_pkt_rssi</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="mi">9</span><span class="p">,</span>
	<span class="mi">10</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="mi">7</span><span class="p">,</span>
	<span class="mi">7</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">wlc_phy_compute_dB</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">cmplx_pwr</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">p_cmplx_pwr_dB</span><span class="p">,</span> <span class="n">u8</span> <span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">msb</span><span class="p">,</span> <span class="n">secondmsb</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">core</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">secondmsb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cmplx_pwr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">msb</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msb</span><span class="p">)</span>
			<span class="n">secondmsb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="o">--</span><span class="n">msb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">p_cmplx_pwr_dB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">msb</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">secondmsb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wlc_phy_rssi_compute</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">d11rxhdr</span> <span class="o">*</span><span class="n">rxh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rssi</span> <span class="o">=</span> <span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_1</span> <span class="o">&amp;</span> <span class="n">PRXS1_JSSI_MASK</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">radioid</span> <span class="o">=</span> <span class="n">pih</span><span class="o">-&gt;</span><span class="n">radioid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">corerev</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxStatus2</span> <span class="o">&amp;</span> <span class="n">RXS_PHYRXST_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="n">BRCMS_RSSI_INVALID</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">gidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_2</span> <span class="o">&amp;</span> <span class="mh">0xFC00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">brcms_phy_lcnphy</span> <span class="o">*</span><span class="n">pi_lcn</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pi_lcnphy</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">)</span>
			<span class="n">rssi</span> <span class="o">-=</span> <span class="mi">256</span><span class="p">;</span>

		<span class="n">rssi</span> <span class="o">=</span> <span class="n">rssi</span> <span class="o">+</span> <span class="n">lcnphy_gain_index_offset_for_pkt_rssi</span><span class="p">[</span><span class="n">gidx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">46</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gidx</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">))</span>
			<span class="n">rssi</span> <span class="o">=</span> <span class="n">rssi</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>

		<span class="n">rssi</span> <span class="o">=</span> <span class="n">rssi</span> <span class="o">+</span> <span class="n">pi_lcn</span><span class="o">-&gt;</span><span class="n">lcnphy_pkteng_rssi_slope</span><span class="p">;</span>

		<span class="n">rssi</span> <span class="o">=</span> <span class="n">rssi</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">)</span>
			<span class="n">rssi</span> <span class="o">-=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">radioid</span> <span class="o">==</span> <span class="n">BCM2055_ID</span> <span class="o">||</span> <span class="n">radioid</span> <span class="o">==</span> <span class="n">BCM2056_ID</span>
		   <span class="o">||</span> <span class="n">radioid</span> <span class="o">==</span> <span class="n">BCM2057_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="n">wlc_phy_rssi_compute_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">rxh</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">end:</span>
	<span class="k">return</span> <span class="n">rssi</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_freqtrack_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_freqtrack_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_set_deaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">bool</span> <span class="n">user_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="n">wlc_lcnphy_deaf_mode</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="n">wlc_nphy_deaf_mode</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">delay_phy_cal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">now</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">watchdog_override</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SCAN_RM_IN_PROGRESS</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">||</span> <span class="n">PLT_INPROG_PHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)))</span>
		<span class="n">wlc_phy_noise_sample_request</span><span class="p">((</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="p">)</span> <span class="n">pi</span><span class="p">,</span>
					     <span class="n">PHY_NOISE_SAMPLE_MON</span><span class="p">,</span>
					     <span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span>
							    <span class="n">radio_chanspec</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_state</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">-</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_now</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phynoise_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_txpower</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">-</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_txpower</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">fast_timer</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SCAN_INPROG_PHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">wlc_phy_cal_txpower_recalc_sw</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_txpower</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">SCAN_RM_IN_PROGRESS</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">||</span> <span class="n">PLT_INPROG_PHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
	     <span class="o">||</span> <span class="n">ASSOC_INPROG_PHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">disable_percal</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">delay_phy_cal</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_perical</span> <span class="o">!=</span> <span class="n">PHY_PERICAL_DISABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_perical</span> <span class="o">!=</span> <span class="n">PHY_PERICAL_MANUAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">-</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_perical_last</span><span class="p">)</span> <span class="o">&gt;=</span>
		     <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">glacial_timer</span><span class="p">))</span>
			<span class="n">wlc_phy_cal_perical</span><span class="p">((</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="p">)</span> <span class="n">pi</span><span class="p">,</span>
					    <span class="n">PHY_PERICAL_WATCHDOG</span><span class="p">);</span>

		<span class="n">wlc_phy_txpwr_papd_cal_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_forcecal</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">-</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_lastcal</span><span class="p">)</span> <span class="o">&gt;=</span>
		     <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">glacial_timer</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SCAN_RM_IN_PROGRESS</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">||</span> <span class="n">ASSOC_INPROG_PHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)))</span>
				<span class="n">wlc_lcnphy_calib_modes</span><span class="p">(</span>
					<span class="n">pi</span><span class="p">,</span>
					<span class="n">LCNPHY_PERICAL_TEMPBASED_TXPWRCTRL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
			    <span class="p">(</span><span class="n">SCAN_RM_IN_PROGRESS</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">||</span> <span class="n">PLT_INPROG_PHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
			     <span class="o">||</span> <span class="n">ASSOC_INPROG_PHY</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
			     <span class="o">||</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">carrier_suppr_disable</span>
			     <span class="o">||</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">disable_percal</span><span class="p">))</span>
				<span class="n">wlc_lcnphy_calib_modes</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span>
						       <span class="n">PHY_PERICAL_WATCHDOG</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_BSSinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">bool</span> <span class="n">bonlyap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rssi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MA_WINDOW_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_noise_window</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ISLCNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MA_WINDOW_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_noise_window</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">PHY_NOISE_FIXED_VAL_LCNPHY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phy_noise_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHY_NOISE_WINDOW_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">WL_ANT_IDX_1</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">WL_ANT_RX_MAX</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_win</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">PHY_NOISE_FIXED_VAL_NPHY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_noise_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">wlc_phy_papd_decode_epsilon</span><span class="p">(</span><span class="n">u32</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">eps_real</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">eps_imag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">eps_imag</span> <span class="o">=</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">eps_imag</span> <span class="o">&gt;</span> <span class="mh">0xfff</span><span class="p">)</span>
		<span class="o">*</span><span class="n">eps_imag</span> <span class="o">-=</span> <span class="mh">0x2000</span><span class="p">;</span>

	<span class="o">*</span><span class="n">eps_real</span> <span class="o">=</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">eps_real</span> <span class="o">&gt;</span> <span class="mh">0xfff</span><span class="p">)</span>
		<span class="o">*</span><span class="n">eps_real</span> <span class="o">-=</span> <span class="mh">0x2000</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_cal_perical_mphase_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlapi_del_timer</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_timer</span><span class="p">);</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">cal_type_override</span> <span class="o">=</span> <span class="n">PHY_PERICAL_AUTO</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mphase_cal_phase_id</span> <span class="o">=</span> <span class="n">MPHASE_CAL_STATE_IDLE</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mphase_txcal_cmdidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">wlc_phy_cal_perical_mphase_schedule</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">uint</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_perical</span> <span class="o">!=</span> <span class="n">PHY_PERICAL_MPHASE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_perical</span> <span class="o">!=</span> <span class="n">PHY_PERICAL_MANUAL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wlapi_del_timer</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_timer</span><span class="p">);</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mphase_cal_phase_id</span> <span class="o">=</span> <span class="n">MPHASE_CAL_STATE_INIT</span><span class="p">;</span>
	<span class="n">wlapi_add_timer</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_timer</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_cal_perical</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s16</span> <span class="n">nphy_currtemp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">delta_temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">do_periodic_cal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_perical</span> <span class="o">==</span> <span class="n">PHY_PERICAL_DISABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_perical</span> <span class="o">==</span> <span class="n">PHY_PERICAL_MANUAL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PHY_PERICAL_DRIVERUP</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PHY_PERICAL_PHYINIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_perical</span> <span class="o">==</span> <span class="n">PHY_PERICAL_MPHASE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PHY_PERICAL_MPHASE_PENDING</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
				<span class="n">wlc_phy_cal_perical_mphase_reset</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

			<span class="n">wlc_phy_cal_perical_mphase_schedule</span><span class="p">(</span>
				<span class="n">pi</span><span class="p">,</span>
				<span class="n">PHY_PERICAL_INIT_DELAY</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PHY_PERICAL_JOIN_BSS</span>:
	<span class="k">case</span> <span class="n">PHY_PERICAL_START_IBSS</span>:
	<span class="k">case</span> <span class="n">PHY_PERICAL_UP_BSS</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_perical</span> <span class="o">==</span> <span class="n">PHY_PERICAL_MPHASE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">PHY_PERICAL_MPHASE_PENDING</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
			<span class="n">wlc_phy_cal_perical_mphase_reset</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">first_cal_after_assoc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">cal_type_override</span> <span class="o">=</span> <span class="n">PHY_PERICAL_FULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_tempdelta</span><span class="p">)</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_lastcal_temp</span> <span class="o">=</span> <span class="n">wlc_phy_tempsense_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

		<span class="n">wlc_phy_cal_perical_nphy_run</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">PHY_PERICAL_FULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PHY_PERICAL_WATCHDOG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_tempdelta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nphy_currtemp</span> <span class="o">=</span> <span class="n">wlc_phy_tempsense_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
			<span class="n">delta_temp</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">nphy_currtemp</span> <span class="o">&gt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_lastcal_temp</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">nphy_currtemp</span> <span class="o">-</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_lastcal_temp</span> <span class="o">:</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_lastcal_temp</span> <span class="o">-</span> <span class="n">nphy_currtemp</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">delta_temp</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">phycal_tempdelta</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_txiqlocal_chanspec</span> <span class="o">==</span>
			     <span class="n">pi</span><span class="o">-&gt;</span><span class="n">radio_chanspec</span><span class="p">))</span>
				<span class="n">do_periodic_cal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_lastcal_temp</span> <span class="o">=</span> <span class="n">nphy_currtemp</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_periodic_cal</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_perical</span> <span class="o">==</span> <span class="n">PHY_PERICAL_MPHASE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHY_PERICAL_MPHASE_PENDING</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
					<span class="n">wlc_phy_cal_perical_mphase_schedule</span><span class="p">(</span>
						<span class="n">pi</span><span class="p">,</span>
						<span class="n">PHY_PERICAL_WDOG_DELAY</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">nphy_perical</span> <span class="o">==</span> <span class="n">PHY_PERICAL_SPHASE</span><span class="p">)</span>
				<span class="n">wlc_phy_cal_perical_nphy_run</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span>
							     <span class="n">PHY_PERICAL_AUTO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_cal_perical_mphase_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mphase_cal_phase_id</span> <span class="o">=</span> <span class="n">MPHASE_CAL_STATE_INIT</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mphase_txcal_cmdidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">wlc_phy_nbits</span><span class="p">(</span><span class="n">s32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">abs_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">abs_val</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">abs_val</span> <span class="o">&gt;&gt;</span> <span class="n">nbits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nbits</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nbits</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_stf_chain_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">u8</span> <span class="n">txchain</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rxchain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">hw_phytxchain</span> <span class="o">=</span> <span class="n">txchain</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">hw_phyrxchain</span> <span class="o">=</span> <span class="n">rxchain</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phytxchain</span> <span class="o">=</span> <span class="n">txchain</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phyrxchain</span> <span class="o">=</span> <span class="n">rxchain</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_corenum</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">hweight8</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phyrxchain</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_stf_chain_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">u8</span> <span class="n">txchain</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rxchain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phytxchain</span> <span class="o">=</span> <span class="n">txchain</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="n">wlc_phy_rxcore_setstate_nphy</span><span class="p">(</span><span class="n">pih</span><span class="p">,</span> <span class="n">rxchain</span><span class="p">);</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_corenum</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">hweight8</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phyrxchain</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_stf_chain_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">txchain</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rxchain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="o">*</span><span class="n">txchain</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phytxchain</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rxchain</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">phyrxchain</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">wlc_phy_stf_chain_active_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s16</span> <span class="n">nphy_currtemp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">active_bitmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>

	<span class="n">active_bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_txcore_heatedup</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x31</span> <span class="o">:</span> <span class="mh">0x33</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">watchdog_override</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">active_bitmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NREV_GE</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pubpi</span><span class="p">.</span><span class="n">phy_rev</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wlapi_suspend_mac_and_wait</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>
		<span class="n">nphy_currtemp</span> <span class="o">=</span> <span class="n">wlc_phy_tempsense_nphy</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
		<span class="n">wlapi_enable_mac</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_txcore_heatedup</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nphy_currtemp</span> <span class="o">&gt;=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_txcore_disable_temp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">active_bitmap</span> <span class="o">&amp;=</span> <span class="mh">0xFD</span><span class="p">;</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_txcore_heatedup</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nphy_currtemp</span> <span class="o">&lt;=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_txcore_enable_temp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">active_bitmap</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">phy_txcore_heatedup</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">active_bitmap</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">s8</span> <span class="nf">wlc_phy_stf_ssmode_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">pih</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">siso_mcs_id</span><span class="p">,</span> <span class="n">cdd_mcs_id</span><span class="p">;</span>

	<span class="n">siso_mcs_id</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">CHSPEC_IS40</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span> <span class="o">?</span> <span class="n">TXP_FIRST_MCS_40_SISO</span> <span class="o">:</span>
		<span class="n">TXP_FIRST_MCS_20_SISO</span><span class="p">;</span>
	<span class="n">cdd_mcs_id</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">CHSPEC_IS40</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span> <span class="o">?</span> <span class="n">TXP_FIRST_MCS_40_CDD</span> <span class="o">:</span>
		<span class="n">TXP_FIRST_MCS_20_CDD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_target</span><span class="p">[</span><span class="n">siso_mcs_id</span><span class="p">]</span> <span class="o">&gt;</span>
	    <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_power_target</span><span class="p">[</span><span class="n">cdd_mcs_id</span><span class="p">]</span> <span class="o">+</span> <span class="mi">12</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PHY_TXC1_MODE_SISO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">PHY_TXC1_MODE_CDD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">wlc_phy_get_ofdm_rate_lookup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ofdm_rate_lookup</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_lcnphy_epa_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">BCM4313_CHIP_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">boardflags</span> <span class="o">&amp;</span> <span class="n">BFL_FEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">txant</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">txant</span> <span class="o">=</span> <span class="n">wlapi_bmac_get_txant</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txant</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mod_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x44d</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

				<span class="n">mod_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x44c</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

			<span class="p">}</span>
			<span class="n">ai_cc_reg</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span>
				  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chipcregs</span><span class="p">,</span> <span class="n">gpiocontrol</span><span class="p">),</span>
				  <span class="o">~</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="n">ai_cc_reg</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span>
				  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chipcregs</span><span class="p">,</span> <span class="n">gpioout</span><span class="p">),</span>
				  <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="n">ai_cc_reg</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span>
				  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chipcregs</span><span class="p">,</span> <span class="n">gpioouten</span><span class="p">),</span>
				  <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mod_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x44c</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

			<span class="n">mod_phy_reg</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0x44d</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

			<span class="n">ai_cc_reg</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span>
				  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chipcregs</span><span class="p">,</span> <span class="n">gpioout</span><span class="p">),</span>
				  <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">ai_cc_reg</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span>
				  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chipcregs</span><span class="p">,</span> <span class="n">gpioouten</span><span class="p">),</span>
				  <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="n">ai_cc_reg</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span>
				  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chipcregs</span><span class="p">,</span> <span class="n">gpiocontrol</span><span class="p">),</span>
				  <span class="o">~</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wlc_phy_ldpc_override_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ldpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">wlc_phy_get_pwrdet_offsets</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">cckoffset</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">ofdmoffset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">cckoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ofdmoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">s8</span> <span class="nf">wlc_phy_upd_rssi_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">s8</span> <span class="n">rssi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">return</span> <span class="n">rssi</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">wlc_phy_txpower_ipa_ison</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">ppi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_phy</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISNPHY</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">wlc_phy_n_txpower_ipa_ison</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:6}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../../javascript/docco.min.js"></script>
</html>
