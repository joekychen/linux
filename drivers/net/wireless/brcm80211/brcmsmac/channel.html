<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › brcm80211 › brcmsmac › channel.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>channel.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY</span>
<span class="cm"> * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION</span>
<span class="cm"> * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>

<span class="cp">#include &lt;defs.h&gt;</span>
<span class="cp">#include &quot;pub.h&quot;</span>
<span class="cp">#include &quot;phy/phy_hal.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &quot;stf.h&quot;</span>
<span class="cp">#include &quot;channel.h&quot;</span>

<span class="cm">/* QDB() macro takes a dB value and converts to a quarter dB value */</span>
<span class="cp">#define QDB(n) ((n) * BRCMS_TXPWR_DB_FACTOR)</span>

<span class="cp">#define  LOCALE_CHAN_01_11	 (1&lt;&lt;0)</span>
<span class="cp">#define  LOCALE_CHAN_12_13	 (1&lt;&lt;1)</span>
<span class="cp">#define  LOCALE_CHAN_14		 (1&lt;&lt;2)</span>
<span class="cp">#define  LOCALE_SET_5G_LOW_JP1   (1&lt;&lt;3)	</span><span class="cm">/* 34-48, step 2 */</span><span class="cp"></span>
<span class="cp">#define  LOCALE_SET_5G_LOW_JP2   (1&lt;&lt;4)	</span><span class="cm">/* 34-46, step 4 */</span><span class="cp"></span>
<span class="cp">#define  LOCALE_SET_5G_LOW1      (1&lt;&lt;5)	</span><span class="cm">/* 36-48, step 4 */</span><span class="cp"></span>
<span class="cp">#define  LOCALE_SET_5G_LOW2      (1&lt;&lt;6)	</span><span class="cm">/* 52 */</span><span class="cp"></span>
<span class="cp">#define  LOCALE_SET_5G_LOW3      (1&lt;&lt;7)	</span><span class="cm">/* 56-64, step 4 */</span><span class="cp"></span>
<span class="cp">#define  LOCALE_SET_5G_MID1      (1&lt;&lt;8)	</span><span class="cm">/* 100-116, step 4 */</span><span class="cp"></span>
<span class="cp">#define  LOCALE_SET_5G_MID2	 (1&lt;&lt;9)	</span><span class="cm">/* 120-124, step 4 */</span><span class="cp"></span>
<span class="cp">#define  LOCALE_SET_5G_MID3      (1&lt;&lt;10)	</span><span class="cm">/* 128 */</span><span class="cp"></span>
<span class="cp">#define  LOCALE_SET_5G_HIGH1     (1&lt;&lt;11)	</span><span class="cm">/* 132-140, step 4 */</span><span class="cp"></span>
<span class="cp">#define  LOCALE_SET_5G_HIGH2     (1&lt;&lt;12)	</span><span class="cm">/* 149-161, step 4 */</span><span class="cp"></span>
<span class="cp">#define  LOCALE_SET_5G_HIGH3     (1&lt;&lt;13)	</span><span class="cm">/* 165 */</span><span class="cp"></span>
<span class="cp">#define  LOCALE_CHAN_52_140_ALL  (1&lt;&lt;14)</span>
<span class="cp">#define  LOCALE_SET_5G_HIGH4     (1&lt;&lt;15)	</span><span class="cm">/* 184-216 */</span><span class="cp"></span>

<span class="cp">#define  LOCALE_CHAN_36_64	(LOCALE_SET_5G_LOW1 | \</span>
<span class="cp">				 LOCALE_SET_5G_LOW2 | \</span>
<span class="cp">				 LOCALE_SET_5G_LOW3)</span>
<span class="cp">#define  LOCALE_CHAN_52_64	(LOCALE_SET_5G_LOW2 | LOCALE_SET_5G_LOW3)</span>
<span class="cp">#define  LOCALE_CHAN_100_124	(LOCALE_SET_5G_MID1 | LOCALE_SET_5G_MID2)</span>
<span class="cp">#define  LOCALE_CHAN_100_140	(LOCALE_SET_5G_MID1 | LOCALE_SET_5G_MID2 | \</span>
<span class="cp">				  LOCALE_SET_5G_MID3 | LOCALE_SET_5G_HIGH1)</span>
<span class="cp">#define  LOCALE_CHAN_149_165	(LOCALE_SET_5G_HIGH2 | LOCALE_SET_5G_HIGH3)</span>
<span class="cp">#define  LOCALE_CHAN_184_216	LOCALE_SET_5G_HIGH4</span>

<span class="cp">#define  LOCALE_CHAN_01_14	(LOCALE_CHAN_01_11 | \</span>
<span class="cp">				 LOCALE_CHAN_12_13 | \</span>
<span class="cp">				 LOCALE_CHAN_14)</span>

<span class="cp">#define  LOCALE_RADAR_SET_NONE		  0</span>
<span class="cp">#define  LOCALE_RADAR_SET_1		  1</span>

<span class="cp">#define  LOCALE_RESTRICTED_NONE		  0</span>
<span class="cp">#define  LOCALE_RESTRICTED_SET_2G_SHORT   1</span>
<span class="cp">#define  LOCALE_RESTRICTED_CHAN_165       2</span>
<span class="cp">#define  LOCALE_CHAN_ALL_5G		  3</span>
<span class="cp">#define  LOCALE_RESTRICTED_JAPAN_LEGACY   4</span>
<span class="cp">#define  LOCALE_RESTRICTED_11D_2G	  5</span>
<span class="cp">#define  LOCALE_RESTRICTED_11D_5G	  6</span>
<span class="cp">#define  LOCALE_RESTRICTED_LOW_HI	  7</span>
<span class="cp">#define  LOCALE_RESTRICTED_12_13_14	  8</span>

<span class="cp">#define LOCALE_2G_IDX_i			0</span>
<span class="cp">#define LOCALE_5G_IDX_11		0</span>
<span class="cp">#define LOCALE_MIMO_IDX_bn		0</span>
<span class="cp">#define LOCALE_MIMO_IDX_11n		0</span>

<span class="cm">/* max of BAND_5G_PWR_LVLS and 6 for 2.4 GHz */</span>
<span class="cp">#define BRCMS_MAXPWR_TBL_SIZE		6</span>
<span class="cm">/* max of BAND_5G_PWR_LVLS and 14 for 2.4 GHz */</span>
<span class="cp">#define BRCMS_MAXPWR_MIMO_TBL_SIZE	14</span>

<span class="cm">/* power level in group of 2.4GHz band channels:</span>
<span class="cm"> * maxpwr[0] - CCK  channels [1]</span>
<span class="cm"> * maxpwr[1] - CCK  channels [2-10]</span>
<span class="cm"> * maxpwr[2] - CCK  channels [11-14]</span>
<span class="cm"> * maxpwr[3] - OFDM channels [1]</span>
<span class="cm"> * maxpwr[4] - OFDM channels [2-10]</span>
<span class="cm"> * maxpwr[5] - OFDM channels [11-14]</span>
<span class="cm"> */</span>

<span class="cm">/* maxpwr mapping to 5GHz band channels:</span>
<span class="cm"> * maxpwr[0] - channels [34-48]</span>
<span class="cm"> * maxpwr[1] - channels [52-60]</span>
<span class="cm"> * maxpwr[2] - channels [62-64]</span>
<span class="cm"> * maxpwr[3] - channels [100-140]</span>
<span class="cm"> * maxpwr[4] - channels [149-165]</span>
<span class="cm"> */</span>
<span class="cp">#define BAND_5G_PWR_LVLS	5	</span><span class="cm">/* 5 power levels for 5G */</span><span class="cp"></span>

<span class="cp">#define LC(id)	LOCALE_MIMO_IDX_ ## id</span>

<span class="cp">#define LC_2G(id)	LOCALE_2G_IDX_ ## id</span>

<span class="cp">#define LC_5G(id)	LOCALE_5G_IDX_ ## id</span>

<span class="cp">#define LOCALES(band2, band5, mimo2, mimo5) \</span>
<span class="cp">		{LC_2G(band2), LC_5G(band5), LC(mimo2), LC(mimo5)}</span>

<span class="cm">/* macro to get 2.4 GHz channel group index for tx power */</span>
<span class="cp">#define CHANNEL_POWER_IDX_2G_CCK(c) (((c) &lt; 2) ? 0 : (((c) &lt; 11) ? 1 : 2))</span>
<span class="cp">#define CHANNEL_POWER_IDX_2G_OFDM(c) (((c) &lt; 2) ? 3 : (((c) &lt; 11) ? 4 : 5))</span>

<span class="cm">/* macro to get 5 GHz channel group index for tx power */</span>
<span class="cp">#define CHANNEL_POWER_IDX_5G(c) (((c) &lt; 52) ? 0 : \</span>
<span class="cp">				 (((c) &lt; 62) ? 1 : \</span>
<span class="cp">				 (((c) &lt; 100) ? 2 : \</span>
<span class="cp">				 (((c) &lt; 149) ? 3 : 4))))</span>

<span class="cp">#define ISDFS_EU(fl)		(((fl) &amp; BRCMS_DFS_EU) == BRCMS_DFS_EU)</span>

<span class="k">struct</span> <span class="n">brcms_cm_band</span> <span class="p">{</span>
	<span class="cm">/* struct locale_info flags */</span>
	<span class="n">u8</span> <span class="n">locale_flags</span><span class="p">;</span>
	<span class="cm">/* List of valid channels in the country */</span>
	<span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">valid_channels</span><span class="p">;</span>
	<span class="cm">/* List of restricted use channels */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="o">*</span><span class="n">restricted_channels</span><span class="p">;</span>
	<span class="cm">/* List of radar sensitive channels */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="o">*</span><span class="n">radar_channels</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">PAD</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

 <span class="cm">/* locale per-channel tx power limits for MIMO frames</span>
<span class="cm">  * maxpwr arrays are index by channel for 2.4 GHz limits, and</span>
<span class="cm">  * by sub-band for 5 GHz limits using CHANNEL_POWER_IDX_5G(channel)</span>
<span class="cm">  */</span>
<span class="k">struct</span> <span class="n">locale_mimo_info</span> <span class="p">{</span>
	<span class="cm">/* tx 20 MHz power limits, qdBm units */</span>
	<span class="n">s8</span> <span class="n">maxpwr20</span><span class="p">[</span><span class="n">BRCMS_MAXPWR_MIMO_TBL_SIZE</span><span class="p">];</span>
	<span class="cm">/* tx 40 MHz power limits, qdBm units */</span>
	<span class="n">s8</span> <span class="n">maxpwr40</span><span class="p">[</span><span class="n">BRCMS_MAXPWR_MIMO_TBL_SIZE</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Country names and abbreviations with locale defined from ISO 3166 */</span>
<span class="k">struct</span> <span class="n">country_info</span> <span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">locale_2G</span><span class="p">;</span>	<span class="cm">/* 2.4G band locale */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">locale_5G</span><span class="p">;</span>	<span class="cm">/* 5G band locale */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">locale_mimo_2G</span><span class="p">;</span>	<span class="cm">/* 2.4G mimo info */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">locale_mimo_5G</span><span class="p">;</span>	<span class="cm">/* 5G mimo info */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">srom_ccode</span><span class="p">[</span><span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">];</span>	<span class="cm">/* Country Code in SROM */</span>
	<span class="n">uint</span> <span class="n">srom_regrev</span><span class="p">;</span>	<span class="cm">/* Regulatory Rev for the SROM ccode */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">country_info</span> <span class="o">*</span><span class="n">country</span><span class="p">;</span>	<span class="cm">/* current country def */</span>
	<span class="kt">char</span> <span class="n">ccode</span><span class="p">[</span><span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">];</span>	<span class="cm">/* current internal Country Code */</span>
	<span class="n">uint</span> <span class="n">regrev</span><span class="p">;</span>		<span class="cm">/* current Regulatory Revision */</span>
	<span class="kt">char</span> <span class="n">country_abbrev</span><span class="p">[</span><span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">];</span>	<span class="cm">/* current advertised ccode */</span>
	<span class="cm">/* per-band state (one per phy/radio) */</span>
	<span class="k">struct</span> <span class="n">brcms_cm_band</span> <span class="n">bandstate</span><span class="p">[</span><span class="n">MAXBANDS</span><span class="p">];</span>
	<span class="cm">/* quiet channels currently for radar sensitivity or 11h support */</span>
	<span class="cm">/* channels on which we cannot transmit */</span>
	<span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">quiet_channels</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* locale channel and power info. */</span>
<span class="k">struct</span> <span class="n">locale_info</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">valid_channels</span><span class="p">;</span>
	<span class="cm">/* List of radar sensitive channels */</span>
	<span class="n">u8</span> <span class="n">radar_channels</span><span class="p">;</span>
	<span class="cm">/* List of channels used only if APs are detected */</span>
	<span class="n">u8</span> <span class="n">restricted_channels</span><span class="p">;</span>
	<span class="cm">/* Max tx pwr in qdBm for each sub-band */</span>
	<span class="n">s8</span> <span class="n">maxpwr</span><span class="p">[</span><span class="n">BRCMS_MAXPWR_TBL_SIZE</span><span class="p">];</span>
	<span class="cm">/* Country IE advertised max tx pwr in dBm per sub-band */</span>
	<span class="n">s8</span> <span class="n">pub_maxpwr</span><span class="p">[</span><span class="n">BAND_5G_PWR_LVLS</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Regulatory Matrix Spreadsheet (CLM) MIMO v3.7.9 */</span>

<span class="cm">/*</span>
<span class="cm"> * Some common channel sets</span>
<span class="cm"> */</span>

<span class="cm">/* No channels */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">chanvec_none</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* All 2.4 GHz HW channels */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">chanvec_all_2G</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* All 5 GHz HW channels */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">chanvec_all_5G</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
	 <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
	 <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
	 <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Radar channel sets</span>
<span class="cm"> */</span>

<span class="cm">/* Channels 52 - 64, 100 - 140 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">radar_set1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>  <span class="cm">/* 52 - 60 */</span>
	 <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>  <span class="cm">/* 64, 100 - 124 */</span>
	 <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 128 - 140 */</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Restricted channel sets</span>
<span class="cm"> */</span>

<span class="cm">/* Channels 34, 38, 42, 46 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">restricted_set_japan_legacy</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Channels 12, 13 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">restricted_set_2g_short</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Channel 165 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">restricted_chan_165</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Channels 36 - 48 &amp; 149 - 165 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">restricted_low_hi</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Channels 12 - 14 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">restricted_set_12_13_14</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* global memory to provide working buffer for expanded locale */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="o">*</span><span class="n">g_table_radar_set</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">chanvec_none</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">radar_set1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="o">*</span><span class="n">g_table_restricted_chan</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">chanvec_none</span><span class="p">,</span>		<span class="cm">/* restricted_set_none */</span>
	<span class="o">&amp;</span><span class="n">restricted_set_2g_short</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">restricted_chan_165</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">chanvec_all_5G</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">restricted_set_japan_legacy</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">chanvec_all_2G</span><span class="p">,</span>	<span class="cm">/* restricted_set_11d_2G */</span>
	<span class="o">&amp;</span><span class="n">chanvec_all_5G</span><span class="p">,</span>	<span class="cm">/* restricted_set_11d_5G */</span>
	<span class="o">&amp;</span><span class="n">restricted_low_hi</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">restricted_set_12_13_14</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_2g_01_11</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_2g_12_13</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_2g_14</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_5g_LOW_JP1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_5g_LOW_JP2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_5g_LOW1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_5g_LOW2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_5g_LOW3</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
	 <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_5g_MID1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_5g_MID2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_5g_MID3</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_5g_HIGH1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_5g_HIGH2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_5g_HIGH3</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_5g_52_140_ALL</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
	 <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
	 <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">locale_5g_HIGH4</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	 <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
	 <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="o">*</span><span class="n">g_table_locale_base</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">locale_2g_01_11</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_2g_12_13</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_2g_14</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_5g_LOW_JP1</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_5g_LOW_JP2</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_5g_LOW1</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_5g_LOW2</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_5g_LOW3</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_5g_MID1</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_5g_MID2</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_5g_MID3</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_5g_HIGH1</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_5g_HIGH2</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_5g_HIGH3</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_5g_52_140_ALL</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">locale_5g_HIGH4</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_locale_add_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="o">*</span><span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_chanvec</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">channels</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_locale_get_channels</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">locale_info</span> <span class="o">*</span><span class="n">locale</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="o">*</span><span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_chanvec</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">g_table_locale_base</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">locale</span><span class="o">-&gt;</span><span class="n">valid_channels</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">brcms_c_locale_add_channels</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span>
						<span class="n">g_table_locale_base</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Locale Definitions - 2.4 GHz</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">locale_info</span> <span class="n">locale_i</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* locale i. channel 1 - 13 */</span>
	<span class="n">LOCALE_CHAN_01_11</span> <span class="o">|</span> <span class="n">LOCALE_CHAN_12_13</span><span class="p">,</span>
	<span class="n">LOCALE_RADAR_SET_NONE</span><span class="p">,</span>
	<span class="n">LOCALE_RESTRICTED_SET_2G_SHORT</span><span class="p">,</span>
	<span class="p">{</span><span class="n">QDB</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span>
	 <span class="n">QDB</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">19</span><span class="p">)},</span>
	<span class="p">{</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="n">BRCMS_EIRP</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Locale Definitions - 5 GHz</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">locale_info</span> <span class="n">locale_11</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* locale 11. channel 36 - 48, 52 - 64, 100 - 140, 149 - 165 */</span>
	<span class="n">LOCALE_CHAN_36_64</span> <span class="o">|</span> <span class="n">LOCALE_CHAN_100_140</span> <span class="o">|</span> <span class="n">LOCALE_CHAN_149_165</span><span class="p">,</span>
	<span class="n">LOCALE_RADAR_SET_1</span><span class="p">,</span>
	<span class="n">LOCALE_RESTRICTED_NONE</span><span class="p">,</span>
	<span class="p">{</span><span class="n">QDB</span><span class="p">(</span><span class="mi">21</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">21</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">21</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">21</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">21</span><span class="p">)},</span>
	<span class="p">{</span><span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">},</span>
	<span class="n">BRCMS_EIRP</span> <span class="o">|</span> <span class="n">BRCMS_DFS_EU</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">locale_info</span> <span class="o">*</span><span class="n">g_locale_2g_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">locale_i</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">locale_info</span> <span class="o">*</span><span class="n">g_locale_5g_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">locale_11</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * MIMO Locale Definitions - 2.4 GHz</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">locale_mimo_info</span> <span class="n">locale_bn</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span>
	 <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span>
	 <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">)},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span>
	 <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span>
	 <span class="n">QDB</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">locale_mimo_info</span> <span class="o">*</span><span class="n">g_mimo_2g_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">locale_bn</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * MIMO Locale Definitions - 5 GHz</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">locale_mimo_info</span> <span class="n">locale_11n</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="cm">/* 12.5 dBm */</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">15</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">QDB</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">15</span><span class="p">)},</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">locale_mimo_info</span> <span class="o">*</span><span class="n">g_mimo_5g_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">locale_11n</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">abbrev</span><span class="p">[</span><span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">];</span>	<span class="cm">/* country abbreviation */</span>
	<span class="k">struct</span> <span class="n">country_info</span> <span class="n">country</span><span class="p">;</span>
<span class="p">}</span> <span class="n">cntry_locales</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	<span class="s">&quot;X2&quot;</span><span class="p">,</span> <span class="n">LOCALES</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="mi">11</span><span class="n">n</span><span class="p">)},</span>	<span class="cm">/* Worldwide RoW 2 */</span>
<span class="p">};</span>

<span class="cp">#ifdef SUPPORT_40MHZ</span>
<span class="cm">/* 20MHz channel info for 40MHz pairing support */</span>
<span class="k">struct</span> <span class="n">chan20_info</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">sb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">adj_sbs</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* indicates adjacent channels that are allowed for a 40 Mhz channel and</span>
<span class="cm"> * those that permitted by the HT</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">chan20_info</span> <span class="n">chan20_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 11b/11g */</span>
<span class="cm">/* 0 */</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 1 */</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 2 */</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 3 */</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 4 */</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 5 */</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 6 */</span> <span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 7 */</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 8 */</span> <span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 9 */</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 10 */</span> <span class="p">{</span><span class="mi">11</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 11 */</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span><span class="p">)},</span>
<span class="cm">/* 12 */</span> <span class="p">{</span><span class="mi">13</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span><span class="p">)},</span>
<span class="cm">/* 13 */</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span><span class="p">)},</span>

<span class="cm">/* 11a japan high */</span>
<span class="cm">/* 14 */</span> <span class="p">{</span><span class="mi">34</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span><span class="p">)},</span>
<span class="cm">/* 15 */</span> <span class="p">{</span><span class="mi">38</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span><span class="p">)},</span>
<span class="cm">/* 16 */</span> <span class="p">{</span><span class="mi">42</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span><span class="p">)},</span>
<span class="cm">/* 17 */</span> <span class="p">{</span><span class="mi">46</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span><span class="p">)},</span>

<span class="cm">/* 11a usa low */</span>
<span class="cm">/* 18 */</span> <span class="p">{</span><span class="mi">36</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 19 */</span> <span class="p">{</span><span class="mi">40</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 20 */</span> <span class="p">{</span><span class="mi">44</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 21 */</span> <span class="p">{</span><span class="mi">48</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 22 */</span> <span class="p">{</span><span class="mi">52</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 23 */</span> <span class="p">{</span><span class="mi">56</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 24 */</span> <span class="p">{</span><span class="mi">60</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 25 */</span> <span class="p">{</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>

<span class="cm">/* 11a Europe */</span>
<span class="cm">/* 26 */</span> <span class="p">{</span><span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 27 */</span> <span class="p">{</span><span class="mi">104</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 28 */</span> <span class="p">{</span><span class="mi">108</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 29 */</span> <span class="p">{</span><span class="mi">112</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 30 */</span> <span class="p">{</span><span class="mi">116</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 31 */</span> <span class="p">{</span><span class="mi">120</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 32 */</span> <span class="p">{</span><span class="mi">124</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 33 */</span> <span class="p">{</span><span class="mi">128</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 34 */</span> <span class="p">{</span><span class="mi">132</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 35 */</span> <span class="p">{</span><span class="mi">136</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 36 */</span> <span class="p">{</span><span class="mi">140</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span><span class="p">)},</span>

<span class="cm">/* 11a usa high, ref5 only */</span>
<span class="cm">/* The 0x80 bit in pdiv means these are REF5, other entries are REF20 */</span>
<span class="cm">/* 37 */</span> <span class="p">{</span><span class="mi">149</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 38 */</span> <span class="p">{</span><span class="mi">153</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 39 */</span> <span class="p">{</span><span class="mi">157</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 40 */</span> <span class="p">{</span><span class="mi">161</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">)},</span>
<span class="cm">/* 41 */</span> <span class="p">{</span><span class="mi">165</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span><span class="p">)},</span>

<span class="cm">/* 11a japan */</span>
<span class="cm">/* 42 */</span> <span class="p">{</span><span class="mi">184</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span><span class="p">)},</span>
<span class="cm">/* 43 */</span> <span class="p">{</span><span class="mi">188</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span><span class="p">)},</span>
<span class="cm">/* 44 */</span> <span class="p">{</span><span class="mi">192</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span><span class="p">)},</span>
<span class="cm">/* 45 */</span> <span class="p">{</span><span class="mi">196</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span><span class="p">)},</span>
<span class="cm">/* 46 */</span> <span class="p">{</span><span class="mi">200</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span><span class="p">)},</span>
<span class="cm">/* 47 */</span> <span class="p">{</span><span class="mi">204</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span><span class="p">)},</span>
<span class="cm">/* 48 */</span> <span class="p">{</span><span class="mi">208</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span><span class="p">)},</span>
<span class="cm">/* 49 */</span> <span class="p">{</span><span class="mi">212</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span><span class="p">)},</span>
<span class="cm">/* 50 */</span> <span class="p">{</span><span class="mi">216</span><span class="p">,</span> <span class="p">(</span><span class="n">CH_LOWER_SB</span><span class="p">)}</span>
<span class="p">};</span>
<span class="cp">#endif				</span><span class="cm">/* SUPPORT_40MHZ */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">locale_info</span> <span class="o">*</span><span class="nf">brcms_c_get_locale_2g</span><span class="p">(</span><span class="n">u8</span> <span class="n">locale_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locale_idx</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">g_locale_2g_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* error condition */</span>

	<span class="k">return</span> <span class="n">g_locale_2g_table</span><span class="p">[</span><span class="n">locale_idx</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">locale_info</span> <span class="o">*</span><span class="nf">brcms_c_get_locale_5g</span><span class="p">(</span><span class="n">u8</span> <span class="n">locale_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locale_idx</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">g_locale_5g_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* error condition */</span>

	<span class="k">return</span> <span class="n">g_locale_5g_table</span><span class="p">[</span><span class="n">locale_idx</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">locale_mimo_info</span> <span class="o">*</span><span class="nf">brcms_c_get_mimo_2g</span><span class="p">(</span><span class="n">u8</span> <span class="n">locale_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locale_idx</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">g_mimo_2g_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">g_mimo_2g_table</span><span class="p">[</span><span class="n">locale_idx</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">locale_mimo_info</span> <span class="o">*</span><span class="nf">brcms_c_get_mimo_5g</span><span class="p">(</span><span class="n">u8</span> <span class="n">locale_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locale_idx</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">g_mimo_5g_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">g_mimo_5g_table</span><span class="p">[</span><span class="n">locale_idx</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcms_c_country_aggregate_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ccode</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">mapped_ccode</span><span class="p">,</span> <span class="n">uint</span> <span class="o">*</span><span class="n">mapped_regrev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Indicates whether the country provided is valid to pass</span>
<span class="cm"> * to cfg80211 or not.</span>
<span class="cm"> *</span>
<span class="cm"> * returns true if valid; false if not.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_country_valid</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ccode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * only allow ascii alpha uppercase for the first 2</span>
<span class="cm">	 * chars.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mh">0x80</span> <span class="o">&amp;</span> <span class="n">ccode</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ccode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x41</span> <span class="o">&amp;&amp;</span> <span class="n">ccode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0x5A</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="mh">0x80</span> <span class="o">&amp;</span> <span class="n">ccode</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ccode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x41</span> <span class="o">&amp;&amp;</span> <span class="n">ccode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0x5A</span> <span class="o">&amp;&amp;</span>
	      <span class="n">ccode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * do not match ISO 3166-1 user assigned country codes</span>
<span class="cm">	 * that may be in the driver table</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;AA&quot;</span><span class="p">,</span> <span class="n">ccode</span><span class="p">)</span> <span class="o">||</span>        <span class="cm">/* AA */</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;ZZ&quot;</span><span class="p">,</span> <span class="n">ccode</span><span class="p">)</span> <span class="o">||</span>        <span class="cm">/* ZZ */</span>
	    <span class="n">ccode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span> <span class="o">||</span>             <span class="cm">/* XA - XZ */</span>
	    <span class="p">(</span><span class="n">ccode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;Q&#39;</span> <span class="o">&amp;&amp;</span>            <span class="cm">/* QM - QZ */</span>
	     <span class="p">(</span><span class="n">ccode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;M&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ccode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;Z&#39;</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;NA&quot;</span><span class="p">,</span> <span class="n">ccode</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Lookup a country info structure from a null terminated country</span>
<span class="cm"> * abbreviation and regrev directly with no translation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">country_info</span> <span class="o">*</span>
<span class="nf">brcms_c_country_lookup_direct</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ccode</span><span class="p">,</span> <span class="n">uint</span> <span class="n">regrev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Should just return 0 for single locale driver. */</span>
	<span class="cm">/* Keep it this way in case we add more locales. (for now anyway) */</span>

	<span class="cm">/*</span>
<span class="cm">	 * all other country def arrays are for regrev == 0, so if</span>
<span class="cm">	 * regrev is non-zero, fail</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regrev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* find matched table entry from country code */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cntry_locales</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ccode</span><span class="p">,</span> <span class="n">cntry_locales</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">abbrev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">cntry_locales</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">country</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">country_info</span> <span class="o">*</span>
<span class="nf">brcms_c_countrycode_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ccode</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">mapped_ccode</span><span class="p">,</span> <span class="n">uint</span> <span class="o">*</span><span class="n">mapped_regrev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">country_info</span> <span class="o">*</span><span class="n">country</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">srom_regrev</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">srom_regrev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">srom_ccode</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">srom_ccode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mapped</span><span class="p">;</span>

	<span class="cm">/* check for currently supported ccode size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">ccode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">BRCM_CNTRY_BUF_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: ccode </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> too long for &quot;</span>
			  <span class="s">&quot;match</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ccode</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* default mapping is the given ccode and regrev 0 */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">mapped_ccode</span><span class="p">,</span> <span class="n">ccode</span><span class="p">,</span> <span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">);</span>
	<span class="o">*</span><span class="n">mapped_regrev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If the desired country code matches the srom country code,</span>
<span class="cm">	 * then the mapped country is the srom regulatory rev.</span>
<span class="cm">	 * Otherwise look for an aggregate mapping.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">srom_ccode</span><span class="p">,</span> <span class="n">ccode</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">mapped_regrev</span> <span class="o">=</span> <span class="n">srom_regrev</span><span class="p">;</span>
		<span class="n">mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;srom_code == ccode %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mapped</span> <span class="o">=</span>
		    <span class="n">brcms_c_country_aggregate_map</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">ccode</span><span class="p">,</span> <span class="n">mapped_ccode</span><span class="p">,</span>
					      <span class="n">mapped_regrev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* find the matching built-in country definition */</span>
	<span class="n">country</span> <span class="o">=</span> <span class="n">brcms_c_country_lookup_direct</span><span class="p">(</span><span class="n">mapped_ccode</span><span class="p">,</span> <span class="o">*</span><span class="n">mapped_regrev</span><span class="p">);</span>

	<span class="cm">/* if there is not an exact rev match, default to rev zero */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">country</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">mapped_regrev</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">mapped_regrev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">country</span> <span class="o">=</span>
		    <span class="n">brcms_c_country_lookup_direct</span><span class="p">(</span><span class="n">mapped_ccode</span><span class="p">,</span> <span class="o">*</span><span class="n">mapped_regrev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">country</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Lookup a country info structure from a null terminated country code</span>
<span class="cm"> * The lookup is case sensitive.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">country_info</span> <span class="o">*</span>
<span class="nf">brcms_c_country_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ccode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">country_info</span> <span class="o">*</span><span class="n">country</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">mapped_ccode</span><span class="p">[</span><span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">];</span>
	<span class="n">uint</span> <span class="n">mapped_regrev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * map the country code to a built-in country code, regrev, and</span>
<span class="cm">	 * country_info struct</span>
<span class="cm">	 */</span>
	<span class="n">country</span> <span class="o">=</span> <span class="n">brcms_c_countrycode_map</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span> <span class="n">ccode</span><span class="p">,</span> <span class="n">mapped_ccode</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">mapped_regrev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">country</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * reset the quiet channels vector to the union</span>
<span class="cm"> * of the restricted and radar channel sets</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_quiet_channels_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_band</span> <span class="o">*</span><span class="n">band</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="o">*</span><span class="n">chanvec</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">quiet_channels</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_chanvec</span><span class="p">));</span>

	<span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">OTHERBANDUNIT</span><span class="p">(</span><span class="n">wlc</span><span class="p">)])</span> <span class="p">{</span>

		<span class="cm">/* initialize quiet channels for restricted channels */</span>
		<span class="n">chanvec</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">].</span><span class="n">restricted_channels</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_chanvec</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">quiet_channels</span><span class="p">.</span><span class="n">vec</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">chanvec</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Is the channel valid for the current locale and current band? */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_valid_channel20</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">uint</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">MAXCHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">isset</span><span class="p">(</span><span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">].</span><span class="n">valid_channels</span><span class="p">.</span><span class="n">vec</span><span class="p">,</span>
		      <span class="n">val</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Is the channel valid for the current locale and specified band? */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_valid_channel20_in_band</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span>
					    <span class="n">uint</span> <span class="n">bandunit</span><span class="p">,</span> <span class="n">uint</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">MAXCHANNEL</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="n">isset</span><span class="p">(</span><span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">bandunit</span><span class="p">].</span><span class="n">valid_channels</span><span class="p">.</span><span class="n">vec</span><span class="p">,</span> <span class="n">val</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Is the channel valid for the current locale? (but don&#39;t consider channels not</span>
<span class="cm"> *   available due to bandlocking)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_valid_channel20_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">uint</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">brcms_c_valid_channel20</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandlocked</span>
		 <span class="o">&amp;&amp;</span> <span class="n">brcms_c_valid_channel20_in_band</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span>
						    <span class="n">OTHERBANDUNIT</span><span class="p">(</span><span class="n">wlc</span><span class="p">),</span> <span class="n">val</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* JP, J1 - J10 are Japan ccodes */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_japan_ccode</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ccode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ccode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;J&#39;</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ccode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;P&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="n">ccode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;1&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ccode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/* Returns true if currently set country is Japan or variant */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_japan</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">brcms_c_japan_ccode</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="o">-&gt;</span><span class="n">country_abbrev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_c_channel_min_txpower_limits_with_local_constraint</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">txpwr_limits</span> <span class="o">*</span><span class="n">txpwr</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">local_constraint_qdbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/* CCK Rates */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">WL_TX_POWER_CCK_NUM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">cck</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">cck</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

	<span class="cm">/* 20 MHz Legacy OFDM SISO */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">WL_TX_POWER_OFDM_NUM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

	<span class="cm">/* 20 MHz Legacy OFDM CDD */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_cdd</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_cdd</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

	<span class="cm">/* 40 MHz Legacy OFDM SISO */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_siso</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_siso</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

	<span class="cm">/* 40 MHz Legacy OFDM CDD */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_cdd</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_cdd</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

	<span class="cm">/* 20MHz MCS 0-7 SISO */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_siso</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_siso</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

	<span class="cm">/* 20MHz MCS 0-7 CDD */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_cdd</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_cdd</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

	<span class="cm">/* 20MHz MCS 0-7 STBC */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_stbc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_stbc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

	<span class="cm">/* 20MHz MCS 8-15 MIMO */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_2_STREAM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_mimo</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_mimo</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

	<span class="cm">/* 40MHz MCS 0-7 SISO */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_siso</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_siso</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

	<span class="cm">/* 40MHz MCS 0-7 CDD */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_cdd</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_cdd</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

	<span class="cm">/* 40MHz MCS 0-7 STBC */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_stbc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_stbc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

	<span class="cm">/* 40MHz MCS 8-15 MIMO */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_2_STREAM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_mimo</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_mimo</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

	<span class="cm">/* 40MHz MCS 32 */</span>
	<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs32</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs32</span><span class="p">,</span> <span class="n">local_constraint_qdbm</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* Update the radio state (enable/disable) and tx power targets</span>
<span class="cm"> * based on a new set of channel/regulatory information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_channels_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txpwr_limits</span> <span class="n">txpwr</span><span class="p">;</span>

	<span class="cm">/* search for the existence of any valid channel */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">MAXCHANNEL</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brcms_c_valid_channel20_db</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="n">MAXCHANNEL</span><span class="p">)</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">INVCHANNEL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * based on the channel search above, set or</span>
<span class="cm">	 * clear WL_RADIO_COUNTRY_DISABLE.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="n">INVCHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * country/locale with no valid channels, set</span>
<span class="cm">		 * the radio disable bit</span>
<span class="cm">		 */</span>
		<span class="n">mboolset</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">radio_disabled</span><span class="p">,</span> <span class="n">WL_RADIO_COUNTRY_DISABLE</span><span class="p">);</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: no valid channel for </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> &quot;</span>
			  <span class="s">&quot;nbands %d bandlocked %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">country_abbrev</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span><span class="p">,</span>
			  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandlocked</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mboolisset</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">radio_disabled</span><span class="p">,</span>
			      <span class="n">WL_RADIO_COUNTRY_DISABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * country/locale with valid channel, clear</span>
<span class="cm">		 * the radio disable bit</span>
<span class="cm">		 */</span>
		<span class="n">mboolclr</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">radio_disabled</span><span class="p">,</span> <span class="n">WL_RADIO_COUNTRY_DISABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now that the country abbreviation is set, if the radio supports 2G,</span>
<span class="cm">	 * then set channel 14 restrictions based on the new locale.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span><span class="p">)</span>
		<span class="n">wlc_phy_chanspec_ch14_widefilter_set</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span>
						     <span class="n">brcms_c_japan</span><span class="p">(</span><span class="n">wlc</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span>
						     <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span> <span class="o">!=</span> <span class="n">INVCHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_c_channel_reg_limits</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txpwr</span><span class="p">);</span>
		<span class="n">brcms_c_channel_min_txpower_limits_with_local_constraint</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">txpwr</span><span class="p">,</span> <span class="n">BRCMS_TXPWR_MAX</span><span class="p">);</span>
		<span class="n">wlc_phy_txpower_limit_set</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txpwr</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcms_c_channels_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">country_info</span> <span class="o">*</span><span class="n">country</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_band</span> <span class="o">*</span><span class="n">band</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">locale_info</span> <span class="o">*</span><span class="n">li</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_chanvec</span> <span class="n">sup_chan</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">locale_mimo_info</span> <span class="o">*</span><span class="n">li_mimo</span><span class="p">;</span>

	<span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">OTHERBANDUNIT</span><span class="p">(</span><span class="n">wlc</span><span class="p">)])</span> <span class="p">{</span>

		<span class="n">li</span> <span class="o">=</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">brcms_c_get_locale_5g</span><span class="p">(</span><span class="n">country</span><span class="o">-&gt;</span><span class="n">locale_5G</span><span class="p">)</span> <span class="o">:</span>
		    <span class="n">brcms_c_get_locale_2g</span><span class="p">(</span><span class="n">country</span><span class="o">-&gt;</span><span class="n">locale_2G</span><span class="p">);</span>
		<span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">].</span><span class="n">locale_flags</span> <span class="o">=</span> <span class="n">li</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">li_mimo</span> <span class="o">=</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">brcms_c_get_mimo_5g</span><span class="p">(</span><span class="n">country</span><span class="o">-&gt;</span><span class="n">locale_mimo_5G</span><span class="p">)</span> <span class="o">:</span>
		    <span class="n">brcms_c_get_mimo_2g</span><span class="p">(</span><span class="n">country</span><span class="o">-&gt;</span><span class="n">locale_mimo_2G</span><span class="p">);</span>

		<span class="cm">/* merge the mimo non-mimo locale flags */</span>
		<span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">].</span><span class="n">locale_flags</span> <span class="o">|=</span>
		    <span class="n">li_mimo</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

		<span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">].</span><span class="n">restricted_channels</span> <span class="o">=</span>
		    <span class="n">g_table_restricted_chan</span><span class="p">[</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">restricted_channels</span><span class="p">];</span>
		<span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">].</span><span class="n">radar_channels</span> <span class="o">=</span>
		    <span class="n">g_table_radar_set</span><span class="p">[</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">radar_channels</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 * set the channel availability, masking out the channels</span>
<span class="cm">		 * that may not be supported on this phy.</span>
<span class="cm">		 */</span>
		<span class="n">wlc_phy_chanspec_band_validch</span><span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">sup_chan</span><span class="p">);</span>
		<span class="n">brcms_c_locale_get_channels</span><span class="p">(</span><span class="n">li</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">].</span>
					<span class="n">valid_channels</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_chanvec</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">].</span><span class="n">valid_channels</span><span class="p">.</span>
			    <span class="n">vec</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">sup_chan</span><span class="p">.</span><span class="n">vec</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">brcms_c_quiet_channels_reset</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">);</span>
	<span class="n">brcms_c_channels_commit</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the driver&#39;s current country and regulatory information</span>
<span class="cm"> * using a country code as the source. Look up built in country</span>
<span class="cm"> * information found with the country code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_c_set_country_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">country_abbrev</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ccode</span><span class="p">,</span> <span class="n">uint</span> <span class="n">regrev</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">country_info</span> <span class="o">*</span><span class="n">country</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">locale_info</span> <span class="o">*</span><span class="n">locale</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">prev_country_abbrev</span><span class="p">[</span><span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">];</span>

	<span class="cm">/* save current country state */</span>
	<span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">country</span> <span class="o">=</span> <span class="n">country</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev_country_abbrev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">prev_country_abbrev</span><span class="p">,</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">country_abbrev</span><span class="p">,</span>
		<span class="n">BRCM_CNTRY_BUF_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">country_abbrev</span><span class="p">,</span> <span class="n">country_abbrev</span><span class="p">,</span> <span class="n">BRCM_CNTRY_BUF_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">ccode</span><span class="p">,</span> <span class="n">ccode</span><span class="p">,</span> <span class="n">BRCM_CNTRY_BUF_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">regrev</span> <span class="o">=</span> <span class="n">regrev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">&amp;</span> <span class="n">SUPPORT_11N</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">nmode_user</span><span class="p">)</span>
		<span class="n">brcms_c_set_nmode</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="n">brcms_c_stf_ss_update</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">BAND_2G_INDEX</span><span class="p">]);</span>
	<span class="n">brcms_c_stf_ss_update</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">BAND_5G_INDEX</span><span class="p">]);</span>
	<span class="cm">/* set or restore gmode as required by regulatory */</span>
	<span class="n">locale</span> <span class="o">=</span> <span class="n">brcms_c_get_locale_2g</span><span class="p">(</span><span class="n">country</span><span class="o">-&gt;</span><span class="n">locale_2G</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locale</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">locale</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BRCMS_NO_OFDM</span><span class="p">))</span>
		<span class="n">brcms_c_set_gmode</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">GMODE_LEGACY_B</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">brcms_c_set_gmode</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">gmode_user</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">brcms_c_channels_init</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">country</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcms_c_set_countrycode_rev</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">country_abbrev</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ccode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regrev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">country_info</span> <span class="o">*</span><span class="n">country</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">mapped_ccode</span><span class="p">[</span><span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">];</span>
	<span class="n">uint</span> <span class="n">mapped_regrev</span><span class="p">;</span>

	<span class="cm">/* if regrev is -1, lookup the mapped country code,</span>
<span class="cm">	 * otherwise use the ccode and regrev directly</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regrev</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * map the country code to a built-in country</span>
<span class="cm">		 * code, regrev, and country_info</span>
<span class="cm">		 */</span>
		<span class="n">country</span> <span class="o">=</span>
		    <span class="n">brcms_c_countrycode_map</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">ccode</span><span class="p">,</span> <span class="n">mapped_ccode</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">mapped_regrev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* find the matching built-in country definition */</span>
		<span class="n">country</span> <span class="o">=</span> <span class="n">brcms_c_country_lookup_direct</span><span class="p">(</span><span class="n">ccode</span><span class="p">,</span> <span class="n">regrev</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">mapped_ccode</span><span class="p">,</span> <span class="n">ccode</span><span class="p">,</span> <span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">);</span>
		<span class="n">mapped_regrev</span> <span class="o">=</span> <span class="n">regrev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">country</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* set the driver state for the country */</span>
	<span class="n">brcms_c_set_country_common</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">country_abbrev</span><span class="p">,</span> <span class="n">mapped_ccode</span><span class="p">,</span>
			       <span class="n">mapped_regrev</span><span class="p">,</span> <span class="n">country</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the driver&#39;s current country and regulatory information using</span>
<span class="cm"> * a country code as the source. Lookup built in country information</span>
<span class="cm"> * found with the country code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcms_c_set_countrycode</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ccode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">country_abbrev</span><span class="p">[</span><span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">];</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">country_abbrev</span><span class="p">,</span> <span class="n">ccode</span><span class="p">,</span> <span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">brcms_c_set_countrycode_rev</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">country_abbrev</span><span class="p">,</span> <span class="n">ccode</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="nf">brcms_c_channel_mgr_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">country_abbrev</span><span class="p">[</span><span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">country_info</span> <span class="o">*</span><span class="n">country</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_pub</span> <span class="o">*</span><span class="n">pub</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="n">wlc_cm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_cm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">pub</span> <span class="o">=</span> <span class="n">pub</span><span class="p">;</span>
	<span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="p">;</span>

	<span class="cm">/* store the country code for passing up as a regulatory hint */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">alpha2</span> <span class="o">&amp;&amp;</span> <span class="n">brcms_c_country_valid</span><span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">))</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">srom_ccode</span><span class="p">,</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * internal country information which must match</span>
<span class="cm">	 * regulatory constraints in firmware</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">country_abbrev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BRCM_CNTRY_BUF_SZ</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">country_abbrev</span><span class="p">,</span> <span class="s">&quot;X2&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">country_abbrev</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">country</span> <span class="o">=</span> <span class="n">brcms_c_country_lookup</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">country_abbrev</span><span class="p">);</span>

	<span class="cm">/* save default country for exiting 11d regulatory mode */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">country_default</span><span class="p">,</span> <span class="n">country_abbrev</span><span class="p">,</span> <span class="n">BRCM_CNTRY_BUF_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* initialize autocountry_default to driver default */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">autocountry_default</span><span class="p">,</span> <span class="s">&quot;X2&quot;</span><span class="p">,</span> <span class="n">BRCM_CNTRY_BUF_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">brcms_c_set_countrycode</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">country_abbrev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wlc_cm</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_channel_mgr_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u8</span>
<span class="nf">brcms_c_channel_locale_flags_in_band</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span>
				     <span class="n">uint</span> <span class="n">bandunit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">bandunit</span><span class="p">].</span><span class="n">locale_flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">brcms_c_quiet_chanspec</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">&amp;</span> <span class="n">SUPPORT_11N</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">CHSPEC_IS40</span><span class="p">(</span><span class="n">chspec</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">isset</span><span class="p">(</span><span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">quiet_channels</span><span class="p">.</span><span class="n">vec</span><span class="p">,</span>
		       <span class="n">lower_20_sb</span><span class="p">(</span><span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">chspec</span><span class="p">)))</span> <span class="o">||</span>
		 <span class="n">isset</span><span class="p">(</span><span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">quiet_channels</span><span class="p">.</span><span class="n">vec</span><span class="p">,</span>
		       <span class="n">upper_20_sb</span><span class="p">(</span><span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">chspec</span><span class="p">))))</span> <span class="o">:</span>
		<span class="n">isset</span><span class="p">(</span><span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">quiet_channels</span><span class="p">.</span><span class="n">vec</span><span class="p">,</span> <span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">chspec</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">brcms_c_channel_set_chanspec</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chanspec</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">local_constraint_qdbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txpwr_limits</span> <span class="n">txpwr</span><span class="p">;</span>

	<span class="n">brcms_c_channel_reg_limits</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txpwr</span><span class="p">);</span>

	<span class="n">brcms_c_channel_min_txpower_limits_with_local_constraint</span><span class="p">(</span>
		<span class="n">wlc_cm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txpwr</span><span class="p">,</span> <span class="n">local_constraint_qdbm</span>
	<span class="p">);</span>

	<span class="n">brcms_b_set_chanspec</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">brcms_c_quiet_chanspec</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="o">&amp;</span><span class="n">txpwr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">brcms_c_channel_reg_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chanspec</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">txpwr_limits</span> <span class="o">*</span><span class="n">txpwr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxpwr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delta</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">country_info</span> <span class="o">*</span><span class="n">country</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_band</span> <span class="o">*</span><span class="n">band</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">locale_info</span> <span class="o">*</span><span class="n">li</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">conducted_max</span> <span class="o">=</span> <span class="n">BRCMS_TXPWR_MAX</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">conducted_ofdm_max</span> <span class="o">=</span> <span class="n">BRCMS_TXPWR_MAX</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">locale_mimo_info</span> <span class="o">*</span><span class="n">li_mimo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxpwr20</span><span class="p">,</span> <span class="n">maxpwr40</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxpwr_idx</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">txpwr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">txpwr_limits</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_c_valid_chanspec_db</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">country</span> <span class="o">=</span> <span class="n">brcms_c_country_lookup</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">autocountry_default</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">country</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">country</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">country</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">chanspec</span><span class="p">);</span>
	<span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">chspec_bandunit</span><span class="p">(</span><span class="n">chanspec</span><span class="p">)];</span>
	<span class="n">li</span> <span class="o">=</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">brcms_c_get_locale_5g</span><span class="p">(</span><span class="n">country</span><span class="o">-&gt;</span><span class="n">locale_5G</span><span class="p">)</span> <span class="o">:</span>
	    <span class="n">brcms_c_get_locale_2g</span><span class="p">(</span><span class="n">country</span><span class="o">-&gt;</span><span class="n">locale_2G</span><span class="p">);</span>

	<span class="n">li_mimo</span> <span class="o">=</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">brcms_c_get_mimo_5g</span><span class="p">(</span><span class="n">country</span><span class="o">-&gt;</span><span class="n">locale_mimo_5G</span><span class="p">)</span> <span class="o">:</span>
	    <span class="n">brcms_c_get_mimo_2g</span><span class="p">(</span><span class="n">country</span><span class="o">-&gt;</span><span class="n">locale_mimo_2G</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BRCMS_EIRP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span> <span class="o">&gt;</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span> <span class="o">-</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>	<span class="cm">/* Excess over 6 dB */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">li</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">locale_i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conducted_max</span> <span class="o">=</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span>
		<span class="n">conducted_ofdm_max</span> <span class="o">=</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* CCK txpwr limits for 2.4G band */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maxpwr</span> <span class="o">=</span> <span class="n">li</span><span class="o">-&gt;</span><span class="n">maxpwr</span><span class="p">[</span><span class="n">CHANNEL_POWER_IDX_2G_CCK</span><span class="p">(</span><span class="n">chan</span><span class="p">)];</span>

		<span class="n">maxpwr</span> <span class="o">=</span> <span class="n">maxpwr</span> <span class="o">-</span> <span class="n">delta</span><span class="p">;</span>
		<span class="n">maxpwr</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">maxpwr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">maxpwr</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">maxpwr</span><span class="p">,</span> <span class="n">conducted_max</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_CCK</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">cck</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">maxpwr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* OFDM txpwr limits for 2.4G or 5G bands */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span><span class="p">)</span>
		<span class="n">maxpwr</span> <span class="o">=</span> <span class="n">li</span><span class="o">-&gt;</span><span class="n">maxpwr</span><span class="p">[</span><span class="n">CHANNEL_POWER_IDX_2G_OFDM</span><span class="p">(</span><span class="n">chan</span><span class="p">)];</span>
	<span class="k">else</span>
		<span class="n">maxpwr</span> <span class="o">=</span> <span class="n">li</span><span class="o">-&gt;</span><span class="n">maxpwr</span><span class="p">[</span><span class="n">CHANNEL_POWER_IDX_5G</span><span class="p">(</span><span class="n">chan</span><span class="p">)];</span>

	<span class="n">maxpwr</span> <span class="o">=</span> <span class="n">maxpwr</span> <span class="o">-</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">maxpwr</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">maxpwr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">maxpwr</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">maxpwr</span><span class="p">,</span> <span class="n">conducted_ofdm_max</span><span class="p">);</span>

	<span class="cm">/* Keep OFDM lmit below CCK limit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span><span class="p">)</span>
		<span class="n">maxpwr</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">maxpwr</span><span class="p">,</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">cck</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">maxpwr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * OFDM 40 MHz SISO has the same power as the corresponding</span>
<span class="cm">		 * MCS0-7 rate unless overriden by the locale specific code.</span>
<span class="cm">		 * We set this value to 0 as a flag (presumably 0 dBm isn&#39;t</span>
<span class="cm">		 * a possibility) and then copy the MCS0-7 value to the 40 MHz</span>
<span class="cm">		 * value if it wasn&#39;t explicitly set.</span>
<span class="cm">		 */</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_siso</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_cdd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">maxpwr</span><span class="p">;</span>

		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_cdd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* MIMO/HT specific limits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_mimo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BRCMS_EIRP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span> <span class="o">&gt;</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span> <span class="o">-</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>	<span class="cm">/* Excess over 6 dB */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span><span class="p">)</span>
		<span class="n">maxpwr_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">chan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">maxpwr_idx</span> <span class="o">=</span> <span class="n">CHANNEL_POWER_IDX_5G</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">maxpwr20</span> <span class="o">=</span> <span class="n">li_mimo</span><span class="o">-&gt;</span><span class="n">maxpwr20</span><span class="p">[</span><span class="n">maxpwr_idx</span><span class="p">];</span>
	<span class="n">maxpwr40</span> <span class="o">=</span> <span class="n">li_mimo</span><span class="o">-&gt;</span><span class="n">maxpwr40</span><span class="p">[</span><span class="n">maxpwr_idx</span><span class="p">];</span>

	<span class="n">maxpwr20</span> <span class="o">=</span> <span class="n">maxpwr20</span> <span class="o">-</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">maxpwr20</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">maxpwr20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">maxpwr40</span> <span class="o">=</span> <span class="n">maxpwr40</span> <span class="o">-</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">maxpwr40</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">maxpwr40</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Fill in the MCS 0-7 (SISO) rates */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * 20 MHz has the same power as the corresponding OFDM rate</span>
<span class="cm">		 * unless overriden by the locale specific code.</span>
<span class="cm">		 */</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_siso</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_siso</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill in the MCS 0-7 CDD rates */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_cdd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">maxpwr20</span><span class="p">;</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_cdd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">maxpwr40</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * These locales have SISO expressed in the</span>
<span class="cm">	 * table and override CDD later</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_mimo</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">locale_bn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">li_mimo</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">locale_bn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">maxpwr20</span> <span class="o">=</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
			<span class="n">maxpwr40</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">)</span>
				<span class="n">maxpwr40</span> <span class="o">=</span> <span class="n">QDB</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_siso</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">maxpwr20</span><span class="p">;</span>
			<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_siso</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">maxpwr40</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Fill in the MCS 0-7 STBC rates */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_stbc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_stbc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill in the MCS 8-15 SDM rates */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_2_STREAM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_mimo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">maxpwr20</span><span class="p">;</span>
		<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_mimo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">maxpwr40</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill in MCS32 */</span>
	<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs32</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">maxpwr40</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_cdd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_cdd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_cdd</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_cdd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_cdd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_cdd</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the 40 MHZ MCS 0-7 CDD value to the 40 MHZ MCS 0-7 SISO</span>
<span class="cm">	 * value if it wasn&#39;t provided explicitly.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_siso</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_siso</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_cdd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_OFDM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_siso</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_siso</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_siso</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_siso</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">ofdm_40_siso</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_siso</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the 20 and 40 MHz MCS0-7 CDD values to the corresponding</span>
<span class="cm">	 * STBC values if they weren&#39;t provided explicitly.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_NUM_RATES_MCS_1_STREAM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_stbc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_stbc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_20_cdd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_stbc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_stbc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpwr</span><span class="o">-&gt;</span><span class="n">mcs_40_cdd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Verify the chanspec is using a legal set of parameters, i.e. that the</span>
<span class="cm"> * chanspec specified a band, bw, ctl_sb and channel and that the</span>
<span class="cm"> * combination could be legal given any set of circumstances.</span>
<span class="cm"> * RETURNS: true is the chanspec is malformed, false if it looks good.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_chspec_malformed</span><span class="p">(</span><span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be 2G or 5G band */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHSPEC_IS5G</span><span class="p">(</span><span class="n">chanspec</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHSPEC_IS2G</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/* must be 20 or 40 bandwidth */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHSPEC_IS40</span><span class="p">(</span><span class="n">chanspec</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHSPEC_IS20</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* 20MHZ b/w must have no ctl sb, 40 must have a ctl sb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHSPEC_IS20</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHSPEC_SB_NONE</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHSPEC_SB_UPPER</span><span class="p">(</span><span class="n">chanspec</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHSPEC_SB_LOWER</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Validate the chanspec for this locale, for 40MHZ we need to also</span>
<span class="cm"> * check that the sidebands are valid 20MZH channels in this locale</span>
<span class="cm"> * and they are also a legal HT combination</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">brcms_c_valid_chanspec_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chspec</span><span class="p">,</span>
			   <span class="n">bool</span> <span class="n">dualband</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">chspec</span><span class="p">);</span>

	<span class="cm">/* check the chanspec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcms_c_chspec_malformed</span><span class="p">(</span><span class="n">chspec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: malformed chanspec 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">chspec</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHANNEL_BANDUNIT</span><span class="p">(</span><span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">chspec_bandunit</span><span class="p">(</span><span class="n">chspec</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Check a 20Mhz channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHSPEC_IS20</span><span class="p">(</span><span class="n">chspec</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dualband</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">brcms_c_valid_channel20_db</span><span class="p">(</span><span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span>
							  <span class="n">channel</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">brcms_c_valid_channel20</span><span class="p">(</span><span class="n">wlc_cm</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span>
						       <span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef SUPPORT_40MHZ</span>
	<span class="cm">/*</span>
<span class="cm">	 * We know we are now checking a 40MHZ channel, so we should</span>
<span class="cm">	 * only be here for NPHYS</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISNPHY</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="o">||</span> <span class="n">BRCMS_ISSSLPNPHY</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">upper_sideband</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">num_ch20_entries</span> <span class="o">=</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">chan20_info</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chan20_info</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">VALID_40CHANSPEC_IN_BAND</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">chspec_bandunit</span><span class="p">(</span><span class="n">chspec</span><span class="p">)))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dualband</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_c_valid_channel20_db</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span>
							<span class="n">lower_20_sb</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">brcms_c_valid_channel20_db</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span>
							<span class="n">upper_20_sb</span><span class="p">(</span><span class="n">channel</span><span class="p">)))</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_c_valid_channel20</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span>
						     <span class="n">lower_20_sb</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">brcms_c_valid_channel20</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span>
						     <span class="n">upper_20_sb</span><span class="p">(</span><span class="n">channel</span><span class="p">)))</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* find the lower sideband info in the sideband array */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">num_ch20_entries</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan20_info</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">sb</span> <span class="o">==</span> <span class="n">lower_20_sb</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span>
				<span class="n">upper_sideband</span> <span class="o">=</span> <span class="n">chan20_info</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">adj_sbs</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* check that the lower sideband allows an upper sideband */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">upper_sideband</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">))</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">CH_UPPER_SB</span> <span class="o">|</span> <span class="n">CH_EWA_VALID</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* 40 MHZ */</span><span class="cp"></span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">brcms_c_valid_chanspec_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_cm_info</span> <span class="o">*</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">brcms_c_valid_chanspec_ext</span><span class="p">(</span><span class="n">wlc_cm</span><span class="p">,</span> <span class="n">chspec</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
