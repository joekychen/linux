<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › brcm80211 › brcmsmac › dma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>dma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY</span>
<span class="cm"> * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION</span>
<span class="cm"> * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>

<span class="cp">#include &lt;brcmu_utils.h&gt;</span>
<span class="cp">#include &lt;aiutils.h&gt;</span>
<span class="cp">#include &quot;types.h&quot;</span>
<span class="cp">#include &quot;dma.h&quot;</span>
<span class="cp">#include &quot;soc.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * dma register field offset calculation</span>
<span class="cm"> */</span>
<span class="cp">#define DMA64REGOFFS(field)		offsetof(struct dma64regs, field)</span>
<span class="cp">#define DMA64TXREGOFFS(di, field)	(di-&gt;d64txregbase + DMA64REGOFFS(field))</span>
<span class="cp">#define DMA64RXREGOFFS(di, field)	(di-&gt;d64rxregbase + DMA64REGOFFS(field))</span>

<span class="cm">/*</span>
<span class="cm"> * DMA hardware requires each descriptor ring to be 8kB aligned, and fit within</span>
<span class="cm"> * a contiguous 8kB physical address.</span>
<span class="cm"> */</span>
<span class="cp">#define D64RINGALIGN_BITS	13</span>
<span class="cp">#define	D64MAXRINGSZ		(1 &lt;&lt; D64RINGALIGN_BITS)</span>
<span class="cp">#define	D64RINGALIGN		(1 &lt;&lt; D64RINGALIGN_BITS)</span>

<span class="cp">#define	D64MAXDD	(D64MAXRINGSZ / sizeof(struct dma64desc))</span>

<span class="cm">/* transmit channel control */</span>
<span class="cp">#define	D64_XC_XE		0x00000001	</span><span class="cm">/* transmit enable */</span><span class="cp"></span>
<span class="cp">#define	D64_XC_SE		0x00000002	</span><span class="cm">/* transmit suspend request */</span><span class="cp"></span>
<span class="cp">#define	D64_XC_LE		0x00000004	</span><span class="cm">/* loopback enable */</span><span class="cp"></span>
<span class="cp">#define	D64_XC_FL		0x00000010	</span><span class="cm">/* flush request */</span><span class="cp"></span>
<span class="cp">#define	D64_XC_PD		0x00000800	</span><span class="cm">/* parity check disable */</span><span class="cp"></span>
<span class="cp">#define	D64_XC_AE		0x00030000	</span><span class="cm">/* address extension bits */</span><span class="cp"></span>
<span class="cp">#define	D64_XC_AE_SHIFT		16</span>

<span class="cm">/* transmit descriptor table pointer */</span>
<span class="cp">#define	D64_XP_LD_MASK		0x00000fff	</span><span class="cm">/* last valid descriptor */</span><span class="cp"></span>

<span class="cm">/* transmit channel status */</span>
<span class="cp">#define	D64_XS0_CD_MASK		0x00001fff	</span><span class="cm">/* current descriptor pointer */</span><span class="cp"></span>
<span class="cp">#define	D64_XS0_XS_MASK		0xf0000000	</span><span class="cm">/* transmit state */</span><span class="cp"></span>
<span class="cp">#define	D64_XS0_XS_SHIFT		28</span>
<span class="cp">#define	D64_XS0_XS_DISABLED	0x00000000	</span><span class="cm">/* disabled */</span><span class="cp"></span>
<span class="cp">#define	D64_XS0_XS_ACTIVE	0x10000000	</span><span class="cm">/* active */</span><span class="cp"></span>
<span class="cp">#define	D64_XS0_XS_IDLE		0x20000000	</span><span class="cm">/* idle wait */</span><span class="cp"></span>
<span class="cp">#define	D64_XS0_XS_STOPPED	0x30000000	</span><span class="cm">/* stopped */</span><span class="cp"></span>
<span class="cp">#define	D64_XS0_XS_SUSP		0x40000000	</span><span class="cm">/* suspend pending */</span><span class="cp"></span>

<span class="cp">#define	D64_XS1_AD_MASK		0x00001fff	</span><span class="cm">/* active descriptor */</span><span class="cp"></span>
<span class="cp">#define	D64_XS1_XE_MASK		0xf0000000	</span><span class="cm">/* transmit errors */</span><span class="cp"></span>
<span class="cp">#define	D64_XS1_XE_SHIFT		28</span>
<span class="cp">#define	D64_XS1_XE_NOERR	0x00000000	</span><span class="cm">/* no error */</span><span class="cp"></span>
<span class="cp">#define	D64_XS1_XE_DPE		0x10000000	</span><span class="cm">/* descriptor protocol error */</span><span class="cp"></span>
<span class="cp">#define	D64_XS1_XE_DFU		0x20000000	</span><span class="cm">/* data fifo underrun */</span><span class="cp"></span>
<span class="cp">#define	D64_XS1_XE_DTE		0x30000000	</span><span class="cm">/* data transfer error */</span><span class="cp"></span>
<span class="cp">#define	D64_XS1_XE_DESRE	0x40000000	</span><span class="cm">/* descriptor read error */</span><span class="cp"></span>
<span class="cp">#define	D64_XS1_XE_COREE	0x50000000	</span><span class="cm">/* core error */</span><span class="cp"></span>

<span class="cm">/* receive channel control */</span>
<span class="cm">/* receive enable */</span>
<span class="cp">#define	D64_RC_RE		0x00000001</span>
<span class="cm">/* receive frame offset */</span>
<span class="cp">#define	D64_RC_RO_MASK		0x000000fe</span>
<span class="cp">#define	D64_RC_RO_SHIFT		1</span>
<span class="cm">/* direct fifo receive (pio) mode */</span>
<span class="cp">#define	D64_RC_FM		0x00000100</span>
<span class="cm">/* separate rx header descriptor enable */</span>
<span class="cp">#define	D64_RC_SH		0x00000200</span>
<span class="cm">/* overflow continue */</span>
<span class="cp">#define	D64_RC_OC		0x00000400</span>
<span class="cm">/* parity check disable */</span>
<span class="cp">#define	D64_RC_PD		0x00000800</span>
<span class="cm">/* address extension bits */</span>
<span class="cp">#define	D64_RC_AE		0x00030000</span>
<span class="cp">#define	D64_RC_AE_SHIFT		16</span>

<span class="cm">/* flags for dma controller */</span>
<span class="cm">/* partity enable */</span>
<span class="cp">#define DMA_CTRL_PEN		(1 &lt;&lt; 0)</span>
<span class="cm">/* rx overflow continue */</span>
<span class="cp">#define DMA_CTRL_ROC		(1 &lt;&lt; 1)</span>
<span class="cm">/* allow rx scatter to multiple descriptors */</span>
<span class="cp">#define DMA_CTRL_RXMULTI	(1 &lt;&lt; 2)</span>
<span class="cm">/* Unframed Rx/Tx data */</span>
<span class="cp">#define DMA_CTRL_UNFRAMED	(1 &lt;&lt; 3)</span>

<span class="cm">/* receive descriptor table pointer */</span>
<span class="cp">#define	D64_RP_LD_MASK		0x00000fff	</span><span class="cm">/* last valid descriptor */</span><span class="cp"></span>

<span class="cm">/* receive channel status */</span>
<span class="cp">#define	D64_RS0_CD_MASK		0x00001fff	</span><span class="cm">/* current descriptor pointer */</span><span class="cp"></span>
<span class="cp">#define	D64_RS0_RS_MASK		0xf0000000	</span><span class="cm">/* receive state */</span><span class="cp"></span>
<span class="cp">#define	D64_RS0_RS_SHIFT		28</span>
<span class="cp">#define	D64_RS0_RS_DISABLED	0x00000000	</span><span class="cm">/* disabled */</span><span class="cp"></span>
<span class="cp">#define	D64_RS0_RS_ACTIVE	0x10000000	</span><span class="cm">/* active */</span><span class="cp"></span>
<span class="cp">#define	D64_RS0_RS_IDLE		0x20000000	</span><span class="cm">/* idle wait */</span><span class="cp"></span>
<span class="cp">#define	D64_RS0_RS_STOPPED	0x30000000	</span><span class="cm">/* stopped */</span><span class="cp"></span>
<span class="cp">#define	D64_RS0_RS_SUSP		0x40000000	</span><span class="cm">/* suspend pending */</span><span class="cp"></span>

<span class="cp">#define	D64_RS1_AD_MASK		0x0001ffff	</span><span class="cm">/* active descriptor */</span><span class="cp"></span>
<span class="cp">#define	D64_RS1_RE_MASK		0xf0000000	</span><span class="cm">/* receive errors */</span><span class="cp"></span>
<span class="cp">#define	D64_RS1_RE_SHIFT		28</span>
<span class="cp">#define	D64_RS1_RE_NOERR	0x00000000	</span><span class="cm">/* no error */</span><span class="cp"></span>
<span class="cp">#define	D64_RS1_RE_DPO		0x10000000	</span><span class="cm">/* descriptor protocol error */</span><span class="cp"></span>
<span class="cp">#define	D64_RS1_RE_DFU		0x20000000	</span><span class="cm">/* data fifo overflow */</span><span class="cp"></span>
<span class="cp">#define	D64_RS1_RE_DTE		0x30000000	</span><span class="cm">/* data transfer error */</span><span class="cp"></span>
<span class="cp">#define	D64_RS1_RE_DESRE	0x40000000	</span><span class="cm">/* descriptor read error */</span><span class="cp"></span>
<span class="cp">#define	D64_RS1_RE_COREE	0x50000000	</span><span class="cm">/* core error */</span><span class="cp"></span>

<span class="cm">/* fifoaddr */</span>
<span class="cp">#define	D64_FA_OFF_MASK		0xffff	</span><span class="cm">/* offset */</span><span class="cp"></span>
<span class="cp">#define	D64_FA_SEL_MASK		0xf0000	</span><span class="cm">/* select */</span><span class="cp"></span>
<span class="cp">#define	D64_FA_SEL_SHIFT	16</span>
<span class="cp">#define	D64_FA_SEL_XDD		0x00000	</span><span class="cm">/* transmit dma data */</span><span class="cp"></span>
<span class="cp">#define	D64_FA_SEL_XDP		0x10000	</span><span class="cm">/* transmit dma pointers */</span><span class="cp"></span>
<span class="cp">#define	D64_FA_SEL_RDD		0x40000	</span><span class="cm">/* receive dma data */</span><span class="cp"></span>
<span class="cp">#define	D64_FA_SEL_RDP		0x50000	</span><span class="cm">/* receive dma pointers */</span><span class="cp"></span>
<span class="cp">#define	D64_FA_SEL_XFD		0x80000	</span><span class="cm">/* transmit fifo data */</span><span class="cp"></span>
<span class="cp">#define	D64_FA_SEL_XFP		0x90000	</span><span class="cm">/* transmit fifo pointers */</span><span class="cp"></span>
<span class="cp">#define	D64_FA_SEL_RFD		0xc0000	</span><span class="cm">/* receive fifo data */</span><span class="cp"></span>
<span class="cp">#define	D64_FA_SEL_RFP		0xd0000	</span><span class="cm">/* receive fifo pointers */</span><span class="cp"></span>
<span class="cp">#define	D64_FA_SEL_RSD		0xe0000	</span><span class="cm">/* receive frame status data */</span><span class="cp"></span>
<span class="cp">#define	D64_FA_SEL_RSP		0xf0000	</span><span class="cm">/* receive frame status pointers */</span><span class="cp"></span>

<span class="cm">/* descriptor control flags 1 */</span>
<span class="cp">#define D64_CTRL_COREFLAGS	0x0ff00000	</span><span class="cm">/* core specific flags */</span><span class="cp"></span>
<span class="cp">#define	D64_CTRL1_EOT		((u32)1 &lt;&lt; 28)	</span><span class="cm">/* end of descriptor table */</span><span class="cp"></span>
<span class="cp">#define	D64_CTRL1_IOC		((u32)1 &lt;&lt; 29)	</span><span class="cm">/* interrupt on completion */</span><span class="cp"></span>
<span class="cp">#define	D64_CTRL1_EOF		((u32)1 &lt;&lt; 30)	</span><span class="cm">/* end of frame */</span><span class="cp"></span>
<span class="cp">#define	D64_CTRL1_SOF		((u32)1 &lt;&lt; 31)	</span><span class="cm">/* start of frame */</span><span class="cp"></span>

<span class="cm">/* descriptor control flags 2 */</span>
<span class="cm">/* buffer byte count. real data len must &lt;= 16KB */</span>
<span class="cp">#define	D64_CTRL2_BC_MASK	0x00007fff</span>
<span class="cm">/* address extension bits */</span>
<span class="cp">#define	D64_CTRL2_AE		0x00030000</span>
<span class="cp">#define	D64_CTRL2_AE_SHIFT	16</span>
<span class="cm">/* parity bit */</span>
<span class="cp">#define D64_CTRL2_PARITY	0x00040000</span>

<span class="cm">/* control flags in the range [27:20] are core-specific and not defined here */</span>
<span class="cp">#define	D64_CTRL_CORE_MASK	0x0ff00000</span>

<span class="cp">#define D64_RX_FRM_STS_LEN	0x0000ffff	</span><span class="cm">/* frame length mask */</span><span class="cp"></span>
<span class="cp">#define D64_RX_FRM_STS_OVFL	0x00800000	</span><span class="cm">/* RxOverFlow */</span><span class="cp"></span>
<span class="cp">#define D64_RX_FRM_STS_DSCRCNT	0x0f000000  </span><span class="cm">/* no. of descriptors used - 1 */</span><span class="cp"></span>
<span class="cp">#define D64_RX_FRM_STS_DATATYPE	0xf0000000	</span><span class="cm">/* core-dependent data type */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * packet headroom necessary to accommodate the largest header</span>
<span class="cm"> * in the system, (i.e TXOFF). By doing, we avoid the need to</span>
<span class="cm"> * allocate an extra buffer for the header when bridging to WL.</span>
<span class="cm"> * There is a compile time check in wlc.c which ensure that this</span>
<span class="cm"> * value is at least as big as TXOFF. This value is used in</span>
<span class="cm"> * dma_rxfill().</span>
<span class="cm"> */</span>

<span class="cp">#define BCMEXTRAHDROOM 172</span>

<span class="cm">/* debug/trace */</span>
<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define	DMA_ERROR(fmt, ...)					\</span>
<span class="cp">do {								\</span>
<span class="cp">	if (*di-&gt;msg_level &amp; 1)					\</span>
<span class="cp">		pr_debug(&quot;%s: &quot; fmt, __func__, ##__VA_ARGS__);	\</span>
<span class="cp">} while (0)</span>
<span class="cp">#define	DMA_TRACE(fmt, ...)					\</span>
<span class="cp">do {								\</span>
<span class="cp">	if (*di-&gt;msg_level &amp; 2)					\</span>
<span class="cp">		pr_debug(&quot;%s: &quot; fmt, __func__, ##__VA_ARGS__);	\</span>
<span class="cp">} while (0)</span>
<span class="cp">#else</span>
<span class="cp">#define	DMA_ERROR(fmt, ...)			\</span>
<span class="cp">	no_printk(fmt, ##__VA_ARGS__)</span>
<span class="cp">#define	DMA_TRACE(fmt, ...)			\</span>
<span class="cp">	no_printk(fmt, ##__VA_ARGS__)</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="cp">#define	DMA_NONE(fmt, ...)			\</span>
<span class="cp">	no_printk(fmt, ##__VA_ARGS__)</span>

<span class="cp">#define	MAXNAMEL	8	</span><span class="cm">/* 8 char names */</span><span class="cp"></span>

<span class="cm">/* macros to convert between byte offsets and indexes */</span>
<span class="cp">#define	B2I(bytes, type)	((bytes) / sizeof(type))</span>
<span class="cp">#define	I2B(index, type)	((index) * sizeof(type))</span>

<span class="cp">#define	PCI32ADDR_HIGH		0xc0000000	</span><span class="cm">/* address[31:30] */</span><span class="cp"></span>
<span class="cp">#define	PCI32ADDR_HIGH_SHIFT	30	</span><span class="cm">/* address[31:30] */</span><span class="cp"></span>

<span class="cp">#define	PCI64ADDR_HIGH		0x80000000	</span><span class="cm">/* address[63] */</span><span class="cp"></span>
<span class="cp">#define	PCI64ADDR_HIGH_SHIFT	31	</span><span class="cm">/* address[63] */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * DMA Descriptor</span>
<span class="cm"> * Descriptors are only read by the hardware, never written back.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dma64desc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">ctrl1</span><span class="p">;</span>	<span class="cm">/* misc control bits &amp; bufcount */</span>
	<span class="n">__le32</span> <span class="n">ctrl2</span><span class="p">;</span>	<span class="cm">/* buffer count and address extension */</span>
	<span class="n">__le32</span> <span class="n">addrlow</span><span class="p">;</span>	<span class="cm">/* memory address of the date buffer, bits 31:0 */</span>
	<span class="n">__le32</span> <span class="n">addrhigh</span><span class="p">;</span> <span class="cm">/* memory address of the date buffer, bits 63:32 */</span>
<span class="p">};</span>

<span class="cm">/* dma engine software state */</span>
<span class="k">struct</span> <span class="n">dma_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pub</span> <span class="n">dma</span><span class="p">;</span> <span class="cm">/* exported structure */</span>
	<span class="n">uint</span> <span class="o">*</span><span class="n">msg_level</span><span class="p">;</span>	<span class="cm">/* message level pointer */</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MAXNAMEL</span><span class="p">];</span>	<span class="cm">/* callers name for diag msgs */</span>

	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dmadev</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">dma64</span><span class="p">;</span>	<span class="cm">/* this dma engine is operating in 64-bit mode */</span>
	<span class="n">bool</span> <span class="n">addrext</span><span class="p">;</span>	<span class="cm">/* this dma engine supports DmaExtendedAddrChanges */</span>

	<span class="cm">/* 64-bit dma tx engine registers */</span>
	<span class="n">uint</span> <span class="n">d64txregbase</span><span class="p">;</span>
	<span class="cm">/* 64-bit dma rx engine registers */</span>
	<span class="n">uint</span> <span class="n">d64rxregbase</span><span class="p">;</span>
	<span class="cm">/* pointer to dma64 tx descriptor ring */</span>
	<span class="k">struct</span> <span class="n">dma64desc</span> <span class="o">*</span><span class="n">txd64</span><span class="p">;</span>
	<span class="cm">/* pointer to dma64 rx descriptor ring */</span>
	<span class="k">struct</span> <span class="n">dma64desc</span> <span class="o">*</span><span class="n">rxd64</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">dmadesc_align</span><span class="p">;</span>	<span class="cm">/* alignment requirement for dma descriptors */</span>

	<span class="n">u16</span> <span class="n">ntxd</span><span class="p">;</span>		<span class="cm">/* # tx descriptors tunable */</span>
	<span class="n">u16</span> <span class="n">txin</span><span class="p">;</span>		<span class="cm">/* index of next descriptor to reclaim */</span>
	<span class="n">u16</span> <span class="n">txout</span><span class="p">;</span>		<span class="cm">/* index of next descriptor to post */</span>
	<span class="cm">/* pointer to parallel array of pointers to packets */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">txp</span><span class="p">;</span>
	<span class="cm">/* Aligned physical address of descriptor ring */</span>
	<span class="n">dma_addr_t</span> <span class="n">txdpa</span><span class="p">;</span>
	<span class="cm">/* Original physical address of descriptor ring */</span>
	<span class="n">dma_addr_t</span> <span class="n">txdpaorig</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txdalign</span><span class="p">;</span>	<span class="cm">/* #bytes added to alloc&#39;d mem to align txd */</span>
	<span class="n">u32</span> <span class="n">txdalloc</span><span class="p">;</span>	<span class="cm">/* #bytes allocated for the ring */</span>
	<span class="n">u32</span> <span class="n">xmtptrbase</span><span class="p">;</span>	<span class="cm">/* When using unaligned descriptors, the ptr register</span>
<span class="cm">			 * is not just an index, it needs all 13 bits to be</span>
<span class="cm">			 * an offset from the addr register.</span>
<span class="cm">			 */</span>

	<span class="n">u16</span> <span class="n">nrxd</span><span class="p">;</span>	<span class="cm">/* # rx descriptors tunable */</span>
	<span class="n">u16</span> <span class="n">rxin</span><span class="p">;</span>	<span class="cm">/* index of next descriptor to reclaim */</span>
	<span class="n">u16</span> <span class="n">rxout</span><span class="p">;</span>	<span class="cm">/* index of next descriptor to post */</span>
	<span class="cm">/* pointer to parallel array of pointers to packets */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">rxp</span><span class="p">;</span>
	<span class="cm">/* Aligned physical address of descriptor ring */</span>
	<span class="n">dma_addr_t</span> <span class="n">rxdpa</span><span class="p">;</span>
	<span class="cm">/* Original physical address of descriptor ring */</span>
	<span class="n">dma_addr_t</span> <span class="n">rxdpaorig</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rxdalign</span><span class="p">;</span>	<span class="cm">/* #bytes added to alloc&#39;d mem to align rxd */</span>
	<span class="n">u32</span> <span class="n">rxdalloc</span><span class="p">;</span>	<span class="cm">/* #bytes allocated for the ring */</span>
	<span class="n">u32</span> <span class="n">rcvptrbase</span><span class="p">;</span>	<span class="cm">/* Base for ptr reg when using unaligned descriptors */</span>

	<span class="cm">/* tunables */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rxbufsize</span><span class="p">;</span>	<span class="cm">/* rx buffer size in bytes, not including</span>
<span class="cm">				 * the extra headroom</span>
<span class="cm">				 */</span>
	<span class="n">uint</span> <span class="n">rxextrahdrroom</span><span class="p">;</span>	<span class="cm">/* extra rx headroom, reverseved to assist upper</span>
<span class="cm">				 * stack, e.g. some rx pkt buffers will be</span>
<span class="cm">				 * bridged to tx side without byte copying.</span>
<span class="cm">				 * The extra headroom needs to be large enough</span>
<span class="cm">				 * to fit txheader needs. Some dongle driver may</span>
<span class="cm">				 * not need it.</span>
<span class="cm">				 */</span>
	<span class="n">uint</span> <span class="n">nrxpost</span><span class="p">;</span>		<span class="cm">/* # rx buffers to keep posted */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rxoffset</span><span class="p">;</span>	<span class="cm">/* rxcontrol offset */</span>
	<span class="cm">/* add to get dma address of descriptor ring, low 32 bits */</span>
	<span class="n">uint</span> <span class="n">ddoffsetlow</span><span class="p">;</span>
	<span class="cm">/*   high 32 bits */</span>
	<span class="n">uint</span> <span class="n">ddoffsethigh</span><span class="p">;</span>
	<span class="cm">/* add to get dma address of data buffer, low 32 bits */</span>
	<span class="n">uint</span> <span class="n">dataoffsetlow</span><span class="p">;</span>
	<span class="cm">/*   high 32 bits */</span>
	<span class="n">uint</span> <span class="n">dataoffsethigh</span><span class="p">;</span>
	<span class="cm">/* descriptor base need to be aligned or not */</span>
	<span class="n">bool</span> <span class="n">aligndesc_4k</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * default dma message level (if input msg_level</span>
<span class="cm"> * pointer is null in dma_attach())</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">dma_msg_level</span><span class="p">;</span>

<span class="cm">/* Check for odd number of 1&#39;s */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">parity32</span><span class="p">(</span><span class="n">__le32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* no swap needed for counting 1&#39;s */</span>
	<span class="n">u32</span> <span class="n">par_data</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">par_data</span> <span class="o">^=</span> <span class="n">par_data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">par_data</span> <span class="o">^=</span> <span class="n">par_data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">par_data</span> <span class="o">^=</span> <span class="n">par_data</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">par_data</span> <span class="o">^=</span> <span class="n">par_data</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">par_data</span> <span class="o">^=</span> <span class="n">par_data</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">par_data</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">dma64_dd_parity</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma64desc</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">parity32</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">addrlow</span> <span class="o">^</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">addrhigh</span> <span class="o">^</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">^</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">ctrl2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* descriptor bumping functions */</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">xxd</span><span class="p">(</span><span class="n">uint</span> <span class="n">x</span><span class="p">,</span> <span class="n">uint</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* faster than %, but n must be power of 2 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">txd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">uint</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xxd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">rxd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">uint</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xxd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">nrxd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">nexttxd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">uint</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">txd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">prevtxd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">uint</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">txd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">nextrxd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">uint</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">txd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">ntxdactive</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">uint</span> <span class="n">h</span><span class="p">,</span> <span class="n">uint</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">txd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">t</span><span class="o">-</span><span class="n">h</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">nrxdactive</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">uint</span> <span class="n">h</span><span class="p">,</span> <span class="n">uint</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rxd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">t</span><span class="o">-</span><span class="n">h</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">_dma_ctrlflags</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">uint</span> <span class="n">mask</span><span class="p">,</span> <span class="n">uint</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">dmactrlflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMA_ERROR</span><span class="p">(</span><span class="s">&quot;NULL dma handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dmactrlflags</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dmactrlflags</span><span class="p">;</span>
	<span class="n">dmactrlflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">dmactrlflags</span> <span class="o">|=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* If trying to enable parity, check if parity is actually supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmactrlflags</span> <span class="o">&amp;</span> <span class="n">DMA_CTRL_PEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

		<span class="n">control</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">));</span>
		<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">),</span>
		      <span class="n">control</span> <span class="o">|</span> <span class="n">D64_XC_PD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">))</span> <span class="o">&amp;</span>
		    <span class="n">D64_XC_PD</span><span class="p">)</span>
			<span class="cm">/* We *can* disable it so it is supported,</span>
<span class="cm">			 * restore control register</span>
<span class="cm">			 */</span>
			<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">),</span>
				     <span class="n">control</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* Not supported, don&#39;t allow it to be enabled */</span>
			<span class="n">dmactrlflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_CTRL_PEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dmactrlflags</span> <span class="o">=</span> <span class="n">dmactrlflags</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dmactrlflags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_dma64_addrext</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">uint</span> <span class="n">ctrl_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">bcma_set32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">ctrl_offset</span><span class="p">,</span> <span class="n">D64_XC_AE</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">ctrl_offset</span><span class="p">);</span>
	<span class="n">bcma_mask32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">ctrl_offset</span><span class="p">,</span> <span class="o">~</span><span class="n">D64_XC_AE</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">D64_XC_AE</span><span class="p">)</span> <span class="o">==</span> <span class="n">D64_XC_AE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return true if this dma engine supports DmaExtendedAddrChanges,</span>
<span class="cm"> * otherwise false</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">_dma_isaddrext</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* DMA64 supports full 32- or 64-bit operation. AE is always valid */</span>

	<span class="cm">/* not all tx or rx channel are available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d64txregbase</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_dma64_addrext</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">)))</span>
			<span class="n">DMA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: DMA64 tx doesn&#39;t have AE set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d64rxregbase</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_dma64_addrext</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">)))</span>
			<span class="n">DMA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: DMA64 rx doesn&#39;t have AE set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_dma_descriptor_align</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addrl</span><span class="p">;</span>

	<span class="cm">/* Check to see if the descriptors need to be aligned on 4K/8K or not */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d64txregbase</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">addrlow</span><span class="p">),</span> <span class="mh">0xff0</span><span class="p">);</span>
		<span class="n">addrl</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">addrlow</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addrl</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">d64rxregbase</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">addrlow</span><span class="p">),</span> <span class="mh">0xff0</span><span class="p">);</span>
		<span class="n">addrl</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">addrlow</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addrl</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Descriptor table must start at the DMA hardware dictated alignment, so</span>
<span class="cm"> * allocated memory must be large enough to support this requirement.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">dma_alloc_consistent</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">uint</span> <span class="n">size</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">align_bits</span><span class="p">,</span> <span class="n">uint</span> <span class="o">*</span><span class="n">alloced</span><span class="p">,</span>
				  <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">pap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">align_bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">align</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">align_bits</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">align</span><span class="p">))</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">align</span><span class="p">;</span>
		<span class="o">*</span><span class="n">alloced</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pap</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="n">u8</span> <span class="nf">dma_align_sizetobits</span><span class="p">(</span><span class="n">uint</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">bitpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">bitpos</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bitpos</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function ensures that the DMA descriptor ring will not get allocated</span>
<span class="cm"> * across Page boundary. If the allocation is done across the page boundary</span>
<span class="cm"> * at the first time, then it is freed and the allocation is done at</span>
<span class="cm"> * descriptor ring size aligned location. This will ensure that the ring will</span>
<span class="cm"> * not cross page boundary</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">dma_ringalloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">u32</span> <span class="n">boundary</span><span class="p">,</span> <span class="n">uint</span> <span class="n">size</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="o">*</span><span class="n">alignbits</span><span class="p">,</span> <span class="n">uint</span> <span class="o">*</span><span class="n">alloced</span><span class="p">,</span>
			   <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">descpa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">desc_strtaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">alignbytes</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">alignbits</span><span class="p">;</span>

	<span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_consistent</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">*</span><span class="n">alignbits</span><span class="p">,</span> <span class="n">alloced</span><span class="p">,</span> <span class="n">descpa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">va</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">desc_strtaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">roundup</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">va</span><span class="p">,</span> <span class="n">alignbytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">desc_strtaddr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">boundary</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">desc_strtaddr</span>
							<span class="o">&amp;</span> <span class="n">boundary</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">alignbits</span> <span class="o">=</span> <span class="n">dma_align_sizetobits</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">*</span><span class="n">descpa</span><span class="p">);</span>
		<span class="n">va</span> <span class="o">=</span> <span class="n">dma_alloc_consistent</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">*</span><span class="n">alignbits</span><span class="p">,</span>
			<span class="n">alloced</span><span class="p">,</span> <span class="n">descpa</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">va</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">dma64_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">uint</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">ddlen</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">alloced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">align</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">align_bits</span><span class="p">;</span>

	<span class="n">ddlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma64desc</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_TX</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span> <span class="o">*</span> <span class="n">ddlen</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">nrxd</span> <span class="o">*</span> <span class="n">ddlen</span><span class="p">);</span>
	<span class="n">align_bits</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadesc_align</span><span class="p">;</span>
	<span class="n">align</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">align_bits</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">va</span> <span class="o">=</span> <span class="n">dma_ringalloc</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">D64RINGALIGN</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">align_bits</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">alloced</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txdpaorig</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: DMA_ALLOC_CONSISTENT(ntxd) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">align</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">align_bits</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">txd64</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma64desc</span> <span class="o">*</span><span class="p">)</span>
					<span class="n">roundup</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">va</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">txdalign</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="p">((</span><span class="n">s8</span> <span class="o">*</span><span class="p">)</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txd64</span> <span class="o">-</span> <span class="p">(</span><span class="n">s8</span> <span class="o">*</span><span class="p">)</span> <span class="n">va</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">txdpa</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txdpaorig</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txdalign</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">txdalloc</span> <span class="o">=</span> <span class="n">alloced</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">va</span> <span class="o">=</span> <span class="n">dma_ringalloc</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">D64RINGALIGN</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">align_bits</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">alloced</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxdpaorig</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: DMA_ALLOC_CONSISTENT(nrxd) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">align</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">align_bits</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxd64</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma64desc</span> <span class="o">*</span><span class="p">)</span>
					<span class="n">roundup</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">va</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxdalign</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="p">((</span><span class="n">s8</span> <span class="o">*</span><span class="p">)</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxd64</span> <span class="o">-</span> <span class="p">(</span><span class="n">s8</span> <span class="o">*</span><span class="p">)</span> <span class="n">va</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxdpa</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxdpaorig</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxdalign</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxdalloc</span> <span class="o">=</span> <span class="n">alloced</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_dma_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">uint</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dma64_alloc</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="nf">dma_attach</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">si_pub</span> <span class="o">*</span><span class="n">sih</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span>
			   <span class="n">uint</span> <span class="n">txregbase</span><span class="p">,</span> <span class="n">uint</span> <span class="n">rxregbase</span><span class="p">,</span> <span class="n">uint</span> <span class="n">ntxd</span><span class="p">,</span> <span class="n">uint</span> <span class="n">nrxd</span><span class="p">,</span>
			   <span class="n">uint</span> <span class="n">rxbufsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rxextheadroom</span><span class="p">,</span>
			   <span class="n">uint</span> <span class="n">nrxpost</span><span class="p">,</span> <span class="n">uint</span> <span class="n">rxoffset</span><span class="p">,</span> <span class="n">uint</span> <span class="o">*</span><span class="n">msg_level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">rev</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* allocate private info structure */</span>
	<span class="n">di</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">msg_level</span> <span class="o">=</span> <span class="n">msg_level</span> <span class="o">?</span> <span class="n">msg_level</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">dma_msg_level</span><span class="p">;</span>


	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dma64</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">bcma_aread32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">BCMA_IOST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SISF_DMA64</span><span class="p">)</span> <span class="o">==</span> <span class="n">SISF_DMA64</span><span class="p">);</span>

	<span class="cm">/* init dma reg info */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span> <span class="o">=</span> <span class="n">core</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">d64txregbase</span> <span class="o">=</span> <span class="n">txregbase</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">d64rxregbase</span> <span class="o">=</span> <span class="n">rxregbase</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Default flags (which can be changed by the driver calling</span>
<span class="cm">	 * dma_ctrlflags before enable): For backwards compatibility</span>
<span class="cm">	 * both Rx Overflow Continue and Parity are DISABLED.</span>
<span class="cm">	 */</span>
	<span class="n">_dma_ctrlflags</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">DMA_CTRL_ROC</span> <span class="o">|</span> <span class="n">DMA_CTRL_PEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s: %s flags 0x%x ntxd %d nrxd %d &quot;</span>
		  <span class="s">&quot;rxbufsize %d rxextheadroom %d nrxpost %d rxoffset %d &quot;</span>
		  <span class="s">&quot;txregbase %u rxregbase %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;DMA64&quot;</span><span class="p">,</span>
		  <span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dmactrlflags</span><span class="p">,</span> <span class="n">ntxd</span><span class="p">,</span> <span class="n">nrxd</span><span class="p">,</span> <span class="n">rxbufsize</span><span class="p">,</span>
		  <span class="n">rxextheadroom</span><span class="p">,</span> <span class="n">nrxpost</span><span class="p">,</span> <span class="n">rxoffset</span><span class="p">,</span> <span class="n">txregbase</span><span class="p">,</span> <span class="n">rxregbase</span><span class="p">);</span>

	<span class="cm">/* make a private copy of our callers name */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">MAXNAMEL</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">MAXNAMEL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadev</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">;</span>

	<span class="cm">/* save tunables */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">ntxd</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">nrxd</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">nrxd</span><span class="p">;</span>

	<span class="cm">/* the actual dma size doesn&#39;t include the extra headroom */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxextrahdrroom</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">rxextheadroom</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">BCMEXTRAHDROOM</span> <span class="o">:</span> <span class="n">rxextheadroom</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxbufsize</span> <span class="o">&gt;</span> <span class="n">BCMEXTRAHDROOM</span><span class="p">)</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxbufsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">rxbufsize</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxextrahdrroom</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxbufsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">rxbufsize</span><span class="p">;</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">nrxpost</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">nrxpost</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxoffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">rxoffset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * figure out the DMA physical address offset for dd and data</span>
<span class="cm">	 *     PCI/PCIE: they map silicon backplace address to zero</span>
<span class="cm">	 *     based memory, need offset</span>
<span class="cm">	 *     Other bus: use zero SI_BUS BIGENDIAN kludge: use sdram</span>
<span class="cm">	 *     swapped region for data buffer, not descriptor</span>
<span class="cm">	 */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsetlow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dataoffsetlow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* add offset for pcie with DMA64 bus */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsetlow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsethigh</span> <span class="o">=</span> <span class="n">SI_PCIE_DMA_H32</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dataoffsetlow</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsetlow</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dataoffsethigh</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsethigh</span><span class="p">;</span>
	<span class="cm">/* WAR64450 : DMACtl.Addr ext fields are not supported in SDIOD core. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">SDIOD_CORE_ID</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)))</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">addrext</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">I2S_CORE_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">((</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">addrext</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">addrext</span> <span class="o">=</span> <span class="n">_dma_isaddrext</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="cm">/* does the descriptor need to be aligned and if yes, on 4K/8K or not */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">aligndesc_4k</span> <span class="o">=</span> <span class="n">_dma_descriptor_align</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">aligndesc_4k</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadesc_align</span> <span class="o">=</span> <span class="n">D64RINGALIGN_BITS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ntxd</span> <span class="o">&lt;</span> <span class="n">D64MAXDD</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nrxd</span> <span class="o">&lt;</span> <span class="n">D64MAXDD</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
			<span class="cm">/* for smaller dd table, HW relax alignment reqmnt */</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadesc_align</span> <span class="o">=</span> <span class="n">D64RINGALIGN_BITS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadesc_align</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* 16 byte alignment */</span>
	<span class="p">}</span>

	<span class="n">DMA_NONE</span><span class="p">(</span><span class="s">&quot;DMA descriptor align_needed %d, align %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">di</span><span class="o">-&gt;</span><span class="n">aligndesc_4k</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadesc_align</span><span class="p">);</span>

	<span class="cm">/* allocate tx packet pointer vector */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntxd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ntxd</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">txp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate rx packet pointer vector */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nrxd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">nrxd</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate transmit descriptor ring, only need ntxd descriptors</span>
<span class="cm">	 * but it must be aligned</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntxd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_dma_alloc</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">DMA_TX</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate receive descriptor ring, only need nrxd descriptors</span>
<span class="cm">	 * but it must be aligned</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nrxd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_dma_alloc</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">DMA_RX</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsetlow</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">addrext</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txdpa</span> <span class="o">&gt;</span> <span class="n">SI_PCI_DMA_SZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: txdpa 0x%x: addrext not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txdpa</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxdpa</span> <span class="o">&gt;</span> <span class="n">SI_PCI_DMA_SZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: rxdpa 0x%x: addrext not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxdpa</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;ddoffsetlow 0x%x ddoffsethigh 0x%x dataoffsetlow 0x%x dataoffsethigh 0x%x addrext %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsetlow</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsethigh</span><span class="p">,</span>
		  <span class="n">di</span><span class="o">-&gt;</span><span class="n">dataoffsetlow</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">dataoffsethigh</span><span class="p">,</span>
		  <span class="n">di</span><span class="o">-&gt;</span><span class="n">addrext</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="p">)</span> <span class="n">di</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">dma_detach</span><span class="p">((</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="p">)</span><span class="n">di</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">dma64_dd_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma64desc</span> <span class="o">*</span><span class="n">ddring</span><span class="p">,</span>
	     <span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">,</span> <span class="n">uint</span> <span class="n">outidx</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bufcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl2</span> <span class="o">=</span> <span class="n">bufcount</span> <span class="o">&amp;</span> <span class="n">D64_CTRL2_BC_MASK</span><span class="p">;</span>

	<span class="cm">/* PCI bus with big(&gt;1G) physical address, use address extension */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dataoffsetlow</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="n">PCI32ADDR_HIGH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ddring</span><span class="p">[</span><span class="n">outidx</span><span class="p">].</span><span class="n">addrlow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pa</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">dataoffsetlow</span><span class="p">);</span>
		<span class="n">ddring</span><span class="p">[</span><span class="n">outidx</span><span class="p">].</span><span class="n">addrhigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dataoffsethigh</span><span class="p">);</span>
		<span class="n">ddring</span><span class="p">[</span><span class="n">outidx</span><span class="p">].</span><span class="n">ctrl1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ddring</span><span class="p">[</span><span class="n">outidx</span><span class="p">].</span><span class="n">ctrl2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ctrl2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* address extension for 32-bit PCI */</span>
		<span class="n">u32</span> <span class="n">ae</span><span class="p">;</span>

		<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="n">PCI32ADDR_HIGH</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PCI32ADDR_HIGH_SHIFT</span><span class="p">;</span>
		<span class="n">pa</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI32ADDR_HIGH</span><span class="p">;</span>

		<span class="n">ctrl2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ae</span> <span class="o">&lt;&lt;</span> <span class="n">D64_CTRL2_AE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">D64_CTRL2_AE</span><span class="p">;</span>
		<span class="n">ddring</span><span class="p">[</span><span class="n">outidx</span><span class="p">].</span><span class="n">addrlow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pa</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">dataoffsetlow</span><span class="p">);</span>
		<span class="n">ddring</span><span class="p">[</span><span class="n">outidx</span><span class="p">].</span><span class="n">addrhigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dataoffsethigh</span><span class="p">);</span>
		<span class="n">ddring</span><span class="p">[</span><span class="n">outidx</span><span class="p">].</span><span class="n">ctrl1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ddring</span><span class="p">[</span><span class="n">outidx</span><span class="p">].</span><span class="n">ctrl2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ctrl2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dmactrlflags</span> <span class="o">&amp;</span> <span class="n">DMA_CTRL_PEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma64_dd_parity</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddring</span><span class="p">[</span><span class="n">outidx</span><span class="p">]))</span>
			<span class="n">ddring</span><span class="p">[</span><span class="n">outidx</span><span class="p">].</span><span class="n">ctrl2</span> <span class="o">=</span>
			     <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ctrl2</span> <span class="o">|</span> <span class="n">D64_CTRL2_PARITY</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* !! may be called with core in reset */</span>
<span class="kt">void</span> <span class="nf">dma_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>

	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* free dma descriptor rings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txd64</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadev</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txdalloc</span><span class="p">,</span>
				  <span class="p">((</span><span class="n">s8</span> <span class="o">*</span><span class="p">)</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txd64</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txdalign</span><span class="p">),</span>
				  <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txdpaorig</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxd64</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadev</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxdalloc</span><span class="p">,</span>
				  <span class="p">((</span><span class="n">s8</span> <span class="o">*</span><span class="p">)</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxd64</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxdalign</span><span class="p">),</span>
				  <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxdpaorig</span><span class="p">));</span>

	<span class="cm">/* free packet pointer vectors */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxp</span><span class="p">);</span>

	<span class="cm">/* free our private info structure */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* initialize descriptor table base address */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_dma_ddtable_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">uint</span> <span class="n">direction</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">aligndesc_4k</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_TX</span><span class="p">)</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">xmtptrbase</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">rcvptrbase</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsetlow</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="n">PCI32ADDR_HIGH</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_TX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">addrlow</span><span class="p">),</span>
				     <span class="n">pa</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsetlow</span><span class="p">);</span>
			<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">addrhigh</span><span class="p">),</span>
				     <span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsethigh</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">addrlow</span><span class="p">),</span>
				     <span class="n">pa</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsetlow</span><span class="p">);</span>
			<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">addrhigh</span><span class="p">),</span>
				     <span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsethigh</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* DMA64 32bits address extension */</span>
		<span class="n">u32</span> <span class="n">ae</span><span class="p">;</span>

		<span class="cm">/* shift the high bit(s) from pa to ae */</span>
		<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="n">PCI32ADDR_HIGH</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PCI32ADDR_HIGH_SHIFT</span><span class="p">;</span>
		<span class="n">pa</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI32ADDR_HIGH</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_TX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">addrlow</span><span class="p">),</span>
				     <span class="n">pa</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsetlow</span><span class="p">);</span>
			<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">addrhigh</span><span class="p">),</span>
				     <span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsethigh</span><span class="p">);</span>
			<span class="n">bcma_maskset32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">),</span>
				       <span class="n">D64_XC_AE</span><span class="p">,</span> <span class="p">(</span><span class="n">ae</span> <span class="o">&lt;&lt;</span> <span class="n">D64_XC_AE_SHIFT</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">addrlow</span><span class="p">),</span>
				     <span class="n">pa</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsetlow</span><span class="p">);</span>
			<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">addrhigh</span><span class="p">),</span>
				     <span class="n">di</span><span class="o">-&gt;</span><span class="n">ddoffsethigh</span><span class="p">);</span>
			<span class="n">bcma_maskset32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">),</span>
				       <span class="n">D64_RC_AE</span><span class="p">,</span> <span class="p">(</span><span class="n">ae</span> <span class="o">&lt;&lt;</span> <span class="n">D64_RC_AE_SHIFT</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dma_rxenable</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">dmactrlflags</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dmactrlflags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">D64_RC_RE</span> <span class="o">|</span> <span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
					   <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">))</span> <span class="o">&amp;</span>
			       <span class="n">D64_RC_AE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dmactrlflags</span> <span class="o">&amp;</span> <span class="n">DMA_CTRL_PEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">D64_RC_PD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmactrlflags</span> <span class="o">&amp;</span> <span class="n">DMA_CTRL_ROC</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">D64_RC_OC</span><span class="p">;</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">),</span>
		<span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxoffset</span> <span class="o">&lt;&lt;</span> <span class="n">D64_RC_RO_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">control</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dma_rxinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>

	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">nrxd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxin</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* clear rx descriptor ring */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxd64</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">nrxd</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma64desc</span><span class="p">));</span>

	<span class="cm">/* DMA engine with out alignment requirement requires table to be inited</span>
<span class="cm">	 * before enabling the engine</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">aligndesc_4k</span><span class="p">)</span>
		<span class="n">_dma_ddtable_init</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">DMA_RX</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxdpa</span><span class="p">);</span>

	<span class="n">_dma_rxenable</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">aligndesc_4k</span><span class="p">)</span>
		<span class="n">_dma_ddtable_init</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">DMA_RX</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxdpa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">dma64_getnextrxp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">bool</span> <span class="n">forceall</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">,</span> <span class="n">curr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rxp</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxin</span><span class="p">;</span>

	<span class="cm">/* return if no packets posted */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxout</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">curr</span> <span class="o">=</span>
	    <span class="n">B2I</span><span class="p">(((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
			      <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">status0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">D64_RS0_CD_MASK</span><span class="p">)</span> <span class="o">-</span>
		 <span class="n">di</span><span class="o">-&gt;</span><span class="n">rcvptrbase</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">D64_RS0_CD_MASK</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma64desc</span><span class="p">);</span>

	<span class="cm">/* ignore curr if forceall */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">forceall</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">curr</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* get the packet pointer that corresponds to the rx descriptor */</span>
	<span class="n">rxp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pa</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxd64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addrlow</span><span class="p">)</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">dataoffsetlow</span><span class="p">;</span>

	<span class="cm">/* clear this packet from the descriptor ring */</span>
	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadev</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxbufsize</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxd64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addrlow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxd64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addrhigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxin</span> <span class="o">=</span> <span class="n">nextrxd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rxp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">_dma_getnextrxp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">bool</span> <span class="n">forceall</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">nrxd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dma64_getnextrxp</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">forceall</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * !! rx entry routine</span>
<span class="cm"> * returns the number packages in the next frame, or 0 if there are no more</span>
<span class="cm"> *   if DMA_CTRL_RXMULTI is defined, DMA scattering(multiple buffers) is</span>
<span class="cm"> *   supported with pkts chain</span>
<span class="cm"> *   otherwise, it&#39;s treated as giant pkt and will be tossed.</span>
<span class="cm"> *   The DMA scattering starts with normal DMA header, followed by first</span>
<span class="cm"> *   buffer data. After it reaches the max size of buffer, the data continues</span>
<span class="cm"> *   in next DMA descriptor buffer WITHOUT DMA header</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dma_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">skb_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">dma_frames</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">pkt_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pktcnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_frames</span><span class="p">);</span>
 <span class="nl">next_frame:</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">_dma_getnextrxp</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s: dma_rx len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">dma_spin_for_len</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="cm">/* set actual length */</span>
	<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxoffset</span> <span class="o">+</span> <span class="n">len</span><span class="p">),</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxbufsize</span><span class="p">);</span>
	<span class="n">__skb_trim</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_frames</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">resid</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxbufsize</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxoffset</span><span class="p">);</span>

	<span class="cm">/* check for single or multi-buffer rx */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">resid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">_dma_getnextrxp</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">uint</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxbufsize</span><span class="p">);</span>
			<span class="n">__skb_trim</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_frames</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="n">resid</span> <span class="o">-=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxbufsize</span><span class="p">;</span>
			<span class="n">pktcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uint</span> <span class="n">cur</span><span class="p">;</span>
			<span class="n">cur</span> <span class="o">=</span>
			    <span class="n">B2I</span><span class="p">(((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
					      <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">status0</span><span class="p">))</span> <span class="o">&amp;</span>
				  <span class="n">D64_RS0_CD_MASK</span><span class="p">)</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rcvptrbase</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">D64_RS0_CD_MASK</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma64desc</span><span class="p">);</span>
			<span class="n">DMA_ERROR</span><span class="p">(</span><span class="s">&quot;rxin %d rxout %d, hw_curr %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxin</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxout</span><span class="p">,</span> <span class="n">cur</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

		<span class="k">if</span> <span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dmactrlflags</span> <span class="o">&amp;</span> <span class="n">DMA_CTRL_RXMULTI</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: bad frame length (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">skb_queue_walk_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_frames</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_unlink</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_frames</span><span class="p">);</span>
				<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">rxgiants</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pktcnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">next_frame</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">skb_queue_splice_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_frames</span><span class="p">,</span> <span class="n">skb_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pktcnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">dma64_rxidle</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">nrxd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
			     <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">status0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">D64_RS0_CD_MASK</span><span class="p">)</span> <span class="o">==</span>
		<span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">ptr</span><span class="p">))</span> <span class="o">&amp;</span>
		 <span class="n">D64_RS0_CD_MASK</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * post receive buffers</span>
<span class="cm"> *  return false is refill failed completely and ring is empty this will stall</span>
<span class="cm"> *  the rx dma and user might want to call rxfill again asap. This unlikely</span>
<span class="cm"> *  happens on memory-rich NIC, but often on memory-constrained dongle</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">dma_rxfill</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rxin</span><span class="p">,</span> <span class="n">rxout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">extra_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ring_empty</span><span class="p">;</span>

	<span class="n">ring_empty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine how many receive buffers we&#39;re lacking</span>
<span class="cm">	 * from the full complement, allocate, initialize,</span>
<span class="cm">	 * and post them, then update the chip rx lastdscr.</span>
<span class="cm">	 */</span>

	<span class="n">rxin</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxin</span><span class="p">;</span>
	<span class="n">rxout</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxout</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">nrxpost</span> <span class="o">-</span> <span class="n">nrxdactive</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">rxin</span><span class="p">,</span> <span class="n">rxout</span><span class="p">);</span>

	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s: post %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxbufsize</span> <span class="o">&gt;</span> <span class="n">BCMEXTRAHDROOM</span><span class="p">)</span>
		<span class="n">extra_offset</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxextrahdrroom</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * the di-&gt;rxbufsize doesn&#39;t include the extra headroom,</span>
<span class="cm">		 * we need to add it to the size to be allocated</span>
<span class="cm">		 */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">brcmu_pkt_buf_get_skb</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rxbufsize</span> <span class="o">+</span> <span class="n">extra_offset</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: out of rxbufs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dma64_rxidle</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DMA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: ring is empty !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">ring_empty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">rxnobuf</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* reserve an extra headroom, if applicable */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">extra_offset</span><span class="p">)</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">extra_offset</span><span class="p">);</span>

		<span class="cm">/* Do a cached write instead of uncached write since DMA_MAP</span>
<span class="cm">		 * will flush the cache.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pa</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxbufsize</span><span class="p">,</span>
				    <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

		<span class="cm">/* save the free packet pointer */</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxp</span><span class="p">[</span><span class="n">rxout</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

		<span class="cm">/* reset flags for each descriptor */</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxout</span> <span class="o">==</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">nrxd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="n">D64_CTRL1_EOT</span><span class="p">;</span>

		<span class="n">dma64_dd_upd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxd64</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">rxout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span>
			     <span class="n">di</span><span class="o">-&gt;</span><span class="n">rxbufsize</span><span class="p">);</span>
		<span class="n">rxout</span> <span class="o">=</span> <span class="n">nextrxd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">rxout</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">rxout</span> <span class="o">=</span> <span class="n">rxout</span><span class="p">;</span>

	<span class="cm">/* update the chip lastdscr pointer */</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">ptr</span><span class="p">),</span>
	      <span class="n">di</span><span class="o">-&gt;</span><span class="n">rcvptrbase</span> <span class="o">+</span> <span class="n">I2B</span><span class="p">(</span><span class="n">rxout</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma64desc</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ring_empty</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dma_rxreclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">_dma_getnextrxp</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">)))</span>
		<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dma_counterreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset all software counters */</span>
	<span class="n">pub</span><span class="o">-&gt;</span><span class="n">rxgiants</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pub</span><span class="o">-&gt;</span><span class="n">rxnobuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pub</span><span class="o">-&gt;</span><span class="n">txnobuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* get the address of the var in order to change later */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dma_getvar</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;&amp;txavail&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">txavail</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 64-bit DMA functions */</span>

<span class="kt">void</span> <span class="nf">dma_txinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span> <span class="o">=</span> <span class="n">D64_XC_XE</span><span class="p">;</span>

	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">txin</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">txavail</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* clear tx descriptor ring */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txd64</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma64desc</span><span class="p">)));</span>

	<span class="cm">/* DMA engine with out alignment requirement requires table to be inited</span>
<span class="cm">	 * before enabling the engine</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">aligndesc_4k</span><span class="p">)</span>
		<span class="n">_dma_ddtable_init</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">DMA_TX</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txdpa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dmactrlflags</span> <span class="o">&amp;</span> <span class="n">DMA_CTRL_PEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">D64_XC_PD</span><span class="p">;</span>
	<span class="n">bcma_set32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">),</span> <span class="n">control</span><span class="p">);</span>

	<span class="cm">/* DMA engine with alignment requirement requires table to be inited</span>
<span class="cm">	 * before enabling the engine</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">aligndesc_4k</span><span class="p">)</span>
		<span class="n">_dma_ddtable_init</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">DMA_TX</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txdpa</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dma_txsuspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>

	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bcma_set32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">),</span> <span class="n">D64_XC_SE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dma_txresume</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>

	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bcma_mask32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">),</span> <span class="o">~</span><span class="n">D64_XC_SE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">dma_txsuspended</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
			     <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">D64_XC_SE</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">D64_XC_SE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dma_txreclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">,</span> <span class="k">enum</span> <span class="n">txd_range</span> <span class="n">range</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		  <span class="n">range</span> <span class="o">==</span> <span class="n">DMA_RANGE_ALL</span> <span class="o">?</span> <span class="s">&quot;all&quot;</span> <span class="o">:</span>
		  <span class="n">range</span> <span class="o">==</span> <span class="n">DMA_RANGE_TRANSMITTED</span> <span class="o">?</span> <span class="s">&quot;transmitted&quot;</span> <span class="o">:</span>
		  <span class="s">&quot;transferred&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txin</span> <span class="o">==</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txout</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">dma_getnexttxp</span><span class="p">(</span><span class="n">pub</span><span class="p">,</span> <span class="n">range</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* For unframed data, we don&#39;t have any packets to free */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dmactrlflags</span> <span class="o">&amp;</span> <span class="n">DMA_CTRL_UNFRAMED</span><span class="p">))</span>
			<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">dma_txreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* suspend tx DMA first */</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">),</span> <span class="n">D64_XC_SE</span><span class="p">);</span>
	<span class="n">SPINWAIT</span><span class="p">(((</span><span class="n">status</span> <span class="o">=</span>
		   <span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">status0</span><span class="p">))</span> <span class="o">&amp;</span>
		    <span class="n">D64_XS0_XS_MASK</span><span class="p">))</span> <span class="o">!=</span> <span class="n">D64_XS0_XS_DISABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">D64_XS0_XS_IDLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">D64_XS0_XS_STOPPED</span><span class="p">),</span>
		 <span class="mi">10000</span><span class="p">);</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SPINWAIT</span><span class="p">(((</span><span class="n">status</span> <span class="o">=</span>
		   <span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">status0</span><span class="p">))</span> <span class="o">&amp;</span>
		    <span class="n">D64_XS0_XS_MASK</span><span class="p">))</span> <span class="o">!=</span> <span class="n">D64_XS0_XS_DISABLED</span><span class="p">),</span> <span class="mi">10000</span><span class="p">);</span>

	<span class="cm">/* wait for the last transaction to complete */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span> <span class="o">==</span> <span class="n">D64_XS0_XS_DISABLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">dma_rxreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">nrxd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">control</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SPINWAIT</span><span class="p">(((</span><span class="n">status</span> <span class="o">=</span>
		   <span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64RXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">status0</span><span class="p">))</span> <span class="o">&amp;</span>
		    <span class="n">D64_RS0_RS_MASK</span><span class="p">))</span> <span class="o">!=</span> <span class="n">D64_RS0_RS_DISABLED</span><span class="p">),</span> <span class="mi">10000</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span> <span class="o">==</span> <span class="n">D64_RS0_RS_DISABLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * !! tx entry routine</span>
<span class="cm"> * WARNING: call must check the return value for error.</span>
<span class="cm"> *   the error(toss frames) could be fatal and cause many subsequent hard</span>
<span class="cm"> *   to debug problems</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dma_txfast</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">bool</span> <span class="n">commit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>

	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">txout</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txout</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * obtain and initialize transmit descriptor entry.</span>
<span class="cm">	 */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* no use to transmit a zero length packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* return nonzero if out of tx descriptors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nexttxd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">txout</span><span class="p">)</span> <span class="o">==</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txin</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">outoftxd</span><span class="p">;</span>

	<span class="cm">/* get physical address of buffer start */</span>
	<span class="n">pa</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="cm">/* With a DMA segment list, Descriptor table is filled</span>
<span class="cm">	 * using the segment list instead of looping over</span>
<span class="cm">	 * buffers in multi-chain DMA. Therefore, EOF for SGLIST</span>
<span class="cm">	 * is when end of segment list is reached.</span>
<span class="cm">	 */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">D64_CTRL1_SOF</span> <span class="o">|</span> <span class="n">D64_CTRL1_IOC</span> <span class="o">|</span> <span class="n">D64_CTRL1_EOF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txout</span> <span class="o">==</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">D64_CTRL1_EOT</span><span class="p">;</span>

	<span class="n">dma64_dd_upd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txd64</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">txout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">txout</span> <span class="o">=</span> <span class="n">nexttxd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">txout</span><span class="p">);</span>

	<span class="cm">/* save the packet */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">txp</span><span class="p">[</span><span class="n">prevtxd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">txout</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="cm">/* bump the tx descriptor index */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">txout</span> <span class="o">=</span> <span class="n">txout</span><span class="p">;</span>

	<span class="cm">/* kick the chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">commit</span><span class="p">)</span>
		<span class="n">bcma_write32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">ptr</span><span class="p">),</span>
		      <span class="n">di</span><span class="o">-&gt;</span><span class="n">xmtptrbase</span> <span class="o">+</span> <span class="n">I2B</span><span class="p">(</span><span class="n">txout</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma64desc</span><span class="p">));</span>

	<span class="cm">/* tx flow control */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">txavail</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span> <span class="o">-</span> <span class="n">ntxdactive</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txin</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txout</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">outoftxd:</span>
	<span class="n">DMA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: out of txds !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">txavail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">txnobuf</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reclaim next completed txd (txds if using chained buffers) in the range</span>
<span class="cm"> * specified and return associated packet.</span>
<span class="cm"> * If range is DMA_RANGE_TRANSMITTED, reclaim descriptors that have be</span>
<span class="cm"> * transmitted as noted by the hardware &quot;CurrDescr&quot; pointer.</span>
<span class="cm"> * If range is DMA_RANGE_TRANSFERED, reclaim descriptors that have be</span>
<span class="cm"> * transferred by the DMA as noted by the hardware &quot;ActiveDescr&quot; pointer.</span>
<span class="cm"> * If range is DMA_RANGE_ALL, reclaim all txd(s) posted to the ring and</span>
<span class="cm"> * return associated packet regardless of the value of hardware pointers.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">dma_getnexttxp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">,</span> <span class="k">enum</span> <span class="n">txd_range</span> <span class="n">range</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span><span class="n">pub</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">active_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">txp</span><span class="p">;</span>

	<span class="n">DMA_TRACE</span><span class="p">(</span><span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">di</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		  <span class="n">range</span> <span class="o">==</span> <span class="n">DMA_RANGE_ALL</span> <span class="o">?</span> <span class="s">&quot;all&quot;</span> <span class="o">:</span>
		  <span class="n">range</span> <span class="o">==</span> <span class="n">DMA_RANGE_TRANSMITTED</span> <span class="o">?</span> <span class="s">&quot;transmitted&quot;</span> <span class="o">:</span>
		  <span class="s">&quot;transferred&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">txp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txin</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">range</span> <span class="o">==</span> <span class="n">DMA_RANGE_ALL</span><span class="p">)</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txout</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">B2I</span><span class="p">(((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
					       <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">status0</span><span class="p">))</span> <span class="o">&amp;</span>
				   <span class="n">D64_XS0_CD_MASK</span><span class="p">)</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">xmtptrbase</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="n">D64_XS0_CD_MASK</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma64desc</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">range</span> <span class="o">==</span> <span class="n">DMA_RANGE_TRANSFERED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">active_desc</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
						  <span class="n">DMA64TXREGOFFS</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">status1</span><span class="p">))</span> <span class="o">&amp;</span>
				      <span class="n">D64_XS1_AD_MASK</span><span class="p">);</span>
			<span class="n">active_desc</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">active_desc</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">xmtptrbase</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">D64_XS0_CD_MASK</span><span class="p">;</span>
			<span class="n">active_desc</span> <span class="o">=</span> <span class="n">B2I</span><span class="p">(</span><span class="n">active_desc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma64desc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">!=</span> <span class="n">active_desc</span><span class="p">)</span>
				<span class="n">end</span> <span class="o">=</span> <span class="n">prevtxd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">active_desc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txout</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bogus</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">txp</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">nexttxd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>
		<span class="n">uint</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">pa</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txd64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addrlow</span><span class="p">)</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">dataoffsetlow</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txd64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl2</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="n">D64_CTRL2_BC_MASK</span><span class="p">);</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">txd64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addrlow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">txd64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addrhigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">);</span>

		<span class="n">txp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">txp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dmadev</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">txin</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* tx flow control */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">txavail</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ntxd</span> <span class="o">-</span> <span class="n">ntxdactive</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txin</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txout</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">txp</span><span class="p">;</span>

 <span class="nl">bogus:</span>
	<span class="n">DMA_NONE</span><span class="p">(</span><span class="s">&quot;bogus curr: start %d end %d txout %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txout</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Mac80211 initiated actions sometimes require packets in the DMA queue to be</span>
<span class="cm"> * modified. The modified portion of the packet is not under control of the DMA</span>
<span class="cm"> * engine. This function calls a caller-supplied function for each packet in</span>
<span class="cm"> * the caller specified dma chain.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dma_walk_packets</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">dmah</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback_fnc</span><span class="p">)</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg_a</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg_a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">dmah</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span> <span class="o">=</span>   <span class="n">di</span><span class="o">-&gt;</span><span class="n">txin</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">end</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">txout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">txp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
			<span class="p">(</span><span class="n">callback_fnc</span><span class="p">)(</span><span class="n">tx_info</span><span class="p">,</span> <span class="n">arg_a</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">nexttxd</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
