<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › brcm80211 › brcmsmac › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY</span>
<span class="cm"> * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION</span>
<span class="cm"> * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/pci_ids.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &lt;brcm_hw_ids.h&gt;</span>
<span class="cp">#include &lt;aiutils.h&gt;</span>
<span class="cp">#include &lt;chipcommon.h&gt;</span>
<span class="cp">#include &quot;rate.h&quot;</span>
<span class="cp">#include &quot;scb.h&quot;</span>
<span class="cp">#include &quot;phy/phy_hal.h&quot;</span>
<span class="cp">#include &quot;channel.h&quot;</span>
<span class="cp">#include &quot;antsel.h&quot;</span>
<span class="cp">#include &quot;stf.h&quot;</span>
<span class="cp">#include &quot;ampdu.h&quot;</span>
<span class="cp">#include &quot;mac80211_if.h&quot;</span>
<span class="cp">#include &quot;ucode_loader.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &quot;soc.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Indication for txflowcontrol that all priority bits in</span>
<span class="cm"> * TXQ_STOP_FOR_PRIOFC_MASK are to be considered.</span>
<span class="cm"> */</span>
<span class="cp">#define ALLPRIO				-1</span>

<span class="cm">/* watchdog timer, in unit of ms */</span>
<span class="cp">#define TIMER_INTERVAL_WATCHDOG		1000</span>
<span class="cm">/* radio monitor timer, in unit of ms */</span>
<span class="cp">#define TIMER_INTERVAL_RADIOCHK		800</span>

<span class="cm">/* beacon interval, in unit of 1024TU */</span>
<span class="cp">#define BEACON_INTERVAL_DEFAULT		100</span>

<span class="cm">/* n-mode support capability */</span>
<span class="cm">/* 2x2 includes both 1x1 &amp; 2x2 devices</span>
<span class="cm"> * reserved #define 2 for future when we want to separate 1x1 &amp; 2x2 and</span>
<span class="cm"> * control it independently</span>
<span class="cm"> */</span>
<span class="cp">#define WL_11N_2x2			1</span>
<span class="cp">#define WL_11N_3x3			3</span>
<span class="cp">#define WL_11N_4x4			4</span>

<span class="cp">#define EDCF_ACI_MASK			0x60</span>
<span class="cp">#define EDCF_ACI_SHIFT			5</span>
<span class="cp">#define EDCF_ECWMIN_MASK		0x0f</span>
<span class="cp">#define EDCF_ECWMAX_SHIFT		4</span>
<span class="cp">#define EDCF_AIFSN_MASK			0x0f</span>
<span class="cp">#define EDCF_AIFSN_MAX			15</span>
<span class="cp">#define EDCF_ECWMAX_MASK		0xf0</span>

<span class="cp">#define EDCF_AC_BE_TXOP_STA		0x0000</span>
<span class="cp">#define EDCF_AC_BK_TXOP_STA		0x0000</span>
<span class="cp">#define EDCF_AC_VO_ACI_STA		0x62</span>
<span class="cp">#define EDCF_AC_VO_ECW_STA		0x32</span>
<span class="cp">#define EDCF_AC_VI_ACI_STA		0x42</span>
<span class="cp">#define EDCF_AC_VI_ECW_STA		0x43</span>
<span class="cp">#define EDCF_AC_BK_ECW_STA		0xA4</span>
<span class="cp">#define EDCF_AC_VI_TXOP_STA		0x005e</span>
<span class="cp">#define EDCF_AC_VO_TXOP_STA		0x002f</span>
<span class="cp">#define EDCF_AC_BE_ACI_STA		0x03</span>
<span class="cp">#define EDCF_AC_BE_ECW_STA		0xA4</span>
<span class="cp">#define EDCF_AC_BK_ACI_STA		0x27</span>
<span class="cp">#define EDCF_AC_VO_TXOP_AP		0x002f</span>

<span class="cp">#define EDCF_TXOP2USEC(txop)		((txop) &lt;&lt; 5)</span>
<span class="cp">#define EDCF_ECW2CW(exp)		((1 &lt;&lt; (exp)) - 1)</span>

<span class="cp">#define APHY_SYMBOL_TIME		4</span>
<span class="cp">#define APHY_PREAMBLE_TIME		16</span>
<span class="cp">#define APHY_SIGNAL_TIME		4</span>
<span class="cp">#define APHY_SIFS_TIME			16</span>
<span class="cp">#define APHY_SERVICE_NBITS		16</span>
<span class="cp">#define APHY_TAIL_NBITS			6</span>
<span class="cp">#define BPHY_SIFS_TIME			10</span>
<span class="cp">#define BPHY_PLCP_SHORT_TIME		96</span>

<span class="cp">#define PREN_PREAMBLE			24</span>
<span class="cp">#define PREN_MM_EXT			12</span>
<span class="cp">#define PREN_PREAMBLE_EXT		4</span>

<span class="cp">#define DOT11_MAC_HDR_LEN		24</span>
<span class="cp">#define DOT11_ACK_LEN			10</span>
<span class="cp">#define DOT11_BA_LEN			4</span>
<span class="cp">#define DOT11_OFDM_SIGNAL_EXTENSION	6</span>
<span class="cp">#define DOT11_MIN_FRAG_LEN		256</span>
<span class="cp">#define DOT11_RTS_LEN			16</span>
<span class="cp">#define DOT11_CTS_LEN			10</span>
<span class="cp">#define DOT11_BA_BITMAP_LEN		128</span>
<span class="cp">#define DOT11_MIN_BEACON_PERIOD		1</span>
<span class="cp">#define DOT11_MAX_BEACON_PERIOD		0xFFFF</span>
<span class="cp">#define DOT11_MAXNUMFRAGS		16</span>
<span class="cp">#define DOT11_MAX_FRAG_LEN		2346</span>

<span class="cp">#define BPHY_PLCP_TIME			192</span>
<span class="cp">#define RIFS_11N_TIME			2</span>

<span class="cm">/* length of the BCN template area */</span>
<span class="cp">#define BCN_TMPL_LEN			512</span>

<span class="cm">/* brcms_bss_info flag bit values */</span>
<span class="cp">#define BRCMS_BSS_HT			0x0020	</span><span class="cm">/* BSS is HT (MIMO) capable */</span><span class="cp"></span>

<span class="cm">/* chip rx buffer offset */</span>
<span class="cp">#define BRCMS_HWRXOFF			38</span>

<span class="cm">/* rfdisable delay timer 500 ms, runs of ALP clock */</span>
<span class="cp">#define RFDISABLE_DEFAULT		10000000</span>

<span class="cp">#define BRCMS_TEMPSENSE_PERIOD		10	</span><span class="cm">/* 10 second timeout */</span><span class="cp"></span>

<span class="cm">/* precedences numbers for wlc queues. These are twice as may levels as</span>
<span class="cm"> * 802.1D priorities.</span>
<span class="cm"> * Odd numbers are used for HI priority traffic at same precedence levels</span>
<span class="cm"> * These constants are used ONLY by wlc_prio2prec_map.  Do not use them</span>
<span class="cm"> * elsewhere.</span>
<span class="cm"> */</span>
<span class="cp">#define _BRCMS_PREC_NONE		0	</span><span class="cm">/* None = - */</span><span class="cp"></span>
<span class="cp">#define _BRCMS_PREC_BK			2	</span><span class="cm">/* BK - Background */</span><span class="cp"></span>
<span class="cp">#define _BRCMS_PREC_BE			4	</span><span class="cm">/* BE - Best-effort */</span><span class="cp"></span>
<span class="cp">#define _BRCMS_PREC_EE			6	</span><span class="cm">/* EE - Excellent-effort */</span><span class="cp"></span>
<span class="cp">#define _BRCMS_PREC_CL			8	</span><span class="cm">/* CL - Controlled Load */</span><span class="cp"></span>
<span class="cp">#define _BRCMS_PREC_VI			10	</span><span class="cm">/* Vi - Video */</span><span class="cp"></span>
<span class="cp">#define _BRCMS_PREC_VO			12	</span><span class="cm">/* Vo - Voice */</span><span class="cp"></span>
<span class="cp">#define _BRCMS_PREC_NC			14	</span><span class="cm">/* NC - Network Control */</span><span class="cp"></span>

<span class="cm">/* synthpu_dly times in us */</span>
<span class="cp">#define SYNTHPU_DLY_APHY_US		3700</span>
<span class="cp">#define SYNTHPU_DLY_BPHY_US		1050</span>
<span class="cp">#define SYNTHPU_DLY_NPHY_US		2048</span>
<span class="cp">#define SYNTHPU_DLY_LPPHY_US		300</span>

<span class="cp">#define ANTCNT				10	</span><span class="cm">/* vanilla M_MAX_ANTCNT val */</span><span class="cp"></span>

<span class="cm">/* Per-AC retry limit register definitions; uses defs.h bitfield macros */</span>
<span class="cp">#define EDCF_SHORT_S			0</span>
<span class="cp">#define EDCF_SFB_S			4</span>
<span class="cp">#define EDCF_LONG_S			8</span>
<span class="cp">#define EDCF_LFB_S			12</span>
<span class="cp">#define EDCF_SHORT_M			BITFIELD_MASK(4)</span>
<span class="cp">#define EDCF_SFB_M			BITFIELD_MASK(4)</span>
<span class="cp">#define EDCF_LONG_M			BITFIELD_MASK(4)</span>
<span class="cp">#define EDCF_LFB_M			BITFIELD_MASK(4)</span>

<span class="cp">#define RETRY_SHORT_DEF			7	</span><span class="cm">/* Default Short retry Limit */</span><span class="cp"></span>
<span class="cp">#define RETRY_SHORT_MAX			255	</span><span class="cm">/* Maximum Short retry Limit */</span><span class="cp"></span>
<span class="cp">#define RETRY_LONG_DEF			4	</span><span class="cm">/* Default Long retry count */</span><span class="cp"></span>
<span class="cp">#define RETRY_SHORT_FB			3	</span><span class="cm">/* Short count for fb rate */</span><span class="cp"></span>
<span class="cp">#define RETRY_LONG_FB			2	</span><span class="cm">/* Long count for fb rate */</span><span class="cp"></span>

<span class="cp">#define APHY_CWMIN			15</span>
<span class="cp">#define PHY_CWMAX			1023</span>

<span class="cp">#define EDCF_AIFSN_MIN			1</span>

<span class="cp">#define FRAGNUM_MASK			0xF</span>

<span class="cp">#define APHY_SLOT_TIME			9</span>
<span class="cp">#define BPHY_SLOT_TIME			20</span>

<span class="cp">#define WL_SPURAVOID_OFF		0</span>
<span class="cp">#define WL_SPURAVOID_ON1		1</span>
<span class="cp">#define WL_SPURAVOID_ON2		2</span>

<span class="cm">/* invalid core flags, use the saved coreflags */</span>
<span class="cp">#define BRCMS_USE_COREFLAGS		0xffffffff</span>

<span class="cm">/* values for PLCPHdr_override */</span>
<span class="cp">#define BRCMS_PLCP_AUTO			-1</span>
<span class="cp">#define BRCMS_PLCP_SHORT		0</span>
<span class="cp">#define BRCMS_PLCP_LONG			1</span>

<span class="cm">/* values for g_protection_override and n_protection_override */</span>
<span class="cp">#define BRCMS_PROTECTION_AUTO		-1</span>
<span class="cp">#define BRCMS_PROTECTION_OFF		0</span>
<span class="cp">#define BRCMS_PROTECTION_ON		1</span>
<span class="cp">#define BRCMS_PROTECTION_MMHDR_ONLY	2</span>
<span class="cp">#define BRCMS_PROTECTION_CTS_ONLY	3</span>

<span class="cm">/* values for g_protection_control and n_protection_control */</span>
<span class="cp">#define BRCMS_PROTECTION_CTL_OFF	0</span>
<span class="cp">#define BRCMS_PROTECTION_CTL_LOCAL	1</span>
<span class="cp">#define BRCMS_PROTECTION_CTL_OVERLAP	2</span>

<span class="cm">/* values for n_protection */</span>
<span class="cp">#define BRCMS_N_PROTECTION_OFF		0</span>
<span class="cp">#define BRCMS_N_PROTECTION_OPTIONAL	1</span>
<span class="cp">#define BRCMS_N_PROTECTION_20IN40	2</span>
<span class="cp">#define BRCMS_N_PROTECTION_MIXEDMODE	3</span>

<span class="cm">/* values for band specific 40MHz capabilities */</span>
<span class="cp">#define BRCMS_N_BW_20ALL		0</span>
<span class="cp">#define BRCMS_N_BW_40ALL		1</span>
<span class="cp">#define BRCMS_N_BW_20IN2G_40IN5G	2</span>

<span class="cm">/* bitflags for SGI support (sgi_rx iovar) */</span>
<span class="cp">#define BRCMS_N_SGI_20			0x01</span>
<span class="cp">#define BRCMS_N_SGI_40			0x02</span>

<span class="cm">/* defines used by the nrate iovar */</span>
<span class="cm">/* MSC in use,indicates b0-6 holds an mcs */</span>
<span class="cp">#define NRATE_MCS_INUSE			0x00000080</span>
<span class="cm">/* rate/mcs value */</span>
<span class="cp">#define NRATE_RATE_MASK			0x0000007f</span>
<span class="cm">/* stf mode mask: siso, cdd, stbc, sdm */</span>
<span class="cp">#define NRATE_STF_MASK			0x0000ff00</span>
<span class="cm">/* stf mode shift */</span>
<span class="cp">#define NRATE_STF_SHIFT			8</span>
<span class="cm">/* bit indicate to override mcs only */</span>
<span class="cp">#define NRATE_OVERRIDE_MCS_ONLY		0x40000000</span>
<span class="cp">#define NRATE_SGI_MASK			0x00800000	</span><span class="cm">/* sgi mode */</span><span class="cp"></span>
<span class="cp">#define NRATE_SGI_SHIFT			23		</span><span class="cm">/* sgi mode */</span><span class="cp"></span>
<span class="cp">#define NRATE_LDPC_CODING		0x00400000	</span><span class="cm">/* adv coding in use */</span><span class="cp"></span>
<span class="cp">#define NRATE_LDPC_SHIFT		22		</span><span class="cm">/* ldpc shift */</span><span class="cp"></span>

<span class="cp">#define NRATE_STF_SISO			0		</span><span class="cm">/* stf mode SISO */</span><span class="cp"></span>
<span class="cp">#define NRATE_STF_CDD			1		</span><span class="cm">/* stf mode CDD */</span><span class="cp"></span>
<span class="cp">#define NRATE_STF_STBC			2		</span><span class="cm">/* stf mode STBC */</span><span class="cp"></span>
<span class="cp">#define NRATE_STF_SDM			3		</span><span class="cm">/* stf mode SDM */</span><span class="cp"></span>

<span class="cp">#define MAX_DMA_SEGS			4</span>

<span class="cm">/* Max # of entries in Tx FIFO based on 4kb page size */</span>
<span class="cp">#define NTXD				256</span>
<span class="cm">/* Max # of entries in Rx FIFO based on 4kb page size */</span>
<span class="cp">#define NRXD				256</span>

<span class="cm">/* try to keep this # rbufs posted to the chip */</span>
<span class="cp">#define NRXBUFPOST			32</span>

<span class="cm">/* data msg txq hiwat mark */</span>
<span class="cp">#define BRCMS_DATAHIWAT			50</span>

<span class="cm">/* max # frames to process in brcms_c_recv() */</span>
<span class="cp">#define RXBND				8</span>
<span class="cm">/* max # tx status to process in wlc_txstatus() */</span>
<span class="cp">#define TXSBND				8</span>

<span class="cm">/* brcmu_format_flags() bit description structure */</span>
<span class="k">struct</span> <span class="n">brcms_c_bit_desc</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The following table lists the buffer memory allocated to xmt fifos in HW.</span>
<span class="cm"> * the size is in units of 256bytes(one block), total size is HW dependent</span>
<span class="cm"> * ucode has default fifo partition, sw can overwrite if necessary</span>
<span class="cm"> *</span>
<span class="cm"> * This is documented in twiki under the topic UcodeTxFifo. Please ensure</span>
<span class="cm"> * the twiki is updated before making changes.</span>
<span class="cm"> */</span>

<span class="cm">/* Starting corerev for the fifo size table */</span>
<span class="cp">#define XMTFIFOTBL_STARTREV	20</span>

<span class="k">struct</span> <span class="n">d11init</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">edcf_acparam</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">ACI</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ECW</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">TXOP</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">const</span> <span class="n">u8</span> <span class="n">prio2fifo</span><span class="p">[</span><span class="n">NUMPRIO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TX_AC_BE_FIFO</span><span class="p">,</span>		<span class="cm">/* 0    BE      AC_BE   Best Effort */</span>
	<span class="n">TX_AC_BK_FIFO</span><span class="p">,</span>		<span class="cm">/* 1    BK      AC_BK   Background */</span>
	<span class="n">TX_AC_BK_FIFO</span><span class="p">,</span>		<span class="cm">/* 2    --      AC_BK   Background */</span>
	<span class="n">TX_AC_BE_FIFO</span><span class="p">,</span>		<span class="cm">/* 3    EE      AC_BE   Best Effort */</span>
	<span class="n">TX_AC_VI_FIFO</span><span class="p">,</span>		<span class="cm">/* 4    CL      AC_VI   Video */</span>
	<span class="n">TX_AC_VI_FIFO</span><span class="p">,</span>		<span class="cm">/* 5    VI      AC_VI   Video */</span>
	<span class="n">TX_AC_VO_FIFO</span><span class="p">,</span>		<span class="cm">/* 6    VO      AC_VO   Voice */</span>
	<span class="n">TX_AC_VO_FIFO</span>		<span class="cm">/* 7    NC      AC_VO   Voice */</span>
<span class="p">};</span>

<span class="cm">/* debug/trace */</span>
<span class="n">uint</span> <span class="n">brcm_msg_level</span> <span class="o">=</span>
<span class="cp">#if defined(DEBUG)</span>
	<span class="n">LOG_ERROR_VAL</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="cm">/* TX FIFO number to WME/802.1E Access Category */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">wme_fifo2ac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IEEE80211_AC_BK</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_BE</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_VI</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_VO</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_BE</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_BE</span>
<span class="p">};</span>

<span class="cm">/* ieee80211 Access Category to TX FIFO number */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">wme_ac2fifo</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TX_AC_VO_FIFO</span><span class="p">,</span>
	<span class="n">TX_AC_VI_FIFO</span><span class="p">,</span>
	<span class="n">TX_AC_BE_FIFO</span><span class="p">,</span>
	<span class="n">TX_AC_BK_FIFO</span>
<span class="p">};</span>

<span class="cm">/* 802.1D Priority to precedence queue mapping */</span>
<span class="k">const</span> <span class="n">u8</span> <span class="n">wlc_prio2prec_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">_BRCMS_PREC_BE</span><span class="p">,</span>		<span class="cm">/* 0 BE - Best-effort */</span>
	<span class="n">_BRCMS_PREC_BK</span><span class="p">,</span>		<span class="cm">/* 1 BK - Background */</span>
	<span class="n">_BRCMS_PREC_NONE</span><span class="p">,</span>		<span class="cm">/* 2 None = - */</span>
	<span class="n">_BRCMS_PREC_EE</span><span class="p">,</span>		<span class="cm">/* 3 EE - Excellent-effort */</span>
	<span class="n">_BRCMS_PREC_CL</span><span class="p">,</span>		<span class="cm">/* 4 CL - Controlled Load */</span>
	<span class="n">_BRCMS_PREC_VI</span><span class="p">,</span>		<span class="cm">/* 5 Vi - Video */</span>
	<span class="n">_BRCMS_PREC_VO</span><span class="p">,</span>		<span class="cm">/* 6 Vo - Voice */</span>
	<span class="n">_BRCMS_PREC_NC</span><span class="p">,</span>		<span class="cm">/* 7 NC - Network Control */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">xmtfifo_sz</span><span class="p">[][</span><span class="n">NFIFO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* corerev 20: 5120, 49152, 49152, 5376, 4352, 1280 */</span>
	<span class="p">{</span><span class="mi">20</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
	<span class="cm">/* corerev 21: 2304, 14848, 5632, 3584, 3584, 1280 */</span>
	<span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
	<span class="cm">/* corerev 22: 5120, 49152, 49152, 5376, 4352, 1280 */</span>
	<span class="p">{</span><span class="mi">20</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
	<span class="cm">/* corerev 23: 5120, 49152, 49152, 5376, 4352, 1280 */</span>
	<span class="p">{</span><span class="mi">20</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
	<span class="cm">/* corerev 24: 2304, 14848, 5632, 3584, 3584, 1280 */</span>
	<span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">fifo_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;AC_BK&quot;</span><span class="p">,</span> <span class="s">&quot;AC_BE&quot;</span><span class="p">,</span> <span class="s">&quot;AC_VI&quot;</span><span class="p">,</span> <span class="s">&quot;AC_VO&quot;</span><span class="p">,</span> <span class="s">&quot;BCMC&quot;</span><span class="p">,</span> <span class="s">&quot;ATIM&quot;</span> <span class="p">};</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">fifo_names</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cm">/* pointer to most recently allocated wl/wlc */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc_info_dbg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* Find basic rate for a given rate */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">brcms_basic_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">[</span><span class="n">mcs_table</span><span class="p">[</span><span class="n">rspec</span> <span class="o">&amp;</span> <span class="n">RSPEC_RATE_MASK</span><span class="p">]</span>
		       <span class="p">.</span><span class="n">leg_ofdm</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">[</span><span class="n">rspec</span> <span class="o">&amp;</span> <span class="n">RSPEC_RATE_MASK</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">frametype</span><span class="p">(</span><span class="n">u32</span> <span class="n">rspec</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mimoframe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">mimoframe</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">is_cck_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">)</span> <span class="o">?</span> <span class="n">FT_CCK</span> <span class="o">:</span> <span class="n">FT_OFDM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* currently the best mechanism for determining SIFS is the band in use */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_sifs</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_band</span> <span class="o">*</span><span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span> <span class="o">?</span> <span class="n">APHY_SIFS_TIME</span> <span class="o">:</span>
				 <span class="n">BPHY_SIFS_TIME</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Detect Card removed.</span>
<span class="cm"> * Even checking an sbconfig register read will not false trigger when the core</span>
<span class="cm"> * is in reset it breaks CF address mechanism. Accessing gphy phyversion will</span>
<span class="cm"> * cause SB error if aphy is in reset on 4306B0-DB. Need a simple accessible</span>
<span class="cm"> * reg with fixed 0/1 pattern (some platforms return all 0).</span>
<span class="cm"> * If clocks are present, call the sb routine which will figure out if the</span>
<span class="cm"> * device is removed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_deviceremoved</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">macctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ai_deviceremoved</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>
	<span class="n">macctrl</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
			      <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">macctrl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MCTL_PSM_JMP_0</span> <span class="o">|</span> <span class="n">MCTL_IHR_EN</span><span class="p">))</span> <span class="o">!=</span> <span class="n">MCTL_IHR_EN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sum the individual fifo tx pending packet counts */</span>
<span class="k">static</span> <span class="n">s16</span> <span class="nf">brcms_txpktpendtot</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">txpktpend</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">txpktpend</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
	       <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">txpktpend</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">txpktpend</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_is_mband_unlocked</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandlocked</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_chspec_bw</span><span class="p">(</span><span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHSPEC_IS40</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BRCMS_40_MHZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHSPEC_IS20</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BRCMS_20_MHZ</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BRCMS_10_MHZ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_bsscfg_mfree</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_bss_cfg</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">current_bss</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_detach_mfree</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">brcms_c_bsscfg_mfree</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">corestate</span><span class="o">-&gt;</span><span class="n">macstat_snapshot</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">corestate</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* free the wlc */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="n">wlc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">brcms_bss_cfg</span> <span class="o">*</span><span class="nf">brcms_c_bsscfg_malloc</span><span class="p">(</span><span class="n">uint</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_bss_cfg</span> <span class="o">*</span><span class="n">cfg</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_bss_cfg</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">current_bss</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_bss_info</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">current_bss</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cfg</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">brcms_c_bsscfg_mfree</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span>
<span class="nf">brcms_c_attach_malloc</span><span class="p">(</span><span class="n">uint</span> <span class="n">unit</span><span class="p">,</span> <span class="n">uint</span> <span class="o">*</span><span class="n">err</span><span class="p">,</span> <span class="n">uint</span> <span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">;</span>

	<span class="n">wlc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="mi">1002</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate struct brcms_c_pub state structure */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_pub</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="mi">1003</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc</span><span class="p">;</span>

	<span class="cm">/* allocate struct brcms_hardware state structure */</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="mi">1005</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hw_band</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAXBANDS</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="mi">1006</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXBANDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hw_band</span> <span class="o">*</span><span class="p">)</span>
			    <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
			     <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hw_band</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">modulecb</span><span class="p">)</span> <span class="o">*</span> <span class="n">BRCMS_MAXMODULES</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="mi">1009</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_bss_info</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="mi">1010</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span> <span class="o">=</span> <span class="n">brcms_c_bsscfg_malloc</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="mi">1011</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_protection</span><span class="p">),</span>
				  <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="mi">1016</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_stf</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="mi">1017</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_band</span><span class="p">)</span><span class="o">*</span><span class="n">MAXBANDS</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="mi">1025</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXBANDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_band</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_band</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">corestate</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_core</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">corestate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="mi">1026</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">corestate</span><span class="o">-&gt;</span><span class="n">macstat_snapshot</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">macstat</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">corestate</span><span class="o">-&gt;</span><span class="n">macstat_snapshot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="mi">1027</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">wlc</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">brcms_c_detach_mfree</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update the slot timing for standard 11b/g (20us slots)</span>
<span class="cm"> * or shortslot 11g (9us slots)</span>
<span class="cm"> * The PSM needs to be suspended for this call.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_update_slot_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span>
					<span class="n">bool</span> <span class="n">shortslot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shortslot</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 11g short slot: 11a timing */</span>
		<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">ifs_slot</span><span class="p">),</span> <span class="mh">0x0207</span><span class="p">);</span>
		<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_DOT11_SLOT</span><span class="p">,</span> <span class="n">APHY_SLOT_TIME</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* 11g long slot: 11b timing */</span>
		<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">ifs_slot</span><span class="p">),</span> <span class="mh">0x0212</span><span class="p">);</span>
		<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_DOT11_SLOT</span><span class="p">,</span> <span class="n">BPHY_SLOT_TIME</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * calculate frame duration of a given rate and length, return</span>
<span class="cm"> * time in usec unit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">uint</span> <span class="nf">brcms_c_calc_frame_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ratespec</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="n">preamble_type</span><span class="p">,</span> <span class="n">uint</span> <span class="n">mac_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">nsyms</span><span class="p">,</span> <span class="n">dur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Ndps</span><span class="p">,</span> <span class="n">kNdps</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">rspec2rate</span><span class="p">(</span><span class="n">ratespec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: WAR: using rate of 1 mbps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">BRCM_RATE_1M</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: rspec 0x%x, preamble_type %d, len%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">ratespec</span><span class="p">,</span> <span class="n">preamble_type</span><span class="p">,</span> <span class="n">mac_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">ratespec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">uint</span> <span class="n">mcs</span> <span class="o">=</span> <span class="n">ratespec</span> <span class="o">&amp;</span> <span class="n">RSPEC_RATE_MASK</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tot_streams</span> <span class="o">=</span> <span class="n">mcs_2_txstreams</span><span class="p">(</span><span class="n">mcs</span><span class="p">)</span> <span class="o">+</span> <span class="n">rspec_stc</span><span class="p">(</span><span class="n">ratespec</span><span class="p">);</span>

		<span class="n">dur</span> <span class="o">=</span> <span class="n">PREN_PREAMBLE</span> <span class="o">+</span> <span class="p">(</span><span class="n">tot_streams</span> <span class="o">*</span> <span class="n">PREN_PREAMBLE_EXT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">preamble_type</span> <span class="o">==</span> <span class="n">BRCMS_MM_PREAMBLE</span><span class="p">)</span>
			<span class="n">dur</span> <span class="o">+=</span> <span class="n">PREN_MM_EXT</span><span class="p">;</span>
		<span class="cm">/* 1000Ndbps = kbps * 4 */</span>
		<span class="n">kNdps</span> <span class="o">=</span> <span class="n">mcs_2_rate</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">rspec_is40mhz</span><span class="p">(</span><span class="n">ratespec</span><span class="p">),</span>
				   <span class="n">rspec_issgi</span><span class="p">(</span><span class="n">ratespec</span><span class="p">))</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rspec_stc</span><span class="p">(</span><span class="n">ratespec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nsyms</span> <span class="o">=</span>
			    <span class="n">CEIL</span><span class="p">((</span><span class="n">APHY_SERVICE_NBITS</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">mac_len</span> <span class="o">+</span>
				  <span class="n">APHY_TAIL_NBITS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">kNdps</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* STBC needs to have even number of symbols */</span>
			<span class="n">nsyms</span> <span class="o">=</span>
			    <span class="mi">2</span> <span class="o">*</span>
			    <span class="n">CEIL</span><span class="p">((</span><span class="n">APHY_SERVICE_NBITS</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">mac_len</span> <span class="o">+</span>
				  <span class="n">APHY_TAIL_NBITS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">kNdps</span><span class="p">);</span>

		<span class="n">dur</span> <span class="o">+=</span> <span class="n">APHY_SYMBOL_TIME</span> <span class="o">*</span> <span class="n">nsyms</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span><span class="p">)</span>
			<span class="n">dur</span> <span class="o">+=</span> <span class="n">DOT11_OFDM_SIGNAL_EXTENSION</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dur</span> <span class="o">=</span> <span class="n">APHY_PREAMBLE_TIME</span><span class="p">;</span>
		<span class="n">dur</span> <span class="o">+=</span> <span class="n">APHY_SIGNAL_TIME</span><span class="p">;</span>
		<span class="cm">/* Ndbps = Mbps * 4 = rate(500Kbps) * 2 */</span>
		<span class="n">Ndps</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* NSyms = CEILING((SERVICE + 8*NBytes + TAIL) / Ndbps) */</span>
		<span class="n">nsyms</span> <span class="o">=</span>
		    <span class="n">CEIL</span><span class="p">((</span><span class="n">APHY_SERVICE_NBITS</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">mac_len</span> <span class="o">+</span> <span class="n">APHY_TAIL_NBITS</span><span class="p">),</span>
			 <span class="n">Ndps</span><span class="p">);</span>
		<span class="n">dur</span> <span class="o">+=</span> <span class="n">APHY_SYMBOL_TIME</span> <span class="o">*</span> <span class="n">nsyms</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span><span class="p">)</span>
			<span class="n">dur</span> <span class="o">+=</span> <span class="n">DOT11_OFDM_SIGNAL_EXTENSION</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * calc # bits * 2 so factor of 2 in rate (1/2 mbps)</span>
<span class="cm">		 * will divide out</span>
<span class="cm">		 */</span>
		<span class="n">mac_len</span> <span class="o">=</span> <span class="n">mac_len</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* calc ceiling of bits/rate = microseconds of air time */</span>
		<span class="n">dur</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac_len</span> <span class="o">+</span> <span class="n">rate</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">preamble_type</span> <span class="o">&amp;</span> <span class="n">BRCMS_SHORT_PREAMBLE</span><span class="p">)</span>
			<span class="n">dur</span> <span class="o">+=</span> <span class="n">BPHY_PLCP_SHORT_TIME</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dur</span> <span class="o">+=</span> <span class="n">BPHY_PLCP_TIME</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dur</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_write_inits</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">d11init</span> <span class="o">*</span><span class="n">inits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">inits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">inits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">inits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">inits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_write_mhf</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">mhfs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">M_HOST_FLAGS1</span><span class="p">,</span> <span class="n">M_HOST_FLAGS2</span><span class="p">,</span> <span class="n">M_HOST_FLAGS3</span><span class="p">,</span> <span class="n">M_HOST_FLAGS4</span><span class="p">,</span>
		<span class="n">M_HOST_FLAGS5</span>
	<span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">MHFMAX</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">mhfs</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_ucode_bsinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_ucode</span> <span class="o">*</span><span class="n">ucode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ucode</span><span class="p">;</span>

	<span class="cm">/* init microcode host flags */</span>
	<span class="n">brcms_c_write_mhf</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">mhfs</span><span class="p">);</span>

	<span class="cm">/* do band-specific ucode IHR, SHM, and SCR inits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">D11REV_IS</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">23</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISNPHY</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span>
			<span class="n">brcms_c_write_inits</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">ucode</span><span class="o">-&gt;</span><span class="n">d11n0bsinitvals16</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: wl%d: unsupported phy in corerev&quot;</span>
				  <span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
				  <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">D11REV_IS</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISLCNPHY</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span>
				<span class="n">brcms_c_write_inits</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span>
						    <span class="n">ucode</span><span class="o">-&gt;</span><span class="n">d11lcn0bsinitvals24</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: wl%d: unsupported phy in&quot;</span>
					  <span class="s">&quot; core rev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					  <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: wl%d: unsupported corerev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_core_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">m</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioctl</span> <span class="o">=</span> <span class="n">bcma_aread32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">BCMA_IOCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">m</span><span class="p">;</span>

	<span class="n">bcma_awrite32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">BCMA_IOCTL</span><span class="p">,</span> <span class="n">ioctl</span> <span class="o">|</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_core_phy_clk</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: clk %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">clk</span><span class="p">);</span>

	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">phyclk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OFF</span> <span class="o">==</span> <span class="n">clk</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* clear gmode bit, put phy into reset */</span>

		<span class="n">brcms_b_core_ioctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="p">(</span><span class="n">SICF_PRST</span> <span class="o">|</span> <span class="n">SICF_FGC</span> <span class="o">|</span> <span class="n">SICF_GMODE</span><span class="p">),</span>
				   <span class="p">(</span><span class="n">SICF_PRST</span> <span class="o">|</span> <span class="n">SICF_FGC</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">brcms_b_core_ioctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="p">(</span><span class="n">SICF_PRST</span> <span class="o">|</span> <span class="n">SICF_FGC</span><span class="p">),</span> <span class="n">SICF_PRST</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* take phy out of reset */</span>

		<span class="n">brcms_b_core_ioctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="p">(</span><span class="n">SICF_PRST</span> <span class="o">|</span> <span class="n">SICF_FGC</span><span class="p">),</span> <span class="n">SICF_FGC</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">brcms_b_core_ioctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">SICF_FGC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* low-level band switch utility routine */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_setxband</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">uint</span> <span class="n">bandunit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: bandunit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
		<span class="n">bandunit</span><span class="p">);</span>

	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">bandunit</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * BMAC_NOTE:</span>
<span class="cm">	 *   until we eliminate need for wlc-&gt;band refs in low level code</span>
<span class="cm">	 */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">bandunit</span><span class="p">];</span>

	<span class="cm">/* set gmode core flag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sbclk</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">noreset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">gmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bandunit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">gmode</span> <span class="o">=</span> <span class="n">SICF_GMODE</span><span class="p">;</span>

		<span class="n">brcms_b_core_ioctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">SICF_GMODE</span><span class="p">,</span> <span class="n">gmode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* switch to new band but leave it inactive */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">brcms_c_setband_inact</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">uint</span> <span class="n">bandunit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macintmask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macctrl</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
	<span class="n">macctrl</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
			      <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">((</span><span class="n">macctrl</span> <span class="o">&amp;</span> <span class="n">MCTL_EN_MAC</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="n">macintmask</span> <span class="o">=</span> <span class="n">brcms_intrsoff</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>

	<span class="cm">/* radio off */</span>
	<span class="n">wlc_phy_switch_radio</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

	<span class="n">brcms_b_core_phy_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

	<span class="n">brcms_c_setxband</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">bandunit</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">macintmask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* process an individual struct tx_status */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">brcms_c_dotxstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_status</span> <span class="o">*</span><span class="n">txs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d11txh</span> <span class="o">*</span><span class="n">txh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">free_pdu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_rts</span><span class="p">,</span> <span class="n">tx_frame_count</span><span class="p">,</span> <span class="n">tx_rts_count</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">totlen</span><span class="p">,</span> <span class="n">supr_status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">lastframe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mcl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">txrate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* discard intermediate indications for ucode with one legitimate case:</span>
<span class="cm">	 *   e.g. if &quot;useRTS&quot; is set. ucode did a successful rts/cts exchange,</span>
<span class="cm">	 *   but the subsequent tx of DATA failed. so it will start rts/cts</span>
<span class="cm">	 *   from the beginning (resetting the rts transmission count)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_AMPDU</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_INTERMEDIATE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;INTERMEDIATE but not AMPDU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">txs</span><span class="o">-&gt;</span><span class="n">frameid</span> <span class="o">&amp;</span> <span class="n">TXFID_QUEUE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&gt;=</span> <span class="n">NFIFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fatal</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">dma_getnexttxp</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">queue</span><span class="p">],</span> <span class="n">DMA_RANGE_TRANSMITTED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fatal</span><span class="p">;</span>

	<span class="n">txh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">d11txh</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">mcl</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">MacTxControlLow</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">phyerr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brcm_msg_level</span> <span class="o">&amp;</span> <span class="n">LOG_ERROR_VAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;phyerr 0x%x, rate 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">txs</span><span class="o">-&gt;</span><span class="n">phyerr</span><span class="p">,</span> <span class="n">txh</span><span class="o">-&gt;</span><span class="n">MainRates</span><span class="p">);</span>
			<span class="n">brcms_c_print_txdesc</span><span class="p">(</span><span class="n">txh</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">brcms_c_print_txstatus</span><span class="p">(</span><span class="n">txs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">frameid</span> <span class="o">!=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFrameID</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fatal</span><span class="p">;</span>
	<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">txh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">D11_PHY_HDR_LEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pri_scb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_c_ampdu_dotxstatus</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ampdu</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">txs</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">supr_status</span> <span class="o">=</span> <span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_SUPR_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">supr_status</span> <span class="o">==</span> <span class="n">TX_STATUS_SUPR_BADCH</span><span class="p">)</span>
		<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
		       <span class="s">&quot;%s: Pkt tx suppressed, possibly channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">));</span>

	<span class="n">tx_rts</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">MacTxControlLow</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXC_SENDRTS</span><span class="p">;</span>
	<span class="n">tx_frame_count</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_FRM_RTX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TX_STATUS_FRM_RTX_SHIFT</span><span class="p">;</span>
	<span class="n">tx_rts_count</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_RTS_RTX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TX_STATUS_RTS_RTX_SHIFT</span><span class="p">;</span>

	<span class="n">lastframe</span> <span class="o">=</span> <span class="o">!</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lastframe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Not last frame!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set information to be consumed by Minstrel ht.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The &quot;fallback limit&quot; is the number of tx attempts a given</span>
<span class="cm">		 * MPDU is sent at the &quot;primary&quot; rate. Tx attempts beyond that</span>
<span class="cm">		 * limit are sent at the &quot;secondary&quot; rate.</span>
<span class="cm">		 * A &#39;short frame&#39; does not exceed RTS treshold.</span>
<span class="cm">		 */</span>
		<span class="n">u16</span> <span class="n">sfbl</span><span class="p">,</span>	<span class="cm">/* Short Frame Rate Fallback Limit */</span>
		    <span class="n">lfbl</span><span class="p">,</span>	<span class="cm">/* Long Frame Rate Fallback Limit */</span>
		    <span class="n">fbl</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_ACS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sfbl</span> <span class="o">=</span> <span class="n">GFIELD</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wme_retries</span><span class="p">[</span><span class="n">wme_fifo2ac</span><span class="p">[</span><span class="n">queue</span><span class="p">]],</span>
				      <span class="n">EDCF_SFB</span><span class="p">);</span>
			<span class="n">lfbl</span> <span class="o">=</span> <span class="n">GFIELD</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wme_retries</span><span class="p">[</span><span class="n">wme_fifo2ac</span><span class="p">[</span><span class="n">queue</span><span class="p">]],</span>
				      <span class="n">EDCF_LFB</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sfbl</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">SFBL</span><span class="p">;</span>
			<span class="n">lfbl</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">LFBL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">txrate</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txrate</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span><span class="p">)</span>
			<span class="n">fbl</span> <span class="o">=</span> <span class="n">lfbl</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fbl</span> <span class="o">=</span> <span class="n">sfbl</span><span class="p">;</span>

		<span class="n">ieee80211_tx_info_clear_status</span><span class="p">(</span><span class="n">tx_info</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tx_frame_count</span> <span class="o">&gt;</span> <span class="n">fbl</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">txrate</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * rate selection requested a fallback rate</span>
<span class="cm">			 * and we used it</span>
<span class="cm">			 */</span>
			<span class="n">txrate</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">fbl</span><span class="p">;</span>
			<span class="n">txrate</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">tx_frame_count</span> <span class="o">-</span> <span class="n">fbl</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * rate selection did not request fallback rate, or</span>
<span class="cm">			 * we didn&#39;t need it</span>
<span class="cm">			 */</span>
			<span class="n">txrate</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">tx_frame_count</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * rc80211_minstrel.c:minstrel_tx_status() expects</span>
<span class="cm">			 * unused rates to be marked with idx = -1</span>
<span class="cm">			 */</span>
			<span class="n">txrate</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">txrate</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* clear the rest of the rates */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_TX_MAX_RATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">txrate</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_ACK_RCV</span><span class="p">)</span>
			<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">totlen</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">free_pdu</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">brcms_c_txfifo_complete</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lastframe</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* remove PLCP &amp; Broadcom tx descriptor header */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">D11_PHY_HDR_LEN</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">D11_TXH_LEN</span><span class="p">);</span>
		<span class="n">ieee80211_tx_status_irqsafe</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: Not last frame =&gt; not calling &quot;</span>
			  <span class="s">&quot;tx_status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

 <span class="nl">fatal:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* process tx completion events in BMAC</span>
<span class="cm"> * Return true if more tx status need to be processed. false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">brcms_b_txstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">bound</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">fatal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">morepending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_status</span> <span class="n">txstatus</span><span class="p">,</span> <span class="o">*</span><span class="n">txs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Param &#39;max_tx_num&#39; indicates max. # tx status to process before</span>
<span class="cm">	 * break out.</span>
<span class="cm">	 */</span>
	<span class="n">uint</span> <span class="n">max_tx_num</span> <span class="o">=</span> <span class="n">bound</span> <span class="o">?</span> <span class="n">TXSBND</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="n">txs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txstatus</span><span class="p">;</span>
	<span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fatal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">s1</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">frmtxstatus</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">fatal</span><span class="p">)</span>
	       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s1</span> <span class="o">&amp;</span> <span class="n">TXS_V</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s1</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: dead chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">morepending</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s2</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">frmtxstatus2</span><span class="p">));</span>

		<span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">&amp;</span> <span class="n">TXS_STATUS_MASK</span><span class="p">;</span>
		<span class="n">txs</span><span class="o">-&gt;</span><span class="n">frameid</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1</span> <span class="o">&amp;</span> <span class="n">TXS_FID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TXS_FID_SHIFT</span><span class="p">;</span>
		<span class="n">txs</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">s2</span> <span class="o">&amp;</span> <span class="n">TXS_SEQ_MASK</span><span class="p">;</span>
		<span class="n">txs</span><span class="o">-&gt;</span><span class="n">phyerr</span> <span class="o">=</span> <span class="p">(</span><span class="n">s2</span> <span class="o">&amp;</span> <span class="n">TXS_PTX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TXS_PTX_SHIFT</span><span class="p">;</span>
		<span class="n">txs</span><span class="o">-&gt;</span><span class="n">lasttxtime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="o">*</span><span class="n">fatal</span> <span class="o">=</span> <span class="n">brcms_c_dotxstatus</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">txs</span><span class="p">);</span>

		<span class="cm">/* !give others some time to run! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">max_tx_num</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">s1</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">frmtxstatus</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fatal</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">max_tx_num</span><span class="p">)</span>
		<span class="n">morepending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pktq_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pkt_queue</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">))</span>
		<span class="n">brcms_c_send_q</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">morepending</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_tbtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">BSS</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * DirFrmQ is now valid...defer setting until end</span>
<span class="cm">		 * of ATIM window</span>
<span class="cm">		 */</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">qvalid</span> <span class="o">|=</span> <span class="n">MCMD_DIRFRMQVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set initial host flags value */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_c_mhfdef</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">mhfs</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mhf2_init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mhfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MHFMAX</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>

	<span class="n">mhfs</span><span class="p">[</span><span class="n">MHF2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">mhf2_init</span><span class="p">;</span>

	<span class="cm">/* prohibit use of slowclock on multifunction boards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardflags</span> <span class="o">&amp;</span> <span class="n">BFL_NOPLLDOWN</span><span class="p">)</span>
		<span class="n">mhfs</span><span class="p">[</span><span class="n">MHF1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MHF1_FORCEFASTCLK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISNPHY</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">NREV_LT</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phyrev</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mhfs</span><span class="p">[</span><span class="n">MHF2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MHF2_NPHY40MHZ_WAR</span><span class="p">;</span>
		<span class="n">mhfs</span><span class="p">[</span><span class="n">MHF1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MHF1_IQSWAP_WAR</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span>
<span class="nf">dmareg</span><span class="p">(</span><span class="n">uint</span> <span class="n">direction</span><span class="p">,</span> <span class="n">uint</span> <span class="n">fifonum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_TX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d11regs</span><span class="p">,</span> <span class="n">fifo64regs</span><span class="p">[</span><span class="n">fifonum</span><span class="p">].</span><span class="n">dmaxmt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d11regs</span><span class="p">,</span> <span class="n">fifo64regs</span><span class="p">[</span><span class="n">fifonum</span><span class="p">].</span><span class="n">dmarcv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_b_attach_dmapio</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">uint</span> <span class="n">j</span><span class="p">,</span> <span class="n">bool</span> <span class="n">wme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * ucode host flag 2 needed for pio mode, independent of band and fifo</span>
<span class="cm">	 */</span>
	<span class="n">u16</span> <span class="n">pio_mhf2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="cm">/* name and offsets for dma_attach */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;wl%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Init FIFOs */</span>
		<span class="kt">int</span> <span class="n">dma_attach_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * FIFO 0</span>
<span class="cm">		 * TX: TX_AC_BK_FIFO (TX AC Background data packets)</span>
<span class="cm">		 * RX: RX_FIFO (RX data packets)</span>
<span class="cm">		 */</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_attach</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">wme</span> <span class="o">?</span> <span class="n">dmareg</span><span class="p">(</span><span class="n">DMA_TX</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
					   <span class="n">dmareg</span><span class="p">(</span><span class="n">DMA_RX</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					   <span class="p">(</span><span class="n">wme</span> <span class="o">?</span> <span class="n">NTXD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">NRXD</span><span class="p">,</span>
					   <span class="n">RXBUFSZ</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">NRXBUFPOST</span><span class="p">,</span>
					   <span class="n">BRCMS_HWRXOFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">brcm_msg_level</span><span class="p">);</span>
		<span class="n">dma_attach_err</span> <span class="o">|=</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="cm">/*</span>
<span class="cm">		 * FIFO 1</span>
<span class="cm">		 * TX: TX_AC_BE_FIFO (TX AC Best-Effort data packets)</span>
<span class="cm">		 *   (legacy) TX_DATA_FIFO (TX data packets)</span>
<span class="cm">		 * RX: UNUSED</span>
<span class="cm">		 */</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_attach</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
					   <span class="n">dmareg</span><span class="p">(</span><span class="n">DMA_TX</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">NTXD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">brcm_msg_level</span><span class="p">);</span>
		<span class="n">dma_attach_err</span> <span class="o">|=</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="cm">/*</span>
<span class="cm">		 * FIFO 2</span>
<span class="cm">		 * TX: TX_AC_VI_FIFO (TX AC Video data packets)</span>
<span class="cm">		 * RX: UNUSED</span>
<span class="cm">		 */</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_attach</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
					   <span class="n">dmareg</span><span class="p">(</span><span class="n">DMA_TX</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">NTXD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">brcm_msg_level</span><span class="p">);</span>
		<span class="n">dma_attach_err</span> <span class="o">|=</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIFO 3</span>
<span class="cm">		 * TX: TX_AC_VO_FIFO (TX AC Voice data packets)</span>
<span class="cm">		 *   (legacy) TX_CTL_FIFO (TX control &amp; mgmt packets)</span>
<span class="cm">		 */</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_attach</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
					   <span class="n">dmareg</span><span class="p">(</span><span class="n">DMA_TX</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
					   <span class="mi">0</span><span class="p">,</span> <span class="n">NTXD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
					   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">brcm_msg_level</span><span class="p">);</span>
		<span class="n">dma_attach_err</span> <span class="o">|=</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="cm">/* Cleaner to leave this as if with AP defined */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma_attach_err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: wlc_attach: dma_attach failed&quot;</span>
				  <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get pointer to dma engine tx flow control variable */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NFIFO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">txavail</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">uint</span> <span class="o">*</span><span class="p">)</span> <span class="n">dma_getvar</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							<span class="s">&quot;&amp;txavail&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* initial ucode host flags */</span>
	<span class="n">brcms_c_mhfdef</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">mhfs</span><span class="p">,</span> <span class="n">pio_mhf2</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_detach_dmapio</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NFIFO</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dma_detach</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize brcms_c_info default values ...</span>
<span class="cm"> * may get overrides later in this function</span>
<span class="cm"> *  BMAC_NOTES, move low out and resolve the dangling ones</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_info_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>

	<span class="cm">/* set default sw macintmask value */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">defmacintmask</span> <span class="o">=</span> <span class="n">DEF_MACINTMASK</span><span class="p">;</span>

	<span class="cm">/* various 802.11g modes */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">shortslot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">SFBL</span> <span class="o">=</span> <span class="n">RETRY_SHORT_FB</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">LFBL</span> <span class="o">=</span> <span class="n">RETRY_LONG_FB</span><span class="p">;</span>

	<span class="cm">/* default mac retry limits */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">SRL</span> <span class="o">=</span> <span class="n">RETRY_SHORT_DEF</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">LRL</span> <span class="o">=</span> <span class="n">RETRY_LONG_DEF</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">chanspec</span> <span class="o">=</span> <span class="n">ch20mhz_chspec</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_wait_for_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* delay before first read of ucode state */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="cm">/* wait until ucode is no longer asleep */</span>
	<span class="n">SPINWAIT</span><span class="p">((</span><span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_UCODE_DBGST</span><span class="p">)</span> <span class="o">==</span>
		  <span class="n">DBGST_ASLEEP</span><span class="p">),</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fastpwrup_dly</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* control chip clock to save power, enable dynamic clock or force fast clock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_clkctl_clk</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bcma_clkmode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai_get_cccaps</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CC_CAP_PMU</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* new chips with PMU, CCS_FORCEHT will distribute the HT clock</span>
<span class="cm">		 * on backplane, but mac core will still run on ALP(not HT) when</span>
<span class="cm">		 * it enters powersave mode, which means the FCA bit may not be</span>
<span class="cm">		 * set. Should wakeup mac if driver wants it to run on HT.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BCMA_CLKMODE_FAST</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bcma_set32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
					   <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">clk_ctl_st</span><span class="p">),</span>
					   <span class="n">CCS_FORCEHT</span><span class="p">);</span>

				<span class="n">udelay</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>

				<span class="n">SPINWAIT</span><span class="p">(</span>
				    <span class="p">((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
				      <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">clk_ctl_st</span><span class="p">))</span> <span class="o">&amp;</span>
				      <span class="n">CCS_HTAVAIL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
				      <span class="n">PMU_MAX_TRANSITION_DLY</span><span class="p">);</span>
				<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
					<span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">clk_ctl_st</span><span class="p">))</span> <span class="o">&amp;</span>
					<span class="n">CCS_HTAVAIL</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ai_get_pmurev</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
					<span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">clk_ctl_st</span><span class="p">))</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="n">CCS_FORCEHT</span> <span class="o">|</span> <span class="n">CCS_HTAREQ</span><span class="p">)))</span>
					<span class="n">SPINWAIT</span><span class="p">(</span>
					    <span class="p">((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
					      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d11regs</span><span class="p">,</span>
						       <span class="n">clk_ctl_st</span><span class="p">))</span> <span class="o">&amp;</span>
					      <span class="n">CCS_HTAVAIL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
					      <span class="n">PMU_MAX_TRANSITION_DLY</span><span class="p">);</span>
				<span class="n">bcma_mask32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
					<span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">clk_ctl_st</span><span class="p">),</span>
					<span class="o">~</span><span class="n">CCS_FORCEHT</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">forcefastclk</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BCMA_CLKMODE_FAST</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* old chips w/o PMU, force HT through cc,</span>
<span class="cm">		 * then use FCA to verify mac is running fast clock</span>
<span class="cm">		 */</span>

		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">forcefastclk</span> <span class="o">=</span> <span class="n">ai_clkctl_cc</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

		<span class="cm">/* check fast clock is available (if core is not in reset) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">forcefastclk</span> <span class="o">&amp;&amp;</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcma_aread32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">BCMA_IOST</span><span class="p">)</span> <span class="o">&amp;</span>
				  <span class="n">SISF_FCLKA</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * keep the ucode wake bit on if forcefastclk is on since we</span>
<span class="cm">		 * do not want ucode to put us back to slow clock when it dozes</span>
<span class="cm">		 * for PM mode. Code below matches the wake override bit with</span>
<span class="cm">		 * current forcefastclk state. Only setting bit in wake_override</span>
<span class="cm">		 * instead of waking ucode immediately since old code had this</span>
<span class="cm">		 * behavior. Older code set wlc-&gt;forcefastclk but only had the</span>
<span class="cm">		 * wake happen if the wakup_ucode work (protected by an up</span>
<span class="cm">		 * check) was executed just below.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">forcefastclk</span><span class="p">)</span>
			<span class="n">mboolset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wake_override</span><span class="p">,</span>
				 <span class="n">BRCMS_WAKE_OVERRIDE_FORCEFAST</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mboolclr</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wake_override</span><span class="p">,</span>
				 <span class="n">BRCMS_WAKE_OVERRIDE_FORCEFAST</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* set or clear ucode host flag bits</span>
<span class="cm"> * it has an optimization for no-change write</span>
<span class="cm"> * it only writes through shared memory when the core has clock;</span>
<span class="cm"> * pre-CLK changes should use wlc_write_mhf to get around the optimization</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * bands values are: BRCM_BAND_AUTO &lt;--- Current band only</span>
<span class="cm"> *                   BRCM_BAND_5G   &lt;--- 5G band only</span>
<span class="cm"> *                   BRCM_BAND_2G   &lt;--- 2G band only</span>
<span class="cm"> *                   BRCM_BAND_ALL  &lt;--- All bands</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">brcms_b_mhf</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">bands</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">save</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">[</span><span class="n">MHFMAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">M_HOST_FLAGS1</span><span class="p">,</span> <span class="n">M_HOST_FLAGS2</span><span class="p">,</span> <span class="n">M_HOST_FLAGS3</span><span class="p">,</span> <span class="n">M_HOST_FLAGS4</span><span class="p">,</span>
		<span class="n">M_HOST_FLAGS5</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">brcms_hw_band</span> <span class="o">*</span><span class="n">band</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">MHFMAX</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* error condition */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Current band only or all bands,</span>
<span class="cm">		 * then set the band to current band</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">BRCM_BAND_AUTO</span>:
	<span class="k">case</span> <span class="n">BRCM_BAND_ALL</span>:
		<span class="n">band</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCM_BAND_5G</span>:
		<span class="n">band</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">BAND_5G_INDEX</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCM_BAND_2G</span>:
		<span class="n">band</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">BAND_2G_INDEX</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">band</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* error condition */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">band</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">save</span> <span class="o">=</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">mhfs</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">mhfs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">mhfs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>

		<span class="cm">/* optimization: only write through if changed, and</span>
<span class="cm">		 * changed band is the current band</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">mhfs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="n">save</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span>
			<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
					   <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">mhfs</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bands</span> <span class="o">==</span> <span class="n">BRCM_BAND_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mhfs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mhfs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mhfs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mhfs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* set the maccontrol register to desired reset state and</span>
<span class="cm"> * initialize the sw cache of the register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_mctrl_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* IHR accesses are always enabled, PSM disabled, HPS off and WAKE on */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">maccontrol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">suspended_fifos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wake_override</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">mute_override</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">brcms_b_mctrl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">MCTL_IHR_EN</span> <span class="o">|</span> <span class="n">MCTL_WAKE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write the software state of maccontrol and</span>
<span class="cm"> * overrides to the maccontrol register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_mctrl_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">maccontrol</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">maccontrol</span><span class="p">;</span>

	<span class="cm">/* OR in the wake bit if overridden */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wake_override</span><span class="p">)</span>
		<span class="n">maccontrol</span> <span class="o">|=</span> <span class="n">MCTL_WAKE</span><span class="p">;</span>

	<span class="cm">/* set AP and INFRA bits for mute if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">mute_override</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maccontrol</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MCTL_AP</span><span class="p">);</span>
		<span class="n">maccontrol</span> <span class="o">|=</span> <span class="n">MCTL_INFRA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">),</span>
		     <span class="n">maccontrol</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* set or clear maccontrol bits */</span>
<span class="kt">void</span> <span class="nf">brcms_b_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">maccontrol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_maccontrol</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* error condition */</span>
	<span class="n">maccontrol</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">maccontrol</span><span class="p">;</span>
	<span class="n">new_maccontrol</span> <span class="o">=</span> <span class="p">(</span><span class="n">maccontrol</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* if the new maccontrol value is the same as the old, nothing to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_maccontrol</span> <span class="o">==</span> <span class="n">maccontrol</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* something changed, cache the new value */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">maccontrol</span> <span class="o">=</span> <span class="n">new_maccontrol</span><span class="p">;</span>

	<span class="cm">/* write the new values with overrides applied */</span>
	<span class="n">brcms_c_mctrl_write</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_ucode_wake_override_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">override_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wake_override</span> <span class="o">||</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">maccontrol</span> <span class="o">&amp;</span> <span class="n">MCTL_WAKE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mboolset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wake_override</span><span class="p">,</span> <span class="n">override_bit</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mboolset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wake_override</span><span class="p">,</span> <span class="n">override_bit</span><span class="p">);</span>

	<span class="n">brcms_c_mctrl_write</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
	<span class="n">brcms_b_wait_for_wake</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_ucode_wake_override_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">override_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mboolclr</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wake_override</span><span class="p">,</span> <span class="n">override_bit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wake_override</span> <span class="o">||</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">maccontrol</span> <span class="o">&amp;</span> <span class="n">MCTL_WAKE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">brcms_c_mctrl_write</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* When driver needs ucode to stop beaconing, it has to make sure that</span>
<span class="cm"> * MCTL_AP is clear and MCTL_INFRA is set</span>
<span class="cm"> * Mode           MCTL_AP        MCTL_INFRA</span>
<span class="cm"> * AP                1              1</span>
<span class="cm"> * STA               0              1 &lt;--- This will ensure no beacons</span>
<span class="cm"> * IBSS              0              0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_ucode_mute_override_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">mute_override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* if maccontrol already has AP == 0 and INFRA == 1 without this</span>
<span class="cm">	 * override, then there is no change to write</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">maccontrol</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MCTL_AP</span> <span class="o">|</span> <span class="n">MCTL_INFRA</span><span class="p">))</span> <span class="o">==</span> <span class="n">MCTL_INFRA</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">brcms_c_mctrl_write</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Clear the override on AP and INFRA bits */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_ucode_mute_override_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">mute_override</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">mute_override</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if maccontrol already has AP == 0 and INFRA == 1 without this</span>
<span class="cm">	 * override, then there is no change to write</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">maccontrol</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MCTL_AP</span> <span class="o">|</span> <span class="n">MCTL_INFRA</span><span class="p">))</span> <span class="o">==</span> <span class="n">MCTL_INFRA</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">brcms_c_mctrl_write</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write a MAC address to the given match reg offset in the RXE match engine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_b_set_addrmatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">match_reg_offset</span><span class="p">,</span>
		       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mac_l</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mac_m</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mac_h</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: brcms_b_set_addrmatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="n">mac_l</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">mac_m</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">mac_h</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* enter the MAC addr into the RXE match registers */</span>
	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">rcm_ctl</span><span class="p">),</span>
		     <span class="n">RCM_INC_DATA</span> <span class="o">|</span> <span class="n">match_reg_offset</span><span class="p">);</span>
	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">rcm_mat_data</span><span class="p">),</span> <span class="n">mac_l</span><span class="p">);</span>
	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">rcm_mat_data</span><span class="p">),</span> <span class="n">mac_m</span><span class="p">);</span>
	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">rcm_mat_data</span><span class="p">),</span> <span class="n">mac_h</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">brcms_b_write_template_ram</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">word</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">word_le</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">word_be</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">be_bit</span><span class="p">;</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tplatewrptr</span><span class="p">),</span> <span class="n">offset</span><span class="p">);</span>

	<span class="cm">/* if MCTL_BIGEND bit set in mac control register,</span>
<span class="cm">	 * the chip swaps data in fifo, as well as data in</span>
<span class="cm">	 * template ram</span>
<span class="cm">	 */</span>
	<span class="n">be_bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">MCTL_BIGEND</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">word_be</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
			<span class="n">word</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">word_be</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">word_le</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
			<span class="n">word</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">word_le</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tplatewrdata</span><span class="p">),</span> <span class="n">word</span><span class="p">);</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_set_cwmin</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">newmin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">CWmin</span> <span class="o">=</span> <span class="n">newmin</span><span class="p">;</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span>
		     <span class="n">OBJADDR_SCR_SEL</span> <span class="o">|</span> <span class="n">S_DOT11_CWMIN</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">),</span> <span class="n">newmin</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_set_cwmax</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">newmax</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">CWmax</span> <span class="o">=</span> <span class="n">newmax</span><span class="p">;</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span>
		     <span class="n">OBJADDR_SCR_SEL</span> <span class="o">|</span> <span class="n">S_DOT11_CWMAX</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">),</span> <span class="n">newmax</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_b_bw_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">fastclk</span><span class="p">;</span>

	<span class="cm">/* request FAST clock if not on */</span>
	<span class="n">fastclk</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">forcefastclk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fastclk</span><span class="p">)</span>
		<span class="n">brcms_b_clkctl_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BCMA_CLKMODE_FAST</span><span class="p">);</span>

	<span class="n">wlc_phy_bw_state_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">bw</span><span class="p">);</span>

	<span class="n">brcms_b_phy_reset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
	<span class="n">wlc_phy_init</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">wlc_phy_chanspec_get</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">));</span>

	<span class="cm">/* restore the clk */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fastclk</span><span class="p">)</span>
		<span class="n">brcms_b_clkctl_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BCMA_CLKMODE_DYNAMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_upd_synthpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="cm">/* update SYNTHPU_DLY */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISLCNPHY</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">SYNTHPU_DLY_LPPHY_US</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISNPHY</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">NREV_GE</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phyrev</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">SYNTHPU_DLY_NPHY_US</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">SYNTHPU_DLY_BPHY_US</span><span class="p">;</span>

	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_SYNTHPU_DLY</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_ucode_txant_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">phyctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phytxant</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">bmac_phytxant</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">PHY_TXC_ANT_MASK</span><span class="p">;</span>

	<span class="cm">/* set the Probe Response frame phy control word */</span>
	<span class="n">phyctl</span> <span class="o">=</span> <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_CTXPRS_BLK</span> <span class="o">+</span> <span class="n">C_CTX_PCTLWD_POS</span><span class="p">);</span>
	<span class="n">phyctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">phyctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">phytxant</span><span class="p">;</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_CTXPRS_BLK</span> <span class="o">+</span> <span class="n">C_CTX_PCTLWD_POS</span><span class="p">,</span> <span class="n">phyctl</span><span class="p">);</span>

	<span class="cm">/* set the Response (ACK/CTS) frame phy control word */</span>
	<span class="n">phyctl</span> <span class="o">=</span> <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_RSP_PCTLWD</span><span class="p">);</span>
	<span class="n">phyctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">phyctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">phytxant</span><span class="p">;</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_RSP_PCTLWD</span><span class="p">,</span> <span class="n">phyctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">brcms_b_ofdm_ratetable_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">plcp_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">plcp_signal_rate_lookup</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">rate</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">signal_rate</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="cm">/* OFDM RATE sub-field of PLCP SIGNAL field, per 802.11 sec 17.3.4.1 */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">plcp_signal_rate_lookup</span> <span class="n">rate_lookup</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">BRCM_RATE_6M</span><span class="p">,</span> <span class="mh">0xB</span><span class="p">},</span>
		<span class="p">{</span><span class="n">BRCM_RATE_9M</span><span class="p">,</span> <span class="mh">0xF</span><span class="p">},</span>
		<span class="p">{</span><span class="n">BRCM_RATE_12M</span><span class="p">,</span> <span class="mh">0xA</span><span class="p">},</span>
		<span class="p">{</span><span class="n">BRCM_RATE_18M</span><span class="p">,</span> <span class="mh">0xE</span><span class="p">},</span>
		<span class="p">{</span><span class="n">BRCM_RATE_24M</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">},</span>
		<span class="p">{</span><span class="n">BRCM_RATE_36M</span><span class="p">,</span> <span class="mh">0xD</span><span class="p">},</span>
		<span class="p">{</span><span class="n">BRCM_RATE_48M</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">},</span>
		<span class="p">{</span><span class="n">BRCM_RATE_54M</span><span class="p">,</span> <span class="mh">0xC</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rate_lookup</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">rate_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">plcp_rate</span> <span class="o">=</span> <span class="n">rate_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">signal_rate</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Find the SHM pointer to the rate table entry by looking in the</span>
<span class="cm">	 * Direct-map Table</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_RT_DIRMAP_A</span> <span class="o">+</span> <span class="p">(</span><span class="n">plcp_rate</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_upd_ofdm_pctl1_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rates</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">BRCM_RATE_6M</span><span class="p">,</span> <span class="n">BRCM_RATE_9M</span><span class="p">,</span> <span class="n">BRCM_RATE_12M</span><span class="p">,</span> <span class="n">BRCM_RATE_18M</span><span class="p">,</span>
		<span class="n">BRCM_RATE_24M</span><span class="p">,</span> <span class="n">BRCM_RATE_36M</span><span class="p">,</span> <span class="n">BRCM_RATE_48M</span><span class="p">,</span> <span class="n">BRCM_RATE_54M</span>
	<span class="p">};</span>
	<span class="n">u16</span> <span class="n">entry_ptr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pctl1</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BRCMS_PHY_11N_CAP</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* walk the phy rate table and update the entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rates</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">entry_ptr</span> <span class="o">=</span> <span class="n">brcms_b_ofdm_ratetable_offset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

		<span class="cm">/* read the SHM Rate Table entry OFDM PCTL1 values */</span>
		<span class="n">pctl1</span> <span class="o">=</span>
		    <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">entry_ptr</span> <span class="o">+</span> <span class="n">M_RT_OFDM_PCTL1_POS</span><span class="p">);</span>

		<span class="cm">/* modify the value */</span>
		<span class="n">pctl1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_TXC1_MODE_MASK</span><span class="p">;</span>
		<span class="n">pctl1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">hw_stf_ss_opmode</span> <span class="o">&lt;&lt;</span> <span class="n">PHY_TXC1_MODE_SHIFT</span><span class="p">);</span>

		<span class="cm">/* Update the SHM Rate Table entry OFDM PCTL1 values */</span>
		<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">entry_ptr</span> <span class="o">+</span> <span class="n">M_RT_OFDM_PCTL1_POS</span><span class="p">,</span>
				   <span class="n">pctl1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* band-specific init */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_bsinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: bandunit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">);</span>

	<span class="n">brcms_c_ucode_bsinit</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>

	<span class="n">wlc_phy_init</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>

	<span class="n">brcms_c_ucode_txant_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * cwmin is band-specific, update hardware</span>
<span class="cm">	 * with value for current band</span>
<span class="cm">	 */</span>
	<span class="n">brcms_b_set_cwmin</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">CWmin</span><span class="p">);</span>
	<span class="n">brcms_b_set_cwmax</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">CWmax</span><span class="p">);</span>

	<span class="n">brcms_b_update_slot_timing</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span>
				   <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span> <span class="o">?</span>
				   <span class="nb">true</span> <span class="o">:</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">shortslot</span><span class="p">);</span>

	<span class="cm">/* write phytype and phyvers */</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_PHYTYPE</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phytype</span><span class="p">);</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_PHYVER</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phyrev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize the txphyctl1 rate table since</span>
<span class="cm">	 * shmem is shared between bands</span>
<span class="cm">	 */</span>
	<span class="n">brcms_upd_ofdm_pctl1_table</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>

	<span class="n">brcms_b_upd_synthpu</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Perform a soft reset of the PHY PLL */</span>
<span class="kt">void</span> <span class="nf">brcms_b_core_phypll_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="n">ai_cc_reg</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chipcregs</span><span class="p">,</span> <span class="n">chipcontrol_addr</span><span class="p">),</span>
		  <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ai_cc_reg</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chipcregs</span><span class="p">,</span> <span class="n">chipcontrol_data</span><span class="p">),</span>
		  <span class="mh">0x4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ai_cc_reg</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chipcregs</span><span class="p">,</span> <span class="n">chipcontrol_data</span><span class="p">),</span>
		  <span class="mh">0x4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ai_cc_reg</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chipcregs</span><span class="p">,</span> <span class="n">chipcontrol_data</span><span class="p">),</span>
		  <span class="mh">0x4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* light way to turn on phy clock without reset for NPHY only</span>
<span class="cm"> *  refer to brcms_b_core_phy_clk for full version</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_b_phyclk_fgc</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* support(necessary for NPHY and HYPHY) only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BRCMS_ISNPHY</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ON</span> <span class="o">==</span> <span class="n">clk</span><span class="p">)</span>
		<span class="n">brcms_b_core_ioctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">SICF_FGC</span><span class="p">,</span> <span class="n">SICF_FGC</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">brcms_b_core_ioctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">SICF_FGC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_b_macphyclk_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ON</span> <span class="o">==</span> <span class="n">clk</span><span class="p">)</span>
		<span class="n">brcms_b_core_ioctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">SICF_MPCLKE</span><span class="p">,</span> <span class="n">SICF_MPCLKE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">brcms_b_core_ioctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">SICF_MPCLKE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_b_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_phy_pub</span> <span class="o">*</span><span class="n">pih</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_bw_clkbits</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">phy_in_reset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pih</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">phy_bw_clkbits</span> <span class="o">=</span> <span class="n">wlc_phy_clk_bwbits</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">);</span>

	<span class="cm">/* Specific reset sequence required for NPHY rev 3 and 4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISNPHY</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">NREV_GE</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phyrev</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">NREV_LE</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phyrev</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Set the PHY bandwidth */</span>
		<span class="n">brcms_b_core_ioctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">SICF_BWMASK</span><span class="p">,</span> <span class="n">phy_bw_clkbits</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Perform a soft reset of the PHY PLL */</span>
		<span class="n">brcms_b_core_phypll_reset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>

		<span class="cm">/* reset the PHY */</span>
		<span class="n">brcms_b_core_ioctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="p">(</span><span class="n">SICF_PRST</span> <span class="o">|</span> <span class="n">SICF_PCLKE</span><span class="p">),</span>
				   <span class="p">(</span><span class="n">SICF_PRST</span> <span class="o">|</span> <span class="n">SICF_PCLKE</span><span class="p">));</span>
		<span class="n">phy_in_reset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">brcms_b_core_ioctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">SICF_PRST</span> <span class="o">|</span> <span class="n">SICF_PCLKE</span> <span class="o">|</span> <span class="n">SICF_BWMASK</span><span class="p">),</span>
				   <span class="p">(</span><span class="n">SICF_PRST</span> <span class="o">|</span> <span class="n">SICF_PCLKE</span> <span class="o">|</span> <span class="n">phy_bw_clkbits</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">brcms_b_core_phy_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pih</span><span class="p">)</span>
		<span class="n">wlc_phy_anacore</span><span class="p">(</span><span class="n">pih</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* switch to and initialize new band */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_setband</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">uint</span> <span class="n">bandunit</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macintmask</span><span class="p">;</span>

	<span class="cm">/* Enable the d11 core before accessing it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcma_core_is_enabled</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bcma_core_enable</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">brcms_c_mctrl_reset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">macintmask</span> <span class="o">=</span> <span class="n">brcms_c_setband_inact</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bandunit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">brcms_b_core_phy_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>

	<span class="cm">/* band-specific initializations */</span>
	<span class="n">brcms_b_bsinit</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there are any pending software interrupt bits,</span>
<span class="cm">	 * then replace these with a harmless nonzero value</span>
<span class="cm">	 * so brcms_c_dpc() will re-enable interrupts when done.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintstatus</span><span class="p">)</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintstatus</span> <span class="o">=</span> <span class="n">MI_DMAINT</span><span class="p">;</span>

	<span class="cm">/* restore macintmask */</span>
	<span class="n">brcms_intrsrestore</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">macintmask</span><span class="p">);</span>

	<span class="cm">/* ucode should still be suspended.. */</span>
	<span class="n">WARN_ON</span><span class="p">((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">))</span> <span class="o">&amp;</span>
		 <span class="n">MCTL_EN_MAC</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_isgoodchip</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* reject unsupported corerev */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CONF_HAS</span><span class="p">(</span><span class="n">D11CONF</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;unsupported core rev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Validate some board info parameters */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_validboardtype</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">boardrev</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardrev</span><span class="p">;</span>

	<span class="cm">/* 4 bits each for board type, major, minor, and tiny version */</span>
	<span class="n">uint</span> <span class="n">brt</span> <span class="o">=</span> <span class="p">(</span><span class="n">boardrev</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">b0</span> <span class="o">=</span> <span class="p">(</span><span class="n">boardrev</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">b1</span> <span class="o">=</span> <span class="p">(</span><span class="n">boardrev</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">boardrev</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="cm">/* voards from other vendors are always considered valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai_get_boardvendor</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* do some boardrev sanity checks when boardvendor is Broadcom */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boardrev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boardrev</span> <span class="o">&lt;=</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">brt</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">brt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">b0</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">b0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">b1</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">b2</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_get_macaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">etheraddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">;</span>

	<span class="cm">/* If macaddr exists, use it (Sromrev4, CIS, ...). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">il0mac</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">etheraddr</span><span class="p">,</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">il0mac</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">etheraddr</span><span class="p">,</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">et1mac</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">etheraddr</span><span class="p">,</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">il0mac</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* power both the pll and external oscillator on/off */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_xtal</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">want</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: want %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">want</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * dont power down if plldown is false or</span>
<span class="cm">	 * we must poll hw radio disable</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">want</span> <span class="o">&amp;&amp;</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">pllreq</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sbclk</span> <span class="o">=</span> <span class="n">want</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sbclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">&amp;&amp;</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">)</span>
			<span class="n">wlc_phy_hw_clk_state_upd</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return true if radio is disabled, otherwise false.</span>
<span class="cm"> * hw radio disable signal is an external pin, users activate it asynchronously</span>
<span class="cm"> * this function could be called when driver is down and w/o clock</span>
<span class="cm"> * it operates on different registers depending on corerev and boardflag.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_b_radio_read_hwdisabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">v</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span> <span class="n">xtal</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xtal</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sbclk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xtal</span><span class="p">)</span>
		<span class="n">brcms_b_xtal</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>

	<span class="cm">/* may need to take core out of reset first */</span>
	<span class="n">clk</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * mac no longer enables phyclk automatically when driver</span>
<span class="cm">		 * accesses phyreg throughput mac. This can be skipped since</span>
<span class="cm">		 * only mac reg is accessed below</span>
<span class="cm">		 */</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">SICF_PCLKE</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * TODO: test suspend/resume</span>
<span class="cm">		 *</span>
<span class="cm">		 * AI chip doesn&#39;t restore bar0win2 on</span>
<span class="cm">		 * hibernation/resume, need sw fixup</span>
<span class="cm">		 */</span>

		<span class="n">bcma_core_enable</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">brcms_c_mctrl_reset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">v</span> <span class="o">=</span> <span class="p">((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
			  <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phydebug</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PDBG_RFD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* put core back into reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clk</span><span class="p">)</span>
		<span class="n">bcma_core_disable</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xtal</span><span class="p">)</span>
		<span class="n">brcms_b_xtal</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">wlc_dma_rxreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">uint</span> <span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">fifo</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">dma_rxreset</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* d11 core reset</span>
<span class="cm"> *   ensure fask clock during reset</span>
<span class="cm"> *   reset dma</span>
<span class="cm"> *   reset d11(out of reset)</span>
<span class="cm"> *   reset phy(out of reset)</span>
<span class="cm"> *   clear software macintstatus for fresh new start</span>
<span class="cm"> * one testing hack wlc_hw-&gt;noreset will bypass the d11/phy reset</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_b_corereset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fastclk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="n">BRCMS_USE_COREFLAGS</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span> <span class="o">?</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">core_flags</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="cm">/* request FAST clock if not on  */</span>
	<span class="n">fastclk</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">forcefastclk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fastclk</span><span class="p">)</span>
		<span class="n">brcms_b_clkctl_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BCMA_CLKMODE_FAST</span><span class="p">);</span>

	<span class="cm">/* reset the dma engines except first time thru */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcma_core_is_enabled</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NFIFO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_txreset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: &quot;</span>
					  <span class="s">&quot;dma_txreset[%d]: cannot stop dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">RX_FIFO</span><span class="p">])</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_dma_rxreset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">RX_FIFO</span><span class="p">)))</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: dma_rxreset&quot;</span>
				  <span class="s">&quot;[%d]: cannot stop dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">RX_FIFO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* if noreset, just stop the psm and return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">noreset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* skip wl_dpc after down */</span>
		<span class="n">brcms_b_mctrl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">MCTL_PSM_RUN</span> <span class="o">|</span> <span class="n">MCTL_EN_MAC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * mac no longer enables phyclk automatically when driver accesses</span>
<span class="cm">	 * phyreg throughput mac, AND phy_reset is skipped at early stage when</span>
<span class="cm">	 * band-&gt;pi is invalid. need to enable PHY CLK</span>
<span class="cm">	 */</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">SICF_PCLKE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * reset the core</span>
<span class="cm">	 * In chips with PMU, the fastclk request goes through d11 core</span>
<span class="cm">	 * reg 0x1e0, which is cleared by the core_reset. have to re-request it.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This adds some delay and we can optimize it by also requesting</span>
<span class="cm">	 * fastclk through chipcommon during this period if necessary. But</span>
<span class="cm">	 * that has to work coordinate with other driver like mips/arm since</span>
<span class="cm">	 * they may touch chipcommon as well.</span>
<span class="cm">	 */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bcma_core_enable</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">&amp;&amp;</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">)</span>
		<span class="n">wlc_phy_hw_clk_state_upd</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">brcms_c_mctrl_reset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ai_get_cccaps</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CC_CAP_PMU</span><span class="p">)</span>
		<span class="n">brcms_b_clkctl_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BCMA_CLKMODE_FAST</span><span class="p">);</span>

	<span class="n">brcms_b_phy_reset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>

	<span class="cm">/* turn on PHY_PLL */</span>
	<span class="n">brcms_b_core_phypll_ctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* clear sw intstatus */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* restore the clk setting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fastclk</span><span class="p">)</span>
		<span class="n">brcms_b_clkctl_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BCMA_CLKMODE_DYNAMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* txfifo sizes needs to be modified(increased) since the newer cores</span>
<span class="cm"> * have more memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_corerev_fifofixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fifo_nu</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txfifo_startblk</span> <span class="o">=</span> <span class="n">TXFIFO_START_BLK</span><span class="p">,</span> <span class="n">txfifo_endblk</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txfifo_def</span><span class="p">,</span> <span class="n">txfifo_def1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txfifo_cmd</span><span class="p">;</span>

	<span class="cm">/* tx fifos start at TXFIFO_START_BLK from the Base address */</span>
	<span class="n">txfifo_startblk</span> <span class="o">=</span> <span class="n">TXFIFO_START_BLK</span><span class="p">;</span>

	<span class="cm">/* sequence of operations:  reset fifo, set fifo size, reset fifo */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">fifo_nu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fifo_nu</span> <span class="o">&lt;</span> <span class="n">NFIFO</span><span class="p">;</span> <span class="n">fifo_nu</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">txfifo_endblk</span> <span class="o">=</span> <span class="n">txfifo_startblk</span> <span class="o">+</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">fifo_nu</span><span class="p">];</span>
		<span class="n">txfifo_def</span> <span class="o">=</span> <span class="p">(</span><span class="n">txfifo_startblk</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(((</span><span class="n">txfifo_endblk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TXFIFO_FIFOTOP_SHIFT</span><span class="p">);</span>
		<span class="n">txfifo_def1</span> <span class="o">=</span> <span class="p">((</span><span class="n">txfifo_startblk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((((</span><span class="n">txfifo_endblk</span> <span class="o">-</span>
			<span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TXFIFO_FIFOTOP_SHIFT</span><span class="p">);</span>
		<span class="n">txfifo_cmd</span> <span class="o">=</span>
		    <span class="n">TXFIFOCMD_RESET_MASK</span> <span class="o">|</span> <span class="p">(</span><span class="n">fifo_nu</span> <span class="o">&lt;&lt;</span> <span class="n">TXFIFOCMD_FIFOSEL_SHIFT</span><span class="p">);</span>

		<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">xmtfifocmd</span><span class="p">),</span> <span class="n">txfifo_cmd</span><span class="p">);</span>
		<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">xmtfifodef</span><span class="p">),</span> <span class="n">txfifo_def</span><span class="p">);</span>
		<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">xmtfifodef1</span><span class="p">),</span> <span class="n">txfifo_def1</span><span class="p">);</span>

		<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">xmtfifocmd</span><span class="p">),</span> <span class="n">txfifo_cmd</span><span class="p">);</span>

		<span class="n">txfifo_startblk</span> <span class="o">+=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">fifo_nu</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * need to propagate to shm location to be in sync since ucode/hw won&#39;t</span>
<span class="cm">	 * do this</span>
<span class="cm">	 */</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_FIFOSIZE0</span><span class="p">,</span>
			   <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">TX_AC_BE_FIFO</span><span class="p">]);</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_FIFOSIZE1</span><span class="p">,</span>
			   <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">TX_AC_VI_FIFO</span><span class="p">]);</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_FIFOSIZE2</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">TX_AC_VO_FIFO</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span>
			    <span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">TX_AC_BK_FIFO</span><span class="p">]));</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_FIFOSIZE3</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">TX_ATIM_FIFO</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span>
			    <span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">TX_BCMC_FIFO</span><span class="p">]));</span>
<span class="p">}</span>

<span class="cm">/* This function is used for changing the tsf frac register</span>
<span class="cm"> * If spur avoidance mode is off, the mac freq will be 80/120/160Mhz</span>
<span class="cm"> * If spur avoidance mode is on1, the mac freq will be 82/123/164Mhz</span>
<span class="cm"> * If spur avoidance mode is on2, the mac freq will be 84/126/168Mhz</span>
<span class="cm"> * HTPHY Formula is 2^26/freq(MHz) e.g.</span>
<span class="cm"> * For spuron2 - 126MHz -&gt; 2^26/126 = 532610.0</span>
<span class="cm"> *  - 532610 = 0x82082 =&gt; tsf_clk_frac_h = 0x8, tsf_clk_frac_l = 0x2082</span>
<span class="cm"> * For spuron: 123MHz -&gt; 2^26/123    = 545600.5</span>
<span class="cm"> *  - 545601 = 0x85341 =&gt; tsf_clk_frac_h = 0x8, tsf_clk_frac_l = 0x5341</span>
<span class="cm"> * For spur off: 120MHz -&gt; 2^26/120    = 559240.5</span>
<span class="cm"> *  - 559241 = 0x88889 =&gt; tsf_clk_frac_h = 0x8, tsf_clk_frac_l = 0x8889</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">brcms_b_switch_macfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">spurmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ai_get_chip_id</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">)</span> <span class="o">==</span> <span class="n">BCM43224_CHIP_ID</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ai_get_chip_id</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">)</span> <span class="o">==</span> <span class="n">BCM43225_CHIP_ID</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spurmode</span> <span class="o">==</span> <span class="n">WL_SPURAVOID_ON2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 126Mhz */</span>
			<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_clk_frac_l</span><span class="p">),</span> <span class="mh">0x2082</span><span class="p">);</span>
			<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_clk_frac_h</span><span class="p">),</span> <span class="mh">0x8</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spurmode</span> <span class="o">==</span> <span class="n">WL_SPURAVOID_ON1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 123Mhz */</span>
			<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_clk_frac_l</span><span class="p">),</span> <span class="mh">0x5341</span><span class="p">);</span>
			<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_clk_frac_h</span><span class="p">),</span> <span class="mh">0x8</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* 120Mhz */</span>
			<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_clk_frac_l</span><span class="p">),</span> <span class="mh">0x8889</span><span class="p">);</span>
			<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_clk_frac_h</span><span class="p">),</span> <span class="mh">0x8</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISLCNPHY</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spurmode</span> <span class="o">==</span> <span class="n">WL_SPURAVOID_ON1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 82Mhz */</span>
			<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_clk_frac_l</span><span class="p">),</span> <span class="mh">0x7CE0</span><span class="p">);</span>
			<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_clk_frac_h</span><span class="p">),</span> <span class="mh">0xC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* 80Mhz */</span>
			<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_clk_frac_l</span><span class="p">),</span> <span class="mh">0xCCCD</span><span class="p">);</span>
			<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_clk_frac_h</span><span class="p">),</span> <span class="mh">0xC</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Initialize GPIOs that are controlled by D11 core */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_gpio_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gc</span><span class="p">,</span> <span class="n">gm</span><span class="p">;</span>

	<span class="cm">/* use GPIO select 0 to get all gpio signals from the gpio out reg */</span>
	<span class="n">brcms_b_mctrl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">MCTL_GPOUT_SEL_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Common GPIO setup:</span>
<span class="cm">	 *      G0 = LED 0 = WLAN Activity</span>
<span class="cm">	 *      G1 = LED 1 = WLAN 2.4 GHz Radio State</span>
<span class="cm">	 *      G2 = LED 2 = WLAN 5 GHz Radio State</span>
<span class="cm">	 *      G4 = radio disable input (HI enabled, LO disabled)</span>
<span class="cm">	 */</span>

	<span class="n">gc</span> <span class="o">=</span> <span class="n">gm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allocate GPIOs for mimo antenna diversity feature */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">antsel_type</span> <span class="o">==</span> <span class="n">ANTSEL_2x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable antenna diversity, use 2x3 mode */</span>
		<span class="n">brcms_b_mhf</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">MHF3</span><span class="p">,</span> <span class="n">MHF3_ANTSEL_EN</span><span class="p">,</span>
			     <span class="n">MHF3_ANTSEL_EN</span><span class="p">,</span> <span class="n">BRCM_BAND_ALL</span><span class="p">);</span>
		<span class="n">brcms_b_mhf</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">MHF3</span><span class="p">,</span> <span class="n">MHF3_ANTSEL_MODE</span><span class="p">,</span>
			     <span class="n">MHF3_ANTSEL_MODE</span><span class="p">,</span> <span class="n">BRCM_BAND_ALL</span><span class="p">);</span>

		<span class="cm">/* init superswitch control */</span>
		<span class="n">wlc_phy_antsel_init</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">antsel_type</span> <span class="o">==</span> <span class="n">ANTSEL_2x4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gm</span> <span class="o">|=</span> <span class="n">gc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BOARD_GPIO_12</span> <span class="o">|</span> <span class="n">BOARD_GPIO_13</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * The board itself is powered by these GPIOs</span>
<span class="cm">		 * (when not sending pattern) so set them high</span>
<span class="cm">		 */</span>
		<span class="n">bcma_set16</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">psm_gpio_oe</span><span class="p">),</span>
			   <span class="p">(</span><span class="n">BOARD_GPIO_12</span> <span class="o">|</span> <span class="n">BOARD_GPIO_13</span><span class="p">));</span>
		<span class="n">bcma_set16</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">psm_gpio_out</span><span class="p">),</span>
			   <span class="p">(</span><span class="n">BOARD_GPIO_12</span> <span class="o">|</span> <span class="n">BOARD_GPIO_13</span><span class="p">));</span>

		<span class="cm">/* Enable antenna diversity, use 2x4 mode */</span>
		<span class="n">brcms_b_mhf</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">MHF3</span><span class="p">,</span> <span class="n">MHF3_ANTSEL_EN</span><span class="p">,</span>
			     <span class="n">MHF3_ANTSEL_EN</span><span class="p">,</span> <span class="n">BRCM_BAND_ALL</span><span class="p">);</span>
		<span class="n">brcms_b_mhf</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">MHF3</span><span class="p">,</span> <span class="n">MHF3_ANTSEL_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">BRCM_BAND_ALL</span><span class="p">);</span>

		<span class="cm">/* Configure the desired clock to be 4Mhz */</span>
		<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_ANTSEL_CLKDIV</span><span class="p">,</span>
				   <span class="n">ANTSEL_CLKDIV_4MHZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * gpio 9 controls the PA. ucode is responsible</span>
<span class="cm">	 * for wiggling out and oe</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardflags</span> <span class="o">&amp;</span> <span class="n">BFL_PACTRL</span><span class="p">)</span>
		<span class="n">gm</span> <span class="o">|=</span> <span class="n">gc</span> <span class="o">|=</span> <span class="n">BOARD_GPIO_PACTRL</span><span class="p">;</span>

	<span class="cm">/* apply to gpiocontrol register */</span>
	<span class="n">bcma_chipco_gpio_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">drv_cc</span><span class="p">,</span> <span class="n">gm</span><span class="p">,</span> <span class="n">gc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_ucode_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span>
			      <span class="k">const</span> <span class="n">__le32</span> <span class="n">ucode</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span>
		     <span class="n">OBJADDR_AUTO_INC</span> <span class="o">|</span> <span class="n">OBJADDR_UCM_SEL</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ucode</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_ucode_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_ucode</span> <span class="o">*</span><span class="n">ucode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ucode</span><span class="p">;</span>

	<span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">ucode_loaded</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">D11REV_IS</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">23</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISNPHY</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brcms_ucode_write</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">ucode</span><span class="o">-&gt;</span><span class="n">bcm43xx_16_mimo</span><span class="p">,</span>
					  <span class="n">ucode</span><span class="o">-&gt;</span><span class="n">bcm43xx_16_mimosz</span><span class="p">);</span>
			<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">ucode_loaded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: wl%d: unsupported phy in &quot;</span>
				  <span class="s">&quot;corerev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">D11REV_IS</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISLCNPHY</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">brcms_ucode_write</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">ucode</span><span class="o">-&gt;</span><span class="n">bcm43xx_24_lcn</span><span class="p">,</span>
					  <span class="n">ucode</span><span class="o">-&gt;</span><span class="n">bcm43xx_24_lcnsz</span><span class="p">);</span>
			<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">ucode_loaded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: wl%d: unsupported phy in &quot;</span>
				  <span class="s">&quot;corerev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_b_txant_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">phytxant</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* update sw state */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">bmac_phytxant</span> <span class="o">=</span> <span class="n">phytxant</span><span class="p">;</span>

	<span class="cm">/* push to ucode if up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">brcms_c_ucode_txant_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>

<span class="p">}</span>

<span class="n">u16</span> <span class="nf">brcms_b_get_txant</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txant</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_b_antsel_type_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">antsel_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">antsel_type</span> <span class="o">=</span> <span class="n">antsel_type</span><span class="p">;</span>

	<span class="cm">/* Update the antsel type for phy module to use */</span>
	<span class="n">wlc_phy_antsel_type_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">antsel_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_fifoerrors</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">fatal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">unit</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">intstatus</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="n">unit</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">NFIFO</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read intstatus register and ignore any non-error bits */</span>
		<span class="n">intstatus</span> <span class="o">=</span>
			<span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span>
				    <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">intctrlregs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">intstatus</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="n">I_ERRORS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intstatus</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: intstatus%d 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">unit</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">intstatus</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span> <span class="o">&amp;</span> <span class="n">I_RO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: fifo %d: receive fifo &quot;</span>
				  <span class="s">&quot;overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">fatal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span> <span class="o">&amp;</span> <span class="n">I_PC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: fifo %d: descriptor error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">unit</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">fatal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span> <span class="o">&amp;</span> <span class="n">I_PD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: fifo %d: data error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span>
				  <span class="n">idx</span><span class="p">);</span>
			<span class="n">fatal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span> <span class="o">&amp;</span> <span class="n">I_DE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: fifo %d: descriptor protocol &quot;</span>
				  <span class="s">&quot;error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">fatal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span> <span class="o">&amp;</span> <span class="n">I_RU</span><span class="p">)</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: fifo %d: receive descriptor &quot;</span>
				  <span class="s">&quot;underflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intstatus</span> <span class="o">&amp;</span> <span class="n">I_XU</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: fifo %d: transmit fifo &quot;</span>
				  <span class="s">&quot;underflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
			<span class="n">fatal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fatal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcms_fatal_error</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span> <span class="cm">/* big hammer */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span>
				     <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">intctrlregs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">intstatus</span><span class="p">),</span>
				     <span class="n">intstatus</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_intrson</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintmask</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">defmacintmask</span><span class="p">;</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintmask</span><span class="p">),</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintmask</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">brcms_c_intrsoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macintmask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">macintmask</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintmask</span><span class="p">;</span>	<span class="cm">/* isr can still happen */</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintmask</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintmask</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>		<span class="cm">/* ensure int line is no longer driven */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* return previous macintmask; resolve race between us and our isr */</span>
	<span class="k">return</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintstatus</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">macintmask</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_intrsrestore</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">macintmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintmask</span> <span class="o">=</span> <span class="n">macintmask</span><span class="p">;</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintmask</span><span class="p">),</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintmask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* assumes that the d11 MAC is enabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_tx_fifo_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span>
				    <span class="n">uint</span> <span class="n">tx_fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">fifo</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tx_fifo</span><span class="p">;</span>

	<span class="cm">/* Two clients of this code, 11h Quiet period and scanning. */</span>

	<span class="cm">/* only suspend if not already suspended */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">suspended_fifos</span> <span class="o">&amp;</span> <span class="n">fifo</span><span class="p">)</span> <span class="o">==</span> <span class="n">fifo</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* force the core awake only if not already */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">suspended_fifos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">brcms_c_ucode_wake_override_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span>
						<span class="n">BRCMS_WAKE_OVERRIDE_TXFIFO</span><span class="p">);</span>

	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">suspended_fifos</span> <span class="o">|=</span> <span class="n">fifo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">tx_fifo</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Suspending AMPDU transmissions in the middle can cause</span>
<span class="cm">		 * underflow which may result in mismatch between ucode and</span>
<span class="cm">		 * driver so suspend the mac before suspending the FIFO</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_PHY_11N_CAP</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span>
			<span class="n">brcms_c_suspend_mac_and_wait</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>

		<span class="n">dma_txsuspend</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">tx_fifo</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_PHY_11N_CAP</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span>
			<span class="n">brcms_c_enable_mac</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_tx_fifo_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span>
				   <span class="n">uint</span> <span class="n">tx_fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* BMAC_NOTE: BRCMS_TX_FIFO_ENAB is done in brcms_c_dpc() for DMA case</span>
<span class="cm">	 * but need to be done here for PIO otherwise the watchdog will catch</span>
<span class="cm">	 * the inconsistency and fire</span>
<span class="cm">	 */</span>
	<span class="cm">/* Two clients of this code, 11h Quiet period and scanning. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">tx_fifo</span><span class="p">])</span>
		<span class="n">dma_txresume</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">tx_fifo</span><span class="p">]);</span>

	<span class="cm">/* allow core to sleep again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">suspended_fifos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">suspended_fifos</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tx_fifo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">suspended_fifos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">brcms_c_ucode_wake_override_clear</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span>
						<span class="n">BRCMS_WAKE_OVERRIDE_TXFIFO</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* precondition: requires the mac core to be enabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mute_tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">null_ether_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mute_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* suspend tx fifos */</span>
		<span class="n">brcms_b_tx_fifo_suspend</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">TX_DATA_FIFO</span><span class="p">);</span>
		<span class="n">brcms_b_tx_fifo_suspend</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">TX_CTL_FIFO</span><span class="p">);</span>
		<span class="n">brcms_b_tx_fifo_suspend</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">TX_AC_BK_FIFO</span><span class="p">);</span>
		<span class="n">brcms_b_tx_fifo_suspend</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">TX_AC_VI_FIFO</span><span class="p">);</span>

		<span class="cm">/* zero the address match register so we do not send ACKs */</span>
		<span class="n">brcms_b_set_addrmatch</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">RCM_MAC_OFFSET</span><span class="p">,</span>
				       <span class="n">null_ether_addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* resume tx fifos */</span>
		<span class="n">brcms_b_tx_fifo_resume</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">TX_DATA_FIFO</span><span class="p">);</span>
		<span class="n">brcms_b_tx_fifo_resume</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">TX_CTL_FIFO</span><span class="p">);</span>
		<span class="n">brcms_b_tx_fifo_resume</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">TX_AC_BK_FIFO</span><span class="p">);</span>
		<span class="n">brcms_b_tx_fifo_resume</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">TX_AC_VI_FIFO</span><span class="p">);</span>

		<span class="cm">/* Restore address */</span>
		<span class="n">brcms_b_set_addrmatch</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">RCM_MAC_OFFSET</span><span class="p">,</span>
				       <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">etheraddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wlc_phy_mute_upd</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">mute_tx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mute_tx</span><span class="p">)</span>
		<span class="n">brcms_c_ucode_mute_override_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">brcms_c_ucode_mute_override_clear</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">brcms_c_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mute_tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">brcms_b_mute</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">mute_tx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read and clear macintmask and macintstatus and intstatus registers.</span>
<span class="cm"> * This routine should be called with interrupts off</span>
<span class="cm"> * Return:</span>
<span class="cm"> *   -1 if brcms_deviceremoved(wlc) evaluates to true;</span>
<span class="cm"> *   0 if the interrupt is not for us, or we are in some special cases;</span>
<span class="cm"> *   device interrupt status bits otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">wlc_intstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">in_isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macintstatus</span><span class="p">;</span>

	<span class="cm">/* macintstatus includes a DMA interrupt summary bit */</span>
	<span class="n">macintstatus</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintstatus</span><span class="p">));</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: macintstatus: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
		 <span class="n">macintstatus</span><span class="p">);</span>

	<span class="cm">/* detect cardbus removed, in power down(suspend) and in reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcms_deviceremoved</span><span class="p">(</span><span class="n">wlc</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* brcms_deviceremoved() succeeds even when the core is still resetting,</span>
<span class="cm">	 * handle that case here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* defer unsolicited interrupts */</span>
	<span class="n">macintstatus</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">in_isr</span> <span class="o">?</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintmask</span> <span class="o">:</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">defmacintmask</span><span class="p">);</span>

	<span class="cm">/* if not for us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* interrupts are already turned off for CFE build</span>
<span class="cm">	 * Caution: For CFE Turning off the interrupts again has some undesired</span>
<span class="cm">	 * consequences</span>
<span class="cm">	 */</span>
	<span class="cm">/* turn off the interrupts */</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintmask</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintmask</span><span class="p">));</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* clear device interrupts */</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintstatus</span><span class="p">),</span> <span class="n">macintstatus</span><span class="p">);</span>

	<span class="cm">/* MI_DMAINT is indication of non-zero intstatus */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">&amp;</span> <span class="n">MI_DMAINT</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * only fifo interrupt enabled is I_RI in</span>
<span class="cm">		 * RX_FIFO. If MI_DMAINT is set, assume it</span>
<span class="cm">		 * is set and clear the interrupt.</span>
<span class="cm">		 */</span>
		<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">intctrlregs</span><span class="p">[</span><span class="n">RX_FIFO</span><span class="p">].</span><span class="n">intstatus</span><span class="p">),</span>
			     <span class="n">DEF_RXINTMASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">macintstatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Update wlc-&gt;macintstatus and wlc-&gt;intstatus[]. */</span>
<span class="cm">/* Return true if they are updated successfully. false otherwise */</span>
<span class="n">bool</span> <span class="nf">brcms_c_intrsupd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">macintstatus</span><span class="p">;</span>

	<span class="cm">/* read and clear macintstatus and intstatus registers */</span>
	<span class="n">macintstatus</span> <span class="o">=</span> <span class="n">wlc_intstatus</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* device is removed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* update interrupt status in software */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintstatus</span> <span class="o">|=</span> <span class="n">macintstatus</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * First-level interrupt processing.</span>
<span class="cm"> * Return true if this was our interrupt, false otherwise.</span>
<span class="cm"> * *wantdpc will be set to true if further brcms_c_dpc() processing is required,</span>
<span class="cm"> * false otherwise.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">brcms_c_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">wantdpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macintstatus</span><span class="p">;</span>

	<span class="o">*</span><span class="n">wantdpc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">||</span> <span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintmask</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* read and clear macintstatus and intstatus registers */</span>
	<span class="n">macintstatus</span> <span class="o">=</span> <span class="n">wlc_intstatus</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;DEVICEREMOVED detected in the ISR code&quot;</span>
			  <span class="s">&quot; path</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* it is not for us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="o">*</span><span class="n">wantdpc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* save interrupt status bits */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintstatus</span> <span class="o">=</span> <span class="n">macintstatus</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_suspend_mac_and_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mc</span><span class="p">,</span> <span class="n">mi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: bandunit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Track overlapping suspend requests</span>
<span class="cm">	 */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">mac_suspend_depth</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">mac_suspend_depth</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* force the core awake */</span>
	<span class="n">brcms_c_ucode_wake_override_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BRCMS_WAKE_OVERRIDE_MACSUSPEND</span><span class="p">);</span>

	<span class="n">mc</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mc</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: dead chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="n">brcms_down</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">MCTL_PSM_JMP_0</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">MCTL_PSM_RUN</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">MCTL_EN_MAC</span><span class="p">));</span>

	<span class="n">mi</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintstatus</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mi</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: dead chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="n">brcms_down</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mi</span> <span class="o">&amp;</span> <span class="n">MI_MACSSPNDD</span><span class="p">);</span>

	<span class="n">brcms_b_mctrl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">MCTL_EN_MAC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">SPINWAIT</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintstatus</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">MI_MACSSPNDD</span><span class="p">),</span>
		 <span class="n">BRCMS_MAX_MAC_SUSPEND</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintstatus</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">MI_MACSSPNDD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: wlc_suspend_mac_and_wait: waited %d uS&quot;</span>
			  <span class="s">&quot; and MI_MACSSPNDD is still not on.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">BRCMS_MAX_MAC_SUSPEND</span><span class="p">);</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: psmdebug 0x%08x, phydebug 0x%08x, &quot;</span>
			  <span class="s">&quot;psm_brc 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
			  <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">psmdebug</span><span class="p">)),</span>
			  <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">phydebug</span><span class="p">)),</span>
			  <span class="n">bcma_read16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">psm_brc</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="n">mc</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: dead chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="n">brcms_down</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">MCTL_PSM_JMP_0</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">MCTL_PSM_RUN</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">MCTL_EN_MAC</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_enable_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mc</span><span class="p">,</span> <span class="n">mi</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: bandunit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Track overlapping suspend requests</span>
<span class="cm">	 */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">mac_suspend_depth</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">mac_suspend_depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mc</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">MCTL_PSM_JMP_0</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">MCTL_EN_MAC</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">MCTL_PSM_RUN</span><span class="p">));</span>

	<span class="n">brcms_b_mctrl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">MCTL_EN_MAC</span><span class="p">,</span> <span class="n">MCTL_EN_MAC</span><span class="p">);</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintstatus</span><span class="p">),</span> <span class="n">MI_MACSSPNDD</span><span class="p">);</span>

	<span class="n">mc</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">MCTL_PSM_JMP_0</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">MCTL_EN_MAC</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">MCTL_PSM_RUN</span><span class="p">));</span>

	<span class="n">mi</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintstatus</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mi</span> <span class="o">&amp;</span> <span class="n">MI_MACSSPNDD</span><span class="p">);</span>

	<span class="n">brcms_c_ucode_wake_override_clear</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span>
					  <span class="n">BRCMS_WAKE_OVERRIDE_MACSUSPEND</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_b_band_stf_ss_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">stf_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">hw_stf_ss_opmode</span> <span class="o">=</span> <span class="n">stf_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span>
		<span class="n">brcms_upd_ofdm_pctl1_table</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_b_validate_chip_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">w</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="cm">/* Validate dchip register access */</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span> <span class="n">OBJADDR_SHM_SEL</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">));</span>

	<span class="cm">/* Can we write and read back a 32bit register? */</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span> <span class="n">OBJADDR_SHM_SEL</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0xaa5555aa</span><span class="p">);</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span> <span class="n">OBJADDR_SHM_SEL</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0xaa5555aa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: validate_chip_access: SHM = 0x%x, &quot;</span>
			  <span class="s">&quot;expected 0xaa5555aa</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span> <span class="n">OBJADDR_SHM_SEL</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0x55aaaa55</span><span class="p">);</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span> <span class="n">OBJADDR_SHM_SEL</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0x55aaaa55</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: validate_chip_access: SHM = 0x%x, &quot;</span>
			  <span class="s">&quot;expected 0x55aaaa55</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span> <span class="n">OBJADDR_SHM_SEL</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">),</span> <span class="n">w</span><span class="p">);</span>

	<span class="cm">/* clear CFPStart */</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_cfpstart</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">w</span> <span class="o">!=</span> <span class="p">(</span><span class="n">MCTL_IHR_EN</span> <span class="o">|</span> <span class="n">MCTL_WAKE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="p">(</span><span class="n">MCTL_IHR_EN</span> <span class="o">|</span> <span class="n">MCTL_GMODE</span> <span class="o">|</span> <span class="n">MCTL_WAKE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: validate_chip_access: maccontrol = &quot;</span>
			  <span class="s">&quot;0x%x, expected 0x%x or 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">MCTL_IHR_EN</span> <span class="o">|</span> <span class="n">MCTL_WAKE</span><span class="p">),</span>
			  <span class="p">(</span><span class="n">MCTL_IHR_EN</span> <span class="o">|</span> <span class="n">MCTL_GMODE</span> <span class="o">|</span> <span class="n">MCTL_WAKE</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PHYPLL_WAIT_US	100000</span>

<span class="kt">void</span> <span class="nf">brcms_b_core_phypll_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ai_get_chip_id</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">)</span> <span class="o">==</span> <span class="n">BCM4313_CHIP_ID</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bcma_set32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">clk_ctl_st</span><span class="p">),</span>
				   <span class="n">CCS_ERSRC_REQ_HT</span> <span class="o">|</span>
				   <span class="n">CCS_ERSRC_REQ_D11PLL</span> <span class="o">|</span>
				   <span class="n">CCS_ERSRC_REQ_PHYPLL</span><span class="p">);</span>
			<span class="n">SPINWAIT</span><span class="p">((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">clk_ctl_st</span><span class="p">))</span> <span class="o">&amp;</span>
				  <span class="n">CCS_ERSRC_AVAIL_HT</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CCS_ERSRC_AVAIL_HT</span><span class="p">,</span>
				 <span class="n">PHYPLL_WAIT_US</span><span class="p">);</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">clk_ctl_st</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">CCS_ERSRC_AVAIL_HT</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CCS_ERSRC_AVAIL_HT</span><span class="p">)</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: turn on PHY&quot;</span>
					  <span class="s">&quot; PLL failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bcma_set32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">clk_ctl_st</span><span class="p">),</span>
				   <span class="n">tmp</span> <span class="o">|</span> <span class="n">CCS_ERSRC_REQ_D11PLL</span> <span class="o">|</span>
				   <span class="n">CCS_ERSRC_REQ_PHYPLL</span><span class="p">);</span>
			<span class="n">SPINWAIT</span><span class="p">((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">clk_ctl_st</span><span class="p">))</span> <span class="o">&amp;</span>
				  <span class="p">(</span><span class="n">CCS_ERSRC_AVAIL_D11PLL</span> <span class="o">|</span>
				   <span class="n">CCS_ERSRC_AVAIL_PHYPLL</span><span class="p">))</span> <span class="o">!=</span>
				 <span class="p">(</span><span class="n">CCS_ERSRC_AVAIL_D11PLL</span> <span class="o">|</span>
				  <span class="n">CCS_ERSRC_AVAIL_PHYPLL</span><span class="p">),</span> <span class="n">PHYPLL_WAIT_US</span><span class="p">);</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">clk_ctl_st</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span>
			     <span class="p">(</span><span class="n">CCS_ERSRC_AVAIL_D11PLL</span> <span class="o">|</span> <span class="n">CCS_ERSRC_AVAIL_PHYPLL</span><span class="p">))</span>
			    <span class="o">!=</span>
			    <span class="p">(</span><span class="n">CCS_ERSRC_AVAIL_D11PLL</span> <span class="o">|</span> <span class="n">CCS_ERSRC_AVAIL_PHYPLL</span><span class="p">))</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: turn on &quot;</span>
					  <span class="s">&quot;PHY PLL failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Since the PLL may be shared, other cores can still</span>
<span class="cm">		 * be requesting it; so we&#39;ll deassert the request but</span>
<span class="cm">		 * not wait for status to comply.</span>
<span class="cm">		 */</span>
		<span class="n">bcma_mask32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">clk_ctl_st</span><span class="p">),</span>
			    <span class="o">~</span><span class="n">CCS_ERSRC_REQ_PHYPLL</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">clk_ctl_st</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_coredisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">dev_gone</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="n">dev_gone</span> <span class="o">=</span> <span class="n">brcms_deviceremoved</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_gone</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">noreset</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* radio off */</span>
	<span class="n">wlc_phy_switch_radio</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

	<span class="cm">/* turn off analog core */</span>
	<span class="n">wlc_phy_anacore</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

	<span class="cm">/* turn off PHYPLL to save power */</span>
	<span class="n">brcms_b_core_phypll_ctl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bcma_core_disable</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wlc_phy_hw_clk_state_upd</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_flushqueues</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* free any posted tx packets */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NFIFO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dma_txreclaim</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">DMA_RANGE_ALL</span><span class="p">);</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">txpktpend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;pktpend fifo %d clrd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="cm">/* free any posted rx packets */</span>
	<span class="n">dma_rxreclaim</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">RX_FIFO</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span>
<span class="nf">brcms_b_read_objmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">uint</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">objoff</span> <span class="o">=</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">);</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span> <span class="n">sel</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">objoff</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bcma_read16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">objoff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_b_write_objmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">uint</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">v</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">objoff</span> <span class="o">=</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">);</span>

	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span> <span class="n">sel</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">objoff</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">objoff</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read a single u16 from shared memory.</span>
<span class="cm"> * SHM &#39;offset&#39; needs to be an even address</span>
<span class="cm"> */</span>
<span class="n">u16</span> <span class="nf">brcms_b_read_shm</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">uint</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">brcms_b_read_objmem</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">OBJADDR_SHM_SEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write a single u16 to shared memory.</span>
<span class="cm"> * SHM &#39;offset&#39; needs to be an even address</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_b_write_shm</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">uint</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">brcms_b_write_objmem</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">OBJADDR_SHM_SEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy a buffer to shared memory of specified type .</span>
<span class="cm"> * SHM &#39;offset&#39; needs to be an even address and</span>
<span class="cm"> * Buffer length &#39;len&#39; must be an even number of bytes</span>
<span class="cm"> * &#39;sel&#39; selects the type of memory</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">brcms_b_copyto_objmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">uint</span> <span class="n">offset</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">brcms_b_write_objmem</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy a piece of shared memory of specified type to a buffer .</span>
<span class="cm"> * SHM &#39;offset&#39; needs to be an even address and</span>
<span class="cm"> * Buffer length &#39;len&#39; must be an even number of bytes</span>
<span class="cm"> * &#39;sel&#39; selects the type of memory</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">brcms_b_copyfrom_objmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">uint</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">brcms_b_read_objmem</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
		<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Copy a buffer to shared memory.</span>
<span class="cm"> * SHM &#39;offset&#39; needs to be an even address and</span>
<span class="cm"> * Buffer length &#39;len&#39; must be an even number of bytes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_copyto_shm</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">uint</span> <span class="n">offset</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">brcms_b_copyto_objmem</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">OBJADDR_SHM_SEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_retrylimit_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">SRL</span><span class="p">,</span> <span class="n">u16</span> <span class="n">LRL</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">SRL</span> <span class="o">=</span> <span class="n">SRL</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">LRL</span> <span class="o">=</span> <span class="n">LRL</span><span class="p">;</span>

	<span class="cm">/* write retry limit to SCR, shouldn&#39;t need to suspend */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcma_write32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span>
			     <span class="n">OBJADDR_SCR_SEL</span> <span class="o">|</span> <span class="n">S_DOT11_SRC_LMT</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
		<span class="n">bcma_write32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">),</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">SRL</span><span class="p">);</span>
		<span class="n">bcma_write32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span>
			     <span class="n">OBJADDR_SCR_SEL</span> <span class="o">|</span> <span class="n">S_DOT11_LRC_LMT</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
		<span class="n">bcma_write32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">),</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">LRL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_pllreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set</span><span class="p">,</span> <span class="n">u32</span> <span class="n">req_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mboolisset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">pllreq</span><span class="p">,</span> <span class="n">req_bit</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">mboolset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">pllreq</span><span class="p">,</span> <span class="n">req_bit</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mboolisset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">pllreq</span><span class="p">,</span> <span class="n">BRCMS_PLLREQ_FLIP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sbclk</span><span class="p">)</span>
				<span class="n">brcms_b_xtal</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mboolisset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">pllreq</span><span class="p">,</span> <span class="n">req_bit</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">mboolclr</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">pllreq</span><span class="p">,</span> <span class="n">req_bit</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mboolisset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">pllreq</span><span class="p">,</span> <span class="n">BRCMS_PLLREQ_FLIP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sbclk</span><span class="p">)</span>
				<span class="n">brcms_b_xtal</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_antsel_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">antsel_avail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">antsel_avail</span> <span class="o">=</span> <span class="n">antsel_avail</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * conditions under which the PM bit should be set in outgoing frames</span>
<span class="cm"> * and STAY_AWAKE is meaningful</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_ps_allowed</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_bss_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="p">;</span>

	<span class="cm">/* disallow PS when one of the following global conditions meets */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">associated</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* disallow PS when one of these meets when not scanning */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">associated</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * disallow PS when one of the following</span>
<span class="cm">		 * bsscfg specific conditions meets</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">BSS</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_statsupd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">macstat</span> <span class="n">macstats</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">u16</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rxf0ovfl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txfunfl</span><span class="p">[</span><span class="n">NFIFO</span><span class="p">];</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

	<span class="cm">/* if driver down, make no sense to update stats */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="cm">/* save last rx fifo 0 overflow count */</span>
	<span class="n">rxf0ovfl</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">macstat_snapshot</span><span class="o">-&gt;</span><span class="n">rxf0ovfl</span><span class="p">;</span>

	<span class="cm">/* save last tx fifo  underflow count */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NFIFO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txfunfl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">macstat_snapshot</span><span class="o">-&gt;</span><span class="n">txfunfl</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

	<span class="cm">/* Read mac stats from contiguous shared memory */</span>
	<span class="n">brcms_b_copyfrom_objmem</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_UCODE_MACSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">macstats</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">macstat</span><span class="p">),</span> <span class="n">OBJADDR_SHM_SEL</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="cm">/* check for rx fifo 0 overflow */</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">macstat_snapshot</span><span class="o">-&gt;</span><span class="n">rxf0ovfl</span> <span class="o">-</span> <span class="n">rxf0ovfl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %u rx fifo 0 overflows!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>

	<span class="cm">/* check for tx fifo underflows */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NFIFO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delta</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">macstat_snapshot</span><span class="o">-&gt;</span><span class="n">txfunfl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span>
			      <span class="n">txfunfl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span><span class="p">)</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %u tx fifo %d underflows!&quot;</span>
				  <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

	<span class="cm">/* merge counters from dma module */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NFIFO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">dma_counterreset</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="cm">/* reset the core */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_deviceremoved</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">))</span>
		<span class="n">brcms_b_corereset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BRCMS_USE_COREFLAGS</span><span class="p">);</span>

	<span class="cm">/* purge the dma rings */</span>
	<span class="n">brcms_c_flushqueues</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="cm">/* slurp up hw mac counters before core reset */</span>
	<span class="n">brcms_c_statsupd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* reset our snapshot of macstat counters */</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">macstat_snapshot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">macstat</span><span class="p">));</span>

	<span class="n">brcms_b_reset</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Return the channel the driver should initialize during brcms_c_init.</span>
<span class="cm"> * the channel may have to be changed from the currently configured channel</span>
<span class="cm"> * if other configurations are in conflict (bandlocked, 11n mode disabled,</span>
<span class="cm"> * invalid channel for current country, etc.)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">brcms_c_init_chanspec</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">chanspec</span> <span class="o">=</span>
	    <span class="mi">1</span> <span class="o">|</span> <span class="n">WL_CHANSPEC_BW_20</span> <span class="o">|</span> <span class="n">WL_CHANSPEC_CTL_SB_NONE</span> <span class="o">|</span>
	    <span class="n">WL_CHANSPEC_BAND_2G</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">chanspec</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_init_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span><span class="p">));</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SCB_WMECAP</span> <span class="o">|</span> <span class="n">SCB_HTCAP</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMPRIO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">seqnum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">seqctl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">seqctl_nonqos</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">SCB_MAGIC</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* d11 core init</span>
<span class="cm"> *   reset PSM</span>
<span class="cm"> *   download ucode/PCM</span>
<span class="cm"> *   let ucode run to suspended</span>
<span class="cm"> *   download ucode inits</span>
<span class="cm"> *   config other core registers</span>
<span class="cm"> *   init dma</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_coreinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sflags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bcnint_us</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fifosz_fixup</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="n">NFIFO</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_ucode</span> <span class="o">*</span><span class="n">ucode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ucode</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="cm">/* reset PSM */</span>
	<span class="n">brcms_b_mctrl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">MCTL_IHR_EN</span> <span class="o">|</span> <span class="n">MCTL_PSM_JMP_0</span> <span class="o">|</span> <span class="n">MCTL_WAKE</span><span class="p">));</span>

	<span class="n">brcms_ucode_download</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIFOSZ fixup. driver wants to controls the fifo allocation.</span>
<span class="cm">	 */</span>
	<span class="n">fifosz_fixup</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* let the PSM run to the suspended state, set mode to BSS STA */</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintstatus</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">brcms_b_mctrl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">MCTL_IHR_EN</span> <span class="o">|</span> <span class="n">MCTL_INFRA</span> <span class="o">|</span> <span class="n">MCTL_PSM_RUN</span> <span class="o">|</span> <span class="n">MCTL_WAKE</span><span class="p">));</span>

	<span class="cm">/* wait for ucode to self-suspend after auto-init */</span>
	<span class="n">SPINWAIT</span><span class="p">(((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintstatus</span><span class="p">))</span> <span class="o">&amp;</span>
		   <span class="n">MI_MACSSPNDD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintstatus</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">MI_MACSSPNDD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: wlc_coreinit: ucode did not self-&quot;</span>
			  <span class="s">&quot;suspend!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="n">brcms_c_gpio_init</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="n">sflags</span> <span class="o">=</span> <span class="n">bcma_aread32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">BCMA_IOST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">D11REV_IS</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">23</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISNPHY</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span>
			<span class="n">brcms_c_write_inits</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">ucode</span><span class="o">-&gt;</span><span class="n">d11n0initvals16</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: wl%d: unsupported phy in corerev&quot;</span>
				  <span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
				  <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">D11REV_IS</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISLCNPHY</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span>
			<span class="n">brcms_c_write_inits</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">ucode</span><span class="o">-&gt;</span><span class="n">d11lcn0initvals24</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: wl%d: unsupported phy in corerev&quot;</span>
				  <span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
				  <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: wl%d: unsupported corerev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* For old ucode, txfifo sizes needs to be modified(increased) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifosz_fixup</span><span class="p">)</span>
		<span class="n">brcms_b_corerev_fifofixup</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>

	<span class="cm">/* check txfifo allocations match between ucode and driver */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">TX_AC_BE_FIFO</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_FIFOSIZE0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">TX_AC_BE_FIFO</span><span class="p">]</span> <span class="o">!=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">TX_AC_BE_FIFO</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">TX_AC_BE_FIFO</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">TX_AC_VI_FIFO</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_FIFOSIZE1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">TX_AC_VI_FIFO</span><span class="p">]</span> <span class="o">!=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">TX_AC_VI_FIFO</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">TX_AC_VI_FIFO</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">TX_AC_BK_FIFO</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_FIFOSIZE2</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">TX_AC_VO_FIFO</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">TX_AC_BK_FIFO</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">TX_AC_BK_FIFO</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">TX_AC_BK_FIFO</span><span class="p">]</span> <span class="o">!=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">TX_AC_BK_FIFO</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">TX_AC_BK_FIFO</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">TX_AC_VO_FIFO</span><span class="p">]</span> <span class="o">!=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">TX_AC_VO_FIFO</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">TX_AC_VO_FIFO</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">TX_BCMC_FIFO</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_FIFOSIZE3</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">TX_ATIM_FIFO</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">TX_BCMC_FIFO</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">TX_BCMC_FIFO</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">TX_BCMC_FIFO</span><span class="p">]</span> <span class="o">!=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">TX_BCMC_FIFO</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">TX_BCMC_FIFO</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">TX_ATIM_FIFO</span><span class="p">]</span> <span class="o">!=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">TX_ATIM_FIFO</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">TX_ATIM_FIFO</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wlc_coreinit: txfifo mismatch: ucode size %d&quot;</span>
			  <span class="s">&quot; driver size %d index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			  <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* make sure we can still talk to the mac */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="cm">/* band-specific inits done by wlc_bsinit() */</span>

	<span class="cm">/* Set up frame burst size and antenna swap threshold init values */</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_MBURST_SIZE</span><span class="p">,</span> <span class="n">MAXTXFRAMEBURST</span><span class="p">);</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_MAX_ANTCNT</span><span class="p">,</span> <span class="n">ANTCNT</span><span class="p">);</span>

	<span class="cm">/* enable one rx interrupt per received frame */</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">intrcvlazy</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IRL_FC_SHIFT</span><span class="p">));</span>

	<span class="cm">/* set the station mode (BSS STA) */</span>
	<span class="n">brcms_b_mctrl</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">MCTL_INFRA</span> <span class="o">|</span> <span class="n">MCTL_DISCARD_PMQ</span> <span class="o">|</span> <span class="n">MCTL_AP</span><span class="p">),</span>
		       <span class="p">(</span><span class="n">MCTL_INFRA</span> <span class="o">|</span> <span class="n">MCTL_DISCARD_PMQ</span><span class="p">));</span>

	<span class="cm">/* set up Beacon interval */</span>
	<span class="n">bcnint_us</span> <span class="o">=</span> <span class="mh">0x8000</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_cfprep</span><span class="p">),</span>
		     <span class="p">(</span><span class="n">bcnint_us</span> <span class="o">&lt;&lt;</span> <span class="n">CFPREP_CBI_SHIFT</span><span class="p">));</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_cfpstart</span><span class="p">),</span> <span class="n">bcnint_us</span><span class="p">);</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">macintstatus</span><span class="p">),</span> <span class="n">MI_GP1</span><span class="p">);</span>

	<span class="cm">/* write interrupt mask */</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">intctrlregs</span><span class="p">[</span><span class="n">RX_FIFO</span><span class="p">].</span><span class="n">intmask</span><span class="p">),</span>
		     <span class="n">DEF_RXINTMASK</span><span class="p">);</span>

	<span class="cm">/* allow the MAC to control the PHY clock (dynamic on/off) */</span>
	<span class="n">brcms_b_macphyclk_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>

	<span class="cm">/* program dynamic clock control fast powerup delay register */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fastpwrup_dly</span> <span class="o">=</span> <span class="n">ai_clkctl_fast_pwrup_delay</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>
	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">scc_fastpwrup_dly</span><span class="p">),</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fastpwrup_dly</span><span class="p">);</span>

	<span class="cm">/* tell the ucode the corerev */</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_MACHW_VER</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">);</span>

	<span class="cm">/* tell the ucode MAC capabilities */</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_MACHW_CAP_L</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">machwcap</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_MACHW_CAP_H</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">wlc_hw</span><span class="o">-&gt;</span>
				      <span class="n">machwcap</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>

	<span class="cm">/* write retry limits to SCR, this done after PSM init */</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span>
		     <span class="n">OBJADDR_SCR_SEL</span> <span class="o">|</span> <span class="n">S_DOT11_SRC_LMT</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">),</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">SRL</span><span class="p">);</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">),</span>
		     <span class="n">OBJADDR_SCR_SEL</span> <span class="o">|</span> <span class="n">S_DOT11_LRC_LMT</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objaddr</span><span class="p">));</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">objdata</span><span class="p">),</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">LRL</span><span class="p">);</span>

	<span class="cm">/* write rate fallback retry limits */</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_SFRMTXCNTFBRTHSD</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">SFBL</span><span class="p">);</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">M_LFRMTXCNTFBRTHSD</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">LFBL</span><span class="p">);</span>

	<span class="n">bcma_mask16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">ifs_ctl</span><span class="p">),</span> <span class="mh">0x0FFF</span><span class="p">);</span>
	<span class="n">bcma_write16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">ifs_aifsn</span><span class="p">),</span> <span class="n">EDCF_AIFSN_MIN</span><span class="p">);</span>

	<span class="cm">/* init the tx dma engines */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NFIFO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">dma_txinit</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* init the rx dma engine(s) and post receive buffers */</span>
	<span class="n">dma_rxinit</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">RX_FIFO</span><span class="p">]);</span>
	<span class="n">dma_rxfill</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">RX_FIFO</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="k">static</span> <span class="nf">brcms_b_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">macintmask</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fastclk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="cm">/* request FAST clock if not on */</span>
	<span class="n">fastclk</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">forcefastclk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fastclk</span><span class="p">)</span>
		<span class="n">brcms_b_clkctl_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BCMA_CLKMODE_FAST</span><span class="p">);</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="n">macintmask</span> <span class="o">=</span> <span class="n">brcms_intrsoff</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>

	<span class="cm">/* set up the specified band and chanspec */</span>
	<span class="n">brcms_c_setxband</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">chspec_bandunit</span><span class="p">(</span><span class="n">chanspec</span><span class="p">));</span>
	<span class="n">wlc_phy_chanspec_radio_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/* do one-time phy inits and calibration */</span>
	<span class="n">wlc_phy_cal_init</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">);</span>

	<span class="cm">/* core-specific initialization */</span>
	<span class="n">brcms_b_coreinit</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* band-specific inits */</span>
	<span class="n">brcms_b_bsinit</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/* restore macintmask */</span>
	<span class="n">brcms_intrsrestore</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">macintmask</span><span class="p">);</span>

	<span class="cm">/* seed wake_override with BRCMS_WAKE_OVERRIDE_MACSUSPEND since the mac</span>
<span class="cm">	 * is suspended and brcms_c_enable_mac() will clear this override bit.</span>
<span class="cm">	 */</span>
	<span class="n">mboolset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wake_override</span><span class="p">,</span> <span class="n">BRCMS_WAKE_OVERRIDE_MACSUSPEND</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize mac_suspend_depth to 1 to match ucode</span>
<span class="cm">	 * initial suspended state</span>
<span class="cm">	 */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">mac_suspend_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* restore the clk */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fastclk</span><span class="p">)</span>
		<span class="n">brcms_b_clkctl_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BCMA_CLKMODE_DYNAMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_set_phy_chanspec</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Save our copy of the chanspec */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">chanspec</span> <span class="o">=</span> <span class="n">chanspec</span><span class="p">;</span>

	<span class="cm">/* Set the chanspec and power limits for this locale */</span>
	<span class="n">brcms_c_channel_set_chanspec</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">,</span> <span class="n">BRCMS_TXPWR_MAX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">ss_algosel_auto</span><span class="p">)</span>
		<span class="n">brcms_c_stf_ss_algo_channel_get</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">ss_algo_channel</span><span class="p">,</span>
					    <span class="n">chanspec</span><span class="p">);</span>

	<span class="n">brcms_c_stf_ss_update</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_default_rateset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">brcms_c_rateset_default</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phytype</span><span class="p">,</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">BRCMS_RATE_MASK_FULL</span><span class="p">,</span>
		<span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">&amp;</span> <span class="n">SUPPORT_11N</span><span class="p">),</span>
		<span class="n">brcms_chspec_bw</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">),</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txstreams</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* derive wlc-&gt;band-&gt;basic_rate[] table from &#39;rateset&#39; */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_rate_lookup_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="o">*</span><span class="n">rateset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mandatory</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cck_basic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ofdm_basic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">br</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* incoming rates are in 500kbps units as in 802.11 Supported Rates */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">br</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BRCM_MAXRATE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* For each basic rate in the rates list, make an entry in the</span>
<span class="cm">	 * best basic lookup.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rateset</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only make an entry for a basic rate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rateset</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BRCMS_RATE_FLAG</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* mask off basic bit */</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">rateset</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BRCMS_RATE_MASK</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="n">BRCM_MAXRATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;brcms_c_rate_lookup_init: &quot;</span>
				  <span class="s">&quot;invalid rate 0x%X in rate set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">rateset</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">br</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The rate lookup table now has non-zero entries for each</span>
<span class="cm">	 * basic rate, equal to the basic rate: br[basicN] = basicN</span>
<span class="cm">	 *</span>
<span class="cm">	 * To look up the best basic rate corresponding to any</span>
<span class="cm">	 * particular rate, code can use the basic_rate table</span>
<span class="cm">	 * like this</span>
<span class="cm">	 *</span>
<span class="cm">	 * basic_rate = wlc-&gt;band-&gt;basic_rate[tx_rate]</span>
<span class="cm">	 *</span>
<span class="cm">	 * Make sure there is a best basic rate entry for</span>
<span class="cm">	 * every rate by walking up the table from low rates</span>
<span class="cm">	 * to high, filling in holes in the lookup table</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">hw_rateset</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">hw_rateset</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">br</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This rate is a basic rate.</span>
<span class="cm">			 * Keep track of the best basic rate so far by</span>
<span class="cm">			 * modulation type.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span>
				<span class="n">ofdm_basic</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">cck_basic</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* This rate is not a basic rate so figure out the</span>
<span class="cm">		 * best basic rate less than this rate and fill in</span>
<span class="cm">		 * the hole in the table</span>
<span class="cm">		 */</span>

		<span class="n">br</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="o">?</span> <span class="n">ofdm_basic</span> <span class="o">:</span> <span class="n">cck_basic</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">br</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * In 11g and 11a, the OFDM mandatory rates</span>
<span class="cm">			 * are 6, 12, and 24 Mbps</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">BRCM_RATE_24M</span><span class="p">)</span>
				<span class="n">mandatory</span> <span class="o">=</span> <span class="n">BRCM_RATE_24M</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">BRCM_RATE_12M</span><span class="p">)</span>
				<span class="n">mandatory</span> <span class="o">=</span> <span class="n">BRCM_RATE_12M</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mandatory</span> <span class="o">=</span> <span class="n">BRCM_RATE_6M</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* In 11b, all CCK rates are mandatory 1 - 11 Mbps */</span>
			<span class="n">mandatory</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">br</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span> <span class="n">mandatory</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_bandinit_ordered</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="n">default_rateset</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">parkband</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">,</span> <span class="n">band_order</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We might have been bandlocked during down and the chip</span>
<span class="cm">	 * power-cycled (hibernate). Figure out the right band to park on</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandlocked</span> <span class="o">||</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* updated in brcms_c_bandlock() */</span>
		<span class="n">parkband</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">;</span>
		<span class="n">band_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_order</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parkband</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* park on the band of the specified chanspec */</span>
		<span class="n">parkband</span> <span class="o">=</span> <span class="n">chspec_bandunit</span><span class="p">(</span><span class="n">chanspec</span><span class="p">);</span>

		<span class="cm">/* order so that parkband initialize last */</span>
		<span class="n">band_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">parkband</span> <span class="o">^</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">band_order</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parkband</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make each band operational, software state init */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uint</span> <span class="n">j</span> <span class="o">=</span> <span class="n">band_order</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="n">brcms_default_rateset</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_rateset</span><span class="p">);</span>

		<span class="cm">/* fill in hw_rate */</span>
		<span class="n">brcms_c_rateset_filter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">default_rateset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">hw_rateset</span><span class="p">,</span>
				   <span class="nb">false</span><span class="p">,</span> <span class="n">BRCMS_RATES_CCK_OFDM</span><span class="p">,</span> <span class="n">BRCMS_RATE_MASK</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">&amp;</span> <span class="n">SUPPORT_11N</span><span class="p">));</span>

		<span class="cm">/* init basic rate lookup */</span>
		<span class="n">brcms_c_rate_lookup_init</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_rateset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* sync up phy/radio chanspec */</span>
	<span class="n">brcms_c_set_phy_chanspec</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set or clear filtering related maccontrol bits based on</span>
<span class="cm"> * specified filter flags</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_c_mac_promisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">uint</span> <span class="n">filter_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">promisc_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="n">filter_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FIF_PROMISC_IN_BSS</span> <span class="o">|</span> <span class="n">FIF_OTHER_BSS</span><span class="p">))</span>
		<span class="n">promisc_bits</span> <span class="o">|=</span> <span class="n">MCTL_PROMISC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">)</span>
		<span class="n">promisc_bits</span> <span class="o">|=</span> <span class="n">MCTL_BCNS_PROMISC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_FCSFAIL</span><span class="p">)</span>
		<span class="n">promisc_bits</span> <span class="o">|=</span> <span class="n">MCTL_KEEPBADFCS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FIF_CONTROL</span> <span class="o">|</span> <span class="n">FIF_PSPOLL</span><span class="p">))</span>
		<span class="n">promisc_bits</span> <span class="o">|=</span> <span class="n">MCTL_KEEPCONTROL</span><span class="p">;</span>

	<span class="n">brcms_b_mctrl</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
		<span class="n">MCTL_PROMISC</span> <span class="o">|</span> <span class="n">MCTL_BCNS_PROMISC</span> <span class="o">|</span>
		<span class="n">MCTL_KEEPCONTROL</span> <span class="o">|</span> <span class="n">MCTL_KEEPBADFCS</span><span class="p">,</span>
		<span class="n">promisc_bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ucode, hwmac update</span>
<span class="cm"> *    Channel dependent updates for ucode and hw</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_ucode_mac_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* enable or disable any active IBSSs depending on whether or not</span>
<span class="cm">	 * we are on the home channel</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">home_chanspec</span> <span class="o">==</span> <span class="n">wlc_phy_chanspec_get</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">associated</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * BMAC_NOTE: This is something that should be fixed</span>
<span class="cm">			 * in ucode inits. I think that the ucode inits set</span>
<span class="cm">			 * up the bcn templates and shm values with a bogus</span>
<span class="cm">			 * beacon. This should not be done in the inits. If</span>
<span class="cm">			 * ucode needs to set up a beacon for testing, the</span>
<span class="cm">			 * test routines should write it down, not expect the</span>
<span class="cm">			 * inits to populate a bogus beacon.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_PHY_11N_CAP</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span>
				<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">M_BCN_TXTSF_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* disable an active IBSS if we are not on the home channel */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_write_rate_shm</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rate</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">basic_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">phy_rate</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">basic_phy_rate</span><span class="p">,</span> <span class="n">basic_index</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dir_table</span><span class="p">,</span> <span class="n">basic_table</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">basic_ptr</span><span class="p">;</span>

	<span class="cm">/* Shared memory address for the table we are reading */</span>
	<span class="n">dir_table</span> <span class="o">=</span> <span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">basic_rate</span><span class="p">)</span> <span class="o">?</span> <span class="n">M_RT_DIRMAP_A</span> <span class="o">:</span> <span class="n">M_RT_DIRMAP_B</span><span class="p">;</span>

	<span class="cm">/* Shared memory address for the table we are writing */</span>
	<span class="n">basic_table</span> <span class="o">=</span> <span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="o">?</span> <span class="n">M_RT_BBRSMAP_A</span> <span class="o">:</span> <span class="n">M_RT_BBRSMAP_B</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * for a given rate, the LS-nibble of the PLCP SIGNAL field is</span>
<span class="cm">	 * the index into the rate table.</span>
<span class="cm">	 */</span>
	<span class="n">phy_rate</span> <span class="o">=</span> <span class="n">rate_info</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BRCMS_RATE_MASK</span><span class="p">;</span>
	<span class="n">basic_phy_rate</span> <span class="o">=</span> <span class="n">rate_info</span><span class="p">[</span><span class="n">basic_rate</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BRCMS_RATE_MASK</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">phy_rate</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">basic_index</span> <span class="o">=</span> <span class="n">basic_phy_rate</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="cm">/* Find the SHM pointer to the ACK rate entry by looking in the</span>
<span class="cm">	 * Direct-map Table</span>
<span class="cm">	 */</span>
	<span class="n">basic_ptr</span> <span class="o">=</span> <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">dir_table</span> <span class="o">+</span> <span class="n">basic_index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>

	<span class="cm">/* Update the SHM BSS-basic-rate-set mapping table with the pointer</span>
<span class="cm">	 * to the correct basic rate for the given incoming rate</span>
<span class="cm">	 */</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">basic_table</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">basic_ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="o">*</span>
<span class="nf">brcms_c_rateset_get_hwrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="o">*</span><span class="n">rs_dflt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_PHY_11N_CAP</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span><span class="p">)</span>
			<span class="n">rs_dflt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ofdm_mimo_rates</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rs_dflt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cck_ofdm_mimo_rates</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
		<span class="n">rs_dflt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cck_ofdm_rates</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rs_dflt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cck_rates</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rs_dflt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_set_ratetable</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="o">*</span><span class="n">rs_dflt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="n">rs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">,</span> <span class="n">basic_rate</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rs_dflt</span> <span class="o">=</span> <span class="n">brcms_c_rateset_get_hwrs</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="n">brcms_c_rateset_copy</span><span class="p">(</span><span class="n">rs_dflt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">);</span>
	<span class="n">brcms_c_rateset_mcs_upd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txstreams</span><span class="p">);</span>

	<span class="cm">/* walk the phy rate table and update SHM basic rate lookup table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BRCMS_RATE_MASK</span><span class="p">;</span>

		<span class="cm">/* for a given rate brcms_basic_rate returns the rate at</span>
<span class="cm">		 * which a response ACK/CTS should be sent.</span>
<span class="cm">		 */</span>
		<span class="n">basic_rate</span> <span class="o">=</span> <span class="n">brcms_basic_rate</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">basic_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* This should only happen if we are using a</span>
<span class="cm">			 * restricted rateset.</span>
<span class="cm">			 */</span>
			<span class="n">basic_rate</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BRCMS_RATE_MASK</span><span class="p">;</span>

		<span class="n">brcms_c_write_rate_shm</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">basic_rate</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* band-specific init */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_bsinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: bandunit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">);</span>

	<span class="cm">/* write ucode ACK/CTS rate table */</span>
	<span class="n">brcms_c_set_ratetable</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* update some band specific mac configuration */</span>
	<span class="n">brcms_c_ucode_mac_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* init antenna selection */</span>
	<span class="n">brcms_c_antsel_init</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">asi</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* formula:  IDLE_BUSY_RATIO_X_16 = (100-duty_cycle)/duty_cycle*16 */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcms_c_duty_cycle_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">duty_cycle</span><span class="p">,</span> <span class="n">bool</span> <span class="n">isOFDM</span><span class="p">,</span>
		   <span class="n">bool</span> <span class="n">writeToShm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idle_busy_ratio_x_16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">offset</span> <span class="o">=</span>
	    <span class="n">isOFDM</span> <span class="o">?</span> <span class="n">M_TX_IDLE_BUSY_RATIO_X_16_OFDM</span> <span class="o">:</span>
	    <span class="n">M_TX_IDLE_BUSY_RATIO_X_16_CCK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">duty_cycle</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="o">||</span> <span class="n">duty_cycle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d:  duty cycle value off limit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">duty_cycle</span><span class="p">)</span>
		<span class="n">idle_busy_ratio_x_16</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">duty_cycle</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">duty_cycle</span><span class="p">;</span>
	<span class="cm">/* Only write to shared memory  when wl is up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">writeToShm</span><span class="p">)</span>
		<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">idle_busy_ratio_x_16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isOFDM</span><span class="p">)</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_duty_cycle_ofdm</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">duty_cycle</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_duty_cycle_cck</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">duty_cycle</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the base precedence map for dequeueing</span>
<span class="cm"> * from txq based on WME settings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_tx_prec_map_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_prec_map</span> <span class="o">=</span> <span class="n">BRCMS_PREC_BMP_ALL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fifo2prec_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NFIFO</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fifo2prec_map</span><span class="p">[</span><span class="n">TX_AC_BK_FIFO</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCMS_PREC_BMP_AC_BK</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fifo2prec_map</span><span class="p">[</span><span class="n">TX_AC_BE_FIFO</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCMS_PREC_BMP_AC_BE</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fifo2prec_map</span><span class="p">[</span><span class="n">TX_AC_VI_FIFO</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCMS_PREC_BMP_AC_VI</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fifo2prec_map</span><span class="p">[</span><span class="n">TX_AC_VO_FIFO</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCMS_PREC_BMP_AC_VO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_c_txflowcontrol_signal</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">brcms_txq_info</span> <span class="o">*</span><span class="n">qi</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* transmit flowcontrol is not yet implemented */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_txflowcontrol_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_txq_info</span> <span class="o">*</span><span class="n">qi</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">qi</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_queues</span><span class="p">;</span> <span class="n">qi</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">qi</span> <span class="o">=</span> <span class="n">qi</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcms_c_txflowcontrol_signal</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">qi</span><span class="p">,</span> <span class="n">OFF</span><span class="p">,</span> <span class="n">ALLPRIO</span><span class="p">);</span>
			<span class="n">qi</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* push sw hps and wake state through hardware */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_set_ps_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">hps</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">awake_before</span><span class="p">;</span>

	<span class="n">hps</span> <span class="o">=</span> <span class="n">brcms_c_ps_allowed</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: hps %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">hps</span><span class="p">);</span>

	<span class="n">v1</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">));</span>
	<span class="n">v2</span> <span class="o">=</span> <span class="n">MCTL_WAKE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hps</span><span class="p">)</span>
		<span class="n">v2</span> <span class="o">|=</span> <span class="n">MCTL_HPS</span><span class="p">;</span>

	<span class="n">brcms_b_mctrl</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MCTL_WAKE</span> <span class="o">|</span> <span class="n">MCTL_HPS</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>

	<span class="n">awake_before</span> <span class="o">=</span> <span class="p">((</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="n">MCTL_WAKE</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="n">MCTL_HPS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">awake_before</span><span class="p">)</span>
		<span class="n">brcms_b_wait_for_wake</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write this BSS config&#39;s MAC address to core.</span>
<span class="cm"> * Updates RXE match engine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_c_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_bss_cfg</span> <span class="o">*</span><span class="n">bsscfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>

	<span class="cm">/* enter the MAC addr into the RXE match registers */</span>
	<span class="n">brcms_c_set_addrmatch</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">RCM_MAC_OFFSET</span><span class="p">,</span> <span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">cur_etheraddr</span><span class="p">);</span>

	<span class="n">brcms_c_ampdu_macaddr_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write the BSS config&#39;s BSSID address to core (set_bssid in d11procs.tcl).</span>
<span class="cm"> * Updates RXE match engine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_set_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_bss_cfg</span> <span class="o">*</span><span class="n">bsscfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* we need to update BSSID in RXE match registers */</span>
	<span class="n">brcms_c_set_addrmatch</span><span class="p">(</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">RCM_BSSID_OFFSET</span><span class="p">,</span> <span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_set_shortslot</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">shortslot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">shortslot</span> <span class="o">=</span> <span class="n">shortslot</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span> <span class="o">&amp;&amp;</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_c_suspend_mac_and_wait</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
		<span class="n">brcms_b_update_slot_timing</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">shortslot</span><span class="p">);</span>
		<span class="n">brcms_c_enable_mac</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Suspend the the MAC and update the slot timing</span>
<span class="cm"> * for standard 11b/g (20us slots) or shortslot 11g (9us slots).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_switch_shortslot</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">shortslot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* use the override if it is set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">shortslot_override</span> <span class="o">!=</span> <span class="n">BRCMS_SHORTSLOT_AUTO</span><span class="p">)</span>
		<span class="n">shortslot</span> <span class="o">=</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">shortslot_override</span> <span class="o">==</span> <span class="n">BRCMS_SHORTSLOT_ON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">shortslot</span> <span class="o">==</span> <span class="n">shortslot</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">shortslot</span> <span class="o">=</span> <span class="n">shortslot</span><span class="p">;</span>

	<span class="n">brcms_b_set_shortslot</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">shortslot</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_set_home_chanspec</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">home_chanspec</span> <span class="o">!=</span> <span class="n">chanspec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">home_chanspec</span> <span class="o">=</span> <span class="n">chanspec</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">associated</span><span class="p">)</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">current_bss</span><span class="o">-&gt;</span><span class="n">chanspec</span> <span class="o">=</span> <span class="n">chanspec</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">brcms_b_set_chanspec</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chanspec</span><span class="p">,</span>
		      <span class="n">bool</span> <span class="n">mute_tx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">txpwr_limits</span> <span class="o">*</span><span class="n">txpwr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">bandunit</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>

	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">chanspec</span> <span class="o">=</span> <span class="n">chanspec</span><span class="p">;</span>

	<span class="cm">/* Switch bands if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bandunit</span> <span class="o">=</span> <span class="n">chspec_bandunit</span><span class="p">(</span><span class="n">chanspec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span> <span class="o">!=</span> <span class="n">bandunit</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* brcms_b_setband disables other bandunit,</span>
<span class="cm">			 *  use light band switch if not up yet</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wlc_phy_chanspec_radio_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span>
							   <span class="n">bandstate</span><span class="p">[</span><span class="n">bandunit</span><span class="p">]</span><span class="o">-&gt;</span>
							   <span class="n">pi</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>
				<span class="n">brcms_b_setband</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">bandunit</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">brcms_c_setxband</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">bandunit</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wlc_phy_initcal_enable</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="o">!</span><span class="n">mute_tx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span>
			<span class="n">wlc_phy_txpower_limit_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">txpwr</span><span class="p">,</span>
						  <span class="n">chanspec</span><span class="p">);</span>
		<span class="n">wlc_phy_chanspec_radio_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wlc_phy_chanspec_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>
		<span class="n">wlc_phy_txpower_limit_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">txpwr</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>

		<span class="cm">/* Update muting of the channel */</span>
		<span class="n">brcms_b_mute</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">mute_tx</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* switch to and initialize new band */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_setband</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span>
					   <span class="n">uint</span> <span class="n">bandunit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">bandunit</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* wait for at least one beacon before entering sleeping state */</span>
	<span class="n">brcms_c_set_ps_ctrl</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* band-specific initializations */</span>
	<span class="n">brcms_c_bsinit</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_set_chanspec</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chanspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">bandunit</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">switchband</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">old_chanspec</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_c_valid_chanspec_db</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: Bad channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">chanspec</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Switch bands if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bandunit</span> <span class="o">=</span> <span class="n">chspec_bandunit</span><span class="p">(</span><span class="n">chanspec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span> <span class="o">!=</span> <span class="n">bandunit</span> <span class="o">||</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandinit_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">switchband</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandlocked</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: chspec %d &quot;</span>
					  <span class="s">&quot;band is locked!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					  <span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">chanspec</span><span class="p">));</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * should the setband call come after the</span>
<span class="cm">			 * brcms_b_chanspec() ? if the setband updates</span>
<span class="cm">			 * (brcms_c_bsinit) use low level calls to inspect and</span>
<span class="cm">			 * set state, the state inspected may be from the wrong</span>
<span class="cm">			 * band, or the following brcms_b_set_chanspec() may</span>
<span class="cm">			 * undo the work.</span>
<span class="cm">			 */</span>
			<span class="n">brcms_c_setband</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bandunit</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* sync up phy/radio chanspec */</span>
	<span class="n">brcms_c_set_phy_chanspec</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/* init antenna selection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcms_chspec_bw</span><span class="p">(</span><span class="n">old_chanspec</span><span class="p">)</span> <span class="o">!=</span> <span class="n">brcms_chspec_bw</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcms_c_antsel_init</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">asi</span><span class="p">);</span>

		<span class="cm">/* Fix the hardware rateset based on bw.</span>
<span class="cm">		 * Mainly add MCS32 for 40Mhz, remove MCS 32 for 20Mhz</span>
<span class="cm">		 */</span>
		<span class="n">brcms_c_rateset_bw_mcs_filter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">hw_rateset</span><span class="p">,</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">mimo_cap_40</span> <span class="o">?</span> <span class="n">brcms_chspec_bw</span><span class="p">(</span><span class="n">chanspec</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* update some mac configuration since chanspec changed */</span>
	<span class="n">brcms_c_ucode_mac_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function changes the phytxctl for beacon based on current</span>
<span class="cm"> * beacon ratespec AND txant setting as per this table:</span>
<span class="cm"> *  ratespec     CCK		ant = wlc-&gt;stf-&gt;txant</span>
<span class="cm"> *		OFDM		ant = 3</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_c_beacon_phytxctl_txant_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">bcn_rspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">phyctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phytxant</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">phytxant</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">PHY_TXC_ANT_MASK</span><span class="p">;</span>

	<span class="cm">/* for non-siso rates or default setting, use the available chains */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_PHY_11N_CAP</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span>
		<span class="n">phytxant</span> <span class="o">=</span> <span class="n">brcms_c_stf_phytxchain_sel</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bcn_rspec</span><span class="p">);</span>

	<span class="n">phyctl</span> <span class="o">=</span> <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_BCN_PCTLWD</span><span class="p">);</span>
	<span class="n">phyctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">phyctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">phytxant</span><span class="p">;</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_BCN_PCTLWD</span><span class="p">,</span> <span class="n">phyctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * centralized protection config change function to simplify debugging, no</span>
<span class="cm"> * consistency checking this should be called only on changes to avoid overhead</span>
<span class="cm"> * in periodic function</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_c_protection_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">uint</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;idx %d, val %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BRCMS_PROT_G_SPEC</span>:
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">_g</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCMS_PROT_G_OVR</span>:
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">g_override</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCMS_PROT_G_USER</span>:
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">gmode_user</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCMS_PROT_OVERLAP</span>:
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">overlap</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCMS_PROT_N_USER</span>:
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">nmode_user</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCMS_PROT_N_CFG</span>:
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">n_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCMS_PROT_N_CFG_OVR</span>:
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">n_cfg_override</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCMS_PROT_N_NONGF</span>:
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">nongf</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCMS_PROT_N_NONGF_OVR</span>:
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">nongf_override</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCMS_PROT_N_PAM_OVR</span>:
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">n_pam_override</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCMS_PROT_N_OBSS</span>:
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">n_obss</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_ht_update_sgi_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_c_update_beacon</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
		<span class="n">brcms_c_update_probe_resp</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_ht_update_ldpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">s8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">ldpc</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_c_update_beacon</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
		<span class="n">brcms_c_update_probe_resp</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">wlc_phy_ldpc_override_set</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_wme_setparams</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">aci</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
		       <span class="n">bool</span> <span class="n">suspend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">shm_acparams</span> <span class="n">acp_shm</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">shm_entry</span><span class="p">;</span>

	<span class="cm">/* Only apply params if the core is out of reset and has clocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s : no-clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">acp_shm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shm_acparams</span><span class="p">));</span>
	<span class="cm">/* fill in shm ac params struct */</span>
	<span class="n">acp_shm</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">;</span>
	<span class="cm">/* convert from units of 32us to us for ucode */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">edcf_txop</span><span class="p">[</span><span class="n">aci</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">]</span> <span class="o">=</span> <span class="n">acp_shm</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span>
	    <span class="n">EDCF_TXOP2USEC</span><span class="p">(</span><span class="n">acp_shm</span><span class="p">.</span><span class="n">txop</span><span class="p">);</span>
	<span class="n">acp_shm</span><span class="p">.</span><span class="n">aifs</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">aifs</span> <span class="o">&amp;</span> <span class="n">EDCF_AIFSN_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aci</span> <span class="o">==</span> <span class="n">IEEE80211_AC_VI</span> <span class="o">&amp;&amp;</span> <span class="n">acp_shm</span><span class="p">.</span><span class="n">txop</span> <span class="o">==</span> <span class="mi">0</span>
	    <span class="o">&amp;&amp;</span> <span class="n">acp_shm</span><span class="p">.</span><span class="n">aifs</span> <span class="o">&lt;</span> <span class="n">EDCF_AIFSN_MAX</span><span class="p">)</span>
		<span class="n">acp_shm</span><span class="p">.</span><span class="n">aifs</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acp_shm</span><span class="p">.</span><span class="n">aifs</span> <span class="o">&lt;</span> <span class="n">EDCF_AIFSN_MIN</span>
	    <span class="o">||</span> <span class="n">acp_shm</span><span class="p">.</span><span class="n">aifs</span> <span class="o">&gt;</span> <span class="n">EDCF_AIFSN_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: edcf_setparams: bad &quot;</span>
			  <span class="s">&quot;aifs %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">acp_shm</span><span class="p">.</span><span class="n">aifs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">acp_shm</span><span class="p">.</span><span class="n">cwmin</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">;</span>
		<span class="n">acp_shm</span><span class="p">.</span><span class="n">cwmax</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">;</span>
		<span class="n">acp_shm</span><span class="p">.</span><span class="n">cwcur</span> <span class="o">=</span> <span class="n">acp_shm</span><span class="p">.</span><span class="n">cwmin</span><span class="p">;</span>
		<span class="n">acp_shm</span><span class="p">.</span><span class="n">bslots</span> <span class="o">=</span>
			<span class="n">bcma_read16</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_random</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="n">acp_shm</span><span class="p">.</span><span class="n">cwcur</span><span class="p">;</span>
		<span class="n">acp_shm</span><span class="p">.</span><span class="n">reggap</span> <span class="o">=</span> <span class="n">acp_shm</span><span class="p">.</span><span class="n">bslots</span> <span class="o">+</span> <span class="n">acp_shm</span><span class="p">.</span><span class="n">aifs</span><span class="p">;</span>
		<span class="cm">/* Indicate the new params to the ucode */</span>
		<span class="n">acp_shm</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">M_EDCF_QINFO</span> <span class="o">+</span>
						  <span class="n">wme_ac2fifo</span><span class="p">[</span><span class="n">aci</span><span class="p">]</span> <span class="o">*</span>
						  <span class="n">M_EDCF_QLEN</span> <span class="o">+</span>
						  <span class="n">M_EDCF_STATUS_OFF</span><span class="p">));</span>
		<span class="n">acp_shm</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">WME_STATUS_NEWAC</span><span class="p">;</span>

		<span class="cm">/* Fill in shm acparam table */</span>
		<span class="n">shm_entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">acp_shm</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shm_acparams</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					  <span class="n">M_EDCF_QINFO</span> <span class="o">+</span>
					  <span class="n">wme_ac2fifo</span><span class="p">[</span><span class="n">aci</span><span class="p">]</span> <span class="o">*</span> <span class="n">M_EDCF_QLEN</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
					  <span class="o">*</span><span class="n">shm_entry</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_c_suspend_mac_and_wait</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
		<span class="n">brcms_c_enable_mac</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_edcf_setparams</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">suspend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">aci</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i_ac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="n">txq_pars</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">edcf_acparam</span> <span class="n">default_edcf_acparams</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		 <span class="p">{</span><span class="n">EDCF_AC_BE_ACI_STA</span><span class="p">,</span> <span class="n">EDCF_AC_BE_ECW_STA</span><span class="p">,</span> <span class="n">EDCF_AC_BE_TXOP_STA</span><span class="p">},</span>
		 <span class="p">{</span><span class="n">EDCF_AC_BK_ACI_STA</span><span class="p">,</span> <span class="n">EDCF_AC_BK_ECW_STA</span><span class="p">,</span> <span class="n">EDCF_AC_BK_TXOP_STA</span><span class="p">},</span>
		 <span class="p">{</span><span class="n">EDCF_AC_VI_ACI_STA</span><span class="p">,</span> <span class="n">EDCF_AC_VI_ECW_STA</span><span class="p">,</span> <span class="n">EDCF_AC_VI_TXOP_STA</span><span class="p">},</span>
		 <span class="p">{</span><span class="n">EDCF_AC_VO_ACI_STA</span><span class="p">,</span> <span class="n">EDCF_AC_VO_ECW_STA</span><span class="p">,</span> <span class="n">EDCF_AC_VO_TXOP_STA</span><span class="p">}</span>
	<span class="p">};</span> <span class="cm">/* ucode needs these parameters during its initialization */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">edcf_acparam</span> <span class="o">*</span><span class="n">edcf_acp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">default_edcf_acparams</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i_ac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i_ac</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_ACS</span><span class="p">;</span> <span class="n">i_ac</span><span class="o">++</span><span class="p">,</span> <span class="n">edcf_acp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* find out which ac this set of params applies to */</span>
		<span class="n">aci</span> <span class="o">=</span> <span class="p">(</span><span class="n">edcf_acp</span><span class="o">-&gt;</span><span class="n">ACI</span> <span class="o">&amp;</span> <span class="n">EDCF_ACI_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">EDCF_ACI_SHIFT</span><span class="p">;</span>

		<span class="cm">/* fill in shm ac params struct */</span>
		<span class="n">txq_pars</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span> <span class="n">edcf_acp</span><span class="o">-&gt;</span><span class="n">TXOP</span><span class="p">;</span>
		<span class="n">txq_pars</span><span class="p">.</span><span class="n">aifs</span> <span class="o">=</span> <span class="n">edcf_acp</span><span class="o">-&gt;</span><span class="n">ACI</span><span class="p">;</span>

		<span class="cm">/* CWmin = 2^(ECWmin) - 1 */</span>
		<span class="n">txq_pars</span><span class="p">.</span><span class="n">cw_min</span> <span class="o">=</span> <span class="n">EDCF_ECW2CW</span><span class="p">(</span><span class="n">edcf_acp</span><span class="o">-&gt;</span><span class="n">ECW</span> <span class="o">&amp;</span> <span class="n">EDCF_ECWMIN_MASK</span><span class="p">);</span>
		<span class="cm">/* CWmax = 2^(ECWmax) - 1 */</span>
		<span class="n">txq_pars</span><span class="p">.</span><span class="n">cw_max</span> <span class="o">=</span> <span class="n">EDCF_ECW2CW</span><span class="p">((</span><span class="n">edcf_acp</span><span class="o">-&gt;</span><span class="n">ECW</span> <span class="o">&amp;</span> <span class="n">EDCF_ECWMAX_MASK</span><span class="p">)</span>
					    <span class="o">&gt;&gt;</span> <span class="n">EDCF_ECWMAX_SHIFT</span><span class="p">);</span>
		<span class="n">brcms_c_wme_setparams</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">aci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq_pars</span><span class="p">,</span> <span class="n">suspend</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_c_suspend_mac_and_wait</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
		<span class="n">brcms_c_enable_mac</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_radio_monitor_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Don&#39;t start the timer if HWRADIO feature is disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">radio_monitor</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">radio_monitor</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">brcms_b_pllreq</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">BRCMS_PLLREQ_RADIO_MON</span><span class="p">);</span>
	<span class="n">brcms_add_timer</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">radio_timer</span><span class="p">,</span> <span class="n">TIMER_INTERVAL_RADIOCHK</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_radio_monitor_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">radio_monitor</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">radio_monitor</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">brcms_b_pllreq</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">BRCMS_PLLREQ_RADIO_MON</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">brcms_del_timer</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">radio_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* read hwdisable state and propagate to wlc flag */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_radio_hwdisable_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">hw_off</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brcms_b_radio_read_hwdisabled</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="n">mboolset</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">radio_disabled</span><span class="p">,</span> <span class="n">WL_RADIO_HW_DISABLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mboolclr</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">radio_disabled</span><span class="p">,</span> <span class="n">WL_RADIO_HW_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* update hwradio status and return it */</span>
<span class="n">bool</span> <span class="nf">brcms_c_check_radio_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">brcms_c_radio_hwdisable_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mboolisset</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">radio_disabled</span><span class="p">,</span> <span class="n">WL_RADIO_HW_DISABLE</span><span class="p">)</span> <span class="o">?</span>
			<span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* periodical query hw radio button while driver is &quot;down&quot; */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_radio_timer</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brcms_deviceremoved</span><span class="p">(</span><span class="n">wlc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: dead chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">brcms_down</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">brcms_c_radio_hwdisable_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* common low-level watchdog code */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_watchdog</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* increment second count */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">now</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Check for FIFO error interrupts */</span>
	<span class="n">brcms_b_fifoerrors</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>

	<span class="cm">/* make sure RX dma has buffers */</span>
	<span class="n">dma_rxfill</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">RX_FIFO</span><span class="p">]);</span>

	<span class="n">wlc_phy_watchdog</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* common watchdog code */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_watchdog</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brcms_deviceremoved</span><span class="p">(</span><span class="n">wlc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: dead chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="n">brcms_down</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* increment second count */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">now</span><span class="o">++</span><span class="p">;</span>

	<span class="n">brcms_c_radio_hwdisable_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="cm">/* if radio is disable, driver may be down, quit here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">radio_disabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">brcms_b_watchdog</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * occasionally sample mac stat counters to</span>
<span class="cm">	 * detect 16-bit counter wrap</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">%</span> <span class="n">SW_TIMER_MAC_STAT_UPD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">brcms_c_statsupd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISNPHY</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">-</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tempsense_lasttime</span><span class="p">)</span> <span class="o">&gt;=</span>
	     <span class="n">BRCMS_TEMPSENSE_PERIOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tempsense_lasttime</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">;</span>
		<span class="n">brcms_c_tempsense_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_watchdog_by_timer</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">brcms_c_watchdog</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_timers_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wdtimer</span> <span class="o">=</span> <span class="n">brcms_init_timer</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">brcms_c_watchdog_by_timer</span><span class="p">,</span>
		<span class="n">wlc</span><span class="p">,</span> <span class="s">&quot;watchdog&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wdtimer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d:  wl_init_timer for wdtimer &quot;</span>
			  <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">radio_timer</span> <span class="o">=</span> <span class="n">brcms_init_timer</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">brcms_c_radio_timer</span><span class="p">,</span>
		<span class="n">wlc</span><span class="p">,</span> <span class="s">&quot;radio&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">radio_timer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d:  wl_init_timer for radio_timer &quot;</span>
			  <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize brcms_c_info default values ...</span>
<span class="cm"> * may get overrides later in this function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_info_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Save our copy of the chanspec */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">chanspec</span> <span class="o">=</span> <span class="n">ch20mhz_chspec</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* various 802.11g modes */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">shortslot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">shortslot_override</span> <span class="o">=</span> <span class="n">BRCMS_SHORTSLOT_AUTO</span><span class="p">;</span>

	<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_G_OVR</span><span class="p">,</span> <span class="n">BRCMS_PROTECTION_AUTO</span><span class="p">);</span>
	<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_G_SPEC</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_N_CFG_OVR</span><span class="p">,</span>
			       <span class="n">BRCMS_PROTECTION_AUTO</span><span class="p">);</span>
	<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_N_CFG</span><span class="p">,</span> <span class="n">BRCMS_N_PROTECTION_OFF</span><span class="p">);</span>
	<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_N_NONGF_OVR</span><span class="p">,</span>
			       <span class="n">BRCMS_PROTECTION_AUTO</span><span class="p">);</span>
	<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_N_NONGF</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_N_PAM_OVR</span><span class="p">,</span> <span class="n">AUTO</span><span class="p">);</span>

	<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_OVERLAP</span><span class="p">,</span>
			       <span class="n">BRCMS_PROTECTION_CTL_OVERLAP</span><span class="p">);</span>

	<span class="cm">/* 802.11g draft 4.0 NonERP elt advertisement */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">include_legacy_erp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">ant_rx_ovr</span> <span class="o">=</span> <span class="n">ANT_RX_DIV_DEF</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txant</span> <span class="o">=</span> <span class="n">ANT_TX_DEF</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">prb_resp_timeout</span> <span class="o">=</span> <span class="n">BRCMS_PRB_RESP_TIMEOUT</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">usr_fragthresh</span> <span class="o">=</span> <span class="n">DOT11_DEFAULT_FRAG_LEN</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NFIFO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fragthresh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DOT11_DEFAULT_FRAG_LEN</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">RTSThresh</span> <span class="o">=</span> <span class="n">DOT11_DEFAULT_RTS_LEN</span><span class="p">;</span>

	<span class="cm">/* default rate fallback retry limits */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">SFBL</span> <span class="o">=</span> <span class="n">RETRY_SHORT_FB</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">LFBL</span> <span class="o">=</span> <span class="n">RETRY_LONG_FB</span><span class="p">;</span>

	<span class="cm">/* default mac retry limits */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">SRL</span> <span class="o">=</span> <span class="n">RETRY_SHORT_DEF</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">LRL</span> <span class="o">=</span> <span class="n">RETRY_LONG_DEF</span><span class="p">;</span>

	<span class="cm">/* WME QoS mode is Auto by default */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_ampdu</span> <span class="o">=</span> <span class="n">AMPDU_AGG_HOST</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">bcmerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">brcms_c_attach_module</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">unit</span><span class="p">;</span>
	<span class="n">unit</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">asi</span> <span class="o">=</span> <span class="n">brcms_c_antsel_attach</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">asi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: attach: antsel_attach &quot;</span>
			  <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">44</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ampdu</span> <span class="o">=</span> <span class="n">brcms_c_ampdu_attach</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ampdu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: attach: ampdu_attach &quot;</span>
			  <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">brcms_c_stf_attach</span><span class="p">(</span><span class="n">wlc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: attach: stf_attach &quot;</span>
			  <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">68</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">brcms_pub</span> <span class="o">*</span><span class="nf">brcms_c_pub</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* low level attach</span>
<span class="cm"> *    run backplane attach, init nvram</span>
<span class="cm"> *    run phy attach</span>
<span class="cm"> *    initialize software state for each core and band</span>
<span class="cm"> *    put the whole chip in reset(driver down state), no clock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_b_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span>
			  <span class="n">uint</span> <span class="n">unit</span><span class="p">,</span> <span class="n">bool</span> <span class="n">piomode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">wme</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">shared_phy_params</span> <span class="n">sha_params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">hosttype</span> <span class="o">==</span> <span class="n">BCMA_HOSTTYPE_PCI</span><span class="p">)</span>
		<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: vendor 0x%x device 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span>
		       <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
		       <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: vendor 0x%x device 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span>
		       <span class="n">core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">vendor</span><span class="p">,</span>
		       <span class="n">core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>

	<span class="n">wme</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">_piomode</span> <span class="o">=</span> <span class="n">piomode</span><span class="p">;</span>

	<span class="cm">/* populate struct brcms_hardware with default values  */</span>
	<span class="n">brcms_b_info_init</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do the hardware portion of the attach. Also initialize software</span>
<span class="cm">	 * state that depends on the particular hardware we are running.</span>
<span class="cm">	 */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span> <span class="o">=</span> <span class="n">ai_attach</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: brcms_b_attach: si_attach failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">unit</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* verify again the device is supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">hosttype</span> <span class="o">==</span> <span class="n">BCMA_HOSTTYPE_PCI</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">brcms_c_chipmatch</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: brcms_b_attach: Unsupported &quot;</span>
			<span class="s">&quot;vendor/device (0x%x/0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">unit</span><span class="p">,</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">hosttype</span> <span class="o">==</span> <span class="n">BCMA_HOSTTYPE_PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">vendorid</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">deviceid</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">vendorid</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">vendor</span><span class="p">;</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">deviceid</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span> <span class="o">=</span> <span class="n">core</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">rev</span><span class="p">;</span>

	<span class="cm">/* validate chip, chiprev and corerev */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_c_isgoodchip</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize power control registers */</span>
	<span class="n">ai_clkctl_init</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>

	<span class="cm">/* request fastclock and force fastclock for the rest of attach</span>
<span class="cm">	 * bring the d11 core out of reset.</span>
<span class="cm">	 *   For PMU chips, the first wlc_clkctl_clk is no-op since core-clk</span>
<span class="cm">	 *   is still false; But it will be called again inside wlc_corereset,</span>
<span class="cm">	 *   after d11 is out of reset.</span>
<span class="cm">	 */</span>
	<span class="n">brcms_b_clkctl_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BCMA_CLKMODE_FAST</span><span class="p">);</span>
	<span class="n">brcms_b_corereset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BRCMS_USE_COREFLAGS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_b_validate_chip_access</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: brcms_b_attach: validate_chip_access &quot;</span>
			<span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get the board rev, used just below */</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">board_rev</span><span class="p">;</span>
	<span class="cm">/* promote srom boardrev of 0xFF to 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">BOARDREV_PROMOTABLE</span><span class="p">)</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">BOARDREV_PROMOTED</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardrev</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_c_validboardtype</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: brcms_b_attach: Unsupported Broadcom &quot;</span>
			  <span class="s">&quot;board type (0x%x)&quot;</span> <span class="s">&quot; or revision level (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">unit</span><span class="p">,</span> <span class="n">ai_get_boardtype</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">),</span>
			  <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardrev</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sromrev</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardflags</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">+</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardflags2</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags2_lo</span> <span class="o">+</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags2_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardflags</span> <span class="o">&amp;</span> <span class="n">BFL_NOPLLDOWN</span><span class="p">)</span>
		<span class="n">brcms_b_pllreq</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">BRCMS_PLLREQ_SHARED</span><span class="p">);</span>

	<span class="cm">/* check device id(srom, nvram etc.) to set bands */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">deviceid</span> <span class="o">==</span> <span class="n">BCM43224_D11N_ID</span> <span class="o">||</span>
	    <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">deviceid</span> <span class="o">==</span> <span class="n">BCM43224_D11N_ID_VEN1</span><span class="p">)</span>
		<span class="cm">/* Dualband boards */</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ai_get_chip_id</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">)</span> <span class="o">==</span> <span class="n">BCM43225_CHIP_ID</span><span class="p">))</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* BMAC_NOTE: remove init of pub values when brcms_c_attach()</span>
<span class="cm">	 * unconditionally does the init of these values</span>
<span class="cm">	 */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">vendorid</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">vendorid</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">deviceid</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">deviceid</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">sih</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">corerev</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">sromrev</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sromrev</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">boardrev</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardrev</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">boardflags</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardflags</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">boardflags2</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardflags2</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">_nbands</span><span class="p">;</span>

	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">physhim</span> <span class="o">=</span> <span class="n">wlc_phy_shim_attach</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">physhim</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: brcms_b_attach: wlc_phy_shim_attach &quot;</span>
			<span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* pass all the parameters to wlc_phy_shared_attach in one struct */</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">sih</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">;</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">physhim</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">;</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span><span class="p">;</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">corerev</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span><span class="p">;</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">vendorid</span><span class="p">;</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">deviceid</span><span class="p">;</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ai_get_chip_id</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">chiprev</span> <span class="o">=</span> <span class="n">ai_get_chiprev</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">chippkg</span> <span class="o">=</span> <span class="n">ai_get_chippkg</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">sromrev</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sromrev</span><span class="p">;</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">boardtype</span> <span class="o">=</span> <span class="n">ai_get_boardtype</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">boardrev</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardrev</span><span class="p">;</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">boardflags</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardflags</span><span class="p">;</span>
	<span class="n">sha_params</span><span class="p">.</span><span class="n">boardflags2</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardflags2</span><span class="p">;</span>

	<span class="cm">/* alloc and save pointer to shared phy state area */</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">phy_sh</span> <span class="o">=</span> <span class="n">wlc_phy_shared_attach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sha_params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">phy_sh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize software state for each core and band */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">_nbands</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * band0 is always 2.4Ghz</span>
<span class="cm">		 * band1, if present, is 5Ghz</span>
<span class="cm">		 */</span>

		<span class="n">brcms_c_setxband</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">=</span> <span class="n">j</span> <span class="o">?</span> <span class="n">BRCM_BAND_5G</span> <span class="o">:</span> <span class="n">BRCM_BAND_2G</span><span class="p">;</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">=</span> <span class="n">j</span> <span class="o">?</span> <span class="n">BRCM_BAND_5G</span> <span class="o">:</span> <span class="n">BRCM_BAND_2G</span><span class="p">;</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">coreidx</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">core_index</span><span class="p">;</span>

		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">machwcap</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">machwcap</span><span class="p">));</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">machwcap_backup</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">machwcap</span><span class="p">;</span>

		<span class="cm">/* init tx fifo size */</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span> <span class="o">=</span>
		    <span class="n">xmtfifo_sz</span><span class="p">[(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">corerev</span> <span class="o">-</span> <span class="n">XMTFIFOTBL_STARTREV</span><span class="p">)];</span>

		<span class="cm">/* Get a phy for this band */</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span> <span class="o">=</span>
			<span class="n">wlc_phy_attach</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">phy_sh</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span>
				       <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span><span class="p">,</span>
				       <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: brcms_b_attach: wlc_phy_&quot;</span>
				  <span class="s">&quot;attach failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wlc_phy_machwcap_set</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">machwcap</span><span class="p">);</span>

		<span class="n">wlc_phy_get_phyversion</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phytype</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phyrev</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">radioid</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">radiorev</span><span class="p">);</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">abgphy_encore</span> <span class="o">=</span>
		    <span class="n">wlc_phy_get_encore</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">);</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">abgphy_encore</span> <span class="o">=</span> <span class="n">wlc_phy_get_encore</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">);</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">core_flags</span> <span class="o">=</span>
		    <span class="n">wlc_phy_get_coreflags</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">);</span>

		<span class="cm">/* verify good phy_type &amp; supported phy revision */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISNPHY</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NCONF_HAS</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phyrev</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">good_phy</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">bad_phy</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISLCNPHY</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">LCNCONF_HAS</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phyrev</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">good_phy</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">bad_phy</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="nl">bad_phy:</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: brcms_b_attach: unsupported &quot;</span>
				  <span class="s">&quot;phy type/rev (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span>
				  <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phytype</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phyrev</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

 <span class="nl">good_phy:</span>
		<span class="cm">/*</span>
<span class="cm">		 * BMAC_NOTE: wlc-&gt;band-&gt;pi should not be set below and should</span>
<span class="cm">		 * be done in the high level attach. However we can not make</span>
<span class="cm">		 * that change until all low level access is changed to</span>
<span class="cm">		 * wlc_hw-&gt;band-&gt;pi. Instead do the wlc-&gt;band-&gt;pi init below,</span>
<span class="cm">		 * keeping wlc_hw-&gt;band-&gt;pi as well for incremental update of</span>
<span class="cm">		 * low level fns, and cut over low only init when all fns</span>
<span class="cm">		 * updated.</span>
<span class="cm">		 */</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">;</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phytype</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phytype</span><span class="p">;</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phyrev</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phyrev</span><span class="p">;</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">radioid</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">radioid</span><span class="p">;</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">radiorev</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">radiorev</span><span class="p">;</span>

		<span class="cm">/* default contention windows size limits */</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">CWmin</span> <span class="o">=</span> <span class="n">APHY_CWMIN</span><span class="p">;</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">CWmax</span> <span class="o">=</span> <span class="n">PHY_CWMAX</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_b_attach_dmapio</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">wme</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* disable core to match driver &quot;down&quot; state */</span>
	<span class="n">brcms_c_coredisable</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>

	<span class="cm">/* Match driver &quot;down&quot; state */</span>
	<span class="n">ai_pci_down</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>

	<span class="cm">/* turn off pll and xtal to match driver &quot;down&quot; state */</span>
	<span class="n">brcms_b_xtal</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

	<span class="cm">/* *******************************************************************</span>
<span class="cm">	 * The hardware is in the DOWN state at this point. D11 core</span>
<span class="cm">	 * or cores are in reset with clocks off, and the board PLLs</span>
<span class="cm">	 * are off if possible.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Beyond this point, wlc-&gt;sbclk == false and chip registers</span>
<span class="cm">	 * should not be touched.</span>
<span class="cm">	 *********************************************************************</span>
<span class="cm">	 */</span>

	<span class="cm">/* init etheraddr state variables */</span>
	<span class="n">brcms_c_get_macaddr</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">etheraddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">etheraddr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">etheraddr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: brcms_b_attach: bad macaddr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">unit</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;deviceid 0x%x nbands %d board 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">deviceid</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">_nbands</span><span class="p">,</span> <span class="n">ai_get_boardtype</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: brcms_b_attach: failed with err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span>
		  <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_attach_antgain_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">unit</span><span class="p">;</span>
	<span class="n">unit</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">sromrev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* default antenna gain for srom rev 1 is 2 dBm (8 qdbm) */</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: Invalid antennas available in&quot;</span>
			  <span class="s">&quot; srom, using 2dB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s8</span> <span class="n">gain</span><span class="p">,</span> <span class="n">fract</span><span class="p">;</span>
		<span class="cm">/* Older sroms specified gain in whole dbm only.  In order</span>
<span class="cm">		 * be able to specify qdbm granularity and remain backward</span>
<span class="cm">		 * compatible the whole dbms are now encoded in only</span>
<span class="cm">		 * low 6 bits and remaining qdbms are encoded in the hi 2 bits.</span>
<span class="cm">		 * 6 bit signed number ranges from -32 - 31.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Examples:</span>
<span class="cm">		 * 0x1 = 1 db,</span>
<span class="cm">		 * 0xc1 = 1.75 db (1 + 3 quarters),</span>
<span class="cm">		 * 0x3f = -1 (-1 + 0 quarters),</span>
<span class="cm">		 * 0x7f = -.75 (-1 + 1 quarters) = -3 qdbm.</span>
<span class="cm">		 * 0xbf = -.50 (-1 + 2 quarters) = -2 qdbm.</span>
<span class="cm">		 */</span>
		<span class="n">gain</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">gain</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Sign extend */</span>
		<span class="n">gain</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">fract</span> <span class="o">=</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">gain</span> <span class="o">+</span> <span class="n">fract</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_attach_stf_ant_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">aa</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">unit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bandtype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">;</span>

	<span class="n">unit</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">;</span>
	<span class="n">bandtype</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span><span class="p">;</span>

	<span class="cm">/* get antennas available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span><span class="p">)</span>
		<span class="n">aa</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">ant_available_a</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">aa</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">ant_available_bg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">aa</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">aa</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: Invalid antennas available in&quot;</span>
			  <span class="s">&quot; srom (0x%x), using 3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">aa</span><span class="p">);</span>
		<span class="n">aa</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset the defaults if we have a single antenna */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aa</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">ant_rx_ovr</span> <span class="o">=</span> <span class="n">ANT_RX_DIV_FORCE_0</span><span class="p">;</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txant</span> <span class="o">=</span> <span class="n">ANT_TX_FORCE_0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">aa</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">ant_rx_ovr</span> <span class="o">=</span> <span class="n">ANT_RX_DIV_FORCE_1</span><span class="p">;</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txant</span> <span class="o">=</span> <span class="n">ANT_TX_FORCE_1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="p">}</span>

	<span class="cm">/* Compute Antenna Gain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span><span class="p">)</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">antenna_gain</span><span class="p">.</span><span class="n">a1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">antgain</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">antenna_gain</span><span class="p">.</span><span class="n">a0</span><span class="p">;</span>

	<span class="n">brcms_c_attach_antgain_init</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_bss_default_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">chanspec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_band</span> <span class="o">*</span><span class="n">band</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_bss_info</span> <span class="o">*</span><span class="n">bi</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="p">;</span>

	<span class="cm">/* init default and target BSS with some sane initial values */</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">bi</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_bss_info</span><span class="p">));</span>
	<span class="n">bi</span><span class="o">-&gt;</span><span class="n">beacon_period</span> <span class="o">=</span> <span class="n">BEACON_INTERVAL_DEFAULT</span><span class="p">;</span>

	<span class="cm">/* fill the default channel as the first valid channel</span>
<span class="cm">	 * starting from the 2G channels</span>
<span class="cm">	 */</span>
	<span class="n">chanspec</span> <span class="o">=</span> <span class="n">ch20mhz_chspec</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">home_chanspec</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">chanspec</span> <span class="o">=</span> <span class="n">chanspec</span><span class="p">;</span>

	<span class="cm">/* find the band of our default channel */</span>
	<span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span> <span class="o">!=</span> <span class="n">chspec_bandunit</span><span class="p">(</span><span class="n">chanspec</span><span class="p">))</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">OTHERBANDUNIT</span><span class="p">(</span><span class="n">wlc</span><span class="p">)];</span>

	<span class="cm">/* init bss rates to the band specific default rate set */</span>
	<span class="n">brcms_c_rateset_default</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">phytype</span><span class="p">,</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">BRCMS_RATE_MASK_FULL</span><span class="p">,</span>
		<span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">&amp;</span> <span class="n">SUPPORT_11N</span><span class="p">),</span>
		<span class="n">brcms_chspec_bw</span><span class="p">(</span><span class="n">chanspec</span><span class="p">),</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txstreams</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">&amp;</span> <span class="n">SUPPORT_11N</span><span class="p">)</span>
		<span class="n">bi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BRCMS_BSS_HT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">brcms_txq_info</span> <span class="o">*</span><span class="nf">brcms_c_txq_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_txq_info</span> <span class="o">*</span><span class="n">qi</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">qi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_txq_info</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qi</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Have enough room for control packets along with HI watermark</span>
<span class="cm">		 * Also, add room to txq for total psq packets if all the SCBs</span>
<span class="cm">		 * leave PS mode. The watermark for flowcontrol to OS packets</span>
<span class="cm">		 * will remain the same</span>
<span class="cm">		 */</span>
		<span class="n">brcmu_pktq_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">BRCMS_PREC_COUNT</span><span class="p">,</span>
			  <span class="mi">2</span> <span class="o">*</span> <span class="n">BRCMS_DATAHIWAT</span> <span class="o">+</span> <span class="n">PKTQ_LEN_DEFAULT</span><span class="p">);</span>

		<span class="cm">/* add this queue to the the global list */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_queues</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_queues</span> <span class="o">=</span> <span class="n">qi</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">qi</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">qi</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_txq_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">brcms_txq_info</span> <span class="o">*</span><span class="n">qi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_txq_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* remove the queue from the linked list */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_queues</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">qi</span><span class="p">)</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_queues</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">qi</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">qi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_update_mimo_band_bwcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bwcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_band</span> <span class="o">*</span><span class="n">band</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">bwcap</span> <span class="o">==</span> <span class="n">BRCMS_N_BW_40ALL</span><span class="p">)</span>
			    <span class="o">||</span> <span class="p">(</span><span class="n">bwcap</span> <span class="o">==</span> <span class="n">BRCMS_N_BW_20IN2G_40IN5G</span><span class="p">))</span>
				<span class="n">band</span><span class="o">-&gt;</span><span class="n">mimo_cap_40</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">band</span><span class="o">-&gt;</span><span class="n">mimo_cap_40</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bwcap</span> <span class="o">==</span> <span class="n">BRCMS_N_BW_40ALL</span><span class="p">)</span>
				<span class="n">band</span><span class="o">-&gt;</span><span class="n">mimo_cap_40</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">band</span><span class="o">-&gt;</span><span class="n">mimo_cap_40</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_timers_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* free timer state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wdtimer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_free_timer</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wdtimer</span><span class="p">);</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wdtimer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">radio_timer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_free_timer</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">radio_timer</span><span class="p">);</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">radio_timer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_detach_module</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">asi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_c_antsel_detach</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">asi</span><span class="p">);</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">asi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ampdu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_c_ampdu_detach</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ampdu</span><span class="p">);</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ampdu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">brcms_c_stf_detach</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * low level detach</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_b_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_hw_band</span> <span class="o">*</span><span class="n">band</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">callbacks</span><span class="p">;</span>

	<span class="n">callbacks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">brcms_b_detach_dmapio</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>

	<span class="n">band</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">_nbands</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Detach this band&#39;s phy */</span>
			<span class="n">wlc_phy_detach</span><span class="p">(</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">);</span>
			<span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">OTHERBANDUNIT</span><span class="p">(</span><span class="n">wlc</span><span class="p">)];</span>
	<span class="p">}</span>

	<span class="cm">/* Free shared phy state */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">phy_sh</span><span class="p">);</span>

	<span class="n">wlc_phy_shim_detach</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">physhim</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ai_detach</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">callbacks</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return a count of the number of driver callbacks still pending.</span>
<span class="cm"> *</span>
<span class="cm"> * General policy is that brcms_c_detach can only dealloc/free software states.</span>
<span class="cm"> * It can NOT touch hardware registers since the d11core may be in reset and</span>
<span class="cm"> * clock may not be available.</span>
<span class="cm"> * One exception is sb register access, which is possible if crystal is turned</span>
<span class="cm"> * on after &quot;down&quot; state, driver should avoid software timer with the exception</span>
<span class="cm"> * of radio_monitor.</span>
<span class="cm"> */</span>
<span class="n">uint</span> <span class="nf">brcms_c_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="n">callbacks</span> <span class="o">+=</span> <span class="n">brcms_b_detach</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* delete software timers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_c_radio_monitor_stop</span><span class="p">(</span><span class="n">wlc</span><span class="p">))</span>
		<span class="n">callbacks</span><span class="o">++</span><span class="p">;</span>

	<span class="n">brcms_c_channel_mgr_detach</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">);</span>

	<span class="n">brcms_c_timers_deinit</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="n">brcms_c_detach_module</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>


	<span class="k">while</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_queues</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">brcms_c_txq_free</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_queues</span><span class="p">);</span>

	<span class="n">brcms_c_detach_mfree</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">callbacks</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* update state that depends on the current value of &quot;ap&quot; */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_ap_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* STA-BSS; short capable */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">PLCPHdr_override</span> <span class="o">=</span> <span class="n">BRCMS_PLCP_SHORT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize just the hardware when coming out of POR or S3/S5 system states */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_b_hw_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">hw_up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable pll and xtal, initialize the power control registers,</span>
<span class="cm">	 * and force fastclock for the remainder of brcms_c_up().</span>
<span class="cm">	 */</span>
	<span class="n">brcms_b_xtal</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">ai_clkctl_init</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>
	<span class="n">brcms_b_clkctl_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BCMA_CLKMODE_FAST</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: test suspend/resume</span>
<span class="cm">	 *</span>
<span class="cm">	 * AI chip doesn&#39;t restore bar0win2 on</span>
<span class="cm">	 * hibernation/resume, need sw fixup</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Inform phy that a POR reset has occurred so</span>
<span class="cm">	 * it does a complete phy init</span>
<span class="cm">	 */</span>
	<span class="n">wlc_phy_por_inform</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">);</span>

	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">ucode_loaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">hw_up</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardflags</span> <span class="o">&amp;</span> <span class="n">BFL_FEM</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ai_get_chip_id</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">)</span> <span class="o">==</span> <span class="n">BCM4313_CHIP_ID</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
		    <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardrev</span> <span class="o">&gt;=</span> <span class="mh">0x1250</span>
		     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">boardflags</span> <span class="o">&amp;</span> <span class="n">BFL_FEM_BT</span><span class="p">)))</span>
			<span class="n">ai_epa_4313war</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_b_up_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable pll and xtal, initialize the power control registers,</span>
<span class="cm">	 * and force fastclock for the remainder of brcms_c_up().</span>
<span class="cm">	 */</span>
	<span class="n">brcms_b_xtal</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">ai_clkctl_init</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>
	<span class="n">brcms_b_clkctl_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BCMA_CLKMODE_FAST</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure pci/pcmcia here instead of in brcms_c_attach()</span>
<span class="cm">	 * to allow mfg hotswap:  down, hotswap (chip power cycle), up.</span>
<span class="cm">	 */</span>
	<span class="n">bcma_core_pci_irq_ctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">drv_pci</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
			      <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Need to read the hwradio status here to cover the case where the</span>
<span class="cm">	 * system is loaded with the hw radio disabled. We do not want to</span>
<span class="cm">	 * bring the driver up in this case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcms_b_radio_read_hwdisabled</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* put SB PCI in down state again */</span>
		<span class="n">ai_pci_down</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>
		<span class="n">brcms_b_xtal</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ai_pci_up</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>

	<span class="cm">/* reset the d11 core */</span>
	<span class="n">brcms_b_corereset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BRCMS_USE_COREFLAGS</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_b_up_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">wlc_phy_hw_state_upd</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* FULLY enable dynamic power control and d11 core interrupt */</span>
	<span class="n">brcms_b_clkctl_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BCMA_CLKMODE_DYNAMIC</span><span class="p">);</span>
	<span class="n">brcms_intrson</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write WME tunable parameters for retransmit/max rate</span>
<span class="cm"> * from wlc struct to ucode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_wme_retries_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ac</span><span class="p">;</span>

	<span class="cm">/* Need clock to do this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ac</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_ACS</span><span class="p">;</span> <span class="n">ac</span><span class="o">++</span><span class="p">)</span>
		<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_AC_TXLMT_ADDR</span><span class="p">(</span><span class="n">ac</span><span class="p">),</span>
				  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wme_retries</span><span class="p">[</span><span class="n">ac</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* make interface operational */</span>
<span class="kt">int</span> <span class="nf">brcms_c_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="cm">/* HW is turned off so don&#39;t try to access it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">hw_off</span> <span class="o">||</span> <span class="n">brcms_deviceremoved</span><span class="p">(</span><span class="n">wlc</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">hw_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_b_hw_up</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">hw_up</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">boardflags</span> <span class="o">&amp;</span> <span class="n">BFL_FEM</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ai_get_chip_id</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">)</span> <span class="o">==</span> <span class="n">BCM4313_CHIP_ID</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">boardrev</span> <span class="o">&gt;=</span> <span class="mh">0x1250</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">boardflags</span> <span class="o">&amp;</span> <span class="n">BFL_FEM_BT</span><span class="p">))</span>
			<span class="n">brcms_b_mhf</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MHF5</span><span class="p">,</span> <span class="n">MHF5_4313_GPIOCTRL</span><span class="p">,</span>
				<span class="n">MHF5_4313_GPIOCTRL</span><span class="p">,</span> <span class="n">BRCM_BAND_ALL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">brcms_b_mhf</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MHF4</span><span class="p">,</span> <span class="n">MHF4_EXTPA_ENABLE</span><span class="p">,</span>
				    <span class="n">MHF4_EXTPA_ENABLE</span><span class="p">,</span> <span class="n">BRCM_BAND_ALL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Need to read the hwradio status here to cover the case where the</span>
<span class="cm">	 * system is loaded with the hw radio disabled. We do not want to bring</span>
<span class="cm">	 * the driver up in this case. If radio is disabled, abort up, lower</span>
<span class="cm">	 * power, start radio timer and return 0(for NDIS) don&#39;t call</span>
<span class="cm">	 * radio_update to avoid looping brcms_c_up.</span>
<span class="cm">	 *</span>
<span class="cm">	 * brcms_b_up_prep() returns either 0 or -BCME_RADIOOFF only</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">radio_disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">brcms_b_up_prep</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mboolisset</span>
			    <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">radio_disabled</span><span class="p">,</span> <span class="n">WL_RADIO_HW_DISABLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">brcms_bss_cfg</span> <span class="o">*</span><span class="n">bsscfg</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="p">;</span>
				<span class="n">mboolset</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">radio_disabled</span><span class="p">,</span>
					 <span class="n">WL_RADIO_HW_DISABLE</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">BSS</span><span class="p">)</span>
					<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: up&quot;</span>
						  <span class="s">&quot;: rfdisable -&gt; &quot;</span>
						  <span class="s">&quot;bsscfg_disable()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						   <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">radio_disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_c_radio_monitor_start</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* brcms_b_up_prep has done brcms_c_corereset(). so clk is on, set it */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">brcms_c_radio_monitor_stop</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* Set EDCF hostflags */</span>
	<span class="n">brcms_b_mhf</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MHF1</span><span class="p">,</span> <span class="n">MHF1_EDCF</span><span class="p">,</span> <span class="n">MHF1_EDCF</span><span class="p">,</span> <span class="n">BRCM_BAND_ALL</span><span class="p">);</span>

	<span class="n">brcms_init</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandinit_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_c_suspend_mac_and_wait</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
		<span class="n">brcms_c_set_chanspec</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">);</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandinit_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">brcms_c_enable_mac</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">brcms_b_up_finish</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Program the TX wme params with the current settings */</span>
	<span class="n">brcms_c_wme_retries_write</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* start one second watchdog timer */</span>
	<span class="n">brcms_add_timer</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wdtimer</span><span class="p">,</span> <span class="n">TIMER_INTERVAL_WATCHDOG</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">WDarmed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* ensure antenna config is up to date */</span>
	<span class="n">brcms_c_stf_phy_txant_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="cm">/* ensure LDPC config is in sync */</span>
	<span class="n">brcms_c_ht_update_ldpc</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">ldpc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">brcms_c_down_del_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">callbacks</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_b_bmac_down_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">dev_gone</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">callbacks</span><span class="p">;</span>

	<span class="n">dev_gone</span> <span class="o">=</span> <span class="n">brcms_deviceremoved</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_gone</span><span class="p">)</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* now disable interrupts */</span>
		<span class="n">brcms_intrsoff</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>

		<span class="cm">/* ensure we&#39;re running on the pll clock again */</span>
		<span class="n">brcms_b_clkctl_clk</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">BCMA_CLKMODE_FAST</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* down phy at the last of this stage */</span>
	<span class="n">callbacks</span> <span class="o">+=</span> <span class="n">wlc_phy_down</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">callbacks</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_b_down_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">dev_gone</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">callbacks</span><span class="p">;</span>

	<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wlc_phy_hw_state_upd</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">dev_gone</span> <span class="o">=</span> <span class="n">brcms_deviceremoved</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_gone</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sbclk</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">wlc_phy_hw_clk_state_upd</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/* reclaim any posted packets */</span>
		<span class="n">brcms_c_flushqueues</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* Reset and disable the core */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcma_core_is_enabled</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bcma_read32</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">,</span>
					<span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccontrol</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">MCTL_EN_MAC</span><span class="p">)</span>
				<span class="n">brcms_c_suspend_mac_and_wait</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
			<span class="n">callbacks</span> <span class="o">+=</span> <span class="n">brcms_reset</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
			<span class="n">brcms_c_coredisable</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* turn off primary xtal and pll */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">noreset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ai_pci_down</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">);</span>
			<span class="n">brcms_b_xtal</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">callbacks</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Mark the interface nonoperational, stop the software mechanisms,</span>
<span class="cm"> * disable the hardware, free any transient buffer state.</span>
<span class="cm"> * Return a count of the number of driver callbacks still pending.</span>
<span class="cm"> */</span>
<span class="n">uint</span> <span class="nf">brcms_c_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">uint</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">dev_gone</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_txq_info</span> <span class="o">*</span><span class="n">qi</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="cm">/* check if we are already in the going down path */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">going_down</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: Driver going down so return&quot;</span>
			  <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">callbacks</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">going_down</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">callbacks</span> <span class="o">+=</span> <span class="n">brcms_b_bmac_down_prep</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">dev_gone</span> <span class="o">=</span> <span class="n">brcms_deviceremoved</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* Call any registered down handlers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_MAXMODULES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">down_fn</span><span class="p">)</span>
			<span class="n">callbacks</span> <span class="o">+=</span>
			    <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">down_fn</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hdl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* cancel the watchdog timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">WDarmed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_del_timer</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wdtimer</span><span class="p">))</span>
			<span class="n">callbacks</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">WDarmed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* cancel all other timers */</span>
	<span class="n">callbacks</span> <span class="o">+=</span> <span class="n">brcms_c_down_del_timer</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">wlc_phy_mute_upd</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">PHY_MUTE_ALL</span><span class="p">);</span>

	<span class="cm">/* clear txq flow control */</span>
	<span class="n">brcms_c_txflowcontrol_reset</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* flush tx queues */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">qi</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_queues</span><span class="p">;</span> <span class="n">qi</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">qi</span> <span class="o">=</span> <span class="n">qi</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">brcmu_pktq_flush</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">callbacks</span> <span class="o">+=</span> <span class="n">brcms_b_down_finish</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* brcms_b_down_finish has done brcms_c_coredisable(). so clk is off */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">going_down</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">callbacks</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set the current gmode configuration */</span>
<span class="kt">int</span> <span class="nf">brcms_c_set_gmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">gmode</span><span class="p">,</span> <span class="n">bool</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="n">rs</span><span class="p">;</span>
	<span class="cm">/* Default to 54g Auto */</span>
	<span class="cm">/* Advertise and use shortslot (-1/0/1 Auto/Off/On) */</span>
	<span class="n">s8</span> <span class="n">shortslot</span> <span class="o">=</span> <span class="n">BRCMS_SHORTSLOT_AUTO</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">shortslot_restrict</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* Restrict association to stations</span>
<span class="cm">					  * that support shortslot</span>
<span class="cm">					  */</span>
	<span class="n">bool</span> <span class="n">ofdm_basic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* Make 6, 12, and 24 basic rates */</span>
	<span class="cm">/* Advertise and use short preambles (-1/0/1 Auto/Off/On) */</span>
	<span class="kt">int</span> <span class="n">preamble</span> <span class="o">=</span> <span class="n">BRCMS_PLCP_LONG</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">preamble_restrict</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* Restrict association to stations</span>
<span class="cm">					 * that support short preambles</span>
<span class="cm">					 */</span>
	<span class="k">struct</span> <span class="n">brcms_band</span> <span class="o">*</span><span class="n">band</span><span class="p">;</span>

	<span class="cm">/* if N-support is enabled, allow Gmode set as long as requested</span>
<span class="cm">	 * Gmode is not GMODE_LEGACY_B</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">&amp;</span> <span class="n">SUPPORT_11N</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">gmode</span> <span class="o">==</span> <span class="n">GMODE_LEGACY_B</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="cm">/* verify that we are dealing with 2G band and grab the band pointer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span><span class="p">)</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">OTHERBANDUNIT</span><span class="p">(</span><span class="n">wlc</span><span class="p">)]</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span><span class="p">))</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">OTHERBANDUNIT</span><span class="p">(</span><span class="n">wlc</span><span class="p">)];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Legacy or bust when no OFDM is supported by regulatory */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">brcms_c_channel_locale_flags_in_band</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">)</span> <span class="o">&amp;</span>
	     <span class="n">BRCMS_NO_OFDM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gmode</span> <span class="o">!=</span> <span class="n">GMODE_LEGACY_B</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* update configuration value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="p">)</span>
		<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_G_USER</span><span class="p">,</span> <span class="n">gmode</span><span class="p">);</span>

	<span class="cm">/* Clear rateset override */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_rateset</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">gmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GMODE_LEGACY_B</span>:
		<span class="n">shortslot</span> <span class="o">=</span> <span class="n">BRCMS_SHORTSLOT_OFF</span><span class="p">;</span>
		<span class="n">brcms_c_rateset_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gphy_legacy_rates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GMODE_LRS</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GMODE_AUTO</span>:
		<span class="cm">/* Accept defaults */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GMODE_ONLY</span>:
		<span class="n">ofdm_basic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">preamble</span> <span class="o">=</span> <span class="n">BRCMS_PLCP_SHORT</span><span class="p">;</span>
		<span class="n">preamble_restrict</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GMODE_PERFORMANCE</span>:
		<span class="n">shortslot</span> <span class="o">=</span> <span class="n">BRCMS_SHORTSLOT_ON</span><span class="p">;</span>
		<span class="n">shortslot_restrict</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ofdm_basic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">preamble</span> <span class="o">=</span> <span class="n">BRCMS_PLCP_SHORT</span><span class="p">;</span>
		<span class="n">preamble_restrict</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* Error */</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: invalid gmode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">gmode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">band</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">=</span> <span class="n">gmode</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">shortslot_override</span> <span class="o">=</span> <span class="n">shortslot</span><span class="p">;</span>

	<span class="cm">/* Use the default 11g rateset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
		<span class="n">brcms_c_rateset_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cck_ofdm_rates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_basic</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">BRCM_RATE_6M</span>
			    <span class="o">||</span> <span class="n">rs</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">BRCM_RATE_12M</span>
			    <span class="o">||</span> <span class="n">rs</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">BRCM_RATE_24M</span><span class="p">)</span>
				<span class="n">rs</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BRCMS_RATE_FLAG</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set default bss rateset */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">.</span><span class="n">rates</span><span class="p">,</span> <span class="n">rs</span><span class="p">.</span><span class="n">rates</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">.</span><span class="n">rates</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcms_c_set_nmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">nmode</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txstreams</span> <span class="o">==</span> <span class="n">WL_11N_3x3</span><span class="p">)</span>
		<span class="n">nmode</span> <span class="o">=</span> <span class="n">WL_11N_3x3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nmode</span> <span class="o">=</span> <span class="n">WL_11N_2x2</span><span class="p">;</span>

	<span class="cm">/* force GMODE_AUTO if NMODE is ON */</span>
	<span class="n">brcms_c_set_gmode</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">GMODE_AUTO</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nmode</span> <span class="o">==</span> <span class="n">WL_11N_3x3</span><span class="p">)</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">=</span> <span class="n">SUPPORT_HT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">=</span> <span class="n">SUPPORT_11N</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BRCMS_BSS_HT</span><span class="p">;</span>
	<span class="cm">/* add the mcs rates to the default and hw ratesets */</span>
	<span class="n">brcms_c_rateset_mcs_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">,</span>
			      <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txstreams</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hw_rateset</span><span class="p">.</span><span class="n">mcs</span><span class="p">,</span>
		       <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">.</span><span class="n">mcs</span><span class="p">,</span> <span class="n">MCSSET_LEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcms_c_set_internal_rateset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="o">*</span><span class="n">rs_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="n">rs</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">bandunit</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span> <span class="n">rs_arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_rateset</span><span class="p">));</span>

	<span class="cm">/* check for bad count value */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rs</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">BRCMS_NUMRATES</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* try the current band */</span>
	<span class="n">bandunit</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_rateset</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcms_c_rate_hwrs_filter_sort_validate</span>
	    <span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">bandunit</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hw_rateset</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
	     <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txstreams</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">good</span><span class="p">;</span>

	<span class="cm">/* try the other band */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcms_is_mband_unlocked</span><span class="p">(</span><span class="n">wlc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bandunit</span> <span class="o">=</span> <span class="n">OTHERBANDUNIT</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_rateset</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brcms_c_rate_hwrs_filter_sort_validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span>
						       <span class="n">bandstate</span><span class="p">[</span><span class="n">bandunit</span><span class="p">]</span><span class="o">-&gt;</span>
						       <span class="n">hw_rateset</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
						       <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txstreams</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">good</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">;</span>

 <span class="nl">good:</span>
	<span class="cm">/* apply new rateset */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_rateset</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">bandunit</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">defrateset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_rateset</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_ofdm_rateset_war</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">war</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">associated</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">current_bss</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">wlc_phy_ofdm_rateset_war</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">war</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcms_c_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">chspec</span> <span class="o">=</span> <span class="n">ch20mhz_chspec</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="n">MAXCHANNEL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_c_valid_chanspec_db</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">,</span> <span class="n">chspec</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">&amp;&amp;</span> <span class="n">brcms_is_mband_unlocked</span><span class="p">(</span><span class="n">wlc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span> <span class="o">!=</span> <span class="n">chspec_bandunit</span><span class="p">(</span><span class="n">chspec</span><span class="p">))</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandinit_pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandinit_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">chanspec</span> <span class="o">=</span> <span class="n">chspec</span><span class="p">;</span>
	<span class="cm">/* brcms_c_BSSinit() will sanitize the rateset before</span>
<span class="cm">	 * using it.. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wlc_phy_chanspec_get</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">)</span> <span class="o">!=</span> <span class="n">chspec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcms_c_set_home_chanspec</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">chspec</span><span class="p">);</span>
		<span class="n">brcms_c_suspend_mac_and_wait</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
		<span class="n">brcms_c_set_chanspec</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">chspec</span><span class="p">);</span>
		<span class="n">brcms_c_enable_mac</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcms_c_set_rate_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">srl</span><span class="p">,</span> <span class="n">u16</span> <span class="n">lrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ac</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srl</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">srl</span> <span class="o">&gt;</span> <span class="n">RETRY_SHORT_MAX</span> <span class="o">||</span>
	    <span class="n">lrl</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">lrl</span> <span class="o">&gt;</span> <span class="n">RETRY_SHORT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">SRL</span> <span class="o">=</span> <span class="n">srl</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">LRL</span> <span class="o">=</span> <span class="n">lrl</span><span class="p">;</span>

	<span class="n">brcms_b_retrylimit_upd</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">SRL</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">LRL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ac</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_ACS</span><span class="p">;</span> <span class="n">ac</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wme_retries</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">=</span>	<span class="n">SFIELD</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wme_retries</span><span class="p">[</span><span class="n">ac</span><span class="p">],</span>
					       <span class="n">EDCF_SHORT</span><span class="p">,</span>  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">SRL</span><span class="p">);</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wme_retries</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">=</span>	<span class="n">SFIELD</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wme_retries</span><span class="p">[</span><span class="n">ac</span><span class="p">],</span>
					       <span class="n">EDCF_LONG</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">LRL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">brcms_c_wme_retries_write</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_get_current_rateset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">brcm_rateset</span> <span class="o">*</span><span class="n">currs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="o">*</span><span class="n">rs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">associated</span><span class="p">)</span>
		<span class="n">rs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">current_bss</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">;</span>

	<span class="cm">/* Copy only legacy rateset section */</span>
	<span class="n">currs</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">currs</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcms_c_set_rateset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcm_rateset</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="n">internal_rs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bcmerror</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">BRCMS_NUMRATES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">internal_rs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_rateset</span><span class="p">));</span>

	<span class="cm">/* Copy only legacy rateset section */</span>
	<span class="n">internal_rs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">internal_rs</span><span class="p">.</span><span class="n">rates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">internal_rs</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>

	<span class="cm">/* merge rateset coming in with the current mcsset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">&amp;</span> <span class="n">SUPPORT_11N</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">brcms_bss_info</span> <span class="o">*</span><span class="n">mcsset_bss</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">associated</span><span class="p">)</span>
			<span class="n">mcsset_bss</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">current_bss</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mcsset_bss</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">internal_rs</span><span class="p">.</span><span class="n">mcs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcsset_bss</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">.</span><span class="n">mcs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		       <span class="n">MCSSET_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bcmerror</span> <span class="o">=</span> <span class="n">brcms_c_set_internal_rateset</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_rs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcmerror</span><span class="p">)</span>
		<span class="n">brcms_c_ofdm_rateset_war</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bcmerror</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcms_c_set_beacon_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">period</span> <span class="o">&lt;</span> <span class="n">DOT11_MIN_BEACON_PERIOD</span> <span class="o">||</span>
	    <span class="n">period</span> <span class="o">&gt;</span> <span class="n">DOT11_MAX_BEACON_PERIOD</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">default_bss</span><span class="o">-&gt;</span><span class="n">beacon_period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">brcms_c_get_phy_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phyidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">phytype</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_set_shortslot_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">s8</span> <span class="n">sslot_override</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">shortslot_override</span> <span class="o">=</span> <span class="n">sslot_override</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * shortslot is an 11g feature, so no more work if we are</span>
<span class="cm">	 * currently on the 5G band</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">&amp;&amp;</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">associated</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* let watchdog or beacon processing update shortslot */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unassociated shortslot is off */</span>
		<span class="n">brcms_c_switch_shortslot</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* driver is down, so just update the brcms_c_info</span>
<span class="cm">		 * value */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">shortslot_override</span> <span class="o">==</span> <span class="n">BRCMS_SHORTSLOT_AUTO</span><span class="p">)</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">shortslot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">shortslot</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">shortslot_override</span> <span class="o">==</span>
			     <span class="n">BRCMS_SHORTSLOT_ON</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * register watchdog and down handlers.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">brcms_c_module_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">d_fn</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">pub</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* find an empty entry and just add, no duplication check! */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_MAXMODULES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hdl</span> <span class="o">=</span> <span class="n">hdl</span><span class="p">;</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">down_fn</span> <span class="o">=</span> <span class="n">d_fn</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* unregister module callbacks */</span>
<span class="kt">int</span> <span class="nf">brcms_c_module_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">hdl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">pub</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BRCMS_MAXMODULES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hdl</span> <span class="o">==</span> <span class="n">hdl</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">modulecb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">modulecb</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* table not found! */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_print_txstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_status</span> <span class="o">*</span><span class="n">txs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">txpkt (MPDU) Complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;FrameID: %04x   TxStatus: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txs</span><span class="o">-&gt;</span><span class="n">frameid</span><span class="p">,</span> <span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;[15:12]  %d  frame attempts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_FRM_RTX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		 <span class="n">TX_STATUS_FRM_RTX_SHIFT</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; [11:8]  %d  rts attempts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_RTS_RTX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		 <span class="n">TX_STATUS_RTS_RTX_SHIFT</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;    [7]  %d  PM mode indicated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_PMINDCTD</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;    [6]  %d  intermediate status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_INTERMEDIATE</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;    [5]  %d  AMPDU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_AMPDU</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  [4:2]  %d  Frame Suppressed Reason (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_SUPR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TX_STATUS_SUPR_SHIFT</span><span class="p">,</span>
		 <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">[])</span> <span class="p">{</span>
			<span class="s">&quot;None&quot;</span><span class="p">,</span>
			<span class="s">&quot;PMQ Entry&quot;</span><span class="p">,</span>
			<span class="s">&quot;Flush request&quot;</span><span class="p">,</span>
			<span class="s">&quot;Previous frag failure&quot;</span><span class="p">,</span>
			<span class="s">&quot;Channel mismatch&quot;</span><span class="p">,</span>
			<span class="s">&quot;Lifetime Expiry&quot;</span><span class="p">,</span>
			<span class="s">&quot;Underflow&quot;</span>
		 <span class="p">}</span> <span class="p">[(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_SUPR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		    <span class="n">TX_STATUS_SUPR_SHIFT</span><span class="p">]);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;    [1]  %d  acked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">txs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_ACK_RCV</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;LastTxTime: %04x Seq: %04x PHYTxStatus: %04x RxAckRSSI: %04x RxAckSQ: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">txs</span><span class="o">-&gt;</span><span class="n">lasttxtime</span><span class="p">,</span> <span class="n">txs</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">,</span> <span class="n">txs</span><span class="o">-&gt;</span><span class="n">phyerr</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">ackphyrxsh</span> <span class="o">&amp;</span> <span class="n">PRXS1_JSSI_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PRXS1_JSSI_SHIFT</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">ackphyrxsh</span> <span class="o">&amp;</span> <span class="n">PRXS1_SQ_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PRXS1_SQ_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">brcms_c_chipmatch</span><span class="p">(</span><span class="n">u16</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unknown vendor id %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vendor</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">BCM43224_D11N_ID_VEN1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">device</span> <span class="o">==</span> <span class="n">BCM43224_D11N_ID</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">BCM43225_D11N2G_ID</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">BCM4313_D11N2G_ID</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">device</span> <span class="o">==</span> <span class="n">BCM43236_D11N_ID</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">BCM43236_D11N2G_ID</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unknown device id %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(DEBUG)</span>
<span class="kt">void</span> <span class="nf">brcms_c_print_txdesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">d11txh</span> <span class="o">*</span><span class="n">txh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">mtcl</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">MacTxControlLow</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mtch</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">MacTxControlHigh</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mfc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">MacFrameControl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">tfest</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFesTimeNormal</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">ptcw</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">PhyTxControlWord</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">ptcw_1</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">PhyTxControlWord_1</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">ptcw_1_Fbr</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">PhyTxControlWord_1_Fbr</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">ptcw_1_Rts</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">PhyTxControlWord_1_Rts</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">ptcw_1_FbrRts</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">PhyTxControlWord_1_FbrRts</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mainrates</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">MainRates</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">xtraft</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">XtraFrameTypes</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">iv</span> <span class="o">=</span> <span class="n">txh</span><span class="o">-&gt;</span><span class="n">IV</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ra</span> <span class="o">=</span> <span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFrameRA</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tfestfb</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFesTimeFallback</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rtspfb</span> <span class="o">=</span> <span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSPLCPFallback</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rtsdfb</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSDurFallback</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">fragpfb</span> <span class="o">=</span> <span class="n">txh</span><span class="o">-&gt;</span><span class="n">FragPLCPFallback</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fragdfb</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">FragDurFallback</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mmodelen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">MModeLen</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mmodefbrlen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">MModeFbrLen</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">tfid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFrameID</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">txs</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxStatus</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mnmpdu</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">MaxNMpdus</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mabyte</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">MaxABytes_MRT</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mabyte_f</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">MaxABytes_FBR</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mmbyte</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">MinMBytes</span><span class="p">);</span>

	<span class="n">u8</span> <span class="o">*</span><span class="n">rtsph</span> <span class="o">=</span> <span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSPhyHeader</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rts</span> <span class="n">rts</span> <span class="o">=</span> <span class="n">txh</span><span class="o">-&gt;</span><span class="n">rts_frame</span><span class="p">;</span>

	<span class="cm">/* add plcp header along with txh descriptor */</span>
	<span class="n">brcmu_dbg_hex_dump</span><span class="p">(</span><span class="n">txh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d11txh</span><span class="p">)</span> <span class="o">+</span> <span class="mi">48</span><span class="p">,</span>
			   <span class="s">&quot;Raw TxDesc + plcp header:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;TxCtlLow: %04x &quot;</span><span class="p">,</span> <span class="n">mtcl</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;TxCtlHigh: %04x &quot;</span><span class="p">,</span> <span class="n">mtch</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;FC: %04x &quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;FES Time: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tfest</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PhyCtl: %04x%s &quot;</span><span class="p">,</span> <span class="n">ptcw</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">ptcw</span> <span class="o">&amp;</span> <span class="n">PHY_TXC_SHORT_HDR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; short&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PhyCtl_1: %04x &quot;</span><span class="p">,</span> <span class="n">ptcw_1</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PhyCtl_1_Fbr: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptcw_1_Fbr</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PhyCtl_1_Rts: %04x &quot;</span><span class="p">,</span> <span class="n">ptcw_1_Rts</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PhyCtl_1_Fbr_Rts: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptcw_1_FbrRts</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MainRates: %04x &quot;</span><span class="p">,</span> <span class="n">mainrates</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;XtraFrameTypes: %04x &quot;</span><span class="p">,</span> <span class="n">xtraft</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;SecIV:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">IV</span><span class="p">));</span>
	<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;RA:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
			     <span class="n">ra</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFrameRA</span><span class="p">));</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Fb FES Time: %04x &quot;</span><span class="p">,</span> <span class="n">tfestfb</span><span class="p">);</span>
	<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;Fb RTS PLCP:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
			     <span class="n">rtspfb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSPLCPFallback</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RTS DUR: %04x &quot;</span><span class="p">,</span> <span class="n">rtsdfb</span><span class="p">);</span>
	<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;PLCP:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
			     <span class="n">fragpfb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">FragPLCPFallback</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;DUR: %04x&quot;</span><span class="p">,</span> <span class="n">fragdfb</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MModeLen: %04x &quot;</span><span class="p">,</span> <span class="n">mmodelen</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MModeFbrLen: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmodefbrlen</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;FrameID:     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tfid</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;TxStatus:    %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txs</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MaxNumMpdu:  %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mnmpdu</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MaxAggbyte:  %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mabyte</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MaxAggbyte_fb:  %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mabyte_f</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MinByte:     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmbyte</span><span class="p">);</span>

	<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;RTS PLCP:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
			     <span class="n">rtsph</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSPhyHeader</span><span class="p">));</span>
	<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;RTS Frame:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rts</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">rts_frame</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* defined(DEBUG) */</span><span class="cp"></span>

<span class="cp">#if defined(DEBUG)</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcms_c_format_flags</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_c_bit_desc</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">hexstr</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">slen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bit</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* print any unnamed bits */</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">hexstr</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;0x%X&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">hexstr</span><span class="p">;</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* exit loop */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span>
		<span class="n">nlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
		<span class="n">slen</span> <span class="o">+=</span> <span class="n">nlen</span><span class="p">;</span>
		<span class="cm">/* count btwn flag space */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">slen</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* need NULL char as well */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">slen</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* copy NULL char but don&#39;t count it */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">nlen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">nlen</span><span class="p">;</span>
		<span class="cm">/* copy btwn flag space and NULL char */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">slen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* indicate the str was too short */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>	<span class="cm">/* overwrite last char */</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">p</span> <span class="o">-</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* defined(DEBUG) */</span><span class="cp"></span>

<span class="cp">#if defined(DEBUG)</span>
<span class="kt">void</span> <span class="nf">brcms_c_print_rxh</span><span class="p">(</span><span class="k">struct</span> <span class="n">d11rxhdr</span> <span class="o">*</span><span class="n">rxh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">len</span> <span class="o">=</span> <span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxFrameSize</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phystatus_0</span> <span class="o">=</span> <span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phystatus_1</span> <span class="o">=</span> <span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phystatus_2</span> <span class="o">=</span> <span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phystatus_3</span> <span class="o">=</span> <span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_3</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">macstatus1</span> <span class="o">=</span> <span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxStatus1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">macstatus2</span> <span class="o">=</span> <span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxStatus2</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">flagstr</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">lenbuf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_c_bit_desc</span> <span class="n">macstat_flags</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">RXS_FCSERR</span><span class="p">,</span> <span class="s">&quot;FCSErr&quot;</span><span class="p">},</span>
		<span class="p">{</span><span class="n">RXS_RESPFRAMETX</span><span class="p">,</span> <span class="s">&quot;Reply&quot;</span><span class="p">},</span>
		<span class="p">{</span><span class="n">RXS_PBPRES</span><span class="p">,</span> <span class="s">&quot;PADDING&quot;</span><span class="p">},</span>
		<span class="p">{</span><span class="n">RXS_DECATMPT</span><span class="p">,</span> <span class="s">&quot;DeCr&quot;</span><span class="p">},</span>
		<span class="p">{</span><span class="n">RXS_DECERR</span><span class="p">,</span> <span class="s">&quot;DeCrErr&quot;</span><span class="p">},</span>
		<span class="p">{</span><span class="n">RXS_BCNSENT</span><span class="p">,</span> <span class="s">&quot;Bcn&quot;</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="n">brcmu_dbg_hex_dump</span><span class="p">(</span><span class="n">rxh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d11rxhdr</span><span class="p">),</span> <span class="s">&quot;Raw RxDesc:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">brcms_c_format_flags</span><span class="p">(</span><span class="n">macstat_flags</span><span class="p">,</span> <span class="n">macstatus1</span><span class="p">,</span> <span class="n">flagstr</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">lenbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lenbuf</span><span class="p">),</span> <span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RxFrameSize:     %6s (%d)%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lenbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_0</span> <span class="o">&amp;</span> <span class="n">PRXS0_SHORTH</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; short preamble&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RxPHYStatus:     %04x %04x %04x %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">phystatus_0</span><span class="p">,</span> <span class="n">phystatus_1</span><span class="p">,</span> <span class="n">phystatus_2</span><span class="p">,</span> <span class="n">phystatus_3</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RxMACStatus:     %x %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">macstatus1</span><span class="p">,</span> <span class="n">flagstr</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RXMACaggtype:    %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">macstatus2</span> <span class="o">&amp;</span> <span class="n">RXS_AGGTYPE_MASK</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RxTSFTime:       %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxTSFTime</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* defined(DEBUG) */</span><span class="cp"></span>

<span class="n">u16</span> <span class="nf">brcms_b_rate_shm_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">table_ptr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_rate</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/* get the phy specific rate encoding for the PLCP SIGNAL field */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span>
		<span class="n">table_ptr</span> <span class="o">=</span> <span class="n">M_RT_DIRMAP_A</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">table_ptr</span> <span class="o">=</span> <span class="n">M_RT_DIRMAP_B</span><span class="p">;</span>

	<span class="cm">/* for a given rate, the LS-nibble of the PLCP SIGNAL field is</span>
<span class="cm">	 * the index into the rate table.</span>
<span class="cm">	 */</span>
	<span class="n">phy_rate</span> <span class="o">=</span> <span class="n">rate_info</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BRCMS_RATE_MASK</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">phy_rate</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="cm">/* Find the SHM pointer to the rate table entry by looking in the</span>
<span class="cm">	 * Direct-map Table</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">table_ptr</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">brcms_c_prec_enq_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pktq</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prec</span><span class="p">,</span> <span class="n">bool</span> <span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eprec</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* precedence to evict from */</span>

	<span class="cm">/* Determine precedence from which to evict packet, if any */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pktq_pfull</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">prec</span><span class="p">))</span>
		<span class="n">eprec</span> <span class="o">=</span> <span class="n">prec</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pktq_full</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">brcmu_pktq_peek_tail</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eprec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eprec</span> <span class="o">&gt;</span> <span class="n">prec</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: Failing: eprec %d &gt; prec %d&quot;</span>
				  <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">eprec</span><span class="p">,</span> <span class="n">prec</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Evict if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eprec</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">discard_oldest</span><span class="p">;</span>

		<span class="n">discard_oldest</span> <span class="o">=</span> <span class="n">ac_bitmap_tst</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eprec</span><span class="p">);</span>

		<span class="cm">/* Refuse newer packet unless configured to discard oldest */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eprec</span> <span class="o">==</span> <span class="n">prec</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">discard_oldest</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: No where to go, prec == %d&quot;</span>
				  <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">prec</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Evict packet according to discard policy */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">discard_oldest</span> <span class="o">?</span> <span class="n">brcmu_pktq_pdeq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">eprec</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">brcmu_pktq_pdeq_tail</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">eprec</span><span class="p">);</span>
		<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enqueue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">brcmu_pktq_penq_head</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">brcmu_pktq_penq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Attempts to queue a packet onto a multiple-precedence queue,</span>
<span class="cm"> * if necessary evicting a lower precedence packet from the queue.</span>
<span class="cm"> *</span>
<span class="cm"> * &#39;prec&#39; is the precedence number that has already been mapped</span>
<span class="cm"> * from the packet priority.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if packet consumed (queued), false if not.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_prec_enq</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pktq</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">brcms_c_prec_enq_head</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_txq_enq</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sdu</span><span class="p">,</span> <span class="n">uint</span> <span class="n">prec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_txq_info</span> <span class="o">*</span><span class="n">qi</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pkt_queue</span><span class="p">;</span>	<span class="cm">/* Check me */</span>
	<span class="k">struct</span> <span class="n">pktq</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prio</span><span class="p">;</span>

	<span class="n">prio</span> <span class="o">=</span> <span class="n">sdu</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_c_prec_enq</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">sdu</span><span class="p">,</span> <span class="n">prec</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * we might hit this condtion in case</span>
<span class="cm">		 * packet flooding from mac80211 stack</span>
<span class="cm">		 */</span>
		<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">sdu</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bcmc_fid_generate:</span>
<span class="cm"> * Generate frame ID for a BCMC packet.  The frag field is not used</span>
<span class="cm"> * for MC frames so is used as part of the sequence number.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span>
<span class="nf">bcmc_fid_generate</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcms_bss_cfg</span> <span class="o">*</span><span class="n">bsscfg</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">d11txh</span> <span class="o">*</span><span class="n">txh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">frameid</span><span class="p">;</span>

	<span class="n">frameid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFrameID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TXFID_SEQ_MASK</span> <span class="o">|</span>
						  <span class="n">TXFID_QUEUE_MASK</span><span class="p">);</span>
	<span class="n">frameid</span> <span class="o">|=</span>
	    <span class="p">(((</span><span class="n">wlc</span><span class="o">-&gt;</span>
	       <span class="n">mc_fid_counter</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TXFID_SEQ_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXFID_SEQ_MASK</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">TX_BCMC_FIFO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">frameid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span>
<span class="nf">brcms_c_calc_ack_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rspec</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="n">preamble_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">dur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: rspec 0x%x, preamble_type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">rspec</span><span class="p">,</span> <span class="n">preamble_type</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Spec 9.6: ack rate is the highest rate in BSSBasicRateSet that</span>
<span class="cm">	 * is less than or equal to the rate of the immediately previous</span>
<span class="cm">	 * frame in the FES</span>
<span class="cm">	 */</span>
	<span class="n">rspec</span> <span class="o">=</span> <span class="n">brcms_basic_rate</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">);</span>
	<span class="cm">/* ACK frame len == 14 == 2(fc) + 2(dur) + 6(ra) + 4(fcs) */</span>
	<span class="n">dur</span> <span class="o">=</span>
	    <span class="n">brcms_c_calc_frame_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">,</span> <span class="n">preamble_type</span><span class="p">,</span>
				<span class="p">(</span><span class="n">DOT11_ACK_LEN</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">dur</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span>
<span class="nf">brcms_c_calc_cts_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rspec</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="n">preamble_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: ratespec 0x%x, preamble_type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">rspec</span><span class="p">,</span> <span class="n">preamble_type</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">brcms_c_calc_ack_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">,</span> <span class="n">preamble_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span>
<span class="nf">brcms_c_calc_ba_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rspec</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="n">preamble_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: rspec 0x%x, &quot;</span>
		 <span class="s">&quot;preamble_type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">rspec</span><span class="p">,</span> <span class="n">preamble_type</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Spec 9.6: ack rate is the highest rate in BSSBasicRateSet that</span>
<span class="cm">	 * is less than or equal to the rate of the immediately previous</span>
<span class="cm">	 * frame in the FES</span>
<span class="cm">	 */</span>
	<span class="n">rspec</span> <span class="o">=</span> <span class="n">brcms_basic_rate</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">);</span>
	<span class="cm">/* BA len == 32 == 16(ctl hdr) + 4(ba len) + 8(bitmap) + 4(fcs) */</span>
	<span class="k">return</span> <span class="n">brcms_c_calc_frame_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">,</span> <span class="n">preamble_type</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">DOT11_BA_LEN</span> <span class="o">+</span> <span class="n">DOT11_BA_BITMAP_LEN</span> <span class="o">+</span>
				    <span class="n">FCS_LEN</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* brcms_c_compute_frame_dur()</span>
<span class="cm"> *</span>
<span class="cm"> * Calculate the 802.11 MAC header DUR field for MPDU</span>
<span class="cm"> * DUR for a single frame = 1 SIFS + 1 ACK</span>
<span class="cm"> * DUR for a frame with following frags = 3 SIFS + 2 ACK + next frag time</span>
<span class="cm"> *</span>
<span class="cm"> * rate			MPDU rate in unit of 500kbps</span>
<span class="cm"> * next_frag_len	next MPDU length in bytes</span>
<span class="cm"> * preamble_type	use short/GF or long/MM PLCP header</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span>
<span class="nf">brcms_c_compute_frame_dur</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rate</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="n">preamble_type</span><span class="p">,</span> <span class="n">uint</span> <span class="n">next_frag_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dur</span><span class="p">,</span> <span class="n">sifs</span><span class="p">;</span>

	<span class="n">sifs</span> <span class="o">=</span> <span class="n">get_sifs</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>

	<span class="n">dur</span> <span class="o">=</span> <span class="n">sifs</span><span class="p">;</span>
	<span class="n">dur</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">brcms_c_calc_ack_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">preamble_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next_frag_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Double the current DUR to get 2 SIFS + 2 ACKs */</span>
		<span class="n">dur</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* add another SIFS and the frag time */</span>
		<span class="n">dur</span> <span class="o">+=</span> <span class="n">sifs</span><span class="p">;</span>
		<span class="n">dur</span> <span class="o">+=</span>
		    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">brcms_c_calc_frame_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">preamble_type</span><span class="p">,</span>
						 <span class="n">next_frag_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dur</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The opposite of brcms_c_calc_frame_time */</span>
<span class="k">static</span> <span class="n">uint</span>
<span class="nf">brcms_c_calc_frame_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ratespec</span><span class="p">,</span>
		   <span class="n">u8</span> <span class="n">preamble_type</span><span class="p">,</span> <span class="n">uint</span> <span class="n">dur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">nsyms</span><span class="p">,</span> <span class="n">mac_len</span><span class="p">,</span> <span class="n">Ndps</span><span class="p">,</span> <span class="n">kNdps</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">rspec2rate</span><span class="p">(</span><span class="n">ratespec</span><span class="p">);</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: rspec 0x%x, preamble_type %d, dur %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">ratespec</span><span class="p">,</span> <span class="n">preamble_type</span><span class="p">,</span> <span class="n">dur</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">ratespec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">uint</span> <span class="n">mcs</span> <span class="o">=</span> <span class="n">ratespec</span> <span class="o">&amp;</span> <span class="n">RSPEC_RATE_MASK</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tot_streams</span> <span class="o">=</span> <span class="n">mcs_2_txstreams</span><span class="p">(</span><span class="n">mcs</span><span class="p">)</span> <span class="o">+</span> <span class="n">rspec_stc</span><span class="p">(</span><span class="n">ratespec</span><span class="p">);</span>
		<span class="n">dur</span> <span class="o">-=</span> <span class="n">PREN_PREAMBLE</span> <span class="o">+</span> <span class="p">(</span><span class="n">tot_streams</span> <span class="o">*</span> <span class="n">PREN_PREAMBLE_EXT</span><span class="p">);</span>
		<span class="cm">/* payload calculation matches that of regular ofdm */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span><span class="p">)</span>
			<span class="n">dur</span> <span class="o">-=</span> <span class="n">DOT11_OFDM_SIGNAL_EXTENSION</span><span class="p">;</span>
		<span class="cm">/* kNdbps = kbps * 4 */</span>
		<span class="n">kNdps</span> <span class="o">=</span>	<span class="n">mcs_2_rate</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">rspec_is40mhz</span><span class="p">(</span><span class="n">ratespec</span><span class="p">),</span>
				   <span class="n">rspec_issgi</span><span class="p">(</span><span class="n">ratespec</span><span class="p">))</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">nsyms</span> <span class="o">=</span> <span class="n">dur</span> <span class="o">/</span> <span class="n">APHY_SYMBOL_TIME</span><span class="p">;</span>
		<span class="n">mac_len</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">nsyms</span> <span class="o">*</span> <span class="n">kNdps</span><span class="p">)</span> <span class="o">-</span>
		     <span class="p">((</span><span class="n">APHY_SERVICE_NBITS</span> <span class="o">+</span> <span class="n">APHY_TAIL_NBITS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">/</span> <span class="mi">8000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">ratespec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dur</span> <span class="o">-=</span> <span class="n">APHY_PREAMBLE_TIME</span><span class="p">;</span>
		<span class="n">dur</span> <span class="o">-=</span> <span class="n">APHY_SIGNAL_TIME</span><span class="p">;</span>
		<span class="cm">/* Ndbps = Mbps * 4 = rate(500Kbps) * 2 */</span>
		<span class="n">Ndps</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">nsyms</span> <span class="o">=</span> <span class="n">dur</span> <span class="o">/</span> <span class="n">APHY_SYMBOL_TIME</span><span class="p">;</span>
		<span class="n">mac_len</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">nsyms</span> <span class="o">*</span> <span class="n">Ndps</span><span class="p">)</span> <span class="o">-</span>
		     <span class="p">(</span><span class="n">APHY_SERVICE_NBITS</span> <span class="o">+</span> <span class="n">APHY_TAIL_NBITS</span><span class="p">))</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">preamble_type</span> <span class="o">&amp;</span> <span class="n">BRCMS_SHORT_PREAMBLE</span><span class="p">)</span>
			<span class="n">dur</span> <span class="o">-=</span> <span class="n">BPHY_PLCP_SHORT_TIME</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dur</span> <span class="o">-=</span> <span class="n">BPHY_PLCP_TIME</span><span class="p">;</span>
		<span class="n">mac_len</span> <span class="o">=</span> <span class="n">dur</span> <span class="o">*</span> <span class="n">rate</span><span class="p">;</span>
		<span class="cm">/* divide out factor of 2 in rate (1/2 mbps) */</span>
		<span class="n">mac_len</span> <span class="o">=</span> <span class="n">mac_len</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">mac_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return true if the specified rate is supported by the specified band.</span>
<span class="cm"> * BRCM_BAND_AUTO indicates the current band.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">brcms_c_valid_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rspec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">band</span><span class="p">,</span>
		    <span class="n">bool</span> <span class="n">verbose</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="o">*</span><span class="n">hw_rateset</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">band</span> <span class="o">==</span> <span class="n">BRCM_BAND_AUTO</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span><span class="p">))</span>
		<span class="n">hw_rateset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">hw_rateset</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">hw_rateset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">OTHERBANDUNIT</span><span class="p">(</span><span class="n">wlc</span><span class="p">)]</span><span class="o">-&gt;</span><span class="n">hw_rateset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* other band specified and we are a single band device */</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* check if this is a mimo rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rspec</span> <span class="o">&amp;</span> <span class="n">RSPEC_RATE_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MCS_TABLE_SIZE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">isset</span><span class="p">(</span><span class="n">hw_rateset</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">,</span> <span class="p">(</span><span class="n">rspec</span> <span class="o">&amp;</span> <span class="n">RSPEC_RATE_MASK</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw_rateset</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw_rateset</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rspec2rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
 <span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: valid_rate: rate spec 0x%x &quot;</span>
			  <span class="s">&quot;not in hw_rateset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">rspec</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">mac80211_wlc_set_nrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcms_band</span> <span class="o">*</span><span class="n">cur_band</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">int_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">stf</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_val</span> <span class="o">&amp;</span> <span class="n">NRATE_STF_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">NRATE_STF_SHIFT</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">int_val</span> <span class="o">&amp;</span> <span class="n">NRATE_RATE_MASK</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rspec</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ismcs</span> <span class="o">=</span> <span class="p">((</span><span class="n">int_val</span> <span class="o">&amp;</span> <span class="n">NRATE_MCS_INUSE</span><span class="p">)</span> <span class="o">==</span> <span class="n">NRATE_MCS_INUSE</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">issgi</span> <span class="o">=</span> <span class="p">((</span><span class="n">int_val</span> <span class="o">&amp;</span> <span class="n">NRATE_SGI_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">NRATE_SGI_SHIFT</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">override_mcs_only</span> <span class="o">=</span> <span class="p">((</span><span class="n">int_val</span> <span class="o">&amp;</span> <span class="n">NRATE_OVERRIDE_MCS_ONLY</span><span class="p">)</span>
				  <span class="o">==</span> <span class="n">NRATE_OVERRIDE_MCS_ONLY</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bcmerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ismcs</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">rate</span><span class="p">;</span>

	<span class="cm">/* validate the combination of rate/mcs/stf is allowed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">&amp;</span> <span class="n">SUPPORT_11N</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ismcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mcs only allowed when nmode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stf</span> <span class="o">&gt;</span> <span class="n">PHY_TXC1_MODE_SDM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: Invalid stf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">bcmerror</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* mcs 32 is a special case, DUP mode 40 only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHSPEC_IS40</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">home_chanspec</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">stf</span> <span class="o">!=</span> <span class="n">PHY_TXC1_MODE_SISO</span><span class="p">)</span>
			     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stf</span> <span class="o">!=</span> <span class="n">PHY_TXC1_MODE_CDD</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: Invalid mcs &quot;</span>
					  <span class="s">&quot;32</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">bcmerror</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* mcs &gt; 7 must use stf SDM */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="n">HIGHEST_SINGLE_STREAM_MCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* mcs &gt; 7 must use stf SDM */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stf</span> <span class="o">!=</span> <span class="n">PHY_TXC1_MODE_SDM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: enabling &quot;</span>
				       <span class="s">&quot;SDM mode for mcs %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
				<span class="n">stf</span> <span class="o">=</span> <span class="n">PHY_TXC1_MODE_SDM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * MCS 0-7 may use SISO, CDD, and for</span>
<span class="cm">			 * phy_rev &gt;= 3 STBC</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">stf</span> <span class="o">&gt;</span> <span class="n">PHY_TXC1_MODE_STBC</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="o">!</span><span class="n">BRCMS_STBC_CAP_PHY</span><span class="p">(</span><span class="n">wlc</span><span class="p">)</span>
			     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stf</span> <span class="o">==</span> <span class="n">PHY_TXC1_MODE_STBC</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: Invalid STBC&quot;</span>
					  <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">bcmerror</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stf</span> <span class="o">!=</span> <span class="n">PHY_TXC1_MODE_CDD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stf</span> <span class="o">!=</span> <span class="n">PHY_TXC1_MODE_SISO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: Invalid OFDM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">bcmerror</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_cck_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cur_band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">!=</span> <span class="n">BRCM_BAND_2G</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">stf</span> <span class="o">!=</span> <span class="n">PHY_TXC1_MODE_SISO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: Invalid CCK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">bcmerror</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: Unknown rate type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">bcmerror</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* make sure multiple antennae are available for non-siso rates */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stf</span> <span class="o">!=</span> <span class="n">PHY_TXC1_MODE_SISO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txstreams</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: SISO antenna but !SISO &quot;</span>
			  <span class="s">&quot;request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">bcmerror</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rspec</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ismcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rspec</span> <span class="o">|=</span> <span class="n">RSPEC_MIMORATE</span><span class="p">;</span>
		<span class="cm">/* For STBC populate the STC field of the ratespec */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stf</span> <span class="o">==</span> <span class="n">PHY_TXC1_MODE_STBC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">stc</span><span class="p">;</span>
			<span class="n">stc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Nss for single stream is always 1 */</span>
			<span class="n">rspec</span> <span class="o">|=</span> <span class="p">(</span><span class="n">stc</span> <span class="o">&lt;&lt;</span> <span class="n">RSPEC_STC_SHIFT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rspec</span> <span class="o">|=</span> <span class="p">(</span><span class="n">stf</span> <span class="o">&lt;&lt;</span> <span class="n">RSPEC_STF_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">override_mcs_only</span><span class="p">)</span>
		<span class="n">rspec</span> <span class="o">|=</span> <span class="n">RSPEC_OVERRIDE_MCS_ONLY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">issgi</span><span class="p">)</span>
		<span class="n">rspec</span> <span class="o">|=</span> <span class="n">RSPEC_SHORT_GI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">brcms_c_valid_rate</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">,</span> <span class="n">cur_band</span><span class="o">-&gt;</span><span class="n">bandtype</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rspec</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Compute PLCP, but only requires actual rate and length of pkt.</span>
<span class="cm"> * Rate is given in the driver standard multiple of 500 kbps.</span>
<span class="cm"> * le is set for 11 Mbps rate if necessary.</span>
<span class="cm"> * Broken out for PRQ.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_cck_plcp_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate_500</span><span class="p">,</span>
			     <span class="n">uint</span> <span class="n">length</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">plcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">usec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">le</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate_500</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BRCM_RATE_1M</span>:
		<span class="n">usec</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCM_RATE_2M</span>:
		<span class="n">usec</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCM_RATE_5M5</span>:
		<span class="n">usec</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">length</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">usec</span> <span class="o">*</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">usec</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRCM_RATE_11M</span>:
		<span class="n">usec</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">length</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">usec</span> <span class="o">*</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usec</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">usec</span> <span class="o">*</span> <span class="mi">11</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">le</span> <span class="o">=</span> <span class="n">D11B_PLCP_SIGNAL_LE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;brcms_c_cck_plcp_set: unsupported rate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">rate_500</span><span class="p">);</span>
		<span class="n">rate_500</span> <span class="o">=</span> <span class="n">BRCM_RATE_1M</span><span class="p">;</span>
		<span class="n">usec</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* PLCP signal byte */</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate_500</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/* r (500kbps) * 5 == r (100kbps) */</span>
	<span class="cm">/* PLCP service byte */</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">le</span> <span class="o">|</span> <span class="n">D11B_PLCP_SIGNAL_LOCKED</span><span class="p">);</span>
	<span class="cm">/* PLCP length u16, little endian */</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">usec</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">usec</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="cm">/* PLCP CRC16 */</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Rate: 802.11 rate code, length: PSDU length in octets */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_compute_mimo_plcp</span><span class="p">(</span><span class="n">u32</span> <span class="n">rspec</span><span class="p">,</span> <span class="n">uint</span> <span class="n">length</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">plcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mcs</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">rspec</span> <span class="o">&amp;</span> <span class="n">RSPEC_RATE_MASK</span><span class="p">);</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rspec_is40mhz</span><span class="p">(</span><span class="n">rspec</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mcs</span> <span class="o">==</span> <span class="mi">32</span><span class="p">))</span>
		<span class="n">plcp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MIMO_PLCP_40MHZ</span><span class="p">;</span>
	<span class="n">BRCMS_SET_MIMO_PLCP_LEN</span><span class="p">(</span><span class="n">plcp</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rspec_mimoplcp3</span><span class="p">(</span><span class="n">rspec</span><span class="p">);</span> <span class="cm">/* rspec already holds this byte */</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x7</span><span class="p">;</span> <span class="cm">/* set smoothing, not sounding ppdu &amp; reserved */</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* number of extension spatial streams bit 0 &amp; 1 */</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Rate: 802.11 rate code, length: PSDU length in octets */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_c_compute_ofdm_plcp</span><span class="p">(</span><span class="n">u32</span> <span class="n">rspec</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">plcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rate_signal</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">rspec2rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * encode rate per 802.11a-1999 sec 17.3.4.1, with lsb</span>
<span class="cm">	 * transmitted first</span>
<span class="cm">	 */</span>
	<span class="n">rate_signal</span> <span class="o">=</span> <span class="n">rate_info</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BRCMS_RATE_MASK</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">plcp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">D11_PHY_HDR_LEN</span><span class="p">);</span>
	<span class="n">D11A_PHY_HDR_SRATE</span><span class="p">((</span><span class="k">struct</span> <span class="n">ofdm_phy_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">plcp</span><span class="p">,</span> <span class="n">rate_signal</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">plcp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Rate: 802.11 rate code, length: PSDU length in octets */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_compute_cck_plcp</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rspec</span><span class="p">,</span>
				 <span class="n">uint</span> <span class="n">length</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">plcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">rspec2rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">);</span>

	<span class="n">brcms_c_cck_plcp_set</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">plcp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_c_compute_plcp</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rspec</span><span class="p">,</span>
		     <span class="n">uint</span> <span class="n">length</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">plcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span>
		<span class="n">brcms_c_compute_mimo_plcp</span><span class="p">(</span><span class="n">rspec</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">plcp</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span>
		<span class="n">brcms_c_compute_ofdm_plcp</span><span class="p">(</span><span class="n">rspec</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">plcp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">brcms_c_compute_cck_plcp</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">plcp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* brcms_c_compute_rtscts_dur()</span>
<span class="cm"> *</span>
<span class="cm"> * Calculate the 802.11 MAC header DUR field for an RTS or CTS frame</span>
<span class="cm"> * DUR for normal RTS/CTS w/ frame = 3 SIFS + 1 CTS + next frame time + 1 ACK</span>
<span class="cm"> * DUR for CTS-TO-SELF w/ frame    = 2 SIFS         + next frame time + 1 ACK</span>
<span class="cm"> *</span>
<span class="cm"> * cts			cts-to-self or rts/cts</span>
<span class="cm"> * rts_rate		rts or cts rate in unit of 500kbps</span>
<span class="cm"> * rate			next MPDU rate in unit of 500kbps</span>
<span class="cm"> * frame_len		next MPDU frame length in bytes</span>
<span class="cm"> */</span>
<span class="n">u16</span>
<span class="nf">brcms_c_compute_rtscts_dur</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">cts_only</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">rts_rate</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">frame_rate</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rts_preamble_type</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">frame_preamble_type</span><span class="p">,</span> <span class="n">uint</span> <span class="n">frame_len</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dur</span><span class="p">,</span> <span class="n">sifs</span><span class="p">;</span>

	<span class="n">sifs</span> <span class="o">=</span> <span class="n">get_sifs</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cts_only</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* RTS/CTS */</span>
		<span class="n">dur</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">sifs</span><span class="p">;</span>
		<span class="n">dur</span> <span class="o">+=</span>
		    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">brcms_c_calc_cts_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rts_rate</span><span class="p">,</span>
					       <span class="n">rts_preamble_type</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* CTS-TO-SELF */</span>
		<span class="n">dur</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sifs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dur</span> <span class="o">+=</span>
	    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">brcms_c_calc_frame_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">frame_rate</span><span class="p">,</span> <span class="n">frame_preamble_type</span><span class="p">,</span>
					 <span class="n">frame_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ba</span><span class="p">)</span>
		<span class="n">dur</span> <span class="o">+=</span>
		    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">brcms_c_calc_ba_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">frame_rate</span><span class="p">,</span>
					      <span class="n">BRCMS_SHORT_PREAMBLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dur</span> <span class="o">+=</span>
		    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">brcms_c_calc_ack_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">frame_rate</span><span class="p">,</span>
					       <span class="n">frame_preamble_type</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dur</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">brcms_c_phytxctl1_calc</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rspec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">phyctl1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISLCNPHY</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bw</span> <span class="o">=</span> <span class="n">PHY_TXC1_BW_20MHZ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bw</span> <span class="o">=</span> <span class="n">rspec_get_bw</span><span class="p">(</span><span class="n">rspec</span><span class="p">);</span>
		<span class="cm">/* 10Mhz is not supported yet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bw</span> <span class="o">&lt;</span> <span class="n">PHY_TXC1_BW_20MHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;phytxctl1_calc: bw %d is &quot;</span>
				  <span class="s">&quot;not supported yet, set to 20L</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bw</span><span class="p">);</span>
			<span class="n">bw</span> <span class="o">=</span> <span class="n">PHY_TXC1_BW_20MHZ</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">uint</span> <span class="n">mcs</span> <span class="o">=</span> <span class="n">rspec</span> <span class="o">&amp;</span> <span class="n">RSPEC_RATE_MASK</span><span class="p">;</span>

		<span class="cm">/* bw, stf, coding-type is part of rspec_phytxbyte2 returns */</span>
		<span class="n">phyctl1</span> <span class="o">=</span> <span class="n">rspec_phytxbyte2</span><span class="p">(</span><span class="n">rspec</span><span class="p">);</span>
		<span class="cm">/* set the upper byte of phyctl1 */</span>
		<span class="n">phyctl1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mcs_table</span><span class="p">[</span><span class="n">mcs</span><span class="p">].</span><span class="n">tx_phy_ctl3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_cck_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BRCMS_ISLCNPHY</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span>
		   <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BRCMS_ISSSLPNPHY</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * In CCK mode LPPHY overloads OFDM Modulation bits with CCK</span>
<span class="cm">		 * Data Rate. Eventually MIMOPHY would also be converted to</span>
<span class="cm">		 * this format</span>
<span class="cm">		 */</span>
		<span class="cm">/* 0 = 1Mbps; 1 = 2Mbps; 2 = 5.5Mbps; 3 = 11Mbps */</span>
		<span class="n">phyctl1</span> <span class="o">=</span> <span class="p">(</span><span class="n">bw</span> <span class="o">|</span> <span class="p">(</span><span class="n">rspec_stf</span><span class="p">(</span><span class="n">rspec</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PHY_TXC1_MODE_SHIFT</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* legacy OFDM/CCK */</span>
		<span class="n">s16</span> <span class="n">phycfg</span><span class="p">;</span>
		<span class="cm">/* get the phyctl byte from rate phycfg table */</span>
		<span class="n">phycfg</span> <span class="o">=</span> <span class="n">brcms_c_rate_legacy_phyctl</span><span class="p">(</span><span class="n">rspec2rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phycfg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;phytxctl1_calc: wrong &quot;</span>
				  <span class="s">&quot;legacy OFDM/CCK rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">phycfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* set the upper byte of phyctl1 */</span>
		<span class="n">phyctl1</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">bw</span> <span class="o">|</span> <span class="p">(</span><span class="n">phycfg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">rspec_stf</span><span class="p">(</span><span class="n">rspec</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PHY_TXC1_MODE_SHIFT</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">phyctl1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add struct d11txh, struct cck_phy_hdr.</span>
<span class="cm"> *</span>
<span class="cm"> * &#39;p&#39; data must start with 802.11 MAC header</span>
<span class="cm"> * &#39;p&#39; must allow enough bytes of local headers to be &quot;pushed&quot; onto the packet</span>
<span class="cm"> *</span>
<span class="cm"> * headroom == D11_PHY_HDR_LEN + D11_TXH_LEN (D11_TXH_LEN is now 104 bytes)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span>
<span class="nf">brcms_c_d11hdrs_mac80211</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span> <span class="n">uint</span> <span class="n">frag</span><span class="p">,</span>
		     <span class="n">uint</span> <span class="n">nfrags</span><span class="p">,</span> <span class="n">uint</span> <span class="n">queue</span><span class="p">,</span> <span class="n">uint</span> <span class="n">next_frag_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d11txh</span> <span class="o">*</span><span class="n">txh</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">plcp</span><span class="p">,</span> <span class="n">plcp_fallback</span><span class="p">[</span><span class="n">D11_PHY_HDR_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">phylen</span><span class="p">,</span> <span class="n">rts_phylen</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mch</span><span class="p">,</span> <span class="n">phyctl</span><span class="p">,</span> <span class="n">xfts</span><span class="p">,</span> <span class="n">mainrates</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mcl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frameid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">BRCM_RATE_1M</span><span class="p">,</span> <span class="n">BRCM_RATE_1M</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">rts_rspec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">BRCM_RATE_1M</span><span class="p">,</span> <span class="n">BRCM_RATE_1M</span> <span class="p">};</span>
	<span class="n">bool</span> <span class="n">use_rts</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">use_cts</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">use_rifs</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">short_preamble</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">preamble_type</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">BRCMS_LONG_PREAMBLE</span><span class="p">,</span> <span class="n">BRCMS_LONG_PREAMBLE</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">rts_preamble_type</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">BRCMS_LONG_PREAMBLE</span><span class="p">,</span> <span class="n">BRCMS_LONG_PREAMBLE</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rts_plcp</span><span class="p">,</span> <span class="n">rts_plcp_fallback</span><span class="p">[</span><span class="n">D11_PHY_HDR_LEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ieee80211_rts</span> <span class="o">*</span><span class="n">rts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">qos</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">ac</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">hwtkmic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mimo_ctlchbw</span> <span class="o">=</span> <span class="n">PHY_TXC1_BW_20MHZ</span><span class="p">;</span>
<span class="cp">#define ANTCFG_NONE 0xFF</span>
	<span class="n">u8</span> <span class="n">antcfg</span> <span class="o">=</span> <span class="n">ANTCFG_NONE</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fbantcfg</span> <span class="o">=</span> <span class="n">ANTCFG_NONE</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">phyctl1_stf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">durid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">txrate</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_mcs</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mimo_txbw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mimo_preamble_type</span><span class="p">;</span>

	<span class="cm">/* locate 802.11 MAC header */</span>
	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">qos</span> <span class="o">=</span> <span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="cm">/* compute length of frame in bytes for use in PLCP computations */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">phylen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">;</span>

	<span class="cm">/* Get tx_info */</span>
	<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="cm">/* add PLCP */</span>
	<span class="n">plcp</span> <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">D11_PHY_HDR_LEN</span><span class="p">);</span>

	<span class="cm">/* add Broadcom tx descriptor header */</span>
	<span class="n">txh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">d11txh</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">D11_TXH_LEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">txh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">D11_TXH_LEN</span><span class="p">);</span>

	<span class="cm">/* setup frameid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_ASSIGN_SEQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* non-AP STA should never use BCMC queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">==</span> <span class="n">TX_BCMC_FIFO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: ASSERT queue == &quot;</span>
				  <span class="s">&quot;TX_BCMC!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">frameid</span> <span class="o">=</span> <span class="n">bcmc_fid_generate</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">txh</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Increment the counter for first fragment */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_FIRST_FRAGMENT</span><span class="p">)</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">seqnum</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* extract fragment number from frame first */</span>
			<span class="n">seq</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FRAGNUM_MASK</span><span class="p">;</span>
			<span class="n">seq</span> <span class="o">|=</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">seqnum</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">SEQNUM_SHIFT</span><span class="p">);</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

			<span class="n">frameid</span> <span class="o">=</span> <span class="p">((</span><span class="n">seq</span> <span class="o">&lt;&lt;</span> <span class="n">TXFID_SEQ_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXFID_SEQ_MASK</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">queue</span> <span class="o">&amp;</span> <span class="n">TXFID_QUEUE_MASK</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">frameid</span> <span class="o">|=</span> <span class="n">queue</span> <span class="o">&amp;</span> <span class="n">TXFID_QUEUE_MASK</span><span class="p">;</span>

	<span class="cm">/* set the ignpmq bit for all pkts tx&#39;d in PS mode and for beacons */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="n">mcl</span> <span class="o">|=</span> <span class="n">TXC_IGNOREPMQ</span><span class="p">;</span>

	<span class="n">txrate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
	<span class="n">txrate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">txrate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if rate control algorithm didn&#39;t give us a fallback</span>
<span class="cm">	 * rate, use the primary rate</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txrate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">txrate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">txrate</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">is_mcs</span> <span class="o">=</span> <span class="n">txrate</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_mcs</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">txrate</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">txrate</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span>
				    <span class="n">bitrates</span><span class="p">[</span><span class="n">txrate</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">].</span><span class="n">hw_value</span><span class="p">;</span>
				<span class="n">short_preamble</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">txrate</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span>
				    <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_SHORT_PREAMBLE</span> <span class="o">?</span>
				    <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCM_RATE_1M</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac80211_wlc_set_nrate</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span>
					<span class="n">NRATE_MCS_INUSE</span> <span class="o">|</span> <span class="n">txrate</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Currently only support same setting for primay and</span>
<span class="cm">		 * fallback rates. Unify flags for each rate into a</span>
<span class="cm">		 * single value for the frame</span>
<span class="cm">		 */</span>
		<span class="n">use_rts</span> <span class="o">|=</span>
		    <span class="n">txrate</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span>
		    <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">use_cts</span> <span class="o">|=</span>
		    <span class="n">txrate</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span>
		    <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>


		<span class="cm">/*</span>
<span class="cm">		 * (1) RATE:</span>
<span class="cm">		 *   determine and validate primary rate</span>
<span class="cm">		 *   and fallback rates</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rspec_active</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCM_RATE_1M</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* set tx antenna config */</span>
				<span class="n">brcms_c_antsel_antcfg_get</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">asi</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
					<span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">antcfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbantcfg</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">phyctl1_stf</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">ss_opmode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">&amp;</span> <span class="n">SUPPORT_11N</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * apply siso/cdd to single stream mcs&#39;s or ofdm</span>
<span class="cm">			 * if rspec is auto selected</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			      <span class="n">is_single_stream</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RSPEC_RATE_MASK</span><span class="p">))</span> <span class="o">||</span>
			     <span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
			    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RSPEC_OVERRIDE_MCS_ONLY</span><span class="p">)</span>
				<span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RSPEC_OVERRIDE</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RSPEC_STF_MASK</span> <span class="o">|</span> <span class="n">RSPEC_STC_MASK</span><span class="p">);</span>

				<span class="cm">/* For SISO MCS use STBC if possible */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
				    <span class="o">&amp;&amp;</span> <span class="n">BRCMS_STF_SS_STBC_TX</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">scb</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">u8</span> <span class="n">stc</span><span class="p">;</span>

					<span class="cm">/* Nss for single stream is always 1 */</span>
					<span class="n">stc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PHY_TXC1_MODE_STBC</span> <span class="o">&lt;&lt;</span>
							<span class="n">RSPEC_STF_SHIFT</span><span class="p">)</span> <span class="o">|</span>
						    <span class="p">(</span><span class="n">stc</span> <span class="o">&lt;&lt;</span> <span class="n">RSPEC_STC_SHIFT</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">|=</span>
					    <span class="p">(</span><span class="n">phyctl1_stf</span> <span class="o">&lt;&lt;</span> <span class="n">RSPEC_STF_SHIFT</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Is the phy configured to use 40MHZ frames? If</span>
<span class="cm">			 * so then pick the desired txbw</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">brcms_chspec_bw</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">chanspec</span><span class="p">)</span> <span class="o">==</span> <span class="n">BRCMS_40_MHZ</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* default txbw is 20in40 SB */</span>
				<span class="n">mimo_ctlchbw</span> <span class="o">=</span> <span class="n">mimo_txbw</span> <span class="o">=</span>
				   <span class="n">CHSPEC_SB_UPPER</span><span class="p">(</span><span class="n">wlc_phy_chanspec_get</span><span class="p">(</span>
								 <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">))</span>
				   <span class="o">?</span> <span class="n">PHY_TXC1_BW_20MHZ_UP</span> <span class="o">:</span> <span class="n">PHY_TXC1_BW_20MHZ</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="p">{</span>
					<span class="cm">/* mcs 32 must be 40b/w DUP */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RSPEC_RATE_MASK</span><span class="p">)</span>
					    <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mimo_txbw</span> <span class="o">=</span>
						    <span class="n">PHY_TXC1_BW_40MHZ_DUP</span><span class="p">;</span>
						<span class="cm">/* use override */</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">mimo_40txbw</span> <span class="o">!=</span> <span class="n">AUTO</span><span class="p">)</span>
						<span class="n">mimo_txbw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">mimo_40txbw</span><span class="p">;</span>
					<span class="cm">/* else check if dst is using 40 Mhz */</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_IS40</span><span class="p">)</span>
						<span class="n">mimo_txbw</span> <span class="o">=</span> <span class="n">PHY_TXC1_BW_40MHZ</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ofdm_40txbw</span> <span class="o">!=</span> <span class="n">AUTO</span><span class="p">)</span>
						<span class="n">mimo_txbw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ofdm_40txbw</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cck_40txbw</span> <span class="o">!=</span> <span class="n">AUTO</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mimo_txbw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cck_40txbw</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * mcs32 is 40 b/w only.</span>
<span class="cm">				 * This is possible for probe packets on</span>
<span class="cm">				 * a STA during SCAN</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RSPEC_RATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
					<span class="cm">/* mcs 0 */</span>
					<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">RSPEC_MIMORATE</span><span class="p">;</span>

				<span class="n">mimo_txbw</span> <span class="o">=</span> <span class="n">PHY_TXC1_BW_20MHZ</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Set channel width */</span>
			<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RSPEC_BW_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span>
				<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mimo_txbw</span> <span class="o">&lt;&lt;</span> <span class="n">RSPEC_BW_SHIFT</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mimo_ctlchbw</span> <span class="o">&lt;&lt;</span> <span class="n">RSPEC_BW_SHIFT</span><span class="p">);</span>

			<span class="cm">/* Disable short GI, not supported yet */</span>
			<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RSPEC_SHORT_GI</span><span class="p">;</span>

			<span class="n">mimo_preamble_type</span> <span class="o">=</span> <span class="n">BRCMS_MM_PREAMBLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txrate</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_GREEN_FIELD</span><span class="p">)</span>
				<span class="n">mimo_preamble_type</span> <span class="o">=</span> <span class="n">BRCMS_GF_PREAMBLE</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">txrate</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span> <span class="p">{</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: IEEE80211_TX_&quot;</span>
					  <span class="s">&quot;RC_MCS != is_mcs_rate(rspec)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">preamble_type</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mimo_preamble_type</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * if SGI is selected, then forced mm</span>
<span class="cm">				 * for single stream</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RSPEC_SHORT_GI</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="n">is_single_stream</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;</span>
							<span class="n">RSPEC_RATE_MASK</span><span class="p">))</span>
					<span class="n">preamble_type</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCMS_MM_PREAMBLE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* should be better conditionalized */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span>
				<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_SHORT_PREAMBLE</span><span class="p">))</span>
				<span class="n">preamble_type</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCMS_SHORT_PREAMBLE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Set ctrlchbw as 20Mhz */</span>
			<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RSPEC_BW_MASK</span><span class="p">;</span>
			<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PHY_TXC1_BW_20MHZ</span> <span class="o">&lt;&lt;</span> <span class="n">RSPEC_BW_SHIFT</span><span class="p">);</span>

			<span class="cm">/* for nphy, stf of ofdm frames must follow policies */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISNPHY</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RSPEC_STF_MASK</span><span class="p">;</span>
				<span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">|=</span> <span class="n">phyctl1_stf</span> <span class="o">&lt;&lt;</span> <span class="n">RSPEC_STF_SHIFT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Reset these for use with AMPDU&#39;s */</span>
	<span class="n">txrate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txrate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* (2) PROTECTION, may change rspec */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">phylen</span> <span class="o">&gt;</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">RTSThresh</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span>
		<span class="n">use_rts</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* (3) PLCP: determine PLCP header and MAC duration,</span>
<span class="cm">	 * fill struct d11txh */</span>
	<span class="n">brcms_c_compute_plcp</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phylen</span><span class="p">,</span> <span class="n">plcp</span><span class="p">);</span>
	<span class="n">brcms_c_compute_plcp</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">phylen</span><span class="p">,</span> <span class="n">plcp_fallback</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">FragPLCPFallback</span><span class="p">,</span>
	       <span class="n">plcp_fallback</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">FragPLCPFallback</span><span class="p">));</span>

	<span class="cm">/* Length field now put in CCK FBR CRC field */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_cck_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">txh</span><span class="o">-&gt;</span><span class="n">FragPLCPFallback</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">phylen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">txh</span><span class="o">-&gt;</span><span class="n">FragPLCPFallback</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">phylen</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* MIMO-RATE: need validation ?? */</span>
	<span class="n">mainrates</span> <span class="o">=</span> <span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span>
			<span class="n">D11A_PHY_HDR_GRATE</span><span class="p">((</span><span class="k">struct</span> <span class="n">ofdm_phy_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">plcp</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">plcp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* DUR field for main rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_pspoll</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">use_rifs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">durid</span> <span class="o">=</span>
		    <span class="n">brcms_c_compute_frame_dur</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">preamble_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					  <span class="n">next_frag_len</span><span class="p">);</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">duration_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">durid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">use_rifs</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NAV protect to end of next max packet size */</span>
		<span class="n">durid</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">brcms_c_calc_frame_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						 <span class="n">preamble_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						 <span class="n">DOT11_MAX_FRAG_LEN</span><span class="p">);</span>
		<span class="n">durid</span> <span class="o">+=</span> <span class="n">RIFS_11N_TIME</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">duration_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">durid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* DUR field for fallback rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_pspoll</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="n">txh</span><span class="o">-&gt;</span><span class="n">FragDurFallback</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">duration_id</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">||</span> <span class="n">use_rifs</span><span class="p">)</span>
		<span class="n">txh</span><span class="o">-&gt;</span><span class="n">FragDurFallback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">durid</span> <span class="o">=</span> <span class="n">brcms_c_compute_frame_dur</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					      <span class="n">preamble_type</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">next_frag_len</span><span class="p">);</span>
		<span class="n">txh</span><span class="o">-&gt;</span><span class="n">FragDurFallback</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">durid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* (4) MAC-HDR: MacTxControlLow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mcl</span> <span class="o">|=</span> <span class="n">TXC_STARTMSDU</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span>
		<span class="n">mcl</span> <span class="o">|=</span> <span class="n">TXC_IMMEDACK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_5G</span><span class="p">)</span>
		<span class="n">mcl</span> <span class="o">|=</span> <span class="n">TXC_FREQBAND_5G</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHSPEC_IS40</span><span class="p">(</span><span class="n">wlc_phy_chanspec_get</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">)))</span>
		<span class="n">mcl</span> <span class="o">|=</span> <span class="n">TXC_BW_40</span><span class="p">;</span>

	<span class="cm">/* set AMIC bit if using hardware TKIP MIC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwtkmic</span><span class="p">)</span>
		<span class="n">mcl</span> <span class="o">|=</span> <span class="n">TXC_AMIC</span><span class="p">;</span>

	<span class="n">txh</span><span class="o">-&gt;</span><span class="n">MacTxControlLow</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mcl</span><span class="p">);</span>

	<span class="cm">/* MacTxControlHigh */</span>
	<span class="n">mch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set fallback rate preamble type */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">preamble_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">BRCMS_SHORT_PREAMBLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">preamble_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">BRCMS_GF_PREAMBLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rspec2rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="n">BRCM_RATE_1M</span><span class="p">)</span>
			<span class="n">mch</span> <span class="o">|=</span> <span class="n">TXC_PREAMBLE_DATA_FB_SHORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* MacFrameControl */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">MacFrameControl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>
	<span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFesTimeNormal</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFesTimeFallback</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* TxFrameRA */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFrameRA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* TxFrameID */</span>
	<span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFrameID</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">frameid</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * TxStatus, Note the case of recreating the first frag of a suppressed</span>
<span class="cm">	 * frame then we may need to reset the retry cnt&#39;s via the status reg</span>
<span class="cm">	 */</span>
	<span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxStatus</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * extra fields for ucode AMPDU aggregation, the new fields are added to</span>
<span class="cm">	 * the END of previous structure so that it&#39;s compatible in driver.</span>
<span class="cm">	 */</span>
	<span class="n">txh</span><span class="o">-&gt;</span><span class="n">MaxNMpdus</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">txh</span><span class="o">-&gt;</span><span class="n">MaxABytes_MRT</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">txh</span><span class="o">-&gt;</span><span class="n">MaxABytes_FBR</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">txh</span><span class="o">-&gt;</span><span class="n">MinMBytes</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* (5) RTS/CTS: determine RTS/CTS PLCP header and MAC duration,</span>
<span class="cm">	 * furnish struct d11txh */</span>
	<span class="cm">/* RTS PLCP header and RTS frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_rts</span> <span class="o">||</span> <span class="n">use_cts</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_rts</span> <span class="o">&amp;&amp;</span> <span class="n">use_cts</span><span class="p">)</span>
			<span class="n">use_cts</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rts_rspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcms_c_rspec_to_rts_rspec</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
							      <span class="nb">false</span><span class="p">,</span>
							      <span class="n">mimo_ctlchbw</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rts_rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">((</span><span class="n">rspec2rate</span><span class="p">(</span><span class="n">rts_rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">BRCM_RATE_1M</span><span class="p">)</span> <span class="o">||</span>
		      <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">PLCPHdr_override</span> <span class="o">==</span> <span class="n">BRCMS_PLCP_LONG</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rts_preamble_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCMS_SHORT_PREAMBLE</span><span class="p">;</span>
			<span class="n">mch</span> <span class="o">|=</span> <span class="n">TXC_PREAMBLE_RTS_MAIN_SHORT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rts_rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">((</span><span class="n">rspec2rate</span><span class="p">(</span><span class="n">rts_rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">BRCM_RATE_1M</span><span class="p">)</span> <span class="o">||</span>
		      <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">PLCPHdr_override</span> <span class="o">==</span> <span class="n">BRCMS_PLCP_LONG</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rts_preamble_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BRCMS_SHORT_PREAMBLE</span><span class="p">;</span>
			<span class="n">mch</span> <span class="o">|=</span> <span class="n">TXC_PREAMBLE_RTS_FB_SHORT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* RTS/CTS additions to MacTxControlLow */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_cts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txh</span><span class="o">-&gt;</span><span class="n">MacTxControlLow</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TXC_SENDCTS</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">txh</span><span class="o">-&gt;</span><span class="n">MacTxControlLow</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TXC_SENDRTS</span><span class="p">);</span>
			<span class="n">txh</span><span class="o">-&gt;</span><span class="n">MacTxControlLow</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TXC_LONGFRAME</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* RTS PLCP header */</span>
		<span class="n">rts_plcp</span> <span class="o">=</span> <span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSPhyHeader</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_cts</span><span class="p">)</span>
			<span class="n">rts_phylen</span> <span class="o">=</span> <span class="n">DOT11_CTS_LEN</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rts_phylen</span> <span class="o">=</span> <span class="n">DOT11_RTS_LEN</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">;</span>

		<span class="n">brcms_c_compute_plcp</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rts_rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rts_phylen</span><span class="p">,</span> <span class="n">rts_plcp</span><span class="p">);</span>

		<span class="cm">/* fallback rate version of RTS PLCP header */</span>
		<span class="n">brcms_c_compute_plcp</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rts_rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rts_phylen</span><span class="p">,</span>
				 <span class="n">rts_plcp_fallback</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSPLCPFallback</span><span class="p">,</span> <span class="n">rts_plcp_fallback</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSPLCPFallback</span><span class="p">));</span>

		<span class="cm">/* RTS frame fields... */</span>
		<span class="n">rts</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rts</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">rts_frame</span><span class="p">;</span>

		<span class="n">durid</span> <span class="o">=</span> <span class="n">brcms_c_compute_rtscts_dur</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">use_cts</span><span class="p">,</span> <span class="n">rts_rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					       <span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rts_preamble_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					       <span class="n">preamble_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phylen</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">rts</span><span class="o">-&gt;</span><span class="n">duration</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">durid</span><span class="p">);</span>
		<span class="cm">/* fallback rate version of RTS DUR field */</span>
		<span class="n">durid</span> <span class="o">=</span> <span class="n">brcms_c_compute_rtscts_dur</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">use_cts</span><span class="p">,</span>
					       <span class="n">rts_rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					       <span class="n">rts_preamble_type</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					       <span class="n">preamble_type</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">phylen</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSDurFallback</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">durid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">use_cts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rts</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_CTL</span> <span class="o">|</span>
							 <span class="n">IEEE80211_STYPE_CTS</span><span class="p">);</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">ra</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rts</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_CTL</span> <span class="o">|</span>
							 <span class="n">IEEE80211_STYPE_RTS</span><span class="p">);</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">ra</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* mainrate</span>
<span class="cm">		 *    low 8 bits: main frag rate/mcs,</span>
<span class="cm">		 *    high 8 bits: rts/cts rate/mcs</span>
<span class="cm">		 */</span>
		<span class="n">mainrates</span> <span class="o">|=</span> <span class="p">(</span><span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rts_rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span>
				<span class="n">D11A_PHY_HDR_GRATE</span><span class="p">(</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">ofdm_phy_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">rts_plcp</span><span class="p">)</span> <span class="o">:</span>
				<span class="n">rts_plcp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSPhyHeader</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">D11_PHY_HDR_LEN</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">rts_frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rts</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSPLCPFallback</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSPLCPFallback</span><span class="p">));</span>
		<span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSDurFallback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_40MHZ</span>
	<span class="cm">/* add null delimiter count */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span>
		<span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSPLCPFallback</span><span class="p">[</span><span class="n">AMPDU_FBR_NULL_DELIM</span><span class="p">]</span> <span class="o">=</span>
		   <span class="n">brcm_c_ampdu_null_delim_cnt</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ampdu</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">rspec</span><span class="p">,</span> <span class="n">phylen</span><span class="p">);</span>

<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now that RTS/RTS FB preamble types are updated, write</span>
<span class="cm">	 * the final value</span>
<span class="cm">	 */</span>
	<span class="n">txh</span><span class="o">-&gt;</span><span class="n">MacTxControlHigh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mch</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * MainRates (both the rts and frag plcp rates have</span>
<span class="cm">	 * been calculated now)</span>
<span class="cm">	 */</span>
	<span class="n">txh</span><span class="o">-&gt;</span><span class="n">MainRates</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mainrates</span><span class="p">);</span>

	<span class="cm">/* XtraFrameTypes */</span>
	<span class="n">xfts</span> <span class="o">=</span> <span class="n">frametype</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">mimoft</span><span class="p">);</span>
	<span class="n">xfts</span> <span class="o">|=</span> <span class="p">(</span><span class="n">frametype</span><span class="p">(</span><span class="n">rts_rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">mimoft</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">XFTS_RTS_FT_SHIFT</span><span class="p">);</span>
	<span class="n">xfts</span> <span class="o">|=</span> <span class="p">(</span><span class="n">frametype</span><span class="p">(</span><span class="n">rts_rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">mimoft</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">XFTS_FBRRTS_FT_SHIFT</span><span class="p">);</span>
	<span class="n">xfts</span> <span class="o">|=</span> <span class="n">CHSPEC_CHANNEL</span><span class="p">(</span><span class="n">wlc_phy_chanspec_get</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
							     <span class="n">XFTS_CHANNEL_SHIFT</span><span class="p">;</span>
	<span class="n">txh</span><span class="o">-&gt;</span><span class="n">XtraFrameTypes</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">xfts</span><span class="p">);</span>

	<span class="cm">/* PhyTxControlWord */</span>
	<span class="n">phyctl</span> <span class="o">=</span> <span class="n">frametype</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">mimoft</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">preamble_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">BRCMS_SHORT_PREAMBLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">preamble_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">BRCMS_GF_PREAMBLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rspec2rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">BRCM_RATE_1M</span><span class="p">)</span>
			<span class="n">phyctl</span> <span class="o">|=</span> <span class="n">PHY_TXC_SHORT_HDR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* phytxant is properly bit shifted */</span>
	<span class="n">phyctl</span> <span class="o">|=</span> <span class="n">brcms_c_stf_d11hdrs_phyctl_txant</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">txh</span><span class="o">-&gt;</span><span class="n">PhyTxControlWord</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">phyctl</span><span class="p">);</span>

	<span class="cm">/* PhyTxControlWord_1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_PHY_11N_CAP</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">phyctl1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">phyctl1</span> <span class="o">=</span> <span class="n">brcms_c_phytxctl1_calc</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">txh</span><span class="o">-&gt;</span><span class="n">PhyTxControlWord_1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">phyctl1</span><span class="p">);</span>
		<span class="n">phyctl1</span> <span class="o">=</span> <span class="n">brcms_c_phytxctl1_calc</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">txh</span><span class="o">-&gt;</span><span class="n">PhyTxControlWord_1_Fbr</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">phyctl1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">use_rts</span> <span class="o">||</span> <span class="n">use_cts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phyctl1</span> <span class="o">=</span> <span class="n">brcms_c_phytxctl1_calc</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rts_rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">txh</span><span class="o">-&gt;</span><span class="n">PhyTxControlWord_1_Rts</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">phyctl1</span><span class="p">);</span>
			<span class="n">phyctl1</span> <span class="o">=</span> <span class="n">brcms_c_phytxctl1_calc</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rts_rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">txh</span><span class="o">-&gt;</span><span class="n">PhyTxControlWord_1_FbrRts</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">phyctl1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * For mcs frames, if mixedmode(overloaded with long preamble)</span>
<span class="cm">		 * is going to be set, fill in non-zero MModeLen and/or</span>
<span class="cm">		 * MModeFbrLen it will be unnecessary if they are separated</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">preamble_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">BRCMS_MM_PREAMBLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">mmodelen</span> <span class="o">=</span>
			    <span class="n">brcms_c_calc_lsig_len</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phylen</span><span class="p">);</span>
			<span class="n">txh</span><span class="o">-&gt;</span><span class="n">MModeLen</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mmodelen</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">preamble_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">BRCMS_MM_PREAMBLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">mmodefbrlen</span> <span class="o">=</span>
			    <span class="n">brcms_c_calc_lsig_len</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">phylen</span><span class="p">);</span>
			<span class="n">txh</span><span class="o">-&gt;</span><span class="n">MModeFbrLen</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mmodefbrlen</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ac</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_WMECAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">qos</span> <span class="o">&amp;&amp;</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">edcf_txop</span><span class="p">[</span><span class="n">ac</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">uint</span> <span class="n">frag_dur</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">dur_fallback</span><span class="p">;</span>

		<span class="cm">/* WME: Update TXOP threshold */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">frag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frag_dur</span> <span class="o">=</span>
			    <span class="n">brcms_c_calc_frame_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">preamble_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phylen</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rts</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* 1 RTS or CTS-to-self frame */</span>
				<span class="n">dur</span> <span class="o">=</span>
				    <span class="n">brcms_c_calc_cts_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rts_rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						      <span class="n">rts_preamble_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">dur_fallback</span> <span class="o">=</span>
				    <span class="n">brcms_c_calc_cts_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rts_rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
						      <span class="n">rts_preamble_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="cm">/* (SIFS + CTS) + SIFS + frame + SIFS + ACK */</span>
				<span class="n">dur</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">duration</span><span class="p">);</span>
				<span class="n">dur_fallback</span> <span class="o">+=</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">RTSDurFallback</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">use_rifs</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dur</span> <span class="o">=</span> <span class="n">frag_dur</span><span class="p">;</span>
				<span class="n">dur_fallback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* frame + SIFS + ACK */</span>
				<span class="n">dur</span> <span class="o">=</span> <span class="n">frag_dur</span><span class="p">;</span>
				<span class="n">dur</span> <span class="o">+=</span>
				    <span class="n">brcms_c_compute_frame_dur</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
							  <span class="n">preamble_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

				<span class="n">dur_fallback</span> <span class="o">=</span>
				    <span class="n">brcms_c_calc_frame_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
							<span class="n">preamble_type</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
							<span class="n">phylen</span><span class="p">);</span>
				<span class="n">dur_fallback</span> <span class="o">+=</span>
				    <span class="n">brcms_c_compute_frame_dur</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
							  <span class="n">preamble_type</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* NEED to set TxFesTimeNormal (hard) */</span>
			<span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFesTimeNormal</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">dur</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * NEED to set fallback rate version of</span>
<span class="cm">			 * TxFesTimeNormal (hard)</span>
<span class="cm">			 */</span>
			<span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFesTimeFallback</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">dur_fallback</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * update txop byte threshold (txop minus intraframe</span>
<span class="cm">			 * overhead)</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">edcf_txop</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">dur</span> <span class="o">-</span> <span class="n">frag_dur</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">uint</span> <span class="n">newfragthresh</span><span class="p">;</span>

				<span class="n">newfragthresh</span> <span class="o">=</span>
				    <span class="n">brcms_c_calc_frame_len</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span>
					<span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">preamble_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">edcf_txop</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">-</span>
						<span class="p">(</span><span class="n">dur</span> <span class="o">-</span> <span class="n">frag_dur</span><span class="p">)));</span>
				<span class="cm">/* range bound the fragthreshold */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">newfragthresh</span> <span class="o">&lt;</span> <span class="n">DOT11_MIN_FRAG_LEN</span><span class="p">)</span>
					<span class="n">newfragthresh</span> <span class="o">=</span>
					    <span class="n">DOT11_MIN_FRAG_LEN</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">newfragthresh</span> <span class="o">&gt;</span>
					 <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">usr_fragthresh</span><span class="p">)</span>
					<span class="n">newfragthresh</span> <span class="o">=</span>
					    <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">usr_fragthresh</span><span class="p">;</span>
				<span class="cm">/* update the fragthresh and do txc update */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fragthresh</span><span class="p">[</span><span class="n">queue</span><span class="p">]</span> <span class="o">!=</span>
				    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">newfragthresh</span><span class="p">)</span>
					<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fragthresh</span><span class="p">[</span><span class="n">queue</span><span class="p">]</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">newfragthresh</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s txop invalid &quot;</span>
					  <span class="s">&quot;for rate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">fifo_names</span><span class="p">[</span><span class="n">queue</span><span class="p">],</span>
					  <span class="n">rspec2rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dur</span> <span class="o">&gt;</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">edcf_txop</span><span class="p">[</span><span class="n">ac</span><span class="p">])</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: %s txop &quot;</span>
					  <span class="s">&quot;exceeded phylen %d/%d dur %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					  <span class="n">fifo_names</span><span class="p">[</span><span class="n">queue</span><span class="p">],</span>
					  <span class="n">phylen</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fragthresh</span><span class="p">[</span><span class="n">queue</span><span class="p">],</span>
					  <span class="n">dur</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">edcf_txop</span><span class="p">[</span><span class="n">ac</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_sendpkt_mac80211</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sdu</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">prio</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">fifo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pri_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">d11_header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">sdu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * 802.11 standard requires management traffic</span>
<span class="cm">	 * to go at highest priority</span>
<span class="cm">	 */</span>
	<span class="n">prio</span> <span class="o">=</span> <span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">d11_header</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">?</span> <span class="n">sdu</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">:</span>
		<span class="n">MAXPRIO</span><span class="p">;</span>
	<span class="n">fifo</span> <span class="o">=</span> <span class="n">prio2fifo</span><span class="p">[</span><span class="n">prio</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcms_c_d11hdrs_mac80211</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">sdu</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">brcms_c_txq_enq</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">sdu</span><span class="p">,</span> <span class="n">BRCMS_PRIO_TO_PREC</span><span class="p">(</span><span class="n">prio</span><span class="p">));</span>
	<span class="n">brcms_c_send_q</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_send_q</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pkt</span><span class="p">[</span><span class="n">DOT11_MAXNUMFRAGS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">prec</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">prec_map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">fifo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_txq_info</span> <span class="o">*</span><span class="n">qi</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pkt_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pktq</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>

	<span class="n">prec_map</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_prec_map</span><span class="p">;</span>

	<span class="cm">/* Send all the enq&#39;d pkts that we can.</span>
<span class="cm">	 * Dequeue packets with precedence with empty HW fifo only</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">prec_map</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">brcmu_pktq_mdeq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">prec_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prec</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">brcms_c_sendampdu</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ampdu</span><span class="p">,</span> <span class="n">qi</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">prec</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">brcms_c_prep_pdu</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">brcms_c_txfifo</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="n">pkt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">true</span><span class="p">,</span>
						       <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brcmu_pktq_penq_head</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="cm">/*</span>
<span class="cm">			 * If send failed due to any other reason than a</span>
<span class="cm">			 * change in HW FIFO condition, quit. Otherwise,</span>
<span class="cm">			 * read the new prec_map!</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prec_map</span> <span class="o">==</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_prec_map</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">prec_map</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_prec_map</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">brcms_c_txfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">uint</span> <span class="n">fifo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
	       <span class="n">bool</span> <span class="n">commit</span><span class="p">,</span> <span class="n">s8</span> <span class="n">txpktpend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">frameid</span> <span class="o">=</span> <span class="n">INVALIDFID</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d11txh</span> <span class="o">*</span><span class="n">txh</span><span class="p">;</span>

	<span class="n">txh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">d11txh</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* When a BC/MC frame is being committed to the BCMC fifo</span>
<span class="cm">	 * via DMA (NOT PIO), update ucode or BSS info as appropriate.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">==</span> <span class="n">TX_BCMC_FIFO</span><span class="p">)</span>
		<span class="n">frameid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFrameID</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bump up pending count for if not using rpc. If rpc is</span>
<span class="cm">	 * used, this will be handled in brcms_b_txfifo()</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">commit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">txpktpend</span><span class="p">[</span><span class="n">fifo</span><span class="p">]</span> <span class="o">+=</span> <span class="n">txpktpend</span><span class="p">;</span>
		<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;pktpend inc %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">txpktpend</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">txpktpend</span><span class="p">[</span><span class="n">fifo</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Commit BCMC sequence number in the SHM frame ID location */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frameid</span> <span class="o">!=</span> <span class="n">INVALIDFID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * To inform the ucode of the last mcast frame posted</span>
<span class="cm">		 * so that it can clear moredata bit</span>
<span class="cm">		 */</span>
		<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_BCMC_FID</span><span class="p">,</span> <span class="n">frameid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_txfast</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">fifo</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="n">commit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;txfifo: fatal, toss frames !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span>
<span class="nf">brcms_c_rspec_to_rts_rspec</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rspec</span><span class="p">,</span>
			   <span class="n">bool</span> <span class="n">use_rspec</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mimo_ctlchbw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rts_rspec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_rspec</span><span class="p">)</span>
		<span class="cm">/* use frame rate as rts rate */</span>
		<span class="n">rts_rspec</span> <span class="o">=</span> <span class="n">rspec</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">&amp;&amp;</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">protection</span><span class="o">-&gt;</span><span class="n">_g</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_cck_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span>
		<span class="cm">/* Use 11Mbps as the g protection RTS target rate and fallback.</span>
<span class="cm">		 * Use the brcms_basic_rate() lookup to find the best basic rate</span>
<span class="cm">		 * under the target in case 11 Mbps is not Basic.</span>
<span class="cm">		 * 6 and 9 Mbps are not usually selected by rate selection, but</span>
<span class="cm">		 * even if the OFDM rate we are protecting is 6 or 9 Mbps, 11</span>
<span class="cm">		 * is more robust.</span>
<span class="cm">		 */</span>
		<span class="n">rts_rspec</span> <span class="o">=</span> <span class="n">brcms_basic_rate</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCM_RATE_11M</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* calculate RTS rate and fallback rate based on the frame rate</span>
<span class="cm">		 * RTS must be sent at a basic rate since it is a</span>
<span class="cm">		 * control frame, sec 9.6 of 802.11 spec</span>
<span class="cm">		 */</span>
		<span class="n">rts_rspec</span> <span class="o">=</span> <span class="n">brcms_basic_rate</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rspec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_PHY_11N_CAP</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* set rts txbw to correct side band */</span>
		<span class="n">rts_rspec</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RSPEC_BW_MASK</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * if rspec/rspec_fallback is 40MHz, then send RTS on both</span>
<span class="cm">		 * 20MHz channel (DUP), otherwise send RTS on control channel</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rspec_is40mhz</span><span class="p">(</span><span class="n">rspec</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_cck_rate</span><span class="p">(</span><span class="n">rts_rspec</span><span class="p">))</span>
			<span class="n">rts_rspec</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PHY_TXC1_BW_40MHZ_DUP</span> <span class="o">&lt;&lt;</span> <span class="n">RSPEC_BW_SHIFT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rts_rspec</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mimo_ctlchbw</span> <span class="o">&lt;&lt;</span> <span class="n">RSPEC_BW_SHIFT</span><span class="p">);</span>

		<span class="cm">/* pick siso/cdd as default for ofdm */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rts_rspec</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rts_rspec</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RSPEC_STF_MASK</span><span class="p">;</span>
			<span class="n">rts_rspec</span> <span class="o">|=</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">ss_opmode</span> <span class="o">&lt;&lt;</span> <span class="n">RSPEC_STF_SHIFT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rts_rspec</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">brcms_c_txfifo_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">uint</span> <span class="n">fifo</span><span class="p">,</span> <span class="n">s8</span> <span class="n">txpktpend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">txpktpend</span><span class="p">[</span><span class="n">fifo</span><span class="p">]</span> <span class="o">-=</span> <span class="n">txpktpend</span><span class="p">;</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;pktpend dec %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txpktpend</span><span class="p">,</span>
	       <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">txpktpend</span><span class="p">[</span><span class="n">fifo</span><span class="p">]);</span>

	<span class="cm">/* There is more room; mark precedences related to this FIFO sendable */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_prec_map</span> <span class="o">|=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fifo2prec_map</span><span class="p">[</span><span class="n">fifo</span><span class="p">];</span>

	<span class="cm">/* figure out which bsscfg is being worked on... */</span>
<span class="p">}</span>

<span class="cm">/* Update beacon listen interval in shared memory */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_bcn_li_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* wake up every DTIM is the default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bcn_li_dtim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_BCN_LI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_BCN_LI</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bcn_li_dtim</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bcn_li_bcn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_b_read_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">tsf_l_ptr</span><span class="p">,</span>
		  <span class="n">u32</span> <span class="o">*</span><span class="n">tsf_h_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>

	<span class="cm">/* read the tsf timer low, then high to get an atomic read */</span>
	<span class="o">*</span><span class="n">tsf_l_ptr</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_timerlow</span><span class="p">));</span>
	<span class="o">*</span><span class="n">tsf_h_ptr</span> <span class="o">=</span> <span class="n">bcma_read32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_timerhigh</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * recover 64bit TSF value from the 16bit TSF value in the rx header</span>
<span class="cm"> * given the assumption that the TSF passed in header is within 65ms</span>
<span class="cm"> * of the current tsf.</span>
<span class="cm"> *</span>
<span class="cm"> * 6       5       4       4       3       2       1</span>
<span class="cm"> * 3.......6.......8.......0.......2.......4.......6.......8......0</span>
<span class="cm"> * |&lt;---------- tsf_h -----------&gt;||&lt;--- tsf_l --&gt;||&lt;-RxTSFTime -&gt;|</span>
<span class="cm"> *</span>
<span class="cm"> * The RxTSFTime are the lowest 16 bits and provided by the ucode. The</span>
<span class="cm"> * tsf_l is filled in by brcms_b_recv, which is done earlier in the</span>
<span class="cm"> * receive call sequence after rx interrupt. Only the higher 16 bits</span>
<span class="cm"> * are used. Finally, the tsf_h is read from the tsf register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u64</span> <span class="nf">brcms_c_recover_tsf64</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">d11rxhdr</span> <span class="o">*</span><span class="n">rxh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tsf_h</span><span class="p">,</span> <span class="n">tsf_l</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_tsf_0_15</span><span class="p">,</span> <span class="n">rx_tsf_16_31</span><span class="p">;</span>

	<span class="n">brcms_b_read_tsf</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsf_l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsf_h</span><span class="p">);</span>

	<span class="n">rx_tsf_16_31</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">tsf_l</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">rx_tsf_0_15</span> <span class="o">=</span> <span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxTSFTime</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * a greater tsf time indicates the low 16 bits of</span>
<span class="cm">	 * tsf_l wrapped, so decrement the high 16 bits.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">tsf_l</span> <span class="o">&lt;</span> <span class="n">rx_tsf_0_15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_tsf_16_31</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_tsf_16_31</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="n">tsf_h</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">tsf_h</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">rx_tsf_16_31</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">rx_tsf_0_15</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">prep_mac80211_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d11rxhdr</span> <span class="o">*</span><span class="n">rxh</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">rx_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">preamble</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rspec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">plcp</span><span class="p">;</span>

	<span class="cm">/* fill in TSF and flag its presence */</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">mactime</span> <span class="o">=</span> <span class="n">brcms_c_recover_tsf64</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rxh</span><span class="p">);</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_MACTIME_MPDU</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">BRCMS_CHAN_CHANNEL</span><span class="p">(</span><span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxChan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">ieee80211_ofdm_chan_to_freq</span><span class="p">(</span>
					<span class="n">WF_CHAN_FACTOR_5_G</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">ieee80211_dsss_chan_to_freq</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">wlc_phy_rssi_compute</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">rxh</span><span class="p">);</span>

	<span class="cm">/* noise */</span>
	<span class="cm">/* qual */</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">antenna</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_0</span> <span class="o">&amp;</span> <span class="n">PRXS0_RXANT_UPSUBBAND</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">plcp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">rspec</span> <span class="o">=</span> <span class="n">brcms_c_compute_rspec</span><span class="p">(</span><span class="n">rxh</span><span class="p">,</span> <span class="n">plcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">rspec</span> <span class="o">&amp;</span> <span class="n">RSPEC_RATE_MASK</span><span class="p">;</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_HT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rspec_is40mhz</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span>
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_40MHZ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rspec2rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BRCM_RATE_1M</span>:
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BRCM_RATE_2M</span>:
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BRCM_RATE_5M5</span>:
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BRCM_RATE_11M</span>:
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BRCM_RATE_6M</span>:
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BRCM_RATE_9M</span>:
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BRCM_RATE_12M</span>:
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BRCM_RATE_18M</span>:
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BRCM_RATE_24M</span>:
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BRCM_RATE_36M</span>:
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BRCM_RATE_48M</span>:
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BRCM_RATE_54M</span>:
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: Unknown rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * For 5GHz, we should decrease the index as it is</span>
<span class="cm">		 * a subset of the 2.4G rates. See bitrates field</span>
<span class="cm">		 * of brcms_band_5GHz_nphy (in mac80211_if.c).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">-=</span> <span class="n">BRCMS_LEGACY_5G_RATE_OFFSET</span><span class="p">;</span>

		<span class="cm">/* Determine short preamble and rate_idx */</span>
		<span class="n">preamble</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_cck_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_0</span> <span class="o">&amp;</span> <span class="n">PRXS0_SHORTH</span><span class="p">)</span>
				<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORTPRE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_ofdm_rate</span><span class="p">(</span><span class="n">rspec</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORTPRE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: Unknown modulation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plcp3_issgi</span><span class="p">(</span><span class="n">plcp</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORT_GI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxStatus1</span> <span class="o">&amp;</span> <span class="n">RXS_DECERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_FAILED_PLCP_CRC</span><span class="p">;</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s:  RX_FLAG_FAILED_PLCP_CRC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxStatus1</span> <span class="o">&amp;</span> <span class="n">RXS_FCSERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_FAILED_FCS_CRC</span><span class="p">;</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s:  RX_FLAG_FAILED_FCS_CRC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_c_recvctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d11rxhdr</span> <span class="o">*</span><span class="n">rxh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len_mpdu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="n">rx_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_status</span><span class="p">));</span>
	<span class="n">prep_mac80211_status</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rxh</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_status</span><span class="p">);</span>

	<span class="cm">/* mac header+body length, exclude CRC and plcp header */</span>
	<span class="n">len_mpdu</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">D11_PHY_HDR_LEN</span> <span class="o">-</span> <span class="n">FCS_LEN</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">D11_PHY_HDR_LEN</span><span class="p">);</span>
	<span class="n">__skb_trim</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">len_mpdu</span><span class="p">);</span>

	<span class="cm">/* unmute transmit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">suspended_fifos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
			<span class="n">brcms_b_mute</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rx_status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_status</span><span class="p">));</span>
	<span class="n">ieee80211_rx_irqsafe</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* calculate frame duration for Mixed-mode L-SIG spoofing, return</span>
<span class="cm"> * number of bytes goes in the length field</span>
<span class="cm"> *</span>
<span class="cm"> * Formula given by HT PHY Spec v 1.13</span>
<span class="cm"> *   len = 3(nsyms + nstream + 3) - 3</span>
<span class="cm"> */</span>
<span class="n">u16</span>
<span class="nf">brcms_c_calc_lsig_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ratespec</span><span class="p">,</span>
		      <span class="n">uint</span> <span class="n">mac_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">nsyms</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kNdps</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: rate %d, len%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">rspec2rate</span><span class="p">(</span><span class="n">ratespec</span><span class="p">),</span> <span class="n">mac_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_mcs_rate</span><span class="p">(</span><span class="n">ratespec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">uint</span> <span class="n">mcs</span> <span class="o">=</span> <span class="n">ratespec</span> <span class="o">&amp;</span> <span class="n">RSPEC_RATE_MASK</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tot_streams</span> <span class="o">=</span> <span class="p">(</span><span class="n">mcs_2_txstreams</span><span class="p">(</span><span class="n">mcs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
				  <span class="n">rspec_stc</span><span class="p">(</span><span class="n">ratespec</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * the payload duration calculation matches that</span>
<span class="cm">		 * of regular ofdm</span>
<span class="cm">		 */</span>
		<span class="cm">/* 1000Ndbps = kbps * 4 */</span>
		<span class="n">kNdps</span> <span class="o">=</span> <span class="n">mcs_2_rate</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">rspec_is40mhz</span><span class="p">(</span><span class="n">ratespec</span><span class="p">),</span>
				   <span class="n">rspec_issgi</span><span class="p">(</span><span class="n">ratespec</span><span class="p">))</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rspec_stc</span><span class="p">(</span><span class="n">ratespec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nsyms</span> <span class="o">=</span>
			    <span class="n">CEIL</span><span class="p">((</span><span class="n">APHY_SERVICE_NBITS</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">mac_len</span> <span class="o">+</span>
				  <span class="n">APHY_TAIL_NBITS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">kNdps</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* STBC needs to have even number of symbols */</span>
			<span class="n">nsyms</span> <span class="o">=</span>
			    <span class="mi">2</span> <span class="o">*</span>
			    <span class="n">CEIL</span><span class="p">((</span><span class="n">APHY_SERVICE_NBITS</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">mac_len</span> <span class="o">+</span>
				  <span class="n">APHY_TAIL_NBITS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">kNdps</span><span class="p">);</span>

		<span class="cm">/* (+3) account for HT-SIG(2) and HT-STF(1) */</span>
		<span class="n">nsyms</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tot_streams</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * 3 bytes/symbol @ legacy 6Mbps rate</span>
<span class="cm">		 * (-3) excluding service bits and tail bits</span>
<span class="cm">		 */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">nsyms</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_c_mod_prb_rsp_rate_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">uint</span> <span class="n">frame_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="o">*</span><span class="n">rs_dflt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_c_rateset</span> <span class="n">rs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">entry_ptr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">plcp</span><span class="p">[</span><span class="n">D11_PHY_HDR_LEN</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">dur</span><span class="p">,</span> <span class="n">sifs</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sifs</span> <span class="o">=</span> <span class="n">get_sifs</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>

	<span class="n">rs_dflt</span> <span class="o">=</span> <span class="n">brcms_c_rateset_get_hwrs</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="n">brcms_c_rateset_copy</span><span class="p">(</span><span class="n">rs_dflt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">);</span>
	<span class="n">brcms_c_rateset_mcs_upd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txstreams</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * walk the phy rate table and update MAC core SHM</span>
<span class="cm">	 * basic rate table entries</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BRCMS_RATE_MASK</span><span class="p">;</span>

		<span class="n">entry_ptr</span> <span class="o">=</span> <span class="n">brcms_b_rate_shm_offset</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

		<span class="cm">/* Calculate the Probe Response PLCP for the given rate */</span>
		<span class="n">brcms_c_compute_plcp</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">frame_len</span><span class="p">,</span> <span class="n">plcp</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Calculate the duration of the Probe Response</span>
<span class="cm">		 * frame plus SIFS for the MAC</span>
<span class="cm">		 */</span>
		<span class="n">dur</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">brcms_c_calc_frame_time</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span>
						<span class="n">BRCMS_LONG_PREAMBLE</span><span class="p">,</span> <span class="n">frame_len</span><span class="p">);</span>
		<span class="n">dur</span> <span class="o">+=</span> <span class="n">sifs</span><span class="p">;</span>

		<span class="cm">/* Update the SHM Rate Table entry Probe Response values */</span>
		<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">entry_ptr</span> <span class="o">+</span> <span class="n">M_RT_PRS_PLCP_POS</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">plcp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">plcp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
		<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">entry_ptr</span> <span class="o">+</span> <span class="n">M_RT_PRS_PLCP_POS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">plcp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">plcp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
		<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">entry_ptr</span> <span class="o">+</span> <span class="n">M_RT_PRS_DUR_POS</span><span class="p">,</span> <span class="n">dur</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*	Max buffering needed for beacon template/prb resp template is 142 bytes.</span>
<span class="cm"> *</span>
<span class="cm"> *	PLCP header is 6 bytes.</span>
<span class="cm"> *	802.11 A3 header is 24 bytes.</span>
<span class="cm"> *	Max beacon frame body template length is 112 bytes.</span>
<span class="cm"> *	Max probe resp frame body template length is 110 bytes.</span>
<span class="cm"> *</span>
<span class="cm"> *      *len on input contains the max length of the packet available.</span>
<span class="cm"> *</span>
<span class="cm"> *	The *len value is set to the number of bytes in buf used, and starts</span>
<span class="cm"> *	with the PLCP and included up to, but not including, the 4 byte FCS.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_c_bcn_prb_template</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">bcn_rspec</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">brcms_bss_cfg</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ether_bcast</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">cck_phy_hdr</span> <span class="o">*</span><span class="n">plcp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">body_len</span><span class="p">;</span>

	<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">D11_PHY_HDR_LEN</span> <span class="o">+</span> <span class="n">DOT11_MAC_HDR_LEN</span><span class="p">;</span>

	<span class="cm">/* calc buffer size provided for frame body */</span>
	<span class="n">body_len</span> <span class="o">=</span> <span class="o">*</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="cm">/* return actual size */</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">hdr_len</span> <span class="o">+</span> <span class="n">body_len</span><span class="p">;</span>

	<span class="cm">/* format PHY and MAC headers */</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>

	<span class="n">plcp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cck_phy_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * PLCP for Probe Response frames are filled in from</span>
<span class="cm">	 * core&#39;s rate table</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_BEACON</span><span class="p">)</span>
		<span class="cm">/* fill in PLCP */</span>
		<span class="n">brcms_c_compute_plcp</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bcn_rspec</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">DOT11_MAC_HDR_LEN</span> <span class="o">+</span> <span class="n">body_len</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">),</span>
				 <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">plcp</span><span class="p">);</span>

	<span class="cm">/* &quot;Regular&quot; and 16 MBSS but not for 4 MBSS */</span>
	<span class="cm">/* Update the phytxctl for the beacon based on the rspec */</span>
	<span class="n">brcms_c_beacon_phytxctl_txant_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bcn_rspec</span><span class="p">);</span>

	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">plcp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* fill in 802.11 header */</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span> <span class="n">type</span><span class="p">);</span>

	<span class="cm">/* DUR is 0 for multicast bcn, or filled in by MAC for prb resp */</span>
	<span class="cm">/* A1 filled in by MAC for prb resp, broadcast for bcn */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_BEACON</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ether_bcast</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cur_etheraddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* SEQ filled in by MAC */</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcms_c_get_header_len</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">TXOFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update all beacons for the system.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_c_update_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_bss_cfg</span> <span class="o">*</span><span class="n">bsscfg</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">BSS</span><span class="p">)</span>
		<span class="cm">/* Clear the soft intmask */</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">defmacintmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MI_BCNTPL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write ssid into shared memory */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_c_shm_ssid_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcms_bss_cfg</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ssidptr</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">base</span> <span class="o">=</span> <span class="n">M_SSID</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ssidbuf</span><span class="p">[</span><span class="n">IEEE80211_MAX_SSID_LEN</span><span class="p">];</span>

	<span class="cm">/* padding the ssid with zero and copy it into shm */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ssidbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IEEE80211_MAX_SSID_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ssidbuf</span><span class="p">,</span> <span class="n">ssidptr</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">SSID_len</span><span class="p">);</span>

	<span class="n">brcms_c_copyto_shm</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">ssidbuf</span><span class="p">,</span> <span class="n">IEEE80211_MAX_SSID_LEN</span><span class="p">);</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_SSIDLEN</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">SSID_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_c_bss_update_probe_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">brcms_bss_cfg</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">suspend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">prb_resp</span><span class="p">[</span><span class="n">BCN_TMPL_LEN</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">BCN_TMPL_LEN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * write the probe response to hardware, or save in</span>
<span class="cm">	 * the config structure</span>
<span class="cm">	 */</span>

	<span class="cm">/* create the probe response template */</span>
	<span class="n">brcms_c_bcn_prb_template</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">IEEE80211_STYPE_PROBE_RESP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">cfg</span><span class="p">,</span> <span class="n">prb_resp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">suspend</span><span class="p">)</span>
		<span class="n">brcms_c_suspend_mac_and_wait</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* write the probe response into the template region */</span>
	<span class="n">brcms_b_write_template_ram</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">T_PRS_TPL_BASE</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">,</span> <span class="n">prb_resp</span><span class="p">);</span>

	<span class="cm">/* write the length of the probe response frame (+PLCP/-FCS) */</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_PRB_RESP_FRM_LEN</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* write the SSID and SSID length */</span>
	<span class="n">brcms_c_shm_ssid_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write PLCP headers and durations for probe response frames</span>
<span class="cm">	 * at all rates. Use the actual frame length covered by the</span>
<span class="cm">	 * PLCP header for the call to brcms_c_mod_prb_rsp_rate_table()</span>
<span class="cm">	 * by subtracting the PLCP len and adding the FCS.</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="o">-</span><span class="n">D11_PHY_HDR_LEN</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">);</span>
	<span class="n">brcms_c_mod_prb_rsp_rate_table</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">suspend</span><span class="p">)</span>
		<span class="n">brcms_c_enable_mac</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_update_probe_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">suspend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_bss_cfg</span> <span class="o">*</span><span class="n">bsscfg</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="p">;</span>

	<span class="cm">/* update AP or IBSS probe responses */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">BSS</span><span class="p">)</span>
		<span class="n">brcms_c_bss_update_probe_resp</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bsscfg</span><span class="p">,</span> <span class="n">suspend</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* prepares pdu for transmission. returns BCM error codes */</span>
<span class="kt">int</span> <span class="nf">brcms_c_prep_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pdu</span><span class="p">,</span> <span class="n">uint</span> <span class="o">*</span><span class="n">fifop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">fifo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d11txh</span> <span class="o">*</span><span class="n">txh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>

	<span class="n">txh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">d11txh</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">txh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">D11_PHY_HDR_LEN</span><span class="p">);</span>

	<span class="cm">/* get the pkt queue info. This was put at brcms_c_sendctl or</span>
<span class="cm">	 * brcms_c_send for PDU */</span>
	<span class="n">fifo</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txh</span><span class="o">-&gt;</span><span class="n">TxFrameID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXFID_QUEUE_MASK</span><span class="p">;</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">fifop</span> <span class="o">=</span> <span class="n">fifo</span><span class="p">;</span>

	<span class="cm">/* return if insufficient dma resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">txavail</span><span class="p">[</span><span class="n">fifo</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MAX_DMA_SEGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Mark precedences related to this FIFO, unsendable */</span>
		<span class="cm">/* A fifo is full. Clear precedences related to that FIFO */</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_prec_map</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">fifo2prec_map</span><span class="p">[</span><span class="n">fifo</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcms_b_xmtfifo_sz_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">uint</span> <span class="n">fifo</span><span class="p">,</span>
			   <span class="n">uint</span> <span class="o">*</span><span class="n">blocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&gt;=</span> <span class="n">NFIFO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">xmtfifo_sz</span><span class="p">[</span><span class="n">fifo</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">brcms_c_set_addrmatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">match_reg_offset</span><span class="p">,</span>
		  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">brcms_b_set_addrmatch</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">match_reg_offset</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match_reg_offset</span> <span class="o">==</span> <span class="n">RCM_BSSID_OFFSET</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Flag &#39;scan in progress&#39; to withhold dynamic phy calibration</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_c_scan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc_phy_hold_upd</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">PHY_HOLD_FOR_SCAN</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_scan_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc_phy_hold_upd</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">PHY_HOLD_FOR_SCAN</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_associate_upd</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">associated</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">associated</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When a remote STA/AP is removed by Mac80211, or when it can no longer accept</span>
<span class="cm"> * AMPDU traffic, packets pending in hardware have to be invalidated so that</span>
<span class="cm"> * when later on hardware releases them, they can be handled appropriately.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_c_inval_dma_pkts</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">dma_callback_fn</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pub</span> <span class="o">*</span><span class="n">dmah</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NFIFO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmah</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dma_walk_packets</span><span class="p">(</span><span class="n">dmah</span><span class="p">,</span> <span class="n">dma_callback_fn</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcms_c_get_curband</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandunit</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_wait_for_tx_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">drop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

	<span class="cm">/* flush packet queue when requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drop</span><span class="p">)</span>
		<span class="n">brcmu_pktq_flush</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pkt_queue</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* wait for queue and DMA fifos to run dry */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">pktq_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pkt_queue</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">)</span> <span class="o">||</span> <span class="n">brcms_txpktpendtot</span><span class="p">(</span><span class="n">wlc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_msleep</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_set_beacon_listen_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bcn_li_bcn</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="n">brcms_c_bcn_li_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcms_c_set_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txpwr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">qdbm</span><span class="p">;</span>

	<span class="cm">/* Remove override bit and clip to max qdbm value */</span>
	<span class="n">qdbm</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">uint</span><span class="p">,</span> <span class="n">txpwr</span> <span class="o">*</span> <span class="n">BRCMS_TXPWR_DB_FACTOR</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wlc_phy_txpower_set</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">qdbm</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">brcms_c_get_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">qdbm</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">override</span><span class="p">;</span>

	<span class="n">wlc_phy_txpower_get</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdbm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">override</span><span class="p">);</span>

	<span class="cm">/* Return qdbm units */</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">qdbm</span> <span class="o">/</span> <span class="n">BRCMS_TXPWR_DB_FACTOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Process received frames */</span>
<span class="cm">/*</span>
<span class="cm"> * Return true if more frames need to be processed. false otherwise.</span>
<span class="cm"> * Param &#39;bound&#39; indicates max. # frames to process before break out.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_c_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d11rxhdr</span> <span class="o">*</span><span class="n">rxh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_amsdu</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="cm">/* frame starts with rxhdr */</span>
	<span class="n">rxh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">d11rxhdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* strip off rxhdr */</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">BRCMS_HWRXOFF</span><span class="p">);</span>

	<span class="cm">/* MAC inserts 2 pad bytes for a4 headers or QoS or A-MSDU subframes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxStatus1</span> <span class="o">&amp;</span> <span class="n">RXS_PBPRES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: recv: rcvd runt of &quot;</span>
				  <span class="s">&quot;len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">toss</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">D11_PHY_HDR_LEN</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxStatus1</span> <span class="o">&amp;</span> <span class="n">RXS_FCSERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_FCSFAIL</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">toss</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check received pkt has at least frame control field */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">D11_PHY_HDR_LEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">toss</span><span class="p">;</span>

	<span class="cm">/* not supporting A-MSDU */</span>
	<span class="n">is_amsdu</span> <span class="o">=</span> <span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxStatus2</span> <span class="o">&amp;</span> <span class="n">RXS_AMSDU_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_amsdu</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">toss</span><span class="p">;</span>

	<span class="n">brcms_c_recvctl</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">rxh</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">toss:</span>
	<span class="n">brcmu_pkt_buf_free_skb</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Process received frames */</span>
<span class="cm">/*</span>
<span class="cm"> * Return true if more frames need to be processed. false otherwise.</span>
<span class="cm"> * Param &#39;bound&#39; indicates max. # frames to process before break out.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">brcms_b_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">uint</span> <span class="n">fifo</span><span class="p">,</span> <span class="n">bool</span> <span class="n">bound</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">recv_frames</span><span class="p">;</span>

	<span class="n">uint</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">bound_limit</span> <span class="o">=</span> <span class="n">bound</span> <span class="o">?</span> <span class="n">RXBND</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recv_frames</span><span class="p">);</span>

	<span class="cm">/* gather received frames */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dma_rx</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">fifo</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">recv_frames</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* !give others some time to run! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">bound_limit</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* post more rbufs */</span>
	<span class="n">dma_rxfill</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">fifo</span><span class="p">]);</span>

	<span class="cm">/* process each frame */</span>
	<span class="n">skb_queue_walk_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recv_frames</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">d11rxhdr_le</span> <span class="o">*</span><span class="n">rxh_le</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">d11rxhdr</span> <span class="o">*</span><span class="n">rxh</span><span class="p">;</span>

		<span class="n">skb_unlink</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recv_frames</span><span class="p">);</span>
		<span class="n">rxh_le</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">d11rxhdr_le</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">rxh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">d11rxhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="cm">/* fixup rx header endianness */</span>
		<span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxFrameSize</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxh_le</span><span class="o">-&gt;</span><span class="n">RxFrameSize</span><span class="p">);</span>
		<span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_0</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxh_le</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_0</span><span class="p">);</span>
		<span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_1</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxh_le</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_1</span><span class="p">);</span>
		<span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_2</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxh_le</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_2</span><span class="p">);</span>
		<span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_3</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxh_le</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_3</span><span class="p">);</span>
		<span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_4</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxh_le</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_4</span><span class="p">);</span>
		<span class="n">rxh</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_5</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxh_le</span><span class="o">-&gt;</span><span class="n">PhyRxStatus_5</span><span class="p">);</span>
		<span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxStatus1</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxh_le</span><span class="o">-&gt;</span><span class="n">RxStatus1</span><span class="p">);</span>
		<span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxStatus2</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxh_le</span><span class="o">-&gt;</span><span class="n">RxStatus2</span><span class="p">);</span>
		<span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxTSFTime</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxh_le</span><span class="o">-&gt;</span><span class="n">RxTSFTime</span><span class="p">);</span>
		<span class="n">rxh</span><span class="o">-&gt;</span><span class="n">RxChan</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxh_le</span><span class="o">-&gt;</span><span class="n">RxChan</span><span class="p">);</span>

		<span class="n">brcms_c_recv</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">bound_limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* second-level interrupt processing</span>
<span class="cm"> *   Return true if another dpc needs to be re-scheduled. false otherwise.</span>
<span class="cm"> *   Param &#39;bounded&#39; indicates if applicable loops should be bounded.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">brcms_c_dpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">bounded</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">macintstatus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_hardware</span> <span class="o">*</span><span class="n">wlc_hw</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brcms_deviceremoved</span><span class="p">(</span><span class="n">wlc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: dead chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="n">brcms_down</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* grab and clear the saved software intstatus bits */</span>
	<span class="n">macintstatus</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintstatus</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: macintstatus 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">macintstatus</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">macintstatus</span> <span class="o">&amp;</span> <span class="n">MI_PRQ</span><span class="p">);</span> <span class="cm">/* PRQ Interrupt in non-MBSS */</span>

	<span class="cm">/* tx status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">&amp;</span> <span class="n">MI_TFS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">fatal</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brcms_b_txstatus</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">bounded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fatal</span><span class="p">))</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintstatus</span> <span class="o">|=</span> <span class="n">MI_TFS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fatal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;MI_TFS: fatal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fatal</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MI_TBTT</span> <span class="o">|</span> <span class="n">MI_DTIM_TBTT</span><span class="p">))</span>
		<span class="n">brcms_c_tbtt</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* ATIM window end */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">&amp;</span> <span class="n">MI_ATIMWINEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;end of ATIM window</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bcma_set32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">maccommand</span><span class="p">),</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">qvalid</span><span class="p">);</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">qvalid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * received data or control frame, MI_DMAINT is</span>
<span class="cm">	 * indication of RX_FIFO interrupt</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">&amp;</span> <span class="n">MI_DMAINT</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brcms_b_recv</span><span class="p">(</span><span class="n">wlc_hw</span><span class="p">,</span> <span class="n">RX_FIFO</span><span class="p">,</span> <span class="n">bounded</span><span class="p">))</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintstatus</span> <span class="o">|=</span> <span class="n">MI_DMAINT</span><span class="p">;</span>

	<span class="cm">/* noise sample collected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">&amp;</span> <span class="n">MI_BG_NOISE</span><span class="p">)</span>
		<span class="n">wlc_phy_noise_sample_intr</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">&amp;</span> <span class="n">MI_GP0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: PSM microcode watchdog fired at %d &quot;</span>
			  <span class="s">&quot;(seconds). Resetting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">);</span>

		<span class="n">printk_once</span><span class="p">(</span><span class="s">&quot;%s : PSM Watchdog, chipid 0x%x, chiprev 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">ai_get_chip_id</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">),</span>
			    <span class="n">ai_get_chiprev</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">));</span>
		<span class="n">brcms_fatal_error</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* gptimer timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">&amp;</span> <span class="n">MI_TO</span><span class="p">)</span>
		<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">gptimer</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">macintstatus</span> <span class="o">&amp;</span> <span class="n">MI_RFDISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: BMAC Detected a change on the&quot;</span>
		       <span class="s">&quot; RF Disable Input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
		<span class="n">brcms_rfkill_set_hw_state</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* send any enq&#39;d tx packets. Just makes sure to jump start tx */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pktq_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pkt_queue</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">))</span>
		<span class="n">brcms_c_send_q</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* it isn&#39;t done and needs to be resched if macintstatus is non-zero */</span>
	<span class="k">return</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintstatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fatal:</span>
	<span class="n">brcms_fatal_error</span><span class="p">(</span><span class="n">wlc_hw</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">macintstatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_c_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mute_tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">d11core</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">chanspec</span><span class="p">;</span>

	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This will happen if a big-hammer was executed. In</span>
<span class="cm">	 * that case, we want to go back to the channel that</span>
<span class="cm">	 * we were on and not new channel</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">associated</span><span class="p">)</span>
		<span class="n">chanspec</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">home_chanspec</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chanspec</span> <span class="o">=</span> <span class="n">brcms_c_init_chanspec</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="n">brcms_b_init</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/* update beacon listen interval */</span>
	<span class="n">brcms_c_bcn_li_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* write ethernet address to core */</span>
	<span class="n">brcms_c_set_mac</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="p">);</span>
	<span class="n">brcms_c_set_bssid</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="p">);</span>

	<span class="cm">/* Update tsf_cfprep if associated and up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">associated</span> <span class="o">&amp;&amp;</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">bi</span><span class="p">;</span>

		<span class="cm">/* get beacon period and convert to uS */</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">current_bss</span><span class="o">-&gt;</span><span class="n">beacon_period</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * update since init path would reset</span>
<span class="cm">		 * to default value</span>
<span class="cm">		 */</span>
		<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">tsf_cfprep</span><span class="p">),</span>
			     <span class="n">bi</span> <span class="o">&lt;&lt;</span> <span class="n">CFPREP_CBI_SHIFT</span><span class="p">);</span>

		<span class="cm">/* Update maccontrol PM related bits */</span>
		<span class="n">brcms_c_set_ps_ctrl</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">brcms_c_bandinit_ordered</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">chanspec</span><span class="p">);</span>

	<span class="cm">/* init probe response timeout */</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_PRS_MAXTIME</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">prb_resp_timeout</span><span class="p">);</span>

	<span class="cm">/* init max burst txop (framebursting) */</span>
	<span class="n">brcms_b_write_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_MBURST_TXOP</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span>
		       <span class="n">_rifs</span> <span class="o">?</span> <span class="p">(</span><span class="n">EDCF_AC_VO_TXOP_AP</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">:</span> <span class="n">MAXFRAMEBURST_TXOP</span><span class="p">));</span>

	<span class="cm">/* initialize maximum allowed duty cycle */</span>
	<span class="n">brcms_c_duty_cycle_set</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_duty_cycle_ofdm</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">brcms_c_duty_cycle_set</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_duty_cycle_cck</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update some shared memory locations related to</span>
<span class="cm">	 * max AMPDU size allowed to received</span>
<span class="cm">	 */</span>
	<span class="n">brcms_c_ampdu_shm_upd</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ampdu</span><span class="p">);</span>

	<span class="cm">/* band-specific inits */</span>
	<span class="n">brcms_c_bsinit</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* Enable EDCF mode (while the MAC is suspended) */</span>
	<span class="n">bcma_set16</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">ifs_ctl</span><span class="p">),</span> <span class="n">IFS_USEEDCF</span><span class="p">);</span>
	<span class="n">brcms_c_edcf_setparams</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* Init precedence maps for empty FIFOs */</span>
	<span class="n">brcms_c_tx_prec_map_init</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* read the ucode version if we have not yet done so */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ucode_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ucode_rev</span> <span class="o">=</span>
		    <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_BOM_REV_MAJOR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NBITS</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ucode_rev</span> <span class="o">|=</span> <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_BOM_REV_MINOR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ..now really unleash hell (allow the MAC out of suspend) */</span>
	<span class="n">brcms_c_enable_mac</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* suspend the tx fifos and mute the phy for preism cac time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mute_tx</span><span class="p">)</span>
		<span class="n">brcms_b_mute</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* clear tx flow control */</span>
	<span class="n">brcms_c_txflowcontrol_reset</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* enable the RF Disable Delay timer */</span>
	<span class="n">bcma_write32</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">D11REGOFFS</span><span class="p">(</span><span class="n">rfdisabledly</span><span class="p">),</span> <span class="n">RFDISABLE_DEFAULT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize WME parameters; if they haven&#39;t been set by some other</span>
<span class="cm">	 * mechanism (IOVar, etc) then read them from the hardware.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GFIELD</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wme_retries</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">EDCF_SHORT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Uninitialized; read from HW */</span>
		<span class="kt">int</span> <span class="n">ac</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ac</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_ACS</span><span class="p">;</span> <span class="n">ac</span><span class="o">++</span><span class="p">)</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wme_retries</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">brcms_b_read_shm</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">M_AC_TXLMT_ADDR</span><span class="p">(</span><span class="n">ac</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The common driver entry routine. Error codes should be unique</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span>
<span class="nf">brcms_c_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span> <span class="n">uint</span> <span class="n">unit</span><span class="p">,</span>
	       <span class="n">bool</span> <span class="n">piomode</span><span class="p">,</span> <span class="n">uint</span> <span class="o">*</span><span class="n">perr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_pub</span> <span class="o">*</span><span class="n">pub</span><span class="p">;</span>

	<span class="cm">/* allocate struct brcms_c_info state and its substructures */</span>
	<span class="n">wlc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">brcms_c_attach_malloc</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="n">pub</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">;</span>

<span class="cp">#if defined(DEBUG)</span>
	<span class="n">wlc_info_dbg</span> <span class="o">=</span> <span class="n">wlc</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">corestate</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wl</span><span class="p">;</span>
	<span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span><span class="p">;</span>
	<span class="n">pub</span><span class="o">-&gt;</span><span class="n">_piomode</span> <span class="o">=</span> <span class="n">piomode</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandinit_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* populate struct brcms_c_info with default values  */</span>
	<span class="n">brcms_c_info_init</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>

	<span class="cm">/* update sta/ap related parameters */</span>
	<span class="n">brcms_c_ap_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * low level attach steps(all hw accesses go</span>
<span class="cm">	 * inside, no more in rest of the attach)</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcms_b_attach</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">piomode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_N_PAM_OVR</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

	<span class="n">pub</span><span class="o">-&gt;</span><span class="n">phy_11ncapable</span> <span class="o">=</span> <span class="n">BRCMS_PHY_11N_CAP</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>

	<span class="cm">/* disable allowed duty cycle */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_duty_cycle_ofdm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">tx_duty_cycle_cck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">brcms_c_stf_phy_chain_calc</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* txchain 1: txant 0, txchain 2: txant 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISNPHY</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txstreams</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">txant</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">hw_txchain</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* push to BMAC driver */</span>
	<span class="n">wlc_phy_stf_chain_init</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">hw_txchain</span><span class="p">,</span>
			       <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">stf</span><span class="o">-&gt;</span><span class="n">hw_rxchain</span><span class="p">);</span>

	<span class="cm">/* pull up some info resulting from the low attach */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NFIFO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">txavail</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">txavail</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">perm_etheraddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">etheraddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">cur_etheraddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">etheraddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_c_attach_stf_ant_init</span><span class="p">(</span><span class="n">wlc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* default contention windows size limits */</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">CWmin</span> <span class="o">=</span> <span class="n">APHY_CWMIN</span><span class="p">;</span>
		<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">CWmax</span> <span class="o">=</span> <span class="n">PHY_CWMAX</span><span class="p">;</span>

		<span class="cm">/* init gmode value */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">bandtype</span> <span class="o">==</span> <span class="n">BRCM_BAND_2G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">=</span> <span class="n">GMODE_AUTO</span><span class="p">;</span>
			<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_G_USER</span><span class="p">,</span>
					   <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* init _n_enab supported mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_PHY_11N_CAP</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">=</span> <span class="n">SUPPORT_11N</span><span class="p">;</span>
			<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_N_USER</span><span class="p">,</span>
						   <span class="p">((</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">==</span>
						     <span class="n">SUPPORT_11N</span><span class="p">)</span> <span class="o">?</span> <span class="n">WL_11N_2x2</span> <span class="o">:</span>
						    <span class="n">WL_11N_3x3</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* init per-band default rateset, depend on band-&gt;gmode */</span>
		<span class="n">brcms_default_rateset</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">defrateset</span><span class="p">);</span>

		<span class="cm">/* fill in hw_rateset */</span>
		<span class="n">brcms_c_rateset_filter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">defrateset</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">hw_rateset</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
				   <span class="n">BRCMS_RATES_CCK_OFDM</span><span class="p">,</span> <span class="n">BRCMS_RATE_MASK</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_n_enab</span> <span class="o">&amp;</span> <span class="n">SUPPORT_11N</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * update antenna config due to</span>
<span class="cm">	 * wlc-&gt;stf-&gt;txant/txchain/ant_rx_ovr change</span>
<span class="cm">	 */</span>
	<span class="n">brcms_c_stf_phy_txant_upd</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* attach each modules */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">brcms_c_attach_module</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brcms_c_timers_init</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">unit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: init_timer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* depend on rateset, gmode */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span> <span class="o">=</span> <span class="n">brcms_c_channel_mgr_attach</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cmi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: channel_mgr_attach failed&quot;</span>
			  <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init default when all parameters are ready, i.e. -&gt;rateset */</span>
	<span class="n">brcms_c_bss_default_init</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Complete the wlc default state initializations..</span>
<span class="cm">	 */</span>

	<span class="cm">/* allocate our initial queue */</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pkt_queue</span> <span class="o">=</span> <span class="n">brcms_c_txq_alloc</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pkt_queue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: failed to malloc tx queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bsscfg</span><span class="o">-&gt;</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wlc</span><span class="p">;</span>

	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">mimoft</span> <span class="o">=</span> <span class="n">FT_HT</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">mimo_40txbw</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">ofdm_40txbw</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">;</span>
	<span class="n">wlc</span><span class="o">-&gt;</span><span class="n">cck_40txbw</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">;</span>
	<span class="n">brcms_c_update_mimo_band_bwcap</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_N_BW_20IN2G_40IN5G</span><span class="p">);</span>

	<span class="cm">/* Set default values of SGI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_SGI_CAP_PHY</span><span class="p">(</span><span class="n">wlc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcms_c_ht_update_sgi_rx</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="p">(</span><span class="n">BRCMS_N_SGI_20</span> <span class="o">|</span>
					       <span class="n">BRCMS_N_SGI_40</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BRCMS_ISSSLPNPHY</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brcms_c_ht_update_sgi_rx</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="p">(</span><span class="n">BRCMS_N_SGI_20</span> <span class="o">|</span>
					       <span class="n">BRCMS_N_SGI_40</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">brcms_c_ht_update_sgi_rx</span><span class="p">(</span><span class="n">wlc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">brcms_b_antsel_set</span><span class="p">(</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">wlc</span><span class="o">-&gt;</span><span class="n">asi</span><span class="o">-&gt;</span><span class="n">antsel_avail</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perr</span><span class="p">)</span>
		<span class="o">*</span><span class="n">perr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">wlc</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: failed with err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">unit</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlc</span><span class="p">)</span>
		<span class="n">brcms_c_detach</span><span class="p">(</span><span class="n">wlc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perr</span><span class="p">)</span>
		<span class="o">*</span><span class="n">perr</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
